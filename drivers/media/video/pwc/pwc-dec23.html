<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › pwc › pwc-dec23.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pwc-dec23.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Linux driver for Philips webcam</span>
<span class="cm">   Decompression for chipset version 2 et 3</span>
<span class="cm">   (C) 2004-2006  Luc Saillard (luc@saillard.org)</span>

<span class="cm">   NOTE: this version of pwc is an unofficial (modified) release of pwc &amp; pcwx</span>
<span class="cm">   driver and thus may have bugs that are not present in the original version.</span>
<span class="cm">   Please send bug reports and support requests to &lt;luc@saillard.org&gt;.</span>
<span class="cm">   The decompression routines have been implemented by reverse-engineering the</span>
<span class="cm">   Nemosoft binary pwcx module. Caveat emptor.</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">   (at your option) any later version.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; if not, write to the Free Software</span>
<span class="cm">   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm">*/</span>

<span class="cp">#include &quot;pwc-timon.h&quot;</span>
<span class="cp">#include &quot;pwc-kiara.h&quot;</span>
<span class="cp">#include &quot;pwc-dec23.h&quot;</span>

<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * USE_LOOKUP_TABLE_TO_CLAMP</span>
<span class="cm"> *   0: use a C version of this tests:  {  a&lt;0?0:(a&gt;255?255:a) }</span>
<span class="cm"> *   1: use a faster lookup table for cpu with a big cache (intel)</span>
<span class="cm"> */</span>
<span class="cp">#define USE_LOOKUP_TABLE_TO_CLAMP	1</span>
<span class="cm">/*</span>
<span class="cm"> * UNROLL_LOOP_FOR_COPYING_BLOCK</span>
<span class="cm"> *   0: use a loop for a smaller code (but little slower)</span>
<span class="cm"> *   1: when unrolling the loop, gcc produces some faster code (perhaps only</span>
<span class="cm"> *   valid for intel processor class). Activating this option, automaticaly</span>
<span class="cm"> *   activate USE_LOOKUP_TABLE_TO_CLAMP</span>
<span class="cm"> */</span>
<span class="cp">#define UNROLL_LOOP_FOR_COPY		1</span>
<span class="cp">#if UNROLL_LOOP_FOR_COPY</span>
<span class="cp"># undef USE_LOOKUP_TABLE_TO_CLAMP</span>
<span class="cp"># define USE_LOOKUP_TABLE_TO_CLAMP 1</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_subblock_pattern</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_dec23_private</span> <span class="o">*</span><span class="n">pdec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">initial_values</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="o">-</span><span class="mh">0x526500</span><span class="p">,</span> <span class="o">-</span><span class="mh">0x221200</span><span class="p">,</span> <span class="mh">0x221200</span><span class="p">,</span> <span class="mh">0x526500</span><span class="p">,</span>
			   <span class="o">-</span><span class="mh">0x3de200</span><span class="p">,</span> <span class="mh">0x3de200</span><span class="p">,</span>
		<span class="o">-</span><span class="mh">0x6db480</span><span class="p">,</span> <span class="o">-</span><span class="mh">0x2d5d00</span><span class="p">,</span> <span class="mh">0x2d5d00</span><span class="p">,</span> <span class="mh">0x6db480</span><span class="p">,</span>
			   <span class="o">-</span><span class="mh">0x12c200</span><span class="p">,</span> <span class="mh">0x12c200</span>

	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">values_derivated</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xa4ca</span><span class="p">,</span> <span class="mh">0x4424</span><span class="p">,</span> <span class="o">-</span><span class="mh">0x4424</span><span class="p">,</span> <span class="o">-</span><span class="mh">0xa4ca</span><span class="p">,</span>
			<span class="mh">0x7bc4</span><span class="p">,</span> <span class="o">-</span><span class="mh">0x7bc4</span><span class="p">,</span>
		<span class="mh">0xdb69</span><span class="p">,</span> <span class="mh">0x5aba</span><span class="p">,</span> <span class="o">-</span><span class="mh">0x5aba</span><span class="p">,</span> <span class="o">-</span><span class="mh">0xdb69</span><span class="p">,</span>
			<span class="mh">0x2584</span><span class="p">,</span> <span class="o">-</span><span class="mh">0x2584</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">temp_values</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">temp_values</span><span class="p">,</span> <span class="n">initial_values</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">initial_values</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">12</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_subblock</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp_values</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
			<span class="n">temp_values</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+=</span> <span class="n">values_derivated</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_bit_powermask_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_dec23_private</span> <span class="o">*</span><span class="n">pdec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">byte</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bitpower</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">bitpower</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_bitpowermask</span><span class="p">[</span><span class="n">bit</span><span class="p">];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">byte</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">byte</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&amp;</span> <span class="n">bitpower</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">val</span><span class="p">;</span>
			<span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bitpower</span><span class="o">&lt;&lt;=</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">build_table_color</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">romtable</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">8</span><span class="p">],</span>
			      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p0004</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">1024</span><span class="p">],</span>
			      <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">p8004</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">256</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">compression_mode</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">pw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p0</span><span class="p">,</span> <span class="o">*</span><span class="n">p8</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

	<span class="cm">/* We have 16 compressions tables */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">compression_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">compression_mode</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">compression_mode</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p0</span> <span class="o">=</span> <span class="n">p0004</span><span class="p">[</span><span class="n">compression_mode</span><span class="p">];</span>
		<span class="n">p8</span> <span class="o">=</span> <span class="n">p8004</span><span class="p">[</span><span class="n">compression_mode</span><span class="p">];</span>
		<span class="n">r</span>  <span class="o">=</span> <span class="n">romtable</span><span class="p">[</span><span class="n">compression_mode</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">r</span><span class="o">++</span><span class="p">,</span> <span class="n">p0</span> <span class="o">+=</span> <span class="mi">128</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
					<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span>
					<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span>
					<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;=</span> <span class="mi">13</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">)</span>
					<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">bit</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="o">*</span><span class="n">p8</span><span class="o">++</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">*</span><span class="n">p8</span><span class="o">++</span> <span class="o">=</span> <span class="n">j</span> <span class="o">-</span> <span class="n">bit</span><span class="p">;</span>
				<span class="o">*</span><span class="n">p8</span><span class="o">++</span> <span class="o">=</span> <span class="n">bit</span><span class="p">;</span>

				<span class="n">pw</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit</span><span class="p">;</span>
				<span class="n">p0</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">*</span> <span class="n">pw</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">p0</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pw</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">p0</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">pw</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">p0</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mh">0x30</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pw</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">p0</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mh">0x40</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">pw</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">p0</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mh">0x50</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pw</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">p0</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mh">0x60</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">3</span> <span class="o">*</span> <span class="n">pw</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
				<span class="n">p0</span><span class="p">[</span><span class="n">k</span> <span class="o">+</span> <span class="mh">0x70</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">4</span> <span class="o">*</span> <span class="n">pw</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/* end of for (k=0; k&lt;16; k++, p8++) */</span>
		<span class="p">}</span>	<span class="cm">/* end of for (j=0; j&lt;8; j++ , table++) */</span>
	<span class="p">}</span> <span class="cm">/* end of foreach compression_mode */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_table_dc00_d800</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_dec23_private</span> <span class="o">*</span><span class="n">pdec</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define SCALEBITS 15</span>
<span class="cp">#define ONE_HALF  (1UL &lt;&lt; (SCALEBITS - 1))</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset1</span> <span class="o">=</span> <span class="n">ONE_HALF</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset2</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_dc00</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset1</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ONE_HALF</span><span class="p">);</span>
		<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_d800</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">offset2</span><span class="p">;</span>

		<span class="n">offset1</span> <span class="o">+=</span> <span class="mh">0x7bc4</span><span class="p">;</span>
		<span class="n">offset2</span> <span class="o">+=</span> <span class="mh">0x7bc4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * To decode the stream:</span>
<span class="cm"> *   if look_bits(2) == 0:	# op == 2 in the lookup table</span>
<span class="cm"> *      skip_bits(2)</span>
<span class="cm"> *      end of the stream</span>
<span class="cm"> *   elif look_bits(3) == 7:	# op == 1 in the lookup table</span>
<span class="cm"> *      skip_bits(3)</span>
<span class="cm"> *      yyyy = get_bits(4)</span>
<span class="cm"> *      xxxx = get_bits(8)</span>
<span class="cm"> *   else:			# op == 0 in the lookup table</span>
<span class="cm"> *      skip_bits(x)</span>
<span class="cm"> *</span>
<span class="cm"> * For speedup processing, we build a lookup table and we takes the first 6 bits.</span>
<span class="cm"> *</span>
<span class="cm"> * struct {</span>
<span class="cm"> *   unsigned char op;	    // operation to execute</span>
<span class="cm"> *   unsigned char bits;    // bits use to perform operation</span>
<span class="cm"> *   unsigned char offset1; // offset to add to access in the table_0004 % 16</span>
<span class="cm"> *   unsigned char offset2; // offset to add to access in the table_0004</span>
<span class="cm"> * }</span>
<span class="cm"> *</span>
<span class="cm"> * How to build this table ?</span>
<span class="cm"> *   op == 2 when (i%4)==0</span>
<span class="cm"> *   op == 1 when (i%8)==7</span>
<span class="cm"> *   op == 0 otherwise</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">hash_table_ops</span><span class="p">[</span><span class="mi">64</span><span class="o">*</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">MulIdx</span><span class="p">[</span><span class="mi">16</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">4</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,},</span>
	<span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">10</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#if USE_LOOKUP_TABLE_TO_CLAMP</span>
<span class="cp">#define MAX_OUTER_CROP_VALUE	(512)</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">pwc_crop_table</span><span class="p">[</span><span class="mi">256</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">MAX_OUTER_CROP_VALUE</span><span class="p">];</span>
<span class="cp">#define CLAMP(x) (pwc_crop_table[MAX_OUTER_CROP_VALUE+(x)])</span>
<span class="cp">#else</span>
<span class="cp">#define CLAMP(x) ((x)&gt;255?255:((x)&lt;0?0:x))</span>
<span class="cp">#endif</span>


<span class="cm">/* If the type or the command change, we rebuild the lookup table */</span>
<span class="kt">void</span> <span class="nf">pwc_dec23_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pwc_dec23_private</span> <span class="o">*</span><span class="n">pdec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dec23</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdec</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdec</span><span class="o">-&gt;</span><span class="n">last_cmd_valid</span> <span class="o">&amp;&amp;</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">last_cmd</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">DEVICE_USE_CODEC3</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* More bits, mean more bits to encode the stream, but better quality */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbits</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

		<span class="n">version</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">build_table_color</span><span class="p">(</span><span class="n">KiaraRomTable</span><span class="p">[</span><span class="n">version</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_0004_pass1</span><span class="p">,</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_8004_pass1</span><span class="p">);</span>
		<span class="n">build_table_color</span><span class="p">(</span><span class="n">KiaraRomTable</span><span class="p">[</span><span class="n">version</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_0004_pass2</span><span class="p">,</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_8004_pass2</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">6</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbits</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbits</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbits</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

		<span class="n">version</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">build_table_color</span><span class="p">(</span><span class="n">TimonRomTable</span><span class="p">[</span><span class="n">version</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_0004_pass1</span><span class="p">,</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_8004_pass1</span><span class="p">);</span>
		<span class="n">build_table_color</span><span class="p">(</span><span class="n">TimonRomTable</span><span class="p">[</span><span class="n">version</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_0004_pass2</span><span class="p">,</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_8004_pass2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Informations can be coded on a variable number of bits but never less than 8 */</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">;</span>
	<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">scalebits</span> <span class="o">=</span> <span class="n">SCALEBITS</span> <span class="o">-</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbitsmask</span> <span class="o">=</span> <span class="mh">0xFF</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">;</span>

	<span class="n">fill_table_dc00_d800</span><span class="p">(</span><span class="n">pdec</span><span class="p">);</span>
	<span class="n">build_subblock_pattern</span><span class="p">(</span><span class="n">pdec</span><span class="p">);</span>
	<span class="n">build_bit_powermask_table</span><span class="p">(</span><span class="n">pdec</span><span class="p">);</span>

<span class="cp">#if USE_LOOKUP_TABLE_TO_CLAMP</span>
	<span class="cm">/* Build the static table to clamp value [0-255] */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_OUTER_CROP_VALUE</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pwc_crop_table</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pwc_crop_table</span><span class="p">[</span><span class="n">MAX_OUTER_CROP_VALUE</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="n">MAX_OUTER_CROP_VALUE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pwc_crop_table</span><span class="p">[</span><span class="n">MAX_OUTER_CROP_VALUE</span><span class="o">+</span><span class="mi">256</span><span class="o">+</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">last_cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">last_cmd_valid</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy the 4x4 image block to Y plane buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_image_block_Y</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes_per_line</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scalebits</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if UNROLL_LOOP_FOR_COPY</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cm</span> <span class="o">=</span> <span class="n">pwc_crop_table</span><span class="o">+</span><span class="n">MAX_OUTER_CROP_VALUE</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>

	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">bytes_per_line</span><span class="p">;</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">bytes_per_line</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">bytes_per_line</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
<span class="cp">#else</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">CLAMP</span><span class="p">((</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">);</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">bytes_per_line</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">CLAMP</span><span class="p">((</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">);</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">bytes_per_line</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">CLAMP</span><span class="p">((</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">);</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">bytes_per_line</span><span class="o">*</span><span class="mi">3</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c</span><span class="o">++</span><span class="p">)</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">CLAMP</span><span class="p">((</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Copy the 4x4 image block to a CrCb plane buffer</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">copy_image_block_CrCb</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bytes_per_line</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scalebits</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if UNROLL_LOOP_FOR_COPY</span>
	<span class="cm">/* Unroll all loops */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">cm</span> <span class="o">=</span> <span class="n">pwc_crop_table</span><span class="o">+</span><span class="n">MAX_OUTER_CROP_VALUE</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>

	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">bytes_per_line</span><span class="p">;</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
	<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">cm</span><span class="p">[</span><span class="n">c</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">];</span>
<span class="cp">#else</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">c1</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="o">*</span><span class="n">c2</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c1</span><span class="o">++</span><span class="p">,</span> <span class="n">c2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">CLAMP</span><span class="p">((</span><span class="o">*</span><span class="n">c1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">);</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">CLAMP</span><span class="p">((</span><span class="o">*</span><span class="n">c2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">c1</span> <span class="o">=</span> <span class="n">src</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">bytes_per_line</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">c1</span><span class="o">++</span><span class="p">,</span> <span class="n">c2</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">CLAMP</span><span class="p">((</span><span class="o">*</span><span class="n">c1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">);</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="n">CLAMP</span><span class="p">((</span><span class="o">*</span><span class="n">c2</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">scalebits</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * To manage the stream, we keep bits in a 32 bits register.</span>
<span class="cm"> * fill_nbits(n): fill the reservoir with at least n bits</span>
<span class="cm"> * skip_bits(n): discard n bits from the reservoir</span>
<span class="cm"> * get_bits(n): fill the reservoir, returns the first n bits and discard the</span>
<span class="cm"> *              bits from the reservoir.</span>
<span class="cm"> * __get_nbits(n): faster version of get_bits(n), but asumes that the reservoir</span>
<span class="cm"> *                 contains at least n bits. bits returned is discarded.</span>
<span class="cm"> */</span>
<span class="cp">#define fill_nbits(pdec, nbits_wanted) do { \</span>
<span class="cp">   while (pdec-&gt;nbits_in_reservoir&lt;(nbits_wanted)) \</span>
<span class="cp">    { \</span>
<span class="cp">      pdec-&gt;reservoir |= (*(pdec-&gt;stream)++) &lt;&lt; (pdec-&gt;nbits_in_reservoir); \</span>
<span class="cp">      pdec-&gt;nbits_in_reservoir += 8; \</span>
<span class="cp">    } \</span>
<span class="cp">}  while(0);</span>

<span class="cp">#define skip_nbits(pdec, nbits_to_skip) do { \</span>
<span class="cp">   pdec-&gt;reservoir &gt;&gt;= (nbits_to_skip); \</span>
<span class="cp">   pdec-&gt;nbits_in_reservoir -= (nbits_to_skip); \</span>
<span class="cp">}  while(0);</span>

<span class="cp">#define get_nbits(pdec, nbits_wanted, result) do { \</span>
<span class="cp">   fill_nbits(pdec, nbits_wanted); \</span>
<span class="cp">   result = (pdec-&gt;reservoir) &amp; ((1U&lt;&lt;(nbits_wanted))-1); \</span>
<span class="cp">   skip_nbits(pdec, nbits_wanted); \</span>
<span class="cp">}  while(0);</span>

<span class="cp">#define __get_nbits(pdec, nbits_wanted, result) do { \</span>
<span class="cp">   result = (pdec-&gt;reservoir) &amp; ((1U&lt;&lt;(nbits_wanted))-1); \</span>
<span class="cp">   skip_nbits(pdec, nbits_wanted); \</span>
<span class="cp">}  while(0);</span>

<span class="cp">#define look_nbits(pdec, nbits_wanted) \</span>
<span class="cp">   ((pdec-&gt;reservoir) &amp; ((1U&lt;&lt;(nbits_wanted))-1))</span>

<span class="cm">/*</span>
<span class="cm"> * Decode a 4x4 pixel block</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">decode_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_dec23_private</span> <span class="o">*</span><span class="n">pdec</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptable0004</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptable8004</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">primary_color</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel_v</span><span class="p">,</span> <span class="n">offset1</span><span class="p">,</span> <span class="n">op</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">fill_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">__get_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbits</span><span class="p">,</span> <span class="n">primary_color</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">look_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skip_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/* Very simple, the color is the same for all pixels of the square */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">temp_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_dc00</span><span class="p">[</span><span class="n">primary_color</span><span class="p">];</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This block is encoded with small pattern */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">temp_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_d800</span><span class="p">[</span><span class="n">primary_color</span><span class="p">];</span>

	<span class="n">__get_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">channel_v</span><span class="p">);</span>
	<span class="n">channel_v</span> <span class="o">=</span> <span class="p">((</span><span class="n">channel_v</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">channel_v</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">channel_v</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">ptable0004</span> <span class="o">+=</span> <span class="p">(</span><span class="n">channel_v</span> <span class="o">*</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">ptable8004</span> <span class="o">+=</span> <span class="p">(</span><span class="n">channel_v</span> <span class="o">*</span> <span class="mi">32</span><span class="p">);</span>

	<span class="n">offset1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span>
	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">htable_idx</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">block</span><span class="p">;</span>

		<span class="cm">/* [  zzzz y x x ]</span>
<span class="cm">		 *     xx == 00 :=&gt; end of the block def, remove the two bits from the stream</span>
<span class="cm">		 *    yxx == 111</span>
<span class="cm">		 *    yxx == any other value</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="n">fill_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">htable_idx</span> <span class="o">=</span> <span class="n">look_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">op</span> <span class="o">=</span> <span class="n">hash_table_ops</span><span class="p">[</span><span class="n">htable_idx</span> <span class="o">*</span> <span class="mi">4</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skip_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">op</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* 15bits [ xxxx xxxx yyyy 111 ]</span>
<span class="cm">			 * yyy =&gt; offset in the table8004</span>
<span class="cm">			 * xxx =&gt; offset in the tabled004 (tree)</span>
<span class="cm">			 */</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbits</span><span class="p">,</span> <span class="n">col1</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yyyy</span><span class="p">;</span>

			<span class="n">skip_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
			<span class="cm">/* offset1 += yyyy */</span>
			<span class="n">__get_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">yyyy</span><span class="p">);</span>
			<span class="n">offset1</span> <span class="o">+=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">yyyy</span><span class="p">;</span>
			<span class="n">offset1</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>
			<span class="n">nbits</span> <span class="o">=</span> <span class="n">ptable8004</span><span class="p">[</span><span class="n">offset1</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>

			<span class="cm">/* col1 = xxxx xxxx */</span>
			<span class="n">__get_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="n">nbits</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">col1</span><span class="p">);</span>

			<span class="cm">/* Bit mask table */</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_bitpowermask</span><span class="p">[</span><span class="n">nbits</span><span class="p">][</span><span class="n">col1</span><span class="p">];</span>
			<span class="n">shift</span> <span class="o">=</span> <span class="n">ptable8004</span><span class="p">[</span><span class="n">offset1</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">rows</span> <span class="o">=</span> <span class="p">((</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

			<span class="n">block</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_subblock</span><span class="p">[</span><span class="n">rows</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">temp_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">block</span><span class="p">[</span><span class="n">MulIdx</span><span class="p">[</span><span class="n">offset1</span><span class="p">][</span><span class="n">i</span><span class="p">]];</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* op == 0</span>
<span class="cm">			 * offset1 is coded on 3 bits</span>
<span class="cm">			 */</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>

			<span class="n">offset1</span> <span class="o">+=</span> <span class="n">hash_table_ops</span> <span class="p">[</span><span class="n">htable_idx</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">2</span><span class="p">];</span>
			<span class="n">offset1</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>

			<span class="n">rows</span> <span class="o">=</span> <span class="n">ptable0004</span><span class="p">[</span><span class="n">offset1</span> <span class="o">+</span> <span class="n">hash_table_ops</span> <span class="p">[</span><span class="n">htable_idx</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]];</span>
			<span class="n">block</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_subblock</span><span class="p">[</span><span class="n">rows</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">temp_colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">block</span><span class="p">[</span><span class="n">MulIdx</span><span class="p">[</span><span class="n">offset1</span><span class="p">][</span><span class="n">i</span><span class="p">]];</span>

			<span class="n">shift</span> <span class="o">=</span> <span class="n">hash_table_ops</span><span class="p">[</span><span class="n">htable_idx</span> <span class="o">*</span> <span class="mi">4</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">skip_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">op</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">DecompressBand23</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_dec23_private</span> <span class="o">*</span><span class="n">pdec</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rawyuv</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">planar_y</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">planar_u</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">planar_v</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">compressed_image_width</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">real_image_width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">compression_index</span><span class="p">,</span> <span class="n">nblocks</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptable0004</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptable8004</span><span class="p">;</span>

	<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">reservoir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">nbits_in_reservoir</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pdec</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">=</span> <span class="n">rawyuv</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* The first byte of the stream is skipped */</span>

	<span class="n">get_nbits</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">compression_index</span><span class="p">);</span>

	<span class="cm">/* pass 1: uncompress Y component */</span>
	<span class="n">nblocks</span> <span class="o">=</span> <span class="n">compressed_image_width</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ptable0004</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_0004_pass1</span><span class="p">[</span><span class="n">compression_index</span><span class="p">];</span>
	<span class="n">ptable8004</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_8004_pass1</span><span class="p">[</span><span class="n">compression_index</span><span class="p">];</span>

	<span class="cm">/* Each block decode a square of 4x4 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nblocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">decode_block</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="n">ptable0004</span><span class="p">,</span> <span class="n">ptable8004</span><span class="p">);</span>
		<span class="n">copy_image_block_Y</span><span class="p">(</span><span class="n">pdec</span><span class="o">-&gt;</span><span class="n">temp_colors</span><span class="p">,</span> <span class="n">planar_y</span><span class="p">,</span> <span class="n">real_image_width</span><span class="p">,</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">scalebits</span><span class="p">);</span>
		<span class="n">planar_y</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">nblocks</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* pass 2: uncompress UV component */</span>
	<span class="n">nblocks</span> <span class="o">=</span> <span class="n">compressed_image_width</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">ptable0004</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_0004_pass2</span><span class="p">[</span><span class="n">compression_index</span><span class="p">];</span>
	<span class="n">ptable8004</span> <span class="o">=</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">table_8004_pass2</span><span class="p">[</span><span class="n">compression_index</span><span class="p">];</span>

	<span class="cm">/* Each block decode a square of 4x4 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">nblocks</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">decode_block</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="n">ptable0004</span><span class="p">,</span> <span class="n">ptable8004</span><span class="p">);</span>
		<span class="n">copy_image_block_CrCb</span><span class="p">(</span><span class="n">pdec</span><span class="o">-&gt;</span><span class="n">temp_colors</span><span class="p">,</span> <span class="n">planar_u</span><span class="p">,</span> <span class="n">real_image_width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">scalebits</span><span class="p">);</span>

		<span class="n">decode_block</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="n">ptable0004</span><span class="p">,</span> <span class="n">ptable8004</span><span class="p">);</span>
		<span class="n">copy_image_block_CrCb</span><span class="p">(</span><span class="n">pdec</span><span class="o">-&gt;</span><span class="n">temp_colors</span><span class="p">,</span> <span class="n">planar_v</span><span class="p">,</span> <span class="n">real_image_width</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="n">pdec</span><span class="o">-&gt;</span><span class="n">scalebits</span><span class="p">);</span>

		<span class="n">planar_v</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">planar_u</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">nblocks</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> *</span>
<span class="cm"> * Uncompress a pwc23 buffer.</span>
<span class="cm"> *</span>
<span class="cm"> * src: raw data</span>
<span class="cm"> * dst: image output</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pwc_dec23_decompress</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
			  <span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bandlines_left</span><span class="p">,</span> <span class="n">bytes_per_block</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pwc_dec23_private</span> <span class="o">*</span><span class="n">pdec</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dec23</span><span class="p">;</span>

	<span class="cm">/* YUV420P image format */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pout_planar_y</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pout_planar_u</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pout_planar_v</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>   <span class="n">plane_size</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdec</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">bandlines_left</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">bytes_per_block</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">plane_size</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="n">pout_planar_y</span> <span class="o">=</span> <span class="n">dst</span><span class="p">;</span>
	<span class="n">pout_planar_u</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">plane_size</span><span class="p">;</span>
	<span class="n">pout_planar_v</span> <span class="o">=</span> <span class="n">dst</span> <span class="o">+</span> <span class="n">plane_size</span> <span class="o">+</span> <span class="n">plane_size</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">bandlines_left</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DecompressBand23</span><span class="p">(</span><span class="n">pdec</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span>
				 <span class="n">pout_planar_y</span><span class="p">,</span> <span class="n">pout_planar_u</span><span class="p">,</span> <span class="n">pout_planar_v</span><span class="p">,</span>
				 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vbandlength</span><span class="p">;</span>
		<span class="n">pout_planar_y</span> <span class="o">+=</span> <span class="n">bytes_per_block</span><span class="p">;</span>
		<span class="n">pout_planar_u</span> <span class="o">+=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">pout_planar_v</span> <span class="o">+=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdec</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
