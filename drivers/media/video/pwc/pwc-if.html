<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › pwc › pwc-if.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pwc-if.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* Linux driver for Philips webcam</span>
<span class="cm">   USB and Video4Linux interface part.</span>
<span class="cm">   (C) 1999-2004 Nemosoft Unv.</span>
<span class="cm">   (C) 2004-2006 Luc Saillard (luc@saillard.org)</span>
<span class="cm">   (C) 2011 Hans de Goede &lt;hdegoede@redhat.com&gt;</span>

<span class="cm">   NOTE: this version of pwc is an unofficial (modified) release of pwc &amp; pcwx</span>
<span class="cm">   driver and thus may have bugs that are not present in the original version.</span>
<span class="cm">   Please send bug reports and support requests to &lt;luc@saillard.org&gt;.</span>
<span class="cm">   The decompression routines have been implemented by reverse-engineering the</span>
<span class="cm">   Nemosoft binary pwcx module. Caveat emptor.</span>

<span class="cm">   This program is free software; you can redistribute it and/or modify</span>
<span class="cm">   it under the terms of the GNU General Public License as published by</span>
<span class="cm">   the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">   (at your option) any later version.</span>

<span class="cm">   This program is distributed in the hope that it will be useful,</span>
<span class="cm">   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">   GNU General Public License for more details.</span>

<span class="cm">   You should have received a copy of the GNU General Public License</span>
<span class="cm">   along with this program; if not, write to the Free Software</span>
<span class="cm">   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>

<span class="cm">*/</span>

<span class="cm">/*</span>
<span class="cm">   This code forms the interface between the USB layers and the Philips</span>
<span class="cm">   specific stuff. Some adanved stuff of the driver falls under an</span>
<span class="cm">   NDA, signed between me and Philips B.V., Eindhoven, the Netherlands, and</span>
<span class="cm">   is thus not distributed in source form. The binary pwcx.o module</span>
<span class="cm">   contains the code that falls under the NDA.</span>

<span class="cm">   In case you&#39;re wondering: &#39;pwc&#39; stands for &quot;Philips WebCam&quot;, but</span>
<span class="cm">   I really didn&#39;t want to type &#39;philips_web_cam&#39; every time (I&#39;m lazy as</span>
<span class="cm">   any Linux kernel hacker, but I don&#39;t like uncomprehensible abbreviations</span>
<span class="cm">   without explanation).</span>

<span class="cm">   Oh yes, convention: to disctinguish between all the various pointers to</span>
<span class="cm">   device-structures, I use these names for the pointer variables:</span>
<span class="cm">   udev: struct usb_device *</span>
<span class="cm">   vdev: struct video_device (member of pwc_dev)</span>
<span class="cm">   pdev: struct pwc_devive *</span>
<span class="cm">*/</span>

<span class="cm">/* Contributors:</span>
<span class="cm">   - Alvarado: adding whitebalance code</span>
<span class="cm">   - Alistar Moire: QuickCam 3000 Pro device/product ID</span>
<span class="cm">   - Tony Hoyle: Creative Labs Webcam 5 device/product ID</span>
<span class="cm">   - Mark Burazin: solving hang in VIDIOCSYNC when camera gets unplugged</span>
<span class="cm">   - Jk Fang: Sotec Afina Eye ID</span>
<span class="cm">   - Xavier Roche: QuickCam Pro 4000 ID</span>
<span class="cm">   - Jens Knudsen: QuickCam Zoom ID</span>
<span class="cm">   - J. Debert: QuickCam for Notebooks ID</span>
<span class="cm">   - Pham Thanh Nam: webcam snapshot button as an event input device</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#ifdef CONFIG_USB_PWC_INPUT_EVDEV</span>
<span class="cp">#include &lt;linux/usb/input.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;		</span><span class="cm">/* simple_strtol() */</span><span class="cp"></span>

<span class="cp">#include &quot;pwc.h&quot;</span>
<span class="cp">#include &quot;pwc-kiara.h&quot;</span>
<span class="cp">#include &quot;pwc-timon.h&quot;</span>
<span class="cp">#include &quot;pwc-dec23.h&quot;</span>
<span class="cp">#include &quot;pwc-dec1.h&quot;</span>

<span class="cm">/* Function prototypes and driver templates */</span>

<span class="cm">/* hotplug device table support */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">pwc_device_table</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0302</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Philips models */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0303</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0304</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0307</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0308</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x030C</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0310</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0311</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Philips ToUcam PRO II */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0312</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0313</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* the &#39;new&#39; 720K */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0471</span><span class="p">,</span> <span class="mh">0x0329</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Philips SPC 900NC PC Camera */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x069A</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Askey */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08B0</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Logitech QuickCam Pro 3000 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08B1</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Logitech QuickCam Notebook Pro */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08B2</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Logitech QuickCam Pro 4000 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08B3</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Logitech QuickCam Zoom (old model) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08B4</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Logitech QuickCam Zoom (new model) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08B5</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Logitech QuickCam Orbit/Sphere */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08B6</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Cisco VT Camera */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08B7</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Logitech ViewPort AV 100 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046D</span><span class="p">,</span> <span class="mh">0x08B8</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Logitech (reserved) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x055D</span><span class="p">,</span> <span class="mh">0x9000</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Samsung MPC-C10 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x055D</span><span class="p">,</span> <span class="mh">0x9001</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Samsung MPC-C30 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x055D</span><span class="p">,</span> <span class="mh">0x9002</span><span class="p">)</span> <span class="p">},</span>	<span class="cm">/* Samsung SNC-35E (Ver3.0) */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x041E</span><span class="p">,</span> <span class="mh">0x400C</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Creative Webcam 5 */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x041E</span><span class="p">,</span> <span class="mh">0x4011</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Creative Webcam Pro Ex */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x04CC</span><span class="p">,</span> <span class="mh">0x8116</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Afina Eye */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x06BE</span><span class="p">,</span> <span class="mh">0x8116</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* new Afina Eye */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0d81</span><span class="p">,</span> <span class="mh">0x1910</span><span class="p">)</span> <span class="p">},</span> <span class="cm">/* Visionite */</span>
	<span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x0d81</span><span class="p">,</span> <span class="mh">0x1900</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">pwc_device_table</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">usb_pwc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">usb_pwc_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pwc_isoc_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">pwc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>			<span class="s">&quot;Philips webcam&quot;</span><span class="p">,</span>	<span class="cm">/* name */</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>		<span class="n">pwc_device_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>		<span class="n">usb_pwc_probe</span><span class="p">,</span>		<span class="cm">/* probe() */</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>		<span class="n">usb_pwc_disconnect</span><span class="p">,</span>	<span class="cm">/* disconnect() */</span>
<span class="p">};</span>

<span class="cp">#define MAX_DEV_HINTS	20</span>
<span class="cp">#define MAX_ISOC_ERRORS	20</span>

<span class="cp">#ifdef CONFIG_USB_PWC_DEBUG</span>
	<span class="kt">int</span> <span class="n">pwc_trace</span> <span class="o">=</span> <span class="n">PWC_DEBUG_LEVEL</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">power_save</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">leds</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

<span class="cm">/***/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pwc_video_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="n">pwc_video_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pwc_video_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">pwc_video_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">pwc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span>	<span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>		<span class="n">v4l2_fh_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>     	<span class="n">pwc_video_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span>		<span class="n">pwc_video_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span>		<span class="n">pwc_video_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span>		<span class="n">pwc_video_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">pwc_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;Philips Webcam&quot;</span><span class="p">,</span>	<span class="cm">/* Filled in later */</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span>	<span class="n">video_device_release_empty</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span>         <span class="o">&amp;</span><span class="n">pwc_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> <span class="o">=</span>	<span class="o">&amp;</span><span class="n">pwc_ioctl_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/***************************************************************************/</span>
<span class="cm">/* Private functions */</span>

<span class="k">struct</span> <span class="n">pwc_frame_buf</span> <span class="o">*</span><span class="nf">pwc_get_next_fill_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pwc_frame_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pwc_frame_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
<span class="nl">leave:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwc_snapshot_button</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">down</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">down</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_TRACE</span><span class="p">(</span><span class="s">&quot;Snapshot button pressed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PWC_TRACE</span><span class="p">(</span><span class="s">&quot;Snapshot button released.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_USB_PWC_INPUT_EVDEV</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="p">,</span> <span class="n">KEY_CAMERA</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwc_frame_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_frame_buf</span> <span class="o">*</span><span class="n">fbuf</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span><span class="p">;</span>

	<span class="cm">/* The ToUCam Fun CMOS sensor causes the firmware to send 2 or 3 bogus</span>
<span class="cm">	   frames on the USB wire after an exposure change. This conditition is</span>
<span class="cm">	   however detected  in the cam and a bit is set in the header.</span>
<span class="cm">	   */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">730</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PWC_TRACE</span><span class="p">(</span><span class="s">&quot;Hyundai CMOS sensor bug. Dropping frame.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">drop_frames</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmirror</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pwc_snapshot_button</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmirror</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
				<span class="n">PWC_TRACE</span><span class="p">(</span><span class="s">&quot;Image is mirrored.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">PWC_TRACE</span><span class="p">(</span><span class="s">&quot;Image is normal.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmirror</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
		<span class="cm">/* Sometimes the trailer of the 730 is still sent as a 4 byte packet</span>
<span class="cm">		   after a short frame; this condition is filtered out specifically. A 4 byte</span>
<span class="cm">		   frame doesn&#39;t make sense anyway.</span>
<span class="cm">		   So we get either this sequence:</span>
<span class="cm">		   drop_bit set -&gt; 4 byte frame -&gt; short frame -&gt; good frame</span>
<span class="cm">		   Or this one:</span>
<span class="cm">		   drop_bit set -&gt; short frame -&gt; good frame</span>
<span class="cm">		   So we drop either 3 or 2 frames in all!</span>
<span class="cm">		   */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">drop_frames</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">740</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mi">720</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">^</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmirror</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pwc_snapshot_button</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmirror</span> <span class="o">=</span> <span class="n">ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In case we were instructed to drop the frame, do so silently. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">drop_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">drop_frames</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Check for underflow first */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&lt;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">frame_total_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PWC_DEBUG_FLOW</span><span class="p">(</span><span class="s">&quot;Frame buffer underflow (%d bytes);&quot;</span>
				       <span class="s">&quot; discarded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">filled</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
			<span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vframe_count</span><span class="p">;</span>
			<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_DONE</span><span class="p">);</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="cm">/* !drop_frames */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vframe_count</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This gets called for the Isochronous pipe (video). This is done in</span>
<span class="cm"> * interrupt time, so it has to be fast, not crash, and not stall. Neat.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwc_isoc_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fst</span><span class="p">,</span> <span class="n">flen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">iso_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">||</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ECONNRESET</span> <span class="o">||</span>
	    <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_DEBUG_OPEN</span><span class="p">(</span><span class="s">&quot;URB (%p) unlinked %ssynchronuously.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">,</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;a&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span> <span class="o">=</span> <span class="n">pwc_get_next_fill_buf</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">errmsg</span><span class="p">;</span>

		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Unknown&quot;</span><span class="p">;</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ENOSR</span>:		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Buffer error (overrun)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EPIPE</span>:		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Stalled (device not responding)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EOVERFLOW</span>:	<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Babble (bad cable?)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EPROTO</span>:		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Bit-stuff error (bad cable?)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">EILSEQ</span>:		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;CRC/Timeout (could be anything)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="o">-</span><span class="n">ETIME</span>:		<span class="n">errmsg</span> <span class="o">=</span> <span class="s">&quot;Device does not respond&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;pwc_isoc_handler() called with status %d [%s].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">errmsg</span><span class="p">);</span>
		<span class="cm">/* Give up after a number of contiguous errors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">visoc_errors</span> <span class="o">&gt;</span> <span class="n">MAX_ISOC_ERRORS</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Too many ISOC errors, bailing out.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span>
						<span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Drop the current frame */</span>
		<span class="k">goto</span> <span class="n">handler_end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reset ISOC error counter. We did get here, after all. */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">visoc_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* vsync: 0 = don&#39;t copy data</span>
<span class="cm">		  1 = sync-hunt</span>
<span class="cm">		  2 = synched</span>
<span class="cm">	 */</span>
	<span class="cm">/* Compact data */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fst</span>  <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>
		<span class="n">flen</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="n">iso_buf</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fst</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Iso frame %d has error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">fst</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flen</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vsync</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">pwc_frame_buf</span> <span class="o">*</span><span class="n">fbuf</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">v4l2_buf</span><span class="p">.</span><span class="n">timestamp</span><span class="p">);</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">flen</span> <span class="o">+</span> <span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">&gt;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">frame_total_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Frame overflow (%d &gt; %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">flen</span> <span class="o">+</span> <span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">filled</span><span class="p">,</span>
					  <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">frame_total_size</span><span class="p">);</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Let&#39;s wait for an EOF */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">filled</span><span class="p">,</span> <span class="n">iso_buf</span><span class="p">,</span>
				       <span class="n">flen</span><span class="p">);</span>
				<span class="n">fbuf</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">+=</span> <span class="n">flen</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flen</span> <span class="o">&lt;</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vlast_packet_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Shorter packet... end of frame */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">pwc_frame_complete</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span> <span class="o">=</span> <span class="n">pwc_get_next_fill_buf</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vlast_packet_size</span> <span class="o">=</span> <span class="n">flen</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">handler_end:</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Error (%d) re-submitting urb in pwc_isoc_handler.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Both v4l2_lock and vb_queue_lock should be locked when calling this */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pwc_isoc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">idesc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">compression</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* 0..3 = uncompressed..high */</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vsync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vlast_packet_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">fill_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vframe_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">visoc_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">udev</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>

<span class="nl">retry:</span>
	<span class="cm">/* We first try with low compression and then retry with a higher</span>
<span class="cm">	   compression setting if there is not enough bandwidth. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pwc_set_video_mode</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">pixfmt</span><span class="p">,</span>
				 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vframes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compression</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Get the current alternate interface, adjust packet size */</span>
	<span class="n">intf</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="p">)</span>
		<span class="n">idesc</span> <span class="o">=</span> <span class="n">usb_altnum_to_altsetting</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">valternate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idesc</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Search video endpoint */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmax_packet_size</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">idesc</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">idesc</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">==</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendpoint</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmax_packet_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">idesc</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmax_packet_size</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmax_packet_size</span> <span class="o">&gt;</span> <span class="n">ISO_MAX_FRAME_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to find packet size for video endpoint in current alternate setting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENFILE</span><span class="p">;</span> <span class="cm">/* Odd error, that should be noticeable */</span>
	<span class="p">}</span>

	<span class="cm">/* Set alternate interface */</span>
	<span class="n">PWC_DEBUG_OPEN</span><span class="p">(</span><span class="s">&quot;Setting alternate interface %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">valternate</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">valternate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span> <span class="o">&amp;&amp;</span> <span class="n">compression</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">compression</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Allocate and init Isochronuous urbs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_ISO_BUFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">ISO_FRAMES_PER_DESC</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to allocate urb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">pwc_isoc_cleanup</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
		<span class="n">PWC_DEBUG_MEMORY</span><span class="p">(</span><span class="s">&quot;Allocated URB at 0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>

		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// devik</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendpoint</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span> <span class="o">|</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span>
							  <span class="n">ISO_BUFFER_SIZE</span><span class="p">,</span>
							  <span class="n">GFP_KERNEL</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to allocate urb buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">pwc_isoc_cleanup</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span> <span class="n">ISO_BUFFER_SIZE</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">pwc_isoc_handler</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">start_frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">ISO_FRAMES_PER_DESC</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ISO_FRAMES_PER_DESC</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">j</span> <span class="o">*</span> <span class="n">ISO_MAX_FRAME_SIZE</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vmax_packet_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* link */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_ISO_BUFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span> <span class="o">&amp;&amp;</span> <span class="n">compression</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">compression</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pwc_isoc_cleanup</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;isoc_init() submit_urb %d failed with error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">pwc_isoc_cleanup</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PWC_DEBUG_MEMORY</span><span class="p">(</span><span class="s">&quot;URB 0x%p submitted.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* All is done... */</span>
	<span class="n">PWC_DEBUG_OPEN</span><span class="p">(</span><span class="s">&quot;&lt;&lt; pwc_isoc_init()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwc_iso_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Unlinking ISOC buffers one by one */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_ISO_BUFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">PWC_DEBUG_MEMORY</span><span class="p">(</span><span class="s">&quot;Unlinking URB %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwc_iso_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Freeing ISOC buffers one by one */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_ISO_BUFS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">PWC_DEBUG_MEMORY</span><span class="p">(</span><span class="s">&quot;Freeing URB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
					<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span><span class="p">,</span>
					<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span><span class="p">,</span>
					<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">urbs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Both v4l2_lock and vb_queue_lock should be locked when calling this */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwc_isoc_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PWC_DEBUG_OPEN</span><span class="p">(</span><span class="s">&quot;&gt;&gt; pwc_isoc_cleanup()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">pwc_iso_stop</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pwc_iso_free</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">usb_set_interface</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">PWC_DEBUG_OPEN</span><span class="p">(</span><span class="s">&quot;&lt;&lt; pwc_isoc_cleanup()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Must be called with vb_queue_lock hold */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwc_cleanup_queued_bufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pwc_frame_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pwc_frame_buf</span><span class="p">,</span>
				 <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_USB_PWC_DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pwc_sensor_type_to_string</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sensor_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">sensor_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>:
			<span class="k">return</span> <span class="s">&quot;Hyundai CMOS sensor&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x20</span>:
			<span class="k">return</span> <span class="s">&quot;Sony CCD sensor + TDA8787&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x2E</span>:
			<span class="k">return</span> <span class="s">&quot;Sony CCD sensor + Exas 98L59&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x2F</span>:
			<span class="k">return</span> <span class="s">&quot;Sony CCD sensor + ADI 9804&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x30</span>:
			<span class="k">return</span> <span class="s">&quot;Sharp CCD sensor + TDA8787&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x3E</span>:
			<span class="k">return</span> <span class="s">&quot;Sharp CCD sensor + Exas 98L59&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x3F</span>:
			<span class="k">return</span> <span class="s">&quot;Sharp CCD sensor + ADI 9804&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x40</span>:
			<span class="k">return</span> <span class="s">&quot;UPA 1021 sensor&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x100</span>:
			<span class="k">return</span> <span class="s">&quot;VGA sensor&quot;</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x101</span>:
			<span class="k">return</span> <span class="s">&quot;PAL MR sensor&quot;</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="s">&quot;unknown type of sensor&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/***************************************************************************/</span>
<span class="cm">/* Video4Linux functions */</span>

<span class="kt">int</span> <span class="nf">pwc_test_n_set_capt_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">!=</span> <span class="n">file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pwc_video_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pwc_device</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ctrl_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pwc_video_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we&#39;re still streaming vb2_queue_release will call stream_stop</span>
<span class="cm">	 * so we must take both the v4l2_lock and the vb_queue_lock.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">==</span> <span class="n">file</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_queue_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">);</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">capt_file</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_fh_release</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pwc_video_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">lock_v4l2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pwc_test_n_set_capt_file</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* stream_start will get called so we must take the v4l2_lock */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">.</span><span class="n">fileio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">lock_v4l2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Use try_lock, since we&#39;re taking the locks in the *wrong* order! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock_v4l2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span>
		       <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock_v4l2</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pwc_video_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">req_events</span> <span class="o">=</span> <span class="n">poll_requested_events</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">POLL_ERR</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lock_v4l2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">POLL_ERR</span><span class="p">;</span>

	<span class="cm">/* Will this start fileio and thus call start_stream? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">req_events</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">q</span><span class="o">-&gt;</span><span class="n">num_buffers</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">&amp;&amp;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">fileio</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pwc_test_n_set_capt_file</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">file</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">lock_v4l2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use try_lock, since we&#39;re taking the locks in the *wrong* order! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock_v4l2</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock_v4l2</span><span class="p">)</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">POLLHUP</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pwc_video_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pwc_test_n_set_capt_file</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vb2_mmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***************************************************************************/</span>
<span class="cm">/* Videobuf2 operations */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">queue_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nbuffers</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">nplanes</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sizes</span><span class="p">[],</span> <span class="kt">void</span> <span class="o">*</span><span class="n">alloc_ctxs</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vb2_get_drv_priv</span><span class="p">(</span><span class="n">vq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nbuffers</span> <span class="o">&lt;</span> <span class="n">MIN_FRAMES</span><span class="p">)</span>
		<span class="o">*</span><span class="n">nbuffers</span> <span class="o">=</span> <span class="n">MIN_FRAMES</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nbuffers</span> <span class="o">&gt;</span> <span class="n">MAX_FRAMES</span><span class="p">)</span>
		<span class="o">*</span><span class="n">nbuffers</span> <span class="o">=</span> <span class="n">MAX_FRAMES</span><span class="p">;</span>

	<span class="o">*</span><span class="n">nplanes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">pwc_get_size</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MAX_WIDTH</span><span class="p">,</span> <span class="n">MAX_HEIGHT</span><span class="p">);</span>
	<span class="n">sizes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">pwc_image_sizes</span><span class="p">[</span><span class="n">size</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span>
			      <span class="n">pwc_image_sizes</span><span class="p">[</span><span class="n">size</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_frame_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pwc_frame_buf</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>

	<span class="cm">/* need vmalloc since frame buffer &gt; 128K */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">vzalloc</span><span class="p">(</span><span class="n">PWC_FRAME_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vb2_get_drv_priv</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t allow queing new buffers after device disconnection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vb2_get_drv_priv</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pwc_frame_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pwc_frame_buf</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Application has called dqbuf and is getting back a buffer we&#39;ve</span>
<span class="cm">	 * filled, take the pwc data we&#39;ve stored in buf-&gt;data and decompress</span>
<span class="cm">	 * it into a usable format, storing the result in the vb2_buffer</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">pwc_decompress</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buffer_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_frame_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pwc_frame_buf</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buffer_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vb2_get_drv_priv</span><span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">vb2_queue</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pwc_frame_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pwc_frame_buf</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check the device has not disconnected between prep and queuing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb2_buffer_done</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="n">VB2_BUF_STATE_ERROR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vb2_get_drv_priv</span><span class="p">(</span><span class="n">vq</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* Turn on camera and set LEDS on */</span>
	<span class="n">pwc_camera_power</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pwc_set_leds</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">leds</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">leds</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">pwc_isoc_init</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we failed turn camera and LEDS back off */</span>
		<span class="n">pwc_set_leds</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pwc_camera_power</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* And cleanup any queued bufs!! */</span>
		<span class="n">pwc_cleanup_queued_bufs</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vb2_get_drv_priv</span><span class="p">(</span><span class="n">vq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pwc_set_leds</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pwc_camera_power</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pwc_isoc_cleanup</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pwc_cleanup_queued_bufs</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vb2_get_drv_priv</span><span class="p">(</span><span class="n">vq</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wait_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">vb2_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">vb2_get_drv_priv</span><span class="p">(</span><span class="n">vq</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vb2_ops</span> <span class="n">pwc_vb_queue_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queue_setup</span>		<span class="o">=</span> <span class="n">queue_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_init</span>		<span class="o">=</span> <span class="n">buffer_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span>		<span class="o">=</span> <span class="n">buffer_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_finish</span>		<span class="o">=</span> <span class="n">buffer_finish</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_cleanup</span>		<span class="o">=</span> <span class="n">buffer_cleanup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span>		<span class="o">=</span> <span class="n">buffer_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start_streaming</span>	<span class="o">=</span> <span class="n">start_streaming</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop_streaming</span>		<span class="o">=</span> <span class="n">stop_streaming</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_prepare</span>		<span class="o">=</span> <span class="n">wait_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wait_finish</span>		<span class="o">=</span> <span class="n">wait_finish</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/***************************************************************************/</span>
<span class="cm">/* USB functions */</span>

<span class="cm">/* This function gets called when a new device is plugged in or the usb core</span>
<span class="cm"> * is loaded.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usb_pwc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vendor_id</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span> <span class="n">type_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">features</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">compression</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">my_power_save</span> <span class="o">=</span> <span class="n">power_save</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">serial_number</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">vendor_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">);</span>
	<span class="n">product_id</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">);</span>

	<span class="cm">/* Check if we can handle this device */</span>
	<span class="n">PWC_DEBUG_PROBE</span><span class="p">(</span><span class="s">&quot;probe() called [%04X %04X], if %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vendor_id</span><span class="p">,</span> <span class="n">product_id</span><span class="p">,</span>
		<span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>

	<span class="cm">/* the interfaces are probed one by one. We are only interested in the</span>
<span class="cm">	   video interface (0) now.</span>
<span class="cm">	   Interface 1 is the Audio Control, and interface 2 Audio itself.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x0471</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0302</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips PCA645VC USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips 645 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">645</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0303</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips PCA646VC USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips 646 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">646</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0304</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Askey VC010 type 2 USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Askey VC010 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">646</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0307</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips PCVC675K (Vesta) USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips 675 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">675</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0308</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips PCVC680K (Vesta Pro) USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips 680 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">680</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x030C</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips PCVC690K (Vesta Pro Scan) USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips 690 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">690</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0310</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips PCVC730K (ToUCam Fun)/PCVC830 (ToUCam II) USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips 730 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">730</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0311</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips PCVC740K (ToUCam Pro)/PCVC840 (ToUCam II) USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips 740 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0312</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips PCVC750K (ToUCam Pro Scan) USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips 750 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">750</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0313</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips PCVC720K/40 (ToUCam XS) USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips 720K/40 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0329</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Philips SPC 900NC USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Philips SPC 900NC webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x069A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0001</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Askey VC010 type 1 USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Askey VC010 webcam&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">645</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x046d</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x08b0</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Logitech QuickCam Pro 3000 USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Logitech QuickCam Pro 3000&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span> <span class="cm">/* CCD sensor */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08b1</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Logitech QuickCam Notebook Pro USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Logitech QuickCam Notebook Pro&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span> <span class="cm">/* CCD sensor */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08b2</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Logitech QuickCam 4000 Pro USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Logitech QuickCam Pro 4000&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span> <span class="cm">/* CCD sensor */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">my_power_save</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">my_power_save</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08b3</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Logitech QuickCam Zoom USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Logitech QuickCam Zoom&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span> <span class="cm">/* CCD sensor */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08B4</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Logitech QuickCam Zoom (new model) USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Logitech QuickCam Zoom&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span> <span class="cm">/* CCD sensor */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">my_power_save</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">my_power_save</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08b5</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Logitech QuickCam Orbit/Sphere USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Logitech QuickCam Orbit&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span> <span class="cm">/* CCD sensor */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">my_power_save</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">my_power_save</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">features</span> <span class="o">|=</span> <span class="n">FEATURE_MOTOR_PANTILT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08b6</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Logitech/Cisco VT Camera webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Cisco VT Camera&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span> <span class="cm">/* CCD sensor */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08b7</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Logitech ViewPort AV 100 webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Logitech ViewPort AV 100&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span> <span class="cm">/* CCD sensor */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08b8</span>: <span class="cm">/* Where this released? */</span>
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Logitech QuickCam detected (reserved ID).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Logitech QuickCam (res.)&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">730</span><span class="p">;</span> <span class="cm">/* Assuming CMOS */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x055d</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* I don&#39;t know the difference between the C10 and the C30;</span>
<span class="cm">		   I suppose the difference is the sensor, but both cameras</span>
<span class="cm">		   work equally well with a type_id of 675</span>
<span class="cm">		 */</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x9000</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Samsung MPC-C10 USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Samsung MPC-C10&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">675</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x9001</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Samsung MPC-C30 USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Samsung MPC-C30&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">675</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x9002</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Samsung SNC-35E (v3.0) USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Samsung MPC-C30&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x041e</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x400c</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Creative Labs Webcam 5 detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Creative Labs Webcam 5&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">730</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">my_power_save</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">my_power_save</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x4011</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Creative Labs Webcam Pro Ex detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Creative Labs Webcam Pro Ex&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x04cc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x8116</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Sotec Afina Eye USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Sotec Afina Eye&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">730</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x06be</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x8116</span>:
			<span class="cm">/* This is essentially the same cam as the Sotec Afina Eye */</span>
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;AME Co. Afina Eye USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;AME Co. Afina Eye&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">750</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vendor_id</span> <span class="o">==</span> <span class="mh">0x0d81</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">product_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x1900</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Visionite VCS-UC300 USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Visionite VCS-UC300&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">740</span><span class="p">;</span> <span class="cm">/* CCD sensor */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1910</span>:
			<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Visionite VCS-UM100 USB webcam detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Visionite VCS-UM100&quot;</span><span class="p">;</span>
			<span class="n">type_id</span> <span class="o">=</span> <span class="mi">730</span><span class="p">;</span> <span class="cm">/* CMOS sensor */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span> <span class="cm">/* Not any of the know types; but the list keeps growing. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">my_power_save</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">my_power_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">serial_number</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>
	<span class="n">usb_string</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">iSerialNumber</span><span class="p">,</span> <span class="n">serial_number</span><span class="p">,</span> <span class="mi">29</span><span class="p">);</span>
	<span class="n">PWC_DEBUG_PROBE</span><span class="p">(</span><span class="s">&quot;Device serial number is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">serial_number</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">PWC_WARNING</span><span class="p">(</span><span class="s">&quot;Warning: more than 1 configuration available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Allocate structure, initialize pointers, mutexes, etc. and link it to the usb_device */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Oops, could not allocate memory for pwc_device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type_id</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">=</span> <span class="n">features</span><span class="p">;</span>
	<span class="n">pwc_construct</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span> <span class="cm">/* set min/max sizes correct */</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs_lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">queued_bufs</span><span class="p">);</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">udev</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">power_save</span> <span class="o">=</span> <span class="n">my_power_save</span><span class="p">;</span>

	<span class="cm">/* Init videobuf2 queue structure */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">));</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">.</span><span class="n">io_modes</span> <span class="o">=</span> <span class="n">VB2_MMAP</span> <span class="o">|</span> <span class="n">VB2_USERPTR</span> <span class="o">|</span> <span class="n">VB2_READ</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">.</span><span class="n">drv_priv</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">.</span><span class="n">buf_struct_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pwc_frame_buf</span><span class="p">);</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pwc_vb_queue_ops</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">.</span><span class="n">mem_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vb2_vmalloc_memops</span><span class="p">;</span>
	<span class="n">vb2_queue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">);</span>

	<span class="cm">/* Init video_device structure */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pwc_template</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pwc_template</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_USE_FH_PRIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">pdev</span><span class="p">);</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bcdDevice</span><span class="p">);</span>
	<span class="n">PWC_DEBUG_PROBE</span><span class="p">(</span><span class="s">&quot;Release: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">);</span>

	<span class="cm">/* Allocate USB command buffers */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ctrl_buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">cmd_buf</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ctrl_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Oops, could not allocate memory for pwc_device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_mem</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_USB_PWC_DEBUG</span>
	<span class="cm">/* Query sensor type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pwc_get_cmos_sensor</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rc</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_DEBUG_OPEN</span><span class="p">(</span><span class="s">&quot;This %s camera is equipped with a %s (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="n">pwc_sensor_type_to_string</span><span class="p">(</span><span class="n">rc</span><span class="p">),</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Set the leds off */</span>
	<span class="n">pwc_set_leds</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Setup intial videomode */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pwc_set_video_mode</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">MAX_WIDTH</span><span class="p">,</span> <span class="n">MAX_HEIGHT</span><span class="p">,</span>
				<span class="n">V4L2_PIX_FMT_YUV420</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">compression</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_mem</span><span class="p">;</span>

	<span class="cm">/* Register controls (and read default values from camera */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pwc_init_controls</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to register v4l2 controls (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_mem</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* And powerdown the camera until streaming starts */</span>
	<span class="n">pwc_camera_power</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Register the v4l2_device structure */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">pwc_video_release</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to register v4l2-device (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_controls</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t take v4l2_lock for these ioctls. This improves latency if</span>
<span class="cm">	 * v4l2_lock is taken for a long time, e.g. when changing a control</span>
<span class="cm">	 * value, and a new frame is ready to be dequeued.</span>
<span class="cm">	 */</span>
	<span class="n">v4l2_disable_ioctl_locking</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VIDIOC_DQBUF</span><span class="p">);</span>
	<span class="n">v4l2_disable_ioctl_locking</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VIDIOC_QBUF</span><span class="p">);</span>
	<span class="n">v4l2_disable_ioctl_locking</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VIDIOC_QUERYBUF</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Failed to register as video device (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_unregister_v4l2_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PWC_INFO</span><span class="p">(</span><span class="s">&quot;Registered as %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">));</span>

<span class="cp">#ifdef CONFIG_USB_PWC_INPUT_EVDEV</span>
	<span class="cm">/* register webcam snapshot button input device */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PWC_ERROR</span><span class="p">(</span><span class="s">&quot;Err, insufficient memory for webcam snapshot button device.&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_video_unreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_phys</span><span class="p">));</span>
	<span class="n">strlcat</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_phys</span><span class="p">,</span> <span class="s">&quot;/input0&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_phys</span><span class="p">));</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;PWC snapshot button&quot;</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_phys</span><span class="p">;</span>
	<span class="n">usb_to_input_id</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">);</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">KEY_CAMERA</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">KEY_CAMERA</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_free_device</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="p">);</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_video_unreg</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_video_unreg:</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
<span class="nl">err_unregister_v4l2_dev:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="nl">err_free_controls:</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
<span class="nl">err_free_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">ctrl_buf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The user yanked out the cable... */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usb_pwc_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pwc_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pwc_device</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">);</span>
	<span class="cm">/* No need to keep the urbs around after disconnection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue</span><span class="p">.</span><span class="n">streaming</span><span class="p">)</span>
		<span class="n">pwc_isoc_cleanup</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pwc_cleanup_queued_bufs</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vb_queue_lock</span><span class="p">);</span>

	<span class="n">v4l2_device_disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_USB_PWC_INPUT_EVDEV</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="p">)</span>
		<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">button_dev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">v4l2_device_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Initialization code &amp; module stuff</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">leds_nargs</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_USB_PWC_DEBUG</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">pwc_trace</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">power_save</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">leds</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">leds_nargs</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_USB_PWC_DEBUG</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="s">&quot;For debugging purposes&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">power_save</span><span class="p">,</span> <span class="s">&quot;Turn power saving for new cameras on or off&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">leds</span><span class="p">,</span> <span class="s">&quot;LED on,off time in milliseconds&quot;</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Philips &amp; OEM USB webcam driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Luc Saillard &lt;luc@saillard.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;pwcx&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span> <span class="n">PWC_VERSION</span> <span class="p">);</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">pwc_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
