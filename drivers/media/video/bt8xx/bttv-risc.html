<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › bt8xx › bttv-risc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>bttv-risc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">    bttv-risc.c  --  interfaces to other kernel modules</span>

<span class="cm">    bttv risc code handling</span>
<span class="cm">	- memory management</span>
<span class="cm">	- generation</span>

<span class="cm">    (c) 2000-2003 Gerd Knorr &lt;kraxel@bytesex.org&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>

<span class="cm">*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;asm/page.h&gt;</span>
<span class="cp">#include &lt;asm/pgtable.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>

<span class="cp">#include &quot;bttvp.h&quot;</span>

<span class="cp">#define VCR_HACK_LINES 4</span>

<span class="cm">/* ---------------------------------------------------------- */</span>
<span class="cm">/* risc code generators                                       */</span>

<span class="kt">int</span>
<span class="nf">bttv_risc_packed</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpl</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">padding</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skip_lines</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">store_lines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">instructions</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">todo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sg</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* estimate risc mem: worst case is one write per page border +</span>
<span class="cm">	   one write per scan line + sync + jump (all 2 dwords).  padding</span>
<span class="cm">	   can cause next bpl to start close to a page border.  First DMA</span>
<span class="cm">	   region may be smaller than PAGE_SIZE */</span>
	<span class="n">instructions</span>  <span class="o">=</span> <span class="n">skip_lines</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">instructions</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">bpl</span> <span class="o">+</span> <span class="n">padding</span><span class="p">)</span> <span class="o">*</span> <span class="n">store_lines</span><span class="p">)</span>
			 <span class="o">/</span> <span class="n">PAGE_SIZE</span> <span class="o">+</span> <span class="n">store_lines</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">instructions</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="n">risc</span><span class="p">,</span><span class="n">instructions</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* sync instruction */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_SYNC</span><span class="o">|</span><span class="n">BT848_FIFO_STATUS_FM1</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">skip_lines</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_SKIP</span> <span class="o">|</span> <span class="n">BT848_RISC_SOL</span> <span class="o">|</span>
				      <span class="n">BT848_RISC_EOL</span> <span class="o">|</span> <span class="n">bpl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* scan lines */</span>
	<span class="n">sg</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">store_lines</span><span class="p">;</span> <span class="n">line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_vcr_hack</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">store_lines</span> <span class="o">-</span> <span class="n">VCR_HACK_LINES</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;&amp;</span> <span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
			<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bpl</span> <span class="o">&lt;=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* fits into current chunk */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_WRITE</span><span class="o">|</span><span class="n">BT848_RISC_SOL</span><span class="o">|</span>
					    <span class="n">BT848_RISC_EOL</span><span class="o">|</span><span class="n">bpl</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">offset</span><span class="o">+=</span><span class="n">bpl</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* scanline needs to be splitted */</span>
			<span class="n">todo</span> <span class="o">=</span> <span class="n">bpl</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_WRITE</span><span class="o">|</span><span class="n">BT848_RISC_SOL</span><span class="o">|</span>
					    <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">));</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">+</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">todo</span> <span class="o">-=</span> <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">)</span><span class="o">-</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">todo</span> <span class="o">&gt;</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_WRITE</span><span class="o">|</span>
						    <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
				<span class="n">todo</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">sg</span><span class="p">);</span>
				<span class="n">sg</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_WRITE</span><span class="o">|</span><span class="n">BT848_RISC_EOL</span><span class="o">|</span>
					    <span class="n">todo</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">sg</span><span class="p">));</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">todo</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">padding</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* save pointer to jmp instruction address */</span>
	<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">-</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bttv_risc_planar</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">sglist</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">yoffset</span><span class="p">,</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ybpl</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ypadding</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ylines</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uoffset</span><span class="p">,</span>  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">voffset</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">hshift</span><span class="p">,</span>   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vshift</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cpadding</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">instructions</span><span class="p">,</span><span class="n">line</span><span class="p">,</span><span class="n">todo</span><span class="p">,</span><span class="n">ylen</span><span class="p">,</span><span class="n">chroma</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ri</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">ysg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">usg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">vsg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">topfield</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">yoffset</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* estimate risc mem: worst case is one write per page border +</span>
<span class="cm">	   one write per scan line (5 dwords)</span>
<span class="cm">	   plus sync + jump (2 dwords) */</span>
	<span class="n">instructions</span>  <span class="o">=</span> <span class="p">((</span><span class="mi">3</span> <span class="o">+</span> <span class="p">(</span><span class="n">ybpl</span> <span class="o">+</span> <span class="n">ypadding</span><span class="p">)</span> <span class="o">*</span> <span class="n">ylines</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
			 <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">ylines</span><span class="p">;</span>
	<span class="n">instructions</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="n">risc</span><span class="p">,</span><span class="n">instructions</span><span class="o">*</span><span class="mi">4</span><span class="o">*</span><span class="mi">5</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* sync instruction */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_SYNC</span><span class="o">|</span><span class="n">BT848_FIFO_STATUS_FM3</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* scan lines */</span>
	<span class="n">ysg</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
	<span class="n">usg</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
	<span class="n">vsg</span> <span class="o">=</span> <span class="n">sglist</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">ylines</span><span class="p">;</span> <span class="n">line</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_vcr_hack</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ylines</span> <span class="o">-</span> <span class="n">VCR_HACK_LINES</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vshift</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">chroma</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">topfield</span><span class="p">)</span>
				<span class="n">chroma</span> <span class="o">=</span> <span class="p">((</span><span class="n">line</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">chroma</span> <span class="o">=</span> <span class="p">((</span><span class="n">line</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">topfield</span><span class="p">)</span>
				<span class="n">chroma</span> <span class="o">=</span> <span class="p">((</span><span class="n">line</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">chroma</span> <span class="o">=</span> <span class="p">((</span><span class="n">line</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">chroma</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">todo</span> <span class="o">=</span> <span class="n">ybpl</span><span class="p">;</span> <span class="n">todo</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">todo</span> <span class="o">-=</span> <span class="n">ylen</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* go to next sg entry if needed */</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">yoffset</span> <span class="o">&amp;&amp;</span> <span class="n">yoffset</span> <span class="o">&gt;=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">ysg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">yoffset</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">ysg</span><span class="p">);</span>
				<span class="n">ysg</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">uoffset</span> <span class="o">&amp;&amp;</span> <span class="n">uoffset</span> <span class="o">&gt;=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">usg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">uoffset</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">usg</span><span class="p">);</span>
				<span class="n">usg</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">voffset</span> <span class="o">&amp;&amp;</span> <span class="n">voffset</span> <span class="o">&gt;=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">vsg</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">voffset</span> <span class="o">-=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">vsg</span><span class="p">);</span>
				<span class="n">vsg</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* calculate max number of bytes we can write */</span>
			<span class="n">ylen</span> <span class="o">=</span> <span class="n">todo</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">ylen</span> <span class="o">&gt;</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">ysg</span><span class="p">))</span>
				<span class="n">ylen</span> <span class="o">=</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">ysg</span><span class="p">)</span> <span class="o">-</span> <span class="n">yoffset</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chroma</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">uoffset</span> <span class="o">+</span> <span class="p">(</span><span class="n">ylen</span><span class="o">&gt;&gt;</span><span class="n">hshift</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">usg</span><span class="p">))</span>
					<span class="n">ylen</span> <span class="o">=</span> <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">usg</span><span class="p">)</span> <span class="o">-</span> <span class="n">uoffset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">hshift</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">voffset</span> <span class="o">+</span> <span class="p">(</span><span class="n">ylen</span><span class="o">&gt;&gt;</span><span class="n">hshift</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">sg_dma_len</span><span class="p">(</span><span class="n">vsg</span><span class="p">))</span>
					<span class="n">ylen</span> <span class="o">=</span> <span class="p">(</span><span class="n">sg_dma_len</span><span class="p">(</span><span class="n">vsg</span><span class="p">)</span> <span class="o">-</span> <span class="n">voffset</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">hshift</span><span class="p">;</span>
				<span class="n">ri</span> <span class="o">=</span> <span class="n">BT848_RISC_WRITE123</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ri</span> <span class="o">=</span> <span class="n">BT848_RISC_WRITE1S23</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ybpl</span> <span class="o">==</span> <span class="n">todo</span><span class="p">)</span>
				<span class="n">ri</span> <span class="o">|=</span> <span class="n">BT848_RISC_SOL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ylen</span> <span class="o">==</span> <span class="n">todo</span><span class="p">)</span>
				<span class="n">ri</span> <span class="o">|=</span> <span class="n">BT848_RISC_EOL</span><span class="p">;</span>

			<span class="cm">/* write risc instruction */</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ri</span> <span class="o">|</span> <span class="n">ylen</span><span class="p">);</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(((</span><span class="n">ylen</span> <span class="o">&gt;&gt;</span> <span class="n">hshift</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
					    <span class="p">(</span><span class="n">ylen</span> <span class="o">&gt;&gt;</span> <span class="n">hshift</span><span class="p">));</span>
			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">ysg</span><span class="p">)</span><span class="o">+</span><span class="n">yoffset</span><span class="p">);</span>
			<span class="n">yoffset</span> <span class="o">+=</span> <span class="n">ylen</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">chroma</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">usg</span><span class="p">)</span><span class="o">+</span><span class="n">uoffset</span><span class="p">);</span>
				<span class="n">uoffset</span> <span class="o">+=</span> <span class="n">ylen</span> <span class="o">&gt;&gt;</span> <span class="n">hshift</span><span class="p">;</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">vsg</span><span class="p">)</span><span class="o">+</span><span class="n">voffset</span><span class="p">);</span>
				<span class="n">voffset</span> <span class="o">+=</span> <span class="n">ylen</span> <span class="o">&gt;&gt;</span> <span class="n">hshift</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">yoffset</span> <span class="o">+=</span> <span class="n">ypadding</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chroma</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uoffset</span> <span class="o">+=</span> <span class="n">cpadding</span><span class="p">;</span>
			<span class="n">voffset</span> <span class="o">+=</span> <span class="n">cpadding</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* save pointer to jmp instruction address */</span>
	<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">-</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bttv_risc_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_overlay</span> <span class="o">*</span><span class="n">ov</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">skip_even</span><span class="p">,</span> <span class="kt">int</span> <span class="n">skip_odd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dwords</span><span class="p">,</span> <span class="n">rc</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">skip</span><span class="p">,</span> <span class="n">nskips</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btcx_skiplist</span> <span class="o">*</span><span class="n">skips</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">rp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ri</span><span class="p">,</span><span class="n">ra</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* skip list for window clipping */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="p">(</span><span class="n">skips</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">skips</span><span class="p">)</span> <span class="o">*</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">nclips</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* estimate risc mem: worst case is (1.5*clip+1) * lines instructions</span>
<span class="cm">	   + sync + jump (all 2 dwords) */</span>
	<span class="n">dwords</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">nclips</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">((</span><span class="n">skip_even</span> <span class="o">||</span> <span class="n">skip_odd</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">&gt;&gt;</span><span class="mi">1</span> <span class="o">:</span>  <span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
	<span class="n">dwords</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="n">risc</span><span class="p">,</span><span class="n">dwords</span><span class="o">*</span><span class="mi">4</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">skips</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* sync instruction */</span>
	<span class="n">rp</span> <span class="o">=</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_SYNC</span><span class="o">|</span><span class="n">BT848_FIFO_STATUS_FM1</span><span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">addr</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
	<span class="n">addr</span> <span class="o">+=</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span>          <span class="o">*</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>

	<span class="cm">/* scan lines */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">maxy</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	     <span class="n">line</span><span class="o">++</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_vcr_hack</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">line</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">VCR_HACK_LINES</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">line</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>  <span class="o">&amp;&amp;</span>  <span class="n">skip_even</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">line</span><span class="o">%</span><span class="mi">2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>  <span class="o">&amp;&amp;</span>  <span class="n">skip_odd</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* calculate clipping */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&gt;</span> <span class="n">maxy</span><span class="p">)</span>
			<span class="n">btcx_calc_skips</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">maxy</span><span class="p">,</span>
					<span class="n">skips</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nskips</span><span class="p">,</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">clips</span><span class="p">,</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">nclips</span><span class="p">);</span>

		<span class="cm">/* write out risc code */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">;</span> <span class="n">start</span> <span class="o">=</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skip</span> <span class="o">&gt;=</span> <span class="n">nskips</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ri</span>  <span class="o">=</span> <span class="n">BT848_RISC_WRITE</span><span class="p">;</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">start</span> <span class="o">&lt;</span> <span class="n">skips</span><span class="p">[</span><span class="n">skip</span><span class="p">].</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ri</span>  <span class="o">=</span> <span class="n">BT848_RISC_WRITE</span><span class="p">;</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">skips</span><span class="p">[</span><span class="n">skip</span><span class="p">].</span><span class="n">start</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ri</span>  <span class="o">=</span> <span class="n">BT848_RISC_SKIP</span><span class="p">;</span>
				<span class="n">end</span> <span class="o">=</span> <span class="n">skips</span><span class="p">[</span><span class="n">skip</span><span class="p">].</span><span class="n">end</span><span class="p">;</span>
				<span class="n">skip</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">BT848_RISC_WRITE</span> <span class="o">==</span> <span class="n">ri</span><span class="p">)</span>
				<span class="n">ra</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span><span class="o">*</span><span class="n">start</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">start</span><span class="p">)</span>
				<span class="n">ri</span> <span class="o">|=</span> <span class="n">BT848_RISC_SOL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">end</span><span class="p">)</span>
				<span class="n">ri</span> <span class="o">|=</span> <span class="n">BT848_RISC_EOL</span><span class="p">;</span>
			<span class="n">ri</span> <span class="o">|=</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">&gt;&gt;</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">);</span>

			<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ri</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">ra</span><span class="p">)</span>
				<span class="o">*</span><span class="p">(</span><span class="n">rp</span><span class="o">++</span><span class="p">)</span><span class="o">=</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">ra</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* save pointer to jmp instruction address */</span>
	<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span> <span class="o">-</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">skips</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_calc_geo_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">,</span>
		  <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interleaved</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_tvnorm</span> <span class="o">*</span><span class="n">tvnorm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">xsf</span><span class="p">,</span> <span class="n">sr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vdelay</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">swidth</span>       <span class="o">=</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">swidth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">totalwidth</span>   <span class="o">=</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">totalwidth</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scaledtwidth</span> <span class="o">=</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">scaledtwidth</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">swidth</span>       <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">totalwidth</span>   <span class="o">=</span> <span class="mi">858</span><span class="p">;</span>
		<span class="n">scaledtwidth</span> <span class="o">=</span> <span class="mi">858</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdelay</span> <span class="o">=</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">vdelay</span><span class="p">;</span>

	<span class="n">xsf</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span><span class="o">*</span><span class="n">scaledtwidth</span><span class="p">)</span><span class="o">/</span><span class="n">swidth</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">hscale</span> <span class="o">=</span>  <span class="p">((</span><span class="n">totalwidth</span><span class="o">*</span><span class="mi">4096UL</span><span class="p">)</span><span class="o">/</span><span class="n">xsf</span><span class="o">-</span><span class="mi">4096</span><span class="p">);</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">hdelay</span> <span class="o">=</span>  <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">hdelayx1</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">hdelay</span> <span class="o">=</span>  <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">hdelay</span><span class="o">*</span><span class="n">width</span><span class="p">)</span><span class="o">/</span><span class="n">swidth</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">hdelay</span> <span class="o">&amp;=</span> <span class="mh">0x3fe</span><span class="p">;</span>
	<span class="n">sr</span> <span class="o">=</span> <span class="p">((</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">sheight</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">interleaved</span><span class="o">?</span><span class="mi">0</span><span class="o">:</span><span class="mi">1</span><span class="p">))</span><span class="o">*</span><span class="mi">512</span><span class="p">)</span><span class="o">/</span><span class="n">height</span> <span class="o">-</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vscale</span> <span class="o">=</span>  <span class="p">(</span><span class="mh">0x10000UL</span><span class="o">-</span><span class="n">sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">crop</span>   <span class="o">=</span>  <span class="p">((</span><span class="n">width</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x03</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">hdelay</span><span class="o">&gt;&gt;</span><span class="mi">6</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x0c</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">sheight</span><span class="o">&gt;&gt;</span><span class="mi">4</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">vdelay</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">)</span><span class="o">&amp;</span><span class="mh">0xc0</span><span class="p">);</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vscale</span> <span class="o">|=</span> <span class="n">interleaved</span> <span class="o">?</span> <span class="p">(</span><span class="n">BT848_VSCALE_INT</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vdelay</span>  <span class="o">=</span>  <span class="n">vdelay</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">width</span>   <span class="o">=</span>  <span class="n">width</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sheight</span> <span class="o">=</span>  <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">sheight</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vtotal</span>  <span class="o">=</span>  <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_combfilter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vtc</span>  <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">193</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="p">((</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">385</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">comb</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">769</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vtc</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">comb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_calc_geo</span>		<span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span>                  <span class="n">btv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bttv_geometry</span> <span class="o">*</span>         <span class="n">geo</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span>                   <span class="n">width</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span>                   <span class="n">height</span><span class="p">,</span>
			 <span class="kt">int</span>                            <span class="n">both_fields</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_tvnorm</span> <span class="o">*</span>     <span class="n">tvnorm</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span>       <span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">c_height</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">==</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">.</span><span class="n">left</span>
	     <span class="o">&amp;&amp;</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">==</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">.</span><span class="n">top</span>
	     <span class="o">&amp;&amp;</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">==</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span>
	     <span class="o">&amp;&amp;</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">==</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span>
	     <span class="o">&amp;&amp;</span> <span class="n">width</span> <span class="o">&lt;=</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">swidth</span> <span class="cm">/* see PAL-Nc et al */</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bttv_calc_geo_old</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">geo</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
				  <span class="n">both_fields</span><span class="p">,</span> <span class="n">tvnorm</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* For bug compatibility the image size checks permit scale</span>
<span class="cm">	   factors &gt; 16. See bttv_crop_calc_limits(). */</span>
	<span class="n">c_width</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">c_height</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">height</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">hscale</span> <span class="o">=</span> <span class="p">(</span><span class="n">c_width</span> <span class="o">*</span> <span class="mi">4096U</span> <span class="o">+</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">width</span> <span class="o">-</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="cm">/* Even to store Cb first, odd for Cr. */</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">hdelay</span> <span class="o">=</span> <span class="p">((</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">*</span> <span class="n">width</span> <span class="o">+</span> <span class="n">c_width</span><span class="p">)</span> <span class="o">/</span> <span class="n">c_width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">sheight</span> <span class="o">=</span> <span class="n">c_height</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vdelay</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">-</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">MIN_VDELAY</span><span class="p">;</span>
	<span class="n">sr</span> <span class="o">=</span> <span class="n">c_height</span> <span class="o">&gt;&gt;</span> <span class="o">!</span><span class="n">both_fields</span><span class="p">;</span>
	<span class="n">sr</span> <span class="o">=</span> <span class="p">(</span><span class="n">sr</span> <span class="o">*</span> <span class="mi">512U</span> <span class="o">+</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">height</span> <span class="o">-</span> <span class="mi">512</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vscale</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x10000UL</span> <span class="o">-</span> <span class="n">sr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1fff</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vscale</span> <span class="o">|=</span> <span class="n">both_fields</span> <span class="o">?</span> <span class="p">(</span><span class="n">BT848_VSCALE_INT</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">=</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="p">;</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">crop</span> <span class="o">=</span> <span class="p">(((</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">width</span>   <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">((</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">hdelay</span>  <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">((</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">sheight</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span> <span class="o">|</span>
		     <span class="p">((</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">vdelay</span>  <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_combfilter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vtc</span>  <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">193</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="p">((</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">385</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">comb</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">769</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">vtc</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">comb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_apply_geo</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">odd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">off</span> <span class="o">=</span> <span class="n">odd</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">comb</span><span class="p">)</span>
		<span class="n">btor</span><span class="p">(</span><span class="n">BT848_VSCALE_COMB</span><span class="p">,</span> <span class="n">BT848_E_VSCALE_HI</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="n">BT848_VSCALE_COMB</span><span class="p">,</span> <span class="n">BT848_E_VSCALE_HI</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>

	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">vtc</span><span class="p">,</span>             <span class="n">BT848_E_VTC</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">hscale</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span>     <span class="n">BT848_E_HSCALE_HI</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">hscale</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>   <span class="n">BT848_E_HSCALE_LO</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btaor</span><span class="p">((</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">vscale</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">),</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="n">BT848_E_VSCALE_HI</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">vscale</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>   <span class="n">BT848_E_VSCALE_LO</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>    <span class="n">BT848_E_HACTIVE_LO</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">hdelay</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>   <span class="n">BT848_E_HDELAY_LO</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">sheight</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>  <span class="n">BT848_E_VACTIVE_LO</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">vdelay</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>   <span class="n">BT848_E_VDELAY_LO</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">,</span>            <span class="n">BT848_E_CROP</span><span class="o">+</span><span class="n">off</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">vtotal</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">,</span>       <span class="n">BT848_VTOTAL_HI</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">vtotal</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>   <span class="n">BT848_VTOTAL_LO</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------- */</span>
<span class="cm">/* risc group / risc main loop / dma management               */</span>

<span class="kt">void</span>
<span class="nf">bttv_set_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">override</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">capctl</span><span class="p">;</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">cap_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top</span><span class="p">)</span>      <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cap_ctl</span> <span class="o">|=</span> <span class="mh">0x02</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">bottom</span><span class="p">)</span>   <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cap_ctl</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="p">)</span>          <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cap_ctl</span> <span class="o">|=</span> <span class="mh">0x0c</span><span class="p">;</span>

	<span class="n">capctl</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">capctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">cap_ctl</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x03</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>  <span class="cm">/* capture  */</span>
	<span class="n">capctl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">cap_ctl</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0c</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>  <span class="cm">/* vbi data */</span>
	<span class="n">capctl</span> <span class="o">|=</span> <span class="n">override</span><span class="p">;</span>

	<span class="n">d2printk</span><span class="p">(</span><span class="s">&quot;%d: capctl=%x lirq=%d top=%08llx/%08llx even=%08llx/%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span><span class="n">capctl</span><span class="p">,</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span><span class="p">,</span>
		 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span>         <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">.</span><span class="n">dma</span>            <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top</span>     <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">.</span><span class="n">dma</span>        <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span>         <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">dma</span>         <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">bottom</span>  <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">dma</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">BT848_RISC_JUMP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="n">BT848_RISC_IRQ</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span>  <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="o">~</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">frame_irq</span> <span class="o">||</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span> <span class="o">||</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">BTTV_TIMEOUT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="n">RISC_SLOT_LOOP</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>

	<span class="n">btaor</span><span class="p">(</span><span class="n">capctl</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x0f</span><span class="p">,</span> <span class="n">BT848_CAP_CTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">capctl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">dma_on</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">BT848_RISC_STRT_ADD</span><span class="p">);</span>
		<span class="n">btor</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">BT848_GPIO_DMA_CTL</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">dma_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">dma_on</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">BT848_GPIO_DMA_CTL</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">dma_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">bttv_risc_init_main</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">btcx_riscmem_alloc</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">,</span><span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: risc main @ %08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_SYNC</span> <span class="o">|</span> <span class="n">BT848_RISC_RESYNC</span> <span class="o">|</span>
				       <span class="n">BT848_FIFO_STATUS_VRE</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_JUMP</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* top field */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_JUMP</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="p">(</span><span class="mi">6</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_JUMP</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_SYNC</span> <span class="o">|</span> <span class="n">BT848_RISC_RESYNC</span> <span class="o">|</span>
				       <span class="n">BT848_FIFO_STATUS_VRO</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* bottom field */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_JUMP</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_JUMP</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="p">(</span><span class="mi">14</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

	<span class="cm">/* jump back to top field */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">BT848_RISC_JUMP</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="p">(</span><span class="mi">0</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">bttv_risc_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span>
	       <span class="kt">int</span> <span class="n">irqflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">next</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span> <span class="o">+</span> <span class="p">((</span><span class="n">slot</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">risc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d2printk</span><span class="p">(</span><span class="s">&quot;%d: risc=%p slot[%d]=NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="n">slot</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="n">slot</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">d2printk</span><span class="p">(</span><span class="s">&quot;%d: risc=%p slot[%d]=%08llx irq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span> <span class="n">slot</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">irqflags</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">BT848_RISC_JUMP</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irqflags</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">BT848_RISC_IRQ</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="n">irqflags</span>  <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="p">(</span><span class="o">~</span><span class="n">irqflags</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">risc</span><span class="o">-&gt;</span><span class="n">jmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">next</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="n">slot</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">bttv_dma_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">videobuf_dmabuf</span> <span class="o">*</span><span class="n">dma</span><span class="o">=</span><span class="n">videobuf_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>
	<span class="n">videobuf_waiton</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">videobuf_dma_unmap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">videobuf_dma_free</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">btcx_riscmem_free</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">);</span>
	<span class="n">btcx_riscmem_free</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">bttv_buffer_activate_vbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">vbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">bottom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">top_irq_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bottom_irq_flags</span><span class="p">;</span>

	<span class="n">top</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bottom</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">top_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bottom_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vbi</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crop</span><span class="p">,</span> <span class="n">vdelay</span><span class="p">;</span>

		<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vbi</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>

		<span class="cm">/* VDELAY is start of video, end of VBI capturing. */</span>
		<span class="n">crop</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_E_CROP</span><span class="p">);</span>
		<span class="n">vdelay</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_E_VDELAY_LO</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">crop</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vbi</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">vdelay</span> <span class="o">&gt;</span> <span class="n">vdelay</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vdelay</span> <span class="o">=</span> <span class="n">vbi</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">vdelay</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">;</span>
			<span class="n">crop</span> <span class="o">=</span> <span class="p">(</span><span class="n">crop</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">vbi</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">.</span><span class="n">vdelay</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">);</span>

			<span class="n">btwrite</span><span class="p">(</span><span class="n">vdelay</span><span class="p">,</span> <span class="n">BT848_E_VDELAY_LO</span><span class="p">);</span>
			<span class="n">btwrite</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span>	<span class="n">BT848_E_CROP</span><span class="p">);</span>
			<span class="n">btwrite</span><span class="p">(</span><span class="n">vdelay</span><span class="p">,</span> <span class="n">BT848_O_VDELAY_LO</span><span class="p">);</span>
			<span class="n">btwrite</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span>	<span class="n">BT848_O_CROP</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vbi</span><span class="o">-&gt;</span><span class="n">vbi_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">top</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vbi</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
			<span class="n">top_irq_flags</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vbi</span><span class="o">-&gt;</span><span class="n">vbi_count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">top_irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">bottom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vbi</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">;</span>
			<span class="n">bottom_irq_flags</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_O_VBI</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">top_irq_flags</span><span class="p">);</span>
	<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_E_VBI</span><span class="p">,</span> <span class="n">bottom</span><span class="p">,</span> <span class="n">bottom_irq_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">bttv_buffer_activate_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">bttv_buffer_set</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* video capture */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span>  <span class="o">&amp;&amp;</span>  <span class="nb">NULL</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">==</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span>    <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">)</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span>    <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
			<span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">)</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">)</span>
				<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bttv_apply_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bttv_apply_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_O_FIELD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>
			       <span class="n">set</span><span class="o">-&gt;</span><span class="n">top_irq</span><span class="p">);</span>
		<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_E_FIELD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span>
			       <span class="n">set</span><span class="o">-&gt;</span><span class="n">frame_irq</span><span class="p">);</span>
		<span class="n">btaor</span><span class="p">((</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">btformat</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">btformat</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">),</span>
		      <span class="o">~</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">BT848_COLOR_FMT</span><span class="p">);</span>
		<span class="n">btaor</span><span class="p">((</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">btswap</span> <span class="o">&amp;</span> <span class="mh">0x0a</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">btswap</span> <span class="o">&amp;</span> <span class="mh">0x05</span><span class="p">),</span>
		      <span class="o">~</span><span class="mh">0x0f</span><span class="p">,</span> <span class="n">BT848_COLOR_CTL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span>  <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">)</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">bttv_apply_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">bttv_apply_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_O_FIELD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>
			       <span class="n">set</span><span class="o">-&gt;</span><span class="n">frame_irq</span><span class="p">);</span>
		<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_E_FIELD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>           <span class="mi">0</span><span class="p">);</span>
		<span class="n">btaor</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">btformat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">BT848_COLOR_FMT</span><span class="p">);</span>
		<span class="n">btaor</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">btswap</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>   <span class="o">~</span><span class="mh">0x0f</span><span class="p">,</span> <span class="n">BT848_COLOR_CTL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">)</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">bttv_apply_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">bttv_apply_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_O_FIELD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_E_FIELD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span>
			       <span class="n">set</span><span class="o">-&gt;</span><span class="n">frame_irq</span><span class="p">);</span>
		<span class="n">btaor</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">btformat</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">~</span><span class="mh">0xff</span><span class="p">,</span> <span class="n">BT848_COLOR_FMT</span><span class="p">);</span>
		<span class="n">btaor</span><span class="p">(</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">btswap</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">,</span>   <span class="o">~</span><span class="mh">0x0f</span><span class="p">,</span> <span class="n">BT848_COLOR_CTL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_O_FIELD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_E_FIELD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------- */</span>

<span class="cm">/* calculate geometry, build risc code */</span>
<span class="kt">int</span>
<span class="nf">bttv_buffer_risc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_tvnorm</span> <span class="o">*</span><span class="n">tvnorm</span> <span class="o">=</span> <span class="n">bttv_tvnorms</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_dmabuf</span> <span class="o">*</span><span class="n">dma</span><span class="o">=</span><span class="n">videobuf_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: buffer field: %s  format: %s  size: %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">v4l2_field_names</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">],</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* packed pixel modes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">bpf</span> <span class="o">=</span> <span class="n">bpl</span> <span class="o">*</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">bttv_calc_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			      <span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">),</span>
			      <span class="n">tvnorm</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
			<span class="n">bttv_risc_packed</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="cm">/* offset */</span> <span class="mi">0</span><span class="p">,</span><span class="n">bpl</span><span class="p">,</span>
					 <span class="cm">/* padding */</span> <span class="mi">0</span><span class="p">,</span><span class="cm">/* skip_lines */</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
			<span class="n">bttv_risc_packed</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span><span class="n">bpl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
			<span class="n">bttv_risc_packed</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span><span class="n">bpl</span><span class="p">,</span><span class="n">bpl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bttv_risc_packed</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="n">bpl</span><span class="p">,</span><span class="n">bpl</span><span class="p">,</span><span class="n">bpl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_SEQ_TB</span>:
			<span class="n">bttv_risc_packed</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span><span class="n">bpl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">bttv_risc_packed</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span><span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="n">bpf</span><span class="p">,</span><span class="n">bpl</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* planar modes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FORMAT_FLAGS_PLANAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">uoffset</span><span class="p">,</span> <span class="n">voffset</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ypadding</span><span class="p">,</span> <span class="n">cpadding</span><span class="p">,</span> <span class="n">lines</span><span class="p">;</span>

		<span class="cm">/* calculate chroma offsets */</span>
		<span class="n">uoffset</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">voffset</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FORMAT_FLAGS_CrCb</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Y-Cr-Cb plane order */</span>
			<span class="n">uoffset</span> <span class="o">&gt;&gt;=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">;</span>
			<span class="n">uoffset</span> <span class="o">&gt;&gt;=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">vshift</span><span class="p">;</span>
			<span class="n">uoffset</span>  <span class="o">+=</span> <span class="n">voffset</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Y-Cb-Cr plane order */</span>
			<span class="n">voffset</span> <span class="o">&gt;&gt;=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">;</span>
			<span class="n">voffset</span> <span class="o">&gt;&gt;=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">vshift</span><span class="p">;</span>
			<span class="n">voffset</span>  <span class="o">+=</span> <span class="n">uoffset</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
			<span class="n">bttv_calc_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
				      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span><span class="cm">/* both_fields */</span> <span class="mi">0</span><span class="p">,</span>
				      <span class="n">tvnorm</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">);</span>
			<span class="n">bttv_risc_planar</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
					 <span class="n">uoffset</span><span class="p">,</span><span class="n">voffset</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">vshift</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
			<span class="n">bttv_calc_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
				      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				      <span class="n">tvnorm</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">);</span>
			<span class="n">bttv_risc_planar</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
					 <span class="n">uoffset</span><span class="p">,</span><span class="n">voffset</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">vshift</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
			<span class="n">bttv_calc_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
				      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
				      <span class="n">tvnorm</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">);</span>
			<span class="n">lines</span>    <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ypadding</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
			<span class="n">cpadding</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">;</span>
			<span class="n">bttv_risc_planar</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>
					 <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="n">ypadding</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span>
					 <span class="n">uoffset</span><span class="p">,</span><span class="n">voffset</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">vshift</span><span class="p">,</span>
					 <span class="n">cpadding</span><span class="p">);</span>
			<span class="n">bttv_risc_planar</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span>
					 <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="n">ypadding</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="n">ypadding</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span>
					 <span class="n">uoffset</span><span class="o">+</span><span class="n">cpadding</span><span class="p">,</span>
					 <span class="n">voffset</span><span class="o">+</span><span class="n">cpadding</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">vshift</span><span class="p">,</span>
					 <span class="n">cpadding</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_SEQ_TB</span>:
			<span class="n">bttv_calc_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
				      <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
				      <span class="n">tvnorm</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">);</span>
			<span class="n">lines</span>    <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ypadding</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
			<span class="n">cpadding</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">;</span>
			<span class="n">bttv_risc_planar</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>
					 <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span>
					 <span class="n">uoffset</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
					 <span class="n">voffset</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">vshift</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">);</span>
			<span class="n">bttv_risc_planar</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span>
					 <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					 <span class="n">lines</span> <span class="o">*</span> <span class="n">ypadding</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">lines</span><span class="p">,</span>
					 <span class="n">lines</span> <span class="o">*</span> <span class="n">ypadding</span> <span class="o">+</span> <span class="p">(</span><span class="n">uoffset</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
					 <span class="n">lines</span> <span class="o">*</span> <span class="n">ypadding</span> <span class="o">+</span> <span class="p">(</span><span class="n">voffset</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">vshift</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* raw data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FORMAT_FLAGS_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* build risc code */</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">;</span>
		<span class="n">bttv_calc_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">swidth</span><span class="p">,</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">sheight</span><span class="p">,</span>
			      <span class="mi">1</span><span class="p">,</span><span class="n">tvnorm</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">);</span>
		<span class="n">bttv_risc_packed</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>  <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
				 <span class="cm">/* offset */</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RAW_BPL</span><span class="p">,</span> <span class="cm">/* padding */</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="cm">/* skip_lines */</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RAW_LINES</span><span class="p">);</span>
		<span class="n">bttv_risc_packed</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
				 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span><span class="o">/</span><span class="mi">2</span> <span class="p">,</span> <span class="n">RAW_BPL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">RAW_LINES</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* copy format info */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">btformat</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">btswap</span>   <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">btswap</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------- */</span>

<span class="cm">/* calculate geometry, build risc code */</span>
<span class="kt">int</span>
<span class="nf">bttv_overlay_risc</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">bttv_overlay</span> <span class="o">*</span><span class="n">ov</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
		  <span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* check interleave, bottom+top fields */</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: overlay fields: %s format: %s  size: %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">v4l2_field_names</span><span class="p">[</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">],</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* calculate geometry */</span>
	<span class="n">bttv_calc_geo</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">geo</span><span class="p">,</span><span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="n">ov</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
		      <span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">ov</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">),</span>
		      <span class="o">&amp;</span><span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">ov</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">],</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">);</span>

	<span class="cm">/* build risc code */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ov</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
		<span class="n">bttv_risc_overlay</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>    <span class="n">fmt</span><span class="p">,</span> <span class="n">ov</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
		<span class="n">bttv_risc_overlay</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ov</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
		<span class="n">bttv_risc_overlay</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>    <span class="n">fmt</span><span class="p">,</span> <span class="n">ov</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">bttv_risc_overlay</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">ov</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="cm">/* copy format info */</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">btformat</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">btswap</span>   <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">btswap</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">ov</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
