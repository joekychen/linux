<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › bt8xx › bttv-driver.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>bttv-driver.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">    bttv - Bt848 frame grabber driver</span>

<span class="cm">    Copyright (C) 1996,97,98 Ralph  Metzler &lt;rjkm@thp.uni-koeln.de&gt;</span>
<span class="cm">			   &amp; Marcus Metzler &lt;mocm@thp.uni-koeln.de&gt;</span>
<span class="cm">    (c) 1999-2002 Gerd Knorr &lt;kraxel@bytesex.org&gt;</span>

<span class="cm">    some v4l2 code lines are taken from Justin&#39;s bttv2 driver which is</span>
<span class="cm">    (c) 2000 Justin Schoeman &lt;justin@suntiger.ee.up.ac.za&gt;</span>

<span class="cm">    V4L1 removal from:</span>
<span class="cm">    (c) 2005-2006 Nickolay V. Shmyrev &lt;nshmyrev@yandex.ru&gt;</span>

<span class="cm">    Fixes to be fully V4L2 compliant by</span>
<span class="cm">    (c) 2006 Mauro Carvalho Chehab &lt;mchehab@infradead.org&gt;</span>

<span class="cm">    Cropping and overscan support</span>
<span class="cm">    Copyright (C) 2005, 2006 Michael H. Schimek &lt;mschimek@gmx.at&gt;</span>
<span class="cm">    Sponsored by OPQ Systems AB</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm">*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kdev_t.h&gt;</span>
<span class="cp">#include &quot;bttvp.h&quot;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/tvaudio.h&gt;</span>
<span class="cp">#include &lt;media/msp3400.h&gt;</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>

<span class="cp">#include &lt;media/saa6588.h&gt;</span>

<span class="cp">#define BTTV_VERSION &quot;0.9.19&quot;</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bttv_num</span><span class="p">;</span>			<span class="cm">/* number of Bt848s in use */</span>
<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">bttvs</span><span class="p">[</span><span class="n">BTTV_MAX</span><span class="p">];</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bttv_debug</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bttv_verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bttv_gpio</span><span class="p">;</span>

<span class="cm">/* config variables */</span>
<span class="cp">#ifdef __BIG_ENDIAN</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bigendian</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bigendian</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">radio</span><span class="p">[</span><span class="n">BTTV_MAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gbuffers</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gbufsize</span> <span class="o">=</span> <span class="mh">0x208000</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reset_crop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">video_nr</span><span class="p">[</span><span class="n">BTTV_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">BTTV_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">radio_nr</span><span class="p">[</span><span class="n">BTTV_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">BTTV_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vbi_nr</span><span class="p">[</span><span class="n">BTTV_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">BTTV_MAX</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug_latency</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">disable_ir</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fdsr</span><span class="p">;</span>

<span class="cm">/* options */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">combfilter</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lumafilter</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">automute</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chroma_agc</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adc_crush</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">whitecrush_upper</span> <span class="o">=</span> <span class="mh">0xCF</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">whitecrush_lower</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vcr_hack</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_iswitch</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uv_ratio</span>    <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">full_luma_range</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">coring</span><span class="p">;</span>

<span class="cm">/* API features (turn on/off stuff for testing) */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v4l2</span>        <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="cm">/* insmod args */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bttv_verbose</span><span class="p">,</span>      <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bttv_gpio</span><span class="p">,</span>         <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bttv_debug</span><span class="p">,</span>        <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq_debug</span><span class="p">,</span>         <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug_latency</span><span class="p">,</span>     <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_ir</span><span class="p">,</span>        <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">fdsr</span><span class="p">,</span>              <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">gbuffers</span><span class="p">,</span>          <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">gbufsize</span><span class="p">,</span>          <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">reset_crop</span><span class="p">,</span>        <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">v4l2</span><span class="p">,</span>              <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">bigendian</span><span class="p">,</span>         <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq_iswitch</span><span class="p">,</span>       <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">combfilter</span><span class="p">,</span>        <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">lumafilter</span><span class="p">,</span>        <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">automute</span><span class="p">,</span>          <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">chroma_agc</span><span class="p">,</span>        <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">adc_crush</span><span class="p">,</span>         <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">whitecrush_upper</span><span class="p">,</span>  <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">whitecrush_lower</span><span class="p">,</span>  <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vcr_hack</span><span class="p">,</span>          <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">uv_ratio</span><span class="p">,</span>          <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">full_luma_range</span><span class="p">,</span>   <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">coring</span><span class="p">,</span>            <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span>       <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span>    <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span>    <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">vbi_nr</span><span class="p">,</span>      <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">radio</span><span class="p">,</span><span class="s">&quot;The TV card supports radio, default is 0 (no)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bigendian</span><span class="p">,</span><span class="s">&quot;byte order of the framebuffer, default is native endian&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bttv_verbose</span><span class="p">,</span><span class="s">&quot;verbose startup messages, default is 1 (yes)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bttv_gpio</span><span class="p">,</span><span class="s">&quot;log gpio changes, default is 0 (no)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bttv_debug</span><span class="p">,</span><span class="s">&quot;debug messages, default is 0 (no)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq_debug</span><span class="p">,</span><span class="s">&quot;irq handler debug messages, default is 0 (no)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_ir</span><span class="p">,</span> <span class="s">&quot;disable infrared remote support&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gbuffers</span><span class="p">,</span><span class="s">&quot;number of capture buffers. range 2-32, default 8&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gbufsize</span><span class="p">,</span><span class="s">&quot;size of the capture buffers, default is 0x208000&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">reset_crop</span><span class="p">,</span><span class="s">&quot;reset cropping parameters at open(), default &quot;</span>
		 <span class="s">&quot;is 1 (yes) for compatibility with older applications&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">automute</span><span class="p">,</span><span class="s">&quot;mute audio on bad/missing video signal, default is 1 (yes)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">chroma_agc</span><span class="p">,</span><span class="s">&quot;enables the AGC of chroma signal, default is 0 (no)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adc_crush</span><span class="p">,</span><span class="s">&quot;enables the luminance ADC crush, default is 1 (yes)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">whitecrush_upper</span><span class="p">,</span><span class="s">&quot;sets the white crush upper value, default is 207&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">whitecrush_lower</span><span class="p">,</span><span class="s">&quot;sets the white crush lower value, default is 127&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vcr_hack</span><span class="p">,</span><span class="s">&quot;enables the VCR hack (improves synch on poor VCR tapes), default is 0 (no)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq_iswitch</span><span class="p">,</span><span class="s">&quot;switch inputs in irq handler&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">uv_ratio</span><span class="p">,</span><span class="s">&quot;ratio between u and v gains, default is 50&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">full_luma_range</span><span class="p">,</span><span class="s">&quot;use the full luma range, default is 0 (no)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">coring</span><span class="p">,</span><span class="s">&quot;set the luma coring level, default is 0 (no)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="s">&quot;video device numbers&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vbi_nr</span><span class="p">,</span> <span class="s">&quot;vbi device numbers&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="s">&quot;radio device numbers&quot;</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;bttv - v4l/v4l2 driver module for bt848/878 based cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ralph Metzler &amp; Marcus Metzler &amp; Gerd Knorr&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">BTTV_VERSION</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* sysfs                                                                   */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vfd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span> <span class="o">?</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span> <span class="o">:</span> <span class="n">UNSET</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_card</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* dvb auto-load setup                                                     */</span>
<span class="cp">#if defined(CONFIG_MODULES) &amp;&amp; defined(MODULE)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">request_module_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;dvb-bt8xx&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">request_modules</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_module_wk</span><span class="p">,</span> <span class="n">request_module_async</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_module_wk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">flush_request_modules</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_module_wk</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define request_modules(dev)</span>
<span class="cp">#define flush_request_modules(dev)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MODULES */</span><span class="cp"></span>


<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* static data                                                             */</span>

<span class="cm">/* special timing tables from conexant... */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">SRAM_Table</span><span class="p">[][</span><span class="mi">60</span><span class="p">]</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="cm">/* PAL digital input over GPIO[7:0] */</span>
	<span class="p">{</span>
		<span class="mi">45</span><span class="p">,</span> <span class="c1">// 45 bytes following</span>
		<span class="mh">0x36</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x16</span><span class="p">,</span>
		<span class="mh">0x12</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x31</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x06</span><span class="p">,</span><span class="mh">0x51</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x89</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x44</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x81</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xA9</span><span class="p">,</span><span class="mh">0x0D</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span>
		<span class="mh">0x37</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xAF</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span><span class="mh">0x00</span>
	<span class="p">},</span>
	<span class="cm">/* NTSC digital input over GPIO[7:0] */</span>
	<span class="p">{</span>
		<span class="mi">51</span><span class="p">,</span> <span class="c1">// 51 bytes following</span>
		<span class="mh">0x0C</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x90</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x10</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span>
		<span class="mh">0x10</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0x12</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x13</span><span class="p">,</span><span class="mh">0x04</span><span class="p">,</span><span class="mh">0x19</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0x04</span><span class="p">,</span><span class="mh">0x39</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x06</span><span class="p">,</span><span class="mh">0x59</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x83</span><span class="p">,</span><span class="mh">0x08</span><span class="p">,</span><span class="mh">0x07</span><span class="p">,</span>
		<span class="mh">0x03</span><span class="p">,</span><span class="mh">0x50</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x86</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0xA6</span><span class="p">,</span>
		<span class="mh">0x0D</span><span class="p">,</span><span class="mh">0x02</span><span class="p">,</span><span class="mh">0x03</span><span class="p">,</span><span class="mh">0x11</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x05</span><span class="p">,</span><span class="mh">0x37</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0xAC</span><span class="p">,</span><span class="mh">0x21</span><span class="p">,</span>
		<span class="mh">0x00</span><span class="p">,</span>
	<span class="p">},</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>TGB_NTSC392 // quartzsight
This table has been modified to be used for Fusion Rev D</p></td><td class="code"><div class="highlight"><pre>	<span class="p">{</span>
		<span class="mh">0x2A</span><span class="p">,</span> <span class="c1">// size of table = 42</span>
		<span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span>
		<span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span>
		<span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="mh">0xbf</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x3d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x2f</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span>
		<span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* minhdelayx1	first video pixel we can capture on a line and</span>
<span class="cm">   hdelayx1	start of active video, both relative to rising edge of</span>
<span class="cm">		/HRESET pulse (0H) in 1 / fCLKx1.</span>
<span class="cm">   swidth	width of active video and</span>
<span class="cm">   totalwidth	total line width, both in 1 / fCLKx1.</span>
<span class="cm">   sqwidth	total line width in square pixels.</span>
<span class="cm">   vdelay	start of active video in 2 * field lines relative to</span>
<span class="cm">		trailing edge of /VRESET pulse (VDELAY register).</span>
<span class="cm">   sheight	height of active video in 2 * field lines.</span>
<span class="cm">   videostart0	ITU-R frame line number of the line corresponding</span>
<span class="cm">		to vdelay in the first field. */</span>
<span class="cp">#define CROPCAP(minhdelayx1, hdelayx1, swidth, totalwidth, sqwidth,	 \</span>
<span class="cp">		vdelay, sheight, videostart0)				 \</span>
<span class="cp">	.cropcap.bounds.left = minhdelayx1,				 \</span>
<span class="cp">	</span><span class="cm">/* * 2 because vertically we count field lines times two, */</span><span class="cp">	 \</span>
<span class="cp">	</span><span class="cm">/* e.g. 23 * 2 to 23 * 2 + 576 in PAL-BGHI defrect. */</span><span class="cp">		 \</span>
<span class="cp">	.cropcap.bounds.top = (videostart0) * 2 - (vdelay) + MIN_VDELAY, \</span>
<span class="cp">	</span><span class="cm">/* 4 is a safety margin at the end of the line. */</span><span class="cp">		 \</span>
<span class="cp">	.cropcap.bounds.width = (totalwidth) - (minhdelayx1) - 4,	 \</span>
<span class="cp">	.cropcap.bounds.height = (sheight) + (vdelay) - MIN_VDELAY,	 \</span>
<span class="cp">	.cropcap.defrect.left = hdelayx1,				 \</span>
<span class="cp">	.cropcap.defrect.top = (videostart0) * 2,			 \</span>
<span class="cp">	.cropcap.defrect.width = swidth,				 \</span>
<span class="cp">	.cropcap.defrect.height = sheight,				 \</span>
<span class="cp">	.cropcap.pixelaspect.numerator = totalwidth,			 \</span>
<span class="cp">	.cropcap.pixelaspect.denominator = sqwidth,</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_tvnorm</span> <span class="n">bttv_tvnorms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* PAL-BDGHI */</span>
	<span class="cm">/* max. active video is actually 922, but 924 is divisible by 4 and 3! */</span>
	<span class="cm">/* actually, max active PAL with HSCALE=0 is 948, NTSC is 768 - nil */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">v4l2_id</span>        <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;PAL&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">Fsc</span>            <span class="o">=</span> <span class="mi">35468950</span><span class="p">,</span>
		<span class="p">.</span><span class="n">swidth</span>         <span class="o">=</span> <span class="mi">924</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sheight</span>        <span class="o">=</span> <span class="mi">576</span><span class="p">,</span>
		<span class="p">.</span><span class="n">totalwidth</span>     <span class="o">=</span> <span class="mi">1135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adelay</span>         <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bdelay</span>         <span class="o">=</span> <span class="mh">0x72</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iform</span>          <span class="o">=</span> <span class="p">(</span><span class="n">BT848_IFORM_PAL_BDGHI</span><span class="o">|</span><span class="n">BT848_IFORM_XT1</span><span class="p">),</span>
		<span class="p">.</span><span class="n">scaledtwidth</span>   <span class="o">=</span> <span class="mi">1135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdelayx1</span>       <span class="o">=</span> <span class="mi">186</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hactivex1</span>      <span class="o">=</span> <span class="mi">924</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdelay</span>         <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbipack</span>        <span class="o">=</span> <span class="mi">255</span><span class="p">,</span> <span class="cm">/* min (2048 / 4, 0x1ff) &amp; 0xff */</span>
		<span class="p">.</span><span class="n">sram</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="cm">/* ITU-R frame line number of the first VBI line</span>
<span class="cm">		   we can capture, of the first and second field.</span>
<span class="cm">		   The last line is determined by cropcap.bounds. */</span>
		<span class="p">.</span><span class="n">vbistart</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">320</span> <span class="p">},</span>
		<span class="n">CROPCAP</span><span class="p">(</span><span class="cm">/* minhdelayx1 */</span> <span class="mi">68</span><span class="p">,</span>
			<span class="cm">/* hdelayx1 */</span> <span class="mi">186</span><span class="p">,</span>
			<span class="cm">/* Should be (768 * 1135 + 944 / 2) / 944.</span>
<span class="cm">			   cropcap.defrect is used for image width</span>
<span class="cm">			   checks, so we keep the old value 924. */</span>
			<span class="cm">/* swidth */</span> <span class="mi">924</span><span class="p">,</span>
			<span class="cm">/* totalwidth */</span> <span class="mi">1135</span><span class="p">,</span>
			<span class="cm">/* sqwidth */</span> <span class="mi">944</span><span class="p">,</span>
			<span class="cm">/* vdelay */</span> <span class="mh">0x20</span><span class="p">,</span>
			<span class="cm">/* sheight */</span> <span class="mi">576</span><span class="p">,</span>
			<span class="cm">/* videostart0 */</span> <span class="mi">23</span><span class="p">)</span>
		<span class="cm">/* bt878 (and bt848?) can capture another</span>
<span class="cm">		   line below active video. */</span>
		<span class="p">.</span><span class="n">cropcap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="mi">576</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0x20</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l2_id</span>        <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M</span> <span class="o">|</span> <span class="n">V4L2_STD_NTSC_M_KR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;NTSC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">Fsc</span>            <span class="o">=</span> <span class="mi">28636363</span><span class="p">,</span>
		<span class="p">.</span><span class="n">swidth</span>         <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sheight</span>        <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">totalwidth</span>     <span class="o">=</span> <span class="mi">910</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adelay</span>         <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bdelay</span>         <span class="o">=</span> <span class="mh">0x5d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iform</span>          <span class="o">=</span> <span class="p">(</span><span class="n">BT848_IFORM_NTSC</span><span class="o">|</span><span class="n">BT848_IFORM_XT0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">scaledtwidth</span>   <span class="o">=</span> <span class="mi">910</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdelayx1</span>       <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hactivex1</span>      <span class="o">=</span> <span class="mi">910</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdelay</span>         <span class="o">=</span> <span class="mh">0x1a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbipack</span>        <span class="o">=</span> <span class="mi">144</span><span class="p">,</span> <span class="cm">/* min (1600 / 4, 0x1ff) &amp; 0xff */</span>
		<span class="p">.</span><span class="n">sram</span>           <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbistart</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">273</span> <span class="p">},</span>
		<span class="n">CROPCAP</span><span class="p">(</span><span class="cm">/* minhdelayx1 */</span> <span class="mi">68</span><span class="p">,</span>
			<span class="cm">/* hdelayx1 */</span> <span class="mi">128</span><span class="p">,</span>
			<span class="cm">/* Should be (640 * 910 + 780 / 2) / 780? */</span>
			<span class="cm">/* swidth */</span> <span class="mi">768</span><span class="p">,</span>
			<span class="cm">/* totalwidth */</span> <span class="mi">910</span><span class="p">,</span>
			<span class="cm">/* sqwidth */</span> <span class="mi">780</span><span class="p">,</span>
			<span class="cm">/* vdelay */</span> <span class="mh">0x1a</span><span class="p">,</span>
			<span class="cm">/* sheight */</span> <span class="mi">480</span><span class="p">,</span>
			<span class="cm">/* videostart0 */</span> <span class="mi">23</span><span class="p">)</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l2_id</span>        <span class="o">=</span> <span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;SECAM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">Fsc</span>            <span class="o">=</span> <span class="mi">35468950</span><span class="p">,</span>
		<span class="p">.</span><span class="n">swidth</span>         <span class="o">=</span> <span class="mi">924</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sheight</span>        <span class="o">=</span> <span class="mi">576</span><span class="p">,</span>
		<span class="p">.</span><span class="n">totalwidth</span>     <span class="o">=</span> <span class="mi">1135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adelay</span>         <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bdelay</span>         <span class="o">=</span> <span class="mh">0xb0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iform</span>          <span class="o">=</span> <span class="p">(</span><span class="n">BT848_IFORM_SECAM</span><span class="o">|</span><span class="n">BT848_IFORM_XT1</span><span class="p">),</span>
		<span class="p">.</span><span class="n">scaledtwidth</span>   <span class="o">=</span> <span class="mi">1135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdelayx1</span>       <span class="o">=</span> <span class="mi">186</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hactivex1</span>      <span class="o">=</span> <span class="mi">922</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdelay</span>         <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbipack</span>        <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sram</span>           <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="cm">/* like PAL, correct? */</span>
		<span class="p">.</span><span class="n">vbistart</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">320</span> <span class="p">},</span>
		<span class="n">CROPCAP</span><span class="p">(</span><span class="cm">/* minhdelayx1 */</span> <span class="mi">68</span><span class="p">,</span>
			<span class="cm">/* hdelayx1 */</span> <span class="mi">186</span><span class="p">,</span>
			<span class="cm">/* swidth */</span> <span class="mi">924</span><span class="p">,</span>
			<span class="cm">/* totalwidth */</span> <span class="mi">1135</span><span class="p">,</span>
			<span class="cm">/* sqwidth */</span> <span class="mi">944</span><span class="p">,</span>
			<span class="cm">/* vdelay */</span> <span class="mh">0x20</span><span class="p">,</span>
			<span class="cm">/* sheight */</span> <span class="mi">576</span><span class="p">,</span>
			<span class="cm">/* videostart0 */</span> <span class="mi">23</span><span class="p">)</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l2_id</span>        <span class="o">=</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;PAL-Nc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">Fsc</span>            <span class="o">=</span> <span class="mi">28636363</span><span class="p">,</span>
		<span class="p">.</span><span class="n">swidth</span>         <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sheight</span>        <span class="o">=</span> <span class="mi">576</span><span class="p">,</span>
		<span class="p">.</span><span class="n">totalwidth</span>     <span class="o">=</span> <span class="mi">910</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adelay</span>         <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bdelay</span>         <span class="o">=</span> <span class="mh">0x5d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iform</span>          <span class="o">=</span> <span class="p">(</span><span class="n">BT848_IFORM_PAL_NC</span><span class="o">|</span><span class="n">BT848_IFORM_XT0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">scaledtwidth</span>   <span class="o">=</span> <span class="mi">780</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdelayx1</span>       <span class="o">=</span> <span class="mi">130</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hactivex1</span>      <span class="o">=</span> <span class="mi">734</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdelay</span>         <span class="o">=</span> <span class="mh">0x1a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbipack</span>        <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sram</span>           <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbistart</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">320</span> <span class="p">},</span>
		<span class="n">CROPCAP</span><span class="p">(</span><span class="cm">/* minhdelayx1 */</span> <span class="mi">68</span><span class="p">,</span>
			<span class="cm">/* hdelayx1 */</span> <span class="mi">130</span><span class="p">,</span>
			<span class="cm">/* swidth */</span> <span class="p">(</span><span class="mi">640</span> <span class="o">*</span> <span class="mi">910</span> <span class="o">+</span> <span class="mi">780</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">780</span><span class="p">,</span>
			<span class="cm">/* totalwidth */</span> <span class="mi">910</span><span class="p">,</span>
			<span class="cm">/* sqwidth */</span> <span class="mi">780</span><span class="p">,</span>
			<span class="cm">/* vdelay */</span> <span class="mh">0x1a</span><span class="p">,</span>
			<span class="cm">/* sheight */</span> <span class="mi">576</span><span class="p">,</span>
			<span class="cm">/* videostart0 */</span> <span class="mi">23</span><span class="p">)</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l2_id</span>        <span class="o">=</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;PAL-M&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">Fsc</span>            <span class="o">=</span> <span class="mi">28636363</span><span class="p">,</span>
		<span class="p">.</span><span class="n">swidth</span>         <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sheight</span>        <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">totalwidth</span>     <span class="o">=</span> <span class="mi">910</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adelay</span>         <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bdelay</span>         <span class="o">=</span> <span class="mh">0x5d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iform</span>          <span class="o">=</span> <span class="p">(</span><span class="n">BT848_IFORM_PAL_M</span><span class="o">|</span><span class="n">BT848_IFORM_XT0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">scaledtwidth</span>   <span class="o">=</span> <span class="mi">780</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdelayx1</span>       <span class="o">=</span> <span class="mi">135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hactivex1</span>      <span class="o">=</span> <span class="mi">754</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdelay</span>         <span class="o">=</span> <span class="mh">0x1a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbipack</span>        <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sram</span>           <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbistart</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">273</span> <span class="p">},</span>
		<span class="n">CROPCAP</span><span class="p">(</span><span class="cm">/* minhdelayx1 */</span> <span class="mi">68</span><span class="p">,</span>
			<span class="cm">/* hdelayx1 */</span> <span class="mi">135</span><span class="p">,</span>
			<span class="cm">/* swidth */</span> <span class="p">(</span><span class="mi">640</span> <span class="o">*</span> <span class="mi">910</span> <span class="o">+</span> <span class="mi">780</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">780</span><span class="p">,</span>
			<span class="cm">/* totalwidth */</span> <span class="mi">910</span><span class="p">,</span>
			<span class="cm">/* sqwidth */</span> <span class="mi">780</span><span class="p">,</span>
			<span class="cm">/* vdelay */</span> <span class="mh">0x1a</span><span class="p">,</span>
			<span class="cm">/* sheight */</span> <span class="mi">480</span><span class="p">,</span>
			<span class="cm">/* videostart0 */</span> <span class="mi">23</span><span class="p">)</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l2_id</span>        <span class="o">=</span> <span class="n">V4L2_STD_PAL_N</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;PAL-N&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">Fsc</span>            <span class="o">=</span> <span class="mi">35468950</span><span class="p">,</span>
		<span class="p">.</span><span class="n">swidth</span>         <span class="o">=</span> <span class="mi">768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sheight</span>        <span class="o">=</span> <span class="mi">576</span><span class="p">,</span>
		<span class="p">.</span><span class="n">totalwidth</span>     <span class="o">=</span> <span class="mi">1135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adelay</span>         <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bdelay</span>         <span class="o">=</span> <span class="mh">0x72</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iform</span>          <span class="o">=</span> <span class="p">(</span><span class="n">BT848_IFORM_PAL_N</span><span class="o">|</span><span class="n">BT848_IFORM_XT1</span><span class="p">),</span>
		<span class="p">.</span><span class="n">scaledtwidth</span>   <span class="o">=</span> <span class="mi">944</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdelayx1</span>       <span class="o">=</span> <span class="mi">186</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hactivex1</span>      <span class="o">=</span> <span class="mi">922</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdelay</span>         <span class="o">=</span> <span class="mh">0x20</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbipack</span>        <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sram</span>           <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbistart</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">320</span> <span class="p">},</span>
		<span class="n">CROPCAP</span><span class="p">(</span><span class="cm">/* minhdelayx1 */</span> <span class="mi">68</span><span class="p">,</span>
			<span class="cm">/* hdelayx1 */</span> <span class="mi">186</span><span class="p">,</span>
			<span class="cm">/* swidth */</span> <span class="p">(</span><span class="mi">768</span> <span class="o">*</span> <span class="mi">1135</span> <span class="o">+</span> <span class="mi">944</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">944</span><span class="p">,</span>
			<span class="cm">/* totalwidth */</span> <span class="mi">1135</span><span class="p">,</span>
			<span class="cm">/* sqwidth */</span> <span class="mi">944</span><span class="p">,</span>
			<span class="cm">/* vdelay */</span> <span class="mh">0x20</span><span class="p">,</span>
			<span class="cm">/* sheight */</span> <span class="mi">576</span><span class="p">,</span>
			<span class="cm">/* videostart0 */</span> <span class="mi">23</span><span class="p">)</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l2_id</span>        <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;NTSC-JP&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">Fsc</span>            <span class="o">=</span> <span class="mi">28636363</span><span class="p">,</span>
		<span class="p">.</span><span class="n">swidth</span>         <span class="o">=</span> <span class="mi">640</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sheight</span>        <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">totalwidth</span>     <span class="o">=</span> <span class="mi">910</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adelay</span>         <span class="o">=</span> <span class="mh">0x68</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bdelay</span>         <span class="o">=</span> <span class="mh">0x5d</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iform</span>          <span class="o">=</span> <span class="p">(</span><span class="n">BT848_IFORM_NTSC_J</span><span class="o">|</span><span class="n">BT848_IFORM_XT0</span><span class="p">),</span>
		<span class="p">.</span><span class="n">scaledtwidth</span>   <span class="o">=</span> <span class="mi">780</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdelayx1</span>       <span class="o">=</span> <span class="mi">135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hactivex1</span>      <span class="o">=</span> <span class="mi">754</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdelay</span>         <span class="o">=</span> <span class="mh">0x16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbipack</span>        <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sram</span>           <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbistart</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">273</span> <span class="p">},</span>
		<span class="n">CROPCAP</span><span class="p">(</span><span class="cm">/* minhdelayx1 */</span> <span class="mi">68</span><span class="p">,</span>
			<span class="cm">/* hdelayx1 */</span> <span class="mi">135</span><span class="p">,</span>
			<span class="cm">/* swidth */</span> <span class="p">(</span><span class="mi">640</span> <span class="o">*</span> <span class="mi">910</span> <span class="o">+</span> <span class="mi">780</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">780</span><span class="p">,</span>
			<span class="cm">/* totalwidth */</span> <span class="mi">910</span><span class="p">,</span>
			<span class="cm">/* sqwidth */</span> <span class="mi">780</span><span class="p">,</span>
			<span class="cm">/* vdelay */</span> <span class="mh">0x16</span><span class="p">,</span>
			<span class="cm">/* sheight */</span> <span class="mi">480</span><span class="p">,</span>
			<span class="cm">/* videostart0 */</span> <span class="mi">23</span><span class="p">)</span>
	<span class="p">},{</span>
		<span class="cm">/* that one hopefully works with the strange timing</span>
<span class="cm">		 * which video recorders produce when playing a NTSC</span>
<span class="cm">		 * tape on a PAL TV ... */</span>
		<span class="p">.</span><span class="n">v4l2_id</span>        <span class="o">=</span> <span class="n">V4L2_STD_PAL_60</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;PAL-60&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">Fsc</span>            <span class="o">=</span> <span class="mi">35468950</span><span class="p">,</span>
		<span class="p">.</span><span class="n">swidth</span>         <span class="o">=</span> <span class="mi">924</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sheight</span>        <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="p">.</span><span class="n">totalwidth</span>     <span class="o">=</span> <span class="mi">1135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">adelay</span>         <span class="o">=</span> <span class="mh">0x7f</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bdelay</span>         <span class="o">=</span> <span class="mh">0x72</span><span class="p">,</span>
		<span class="p">.</span><span class="n">iform</span>          <span class="o">=</span> <span class="p">(</span><span class="n">BT848_IFORM_PAL_BDGHI</span><span class="o">|</span><span class="n">BT848_IFORM_XT1</span><span class="p">),</span>
		<span class="p">.</span><span class="n">scaledtwidth</span>   <span class="o">=</span> <span class="mi">1135</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hdelayx1</span>       <span class="o">=</span> <span class="mi">186</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hactivex1</span>      <span class="o">=</span> <span class="mi">924</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vdelay</span>         <span class="o">=</span> <span class="mh">0x1a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbipack</span>        <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vtotal</span>         <span class="o">=</span> <span class="mi">524</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sram</span>           <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbistart</span>	<span class="o">=</span> <span class="p">{</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">273</span> <span class="p">},</span>
		<span class="n">CROPCAP</span><span class="p">(</span><span class="cm">/* minhdelayx1 */</span> <span class="mi">68</span><span class="p">,</span>
			<span class="cm">/* hdelayx1 */</span> <span class="mi">186</span><span class="p">,</span>
			<span class="cm">/* swidth */</span> <span class="mi">924</span><span class="p">,</span>
			<span class="cm">/* totalwidth */</span> <span class="mi">1135</span><span class="p">,</span>
			<span class="cm">/* sqwidth */</span> <span class="mi">944</span><span class="p">,</span>
			<span class="cm">/* vdelay */</span> <span class="mh">0x1a</span><span class="p">,</span>
			<span class="cm">/* sheight */</span> <span class="mi">480</span><span class="p">,</span>
			<span class="cm">/* videostart0 */</span> <span class="mi">23</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">BTTV_TVNORMS</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bttv_tvnorms</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* bttv format list</span>
<span class="cm">   packed pixel formats must come first */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_format</span> <span class="n">formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;8 bpp, gray&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_GREY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_Y8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;8 bpp, dithered color&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_HI240</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_RGB8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span> <span class="o">|</span> <span class="n">FORMAT_FLAGS_DITHER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;15 bpp RGB, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_RGB15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;15 bpp RGB, be&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB555X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_RGB15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btswap</span>   <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span> <span class="cm">/* byteswap */</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;16 bpp RGB, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_RGB16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;16 bpp RGB, be&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_RGB16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btswap</span>   <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span> <span class="cm">/* byteswap */</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;24 bpp RGB, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_BGR24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_RGB24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;32 bpp RGB, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_BGR32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_RGB32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;32 bpp RGB, be&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_RGB32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btswap</span>   <span class="o">=</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="cm">/* byte+word swap */</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:2, packed, YUYV&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_YUY2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:2, packed, YUYV&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_YUY2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:2, packed, UYVY&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_YUY2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btswap</span>   <span class="o">=</span> <span class="mh">0x03</span><span class="p">,</span> <span class="cm">/* byteswap */</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:2, planar, Y-Cb-Cr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV422P</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_YCrCb422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PLANAR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vshift</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:0, planar, Y-Cb-Cr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV420</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_YCrCb422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PLANAR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:0, planar, Y-Cr-Cb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YVU420</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_YCrCb422</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PLANAR</span> <span class="o">|</span> <span class="n">FORMAT_FLAGS_CrCb</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:1:1, planar, Y-Cb-Cr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV411P</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_YCrCb411</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PLANAR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hshift</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vshift</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:1:0, planar, Y-Cb-Cr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV410</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_YCrCb411</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PLANAR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hshift</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vshift</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:1:0, planar, Y-Cr-Cb&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YVU410</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_YCrCb411</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_PLANAR</span> <span class="o">|</span> <span class="n">FORMAT_FLAGS_CrCb</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hshift</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vshift</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;raw scanlines&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">btformat</span> <span class="o">=</span> <span class="n">BT848_COLOR_FMT_RAW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>    <span class="o">=</span> <span class="n">FORMAT_FLAGS_RAW</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">FORMATS</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">formats</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="cp">#define V4L2_CID_PRIVATE_CHROMA_AGC  (V4L2_CID_PRIVATE_BASE + 0)</span>
<span class="cp">#define V4L2_CID_PRIVATE_COMBFILTER  (V4L2_CID_PRIVATE_BASE + 1)</span>
<span class="cp">#define V4L2_CID_PRIVATE_AUTOMUTE    (V4L2_CID_PRIVATE_BASE + 2)</span>
<span class="cp">#define V4L2_CID_PRIVATE_LUMAFILTER  (V4L2_CID_PRIVATE_BASE + 3)</span>
<span class="cp">#define V4L2_CID_PRIVATE_AGC_CRUSH   (V4L2_CID_PRIVATE_BASE + 4)</span>
<span class="cp">#define V4L2_CID_PRIVATE_VCR_HACK    (V4L2_CID_PRIVATE_BASE + 5)</span>
<span class="cp">#define V4L2_CID_PRIVATE_WHITECRUSH_UPPER   (V4L2_CID_PRIVATE_BASE + 6)</span>
<span class="cp">#define V4L2_CID_PRIVATE_WHITECRUSH_LOWER   (V4L2_CID_PRIVATE_BASE + 7)</span>
<span class="cp">#define V4L2_CID_PRIVATE_UV_RATIO    (V4L2_CID_PRIVATE_BASE + 8)</span>
<span class="cp">#define V4L2_CID_PRIVATE_FULL_LUMA_RANGE    (V4L2_CID_PRIVATE_BASE + 9)</span>
<span class="cp">#define V4L2_CID_PRIVATE_CORING      (V4L2_CID_PRIVATE_BASE + 10)</span>
<span class="cp">#define V4L2_CID_PRIVATE_LASTP1      (V4L2_CID_PRIVATE_BASE + 11)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">no_ctl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;42&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_CTRL_FLAG_DISABLED</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">bttv_ctls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* --- video --- */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Brightness&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Contrast&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">27648</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_SATURATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Saturation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_HUE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Hue&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* --- audio --- */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Mute&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Volume&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">65535</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Balance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">65535</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_BASS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Bass&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">65535</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Treble&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">65535</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">65535</span><span class="o">/</span><span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">32768</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* --- private --- */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_CHROMA_AGC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;chroma agc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_COMBFILTER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;combfilter&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_AUTOMUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;automute&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_LUMAFILTER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;luma decimation filter&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_AGC_CRUSH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;agc crush&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_VCR_HACK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;vcr hack&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_WHITECRUSH_UPPER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;whitecrush upper&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mh">0xCF</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_WHITECRUSH_LOWER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;whitecrush lower&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mh">0x7F</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_UV_RATIO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;uv ratio&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">50</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_FULL_LUMA_RANGE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;full luma range&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_CORING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;coring&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">}</span>



<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="nf">ctrl_by_id</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bttv_ctls</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bttv_ctls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">bttv_ctls</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* resource management                                                     */</span>

<span class="cm">/*</span>
<span class="cm">   RESOURCE_    allocated by                freed by</span>

<span class="cm">   VIDEO_READ   bttv_read 1)                bttv_read 2)</span>

<span class="cm">   VIDEO_STREAM VIDIOC_STREAMON             VIDIOC_STREAMOFF</span>
<span class="cm">		 VIDIOC_QBUF 1)              bttv_release</span>
<span class="cm">		 VIDIOCMCAPTURE 1)</span>

<span class="cm">   OVERLAY	 VIDIOCCAPTURE on            VIDIOCCAPTURE off</span>
<span class="cm">		 VIDIOC_OVERLAY on           VIDIOC_OVERLAY off</span>
<span class="cm">		 3)                          bttv_release</span>

<span class="cm">   VBI		 VIDIOC_STREAMON             VIDIOC_STREAMOFF</span>
<span class="cm">		 VIDIOC_QBUF 1)              bttv_release</span>
<span class="cm">		 bttv_read, bttv_poll 1) 4)</span>

<span class="cm">   1) The resource must be allocated when we enter buffer prepare functions</span>
<span class="cm">      and remain allocated while buffers are in the DMA queue.</span>
<span class="cm">   2) This is a single frame read.</span>
<span class="cm">   3) VIDIOC_S_FBUF and VIDIOC_S_FMT (OVERLAY) still work when</span>
<span class="cm">      RESOURCE_OVERLAY is allocated.</span>
<span class="cm">   4) This is a continuous read, implies VIDIOC_STREAMON.</span>

<span class="cm">   Note this driver permits video input and standard changes regardless if</span>
<span class="cm">   resources are allocated.</span>
<span class="cm">*/</span>

<span class="cp">#define VBI_RESOURCES (RESOURCE_VBI)</span>
<span class="cp">#define VIDEO_RESOURCES (RESOURCE_VIDEO_READ | \</span>
<span class="cp">			 RESOURCE_VIDEO_STREAM | \</span>
<span class="cp">			 RESOURCE_OVERLAY)</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">check_alloc_btres_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">xbits</span><span class="p">;</span> <span class="cm">/* mutual exclusive resources */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
		<span class="cm">/* have it already allocated */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">xbits</span> <span class="o">=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RESOURCE_VIDEO_READ</span> <span class="o">|</span> <span class="n">RESOURCE_VIDEO_STREAM</span><span class="p">))</span>
		<span class="n">xbits</span> <span class="o">|=</span> <span class="n">RESOURCE_VIDEO_READ</span> <span class="o">|</span> <span class="n">RESOURCE_VIDEO_STREAM</span><span class="p">;</span>

	<span class="cm">/* is it free? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">xbits</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no, someone else uses it */</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">VIDEO_RESOURCES</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">VIDEO_RESOURCES</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Do crop - use current, don&#39;t - use default parameters. */</span>
		<span class="n">__s32</span> <span class="n">top</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="o">!!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span> <span class="o">&gt;</span> <span class="n">top</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="cm">/* We cannot capture the same line as video and VBI data.</span>
<span class="cm">		   Claim scan lines crop[].rect.top to bottom. */</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop_start</span> <span class="o">=</span> <span class="n">top</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">VBI_RESOURCES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__s32</span> <span class="n">end</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi_fmt</span><span class="p">.</span><span class="n">end</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">end</span> <span class="o">&gt;</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop_start</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="cm">/* Claim scan lines above fh-&gt;vbi_fmt.end. */</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span> <span class="o">=</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* it&#39;s free, grab it */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span>  <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">check_btres</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">locked_btres</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Call with btv-&gt;lock down. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">disclaim_vbi_lines</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Call with btv-&gt;lock down. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">disclaim_video_lines</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_tvnorm</span> <span class="o">*</span><span class="n">tvnorm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">crop</span><span class="p">;</span>

	<span class="n">tvnorm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">];</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop_start</span> <span class="o">=</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>
		<span class="o">+</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/* VBI capturing ends at VDELAY, start of video capturing, no</span>
<span class="cm">	   matter how many lines the VBI RISC program expects. When video</span>
<span class="cm">	   capturing is off, it shall no longer &quot;preempt&quot; VBI capturing,</span>
<span class="cm">	   so we set VDELAY to maximum. */</span>
	<span class="n">crop</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_E_CROP</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xc0</span><span class="p">;</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="n">BT848_E_CROP</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="n">BT848_E_VDELAY_LO</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">crop</span><span class="p">,</span> <span class="n">BT848_O_CROP</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0xfe</span><span class="p">,</span> <span class="n">BT848_O_VDELAY_LO</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="nf">free_btres_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bits</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* trying to free resources not allocated by us ... */</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;BUG! (btres)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>

	<span class="n">bits</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">resources</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">VIDEO_RESOURCES</span><span class="p">))</span>
		<span class="n">disclaim_video_lines</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">bits</span> <span class="o">&amp;</span> <span class="n">VBI_RESOURCES</span><span class="p">))</span>
		<span class="n">disclaim_vbi_lines</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* If Bt848a or Bt849, use PLL for PAL/SECAM and crystal for NTSC          */</span>

<span class="cm">/* Frequency = (F_input / PLL_X) * PLL_I.PLL_F/PLL_C</span>
<span class="cm">   PLL_X = Reference pre-divider (0=1, 1=2)</span>
<span class="cm">   PLL_C = Post divider (0=6, 1=4)</span>
<span class="cm">   PLL_I = Integer input</span>
<span class="cm">   PLL_F = Fractional input</span>

<span class="cm">   F_input = 28.636363 MHz:</span>
<span class="cm">   PAL (CLKx2 = 35.46895 MHz): PLL_X = 1, PLL_I = 0x0E, PLL_F = 0xDCF9, PLL_C = 0</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_pll_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fin</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">fl</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fi</span><span class="p">;</span>

	<span class="cm">/* prevent overflows */</span>
	<span class="n">fin</span><span class="o">/=</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">fout</span><span class="o">/=</span><span class="mi">4</span><span class="p">;</span>

	<span class="n">fout</span><span class="o">*=</span><span class="mi">12</span><span class="p">;</span>
	<span class="n">fi</span><span class="o">=</span><span class="n">fout</span><span class="o">/</span><span class="n">fin</span><span class="p">;</span>

	<span class="n">fout</span><span class="o">=</span><span class="p">(</span><span class="n">fout</span><span class="o">%</span><span class="n">fin</span><span class="p">)</span><span class="o">*</span><span class="mi">256</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">=</span><span class="n">fout</span><span class="o">/</span><span class="n">fin</span><span class="p">;</span>

	<span class="n">fout</span><span class="o">=</span><span class="p">(</span><span class="n">fout</span><span class="o">%</span><span class="n">fin</span><span class="p">)</span><span class="o">*</span><span class="mi">256</span><span class="p">;</span>
	<span class="n">fl</span><span class="o">=</span><span class="n">fout</span><span class="o">/</span><span class="n">fin</span><span class="p">;</span>

	<span class="n">btwrite</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">BT848_PLL_F_LO</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">BT848_PLL_F_HI</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">fi</span><span class="o">|</span><span class="n">BT848_PLL_X</span><span class="p">,</span> <span class="n">BT848_PLL_XCI</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_pll</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_crystal</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ofreq</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_current</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: PLL: no change required</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ifreq</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ofreq</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no PLL needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_current</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bttv_verbose</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: PLL can sleep, using XTAL (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ifreq</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="n">BT848_TGCTRL</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span><span class="n">BT848_PLL_XCI</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_verbose</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: Setting PLL: %d =&gt; %d (needs up to 100ms)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ifreq</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ofreq</span><span class="p">);</span>
	<span class="n">set_pll_freq</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ifreq</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ofreq</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*  Let other people run while the PLL stabilizes */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">btread</span><span class="p">(</span><span class="n">BT848_DSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BT848_DSTATUS_PLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">BT848_DSTATUS</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x08</span><span class="p">,</span><span class="n">BT848_TGCTRL</span><span class="p">);</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_current</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ofreq</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bttv_verbose</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;PLL set ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_current</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_verbose</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Setting PLL failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* used to switch between the bt848&#39;s analog/digital video capture modes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">bt848A_set_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">table_idx</span> <span class="o">=</span> <span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">].</span><span class="n">sram</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fsc</span>       <span class="o">=</span> <span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">].</span><span class="n">Fsc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">dig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: load digital timing table (table_idx=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span><span class="n">table_idx</span><span class="p">);</span>

		<span class="cm">/* timing change...reset timing generator address */</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">BT848_TGCTRL</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x02</span><span class="p">,</span> <span class="n">BT848_TGCTRL</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">BT848_TGCTRL</span><span class="p">);</span>

		<span class="n">len</span><span class="o">=</span><span class="n">SRAM_Table</span><span class="p">[</span><span class="n">table_idx</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">btwrite</span><span class="p">(</span><span class="n">SRAM_Table</span><span class="p">[</span><span class="n">table_idx</span><span class="p">][</span><span class="n">i</span><span class="p">],</span><span class="n">BT848_TGLB</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ofreq</span> <span class="o">=</span> <span class="mi">27000000</span><span class="p">;</span>

		<span class="n">set_pll</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x11</span><span class="p">,</span> <span class="n">BT848_TGCTRL</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x41</span><span class="p">,</span> <span class="n">BT848_DVSIF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_ofreq</span> <span class="o">=</span> <span class="n">fsc</span><span class="p">;</span>
		<span class="n">set_pll</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">BT848_DVSIF</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bt848_bright</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bright</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>printk("set bright: %d\n", bright); // DEBUG</p></td><td class="code"><div class="highlight"><pre>	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">bright</span> <span class="o">=</span> <span class="n">bright</span><span class="p">;</span>

	<span class="cm">/* We want -128 to 127 we get 0-65535 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">bright</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">BT848_BRIGHT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bt848_hue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">hue</span> <span class="o">=</span> <span class="n">hue</span><span class="p">;</span>

	<span class="cm">/* -128 to 127 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">hue</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">128</span><span class="p">;</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">BT848_HUE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bt848_contrast</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cont</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">,</span><span class="n">hibit</span><span class="p">;</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">contrast</span> <span class="o">=</span> <span class="n">cont</span><span class="p">;</span>

	<span class="cm">/* 0-511 */</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">cont</span>  <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">hibit</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">BT848_CONTRAST_LO</span><span class="p">);</span>
	<span class="n">btaor</span><span class="p">(</span><span class="n">hibit</span><span class="p">,</span> <span class="o">~</span><span class="mi">4</span><span class="p">,</span> <span class="n">BT848_E_CONTROL</span><span class="p">);</span>
	<span class="n">btaor</span><span class="p">(</span><span class="n">hibit</span><span class="p">,</span> <span class="o">~</span><span class="mi">4</span><span class="p">,</span> <span class="n">BT848_O_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bt848_sat</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">color</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val_u</span><span class="p">,</span><span class="n">val_v</span><span class="p">,</span><span class="n">hibits</span><span class="p">;</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">saturation</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>

	<span class="cm">/* 0-511 for the color */</span>
	<span class="n">val_u</span>   <span class="o">=</span> <span class="p">((</span><span class="n">color</span> <span class="o">*</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_uv_ratio</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">val_v</span>   <span class="o">=</span> <span class="p">(((</span><span class="n">color</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">-</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_uv_ratio</span><span class="p">)</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&gt;&gt;</span><span class="mi">7</span><span class="p">)</span><span class="o">*</span><span class="mi">180L</span><span class="p">)</span><span class="o">/</span><span class="mi">254</span><span class="p">;</span>
	<span class="n">hibits</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val_u</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">hibits</span> <span class="o">|=</span> <span class="p">(</span><span class="n">val_v</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">val_u</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">BT848_SAT_U_LO</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">val_v</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">BT848_SAT_V_LO</span><span class="p">);</span>
	<span class="n">btaor</span><span class="p">(</span><span class="n">hibits</span><span class="p">,</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">BT848_E_CONTROL</span><span class="p">);</span>
	<span class="n">btaor</span><span class="p">(</span><span class="n">hibits</span><span class="p">,</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span> <span class="n">BT848_O_CONTROL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">video_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mux</span><span class="p">,</span><span class="n">mask2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">video_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* needed by RemoteVideo MX */</span>
	<span class="n">mask2</span> <span class="o">=</span> <span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">gpiomask2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask2</span><span class="p">)</span>
		<span class="n">gpio_inout</span><span class="p">(</span><span class="n">mask2</span><span class="p">,</span><span class="n">mask2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">svhs</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">btor</span><span class="p">(</span><span class="n">BT848_CONTROL_COMP</span><span class="p">,</span> <span class="n">BT848_E_CONTROL</span><span class="p">);</span>
		<span class="n">btor</span><span class="p">(</span><span class="n">BT848_CONTROL_COMP</span><span class="p">,</span> <span class="n">BT848_O_CONTROL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="n">BT848_CONTROL_COMP</span><span class="p">,</span> <span class="n">BT848_E_CONTROL</span><span class="p">);</span>
		<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="n">BT848_CONTROL_COMP</span><span class="p">,</span> <span class="n">BT848_O_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mux</span> <span class="o">=</span> <span class="n">bttv_muxsel</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
	<span class="n">btaor</span><span class="p">(</span><span class="n">mux</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">,</span> <span class="o">~</span><span class="p">(</span><span class="mi">3</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">),</span> <span class="n">BT848_IFORM</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: video mux: input=%d mux=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">mux</span><span class="p">);</span>

	<span class="cm">/* card specific hook */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">muxsel_hook</span><span class="p">)</span>
		<span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">muxsel_hook</span> <span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">audio_modes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;audio: tuner&quot;</span><span class="p">,</span> <span class="s">&quot;audio: radio&quot;</span><span class="p">,</span> <span class="s">&quot;audio: extern&quot;</span><span class="p">,</span>
	<span class="s">&quot;audio: intern&quot;</span><span class="p">,</span> <span class="s">&quot;audio: mute&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">audio_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">gpio_val</span><span class="p">,</span> <span class="n">signal</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">gpio_inout</span><span class="p">(</span><span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">gpiomask</span><span class="p">,</span>
		   <span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">gpiomask</span><span class="p">);</span>
	<span class="n">signal</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_DSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BT848_DSTATUS_HLOC</span><span class="p">;</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">mute</span> <span class="o">=</span> <span class="n">mute</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">audio</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>

	<span class="cm">/* automute */</span>
	<span class="n">mute</span> <span class="o">=</span> <span class="n">mute</span> <span class="o">||</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_automute</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">signal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_user</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span>
		<span class="n">gpio_val</span> <span class="o">=</span> <span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">gpiomute</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">gpio_val</span> <span class="o">=</span> <span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">gpiomux</span><span class="p">[</span><span class="n">input</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BTTV_BOARD_VOODOOTV_FM</span>:
	<span class="k">case</span> <span class="n">BTTV_BOARD_VOODOOTV_200</span>:
		<span class="n">gpio_val</span> <span class="o">=</span> <span class="n">bttv_tda9880_setnorm</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">gpio_val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">gpio_bits</span><span class="p">(</span><span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">gpiomask</span><span class="p">,</span> <span class="n">gpio_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_gpio</span><span class="p">)</span>
		<span class="n">bttv_gpio_tracking</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">audio_modes</span><span class="p">[</span><span class="n">mute</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="n">input</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">in_interrupt</span><span class="p">())</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">;</span>
	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">sd_msp34xx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">in</span><span class="p">;</span>

		<span class="cm">/* Note: the inputs tuner/radio/extern/intern are translated</span>
<span class="cm">		   to msp routings. This assumes common behavior for all msp3400</span>
<span class="cm">		   based TV cards. When this assumption fails, then the</span>
<span class="cm">		   specific MSP routing must be added to the card table.</span>
<span class="cm">		   For now this is sufficient. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TVAUDIO_INPUT_RADIO</span>:
			<span class="cm">/* Some boards need the msp do to the radio demod */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_uses_msp_demodulator</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">in</span> <span class="o">=</span> <span class="n">MSP_INPUT_DEFAULT</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">in</span> <span class="o">=</span> <span class="n">MSP_INPUT</span><span class="p">(</span><span class="n">MSP_IN_SCART2</span><span class="p">,</span> <span class="n">MSP_IN_TUNER1</span><span class="p">,</span>
				    <span class="n">MSP_DSP_IN_SCART</span><span class="p">,</span> <span class="n">MSP_DSP_IN_SCART</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TVAUDIO_INPUT_EXTERN</span>:
			<span class="n">in</span> <span class="o">=</span> <span class="n">MSP_INPUT</span><span class="p">(</span><span class="n">MSP_IN_SCART1</span><span class="p">,</span> <span class="n">MSP_IN_TUNER1</span><span class="p">,</span>
				    <span class="n">MSP_DSP_IN_SCART</span><span class="p">,</span> <span class="n">MSP_DSP_IN_SCART</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TVAUDIO_INPUT_INTERN</span>:
			<span class="cm">/* Yes, this is the same input as for RADIO. I doubt</span>
<span class="cm">			   if this is ever used. The only board with an INTERN</span>
<span class="cm">			   input is the BTTV_BOARD_AVERMEDIA98. I wonder how</span>
<span class="cm">			   that was tested. My guess is that the whole INTERN</span>
<span class="cm">			   input does not work. */</span>
			<span class="n">in</span> <span class="o">=</span> <span class="n">MSP_INPUT</span><span class="p">(</span><span class="n">MSP_IN_SCART2</span><span class="p">,</span> <span class="n">MSP_IN_TUNER1</span><span class="p">,</span>
				    <span class="n">MSP_DSP_IN_SCART</span><span class="p">,</span> <span class="n">MSP_DSP_IN_SCART</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TVAUDIO_INPUT_TUNER</span>:
		<span class="nl">default:</span>
			<span class="cm">/* This is the only card that uses TUNER2, and afaik,</span>
<span class="cm">			   is the only difference between the VOODOOTV_FM</span>
<span class="cm">			   and VOODOOTV_200 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">BTTV_BOARD_VOODOOTV_200</span><span class="p">)</span>
				<span class="n">in</span> <span class="o">=</span> <span class="n">MSP_INPUT</span><span class="p">(</span><span class="n">MSP_IN_SCART1</span><span class="p">,</span> <span class="n">MSP_IN_TUNER2</span><span class="p">,</span> \
					<span class="n">MSP_DSP_IN_TUNER</span><span class="p">,</span> <span class="n">MSP_DSP_IN_TUNER</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">in</span> <span class="o">=</span> <span class="n">MSP_INPUT_DEFAULT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">sd_msp34xx</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span>
			       <span class="n">in</span><span class="p">,</span> <span class="n">MSP_OUTPUT_DEFAULT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">sd_tvaudio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">sd_tvaudio</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span>
				<span class="n">input</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">audio_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">audio_mux</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">audio</span><span class="p">,</span> <span class="n">mute</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">audio_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">audio_mux</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_crop_calc_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_crop</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Scale factor min. 1:1, max. 16:1. Min. image size</span>
<span class="cm">	   48 x 32. Scaled width must be a multiple of 4. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* For bug compatibility with VIDIOCGCAP and image</span>
<span class="cm">		   size checks in earlier driver versions. */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">min_scaled_width</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">min_scaled_height</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">min_scaled_width</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">min_scaled_height</span> <span class="o">=</span>
			<span class="n">max</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_scaled_width</span>  <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">max_scaled_height</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_crop_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_crop</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span> <span class="o">=</span> <span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">norm</span><span class="p">].</span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">;</span>
	<span class="n">bttv_crop_calc_limits</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Call with btv-&gt;lock down. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_tvnorm</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_tvnorm</span> <span class="o">*</span><span class="n">tvnorm</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">norm</span> <span class="o">&gt;=</span> <span class="n">BTTV_TVNORMS</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span> <span class="o">&gt;=</span> <span class="n">BTTV_TVNORMS</span><span class="p">);</span>

	<span class="n">tvnorm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">norm</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">].</span><span class="n">cropcap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">,</span>
		    <span class="k">sizeof</span> <span class="p">(</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">bttv_crop_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* current = default */</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">VIDEO_RESOURCES</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop_start</span> <span class="o">=</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>
				<span class="o">+</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">cropcap</span><span class="p">.</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">;</span>

	<span class="n">btwrite</span><span class="p">(</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">adelay</span><span class="p">,</span> <span class="n">BT848_ADELAY</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">bdelay</span><span class="p">,</span> <span class="n">BT848_BDELAY</span><span class="p">);</span>
	<span class="n">btaor</span><span class="p">(</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">iform</span><span class="p">,</span><span class="o">~</span><span class="p">(</span><span class="n">BT848_IFORM_NORM</span><span class="o">|</span><span class="n">BT848_IFORM_XTBOTH</span><span class="p">),</span>
	      <span class="n">BT848_IFORM</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">vbipack</span><span class="p">,</span> <span class="n">BT848_VBI_PACK_SIZE</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">BT848_VBI_PACK_DEL</span><span class="p">);</span>
	<span class="n">bt848A_set_timing</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BTTV_BOARD_VOODOOTV_FM</span>:
	<span class="k">case</span> <span class="n">BTTV_BOARD_VOODOOTV_200</span>:
		<span class="n">bttv_tda9880_setnorm</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">gpio_read</span><span class="p">());</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">v4l2_id</span><span class="p">;</span>
	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Call with btv-&gt;lock down. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_iswitch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">frame_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* active capture -&gt; delayed input switch */</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">new_input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">video_mux</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">input</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">video_mux</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">input</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">audio_input</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">!=</span> <span class="n">TUNER_ABSENT</span> <span class="o">&amp;&amp;</span> <span class="n">input</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span>
			 <span class="n">TVAUDIO_INPUT_TUNER</span> <span class="o">:</span> <span class="n">TVAUDIO_INPUT_EXTERN</span><span class="p">);</span>
	<span class="n">set_tvnorm</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">norm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_irqreg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* clear status */</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0xfffffUL</span><span class="p">,</span> <span class="n">BT848_INT_STAT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">no_video</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* i2c only */</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">BT848_INT_I2CDONE</span><span class="p">,</span>
			<span class="n">BT848_INT_MASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* full video */</span>
		<span class="n">btwrite</span><span class="p">((</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">triton1</span><span class="p">)</span>  <span class="o">|</span>
			<span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">gpioirq</span> <span class="o">?</span> <span class="n">BT848_INT_GPINT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BT848_INT_SCERR</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">fdsr</span> <span class="o">?</span> <span class="n">BT848_INT_FDSR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BT848_INT_RISCI</span> <span class="o">|</span> <span class="n">BT848_INT_OCERR</span> <span class="o">|</span>
			<span class="n">BT848_INT_FMTCHG</span><span class="o">|</span><span class="n">BT848_INT_HLOCK</span><span class="o">|</span>
			<span class="n">BT848_INT_I2CDONE</span><span class="p">,</span>
			<span class="n">BT848_INT_MASK</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_bt848</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">no_video</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* very basic init only */</span>
		<span class="n">init_irqreg</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">BT848_CAP_CTL</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">BT848_COLOR_CTL_GAMMA</span><span class="p">,</span> <span class="n">BT848_COLOR_CTL</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">BT848_IFORM_XTAUTO</span> <span class="o">|</span> <span class="n">BT848_IFORM_AUTO</span><span class="p">,</span> <span class="n">BT848_IFORM</span><span class="p">);</span>

	<span class="cm">/* set planar and packed mode trigger points and         */</span>
	<span class="cm">/* set rising edge of inverted GPINTR pin as irq trigger */</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">BT848_GPIO_DMA_CTL_PKTP_32</span><span class="o">|</span>
		<span class="n">BT848_GPIO_DMA_CTL_PLTP1_16</span><span class="o">|</span>
		<span class="n">BT848_GPIO_DMA_CTL_PLTP23_16</span><span class="o">|</span>
		<span class="n">BT848_GPIO_DMA_CTL_GPINTC</span><span class="o">|</span>
		<span class="n">BT848_GPIO_DMA_CTL_GPINTI</span><span class="p">,</span>
		<span class="n">BT848_GPIO_DMA_CTL</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_chroma_agc</span> <span class="o">?</span> <span class="n">BT848_SCLOOP_CAGC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">BT848_E_SCLOOP</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">BT848_O_SCLOOP</span><span class="p">);</span>

	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">BT848_E_VSCALE_HI</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x20</span><span class="p">,</span> <span class="n">BT848_O_VSCALE_HI</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">BT848_ADC_RESERVED</span> <span class="o">|</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_adc_crush</span> <span class="o">?</span> <span class="n">BT848_ADC_CRUSH</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">BT848_ADC</span><span class="p">);</span>

	<span class="n">btwrite</span><span class="p">(</span><span class="n">whitecrush_upper</span><span class="p">,</span> <span class="n">BT848_WC_UP</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">whitecrush_lower</span><span class="p">,</span> <span class="n">BT848_WC_DOWN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_lumafilter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BT848_E_CONTROL</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BT848_O_CONTROL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">BT848_CONTROL_LDEC</span><span class="p">,</span> <span class="n">BT848_E_CONTROL</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">BT848_CONTROL_LDEC</span><span class="p">,</span> <span class="n">BT848_O_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">bt848_bright</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span>   <span class="n">btv</span><span class="o">-&gt;</span><span class="n">bright</span><span class="p">);</span>
	<span class="n">bt848_hue</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span>      <span class="n">btv</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">);</span>
	<span class="n">bt848_contrast</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">);</span>
	<span class="n">bt848_sat</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span>      <span class="n">btv</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">);</span>

	<span class="cm">/* interrupt */</span>
	<span class="n">init_irqreg</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bttv_reinit_bt848</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_verbose</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: reset, reinitialize</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">errors</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">bttv_set_dma</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">init_bt848</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">pll_current</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">set_input</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">bright</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">hue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">contrast</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span>:
		<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_CHROMA_AGC</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_chroma_agc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_COMBFILTER</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_combfilter</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_LUMAFILTER</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_lumafilter</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_AUTOMUTE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_automute</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_AGC_CRUSH</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_adc_crush</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_VCR_HACK</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_vcr_hack</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_WHITECRUSH_UPPER</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_whitecrush_upper</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_WHITECRUSH_LOWER</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_whitecrush_lower</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_UV_RATIO</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_uv_ratio</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_FULL_LUMA_RANGE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_full_luma_range</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_CORING</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_coring</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">bt848_bright</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">bt848_hue</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">bt848_contrast</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">bt848_sat</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="n">audio_mute</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">volume_gpio</span><span class="p">)</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">volume_gpio</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

		<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span>:
		<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_CHROMA_AGC</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_chroma_agc</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_chroma_agc</span> <span class="o">?</span> <span class="n">BT848_SCLOOP_CAGC</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">BT848_E_SCLOOP</span><span class="p">);</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">BT848_O_SCLOOP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_COMBFILTER</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_combfilter</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_LUMAFILTER</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_lumafilter</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_lumafilter</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="n">BT848_CONTROL_LDEC</span><span class="p">,</span> <span class="n">BT848_E_CONTROL</span><span class="p">);</span>
			<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="n">BT848_CONTROL_LDEC</span><span class="p">,</span> <span class="n">BT848_O_CONTROL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">btor</span><span class="p">(</span><span class="n">BT848_CONTROL_LDEC</span><span class="p">,</span> <span class="n">BT848_E_CONTROL</span><span class="p">);</span>
			<span class="n">btor</span><span class="p">(</span><span class="n">BT848_CONTROL_LDEC</span><span class="p">,</span> <span class="n">BT848_O_CONTROL</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_AUTOMUTE</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_automute</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_AGC_CRUSH</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_adc_crush</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">BT848_ADC_RESERVED</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_adc_crush</span> <span class="o">?</span> <span class="n">BT848_ADC_CRUSH</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
				<span class="n">BT848_ADC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_VCR_HACK</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_vcr_hack</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_WHITECRUSH_UPPER</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_whitecrush_upper</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">BT848_WC_UP</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_WHITECRUSH_LOWER</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_whitecrush_lower</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">BT848_WC_DOWN</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_UV_RATIO</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_uv_ratio</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">bt848_sat</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">saturation</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_FULL_LUMA_RANGE</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_full_luma_range</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">btaor</span><span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">&lt;&lt;</span><span class="mi">7</span><span class="p">),</span> <span class="o">~</span><span class="n">BT848_OFORM_RANGE</span><span class="p">,</span> <span class="n">BT848_OFORM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_CORING</span>:
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_coring</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">btaor</span><span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">&lt;&lt;</span><span class="mi">5</span><span class="p">),</span> <span class="o">~</span><span class="n">BT848_OFORM_CORE32</span><span class="p">,</span> <span class="n">BT848_OFORM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="kt">void</span> <span class="nf">bttv_gpio_tracking</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">comment</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">outbits</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">outbits</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_GPIO_OUT_EN</span><span class="p">);</span>
	<span class="n">data</span>    <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_GPIO_DATA</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%d: gpio: en=%08x, out=%08x in=%08x [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">outbits</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="n">outbits</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">outbits</span><span class="p">,</span> <span class="n">comment</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bttv_field_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">need_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="n">need_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">need_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start field counter */</span>
		<span class="n">btor</span><span class="p">(</span><span class="n">BT848_INT_VSYNC</span><span class="p">,</span><span class="n">BT848_INT_MASK</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* stop field counter */</span>
		<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="n">BT848_INT_VSYNC</span><span class="p">,</span><span class="n">BT848_INT_MASK</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">field_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_format</span><span class="o">*</span>
<span class="nf">format_by_fourcc</span><span class="p">(</span><span class="kt">int</span> <span class="n">fourcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FORMATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">fourcc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">formats</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* misc helpers                                                            */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bttv_switch_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;switch_overlay: enter [new=%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span><span class="p">)</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">bttv_set_dma</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;switch_overlay: old=%p state is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">old</span><span class="p">,</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span><span class="p">);</span>
		<span class="n">bttv_dma_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span><span class="n">btv</span><span class="p">,</span> <span class="n">old</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">old</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">new</span><span class="p">)</span>
		<span class="n">free_btres_lock</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_OVERLAY</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;switch_overlay: done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* video4linux (1) interface                                               */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_prepare_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">redo_dma_risc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_crop</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">norm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* check settings */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">btformat</span> <span class="o">==</span> <span class="n">BT848_COLOR_FMT_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">width</span>  <span class="o">=</span> <span class="n">RAW_BPL</span><span class="p">;</span>
		<span class="n">height</span> <span class="o">=</span> <span class="n">RAW_LINES</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">width</span><span class="o">*</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">bsize</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">bsize</span><span class="p">;</span>

		<span class="cm">/* Make sure tvnorm and vbi_end remain consistent</span>
<span class="cm">		   until we&#39;re done. */</span>

		<span class="n">norm</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">;</span>

		<span class="cm">/* In this mode capturing always starts at defrect.top</span>
<span class="cm">		   (default VDELAY), ignoring cropping parameters. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span> <span class="o">&gt;</span> <span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">norm</span><span class="p">].</span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">c</span><span class="p">.</span><span class="n">rect</span> <span class="o">=</span> <span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">norm</span><span class="p">].</span><span class="n">cropcap</span><span class="p">.</span><span class="n">defrect</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">norm</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">;</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="o">!!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">.</span><span class="n">min_scaled_width</span> <span class="o">||</span>
		    <span class="n">width</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">max_scaled_width</span> <span class="o">||</span>
		    <span class="n">height</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">.</span><span class="n">min_scaled_height</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
		<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
		<span class="k">case</span> <span class="n">V4L2_FIELD_ALTERNATE</span>:
			<span class="cm">/* btv-&gt;crop counts frame lines. Max. scale</span>
<span class="cm">			   factor is 16:1 for frames, 8:1 for fields. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">max_scaled_height</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">max_scaled_height</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">baddr</span>  <span class="o">&amp;&amp;</span>  <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">bsize</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* alloc + fill struct bttv_buffer (if changed) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">width</span> <span class="o">||</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">!=</span> <span class="n">height</span> <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span> <span class="o">!=</span> <span class="n">field</span> <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">tvnorm</span> <span class="o">!=</span> <span class="n">norm</span> <span class="o">||</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">!=</span> <span class="n">fmt</span> <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">top</span> <span class="o">!=</span> <span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">left</span> <span class="o">!=</span> <span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">height</span> <span class="o">!=</span> <span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span>  <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">tvnorm</span>    <span class="o">=</span> <span class="n">norm</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span>       <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">crop</span>      <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">;</span>
		<span class="n">redo_dma_risc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* alloc risc memory */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">redo_dma_risc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">videobuf_iolock</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">redo_dma_risc</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">bttv_buffer_risc</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">buf</span><span class="p">)))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">bttv_dma_free</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">btv</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">buffer_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">*</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">*</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">gbuffers</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">size</span> <span class="o">*</span> <span class="o">*</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">gbuffers</span> <span class="o">*</span> <span class="n">gbufsize</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="p">(</span><span class="n">gbuffers</span> <span class="o">*</span> <span class="n">gbufsize</span><span class="p">)</span> <span class="o">/</span> <span class="o">*</span><span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">buffer_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span>
	       <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span><span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">,</span><span class="n">vb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">bttv_prepare_buffer</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">,</span>
				   <span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">field</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">buffer_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span><span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">,</span><span class="n">vb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span>    <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">frame_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bttv_set_dma</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buffer_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span><span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">,</span><span class="n">vb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>

	<span class="n">bttv_dma_free</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue_ops</span> <span class="n">bttv_video_qops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buf_setup</span>    <span class="o">=</span> <span class="n">buffer_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span>  <span class="o">=</span> <span class="n">buffer_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span>    <span class="o">=</span> <span class="n">buffer_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_release</span>  <span class="o">=</span> <span class="n">buffer_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span>  <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BTTV_TVNORMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">v4l2_id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">BTTV_TVNORMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_tvnorm</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

<span class="nl">err:</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_querystd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btread</span><span class="p">(</span><span class="n">BT848_DSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BT848_DSTATUS_NUML</span><span class="p">)</span>
		<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_STD_625_50</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_STD_525_60</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">video_inputs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span>     <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">audioset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">!=</span> <span class="n">TUNER_ABSENT</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Television&quot;</span><span class="p">);</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span>  <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_TUNER</span><span class="p">;</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">svhs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;S-Video&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Composite%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">dstatus</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_DSTATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">dstatus</span> <span class="o">&amp;</span> <span class="n">BT848_DSTATUS_PRES</span><span class="p">))</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">V4L2_IN_ST_NO_SIGNAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">dstatus</span> <span class="o">&amp;</span> <span class="n">BT848_DSTATUS_HLOC</span><span class="p">))</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">V4L2_IN_ST_NO_H_LOCK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">BTTV_NORMS</span><span class="p">;</span>

<span class="nl">err:</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span>  <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">video_inputs</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_input</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>

<span class="nl">err:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span>  <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_ABSENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_tuner</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">audio_mode_gpio</span><span class="p">)</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">audio_mode_gpio</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nl">err:</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span>  <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_user</span> <span class="o">?</span> <span class="n">V4L2_TUNER_RADIO</span> <span class="o">:</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span>  <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_user</span>
		<span class="o">?</span> <span class="n">V4L2_TUNER_RADIO</span> <span class="o">:</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_frequency</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">has_matchbox</span> <span class="o">&amp;&amp;</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_user</span><span class="p">)</span>
		<span class="n">tea5757_set_freq</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">);</span>
<span class="nl">err:</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span>  <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">log_status</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* bt848 has a 12-bit register space */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* bt848 has a 12-bit register space */</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;=</span> <span class="mh">0xfff</span><span class="p">;</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Given cropping boundaries b and the scaled width and height of a</span>
<span class="cm">   single field or frame, which must not exceed hardware limits, this</span>
<span class="cm">   function adjusts the cropping parameters c. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_crop_adjust</span>	<span class="p">(</span><span class="k">struct</span> <span class="n">bttv_crop</span> <span class="o">*</span>             <span class="n">c</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span>	<span class="n">b</span><span class="p">,</span>
			 <span class="n">__s32</span>                          <span class="n">width</span><span class="p">,</span>
			 <span class="n">__s32</span>                          <span class="n">height</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">v4l2_field</span>                <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__s32</span> <span class="n">frame_height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="o">!</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>
	<span class="n">__s32</span> <span class="n">max_left</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">max_top</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">min_scaled_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Max. hor. scale factor 16:1. */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_scaled_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Min. hor. scale factor 1:1. */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>

		<span class="n">max_left</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">max_left</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_left</span><span class="p">,</span> <span class="p">(</span><span class="n">__s32</span><span class="p">)</span> <span class="n">MAX_HDELAY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">max_left</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">max_left</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">min_scaled_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Max. vert. scale factor 16:1, single fields 8:1. */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frame_height</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_scaled_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Min. vert. scale factor 1:1.</span>
<span class="cm">		   Top and height count field lines times two. */</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame_height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">max_top</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">&gt;</span> <span class="n">max_top</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">max_top</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bttv_crop_calc_limits</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Returns an error if scaling to a frame or single field with the given</span>
<span class="cm">   width and height is not possible with the current cropping parameters</span>
<span class="cm">   and width aligned according to width_mask. If adjust_size is TRUE the</span>
<span class="cm">   function may adjust the width and/or height instead, rounding width</span>
<span class="cm">   to (width + width_bias) &amp; width_mask. If adjust_crop is TRUE it may</span>
<span class="cm">   also adjust the current cropping parameters to get closer to the</span>
<span class="cm">   desired image size. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">limit_scaled_size_lock</span>       <span class="p">(</span><span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span>               <span class="n">fh</span><span class="p">,</span>
			 <span class="n">__s32</span> <span class="o">*</span>                        <span class="n">width</span><span class="p">,</span>
			 <span class="n">__s32</span> <span class="o">*</span>                        <span class="n">height</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">v4l2_field</span>                <span class="n">field</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">width_mask</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span>			<span class="n">width_bias</span><span class="p">,</span>
			 <span class="kt">int</span>                            <span class="n">adjust_size</span><span class="p">,</span>
			 <span class="kt">int</span>                            <span class="n">adjust_crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_crop</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">min_width</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">min_height</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">max_width</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">max_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span> <span class="n">width_mask</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span>
	       <span class="n">width_bias</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="o">-</span><span class="n">width_mask</span><span class="p">);</span>

	<span class="cm">/* Make sure tvnorm, vbi_end and the current cropping parameters</span>
<span class="cm">	   remain consistent until we&#39;re done. */</span>

	<span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">].</span><span class="n">cropcap</span><span class="p">.</span><span class="n">bounds</span><span class="p">;</span>

	<span class="cm">/* Do crop - use current, don&#39;t - use default parameters. */</span>
	<span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="o">!!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span>
	    <span class="o">&amp;&amp;</span> <span class="n">adjust_size</span>
	    <span class="o">&amp;&amp;</span> <span class="n">adjust_crop</span>
	    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">locked_btres</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">VIDEO_RESOURCES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">min_width</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="n">min_height</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

		<span class="cm">/* We cannot scale up. When the scaled image is larger</span>
<span class="cm">		   than crop.rect we adjust the crop.rect as required</span>
<span class="cm">		   by the V4L2 spec, hence cropcap.bounds are our limit. */</span>
		<span class="n">max_width</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="p">(</span><span class="n">__s32</span><span class="p">)</span> <span class="n">MAX_HACTIVE</span><span class="p">);</span>
		<span class="n">max_height</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

		<span class="cm">/* We cannot capture the same line as video and VBI data.</span>
<span class="cm">		   Note btv-&gt;vbi_end is really a minimum, see</span>
<span class="cm">		   bttv_vbi_try_fmt(). */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">max_height</span> <span class="o">-=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span> <span class="o">-</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">min_height</span> <span class="o">&gt;</span> <span class="n">max_height</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

		<span class="n">min_width</span>  <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">min_scaled_width</span><span class="p">;</span>
		<span class="n">min_height</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">min_scaled_height</span><span class="p">;</span>
		<span class="n">max_width</span>  <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_scaled_width</span><span class="p">;</span>
		<span class="n">max_height</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">max_scaled_height</span><span class="p">;</span>

		<span class="n">adjust_crop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">min_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">min_width</span> <span class="o">-</span> <span class="n">width_mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">width_mask</span><span class="p">;</span>
	<span class="n">max_width</span> <span class="o">=</span> <span class="n">max_width</span> <span class="o">&amp;</span> <span class="n">width_mask</span><span class="p">;</span>

	<span class="cm">/* Max. scale factor is 16:1 for frames, 8:1 for fields. */</span>
	<span class="n">min_height</span> <span class="o">=</span> <span class="n">min_height</span><span class="p">;</span>
	<span class="cm">/* Min. scale factor is 1:1. */</span>
	<span class="n">max_height</span> <span class="o">&gt;&gt;=</span> <span class="o">!</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">field</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adjust_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">min_width</span><span class="p">,</span> <span class="n">max_width</span><span class="p">);</span>
		<span class="o">*</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="o">*</span><span class="n">height</span><span class="p">,</span> <span class="n">min_height</span><span class="p">,</span> <span class="n">max_height</span><span class="p">);</span>

		<span class="cm">/* Round after clamping to avoid overflow. */</span>
		<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">width</span> <span class="o">+</span> <span class="n">width_bias</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">width_mask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adjust_crop</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bttv_crop_adjust</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="o">*</span><span class="n">height</span><span class="p">,</span> <span class="n">field</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span> <span class="o">&gt;</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Move the crop window out of the way. */</span>
				<span class="n">c</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">width</span>  <span class="o">&lt;</span> <span class="n">min_width</span> <span class="o">||</span>
		    <span class="o">*</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">min_height</span> <span class="o">||</span>
		    <span class="o">*</span><span class="n">width</span>  <span class="o">&gt;</span> <span class="n">max_width</span> <span class="o">||</span>
		    <span class="o">*</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">max_height</span> <span class="o">||</span>
		    <span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="n">width</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">width_mask</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* success */</span>

 <span class="nl">fail:</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns an error if the given overlay window dimensions are not</span>
<span class="cm">   possible with the current cropping parameters. If adjust_size is</span>
<span class="cm">   TRUE the function may adjust the window width and/or height</span>
<span class="cm">   instead, however it always rounds the horizontal position and</span>
<span class="cm">   width as btcx_align() does. If adjust_crop is TRUE the function</span>
<span class="cm">   may also adjust the current cropping parameters to get closer</span>
<span class="cm">   to the desired window size. */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">verify_window_lock</span>		<span class="p">(</span><span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span>               <span class="n">fh</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span>           <span class="n">win</span><span class="p">,</span>
			 <span class="kt">int</span>                            <span class="n">adjust_size</span><span class="p">,</span>
			 <span class="kt">int</span>                            <span class="n">adjust_crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width_mask</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span>  <span class="o">&lt;</span> <span class="mi">48</span> <span class="o">||</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">clipcount</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_ANY</span> <span class="o">==</span> <span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__s32</span> <span class="n">height2</span><span class="p">;</span>

		<span class="n">height2</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="o">!!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">height2</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">V4L2_FIELD_INTERLACED</span>
			<span class="o">:</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* 4-byte alignment. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">width_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">width_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">width_mask</span> <span class="o">=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">-=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">left</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">width_mask</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">left</span> <span class="o">-</span> <span class="n">width_mask</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">width_mask</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">limit_scaled_size_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			       <span class="n">field</span><span class="p">,</span> <span class="n">width_mask</span><span class="p">,</span>
			       <span class="cm">/* width_bias: round down */</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">adjust_size</span><span class="p">,</span> <span class="n">adjust_crop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_window_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span><span class="n">win</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fixup</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_clip</span> <span class="o">*</span><span class="n">clips</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">verify_window_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">win</span><span class="p">,</span>
			       <span class="cm">/* adjust_size */</span> <span class="n">fixup</span><span class="p">,</span>
			       <span class="cm">/* adjust_crop */</span> <span class="n">fixup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="cm">/* copy clips  --  luckily v4l1 + v4l2 are binary</span>
<span class="cm">	   compatible here ...*/</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">clipcount</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">clips</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">n</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
	<span class="n">clips</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">clips</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">clips</span><span class="p">,</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">clips</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_clip</span><span class="p">)</span><span class="o">*</span><span class="n">n</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">clips</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* clip against screen */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">base</span><span class="p">)</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">btcx_screen_clips</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">clips</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
	<span class="n">btcx_sort_clips</span><span class="p">(</span><span class="n">clips</span><span class="p">,</span><span class="n">n</span><span class="p">);</span>

	<span class="cm">/* 4-byte alignments */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">24</span>:
		<span class="n">btcx_align</span><span class="p">(</span><span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">clips</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">16</span>:
		<span class="n">btcx_align</span><span class="p">(</span><span class="o">&amp;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">,</span> <span class="n">clips</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">32</span>:
		<span class="cm">/* no alignment fixups needed */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">clips</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">clips</span>    <span class="o">=</span> <span class="n">clips</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">nclips</span>   <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span>        <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">field</span>    <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">setup_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span>   <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span>  <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">ov</span><span class="p">.</span><span class="n">field</span>     <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>

	<span class="cm">/* update overlay if needed */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_btres</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

		<span class="n">new</span> <span class="o">=</span> <span class="n">videobuf_sg_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">));</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">crop</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="o">!!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span><span class="p">].</span><span class="n">rect</span><span class="p">;</span>
		<span class="n">bttv_overlay_risc</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">bttv_switch_overlay</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue</span><span class="o">*</span> <span class="nf">bttv_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span><span class="o">*</span> <span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span>:
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">q</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">RESOURCE_VIDEO_STREAM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">RESOURCE_VBI</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_switch_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="n">bttv_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">bttv_resource</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_btres</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span><span class="n">res</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">videobuf_queue_is_busy</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pix_format_set_size</span>     <span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span>       <span class="n">f</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_format</span> <span class="o">*</span>     <span class="n">fmt</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span>                   <span class="n">width</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span>                   <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FORMAT_FLAGS_PLANAR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span> <span class="cm">/* Y plane */</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">height</span> <span class="o">*</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">*</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">height</span> <span class="o">*</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span>  <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">pix_format_set_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">,</span>
				<span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span>        <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span>  <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span>  <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">w</span>     <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_ANY</span> <span class="o">==</span> <span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__s32</span> <span class="n">height2</span><span class="p">;</span>

		<span class="n">height2</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="o">!!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span><span class="p">].</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">height2</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">V4L2_FIELD_INTERLACED</span>
			<span class="o">:</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_SEQ_BT</span> <span class="o">==</span> <span class="n">field</span><span class="p">)</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_ALTERNATE</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_SEQ_TB</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FORMAT_FLAGS_PLANAR</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">limit_scaled_size_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">,</span> <span class="n">field</span><span class="p">,</span>
			       <span class="cm">/* width_mask: 4 pixels */</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span>
			       <span class="cm">/* width_bias: nearest */</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="cm">/* adjust_size */</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/* adjust_crop */</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* update data for the application */</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">pix_format_set_size</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_try_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">verify_window_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">,</span>
			<span class="cm">/* adjust_size */</span> <span class="mi">1</span><span class="p">,</span>
			<span class="cm">/* adjust_crop */</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">bttv_switch_type</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">bttv_try_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">width</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">height</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">field</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">limit_scaled_size_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">,</span>
			       <span class="cm">/* width_mask: 4 pixels */</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span>
			       <span class="cm">/* width_bias: nearest */</span> <span class="mi">2</span><span class="p">,</span>
			       <span class="cm">/* adjust_size */</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="cm">/* adjust_crop */</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>

	<span class="cm">/* update our state informations */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span>              <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">field</span>        <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">last</span>         <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span>            <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span>           <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">fmt</span>        <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">width</span>      <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">height</span>     <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_overlay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;V4L2_BUF_TYPE_VIDEO_OVERLAY: no_overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">setup_window_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">v4l2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;bttv&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">),</span>
		 <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span>
		<span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_VBI_CAPTURE</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_READWRITE</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_overlay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">V4L2_CAP_VIDEO_OVERLAY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No need to lock here: those vars are initialized during board</span>
<span class="cm">	 * probe and remains untouched during the rest of the driver lifecycle</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">has_saa6588</span><span class="p">)</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">V4L2_CAP_RDS_CAPTURE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">!=</span> <span class="n">TUNER_ABSENT</span><span class="p">)</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">V4L2_CAP_TUNER</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_enum_fmt_cap_ovr</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FORMATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">index</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">index</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FORMATS</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">bttv_enum_fmt_cap_ovr</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_enum_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">no_overlay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;V4L2_BUF_TYPE_VIDEO_OVERLAY: no_overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">bttv_enum_fmt_cap_ovr</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="n">rc</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_FBUF_CAP_LIST_CLIPPING</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span>  <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* verify args */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">base</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">setup_ok</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: overlay: !setup_ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_alloc_btres_lock</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">tvnorm</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">;</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">videobuf_sg_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">));</span>
		<span class="n">new</span><span class="o">-&gt;</span><span class="n">crop</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="o">!!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span><span class="p">].</span><span class="n">rect</span><span class="p">;</span>
		<span class="n">bttv_overlay_risc</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* switch over */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">bttv_switch_overlay</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bttv_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* check args */</span>
	<span class="n">fmt</span> <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FORMAT_FLAGS_PACKED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_OVERLAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__s32</span> <span class="n">width</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">__s32</span> <span class="n">height</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">limit_scaled_size_lock</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">,</span>
					   <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
					   <span class="cm">/* width_mask */</span> <span class="o">~</span><span class="mi">3</span><span class="p">,</span>
					   <span class="cm">/* width_bias */</span> <span class="mi">2</span><span class="p">,</span>
					   <span class="cm">/* adjust_size */</span> <span class="mi">0</span><span class="p">,</span>
					   <span class="cm">/* adjust_crop */</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ok, accept it */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">base</span>       <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">)</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="o">*</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">ovfmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_OVERLAY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">left</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">top</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">clips</span><span class="p">);</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">clips</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">nclips</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">check_btres</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

			<span class="n">new</span> <span class="o">=</span> <span class="n">videobuf_sg_alloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new</span><span class="p">));</span>
			<span class="n">new</span><span class="o">-&gt;</span><span class="n">crop</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="o">!!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span><span class="p">].</span><span class="n">rect</span><span class="p">;</span>
			<span class="n">bttv_overlay_risc</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">bttv_switch_overlay</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videobuf_reqbufs</span><span class="p">(</span><span class="n">bttv_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videobuf_querybuf</span><span class="p">(</span><span class="n">bttv_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">bttv_resource</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_alloc_btres_lock</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">videobuf_qbuf</span><span class="p">(</span><span class="n">bttv_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="n">bttv_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">b</span><span class="p">,</span>
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">bttv_resource</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_alloc_btres_lock</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videobuf_streamon</span><span class="p">(</span><span class="n">bttv_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">bttv_resource</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>


	<span class="n">retval</span> <span class="o">=</span> <span class="n">videobuf_streamoff</span><span class="p">(</span><span class="n">bttv_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">free_btres_lock</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span>  <span class="n">V4L2_CID_BASE</span> <span class="o">||</span>
	     <span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_LASTP1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span>  <span class="n">V4L2_CID_PRIVATE_BASE</span> <span class="o">||</span>
	     <span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_PRIVATE_LASTP1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">volume_gpio</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span><span class="p">))</span>
		<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">no_ctl</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">ctrl</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">:</span> <span class="n">no_ctl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="n">v4l2_video_std_frame_period</span><span class="p">(</span><span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">].</span><span class="n">v4l2_id</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_ABSENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">t</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">g_tuner</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Television&quot;</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_TUNER_CAP_NORM</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span>       <span class="o">=</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btread</span><span class="p">(</span><span class="n">BT848_DSTATUS</span><span class="p">)</span><span class="o">&amp;</span><span class="n">BT848_DSTATUS_HLOC</span><span class="p">)</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">audio_mode_gpio</span><span class="p">)</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">audio_mode_gpio</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_priority</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v4l2_prio_max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">v4l2_priority</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">rc</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">v4l2_prio_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">].</span><span class="n">cropcap</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* No fh-&gt;do_crop = 1; because btv-&gt;crop[1] may be</span>
<span class="cm">	   inconsistent with fh-&gt;width or fh-&gt;height and apps</span>
<span class="cm">	   do not expect a change here. */</span>

	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="o">!!</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span><span class="p">].</span><span class="n">rect</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_crop</span> <span class="n">c</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">b_left</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">b_top</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">b_right</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">b_bottom</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Make sure tvnorm, vbi_end and the current cropping</span>
<span class="cm">	   parameters remain consistent until we&#39;re done. Note</span>
<span class="cm">	   read() may change vbi_end in check_alloc_btres_lock(). */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">locked_btres</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">,</span> <span class="n">VIDEO_RESOURCES</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bttv_tvnorms</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">].</span><span class="n">cropcap</span><span class="p">.</span><span class="n">bounds</span><span class="p">;</span>

	<span class="n">b_left</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
	<span class="n">b_right</span> <span class="o">=</span> <span class="n">b_left</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">b_bottom</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="n">b_top</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b_top</span> <span class="o">+</span> <span class="mi">32</span> <span class="o">&gt;=</span> <span class="n">b_bottom</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Min. scaled size 48 x 32. */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">b_left</span><span class="p">,</span> <span class="n">b_right</span> <span class="o">-</span> <span class="mi">48</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="p">(</span><span class="n">__s32</span><span class="p">)</span> <span class="n">MAX_HDELAY</span><span class="p">);</span>

	<span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			     <span class="mi">48</span><span class="p">,</span> <span class="n">b_right</span> <span class="o">-</span> <span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>

	<span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">b_top</span><span class="p">,</span> <span class="n">b_bottom</span> <span class="o">-</span> <span class="mi">32</span><span class="p">);</span>
	<span class="cm">/* Top and height must be a multiple of two. */</span>
	<span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			      <span class="mi">32</span><span class="p">,</span> <span class="n">b_bottom</span> <span class="o">-</span> <span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>
	<span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">bttv_crop_calc_limits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="p">);</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">.</span><span class="n">min_scaled_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">min_scaled_width</span><span class="p">;</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">min_scaled_width</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">max_scaled_width</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">max_scaled_width</span><span class="p">;</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">max_scaled_width</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;</span> <span class="n">c</span><span class="p">.</span><span class="n">min_scaled_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">min_scaled_height</span><span class="p">;</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">min_scaled_height</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">c</span><span class="p">.</span><span class="n">max_scaled_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">max_scaled_height</span><span class="p">;</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">max_scaled_height</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_g_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;audio&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_s_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bttv_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">errors</span><span class="p">)</span>
		<span class="n">bttv_reinit_bt848</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: read count=%d type=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">count</span><span class="p">,</span> <span class="n">v4l2_type_names</span><span class="p">[</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_alloc_btres_lock</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_VIDEO_READ</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* VIDEO_READ in use by another fh,</span>
<span class="cm">			   or VIDEO_STREAM by any fh. */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">videobuf_read_one</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span>
					   <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
		<span class="n">free_btres_lock</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_VIDEO_READ</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_alloc_btres_lock</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_VBI</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">videobuf_read_stream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					      <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">bttv_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="n">POLLERR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">check_alloc_btres_lock</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_VBI</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">POLLERR</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">videobuf_poll_stream</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">check_btres</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_VIDEO_STREAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* streaming capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">stream</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">,</span><span class="n">vb</span><span class="p">.</span><span class="n">stream</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* read() capture */</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* need to capture a new frame */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">locked_btres</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">,</span><span class="n">RESOURCE_VIDEO_STREAM</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span> <span class="o">=</span> <span class="n">videobuf_sg_alloc</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">msize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_USERPTR</span><span class="p">;</span>
			<span class="n">field</span> <span class="o">=</span> <span class="n">videobuf_next_field</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">buf_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">,</span><span class="n">field</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">kfree</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">);</span>
				<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">buf_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">);</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bttv_buffer</span><span class="o">*</span><span class="p">)</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">VIDEOBUF_DONE</span> <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">VIDEOBUF_ERROR</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span>  <span class="n">POLLIN</span><span class="o">|</span><span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;open dev=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">vdev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vfl_type</span> <span class="o">==</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vfl_type</span> <span class="o">==</span> <span class="n">VFL_TYPE_VBI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: open called (type=%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">v4l2_type_names</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>

	<span class="cm">/* allocate per filehandle data */</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fh</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">ov</span><span class="p">.</span><span class="n">setup_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">v4l2_prio_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="n">videobuf_queue_sg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bttv_video_qops</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span>
			    <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">,</span>
			    <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">),</span>
			    <span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">videobuf_queue_sg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bttv_vbi_qops</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span>
			    <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span><span class="p">,</span>
			    <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">),</span>
			    <span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">set_tvnorm</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>
	<span class="n">set_input</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* The V4L2 spec requires one global set of cropping parameters</span>
<span class="cm">	   which only change on request. These are stored in btv-&gt;crop[1].</span>
<span class="cm">	   However for compatibility with V4L apps and cropping unaware</span>
<span class="cm">	   V4L2 apps we now reset the cropping parameters as seen through</span>
<span class="cm">	   this fh, which is to say VIDIOC_G_CROP and scaling limit checks</span>
<span class="cm">	   will use btv-&gt;crop[0], the default cropping parameters for the</span>
<span class="cm">	   current video standard, and VIDIOC_S_FMT will not implicitely</span>
<span class="cm">	   change the cropping parameters until VIDIOC_S_CROP has been</span>
<span class="cm">	   called. */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">do_crop</span> <span class="o">=</span> <span class="o">!</span><span class="n">reset_crop</span><span class="p">;</span> <span class="cm">/* module parameter */</span>

	<span class="cm">/* Likewise there should be one global set of VBI capture</span>
<span class="cm">	   parameters, but for compatibility with V4L apps and earlier</span>
<span class="cm">	   driver versions each fh has its own parameters. */</span>
	<span class="n">bttv_vbi_fmt_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi_fmt</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>

	<span class="n">bttv_field_count</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="cm">/* turn off overlay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_btres</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span>
		<span class="n">bttv_switch_overlay</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* stop video capture */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_btres</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_VIDEO_STREAM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">);</span>
		<span class="n">free_btres_lock</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_VIDEO_STREAM</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_btres</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_VIDEO_READ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">free_btres_lock</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_VIDEO_READ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* stop vbi capture */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_btres</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_VBI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">videobuf_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">);</span>
		<span class="n">free_btres_lock</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_VBI</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* free stuff */</span>

	<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">);</span>
	<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">);</span>
	<span class="n">v4l2_prio_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">--</span><span class="p">;</span>
	<span class="n">bttv_field_count</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="n">audio_mute</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bttv_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: mmap type=%s 0x%lx+%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">v4l2_type_names</span><span class="p">[</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">],</span>
		<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">videobuf_mmap_mapper</span><span class="p">(</span><span class="n">bttv_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span><span class="n">vma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">bttv_fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		  <span class="o">=</span> <span class="n">bttv_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	  <span class="o">=</span> <span class="n">bttv_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	  <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		  <span class="o">=</span> <span class="n">bttv_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		  <span class="o">=</span> <span class="n">bttv_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		  <span class="o">=</span> <span class="n">bttv_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">bttv_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>                <span class="o">=</span> <span class="n">bttv_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span>        <span class="o">=</span> <span class="n">bttv_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span>           <span class="o">=</span> <span class="n">bttv_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>         <span class="o">=</span> <span class="n">bttv_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>           <span class="o">=</span> <span class="n">bttv_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_overlay</span>    <span class="o">=</span> <span class="n">bttv_enum_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_overlay</span>       <span class="o">=</span> <span class="n">bttv_g_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_overlay</span>     <span class="o">=</span> <span class="n">bttv_try_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_overlay</span>       <span class="o">=</span> <span class="n">bttv_s_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vbi_cap</span>           <span class="o">=</span> <span class="n">bttv_g_fmt_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vbi_cap</span>         <span class="o">=</span> <span class="n">bttv_try_fmt_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vbi_cap</span>           <span class="o">=</span> <span class="n">bttv_s_fmt_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audio</span>                 <span class="o">=</span> <span class="n">bttv_g_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audio</span>                 <span class="o">=</span> <span class="n">bttv_s_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>                 <span class="o">=</span> <span class="n">bttv_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>                 <span class="o">=</span> <span class="n">bttv_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>                <span class="o">=</span> <span class="n">bttv_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>                    <span class="o">=</span> <span class="n">bttv_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>                   <span class="o">=</span> <span class="n">bttv_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span>                   <span class="o">=</span> <span class="n">bttv_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>              <span class="o">=</span> <span class="n">bttv_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>                 <span class="o">=</span> <span class="n">bttv_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>                 <span class="o">=</span> <span class="n">bttv_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>               <span class="o">=</span> <span class="n">bttv_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>                  <span class="o">=</span> <span class="n">bttv_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>                  <span class="o">=</span> <span class="n">bttv_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>                <span class="o">=</span> <span class="n">bttv_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>               <span class="o">=</span> <span class="n">bttv_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>                 <span class="o">=</span> <span class="n">bttv_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>                 <span class="o">=</span> <span class="n">bttv_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_crop</span>                  <span class="o">=</span> <span class="n">bttv_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_crop</span>                  <span class="o">=</span> <span class="n">bttv_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fbuf</span>                  <span class="o">=</span> <span class="n">bttv_g_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fbuf</span>                  <span class="o">=</span> <span class="n">bttv_s_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_overlay</span>                 <span class="o">=</span> <span class="n">bttv_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_priority</span>              <span class="o">=</span> <span class="n">bttv_g_priority</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_priority</span>              <span class="o">=</span> <span class="n">bttv_s_priority</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_parm</span>                  <span class="o">=</span> <span class="n">bttv_g_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span>             <span class="o">=</span> <span class="n">bttv_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>             <span class="o">=</span> <span class="n">bttv_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_log_status</span>		<span class="o">=</span> <span class="n">bttv_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querystd</span>		<span class="o">=</span> <span class="n">bttv_querystd</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">vidioc_g_register</span>		<span class="o">=</span> <span class="n">bttv_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_register</span>		<span class="o">=</span> <span class="n">bttv_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">bttv_video_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fops</span>         <span class="o">=</span> <span class="o">&amp;</span><span class="n">bttv_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span>    <span class="o">=</span> <span class="o">&amp;</span><span class="n">bttv_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span>      <span class="o">=</span> <span class="n">BTTV_NORMS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">current_norm</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* radio interface                                                         */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;open dev=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">vdev</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: open called (radio)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>

	<span class="cm">/* allocate per filehandle data */</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fh</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">fh</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">;</span>

	<span class="n">v4l2_prio_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_user</span><span class="o">++</span><span class="p">;</span>

	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_radio</span><span class="p">);</span>
	<span class="n">audio_input</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">TVAUDIO_INPUT_RADIO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa6588_command</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">v4l2_prio_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_user</span><span class="o">--</span><span class="p">;</span>

	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">,</span> <span class="n">SAA6588_CMD_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;bttv&quot;</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_TUNER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_ABSENT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>

	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">g_tuner</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">audio_mode_gpio</span><span class="p">)</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">audio_mode_gpio</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">);</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_TUNER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_g_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_tuner</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_s_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span>  <span class="n">V4L2_CID_BASE</span> <span class="o">||</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_LASTP1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">no_ctl</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">radio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa6588_command</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">block_count</span> <span class="o">=</span> <span class="n">count</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">,</span> <span class="n">SAA6588_CMD_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="p">.</span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">radio_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">btv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa6588_command</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">event_list</span> <span class="o">=</span> <span class="n">wait</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">bttv_call_all</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">,</span> <span class="n">SAA6588_CMD_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="p">.</span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">radio_fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	  <span class="o">=</span> <span class="n">radio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>     <span class="o">=</span> <span class="n">radio_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>  <span class="o">=</span> <span class="n">radio_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>     <span class="o">=</span> <span class="n">radio_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">radio_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>        <span class="o">=</span> <span class="n">radio_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>         <span class="o">=</span> <span class="n">radio_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>      <span class="o">=</span> <span class="n">radio_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audio</span>         <span class="o">=</span> <span class="n">radio_g_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>         <span class="o">=</span> <span class="n">radio_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audio</span>         <span class="o">=</span> <span class="n">radio_s_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>         <span class="o">=</span> <span class="n">radio_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span>           <span class="o">=</span> <span class="n">radio_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>       <span class="o">=</span> <span class="n">radio_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>         <span class="o">=</span> <span class="n">radio_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>          <span class="o">=</span> <span class="n">bttv_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>          <span class="o">=</span> <span class="n">bttv_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span>     <span class="o">=</span> <span class="n">bttv_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>     <span class="o">=</span> <span class="n">bttv_s_frequency</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">radio_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fops</span>      <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">radio_ioctl_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* some debug code                                                         */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_risc_decode</span><span class="p">(</span><span class="n">u32</span> <span class="n">risc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">instr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">BT848_RISC_WRITE</span>     <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;write&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_SKIP</span>      <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;skip&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_WRITEC</span>    <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;writec&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_JUMP</span>      <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;jump&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_SYNC</span>      <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;sync&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_WRITE123</span>  <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;write123&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_SKIP123</span>   <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;skip123&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_WRITE1S23</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;write1s23&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">incr</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">BT848_RISC_WRITE</span>     <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_JUMP</span>      <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_SYNC</span>      <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_WRITE123</span>  <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_SKIP123</span>   <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">BT848_RISC_WRITE1S23</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span> <span class="p">]</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;be0&quot;</span><span class="p">,</span>  <span class="s">&quot;be1&quot;</span><span class="p">,</span>  <span class="s">&quot;be2&quot;</span><span class="p">,</span>  <span class="s">&quot;be3/resync&quot;</span><span class="p">,</span>
		<span class="s">&quot;set0&quot;</span><span class="p">,</span> <span class="s">&quot;set1&quot;</span><span class="p">,</span> <span class="s">&quot;set2&quot;</span><span class="p">,</span> <span class="s">&quot;set3&quot;</span><span class="p">,</span>
		<span class="s">&quot;clr0&quot;</span><span class="p">,</span> <span class="s">&quot;clr1&quot;</span><span class="p">,</span> <span class="s">&quot;clr2&quot;</span><span class="p">,</span> <span class="s">&quot;clr3&quot;</span><span class="p">,</span>
		<span class="s">&quot;irq&quot;</span><span class="p">,</span>  <span class="s">&quot;res&quot;</span><span class="p">,</span>  <span class="s">&quot;eol&quot;</span><span class="p">,</span>  <span class="s">&quot;sol&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;0x%08x [ %s&quot;</span><span class="p">,</span> <span class="n">risc</span><span class="p">,</span>
	       <span class="n">instr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">?</span> <span class="n">instr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;INVALID&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">risc</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)))</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; count=%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">risc</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">incr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">?</span> <span class="n">incr</span><span class="p">[</span><span class="n">risc</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">]</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bttv_risc_disasm</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="n">n</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: risc disasm: %p [dma=0x%08lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:   0x%lx: &quot;</span><span class="p">,</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)));</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">bttv_risc_decode</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:   0x%lx: 0x%08x [ arg #%d ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">)),</span>
				<span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">],</span> <span class="n">j</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bttv_print_riscaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  main: %08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  vbi : o=%08llx e=%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span> <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">.</span><span class="n">dma</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span> <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">dma</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  cap : o=%08llx e=%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top</span>
		<span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">.</span><span class="n">dma</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">bottom</span>
		<span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">dma</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;  scr : o=%08llx e=%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">.</span><span class="n">dma</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span> <span class="o">?</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">.</span><span class="n">dma</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">bttv_risc_disasm</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* irq handler                                                             */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">irq_name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;FMTCHG&quot;</span><span class="p">,</span>  <span class="c1">// format change detected (525 vs. 625)</span>
	<span class="s">&quot;VSYNC&quot;</span><span class="p">,</span>   <span class="c1">// vertical sync (new field)</span>
	<span class="s">&quot;HSYNC&quot;</span><span class="p">,</span>   <span class="c1">// horizontal sync</span>
	<span class="s">&quot;OFLOW&quot;</span><span class="p">,</span>   <span class="c1">// chroma/luma AGC overflow</span>
	<span class="s">&quot;HLOCK&quot;</span><span class="p">,</span>   <span class="c1">// horizontal lock changed</span>
	<span class="s">&quot;VPRES&quot;</span><span class="p">,</span>   <span class="c1">// video presence changed</span>
	<span class="s">&quot;6&quot;</span><span class="p">,</span> <span class="s">&quot;7&quot;</span><span class="p">,</span>
	<span class="s">&quot;I2CDONE&quot;</span><span class="p">,</span> <span class="c1">// hw irc operation finished</span>
	<span class="s">&quot;GPINT&quot;</span><span class="p">,</span>   <span class="c1">// gpio port triggered irq</span>
	<span class="s">&quot;10&quot;</span><span class="p">,</span>
	<span class="s">&quot;RISCI&quot;</span><span class="p">,</span>   <span class="c1">// risc instruction triggered irq</span>
	<span class="s">&quot;FBUS&quot;</span><span class="p">,</span>    <span class="c1">// pixel data fifo dropped data (high pci bus latencies)</span>
	<span class="s">&quot;FTRGT&quot;</span><span class="p">,</span>   <span class="c1">// pixel data fifo overrun</span>
	<span class="s">&quot;FDSR&quot;</span><span class="p">,</span>    <span class="c1">// fifo data stream resyncronisation</span>
	<span class="s">&quot;PPERR&quot;</span><span class="p">,</span>   <span class="c1">// parity error (data transfer)</span>
	<span class="s">&quot;RIPERR&quot;</span><span class="p">,</span>  <span class="c1">// parity error (read risc instructions)</span>
	<span class="s">&quot;PABORT&quot;</span><span class="p">,</span>  <span class="c1">// pci abort</span>
	<span class="s">&quot;OCERR&quot;</span><span class="p">,</span>   <span class="c1">// risc instruction error</span>
	<span class="s">&quot;SCERR&quot;</span><span class="p">,</span>   <span class="c1">// syncronisation error</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bttv_print_irqbits</span><span class="p">(</span><span class="n">u32</span> <span class="n">print</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mark</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;bits:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">irq_name</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">print</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">irq_name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mark</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;*&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bttv_irq_debug_low_latency</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%d: irq: skipped frame [main=%lx,o_vbi=%lx,o_field=%lx,rc=%lx]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="n">RISC_SLOT_O_VBI</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">.</span><span class="n">cpu</span><span class="p">[</span><span class="n">RISC_SLOT_O_FIELD</span><span class="o">+</span><span class="mi">1</span><span class="p">]),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">btread</span><span class="p">(</span><span class="n">BT848_DSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">BT848_DSTATUS_HLOC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%d: Oh, there (temporarily?) is no input signal. &quot;</span>
			  <span class="s">&quot;Ok, then this is harmless, don&#39;t worry ;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%d: Uhm. Looks like we have unusual high IRQ latencies</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%d: Lets try to catch the culpit red-handed ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">dump_stack</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">bttv_irq_next_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer_set</span> <span class="o">*</span><span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">set</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">set</span><span class="p">));</span>

	<span class="cm">/* capture request ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set</span><span class="o">-&gt;</span><span class="n">frame_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_HAS_TOP</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">))</span>
			<span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span>    <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_HAS_BOTTOM</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">))</span>
			<span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>

		<span class="cm">/* capture request for other field ? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">item</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
			<span class="cm">/* Mike Isely &lt;isely@pobox.com&gt; - Only check</span>
<span class="cm">			 * and set up the bottom field in the logic</span>
<span class="cm">			 * below.  Don&#39;t ever do the top field.  This</span>
<span class="cm">			 * of course means that if we set up the</span>
<span class="cm">			 * bottom field in the above code that we&#39;ll</span>
<span class="cm">			 * actually skip a field.  But that&#39;s OK.</span>
<span class="cm">			 * Having processed only a single buffer this</span>
<span class="cm">			 * time, then the next time around the first</span>
<span class="cm">			 * available buffer should be for a top field.</span>
<span class="cm">			 * That will then cause us here to set up a</span>
<span class="cm">			 * top then a bottom field in the normal way.</span>
<span class="cm">			 * The alternative to this understanding is</span>
<span class="cm">			 * that we set up the second available buffer</span>
<span class="cm">			 * as a top field, but that&#39;s out of order</span>
<span class="cm">			 * since this driver always processes the top</span>
<span class="cm">			 * field first - the effect will be the two</span>
<span class="cm">			 * buffers being returned in the wrong order,</span>
<span class="cm">			 * with the second buffer also being delayed</span>
<span class="cm">			 * by one field time (owing to the fifo nature</span>
<span class="cm">			 * of videobuf).  Worse still, we&#39;ll be stuck</span>
<span class="cm">			 * doing fields out of order now every time</span>
<span class="cm">			 * until something else causes a field to be</span>
<span class="cm">			 * dropped.  By effectively forcing a field to</span>
<span class="cm">			 * drop this way then we always get back into</span>
<span class="cm">			 * sync within a single frame time.  (Out of</span>
<span class="cm">			 * order fields can screw up deinterlacing</span>
<span class="cm">			 * algorithms.) */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">&amp;&amp;</span>
				    <span class="n">V4L2_FIELD_BOTTOM</span> <span class="o">==</span> <span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">item</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span>  <span class="o">&amp;&amp;</span>  <span class="nb">NULL</span> <span class="o">!=</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span>
					<span class="n">set</span><span class="o">-&gt;</span><span class="n">top_irq</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* screen overlay ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&amp;&amp;</span> <span class="nb">NULL</span> <span class="o">==</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span>    <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">;</span>
				<span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_TOP</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span> <span class="o">&amp;&amp;</span>
			    <span class="nb">NULL</span> <span class="o">==</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_BOTTOM</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span> <span class="o">&amp;&amp;</span>
			    <span class="nb">NULL</span> <span class="o">==</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: next set: top=%p bottom=%p [screen=%p,irq=%d,%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">screen</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">frame_irq</span><span class="p">,</span> <span class="n">set</span><span class="o">-&gt;</span><span class="n">top_irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_irq_wakeup_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer_set</span> <span class="o">*</span><span class="n">wakeup</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">bttv_buffer_set</span> <span class="o">*</span><span class="n">curr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">ts</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">==</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&amp;&amp;</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">!=</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%d: wakeup: both=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
			<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
			<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field_count</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="p">;</span>
			<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&amp;&amp;</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">!=</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%d: wakeup: top=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
			<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
			<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field_count</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="p">;</span>
			<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">&amp;&amp;</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">bottom</span> <span class="o">!=</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%d: wakeup: bottom=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">);</span>
			<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
			<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field_count</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="p">;</span>
			<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_irq_wakeup_vbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">wakeup</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">ts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">wakeup</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ts</span><span class="p">;</span>
	<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field_count</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="p">;</span>
	<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bttv_irq_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_buffer_set</span> <span class="n">old</span><span class="p">,</span><span class="n">new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">ovbi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">item</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_verbose</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: timeout: drop=%d irq=%d/%d, risc=%08x, &quot;</span><span class="p">,</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">framedrop</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">irq_me</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">irq_total</span><span class="p">,</span>
			<span class="n">btread</span><span class="p">(</span><span class="n">BT848_RISC_COUNT</span><span class="p">));</span>
		<span class="n">bttv_print_irqbits</span><span class="p">(</span><span class="n">btread</span><span class="p">(</span><span class="n">BT848_INT_STAT</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* deactivate stuff */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">new</span><span class="p">));</span>
	<span class="n">old</span>  <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">;</span>
	<span class="n">ovbi</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bttv_buffer_activate_video</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">);</span>
	<span class="n">bttv_buffer_activate_vbi</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span>   <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">bttv_set_dma</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* wake up */</span>
	<span class="n">bttv_irq_wakeup_video</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="n">VIDEOBUF_ERROR</span><span class="p">);</span>
	<span class="n">bttv_irq_wakeup_vbi</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">ovbi</span><span class="p">,</span> <span class="n">VIDEOBUF_ERROR</span><span class="p">);</span>

	<span class="cm">/* cancel all outstanding capture / vbi requests */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ERROR</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vcapture</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">item</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vcapture</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ERROR</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">item</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_irq_wakeup_top</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">wakeup</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">wakeup</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bttv_risc_hook</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">RISC_SLOT_O_FIELD</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field_count</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="p">;</span>
	<span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wakeup</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">btcx_riscmem</span> <span class="o">*</span><span class="n">risc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&gt;</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">+</span> <span class="n">risc</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_irq_switch_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_buffer_set</span> <span class="n">new</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_buffer_set</span> <span class="n">old</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">);</span>

	<span class="cm">/* new buffer set */</span>
	<span class="n">bttv_irq_next_video</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_RISC_COUNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top</span>    <span class="o">&amp;&amp;</span> <span class="n">is_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">top</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>       <span class="n">rc</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">bottom</span> <span class="o">&amp;&amp;</span> <span class="n">is_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">.</span><span class="n">bottom</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span> <span class="n">rc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">framedrop</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug_latency</span><span class="p">)</span>
			<span class="n">bttv_irq_debug_low_latency</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* switch over */</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">bttv_buffer_activate_video</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">);</span>
	<span class="n">bttv_set_dma</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* switch input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">new_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">video_mux</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">new_input</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">new_input</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wake up finished buffers */</span>
	<span class="n">bttv_irq_wakeup_video</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new</span><span class="p">,</span> <span class="n">VIDEOBUF_DONE</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">bttv_irq_switch_vbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv_buffer</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vcapture</span><span class="p">))</span>
		<span class="n">new</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vcapture</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bttv_buffer</span><span class="p">,</span> <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">old</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_RISC_COUNT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">old</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">is_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span>    <span class="n">rc</span><span class="p">)</span> <span class="o">||</span>
			    <span class="n">is_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old</span><span class="o">-&gt;</span><span class="n">bottom</span><span class="p">,</span> <span class="n">rc</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">framedrop</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug_latency</span><span class="p">)</span>
			<span class="n">bttv_irq_debug_low_latency</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* switch */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">4</span><span class="p">;</span>
	<span class="n">bttv_buffer_activate_vbi</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="n">bttv_set_dma</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">bttv_irq_wakeup_vbi</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">old</span><span class="p">,</span> <span class="n">VIDEOBUF_DONE</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">bttv_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">,</span><span class="n">astat</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dstat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">btv</span><span class="o">=</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>

	<span class="n">count</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get/clear interrupt status bits */</span>
		<span class="n">stat</span><span class="o">=</span><span class="n">btread</span><span class="p">(</span><span class="n">BT848_INT_STAT</span><span class="p">);</span>
		<span class="n">astat</span><span class="o">=</span><span class="n">stat</span><span class="o">&amp;</span><span class="n">btread</span><span class="p">(</span><span class="n">BT848_INT_MASK</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">astat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">btwrite</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span><span class="n">BT848_INT_STAT</span><span class="p">);</span>

		<span class="cm">/* get device status bits */</span>
		<span class="n">dstat</span><span class="o">=</span><span class="n">btread</span><span class="p">(</span><span class="n">BT848_DSTATUS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irq_debug</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%d: irq loop=%d fc=%d riscs=%x, riscc=%08x, &quot;</span><span class="p">,</span>
				 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="p">,</span>
				 <span class="n">stat</span><span class="o">&gt;&gt;</span><span class="mi">28</span><span class="p">,</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_RISC_COUNT</span><span class="p">));</span>
			<span class="n">bttv_print_irqbits</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span><span class="n">astat</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_HLOCK</span><span class="p">)</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;   HLOC =&gt; %s&quot;</span><span class="p">,</span>
					<span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">BT848_DSTATUS_HLOC</span>
					<span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_VPRES</span><span class="p">)</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;   PRES =&gt; %s&quot;</span><span class="p">,</span>
					<span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">BT848_DSTATUS_PRES</span>
					<span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_FMTCHG</span><span class="p">)</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;   NUML =&gt; %s&quot;</span><span class="p">,</span>
					<span class="n">dstat</span> <span class="o">&amp;</span> <span class="n">BT848_DSTATUS_NUML</span>
					<span class="o">?</span> <span class="s">&quot;625&quot;</span> <span class="o">:</span> <span class="s">&quot;525&quot;</span><span class="p">);</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">astat</span><span class="o">&amp;</span><span class="n">BT848_INT_VSYNC</span><span class="p">)</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_GPINT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bttv_input_irq</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_I2CDONE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">i2c_done</span> <span class="o">=</span> <span class="n">stat</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">i2c_queue</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_RISCI</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">4</span><span class="o">&lt;&lt;</span><span class="mi">28</span><span class="p">)))</span>
			<span class="n">bttv_irq_switch_vbi</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_RISCI</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">2</span><span class="o">&lt;&lt;</span><span class="mi">28</span><span class="p">)))</span>
			<span class="n">bttv_irq_wakeup_top</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_RISCI</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">28</span><span class="p">)))</span>
			<span class="n">bttv_irq_switch_video</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_HLOCK</span><span class="p">)</span>  <span class="o">&amp;&amp;</span>  <span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_automute</span><span class="p">)</span>
			<span class="n">audio_mute</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">mute</span><span class="p">);</span>  <span class="cm">/* trigger automute */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">BT848_INT_SCERR</span><span class="o">|</span><span class="n">BT848_INT_OCERR</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: %s%s @ %08x,&quot;</span><span class="p">,</span>
				<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span>
				<span class="p">(</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_SCERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SCERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_OCERR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;OCERR&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="n">btread</span><span class="p">(</span><span class="n">BT848_RISC_COUNT</span><span class="p">));</span>
			<span class="n">bttv_print_irqbits</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span><span class="n">astat</span><span class="p">);</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bttv_debug</span><span class="p">)</span>
				<span class="n">bttv_print_riscaddr</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fdsr</span> <span class="o">&amp;&amp;</span> <span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_FDSR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: FDSR @ %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_RISC_COUNT</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bttv_debug</span><span class="p">)</span>
				<span class="n">bttv_print_riscaddr</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">astat</span> <span class="o">&amp;</span> <span class="n">BT848_INT_GPINT</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BT848_INT_MASK</span><span class="p">);</span>

				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%d: IRQ lockup, cleared int mask [&quot;</span><span class="p">,</span>
				       <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%d: IRQ lockup, clearing GPINT from int mask [&quot;</span><span class="p">,</span>
				       <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>

				<span class="n">btwrite</span><span class="p">(</span><span class="n">btread</span><span class="p">(</span><span class="n">BT848_INT_MASK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">^</span> <span class="n">BT848_INT_GPINT</span><span class="p">),</span>
						<span class="n">BT848_INT_MASK</span><span class="p">);</span>
			<span class="p">};</span>

			<span class="n">bttv_print_irqbits</span><span class="p">(</span><span class="n">stat</span><span class="p">,</span><span class="n">astat</span><span class="p">);</span>

			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">irq_total</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handled</span><span class="p">)</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">irq_me</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* initialitation                                                          */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="nf">vdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">,</span>
				      <span class="k">const</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">template</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span><span class="p">;</span>

	<span class="n">vfd</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">vfd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">vfd</span> <span class="o">=</span> <span class="o">*</span><span class="n">template</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">debug</span>   <span class="o">=</span> <span class="n">bttv_debug</span><span class="p">;</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vfd</span><span class="p">,</span> <span class="n">btv</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;BT%d%s %s (%s)&quot;</span><span class="p">,</span>
		 <span class="n">btv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">id</span><span class="o">==</span><span class="mi">848</span> <span class="o">&amp;&amp;</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="o">==</span><span class="mh">0x12</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;A&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		 <span class="n">type_name</span><span class="p">,</span> <span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vfd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bttv_unregister_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">))</span>
			<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">))</span>
			<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">))</span>
			<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* register video4linux devices */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bttv_register_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">no_overlay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;Overlay support disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* video */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="n">vdev_init</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bttv_video_template</span><span class="p">,</span> <span class="s">&quot;video&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span>
				  <span class="n">video_nr</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: registered device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="o">&amp;</span><span class="n">dev_attr_card</span><span class="p">)</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%d: device_create_file &#39;card&#39; failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* vbi */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_dev</span> <span class="o">=</span> <span class="n">vdev_init</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bttv_video_template</span><span class="p">,</span> <span class="s">&quot;vbi&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">,</span> <span class="n">VFL_TYPE_VBI</span><span class="p">,</span>
				  <span class="n">vbi_nr</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: registered device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">has_radio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* radio */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span> <span class="o">=</span> <span class="n">vdev_init</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">radio_template</span><span class="p">,</span> <span class="s">&quot;radio&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">,</span> <span class="n">VFL_TYPE_RADIO</span><span class="p">,</span>
				  <span class="n">radio_nr</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: registered device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">));</span>

	<span class="cm">/* all done */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err:</span>
	<span class="n">bttv_unregister_video</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* on OpenFirmware machines (PowerMac at least), PCI memory cycle */</span>
<span class="cm">/* response on cards with no firmware is not enabled by OF */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pci_set_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(__powerpc__)</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">|</span> <span class="n">PCI_COMMAND_MEMORY</span> <span class="p">);</span>
	<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bttv_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">lat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_num</span> <span class="o">==</span> <span class="n">BTTV_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Bt8xx card found (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bttv_num</span><span class="p">);</span>
	<span class="n">bttvs</span><span class="p">[</span><span class="n">bttv_num</span><span class="p">]</span> <span class="o">=</span> <span class="n">btv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">btv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span>  <span class="o">=</span> <span class="n">bttv_num</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">),</span>
			<span class="s">&quot;bttv%d&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>

	<span class="cm">/* initialize structs / fill in defaults */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">gpio_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">i2c_queue</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">subs</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">vcapture</span><span class="p">);</span>
	<span class="n">v4l2_prio_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">bttv_irq_timeout</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">data</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">btv</span><span class="p">;</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">i2c_rc</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">tuner_type</span>  <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">new_input</span>   <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">has_radio</span><span class="o">=</span><span class="n">radio</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">];</span>

	<span class="cm">/* pci stuff (init, get irq/mmio, ... */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">id</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%d: Can&#39;t enable device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%d: No suitable DMA available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
				<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%d: can&#39;t request iomem (0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_command</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%d: v4l2_device_register() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lat</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: Bt%d (rev %d) at %s, irq: %d, latency: %d, mmio: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bttv_num</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lat</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">schedule</span><span class="p">();</span>

	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">bt848_mmio</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="mh">0x1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">bt848_mmio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%d: ioremap() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* identify card */</span>
	<span class="n">bttv_idcard</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="cm">/* disable irqs, register irq handler */</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BT848_INT_MASK</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">bttv_irq</span><span class="p">,</span>
	    <span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">btv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%d: can&#39;t get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bttv_num</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">bttv_handle_chipset</span><span class="p">(</span><span class="n">btv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init options from insmod args */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_combfilter</span> <span class="o">=</span> <span class="n">combfilter</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_lumafilter</span> <span class="o">=</span> <span class="n">lumafilter</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_automute</span>   <span class="o">=</span> <span class="n">automute</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_chroma_agc</span> <span class="o">=</span> <span class="n">chroma_agc</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_adc_crush</span>  <span class="o">=</span> <span class="n">adc_crush</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_vcr_hack</span>   <span class="o">=</span> <span class="n">vcr_hack</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_whitecrush_upper</span>  <span class="o">=</span> <span class="n">whitecrush_upper</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_whitecrush_lower</span>  <span class="o">=</span> <span class="n">whitecrush_lower</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_uv_ratio</span>   <span class="o">=</span> <span class="n">uv_ratio</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_full_luma_range</span>   <span class="o">=</span> <span class="n">full_luma_range</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">opt_coring</span>     <span class="o">=</span> <span class="n">coring</span><span class="p">;</span>

	<span class="cm">/* fill struct bttv with some useful defaults */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">btv</span>         <span class="o">=</span> <span class="n">btv</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">ov</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">fmt</span>         <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">V4L2_PIX_FMT_BGR24</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">width</span>       <span class="o">=</span> <span class="mi">320</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">.</span><span class="n">height</span>      <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* initialize hardware */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_gpio</span><span class="p">)</span>
		<span class="n">bttv_gpio_tracking</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="s">&quot;pre-init&quot;</span><span class="p">);</span>

	<span class="n">bttv_risc_init_main</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="n">init_bt848</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="cm">/* gpio */</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">BT848_GPIO_REG_INP</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">BT848_GPIO_OUT_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_verbose</span><span class="p">)</span>
		<span class="n">bttv_gpio_tracking</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="s">&quot;init&quot;</span><span class="p">);</span>

	<span class="cm">/* needs to be done before i2c is registered */</span>
	<span class="n">bttv_init_card1</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="cm">/* register i2c + gpio */</span>
	<span class="n">init_bttv_i2c</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="cm">/* some card-specific stuff (needs working i2c) */</span>
	<span class="n">bttv_init_card2</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="n">bttv_init_tuner</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="n">init_irqreg</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="cm">/* register video4linux + input */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">no_video</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bttv_register_video</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
		<span class="n">bt848_bright</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="mi">32768</span><span class="p">);</span>
		<span class="n">bt848_contrast</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mi">27648</span><span class="p">);</span>
		<span class="n">bt848_hue</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="mi">32768</span><span class="p">);</span>
		<span class="n">bt848_sat</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="mi">32768</span><span class="p">);</span>
		<span class="n">audio_mute</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">set_input</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>
		<span class="n">bttv_crop_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* current = default */</span>
		<span class="n">disclaim_vbi_lines</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
		<span class="n">disclaim_video_lines</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* add subdevices and autoload dvb-bt8xx if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">has_dvb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bttv_sub_add_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="s">&quot;dvb&quot;</span><span class="p">);</span>
		<span class="n">request_modules</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">disable_ir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">init_bttv_i2c_ir</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
		<span class="n">bttv_input_init</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* everything is fine */</span>
	<span class="n">bttv_num</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">btv</span><span class="p">);</span>

<span class="nl">fail1:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>

<span class="nl">fail0:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">bt848_mmio</span><span class="p">)</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">bt848_mmio</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">bttv_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">to_bttv</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_verbose</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%d: unloading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_tvcards</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">type</span><span class="p">].</span><span class="n">has_dvb</span><span class="p">)</span>
		<span class="n">flush_request_modules</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="cm">/* shutdown everything (DMA+IRQs) */</span>
	<span class="n">btand</span><span class="p">(</span><span class="o">~</span><span class="mi">15</span><span class="p">,</span> <span class="n">BT848_GPIO_DMA_CTL</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BT848_INT_MASK</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="o">~</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">BT848_INT_STAT</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">BT848_GPIO_OUT_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_gpio</span><span class="p">)</span>
		<span class="n">bttv_gpio_tracking</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span><span class="s">&quot;cleanup&quot;</span><span class="p">);</span>

	<span class="cm">/* tell gpio modules we are leaving ... */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">shutdown</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">bttv_input_fini</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="n">bttv_sub_del_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">);</span>

	<span class="cm">/* unregister i2c_bus + input */</span>
	<span class="n">fini_bttv_i2c</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="cm">/* unregister video4linux */</span>
	<span class="n">bttv_unregister_video</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="cm">/* free allocated memory */</span>
	<span class="n">btcx_riscmem_free</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">);</span>

	<span class="cm">/* free ressources */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span><span class="n">btv</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">bt848_mmio</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">pci</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">bttvs</span><span class="p">[</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">to_bttv</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv_buffer_set</span> <span class="n">idle</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: suspend %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">,</span> <span class="n">state</span><span class="p">.</span><span class="n">event</span><span class="p">);</span>

	<span class="cm">/* stop dma + irqs */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">idle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idle</span><span class="p">));</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">vbi</span>   <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">loop_irq</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bttv_buffer_activate_video</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">idle</span><span class="p">);</span>
	<span class="n">bttv_buffer_activate_vbi</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">bttv_set_dma</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">btwrite</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">BT848_INT_MASK</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* save bt878 state */</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">gpio_enable</span> <span class="o">=</span> <span class="n">btread</span><span class="p">(</span><span class="n">BT848_GPIO_OUT_EN</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">gpio_data</span>   <span class="o">=</span> <span class="n">gpio_read</span><span class="p">();</span>

	<span class="cm">/* save pci state */</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">state</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bttv_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bttv</span> <span class="o">*</span><span class="n">btv</span> <span class="o">=</span> <span class="n">to_bttv</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%d: resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>

	<span class="cm">/* restore pci state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span><span class="o">=</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%d: Can&#39;t enable device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span><span class="o">=</span><span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%d: Can&#39;t enable device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">nr</span><span class="p">);</span>
		<span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="cm">/* restore bt878 state */</span>
	<span class="n">bttv_reinit_bt848</span><span class="p">(</span><span class="n">btv</span><span class="p">);</span>
	<span class="n">gpio_inout</span><span class="p">(</span><span class="mh">0xffffff</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">gpio_enable</span><span class="p">);</span>
	<span class="n">gpio_write</span><span class="p">(</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">gpio_data</span><span class="p">);</span>

	<span class="cm">/* restart dma */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">video</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">vbi</span><span class="p">;</span>
	<span class="n">btv</span><span class="o">-&gt;</span><span class="n">loop_irq</span> <span class="o">=</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">loop_irq</span><span class="p">;</span>
	<span class="n">bttv_buffer_activate_video</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">);</span>
	<span class="n">bttv_buffer_activate_vbi</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="n">btv</span><span class="o">-&gt;</span><span class="n">cvbi</span><span class="p">);</span>
	<span class="n">bttv_set_dma</span><span class="p">(</span><span class="n">btv</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">btv</span><span class="o">-&gt;</span><span class="n">s_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">bttv_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROOKTREE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BT848</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROOKTREE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BT849</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROOKTREE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BT878</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROOKTREE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_BT879</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">BROOKTREE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FUSION879</span><span class="p">),</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">bttv_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">bttv_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;bttv&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">bttv_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">bttv_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">bttv_remove</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">bttv_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">bttv_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">bttv_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">bttv_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;driver version %s loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BTTV_VERSION</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gbuffers</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">gbuffers</span> <span class="o">&gt;</span> <span class="n">VIDEO_MAX_FRAME</span><span class="p">)</span>
		<span class="n">gbuffers</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gbufsize</span> <span class="o">&gt;</span> <span class="n">BTTV_MAX_FBUF</span><span class="p">)</span>
		<span class="n">gbufsize</span> <span class="o">=</span> <span class="n">BTTV_MAX_FBUF</span><span class="p">;</span>
	<span class="n">gbufsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">gbufsize</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bttv_verbose</span><span class="p">)</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;using %d buffers with %dk (%d pages) each for capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">gbuffers</span><span class="p">,</span> <span class="n">gbufsize</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span> <span class="n">gbufsize</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>

	<span class="n">bttv_check_chipset</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bttv_sub_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;bus_register error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bttv_pci_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bttv_sub_bus_type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">bttv_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bttv_pci_driver</span><span class="p">);</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bttv_sub_bus_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">bttv_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">bttv_cleanup_module</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
