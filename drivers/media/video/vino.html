<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › vino.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>vino.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for the VINO (Video In No Out) system found in SGI Indys.</span>
<span class="cm"> *</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2004,2005 Mikael Nousiainen &lt;tmnousia@cc.hut.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on the previous version of the driver for 2.4 kernels by:</span>
<span class="cm"> * Copyright (C) 2003 Ladislav Michl &lt;ladis@linux-mips.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * v4l2_device/v4l2_subdev conversion by:</span>
<span class="cm"> * Copyright (C) 2009 Hans Verkuil &lt;hverkuil@xs4all.nl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Note: this conversion is untested! Please contact the linux-media</span>
<span class="cm"> * mailinglist if you can test this, together with the test results.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * TODO:</span>
<span class="cm"> * - remove &quot;mark pages reserved-hacks&quot; from memory allocation code</span>
<span class="cm"> *   and implement fault()</span>
<span class="cm"> * - check decimation, calculating and reporting image size when</span>
<span class="cm"> *   using decimation</span>
<span class="cm"> * - implement read(), user mode buffers and overlay (?)</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>

<span class="cp">#include &lt;linux/i2c.h&gt;</span>

<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;asm/paccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/sgi/ip22.h&gt;</span>
<span class="cp">#include &lt;asm/sgi/mc.h&gt;</span>

<span class="cp">#include &quot;vino.h&quot;</span>
<span class="cp">#include &quot;saa7191.h&quot;</span>
<span class="cp">#include &quot;indycam.h&quot;</span>

<span class="cm">/* Uncomment the following line to get lots and lots of (mostly useless)</span>
<span class="cm"> * debug info.</span>
<span class="cm"> * Note that the debug output also slows down the driver significantly */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define VINO_DEBUG</h1>

<h1>define VINO<em>DEBUG</em>INT</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define VINO_MODULE_VERSION &quot;0.0.7&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SGI VINO Video4Linux2 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">VINO_MODULE_VERSION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Mikael Nousiainen &lt;tmnousia@cc.hut.fi&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#ifdef VINO_DEBUG</span>
<span class="cp">#define dprintk(x...) printk(&quot;VINO: &quot; x);</span>
<span class="cp">#else</span>
<span class="cp">#define dprintk(x...)</span>
<span class="cp">#endif</span>

<span class="cp">#define VINO_NO_CHANNEL			0</span>
<span class="cp">#define VINO_CHANNEL_A			1</span>
<span class="cp">#define VINO_CHANNEL_B			2</span>

<span class="cp">#define VINO_PAL_WIDTH			768</span>
<span class="cp">#define VINO_PAL_HEIGHT			576</span>
<span class="cp">#define VINO_NTSC_WIDTH			640</span>
<span class="cp">#define VINO_NTSC_HEIGHT		480</span>

<span class="cp">#define VINO_MIN_WIDTH			32</span>
<span class="cp">#define VINO_MIN_HEIGHT			32</span>

<span class="cp">#define VINO_CLIPPING_START_ODD_D1	1</span>
<span class="cp">#define VINO_CLIPPING_START_ODD_PAL	15</span>
<span class="cp">#define VINO_CLIPPING_START_ODD_NTSC	12</span>

<span class="cp">#define VINO_CLIPPING_START_EVEN_D1	2</span>
<span class="cp">#define VINO_CLIPPING_START_EVEN_PAL	15</span>
<span class="cp">#define VINO_CLIPPING_START_EVEN_NTSC	12</span>

<span class="cp">#define VINO_INPUT_CHANNEL_COUNT	3</span>

<span class="cm">/* the number is the index for vino_inputs */</span>
<span class="cp">#define VINO_INPUT_NONE			-1</span>
<span class="cp">#define VINO_INPUT_COMPOSITE		0</span>
<span class="cp">#define VINO_INPUT_SVIDEO		1</span>
<span class="cp">#define VINO_INPUT_D1			2</span>

<span class="cp">#define VINO_PAGE_RATIO			(PAGE_SIZE / VINO_PAGE_SIZE)</span>

<span class="cp">#define VINO_FIFO_THRESHOLD_DEFAULT	16</span>

<span class="cp">#define VINO_FRAMEBUFFER_SIZE		((VINO_PAL_WIDTH \</span>
<span class="cp">					  * VINO_PAL_HEIGHT * 4 \</span>
<span class="cp">					  + 3 * PAGE_SIZE) &amp; ~(PAGE_SIZE - 1))</span>

<span class="cp">#define VINO_FRAMEBUFFER_COUNT_MAX	8</span>

<span class="cp">#define VINO_FRAMEBUFFER_UNUSED		0</span>
<span class="cp">#define VINO_FRAMEBUFFER_IN_USE		1</span>
<span class="cp">#define VINO_FRAMEBUFFER_READY		2</span>

<span class="cp">#define VINO_QUEUE_ERROR		-1</span>
<span class="cp">#define VINO_QUEUE_MAGIC		0x20050125</span>

<span class="cp">#define VINO_MEMORY_NONE		0</span>
<span class="cp">#define VINO_MEMORY_MMAP		1</span>
<span class="cp">#define VINO_MEMORY_USERPTR		2</span>

<span class="cp">#define VINO_DUMMY_DESC_COUNT		4</span>
<span class="cp">#define VINO_DESC_FETCH_DELAY		5	</span><span class="cm">/* microseconds */</span><span class="cp"></span>

<span class="cp">#define VINO_MAX_FRAME_SKIP_COUNT	128</span>

<span class="cm">/* the number is the index for vino_data_formats */</span>
<span class="cp">#define VINO_DATA_FMT_NONE		-1</span>
<span class="cp">#define VINO_DATA_FMT_GREY		0</span>
<span class="cp">#define VINO_DATA_FMT_RGB332		1</span>
<span class="cp">#define VINO_DATA_FMT_RGB32		2</span>
<span class="cp">#define VINO_DATA_FMT_YUV		3</span>

<span class="cp">#define VINO_DATA_FMT_COUNT		4</span>

<span class="cm">/* the number is the index for vino_data_norms */</span>
<span class="cp">#define VINO_DATA_NORM_NONE		-1</span>
<span class="cp">#define VINO_DATA_NORM_NTSC		0</span>
<span class="cp">#define VINO_DATA_NORM_PAL		1</span>
<span class="cp">#define VINO_DATA_NORM_SECAM		2</span>
<span class="cp">#define VINO_DATA_NORM_D1		3</span>

<span class="cp">#define VINO_DATA_NORM_COUNT		4</span>

<span class="cm">/* I2C controller flags */</span>
<span class="cp">#define SGI_I2C_FORCE_IDLE		(0 &lt;&lt; 0)</span>
<span class="cp">#define SGI_I2C_NOT_IDLE		(1 &lt;&lt; 0)</span>
<span class="cp">#define SGI_I2C_WRITE			(0 &lt;&lt; 1)</span>
<span class="cp">#define SGI_I2C_READ			(1 &lt;&lt; 1)</span>
<span class="cp">#define SGI_I2C_RELEASE_BUS		(0 &lt;&lt; 2)</span>
<span class="cp">#define SGI_I2C_HOLD_BUS		(1 &lt;&lt; 2)</span>
<span class="cp">#define SGI_I2C_XFER_DONE		(0 &lt;&lt; 4)</span>
<span class="cp">#define SGI_I2C_XFER_BUSY		(1 &lt;&lt; 4)</span>
<span class="cp">#define SGI_I2C_ACK			(0 &lt;&lt; 5)</span>
<span class="cp">#define SGI_I2C_NACK			(1 &lt;&lt; 5)</span>
<span class="cp">#define SGI_I2C_BUS_OK			(0 &lt;&lt; 7)</span>
<span class="cp">#define SGI_I2C_BUS_ERR			(1 &lt;&lt; 7)</span>

<span class="cm">/* Internal data structure definitions */</span>

<span class="k">struct</span> <span class="n">vino_input</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_clipping</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">top</span><span class="p">,</span> <span class="n">bottom</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_data_format</span> <span class="p">{</span>
	<span class="cm">/* the description */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">description</span><span class="p">;</span>
	<span class="cm">/* bytes per pixel */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpp</span><span class="p">;</span>
	<span class="cm">/* V4L2 fourcc code */</span>
	<span class="n">__u32</span> <span class="n">pixelformat</span><span class="p">;</span>
	<span class="cm">/* V4L2 colorspace (duh!) */</span>
	<span class="k">enum</span> <span class="n">v4l2_colorspace</span> <span class="n">colorspace</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_data_norm</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">description</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vino_clipping</span> <span class="n">odd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vino_clipping</span> <span class="n">even</span><span class="p">;</span>

	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fps_min</span><span class="p">,</span> <span class="n">fps_max</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">framelines</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_descriptor_table</span> <span class="p">{</span>
	<span class="cm">/* the number of PAGE_SIZE sized pages in the buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page_count</span><span class="p">;</span>
	<span class="cm">/* virtual (kmalloc&#39;d) pointers to the actual data</span>
<span class="cm">	 * (in PAGE_SIZE chunks, used with mmap streaming) */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="k">virtual</span><span class="p">;</span>

	<span class="cm">/* cpu address for the VINO descriptor table</span>
<span class="cm">	 * (contains DMA addresses, VINO_PAGE_SIZE chunks) */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">dma_cpu</span><span class="p">;</span>
	<span class="cm">/* dma address for the VINO descriptor table</span>
<span class="cm">	 * (contains DMA addresses, VINO_PAGE_SIZE chunks) */</span>
	<span class="n">dma_addr_t</span> <span class="n">dma</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="p">{</span>
	<span class="cm">/* identifier nubmer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="cm">/* the length of the whole buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="cm">/* the length of actual data in buffer */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="cm">/* the data format */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_format</span><span class="p">;</span>
	<span class="cm">/* the state of buffer data */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="cm">/* is the buffer mapped in user space? */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">map_count</span><span class="p">;</span>
	<span class="cm">/* memory offset for mmap() */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="cm">/* frame counter */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_counter</span><span class="p">;</span>
	<span class="cm">/* timestamp (written when image capture finishes) */</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">timestamp</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vino_descriptor_table</span> <span class="n">desc_table</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">state_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">used</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">head</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tail</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">[</span><span class="n">VINO_FRAMEBUFFER_COUNT_MAX</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">magic</span><span class="p">;</span>

	<span class="cm">/* VINO_MEMORY_NONE, VINO_MEMORY_MMAP or VINO_MEMORY_USERPTR */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>

	<span class="cm">/* data field of in and out contain index numbers for buffer */</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span> <span class="n">in</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">[</span><span class="n">VINO_FRAMEBUFFER_COUNT_MAX</span><span class="p">];</span>

	<span class="n">spinlock_t</span> <span class="n">queue_lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">queue_mutex</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">frame_wait_queue</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_interrupt_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">timeval</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_counter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skip_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skip</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">input</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_format</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_norm</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vino_clipping</span> <span class="n">clipping</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">decimation</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alpha</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fps</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">framert_reg</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fifo_threshold</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="n">fb_queue</span><span class="p">;</span>

	<span class="cm">/* number of the current field */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">field</span><span class="p">;</span>

	<span class="cm">/* read in progress */</span>
	<span class="kt">int</span> <span class="n">reading</span><span class="p">;</span>
	<span class="cm">/* streaming is active */</span>
	<span class="kt">int</span> <span class="n">streaming</span><span class="p">;</span>
	<span class="cm">/* the driver is currently processing the queue */</span>
	<span class="kt">int</span> <span class="n">capturing</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">capture_lock</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">users</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vino_interrupt_data</span> <span class="n">int_data</span><span class="p">;</span>

	<span class="cm">/* V4L support */</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">vino_settings</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="n">b</span><span class="p">;</span>

	<span class="cm">/* the channel which owns this client:</span>
<span class="cm">	 * VINO_NO_CHANNEL, VINO_CHANNEL_A or VINO_CHANNEL_B */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">decoder_owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">decoder</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">camera_owner</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">camera</span><span class="p">;</span>

	<span class="cm">/* a lock for vino register access */</span>
	<span class="n">spinlock_t</span> <span class="n">vino_lock</span><span class="p">;</span>
	<span class="cm">/* a lock for channel input changes */</span>
	<span class="n">spinlock_t</span> <span class="n">input_lock</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy_page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vino_descriptor_table</span> <span class="n">dummy_desc_table</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Module parameters */</span>

<span class="cm">/*</span>
<span class="cm"> * Using vino_pixel_conversion the ABGR32-format pixels supplied</span>
<span class="cm"> * by the VINO chip can be converted to more common formats</span>
<span class="cm"> * like RGBA32 (or probably RGB24 in the future). This way we</span>
<span class="cm"> * can give out data that can be specified correctly with</span>
<span class="cm"> * the V4L2-definitions.</span>
<span class="cm"> *</span>
<span class="cm"> * The pixel format is specified as RGBA32 when no conversion</span>
<span class="cm"> * is used.</span>
<span class="cm"> *</span>
<span class="cm"> * Note that this only affects the 32-bit bit depth.</span>
<span class="cm"> *</span>
<span class="cm"> * Use non-zero value to enable conversion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vino_pixel_conversion</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">pixelconv</span><span class="p">,</span> <span class="n">vino_pixel_conversion</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pixelconv</span><span class="p">,</span>
		 <span class="s">&quot;enable pixel conversion (non-zero value enables)&quot;</span><span class="p">);</span>

<span class="cm">/* Internal data structures */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sgi_vino</span> <span class="o">*</span><span class="n">vino</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vino_settings</span> <span class="o">*</span><span class="n">vino_drvdata</span><span class="p">;</span>

<span class="cp">#define camera_call(o, f, args...) \</span>
<span class="cp">	v4l2_subdev_call(vino_drvdata-&gt;camera, o, f, ##args)</span>
<span class="cp">#define decoder_call(o, f, args...) \</span>
<span class="cp">	v4l2_subdev_call(vino_drvdata-&gt;decoder, o, f, ##args)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vino_driver_name</span> <span class="o">=</span> <span class="s">&quot;vino&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vino_driver_description</span> <span class="o">=</span> <span class="s">&quot;SGI VINO&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vino_bus_name</span> <span class="o">=</span> <span class="s">&quot;GIO64 bus&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vino_vdev_name_a</span> <span class="o">=</span> <span class="s">&quot;SGI VINO Channel A&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">vino_vdev_name_b</span> <span class="o">=</span> <span class="s">&quot;SGI VINO Channel B&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">vino_capture_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">);</span>

<span class="n">DECLARE_TASKLET</span><span class="p">(</span><span class="n">vino_tasklet_a</span><span class="p">,</span> <span class="n">vino_capture_tasklet</span><span class="p">,</span> <span class="n">VINO_CHANNEL_A</span><span class="p">);</span>
<span class="n">DECLARE_TASKLET</span><span class="p">(</span><span class="n">vino_tasklet_b</span><span class="p">,</span> <span class="n">vino_capture_tasklet</span><span class="p">,</span> <span class="n">VINO_CHANNEL_B</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vino_input</span> <span class="n">vino_inputs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Composite&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>		<span class="o">=</span> <span class="n">V4L2_STD_NTSC</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL</span>
		<span class="o">|</span> <span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;S-Video&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>		<span class="o">=</span> <span class="n">V4L2_STD_NTSC</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL</span>
		<span class="o">|</span> <span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;D1/IndyCam&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>		<span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vino_data_format</span> <span class="n">vino_data_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="s">&quot;8-bit greyscale&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bpp</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixelformat</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_GREY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="s">&quot;8-bit dithered RGB 3-3-2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bpp</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixelformat</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB332</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="s">&quot;32-bit RGB&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bpp</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixelformat</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="s">&quot;YUV 4:2:2&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bpp</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pixelformat</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span> <span class="c1">// XXX: swapped?</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vino_data_norm</span> <span class="n">vino_data_norms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="s">&quot;NTSC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>		<span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fps_min</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fps_max</span>	<span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
		<span class="p">.</span><span class="n">framelines</span>	<span class="o">=</span> <span class="mi">525</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="n">VINO_NTSC_WIDTH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">VINO_NTSC_HEIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">odd</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_ODD_NTSC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">bottom</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_ODD_NTSC</span>
			<span class="o">+</span> <span class="n">VINO_NTSC_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">right</span>	<span class="o">=</span> <span class="n">VINO_NTSC_WIDTH</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">even</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_EVEN_NTSC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">bottom</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_EVEN_NTSC</span>
			<span class="o">+</span> <span class="n">VINO_NTSC_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">right</span>	<span class="o">=</span> <span class="n">VINO_NTSC_WIDTH</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="s">&quot;PAL&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>		<span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fps_min</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fps_max</span>	<span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
		<span class="p">.</span><span class="n">framelines</span>	<span class="o">=</span> <span class="mi">625</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="n">VINO_PAL_WIDTH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">VINO_PAL_HEIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">odd</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_ODD_PAL</span><span class="p">,</span>
			<span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">bottom</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_ODD_PAL</span>
			<span class="o">+</span> <span class="n">VINO_PAL_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">right</span>	<span class="o">=</span> <span class="n">VINO_PAL_WIDTH</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">even</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_EVEN_PAL</span><span class="p">,</span>
			<span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">bottom</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_EVEN_PAL</span>
			<span class="o">+</span> <span class="n">VINO_PAL_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">right</span>	<span class="o">=</span> <span class="n">VINO_PAL_WIDTH</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="s">&quot;SECAM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>		<span class="o">=</span> <span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fps_min</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fps_max</span>	<span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
		<span class="p">.</span><span class="n">framelines</span>	<span class="o">=</span> <span class="mi">625</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="n">VINO_PAL_WIDTH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">VINO_PAL_HEIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">odd</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_ODD_PAL</span><span class="p">,</span>
			<span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">bottom</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_ODD_PAL</span>
			<span class="o">+</span> <span class="n">VINO_PAL_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">right</span>	<span class="o">=</span> <span class="n">VINO_PAL_WIDTH</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">even</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_EVEN_PAL</span><span class="p">,</span>
			<span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">bottom</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_EVEN_PAL</span>
			<span class="o">+</span> <span class="n">VINO_PAL_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">right</span>	<span class="o">=</span> <span class="n">VINO_PAL_WIDTH</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">description</span>	<span class="o">=</span> <span class="s">&quot;NTSC/D1&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>		<span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fps_min</span>	<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fps_max</span>	<span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
		<span class="p">.</span><span class="n">framelines</span>	<span class="o">=</span> <span class="mi">525</span><span class="p">,</span>
		<span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="n">VINO_NTSC_WIDTH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">VINO_NTSC_HEIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">odd</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_ODD_D1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">bottom</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_ODD_D1</span>
			<span class="o">+</span> <span class="n">VINO_NTSC_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">right</span>	<span class="o">=</span> <span class="n">VINO_NTSC_WIDTH</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">.</span><span class="n">even</span>		<span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_EVEN_D1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">bottom</span>	<span class="o">=</span> <span class="n">VINO_CLIPPING_START_EVEN_D1</span>
			<span class="o">+</span> <span class="n">VINO_NTSC_HEIGHT</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
			<span class="p">.</span><span class="n">right</span>	<span class="o">=</span> <span class="n">VINO_NTSC_WIDTH</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define VINO_INDYCAM_V4L2_CONTROL_COUNT		9</span>

<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">vino_indycam_v4l2_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUTOGAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Automatic Gain Control&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">INDYCAM_AGC_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Automatic White Balance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">INDYCAM_AWB_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_GAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Gain&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">INDYCAM_GAIN_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">INDYCAM_GAIN_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">INDYCAM_GAIN_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">INDYCAM_CONTROL_RED_SATURATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Red Saturation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">INDYCAM_RED_SATURATION_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">INDYCAM_RED_SATURATION_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">INDYCAM_RED_SATURATION_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">INDYCAM_CONTROL_BLUE_SATURATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Blue Saturation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">INDYCAM_BLUE_SATURATION_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">INDYCAM_BLUE_SATURATION_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">INDYCAM_BLUE_SATURATION_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_RED_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Red Balance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">INDYCAM_RED_BALANCE_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">INDYCAM_RED_BALANCE_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">INDYCAM_RED_BALANCE_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_BLUE_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Blue Balance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">INDYCAM_BLUE_BALANCE_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">INDYCAM_BLUE_BALANCE_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">INDYCAM_BLUE_BALANCE_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_EXPOSURE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Shutter Control&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">INDYCAM_SHUTTER_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">INDYCAM_SHUTTER_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">INDYCAM_SHUTTER_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_GAMMA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Gamma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">INDYCAM_GAMMA_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">INDYCAM_GAMMA_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">INDYCAM_GAMMA_DEFAULT</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define VINO_SAA7191_V4L2_CONTROL_COUNT		9</span>

<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">vino_saa7191_v4l2_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_HUE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Hue&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">SAA7191_HUE_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">SAA7191_HUE_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">SAA7191_HUE_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">SAA7191_CONTROL_BANDPASS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Luminance Bandpass&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">SAA7191_BANDPASS_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">SAA7191_BANDPASS_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">SAA7191_BANDPASS_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">SAA7191_CONTROL_BANDPASS_WEIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Luminance Bandpass Weight&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">SAA7191_BANDPASS_WEIGHT_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">SAA7191_BANDPASS_WEIGHT_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">SAA7191_BANDPASS_WEIGHT_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">SAA7191_CONTROL_CORING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HF Luminance Coring&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">SAA7191_CORING_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">SAA7191_CORING_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">SAA7191_CORING_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">SAA7191_CONTROL_FORCE_COLOUR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Force Colour&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">SAA7191_FORCE_COLOUR_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">SAA7191_FORCE_COLOUR_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">SAA7191_FORCE_COLOUR_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">SAA7191_CONTROL_CHROMA_GAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Chrominance Gain Control&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">SAA7191_CHROMA_GAIN_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">SAA7191_CHROMA_GAIN_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">SAA7191_CHROMA_GAIN_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">SAA7191_CONTROL_VTRC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;VTR Time Constant&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">SAA7191_VTRC_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">SAA7191_VTRC_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">SAA7191_VTRC_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">SAA7191_CONTROL_LUMA_DELAY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Luminance Delay Compensation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">SAA7191_LUMA_DELAY_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">SAA7191_LUMA_DELAY_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">SAA7191_LUMA_DELAY_DEFAULT</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">SAA7191_CONTROL_VNR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Vertical Noise Reduction&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">SAA7191_VNR_MIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">SAA7191_VNR_MAX</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">SAA7191_VNR_DEFAULT</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* VINO framebuffer/DMA descriptor management */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_free_buffer_with_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_free_buffer_with_count(): count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
				 <span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">[</span><span class="n">VINO_PAGE_RATIO</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span>
				 <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">free_page</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
			  <span class="n">VINO_PAGE_RATIO</span> <span class="o">*</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">page_count</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span>
			  <span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">),</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">,</span>
			  <span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vino_free_buffer_with_count</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">page_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_allocate_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_allocate_buffer():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer</span><span class="p">));</span>

	<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="n">size</span> <span class="o">/</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_allocate_buffer(): size = %d, count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">size</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/* allocate memory for table with virtual (page) addresses */</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* allocate memory for table with dma addresses</span>
<span class="cm">	 * (has space for four extra descriptors) */</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma_cpu</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">VINO_PAGE_RATIO</span> <span class="o">*</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span>
				   <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_free_virtual</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate pages for the buffer and acquire the according</span>
<span class="cm">	 * dma addresses */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_addr_t</span> <span class="n">dma_data_addr</span><span class="p">;</span>

		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_data_addr</span> <span class="o">=</span>
			<span class="n">dma_map_single</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				       <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">VINO_PAGE_RATIO</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">[</span><span class="n">VINO_PAGE_RATIO</span> <span class="o">*</span> <span class="n">i</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">dma_data_addr</span> <span class="o">+</span> <span class="n">VINO_PAGE_SIZE</span> <span class="o">*</span> <span class="n">j</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">SetPageReserved</span><span class="p">(</span><span class="n">virt_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="cm">/* page_count needs to be set anyway, because the descriptor table has</span>
<span class="cm">	 * been allocated according to this number */</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">page_count</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* the descriptor with index i doesn&#39;t contain</span>
<span class="cm">		 * a valid address yet */</span>
		<span class="n">vino_free_buffer_with_count</span><span class="p">(</span><span class="n">fb</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>fb->size = size;</p></td><td class="code"><div class="highlight"><pre>	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">VINO_DATA_FMT_NONE</span><span class="p">;</span>

	<span class="cm">/* set the dma stop-bit for the last (count+1)th descriptor */</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">[</span><span class="n">VINO_PAGE_RATIO</span> <span class="o">*</span> <span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">VINO_DESC_STOP</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_virtual:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* user buffers not fully implemented yet */</span>
<span class="c">static int vino_prepare_user_buffer(struct vino_framebuffer *fb,</span>
<span class="c">				     void *user,</span>
<span class="c">				     unsigned int size)</span>
<span class="c">{</span>
<span class="c">	unsigned int count, i, j;</span>
<span class="c">	int ret = 0;</span>

<span class="c">	dprintk(&quot;vino_prepare_user_buffer():\n&quot;);</span>

<span class="c">	if (size &lt; 1)</span>
<span class="c">		return -EINVAL;</span>

<span class="c">	memset(fb, 0, sizeof(struct vino_framebuffer));</span>

<span class="c">	count = ((size / PAGE_SIZE)) &amp; ~3;</span>

<span class="c">	dprintk(&quot;vino_prepare_user_buffer(): size = %d, count = %d\n&quot;,</span>
<span class="c">		size, count);</span>

<span class="c">	/* allocate memory for table with virtual (page) addresses */</span>
<span class="c">	fb-&gt;desc_table.virtual = (unsigned long *)</span>
<span class="c">		kmalloc(count * sizeof(unsigned long), GFP_KERNEL);</span>
<span class="c">	if (!fb-&gt;desc_table.virtual)</span>
<span class="c">		return -ENOMEM;</span>

<span class="c">	/* allocate memory for table with dma addresses</span>
<span class="c">	 * (has space for four extra descriptors) */</span>
<span class="c">	fb-&gt;desc_table.dma_cpu =</span>
<span class="c">		dma_alloc_coherent(NULL, VINO_PAGE_RATIO * (count + 4) *</span>
<span class="c">				   sizeof(dma_addr_t), &amp;fb-&gt;desc_table.dma,</span>
<span class="c">				   GFP_KERNEL | GFP_DMA);</span>
<span class="c">	if (!fb-&gt;desc_table.dma_cpu) {</span>
<span class="c">		ret = -ENOMEM;</span>
<span class="c">		goto out_free_virtual;</span>
<span class="c">	}</span>

<span class="c">	/* allocate pages for the buffer and acquire the according</span>
<span class="c">	 * dma addresses */</span>
<span class="c">	for (i = 0; i &lt; count; i++) {</span>
<span class="c">		dma_addr_t dma_data_addr;</span>

<span class="c">		fb-&gt;desc_table.virtual[i] =</span>
<span class="c">			get_zeroed_page(GFP_KERNEL | GFP_DMA);</span>
<span class="c">		if (!fb-&gt;desc_table.virtual[i]) {</span>
<span class="c">			ret = -ENOBUFS;</span>
<span class="c">			break;</span>
<span class="c">		}</span>

<span class="c">		dma_data_addr =</span>
<span class="c">			dma_map_single(NULL,</span>
<span class="c">				       (void *)fb-&gt;desc_table.virtual[i],</span>
<span class="c">				       PAGE_SIZE, DMA_FROM_DEVICE);</span>

<span class="c">		for (j = 0; j &lt; VINO_PAGE_RATIO; j++) {</span>
<span class="c">			fb-&gt;desc_table.dma_cpu[VINO_PAGE_RATIO * i + j] =</span>
<span class="c">				dma_data_addr + VINO_PAGE_SIZE * j;</span>
<span class="c">		}</span>

<span class="c">		SetPageReserved(virt_to_page((void *)fb-&gt;desc_table.virtual[i]));</span>
<span class="c">	}</span>

<span class="c">	/* page_count needs to be set anyway, because the descriptor table has</span>
<span class="c">	 * been allocated according to this number */</span>
<span class="c">	fb-&gt;desc_table.page_count = count;</span>

<span class="c">	if (ret) {</span>
<span class="c">		/* the descriptor with index i doesn&#39;t contain</span>
<span class="c">		 * a valid address yet */</span>
<span class="c">		vino_free_buffer_with_count(fb, i);</span>
<span class="c">		return ret;</span>
<span class="c">	}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>fb->size = size;</p></td><td class="code"><div class="highlight"><pre><span class="c">	fb-&gt;size = count * PAGE_SIZE;</span>

<span class="c">	/* set the dma stop-bit for the last (count+1)th descriptor */</span>
<span class="c">	fb-&gt;desc_table.dma_cpu[VINO_PAGE_RATIO * count] = VINO_DESC_STOP;</span>
<span class="c">	return 0;</span>

<span class="c"> out_free_virtual:</span>
<span class="c">	kfree(fb-&gt;desc_table.virtual);</span>
<span class="c">	return ret;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_sync_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_sync_buffer():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">page_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">dma_sync_single_for_cpu</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
					<span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">[</span><span class="n">VINO_PAGE_RATIO</span> <span class="o">*</span> <span class="n">i</span><span class="p">],</span>
					<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Framebuffer fifo functions (need to be locked externally) */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vino_fifo_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">VINO_FRAMEBUFFER_COUNT_MAX</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">VINO_FRAMEBUFFER_COUNT_MAX</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns true/false */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">vino_fifo_has_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">;</span> <span class="n">i</span> <span class="o">==</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* returns true/false */</span>
<span class="c">static inline int vino_fifo_full(struct vino_framebuffer_fifo *f)</span>
<span class="c">{</span>
<span class="c">	return (f-&gt;used == f-&gt;length);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">vino_fifo_get_used</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">used</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_fifo_enqueue</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">VINO_QUEUE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vino_fifo_has_id</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">VINO_QUEUE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tail</span><span class="p">]</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">tail</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">used</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">VINO_QUEUE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_fifo_peek</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">VINO_QUEUE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_fifo_dequeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">used</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">];</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">used</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">VINO_QUEUE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Framebuffer queue functions */</span>

<span class="cm">/* execute with queue_lock locked */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_queue_free_with_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_fifo</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_free_with_count(): freeing buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i</span><span class="p">);</span>
		<span class="n">vino_free_buffer</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VINO_MEMORY_NONE</span><span class="p">;</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_free():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">VINO_MEMORY_MMAP</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_mutex</span><span class="p">);</span>

	<span class="n">vino_queue_free_with_count</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_queue_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_init(): length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_init(): queue already initialized!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">VINO_MEMORY_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_init(): queue already initialized!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">VINO_FRAMEBUFFER_COUNT_MAX</span><span class="p">)</span>
		<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">VINO_FRAMEBUFFER_COUNT_MAX</span><span class="p">;</span>

	<span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_init(): allocating buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer</span><span class="p">),</span>
				       <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_init(): kmalloc() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_allocate_buffer</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					   <span class="n">VINO_FRAMEBUFFER_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_init(): &quot;</span>
				<span class="s">&quot;vino_allocate_buffer() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span>
				<span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_init(): buffer = %d, offset = %d, &quot;</span>
			<span class="s">&quot;size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vino_queue_free_with_count</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="o">*</span><span class="n">length</span><span class="p">;</span>
		<span class="n">vino_fifo_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">vino_fifo_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VINO_MEMORY_MMAP</span><span class="p">;</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="nf">vino_queue_add</span><span class="p">(</span><span class="k">struct</span>
					       <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">total</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_add(): id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* not needed?: if (vino_fifo_full(&amp;q-&gt;out)) {</span>
<span class="cm">		goto out;</span>
<span class="cm">		}*/</span>
	<span class="cm">/* check that outgoing queue isn&#39;t already full</span>
<span class="cm">	 * (or that it won&#39;t become full) */</span>
	<span class="n">total</span> <span class="o">=</span> <span class="n">vino_fifo_get_used</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">vino_fifo_get_used</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total</span> <span class="o">&gt;=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vino_fifo_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="nf">vino_queue_transfer</span><span class="p">(</span><span class="k">struct</span>
						    <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_transfer():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>now this actually removes an entry from the incoming queue</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">vino_fifo_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_transfer(): id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">id</span><span class="p">];</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>we have already checked that the outgoing queue is not full, but...</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">vino_fifo_enqueue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;vino_queue_transfer(): &quot;</span>
		       <span class="s">&quot;outgoing queue is full, this shouldn&#39;t happen!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns true/false */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_queue_incoming_contains</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_fifo_has_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* returns true/false */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_queue_outgoing_contains</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_fifo_has_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_queue_get_incoming</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">VINO_QUEUE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">VINO_QUEUE_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">used</span> <span class="o">=</span> <span class="n">vino_fifo_get_used</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_queue_get_outgoing</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">used</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">VINO_QUEUE_ERROR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">VINO_QUEUE_ERROR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">used</span> <span class="o">=</span> <span class="n">vino_fifo_get_used</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int vino_queue_get_total(struct vino_framebuffer_queue *q,</span>
<span class="c">				unsigned int *total)</span>
<span class="c">{</span>
<span class="c">	int ret = 0;</span>
<span class="c">	unsigned long flags;</span>

<span class="c">	if (q-&gt;magic != VINO_QUEUE_MAGIC) {</span>
<span class="c">		return VINO_QUEUE_ERROR;</span>
<span class="c">	}</span>

<span class="c">	spin_lock_irqsave(&amp;q-&gt;queue_lock, flags);</span>

<span class="c">	if (q-&gt;length == 0) {</span>
<span class="c">		ret = VINO_QUEUE_ERROR;</span>
<span class="c">		goto out;</span>
<span class="c">	}</span>

<span class="c">	*total = vino_fifo_get_used(&amp;q-&gt;in) +</span>
<span class="c">		vino_fifo_get_used(&amp;q-&gt;out);</span>

<span class="c">out:</span>
<span class="c">	spin_unlock_irqrestore(&amp;q-&gt;queue_lock, flags);</span>

<span class="c">	return ret;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="nf">vino_queue_peek</span><span class="p">(</span><span class="k">struct</span>
						<span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
						<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vino_fifo_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">in</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="o">*</span><span class="n">id</span><span class="p">];</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="nf">vino_queue_remove</span><span class="p">(</span><span class="k">struct</span>
						  <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
						  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_remove():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vino_fifo_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">out</span><span class="p">,</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_remove(): id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="o">*</span><span class="n">id</span><span class="p">];</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span>
<span class="n">vino_framebuffer</span> <span class="o">*</span><span class="nf">vino_queue_get_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">vino_queue_get_length</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">length</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_queue_has_mapped_buffers</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">VINO_QUEUE_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">map_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* VINO functions */</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_update_line_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bpp</span> <span class="o">=</span> <span class="n">vino_data_formats</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">].</span><span class="n">bpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lsize</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;update_line_size(): before: w = %d, d = %d, &quot;</span>
		<span class="s">&quot;line_size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">);</span>

	<span class="cm">/* line size must be multiple of 8 bytes */</span>
	<span class="n">lsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">bpp</span> <span class="o">*</span> <span class="p">(</span><span class="n">w</span> <span class="o">/</span> <span class="n">d</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">7</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsize</span> <span class="o">/</span> <span class="n">bpp</span><span class="p">)</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span> <span class="o">=</span> <span class="n">lsize</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;update_line_size(): after: w = %d, d = %d, &quot;</span>
		<span class="s">&quot;line_size = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_set_clipping</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">y</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxwidth</span><span class="p">,</span> <span class="n">maxheight</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">maxwidth</span> <span class="o">=</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>
	<span class="n">maxheight</span> <span class="o">=</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>
	<span class="n">d</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">;</span>

	<span class="n">y</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>	<span class="cm">/* odd/even fields */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;</span> <span class="n">maxwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">y</span> <span class="o">&gt;</span> <span class="n">maxheight</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">w</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">VINO_MIN_WIDTH</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">((</span><span class="n">h</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">VINO_MIN_HEIGHT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">VINO_MIN_WIDTH</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">VINO_MIN_HEIGHT</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxwidth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="n">maxwidth</span> <span class="o">-</span> <span class="n">x</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">w</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">VINO_MIN_WIDTH</span><span class="p">)</span>
			<span class="n">x</span> <span class="o">=</span> <span class="n">maxwidth</span> <span class="o">-</span> <span class="n">VINO_MIN_WIDTH</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">maxheight</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">h</span> <span class="o">=</span> <span class="n">maxheight</span> <span class="o">-</span> <span class="n">y</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">h</span> <span class="o">/</span> <span class="n">d</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">VINO_MIN_HEIGHT</span><span class="p">)</span>
			<span class="n">y</span> <span class="o">=</span> <span class="n">maxheight</span> <span class="o">-</span> <span class="n">VINO_MIN_HEIGHT</span> <span class="o">*</span> <span class="n">d</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">=</span> <span class="n">x</span> <span class="o">+</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="n">h</span><span class="p">;</span>

	<span class="n">vino_update_line_size</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;clipping %d, %d, %d, %d / %d - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span><span class="p">,</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vino_set_default_clipping</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vino_set_clipping</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">width</span><span class="p">,</span>
			  <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_set_scaling</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">h</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">curw</span><span class="p">,</span> <span class="n">curh</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>

	<span class="n">x</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
	<span class="n">curw</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="n">curh</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>

	<span class="n">d</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">curw</span> <span class="o">/</span> <span class="n">w</span><span class="p">,</span> <span class="n">curh</span> <span class="o">/</span> <span class="n">h</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;scaling w: %d, h: %d, curw: %d, curh: %d, d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">w</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">curw</span><span class="p">,</span> <span class="n">curh</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">vino_set_clipping</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">w</span> <span class="o">*</span> <span class="n">d</span><span class="p">,</span> <span class="n">h</span> <span class="o">*</span> <span class="n">d</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;scaling %d, %d, %d, %d / %d - %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">,</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span><span class="p">,</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vino_set_default_scaling</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vino_set_scaling</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">,</span>
			 <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_set_framerate</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_DATA_NORM_NTSC</span>:
	<span class="k">case</span> <span class="n">VINO_DATA_NORM_D1</span>:
		<span class="n">fps</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">fps</span> <span class="o">/</span> <span class="mi">6</span><span class="p">)</span> <span class="o">*</span> <span class="mi">6</span><span class="p">;</span> <span class="c1">// FIXME: round!</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fps</span> <span class="o">&lt;</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">fps_min</span><span class="p">)</span>
			<span class="n">fps</span> <span class="o">=</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">fps_min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fps</span> <span class="o">&gt;</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">fps_max</span><span class="p">)</span>
			<span class="n">fps</span> <span class="o">=</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">fps_max</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">fps</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">6</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x003</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">12</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x0c3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">18</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x333</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">24</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">30</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0xfff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">VINO_FRAMERT_FULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">framert_reg</span> <span class="o">=</span> <span class="n">VINO_FRAMERT_RT</span><span class="p">(</span><span class="n">mask</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VINO_DATA_NORM_PAL</span>:
	<span class="k">case</span> <span class="n">VINO_DATA_NORM_SECAM</span>:
		<span class="n">fps</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="n">fps</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span> <span class="c1">// FIXME: round!</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fps</span> <span class="o">&lt;</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">fps_min</span><span class="p">)</span>
			<span class="n">fps</span> <span class="o">=</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">fps_min</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fps</span> <span class="o">&gt;</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">fps_max</span><span class="p">)</span>
			<span class="n">fps</span> <span class="o">=</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">fps_max</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">fps</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x003</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">10</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x0c3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">15</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x333</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">20</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x0ff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">25</span>:
			<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x3ff</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">mask</span> <span class="o">=</span> <span class="n">VINO_FRAMERT_FULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">framert_reg</span> <span class="o">=</span> <span class="n">VINO_FRAMERT_RT</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">VINO_FRAMERT_PAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fps</span> <span class="o">=</span> <span class="n">fps</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vino_set_default_framerate</span><span class="p">(</span><span class="k">struct</span>
					      <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vino_set_framerate</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">fps_max</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* VINO I2C bus functions */</span>

<span class="k">struct</span> <span class="n">i2c_algo_sgi_data</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>	<span class="cm">/* private data for lowlevel routines */</span>
	<span class="kt">unsigned</span> <span class="p">(</span><span class="o">*</span><span class="n">getctrl</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">setctrl</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="p">(</span><span class="o">*</span><span class="n">rdata</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">wdata</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">);</span>

	<span class="kt">int</span> <span class="n">xfer_timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ack_timeout</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_xfer_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_sgi_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">xfer_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">getctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SGI_I2C_XFER_BUSY</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wait_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_sgi_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wait_xfer_done</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">ack_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">getctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SGI_I2C_NACK</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">force_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_sgi_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">setctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">SGI_I2C_FORCE_IDLE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">xfer_timeout</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">getctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SGI_I2C_NOT_IDLE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">getctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SGI_I2C_BUS_ERR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_sgi_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">rd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">)</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">setctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">SGI_I2C_NOT_IDLE</span><span class="p">);</span>
	<span class="cm">/* Check if bus is idle, eventually force it to do so */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">getctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SGI_I2C_NOT_IDLE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">force_idle</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="cm">/* Write out the i2c chip address and specify operation */</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">setctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		      <span class="n">SGI_I2C_HOLD_BUS</span> <span class="o">|</span> <span class="n">SGI_I2C_WRITE</span> <span class="o">|</span> <span class="n">SGI_I2C_NOT_IDLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rd</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wait_ack</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_sgi_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">setctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
		      <span class="n">SGI_I2C_HOLD_BUS</span> <span class="o">|</span> <span class="n">SGI_I2C_READ</span> <span class="o">|</span> <span class="n">SGI_I2C_NOT_IDLE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_xfer_done</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">adap</span><span class="o">-&gt;</span><span class="n">rdata</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adap</span><span class="o">-&gt;</span><span class="n">setctrl</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">SGI_I2C_RELEASE_BUS</span> <span class="o">|</span> <span class="n">SGI_I2C_FORCE_IDLE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_algo_sgi_data</span> <span class="o">*</span><span class="n">adap</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* We are already in write state */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">adap</span><span class="o">-&gt;</span><span class="n">wdata</span><span class="p">(</span><span class="n">adap</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_ack</span><span class="p">(</span><span class="n">adap</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sgi_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">msgs</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_algo_sgi_data</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">i2c_adap</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msgs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_address</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">||</span> <span class="o">!</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">I2C_M_RD</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_read</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">i2c_write</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">sgi_func</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">I2C_FUNC_SMBUS_EMUL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_algorithm</span> <span class="n">sgi_algo</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">master_xfer</span>	<span class="o">=</span> <span class="n">sgi_xfer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">functionality</span>	<span class="o">=</span> <span class="n">sgi_func</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">i2c_vino_getctrl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">i2c_control</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_vino_setctrl</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">i2c_control</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">i2c_vino_rdata</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">i2c_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2c_vino_wdata</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">i2c_data</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_algo_sgi_data</span> <span class="n">i2c_sgi_vino_data</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">getctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c_vino_getctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c_vino_setctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rdata</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c_vino_rdata</span><span class="p">,</span>
	<span class="p">.</span><span class="n">wdata</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c_vino_wdata</span><span class="p">,</span>
	<span class="p">.</span><span class="n">xfer_timeout</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ack_timeout</span>  <span class="o">=</span> <span class="mi">1000</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="n">vino_i2c_adapter</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;VINO I2C bus&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">algo</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">sgi_algo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">algo_data</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">i2c_sgi_vino_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">owner</span> 			<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Prepare VINO for DMA transfer...</span>
<span class="cm"> * (execute only with vino_lock and input_lock locked)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_dma_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">intr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sgi_vino_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vino_data_norm</span> <span class="o">*</span><span class="n">norm</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_dma_setup():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">frame_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">vino</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">;</span>
	<span class="n">norm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">];</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">page_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">line_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* VINO line size register is set 8 bytes less than actual */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">line_size</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* let VINO know where to transfer data */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">start_desc_tbl</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">next_4_desc</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>

	<span class="cm">/* give vino time to fetch the first four descriptors, 5 usec</span>
<span class="cm">	 * should be more than enough time */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">VINO_DESC_FETCH_DELAY</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_dma_setup(): start desc = %08x, next 4 desc = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">start_desc_tbl</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">next_4_desc</span><span class="p">);</span>

	<span class="cm">/* set the alpha register */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">alpha</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">alpha</span><span class="p">;</span>

	<span class="cm">/* set clipping registers */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">clip_start</span> <span class="o">=</span> <span class="n">VINO_CLIP_ODD</span><span class="p">(</span><span class="n">norm</span><span class="o">-&gt;</span><span class="n">odd</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">VINO_CLIP_EVEN</span><span class="p">(</span><span class="n">norm</span><span class="o">-&gt;</span><span class="n">even</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span>
			       <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">VINO_CLIP_X</span><span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">clip_end</span> <span class="o">=</span> <span class="n">VINO_CLIP_ODD</span><span class="p">(</span><span class="n">norm</span><span class="o">-&gt;</span><span class="n">odd</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span>
				     <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">VINO_CLIP_EVEN</span><span class="p">(</span><span class="n">norm</span><span class="o">-&gt;</span><span class="n">even</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span>
			       <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">VINO_CLIP_X</span><span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span><span class="p">);</span>

	<span class="cm">/* set the size of actual content in the buffer (DECIMATION !) */</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="p">((</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">)</span> <span class="o">/</span>
			 <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">)</span> <span class="o">*</span>
		<span class="p">((</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="o">/</span>
		 <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">)</span> <span class="o">*</span>
		<span class="n">vino_data_formats</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">].</span><span class="n">bpp</span><span class="p">;</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">frame_rate</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">framert_reg</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">intr_status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* All interrupt conditions for this channel was cleared</span>
<span class="cm">		 * so clear the interrupt status register and enable</span>
<span class="cm">		 * interrupts */</span>
		<span class="n">intr</span> <span class="o">&amp;=</span>	<span class="o">~</span><span class="n">VINO_INTSTAT_A</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_A_INT</span><span class="p">;</span>

		<span class="cm">/* enable synchronization */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_A_SYNC_ENBL</span><span class="p">;</span>

		<span class="cm">/* enable frame assembly */</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_A_INTERLEAVE_ENBL</span><span class="p">;</span>

		<span class="cm">/* set decimation used */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VINO_CTRL_A_DEC_ENBL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_A_DEC_ENBL</span><span class="p">;</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VINO_CTRL_A_DEC_SCALE_MASK</span><span class="p">;</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">VINO_CTRL_A_DEC_SCALE_SHIFT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* select input interface */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_D1</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_A_SELECT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VINO_CTRL_A_SELECT</span><span class="p">;</span>

		<span class="cm">/* palette */</span>
		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VINO_CTRL_A_LUMA_ONLY</span> <span class="o">|</span> <span class="n">VINO_CTRL_A_RGB</span> <span class="o">|</span>
			  <span class="n">VINO_CTRL_A_DITHER</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">intr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VINO_INTSTAT_B</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_B_INT</span><span class="p">;</span>

		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_B_SYNC_ENBL</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_B_INTERLEAVE_ENBL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VINO_CTRL_B_DEC_ENBL</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_B_DEC_ENBL</span><span class="p">;</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VINO_CTRL_B_DEC_SCALE_MASK</span><span class="p">;</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
				<span class="n">VINO_CTRL_B_DEC_SCALE_SHIFT</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_D1</span><span class="p">)</span>
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">VINO_CTRL_B_SELECT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VINO_CTRL_B_SELECT</span><span class="p">;</span>

		<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">VINO_CTRL_B_LUMA_ONLY</span> <span class="o">|</span> <span class="n">VINO_CTRL_B_RGB</span> <span class="o">|</span>
			  <span class="n">VINO_CTRL_B_DITHER</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* set palette */</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VINO_DATA_FMT_GREY</span>:
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">VINO_CTRL_A_LUMA_ONLY</span> <span class="o">:</span> <span class="n">VINO_CTRL_B_LUMA_ONLY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VINO_DATA_FMT_RGB32</span>:
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">VINO_CTRL_A_RGB</span> <span class="o">:</span> <span class="n">VINO_CTRL_B_RGB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VINO_DATA_FMT_YUV</span>:
			<span class="cm">/* nothing needs to be done */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VINO_DATA_FMT_RGB332</span>:
			<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">VINO_CTRL_A_RGB</span> <span class="o">|</span> <span class="n">VINO_CTRL_A_DITHER</span> <span class="o">:</span>
				<span class="n">VINO_CTRL_B_RGB</span> <span class="o">|</span> <span class="n">VINO_CTRL_B_DITHER</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">intr_status</span> <span class="o">=</span> <span class="n">intr</span><span class="p">;</span>
	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* (execute only with vino_lock locked) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vino_dma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_dma_start():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">|=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">VINO_CTRL_A_DMA_ENBL</span> <span class="o">:</span> <span class="n">VINO_CTRL_B_DMA_ENBL</span><span class="p">;</span>
	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* (execute only with vino_lock locked) */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">vino_dma_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">~</span><span class="n">VINO_CTRL_A_DMA_ENBL</span> <span class="o">:</span> <span class="o">~</span><span class="n">VINO_CTRL_B_DMA_ENBL</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">~</span><span class="n">VINO_CTRL_A_INT</span> <span class="o">:</span> <span class="o">~</span><span class="n">VINO_CTRL_B_INT</span><span class="p">;</span>
	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_dma_stop():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Load dummy page to descriptor registers. This prevents generating of</span>
<span class="cm"> * spurious interrupts. (execute only with vino_lock locked)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_clear_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sgi_vino_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">vino</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">;</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">page_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">line_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">start_desc_tbl</span> <span class="o">=</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">next_4_desc</span> <span class="o">=</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">VINO_DESC_FETCH_DELAY</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;channel %c clear interrupt condition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;A&#39;</span><span class="o">:</span><span class="sc">&#39;B&#39;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">flags2</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VINO_FRAMEBUFFER_IN_USE</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VINO_FRAMEBUFFER_IN_USE</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>

	<span class="n">vino_dma_setup</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">fb</span><span class="p">);</span>
	<span class="n">vino_dma_start</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="nf">vino_capture_enqueue</span><span class="p">(</span><span class="k">struct</span>
					      <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
					      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_enqueue():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="n">vino_queue_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_enqueue(): vino_queue_add() failed, &quot;</span>
			<span class="s">&quot;queue full?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_capture_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">start</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">incoming</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_next():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start capture only if capture isn&#39;t in progress already */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* capture next frame:</span>
<span class="cm">		 * stop capture if capturing is not set */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vino_queue_get_incoming</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">incoming</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_next(): vino_queue_get_incoming() &quot;</span>
			<span class="s">&quot;failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">incoming</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_next(): no buffers available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="n">vino_queue_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_next(): vino_queue_peek() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capturing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vino_capture</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">fb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capturing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">vino_is_capturing</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* waits until a frame is captured */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_wait_for_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_wait_for_frame():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">init_waitqueue_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="cm">/* add ourselves into wait queue */</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">.</span><span class="n">frame_wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* to ensure that schedule_timeout will return immediately</span>
<span class="cm">	 * if VINO interrupt was triggered meanwhile */</span>
	<span class="n">schedule_timeout_interruptible</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">.</span><span class="n">frame_wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_wait_for_frame(): waiting for frame %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">err</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;ok&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* the function assumes that PAGE_SIZE % 4 == 0 */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_convert_to_rgba</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pageptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">page</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">page</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">page</span> <span class="o">&lt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">page_count</span><span class="p">;</span> <span class="n">page</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pageptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">[</span><span class="n">page</span><span class="p">];</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">pageptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">pageptr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pageptr</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">pageptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pageptr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">pageptr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">pageptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">pageptr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
			<span class="n">pageptr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* checks if the buffer is in correct state and syncs data */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_check_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_check_buffer():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_FRAMEBUFFER_IN_USE</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VINO_FRAMEBUFFER_READY</span>:
		<span class="n">vino_sync_buffer</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VINO_FRAMEBUFFER_UNUSED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vino_pixel_conversion</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">data_format</span> <span class="o">==</span> <span class="n">VINO_DATA_FMT_RGB32</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vino_convert_to_rgba</span><span class="p">(</span><span class="n">fb</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_check_buffer(): buffer not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">vino_dma_stop</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
		<span class="n">vino_clear_interrupt</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* forcefully terminates capture */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_capture_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">incoming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">outgoing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">,</span> <span class="n">flags2</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_stop():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* unset capturing to stop queue processing */</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capturing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>

	<span class="n">vino_dma_stop</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="n">vino_clear_interrupt</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">,</span> <span class="n">flags2</span><span class="p">);</span>

	<span class="cm">/* remove all items from the queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_get_incoming</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">incoming</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_stop(): &quot;</span>
			<span class="s">&quot;vino_queue_get_incoming() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">incoming</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vino_queue_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_get_incoming</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">incoming</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_stop(): &quot;</span>
				<span class="s">&quot;vino_queue_get_incoming() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_get_outgoing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outgoing</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_stop(): &quot;</span>
			<span class="s">&quot;vino_queue_get_outgoing() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">outgoing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vino_queue_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_get_outgoing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outgoing</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_capture_stop(): &quot;</span>
				<span class="s">&quot;vino_queue_get_outgoing() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static int vino_capture_failed(struct vino_channel_settings *vcs)</span>
<span class="c">{</span>
<span class="c">	struct vino_framebuffer *fb;</span>
<span class="c">	unsigned long flags;</span>
<span class="c">	unsigned int i;</span>
<span class="c">	int ret;</span>

<span class="c">	dprintk(&quot;vino_capture_failed():\n&quot;);</span>

<span class="c">	spin_lock_irqsave(&amp;vino_drvdata-&gt;vino_lock, flags);</span>

<span class="c">	vino_dma_stop(vcs);</span>
<span class="c">	vino_clear_interrupt(vcs);</span>

<span class="c">	spin_unlock_irqrestore(&amp;vino_drvdata-&gt;vino_lock, flags);</span>

<span class="c">	ret = vino_queue_get_incoming(&amp;vcs-&gt;fb_queue, &amp;i);</span>
<span class="c">	if (ret == VINO_QUEUE_ERROR) {</span>
<span class="c">		dprintk(&quot;vino_queue_get_incoming() failed\n&quot;);</span>
<span class="c">		return -EINVAL;</span>
<span class="c">	}</span>
<span class="c">	if (i == 0) {</span>
<span class="c">		/* no buffers to process */</span>
<span class="c">		return 0;</span>
<span class="c">	}</span>

<span class="c">	fb = vino_queue_peek(&amp;vcs-&gt;fb_queue, &amp;i);</span>
<span class="c">	if (fb == NULL) {</span>
<span class="c">		dprintk(&quot;vino_queue_peek() failed\n&quot;);</span>
<span class="c">		return -EINVAL;</span>
<span class="c">	}</span>

<span class="c">	spin_lock_irqsave(&amp;fb-&gt;state_lock, flags);</span>
<span class="c">	if (fb-&gt;state == VINO_FRAMEBUFFER_IN_USE) {</span>
<span class="c">		fb-&gt;state = VINO_FRAMEBUFFER_UNUSED;</span>
<span class="c">		vino_queue_transfer(&amp;vcs-&gt;fb_queue);</span>
<span class="c">		vino_queue_remove(&amp;vcs-&gt;fb_queue, &amp;i);</span>
<span class="c">		/* we should actually discard the newest frame,</span>
<span class="c">		 * but who cares ... */</span>
<span class="c">	}</span>
<span class="c">	spin_unlock_irqrestore(&amp;fb-&gt;state_lock, flags);</span>

<span class="c">	return 0;</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_skip_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">vino_queue_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_skip_frame(): vino_queue_peek() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VINO_FRAMEBUFFER_UNUSED</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">vino_capture_next</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_frame_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">fb</span> <span class="o">=</span> <span class="n">vino_queue_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_frame_done(): vino_queue_transfer() failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">frame_counter</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">int_data</span><span class="p">.</span><span class="n">frame_counter</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">int_data</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VINO_FRAMEBUFFER_IN_USE</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VINO_FRAMEBUFFER_READY</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">state_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">.</span><span class="n">frame_wait_queue</span><span class="p">);</span>

	<span class="n">vino_capture_next</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_capture_tasklet</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">;</span>

	<span class="n">vcs</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span>
		<span class="o">?</span> <span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">int_data</span><span class="p">.</span><span class="n">skip</span><span class="p">)</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">int_data</span><span class="p">.</span><span class="n">skip_count</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">int_data</span><span class="p">.</span><span class="n">skip</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">int_data</span><span class="p">.</span><span class="n">skip_count</span>
				   <span class="o">&lt;=</span> <span class="n">VINO_MAX_FRAME_SKIP_COUNT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vino_skip_frame</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">int_data</span><span class="p">.</span><span class="n">skip_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vino_frame_done</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">vino_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">intr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fc_a</span><span class="p">,</span> <span class="n">fc_b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skip_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done_a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skip_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done_b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef VINO_DEBUG_INT</span>
	<span class="kt">int</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line_count</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">line_count</span><span class="p">,</span>
		<span class="n">page_index</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">page_index</span><span class="p">,</span>
		<span class="n">field_counter</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">field_counter</span><span class="p">,</span>
		<span class="n">start_desc_tbl</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">start_desc_tbl</span><span class="p">,</span>
		<span class="n">next_4_desc</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">next_4_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">line_count_2</span><span class="p">,</span>
		<span class="n">page_index_2</span><span class="p">,</span>
		<span class="n">field_counter_2</span><span class="p">,</span>
		<span class="n">start_desc_tbl_2</span><span class="p">,</span>
		<span class="n">next_4_desc_2</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">intr</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">intr_status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fc_a</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">field_counter</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fc_b</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">field_counter</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* handle error-interrupts in some special way ?</span>
<span class="cm">		 * --&gt; skips frames */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">VINO_INTSTAT_A</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">VINO_INTSTAT_A_EOF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">field</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vino_dma_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">);</span>
					<span class="n">vino_clear_interrupt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">);</span>
					<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">done_a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">page_index</span>
					    <span class="o">!=</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">line_size</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">line_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">page_index</span> <span class="o">=</span>
							<span class="n">vino_drvdata</span><span class="o">-&gt;</span>
							<span class="n">a</span><span class="p">.</span><span class="n">line_size</span><span class="p">;</span>
						<span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">next_4_desc</span> <span class="o">=</span>
							<span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">start_desc_tbl</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;channel A end-of-field &quot;</span>
					<span class="s">&quot;interrupt: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vino_dma_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">);</span>
				<span class="n">vino_clear_interrupt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">);</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">skip_a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;channel A error interrupt: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">intr</span><span class="p">);</span>
			<span class="p">}</span>

<span class="cp">#ifdef VINO_DEBUG_INT</span>
			<span class="n">line_count_2</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">line_count</span><span class="p">;</span>
			<span class="n">page_index_2</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">page_index</span><span class="p">;</span>
			<span class="n">field_counter_2</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">field_counter</span><span class="p">;</span>
			<span class="n">start_desc_tbl_2</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">start_desc_tbl</span><span class="p">;</span>
			<span class="n">next_4_desc_2</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">next_4_desc</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;intr = %04x, loop = %d, field = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">intr</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">field</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;1- line count = %04d, page index = %04d, &quot;</span>
			       <span class="s">&quot;start = %08x, next = %08x</span><span class="se">\n</span><span class="s">&quot;</span>
			       <span class="s">&quot;   fieldc = %d, framec = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">line_count</span><span class="p">,</span> <span class="n">page_index</span><span class="p">,</span> <span class="n">start_desc_tbl</span><span class="p">,</span>
			       <span class="n">next_4_desc</span><span class="p">,</span> <span class="n">field_counter</span><span class="p">,</span> <span class="n">fc_a</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;12-line count = %04d, page index = %04d, &quot;</span>
			       <span class="s">&quot;   start = %08x, next = %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">line_count_2</span><span class="p">,</span> <span class="n">page_index_2</span><span class="p">,</span> <span class="n">start_desc_tbl_2</span><span class="p">,</span>
			       <span class="n">next_4_desc_2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">done_a</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">VINO_INTSTAT_B</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">VINO_INTSTAT_B_EOF</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">field</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">field</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">vino_dma_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">);</span>
					<span class="n">vino_clear_interrupt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">);</span>
					<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">done_b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;channel B end-of-field &quot;</span>
					<span class="s">&quot;interrupt: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">intr</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vino_dma_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">);</span>
				<span class="n">vino_clear_interrupt</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">);</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">skip_b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;channel B error interrupt: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">intr</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Always remember to clear interrupt status.</span>
<span class="cm">		 * Disable VINO interrupts while we do this. */</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">;</span>
		<span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">ctrl</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">VINO_CTRL_A_INT</span> <span class="o">|</span> <span class="n">VINO_CTRL_B_INT</span><span class="p">);</span>
		<span class="n">vino</span><span class="o">-&gt;</span><span class="n">intr_status</span> <span class="o">=</span> <span class="o">~</span><span class="n">intr</span><span class="p">;</span>
		<span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">handled_a</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">done_a</span> <span class="o">||</span> <span class="n">skip_a</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skip_a</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span>
						<span class="n">a</span><span class="p">.</span><span class="n">int_data</span><span class="p">.</span><span class="n">timestamp</span><span class="p">);</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">int_data</span><span class="p">.</span><span class="n">frame_counter</span> <span class="o">=</span> <span class="n">fc_a</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">int_data</span><span class="p">.</span><span class="n">skip</span> <span class="o">=</span> <span class="n">skip_a</span><span class="p">;</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;channel A %s, interrupt: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">skip_a</span> <span class="o">?</span> <span class="s">&quot;skipping frame&quot;</span> <span class="o">:</span> <span class="s">&quot;frame done&quot;</span><span class="p">,</span>
				<span class="n">intr</span><span class="p">);</span>
			<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_tasklet_a</span><span class="p">);</span>
			<span class="n">handled_a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">handled_b</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">done_b</span> <span class="o">||</span> <span class="n">skip_b</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skip_b</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span>
						<span class="n">b</span><span class="p">.</span><span class="n">int_data</span><span class="p">.</span><span class="n">timestamp</span><span class="p">);</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">int_data</span><span class="p">.</span><span class="n">frame_counter</span> <span class="o">=</span> <span class="n">fc_b</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">int_data</span><span class="p">.</span><span class="n">skip</span> <span class="o">=</span> <span class="n">skip_b</span><span class="p">;</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;channel B %s, interrupt: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">skip_b</span> <span class="o">?</span> <span class="s">&quot;skipping frame&quot;</span> <span class="o">:</span> <span class="s">&quot;frame done&quot;</span><span class="p">,</span>
				<span class="n">intr</span><span class="p">);</span>
			<span class="n">tasklet_hi_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_tasklet_b</span><span class="p">);</span>
			<span class="n">handled_b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

<span class="cp">#ifdef VINO_DEBUG_INT</span>
		<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* VINO video input management */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_get_saa7191_input</span><span class="p">(</span><span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
		<span class="k">return</span> <span class="n">SAA7191_INPUT_COMPOSITE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>:
		<span class="k">return</span> <span class="n">SAA7191_INPUT_SVIDEO</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;VINO: vino_get_saa7191_input(): &quot;</span>
		       <span class="s">&quot;invalid input!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_is_input_owner</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
	<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>:
		<span class="k">return</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">==</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_D1</span>:
		<span class="k">return</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">==</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_acquire_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_acquire_input():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* First try D1 and then SAA7191 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">==</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_D1</span><span class="p">;</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span> <span class="o">=</span> <span class="n">VINO_DATA_NORM_D1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder</span>
		   <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">==</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">input</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">data_norm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">;</span>

		<span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_COMPOSITE</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">decoder_call</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span>
				<span class="n">vino_get_saa7191_input</span><span class="p">(</span><span class="n">input</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Don&#39;t hold spinlocks while auto-detecting norm</span>
<span class="cm">		 * as it may take a while... */</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">decoder_call</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">querystd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">data_norm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">data_norm</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">data_norm</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">vino_data_norms</span><span class="p">[</span><span class="n">data_norm</span><span class="p">].</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data_norm</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">data_norm</span> <span class="o">=</span> <span class="n">VINO_DATA_NORM_PAL</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">decoder_call</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">norm</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span> <span class="o">=</span> <span class="n">data_norm</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">input</span> <span class="o">:</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">input</span><span class="p">;</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">data_norm</span> <span class="o">:</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">data_norm</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vino_set_default_clipping</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="n">vino_set_default_scaling</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="n">vino_set_default_framerate</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_acquire_input(): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vino_inputs</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_set_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs2</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_set_input():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">input</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
	<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">==</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">==</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">data_norm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">decoder_call</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span>
					<span class="n">vino_get_saa7191_input</span><span class="p">(</span><span class="n">input</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">=</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="cm">/* Don&#39;t hold spinlocks while auto-detecting norm</span>
<span class="cm">			 * as it may take a while... */</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">decoder_call</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">querystd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">norm</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">data_norm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">data_norm</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">data_norm</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">vino_data_norms</span><span class="p">[</span><span class="n">data_norm</span><span class="p">].</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">norm</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data_norm</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">data_norm</span> <span class="o">=</span> <span class="n">VINO_DATA_NORM_PAL</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">decoder_call</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">norm</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">=</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">;</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
			<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span> <span class="o">=</span> <span class="n">data_norm</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">!=</span> <span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
			<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span> <span class="o">=</span> <span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">==</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Transfer the ownership or release the input */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_D1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">=</span> <span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">=</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_D1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">==</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">)</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">==</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Transfer the ownership or release the input */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_COMPOSITE</span><span class="p">)</span> <span class="o">||</span>
				 <span class="p">(</span><span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_SVIDEO</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">=</span> <span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">=</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span> <span class="o">=</span> <span class="n">VINO_DATA_NORM_D1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vino_set_default_clipping</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="n">vino_set_default_scaling</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="n">vino_set_default_framerate</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_set_input(): %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vino_inputs</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_release_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs2</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span>
		<span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_release_input():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Release ownership of the channel</span>
<span class="cm">	 * and if the other channel takes input from</span>
<span class="cm">	 * the same source, transfer the ownership */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">==</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_D1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">=</span> <span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera_owner</span> <span class="o">=</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">==</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_COMPOSITE</span><span class="p">)</span> <span class="o">||</span>
			 <span class="p">(</span><span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_SVIDEO</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">=</span> <span class="n">vcs2</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder_owner</span> <span class="o">=</span> <span class="n">VINO_NO_CHANNEL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_NONE</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_set_data_norm</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data_norm</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_norm</span> <span class="o">==</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_D1</span>:
		<span class="cm">/* only one &quot;norm&quot; supported */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data_norm</span> <span class="o">!=</span> <span class="n">VINO_DATA_NORM_D1</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
	<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>: <span class="p">{</span>
		<span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data_norm</span> <span class="o">!=</span> <span class="n">VINO_DATA_NORM_PAL</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data_norm</span> <span class="o">!=</span> <span class="n">VINO_DATA_NORM_NTSC</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">data_norm</span> <span class="o">!=</span> <span class="n">VINO_DATA_NORM_SECAM</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="o">*</span><span class="n">flags</span><span class="p">);</span>

		<span class="cm">/* Don&#39;t hold spinlocks while setting norm</span>
<span class="cm">		 * as it may take a while... */</span>

		<span class="n">norm</span> <span class="o">=</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">data_norm</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">decoder_call</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">norm</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="o">*</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span> <span class="o">=</span> <span class="n">data_norm</span><span class="p">;</span>

		<span class="n">vino_set_default_clipping</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
		<span class="n">vino_set_default_scaling</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
		<span class="n">vino_set_default_framerate</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* V4L2 helper functions */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_find_data_format</span><span class="p">(</span><span class="n">__u32</span> <span class="n">pixelformat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VINO_DATA_FMT_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vino_data_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">pixelformat</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">VINO_DATA_FMT_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_int_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_NONE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder</span> <span class="o">&amp;&amp;</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_COMPOSITE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_SVIDEO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_D1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_COMPOSITE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_SVIDEO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_D1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">input</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* execute with input_lock locked */</span>
<span class="k">static</span> <span class="n">__u32</span> <span class="nf">vino_find_input_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>FIXME: detect when no inputs available</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder</span> <span class="o">&amp;&amp;</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>:
			<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VINO_INPUT_D1</span>:
			<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>:
			<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">VINO_INPUT_D1</span>:
			<span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">index</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* V4L2 ioctls */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_capability</span><span class="p">));</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">vino_driver_name</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vino_driver_description</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">vino_bus_name</span><span class="p">);</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span>
		<span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>V4L2<em>CAP</em>OVERLAY, V4L2<em>CAP</em>READWRITE</p></td><td class="code"><div class="highlight"><pre>	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">__u32</span> <span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;requested index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">input</span> <span class="o">=</span> <span class="n">vino_int_enum_input</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">vino_inputs</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">vino_inputs</span><span class="p">[</span><span class="n">input</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_COMPOSITE</span> <span class="o">||</span> <span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_SVIDEO</span><span class="p">)</span>
		<span class="n">decoder_call</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">g_input_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">__u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">input</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">input</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="n">index</span> <span class="o">=</span> <span class="n">vino_find_input_index</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;input = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;requested input = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="n">input</span> <span class="o">=</span> <span class="n">vino_int_enum_input</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vino_set_input</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_querystd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			      <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_D1</span>:
		<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">vino_inputs</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
	<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>: <span class="p">{</span>
		<span class="n">decoder_call</span><span class="p">(</span><span class="n">video</span><span class="p">,</span> <span class="n">querystd</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			   <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;current standard = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			   <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vino_is_input_owner</span><span class="p">(</span><span class="n">vcs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* check if the standard is valid for the current input */</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">vino_inputs</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">].</span><span class="n">std</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;standard accepted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* change the video norm for SAA7191</span>
<span class="cm">		 * and accept NTSC for D1 (do nothing) */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">VINO_INPUT_D1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_set_data_norm</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">VINO_DATA_NORM_PAL</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_set_data_norm</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">VINO_DATA_NORM_NTSC</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_set_data_norm</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">VINO_DATA_NORM_SECAM</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;format index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">VINO_DATA_FMT_COUNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;format name = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vino_data_formats</span><span class="p">[</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">description</span><span class="p">);</span>

	<span class="n">fd</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">vino_data_formats</span><span class="p">[</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">vino_data_formats</span><span class="p">[</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">description</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="n">tempvcs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;requested: w = %d, h = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempvcs</span><span class="p">,</span> <span class="n">vcs</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tempvcs</span><span class="p">.</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">vino_find_data_format</span><span class="p">(</span><span class="n">pf</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tempvcs</span><span class="p">.</span><span class="n">data_format</span> <span class="o">==</span> <span class="n">VINO_DATA_FMT_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tempvcs</span><span class="p">.</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">VINO_DATA_FMT_GREY</span><span class="p">;</span>
		<span class="n">pf</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span>
			<span class="n">vino_data_formats</span><span class="p">[</span><span class="n">tempvcs</span><span class="p">.</span><span class="n">data_format</span><span class="p">].</span>
			<span class="n">pixelformat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* data format must be set before clipping/scaling */</span>
	<span class="n">vino_set_scaling</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tempvcs</span><span class="p">,</span> <span class="n">pf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;data format = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">vino_data_formats</span><span class="p">[</span><span class="n">tempvcs</span><span class="p">.</span><span class="n">data_format</span><span class="p">].</span><span class="n">description</span><span class="p">);</span>

	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">tempvcs</span><span class="p">.</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">tempvcs</span><span class="p">.</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">tempvcs</span><span class="p">.</span><span class="n">decimation</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">tempvcs</span><span class="p">.</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">tempvcs</span><span class="p">.</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">tempvcs</span><span class="p">.</span><span class="n">decimation</span><span class="p">;</span>

	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">tempvcs</span><span class="p">.</span><span class="n">line_size</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">tempvcs</span><span class="p">.</span><span class="n">line_size</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">tempvcs</span><span class="p">.</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">tempvcs</span><span class="p">.</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">tempvcs</span><span class="p">.</span><span class="n">decimation</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span>
		<span class="n">vino_data_formats</span><span class="p">[</span><span class="n">tempvcs</span><span class="p">.</span><span class="n">data_format</span><span class="p">].</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span>
		<span class="n">vino_data_formats</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">].</span><span class="n">pixelformat</span><span class="p">;</span>

	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span>
		<span class="n">vino_data_formats</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">].</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">data_format</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">data_format</span> <span class="o">=</span> <span class="n">vino_find_data_format</span><span class="p">(</span><span class="n">pf</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_format</span> <span class="o">==</span> <span class="n">VINO_DATA_FMT_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">VINO_DATA_FMT_GREY</span><span class="p">;</span>
		<span class="n">pf</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span>
			<span class="n">vino_data_formats</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">].</span>
			<span class="n">pixelformat</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">data_format</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* data format must be set before clipping/scaling */</span>
	<span class="n">vino_set_scaling</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">pf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;data format = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">vino_data_formats</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">].</span><span class="n">description</span><span class="p">);</span>

	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>

	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">line_size</span> <span class="o">*</span>
		<span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span><span class="p">;</span>
	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span>
		<span class="n">vino_data_formats</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span><span class="p">].</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="n">pf</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">ccap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">vino_data_norm</span> <span class="o">*</span><span class="n">norm</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ccap</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">norm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vino_data_norms</span><span class="p">[</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span><span class="p">];</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_rect</span><span class="p">));</span>

		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">c</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">right</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">bottom</span> <span class="o">-</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">clipping</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">vino_set_clipping</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span><span class="p">,</span>
				  <span class="n">c</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_g_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_captureparm</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">;</span>

	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_CAP_TIMEPERFRAME</span><span class="p">;</span>
	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cp</span><span class="o">-&gt;</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fps</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* TODO: cp-&gt;readbuffers = xxx; */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_s_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">sp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_captureparm</span> <span class="o">*</span><span class="n">cp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sp</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cp</span><span class="o">-&gt;</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* reset framerate */</span>
		<span class="n">vino_set_default_framerate</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vino_set_framerate</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">cp</span><span class="o">-&gt;</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span> <span class="o">/</span>
				   <span class="n">cp</span><span class="o">-&gt;</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">rb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">reading</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* TODO: check queue type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;type not mmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vino_is_capturing</span><span class="p">(</span><span class="n">vcs</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;busy, capturing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_has_mapped_buffers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;busy, buffers still mapped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">vino_queue_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">);</span>
			<span class="n">vino_queue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rb</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vino_capture_stop</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
		<span class="n">vino_queue_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_v4l2_get_buffer_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_outgoing_contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span>
					 <span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_incoming_contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span>
				       <span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">V4L2_BUF_FLAG_DONE</span> <span class="o">|</span>
			      <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">V4L2_BUF_FLAG_TIMECODE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">map_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_MAPPED</span><span class="p">;</span>

	<span class="n">b</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">VINO_MEMORY_MMAP</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">V4L2_MEMORY_MMAP</span> <span class="o">:</span> <span class="n">V4L2_MEMORY_USERPTR</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">b</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">frame_counter</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">timeval</span><span class="p">));</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>b->input ?</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer %d: length = %d, bytesused = %d, offset = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">reading</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* TODO: check queue type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">vino_queue_get_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;invalid index = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">b</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="n">vino_queue_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span>
				   <span class="n">b</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_get_buffer() failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vino_v4l2_get_buffer_status</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">reading</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* TODO: check queue type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;type not mmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="n">vino_capture_enqueue</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">vino_v4l2_get_buffer_status</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_capture_next</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nonblocking</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">incoming</span><span class="p">,</span> <span class="n">outgoing</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">reading</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* TODO: check queue type */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vino_queue_get_incoming</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">incoming</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_get_incoming() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">vino_queue_get_outgoing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outgoing</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_get_outgoing() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;incoming = %d, outgoing = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">incoming</span><span class="p">,</span> <span class="n">outgoing</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">outgoing</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">incoming</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;no incoming or outgoing buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nonblocking</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;non-blocking I/O was selected and &quot;</span>
				<span class="s">&quot;there are no buffers to dequeue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">vino_wait_for_frame</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">vino_wait_for_frame</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* interrupted or no frames captured because of</span>
<span class="cm">				 * frame skipping */</span>
				<span class="cm">/* vino_capture_failed(vcs); */</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fb</span> <span class="o">=</span> <span class="n">vino_queue_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_remove() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">vino_check_buffer</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">fb</span><span class="p">);</span>

	<span class="n">vino_v4l2_get_buffer_status</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="n">fb</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">incoming</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">reading</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>TODO: check queue type</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_get_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;no buffers allocated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_queue_get_incoming</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">incoming</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_queue_get_incoming() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">incoming</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_capture_next</span><span class="p">(</span><span class="n">vcs</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;couldn&#39;t start capture</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">reading</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vino_capture_stop</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">queryctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_D1</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VINO_INDYCAM_V4L2_CONTROL_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vino_indycam_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span>
			    <span class="n">queryctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">queryctrl</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">vino_indycam_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_queryctrl</span><span class="p">));</span>
				<span class="n">queryctrl</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
	<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>:
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VINO_SAA7191_V4L2_CONTROL_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vino_saa7191_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span>
			    <span class="n">queryctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">queryctrl</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">vino_saa7191_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_queryctrl</span><span class="p">));</span>
				<span class="n">queryctrl</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">found:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_D1</span>: <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VINO_INDYCAM_V4L2_CONTROL_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vino_indycam_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">camera_call</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
	<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>: <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VINO_SAA7191_V4L2_CONTROL_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vino_saa7191_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">decoder_call</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">__fh</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vino_is_input_owner</span><span class="p">(</span><span class="n">vcs</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_D1</span>: <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VINO_INDYCAM_V4L2_CONTROL_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vino_indycam_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">vino_indycam_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">minimum</span> <span class="o">||</span>
		    <span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">vino_indycam_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">maximum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">camera_call</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">VINO_INPUT_COMPOSITE</span>:
	<span class="k">case</span> <span class="n">VINO_INPUT_SVIDEO</span>: <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VINO_SAA7191_V4L2_CONTROL_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vino_saa7191_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">vino_saa7191_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">minimum</span> <span class="o">||</span>
		    <span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">vino_saa7191_v4l2_controls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">maximum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">decoder_call</span><span class="p">(</span><span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="n">err</span> <span class="o">=</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* File operations */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;open(): channel = %c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">==</span> <span class="n">VINO_CHANNEL_A</span><span class="p">)</span> <span class="o">?</span> <span class="sc">&#39;A&#39;</span> <span class="o">:</span> <span class="sc">&#39;B&#39;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;open(): driver busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_acquire_input</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;open(): vino_acquire_input() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">++</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;open(): %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span> <span class="o">?</span> <span class="s">&quot;failed&quot;</span> <span class="o">:</span> <span class="s">&quot;complete&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;close():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vino_release_input</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>

		<span class="cm">/* stop DMA and free buffers */</span>
		<span class="n">vino_capture_stop</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
		<span class="n">vino_queue_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_vm_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_vm_open(): count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_vm_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span><span class="p">;</span>

	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_vm_close(): count = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">map_count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">vm_operations_struct</span> <span class="n">vino_vm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>	<span class="o">=</span> <span class="n">vino_vm_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span>	<span class="o">=</span> <span class="n">vino_vm_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">vino_framebuffer</span> <span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mmap():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>TODO: reject mmap if already mapped</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">reading</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>TODO: check queue type</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_WRITE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mmap(): app bug: PROT_WRITE please</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_SHARED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mmap(): app bug: MAP_SHARED please</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* find the correct buffer using offset */</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">vino_queue_get_length</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mmap(): queue not initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fb</span> <span class="o">=</span> <span class="n">vino_queue_get_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mmap(): vino_queue_get_buffer() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">==</span> <span class="n">offset</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">found</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mmap(): invalid offset = %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">found:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mmap(): buffer = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">page_count</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mmap(): failed: size = %lu &gt; %lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">size</span><span class="p">,</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">page_count</span> <span class="o">*</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="n">page_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pfn</span> <span class="o">=</span>
			<span class="n">virt_to_phys</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">desc_table</span><span class="p">.</span><span class="k">virtual</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&gt;&gt;</span>
			<span class="n">PAGE_SHIFT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">PAGE_SIZE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-13"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-13">&#182;</a></div><p>protection was: PAGE_READONLY</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">remap_pfn_range</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">pfn</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
				    <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_page_prot</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mmap(): remap_pfn_range() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">map_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_DONTEXPAND</span> <span class="o">|</span> <span class="n">VM_RESERVED</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VM_IO</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_private_data</span> <span class="o">=</span> <span class="n">fb</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_file</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vino_vm_ops</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">vino_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">outgoing</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-14"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-14">&#182;</a></div><p>lock mutex (?)
TODO: this has to be corrected for different read modes</p></td><td class="code"><div class="highlight"><pre>	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;poll():</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_get_outgoing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outgoing</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;poll(): vino_queue_get_outgoing() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">POLLERR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">outgoing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">over</span><span class="p">;</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">.</span><span class="n">frame_wait_queue</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vino_queue_get_outgoing</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">outgoing</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;poll(): vino_queue_get_outgoing() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">POLLERR</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">over:</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;poll(): data %savailable</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">outgoing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">outgoing</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">vino_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialization and cleanup */</span>

<span class="cm">/* __initdata */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">vino_init_stage</span><span class="p">;</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">vino_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span>     <span class="o">=</span> <span class="n">vino_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span> 	     <span class="o">=</span> <span class="n">vino_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>  	     <span class="o">=</span> <span class="n">vino_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>	     <span class="o">=</span> <span class="n">vino_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>    	     <span class="o">=</span> <span class="n">vino_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>   	     <span class="o">=</span> <span class="n">vino_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>      	     <span class="o">=</span> <span class="n">vino_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>      	     <span class="o">=</span> <span class="n">vino_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_std</span> 		     <span class="o">=</span> <span class="n">vino_g_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span> 		     <span class="o">=</span> <span class="n">vino_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querystd</span>             <span class="o">=</span> <span class="n">vino_querystd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>      	     <span class="o">=</span> <span class="n">vino_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_crop</span>       	     <span class="o">=</span> <span class="n">vino_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_crop</span>       	     <span class="o">=</span> <span class="n">vino_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_parm</span> 		     <span class="o">=</span> <span class="n">vino_s_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_parm</span> 		     <span class="o">=</span> <span class="n">vino_g_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>              <span class="o">=</span> <span class="n">vino_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>             <span class="o">=</span> <span class="n">vino_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>                 <span class="o">=</span> <span class="n">vino_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>                <span class="o">=</span> <span class="n">vino_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>             <span class="o">=</span> <span class="n">vino_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>            <span class="o">=</span> <span class="n">vino_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>            <span class="o">=</span> <span class="n">vino_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>               <span class="o">=</span> <span class="n">vino_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>               <span class="o">=</span> <span class="n">vino_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">vino_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">vino_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">vino_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">vino_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">vino_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">vino_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">vdev_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;NOT SET&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">vino_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> 	<span class="o">=</span> <span class="o">&amp;</span><span class="n">vino_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span> 	<span class="o">=</span> <span class="n">V4L2_STD_NTSC</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vino_module_cleanup</span><span class="p">(</span><span class="kt">int</span> <span class="n">stage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">stage</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">vdev</span><span class="p">);</span>
		<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">vdev</span><span class="p">);</span>
		<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">9</span>:
		<span class="n">i2c_del_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_i2c_adapter</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">free_irq</span><span class="p">(</span><span class="n">SGI_VINO_IRQ</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">vdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">vdev</span><span class="p">);</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">vdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">vdev</span><span class="p">);</span>
			<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="cm">/* all entries in dma_cpu dummy table have the same address */</span>
		<span class="n">dma_unmap_single</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
				 <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				 <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">VINO_DUMMY_DESC_COUNT</span>
				  <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">),</span>
				  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span>
				  <span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">,</span>
				  <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="n">free_page</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_page</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">kfree</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">iounmap</span><span class="p">(</span><span class="n">vino</span><span class="p">);</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;vino_module_cleanup(): invalid cleanup stage = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">stage</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rev_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ip22_is_fullhouse</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;VINO doesn&#39;t exist in IP22 Fullhouse</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">sgimc</span><span class="o">-&gt;</span><span class="n">systemid</span> <span class="o">&amp;</span> <span class="n">SGIMC_SYSID_EPRESENT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;VINO is not found (EISA BUS not present)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vino</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sgi_vino</span> <span class="o">*</span><span class="p">)</span><span class="n">ioremap</span><span class="p">(</span><span class="n">VINO_BASE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sgi_vino</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vino</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;VINO: ioremap() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_dbe</span><span class="p">(</span><span class="n">rev_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">vino</span><span class="o">-&gt;</span><span class="n">rev_id</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to read VINO revision register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VINO_ID_VALUE</span><span class="p">(</span><span class="n">rev_id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">VINO_CHIP_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unknown VINO chip ID (Rev/ID: 0x%02lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rev_id</span><span class="p">);</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;VINO revision %ld found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">VINO_REV_NUM</span><span class="p">(</span><span class="n">rev_id</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_dummy_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vino_drvdata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_settings</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vino_drvdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;vino&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">));</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* create a dummy dma descriptor */</span>
	<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_page</span> <span class="o">=</span> <span class="n">get_zeroed_page</span><span class="p">(</span><span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_page</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-15"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-15">&#182;</a></div><p>TODO: use page<em>count in dummy</em>desc_table</p></td><td class="code"><div class="highlight"><pre>	<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma_cpu</span> <span class="o">=</span>
		<span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
		<span class="n">VINO_DUMMY_DESC_COUNT</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span>
		<span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">GFP_DMA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dma_dummy_address</span> <span class="o">=</span> <span class="n">dma_map_single</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span>
					   <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_page</span><span class="p">,</span>
					<span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VINO_DUMMY_DESC_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma_cpu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dma_dummy_address</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize VINO */</span>

	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">control</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">next_4_desc</span> <span class="o">=</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">next_4_desc</span> <span class="o">=</span> <span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">dummy_desc_table</span><span class="p">.</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">VINO_DESC_FETCH_DELAY</span><span class="p">);</span>

	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">intr_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">fifo_thres</span> <span class="o">=</span> <span class="n">VINO_FIFO_THRESHOLD_DEFAULT</span><span class="p">;</span>
	<span class="n">vino</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">fifo_thres</span> <span class="o">=</span> <span class="n">VINO_FIFO_THRESHOLD_DEFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vino_init_channel_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">vino_channel_settings</span> <span class="o">*</span><span class="n">vcs</span><span class="p">,</span>
				 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">VINO_INPUT_NONE</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_format</span> <span class="o">=</span> <span class="n">VINO_DATA_FMT_GREY</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">data_norm</span> <span class="o">=</span> <span class="n">VINO_DATA_NORM_NTSC</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">decimation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vino_set_default_clipping</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>
	<span class="n">vino_set_default_framerate</span><span class="p">(</span><span class="n">vcs</span><span class="p">);</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capturing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">capture_lock</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">.</span><span class="n">queue_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">.</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">fb_queue</span><span class="p">.</span><span class="n">frame_wait_queue</span><span class="p">);</span>

	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev_template</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release</span><span class="p">;</span>
	<span class="n">vcs</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>

	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vcs</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">vcs</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">vino_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;SGI VINO driver version %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">VINO_MODULE_VERSION</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_probe</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_init</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* initialize data structures */</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">vino_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">input_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_init_channel_settings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span> <span class="n">VINO_CHANNEL_A</span><span class="p">,</span>
				    <span class="n">vino_vdev_name_a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vino_init_channel_settings</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">VINO_CHANNEL_B</span><span class="p">,</span>
				    <span class="n">vino_vdev_name_b</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* initialize hardware and register V4L devices */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">SGI_VINO_IRQ</span><span class="p">,</span> <span class="n">vino_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">vino_driver_description</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;VINO: requesting IRQ %02d failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">SGI_VINO_IRQ</span><span class="p">);</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_add_adapter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_i2c_adapter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;VINO I2C bus registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i2c_set_adapdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_i2c_adapter</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">.</span><span class="n">vdev</span><span class="p">,</span>
				    <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;VINO channel A Video4Linux-device &quot;</span>
		       <span class="s">&quot;registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">.</span><span class="n">vdev</span><span class="p">,</span>
				    <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;VINO channel B Video4Linux-device &quot;</span>
		       <span class="s">&quot;registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vino_init_stage</span><span class="o">++</span><span class="p">;</span>

	<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">decoder</span> <span class="o">=</span>
		<span class="n">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vino_i2c_adapter</span><span class="p">,</span>
			       <span class="s">&quot;saa7191&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2C_ADDRS</span><span class="p">(</span><span class="mh">0x45</span><span class="p">));</span>
	<span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">camera</span> <span class="o">=</span>
		<span class="n">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vino_drvdata</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vino_i2c_adapter</span><span class="p">,</span>
			       <span class="s">&quot;indycam&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">I2C_ADDRS</span><span class="p">(</span><span class="mh">0x2b</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;init complete!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">vino_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;exiting, stage = %d ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vino_init_stage</span><span class="p">);</span>
	<span class="n">vino_module_cleanup</span><span class="p">(</span><span class="n">vino_init_stage</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;cleanup complete, exit!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">vino_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">vino_module_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
