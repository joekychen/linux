<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › pvrusb2 › pvrusb2-encoder.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pvrusb2-encoder.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2005 Mike Isely &lt;isely@pobox.com&gt;</span>
<span class="cm"> *  Copyright (C) 2004 Aurelien Alleaume &lt;slts@free.fr&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;   </span><span class="c1">// for linux/firmware.h</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &quot;pvrusb2-util.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-encoder.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-hdw-internal.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-debug.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-fx2-cmd.h&quot;</span>



<span class="cm">/* Firmware mailbox flags - definitions found from ivtv */</span>
<span class="cp">#define IVTV_MBOX_FIRMWARE_DONE 0x00000004</span>
<span class="cp">#define IVTV_MBOX_DRIVER_DONE 0x00000002</span>
<span class="cp">#define IVTV_MBOX_DRIVER_BUSY 0x00000001</span>

<span class="cp">#define MBOX_BASE 0x44</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_encoder_write_words</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offs</span><span class="p">,</span>
				    <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bAddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunkCnt</span><span class="p">;</span>

	<span class="cm">/*</span>

<span class="cm">	Format: First byte must be 0x01.  Remaining 32 bit words are</span>
<span class="cm">	spread out into chunks of 7 bytes each, with the first 4 bytes</span>
<span class="cm">	being the data word (little endian), and the next 3 bytes</span>
<span class="cm">	being the address where that data word is to be written (big</span>
<span class="cm">	endian).  Repeat request for additional words, with offset</span>
<span class="cm">	adjusted accordingly.</span>

<span class="cm">	*/</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunkCnt</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunkCnt</span> <span class="o">&gt;</span> <span class="n">dlen</span><span class="p">)</span> <span class="n">chunkCnt</span> <span class="o">=</span> <span class="n">dlen</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">));</span>
		<span class="n">bAddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="n">bAddr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">FX2CMD_MEM_WRITE_DWORD</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">chunkCnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">offs</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="n">bAddr</span><span class="o">+</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="n">bAddr</span><span class="o">+</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="n">bAddr</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">addr</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">);</span>
			<span class="n">PVR2_DECOMPOSE_LE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span> <span class="n">bAddr</span><span class="p">,</span><span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="n">bAddr</span> <span class="o">+=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_send_request</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span>
					<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">1</span><span class="o">+</span><span class="p">(</span><span class="n">chunkCnt</span><span class="o">*</span><span class="mi">7</span><span class="p">),</span>
					<span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">chunkCnt</span><span class="p">;</span>
		<span class="n">dlen</span> <span class="o">-=</span> <span class="n">chunkCnt</span><span class="p">;</span>
		<span class="n">offs</span> <span class="o">+=</span> <span class="n">chunkCnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_encoder_read_words</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offs</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">chunkCnt</span><span class="p">;</span>

	<span class="cm">/*</span>

<span class="cm">	Format: First byte must be 0x02 (status check) or 0x28 (read</span>
<span class="cm">	back block of 32 bit words).  Next 6 bytes must be zero,</span>
<span class="cm">	followed by a single byte of MBOX_BASE+offset for portion to</span>
<span class="cm">	be read.  Returned data is packed set of 32 bits words that</span>
<span class="cm">	were read.</span>

<span class="cm">	*/</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chunkCnt</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunkCnt</span> <span class="o">&gt;</span> <span class="n">dlen</span><span class="p">)</span> <span class="n">chunkCnt</span> <span class="o">=</span> <span class="n">dlen</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chunkCnt</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="n">chunkCnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">((</span><span class="n">chunkCnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
			 <span class="n">FX2CMD_MEM_READ_DWORD</span> <span class="o">:</span> <span class="n">FX2CMD_MEM_READ_64BYTES</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">offs</span><span class="o">&gt;&gt;</span><span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">offs</span><span class="o">&gt;&gt;</span><span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">offs</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_send_request</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span>
					<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span>
					<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span>
					<span class="p">(</span><span class="n">chunkCnt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">16</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">chunkCnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">PVR2_COMPOSE_LE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="n">idx</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">data</span> <span class="o">+=</span> <span class="n">chunkCnt</span><span class="p">;</span>
		<span class="n">dlen</span> <span class="o">-=</span> <span class="n">chunkCnt</span><span class="p">;</span>
		<span class="n">offs</span> <span class="o">+=</span> <span class="n">chunkCnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This prototype is set up to be compatible with the</span>
<span class="cm">   cx2341x_mbox_func prototype in cx2341x.h, which should be in</span>
<span class="cm">   kernels 2.6.18 or later.  We do this so that we can enable</span>
<span class="cm">   cx2341x.ko to write to our encoder (by handing it a pointer to this</span>
<span class="cm">   function).  For earlier kernels this doesn&#39;t really matter. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_encoder_cmd</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ctxt</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">arg_cnt_send</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">arg_cnt_recv</span><span class="p">,</span>
			    <span class="n">u32</span> <span class="o">*</span><span class="n">argp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">poll_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">try_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retry_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="cm">/* These sizes look to be limited by the FX2 firmware implementation */</span>
	<span class="n">u32</span> <span class="n">wrData</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">rdData</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">)</span><span class="n">ctxt</span><span class="p">;</span>


	<span class="cm">/*</span>

<span class="cm">	The encoder seems to speak entirely using blocks 32 bit words.</span>
<span class="cm">	In ivtv driver terms, this is a mailbox at MBOX_BASE which we</span>
<span class="cm">	populate with data and watch what the hardware does with it.</span>
<span class="cm">	The first word is a set of flags used to control the</span>
<span class="cm">	transaction, the second word is the command to execute, the</span>
<span class="cm">	third byte is zero (ivtv driver suggests that this is some</span>
<span class="cm">	kind of return value), and the fourth byte is a specified</span>
<span class="cm">	timeout (windows driver always uses 0x00060000 except for one</span>
<span class="cm">	case when it is zero).  All successive words are the argument</span>
<span class="cm">	words for the command.</span>

<span class="cm">	First, write out the entire set of words, with the first word</span>
<span class="cm">	being zero.</span>

<span class="cm">	Next, write out just the first word again, but set it to</span>
<span class="cm">	IVTV_MBOX_DRIVER_DONE | IVTV_DRIVER_BUSY this time (which</span>
<span class="cm">	probably means &quot;go&quot;).</span>

<span class="cm">	Next, read back the return count words.  Check the first word,</span>
<span class="cm">	which should have IVTV_MBOX_FIRMWARE_DONE set.  If however</span>
<span class="cm">	that bit is not set, then the command isn&#39;t done so repeat the</span>
<span class="cm">	read until it is set.</span>

<span class="cm">	Finally, write out just the first word again, but set it to</span>
<span class="cm">	0x0 this time (which probably means &quot;idle&quot;).</span>

<span class="cm">	*/</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg_cnt_send</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wrData</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span>
			<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			<span class="s">&quot;Failed to write cx23416 command&quot;</span>
			<span class="s">&quot; - too many input arguments&quot;</span>
			<span class="s">&quot; (was given %u limit %lu)&quot;</span><span class="p">,</span>
			<span class="n">arg_cnt_send</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span><span class="p">)</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wrData</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg_cnt_recv</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rdData</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span>
			<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			<span class="s">&quot;Failed to write cx23416 command&quot;</span>
			<span class="s">&quot; - too many return arguments&quot;</span>
			<span class="s">&quot; (was given %u limit %lu)&quot;</span><span class="p">,</span>
			<span class="n">arg_cnt_recv</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span><span class="p">)</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rdData</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retry_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">try_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrData</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
		<span class="n">wrData</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">wrData</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00060000</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">arg_cnt_send</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wrData</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">argp</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wrData</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wrData</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_encoder_write_words</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">MBOX_BASE</span><span class="p">,</span><span class="n">wrData</span><span class="p">,</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">wrData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">IVTV_MBOX_DRIVER_DONE</span><span class="o">|</span><span class="n">IVTV_MBOX_DRIVER_BUSY</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_encoder_write_words</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">MBOX_BASE</span><span class="p">,</span><span class="n">wrData</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">poll_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">poll_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_encoder_read_words</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">MBOX_BASE</span><span class="p">,</span><span class="n">rdData</span><span class="p">,</span>
						      <span class="n">arg_cnt_recv</span><span class="o">+</span><span class="mi">4</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IVTV_MBOX_FIRMWARE_DONE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rdData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">poll_count</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rdData</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">retry_flag</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
				<span class="n">pvr2_trace</span><span class="p">(</span>
					<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
					<span class="s">&quot;Encoder timed out waiting for us&quot;</span>
					<span class="s">&quot;; arranging to retry&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span>
					<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
					<span class="s">&quot;***WARNING*** device&#39;s encoder&quot;</span>
					<span class="s">&quot; appears to be stuck&quot;</span>
					<span class="s">&quot; (status=0x%08x)&quot;</span><span class="p">,</span><span class="n">rdData</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;Encoder command: 0x%02x&quot;</span><span class="p">,</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">arg_cnt_send</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span>
					<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
					<span class="s">&quot;Encoder arg%d: 0x%08x&quot;</span><span class="p">,</span>
					<span class="n">idx</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="n">wrData</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retry_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">try_count</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;Too many retries...&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STBITS</span><span class="p">,</span>
				   <span class="s">&quot;State bit %s &lt;-- %s&quot;</span><span class="p">,</span>
				   <span class="s">&quot;state_encoder_ok&quot;</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STBITS</span><span class="p">,</span>
				   <span class="s">&quot;State bit %s &lt;-- %s&quot;</span><span class="p">,</span>
					   <span class="s">&quot;state_encoder_runok&quot;</span><span class="p">,</span>
					   <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span> <span class="o">?</span>
					    <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">));</span>
			<span class="p">}</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;Giving up on command.&quot;</span>
				<span class="s">&quot;  This is normally recovered via a firmware&quot;</span>
				<span class="s">&quot; reload and re-initialization; concern&quot;</span>
				<span class="s">&quot; is only warranted if this happens repeatedly&quot;</span>
				<span class="s">&quot; and rapidly.&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wrData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">arg_cnt_recv</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">argp</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">rdData</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">4</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="n">wrData</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_encoder_write_words</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">MBOX_BASE</span><span class="p">,</span><span class="n">wrData</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_encoder_vcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">args</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">vl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span>
			<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			<span class="s">&quot;Failed to write cx23416 command&quot;</span>
			<span class="s">&quot; - too many arguments&quot;</span>
			<span class="s">&quot; (was given %u limit %lu)&quot;</span><span class="p">,</span>
			<span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="kt">unsigned</span><span class="p">)</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">vl</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">vl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pvr2_encoder_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">cmd</span><span class="p">,</span><span class="n">args</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* This implements some extra setup for the encoder that seems to be</span>
<span class="cm">   specific to the PVR USB2 hardware. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_encoder_prep_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encMisc3Arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* This inexplicable bit happens in the Hauppauge windows</span>
<span class="c">	   driver (for both 24xxx and 29xxx devices).  However I</span>
<span class="c">	   currently see no difference in behavior with or without</span>
<span class="c">	   this stuff.  Leave this here as a note of its existence,</span>
<span class="c">	   but don&#39;t use it. */</span>
<span class="c">	LOCK_TAKE(hdw-&gt;ctl_lock); do {</span>
<span class="c">		u32 dat[1];</span>
<span class="c">		dat[0] = 0x80000640;</span>
<span class="c">		pvr2_encoder_write_words(hdw,0x01fe,dat,1);</span>
<span class="c">		pvr2_encoder_write_words(hdw,0x023e,dat,1);</span>
<span class="c">	} while(0); LOCK_GIVE(hdw-&gt;ctl_lock);</span>
<span class="cp">#endif</span>

	<span class="cm">/* Mike Isely &lt;isely@pobox.com&gt; 26-Jan-2006 The windows driver</span>
<span class="cm">	   sends the following list of ENC_MISC commands (for both</span>
<span class="cm">	   24xxx and 29xxx devices).  Meanings are not entirely clear,</span>
<span class="cm">	   however without the ENC_MISC(3,1) command then we risk</span>
<span class="cm">	   random perpetual video corruption whenever the video input</span>
<span class="cm">	   breaks up for a moment (like when switching channels). */</span>


<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* This ENC_MISC(5,0) command seems to hurt 29xxx sync</span>
<span class="c">	   performance on channel changes, but is not a problem on</span>
<span class="c">	   24xxx devices. */</span>
<span class="c">	ret |= pvr2_encoder_vcmd(hdw, CX2341X_ENC_MISC,4, 5,0,0,0);</span>
<span class="cp">#endif</span>

	<span class="cm">/* This ENC_MISC(3,encMisc3Arg) command is critical - without</span>
<span class="cm">	   it there will eventually be video corruption.  Also, the</span>
<span class="cm">	   saa7115 case is strange - the Windows driver is passing 1</span>
<span class="cm">	   regardless of device type but if we have 1 for saa7115</span>
<span class="cm">	   devices the video turns sluggish.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_has_cx25840</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">encMisc3Arg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">encMisc3Arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">CX2341X_ENC_MISC</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				 <span class="n">encMisc3Arg</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">CX2341X_ENC_MISC</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* This ENC_MISC(4,1) command is poisonous, so it is commented</span>
<span class="c">	   out.  But I&#39;m leaving it here anyway to document its</span>
<span class="c">	   existence in the Windows driver.  The effect of this</span>
<span class="c">	   command is that apps displaying the stream become sluggish</span>
<span class="c">	   with stuttering video. */</span>
<span class="c">	ret |= pvr2_encoder_vcmd(hdw, CX2341X_ENC_MISC,4, 4,1,0,0);</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">CX2341X_ENC_MISC</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">CX2341X_ENC_MISC</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">15</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* prevent the PTSs from slowly drifting away in the generated</span>
<span class="cm">	   MPEG stream */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">CX2341X_ENC_MISC</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pvr2_encoder_adjust</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx2341x_update</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">pvr2_encoder_cmd</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_cur_valid</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_cur_state</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">),</span>
			     <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Error from cx2341x module code=%d&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_cur_state</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx2341x_mpeg_params</span><span class="p">));</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_cur_valid</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_encoder_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ENCODER</span><span class="p">,</span><span class="s">&quot;pvr2_encoder_configure&quot;</span>
		   <span class="s">&quot; (cx2341x module)&quot;</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">.</span><span class="n">port</span> <span class="o">=</span> <span class="n">CX2341X_PORT_STREAMING</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_hor_val</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_val</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">.</span><span class="n">is_50hz</span> <span class="o">=</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="o">?</span>
				      <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_encoder_prep_config</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>

	<span class="cm">/* saa7115: 0xf0 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_has_cx25840</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* ivtv cx25840: 0x140 */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x140</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span>
		<span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_SET_NUM_VSYNC_LINES</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
		<span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/* setup firmware to notify us about some events (don&#39;t know why...) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span>
		<span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_SET_EVENT_NOTIFICATION</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x10000000</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span>
		<span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_SET_VBI_LINE</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
		<span class="mh">0xffffffff</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Failed to configure cx23416&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_encoder_adjust</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span>
		<span class="n">hdw</span><span class="p">,</span> <span class="n">CX2341X_ENC_INITIALIZE_INPUT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Failed to initialize cx23416 video input&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_encoder_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* unmask some interrupts */</span>
	<span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="mh">0xbfffffff</span><span class="p">);</span>

	<span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_MUTE_VIDEO</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
			  <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_RADIO</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">active_stream_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pvr2_config_vbi</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_START_CAPTURE</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span>
					   <span class="mh">0x01</span><span class="p">,</span><span class="mh">0x14</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_config_mpeg</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_START_CAPTURE</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span>
					   <span class="mi">0</span><span class="p">,</span><span class="mh">0x13</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* Unhandled cases for now */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_START_CAPTURE</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span>
					   <span class="mi">0</span><span class="p">,</span><span class="mh">0x13</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pvr2_encoder_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* mask all interrupts */</span>
	<span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">active_stream_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pvr2_config_vbi</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_STOP_CAPTURE</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
					   <span class="mh">0x01</span><span class="p">,</span><span class="mh">0x01</span><span class="p">,</span><span class="mh">0x14</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_config_mpeg</span>:
		<span class="n">status</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_STOP_CAPTURE</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
					   <span class="mh">0x01</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x13</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="cm">/* Unhandled cases for now */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">pvr2_encoder_vcmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">CX2341X_ENC_STOP_CAPTURE</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span>
					   <span class="mh">0x01</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mh">0x13</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  Stuff for Emacs to see, in order to encourage consistent editing style:</span>
<span class="cm">  *** Local Variables: ***</span>
<span class="cm">  *** mode: c ***</span>
<span class="cm">  *** fill-column: 70 ***</span>
<span class="cm">  *** tab-width: 8 ***</span>
<span class="cm">  *** c-basic-offset: 8 ***</span>
<span class="cm">  *** End: ***</span>
<span class="cm">  */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
