<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › pvrusb2 › pvrusb2-hdw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>pvrusb2-hdw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2005 Mike Isely &lt;isely@pobox.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>
<span class="cp">#include &quot;pvrusb2.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-std.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-util.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-hdw.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-i2c-core.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-eeprom.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-hdw-internal.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-encoder.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-debug.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-fx2-cmd.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-wm8775.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-video-v4l.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-cx2584x-v4l.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-cs53l32a.h&quot;</span>
<span class="cp">#include &quot;pvrusb2-audio.h&quot;</span>

<span class="cp">#define TV_MIN_FREQ     55250000L</span>
<span class="cp">#define TV_MAX_FREQ    850000000L</span>

<span class="cm">/* This defines a minimum interval that the decoder must remain quiet</span>
<span class="cm">   before we are allowed to start it running. */</span>
<span class="cp">#define TIME_MSEC_DECODER_WAIT 50</span>

<span class="cm">/* This defines a minimum interval that the decoder must be allowed to run</span>
<span class="cm">   before we can safely begin using its streaming output. */</span>
<span class="cp">#define TIME_MSEC_DECODER_STABILIZATION_WAIT 300</span>

<span class="cm">/* This defines a minimum interval that the encoder must remain quiet</span>
<span class="cm">   before we are allowed to configure it. */</span>
<span class="cp">#define TIME_MSEC_ENCODER_WAIT 50</span>

<span class="cm">/* This defines the minimum interval that the encoder must successfully run</span>
<span class="cm">   before we consider that the encoder has run at least once since its</span>
<span class="cm">   firmware has been loaded.  This measurement is in important for cases</span>
<span class="cm">   where we can&#39;t do something until we know that the encoder has been run</span>
<span class="cm">   at least once. */</span>
<span class="cp">#define TIME_MSEC_ENCODER_OK 250</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">unit_pointers</span><span class="p">[</span><span class="n">PVR_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{[</span> <span class="mi">0</span> <span class="p">...</span> <span class="n">PVR_NUM</span><span class="o">-</span><span class="mi">1</span> <span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">};</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pvr2_unit_mtx</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">ctlchg</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">procreload</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tuner</span><span class="p">[</span><span class="n">PVR_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">PVR_NUM</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tolerance</span><span class="p">[</span><span class="n">PVR_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">PVR_NUM</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_std</span><span class="p">[</span><span class="n">PVR_NUM</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">PVR_NUM</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">init_pause_msec</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">ctlchg</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ctlchg</span><span class="p">,</span> <span class="s">&quot;0=optimize ctl change 1=always accept new ctl value&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">init_pause_msec</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">init_pause_msec</span><span class="p">,</span> <span class="s">&quot;hardware initialization settling delay&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">procreload</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">procreload</span><span class="p">,</span>
		 <span class="s">&quot;Attempt init failure recovery with firmware reload&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">tuner</span><span class="p">,</span>    <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tuner</span><span class="p">,</span><span class="s">&quot;specify installed tuner type&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">video_std</span><span class="p">,</span>    <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video_std</span><span class="p">,</span><span class="s">&quot;specify initial video standard&quot;</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">tolerance</span><span class="p">,</span>    <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tolerance</span><span class="p">,</span><span class="s">&quot;specify stream error tolerance&quot;</span><span class="p">);</span>

<span class="cm">/* US Broadcast channel 3 (61.25 MHz), to help with testing */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_tv_freq</span>    <span class="o">=</span> <span class="mi">61250000L</span><span class="p">;</span>
<span class="cm">/* 104.3 MHz, a usable FM station for my area */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">default_radio_freq</span> <span class="o">=</span> <span class="mi">104300000L</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">tv_freq</span><span class="p">,</span> <span class="n">default_tv_freq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tv_freq</span><span class="p">,</span> <span class="s">&quot;specify initial television frequency&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">radio_freq</span><span class="p">,</span> <span class="n">default_radio_freq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">radio_freq</span><span class="p">,</span> <span class="s">&quot;specify initial radio frequency&quot;</span><span class="p">);</span>

<span class="cp">#define PVR2_CTL_WRITE_ENDPOINT  0x01</span>
<span class="cp">#define PVR2_CTL_READ_ENDPOINT   0x81</span>

<span class="cp">#define PVR2_GPIO_IN 0x9008</span>
<span class="cp">#define PVR2_GPIO_OUT 0x900c</span>
<span class="cp">#define PVR2_GPIO_DIR 0x9020</span>

<span class="cp">#define trace_firmware(...) pvr2_trace(PVR2_TRACE_FIRMWARE,__VA_ARGS__)</span>

<span class="cp">#define PVR2_FIRMWARE_ENDPOINT   0x02</span>

<span class="cm">/* size of a firmware chunk */</span>
<span class="cp">#define FIRMWARE_CHUNK_SIZE 0x2000</span>

<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">pvr2_subdev_update_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">pvr2_subdev_update_func</span> <span class="n">pvr2_module_update_functions</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_WM8775</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvr2_wm8775_subdev_update</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_SAA7115</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvr2_saa7115_subdev_update</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_MSP3400</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvr2_msp3400_subdev_update</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_CX25840</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvr2_cx25840_subdev_update</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_CS53L32A</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvr2_cs53l32a_subdev_update</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_MSP3400</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;msp3400&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_CX25840</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;cx25840&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_SAA7115</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;saa7115&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_TUNER</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;tuner&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_DEMOD</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;tuner&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_CS53L32A</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;cs53l32a&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_WM8775</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;wm8775&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">module_i2c_addresses</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_TUNER</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x60\x61\x62\x63</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_DEMOD</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x43</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_MSP3400</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x40</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_SAA7115</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x21</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_WM8775</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x1b</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_CX25840</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x44</span><span class="s">&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CLIENT_ID_CS53L32A</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;</span><span class="se">\x11</span><span class="s">&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ir_scheme_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PVR2_IR_SCHEME_NONE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;none&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_IR_SCHEME_29XXX</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;29xxx&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_IR_SCHEME_24XXX</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;24xxx (29xxx emulation)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_IR_SCHEME_24XXX_MCE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;24xxx (MCE device)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_IR_SCHEME_ZILOG</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Zilog&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* Define the list of additional controls we&#39;ll dynamically construct based</span>
<span class="cm">   on query of the cx2341x module. */</span>
<span class="k">struct</span> <span class="n">pvr2_mpeg_ids</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_mpeg_ids</span> <span class="n">mpeg_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;audio_layer&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_AUDIO_ENCODING</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;audio_bitrate&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_AUDIO_L2_BITRATE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="cm">/* Already using audio_mode elsewhere :-( */</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;mpeg_audio_mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_AUDIO_MODE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;mpeg_audio_mode_extension&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_AUDIO_MODE_EXTENSION</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;audio_emphasis&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_AUDIO_EMPHASIS</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;audio_crc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_AUDIO_CRC</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_aspect&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_ASPECT</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_b_frames&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_B_FRAMES</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_gop_size&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_SIZE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_gop_closure&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_CLOSURE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_bitrate_mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE_MODE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_bitrate&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_bitrate_peak&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE_PEAK</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_temporal_decimation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;stream_type&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_STREAM_TYPE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_spatial_filter_mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER_MODE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_spatial_filter&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_SPATIAL_FILTER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_luma_spatial_filter_type&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_SPATIAL_FILTER_TYPE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_chroma_spatial_filter_type&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_SPATIAL_FILTER_TYPE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_temporal_filter_mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER_MODE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_temporal_filter&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_TEMPORAL_FILTER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_median_filter_type&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_MEDIAN_FILTER_TYPE</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_luma_median_filter_top&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_TOP</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_luma_median_filter_bottom&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_LUMA_MEDIAN_FILTER_BOTTOM</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_chroma_median_filter_top&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_TOP</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">strid</span> <span class="o">=</span> <span class="s">&quot;video_chroma_median_filter_bottom&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_CX2341X_VIDEO_CHROMA_MEDIAN_FILTER_BOTTOM</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cp">#define MPEGDEF_COUNT ARRAY_SIZE(mpeg_ids)</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">control_values_srate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">V4L2_MPEG_AUDIO_SAMPLING_FREQ_44100</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;44.1 kHz&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">V4L2_MPEG_AUDIO_SAMPLING_FREQ_48000</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;48 kHz&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">V4L2_MPEG_AUDIO_SAMPLING_FREQ_32000</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;32 kHz&quot;</span><span class="p">,</span>
<span class="p">};</span>



<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">control_values_input</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PVR2_CVAL_INPUT_TV</span><span class="p">]</span>        <span class="o">=</span> <span class="s">&quot;television&quot;</span><span class="p">,</span>  <span class="cm">/*xawtv needs this name*/</span>
	<span class="p">[</span><span class="n">PVR2_CVAL_INPUT_DTV</span><span class="p">]</span>       <span class="o">=</span> <span class="s">&quot;dtv&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CVAL_INPUT_RADIO</span><span class="p">]</span>     <span class="o">=</span> <span class="s">&quot;radio&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CVAL_INPUT_SVIDEO</span><span class="p">]</span>    <span class="o">=</span> <span class="s">&quot;s-video&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CVAL_INPUT_COMPOSITE</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;composite&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">control_values_audiomode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">]</span>   <span class="o">=</span> <span class="s">&quot;Mono&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Stereo&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;Lang1&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">]</span>  <span class="o">=</span> <span class="s">&quot;Lang2&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Lang1+Lang2&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">control_values_hsm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PVR2_CVAL_HSM_FAIL</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Fail&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CVAL_HSM_HIGH</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;High&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_CVAL_HSM_FULL</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;Full&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pvr2_state_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PVR2_STATE_NONE</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;none&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_STATE_DEAD</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;dead&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_STATE_COLD</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;cold&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_STATE_WARM</span><span class="p">]</span> <span class="o">=</span>    <span class="s">&quot;warm&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_STATE_ERROR</span><span class="p">]</span> <span class="o">=</span>   <span class="s">&quot;error&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_STATE_READY</span><span class="p">]</span> <span class="o">=</span>   <span class="s">&quot;ready&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="n">PVR2_STATE_RUN</span><span class="p">]</span> <span class="o">=</span>     <span class="s">&quot;run&quot;</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">pvr2_fx2cmd_descdef</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_fx2cmd_descdef</span> <span class="n">pvr2_fx2cmd_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">FX2CMD_MEM_WRITE_DWORD</span><span class="p">,</span> <span class="s">&quot;write encoder dword&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_MEM_READ_DWORD</span><span class="p">,</span> <span class="s">&quot;read encoder dword&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_HCW_ZILOG_RESET</span><span class="p">,</span> <span class="s">&quot;zilog IR reset control&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_MEM_READ_64BYTES</span><span class="p">,</span> <span class="s">&quot;read encoder 64bytes&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_REG_WRITE</span><span class="p">,</span> <span class="s">&quot;write encoder register&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_REG_READ</span><span class="p">,</span> <span class="s">&quot;read encoder register&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_MEMSEL</span><span class="p">,</span> <span class="s">&quot;encoder memsel&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_I2C_WRITE</span><span class="p">,</span> <span class="s">&quot;i2c write&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_I2C_READ</span><span class="p">,</span> <span class="s">&quot;i2c read&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_GET_USB_SPEED</span><span class="p">,</span> <span class="s">&quot;get USB speed&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_STREAMING_ON</span><span class="p">,</span> <span class="s">&quot;stream on&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_STREAMING_OFF</span><span class="p">,</span> <span class="s">&quot;stream off&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_FWPOST1</span><span class="p">,</span> <span class="s">&quot;fwpost1&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_POWER_OFF</span><span class="p">,</span> <span class="s">&quot;power off&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_POWER_ON</span><span class="p">,</span> <span class="s">&quot;power on&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_DEEP_RESET</span><span class="p">,</span> <span class="s">&quot;deep reset&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_GET_EEPROM_ADDR</span><span class="p">,</span> <span class="s">&quot;get rom addr&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_GET_IR_CODE</span><span class="p">,</span> <span class="s">&quot;get IR code&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_HCW_DEMOD_RESETIN</span><span class="p">,</span> <span class="s">&quot;hcw demod resetin&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_HCW_DTV_STREAMING_ON</span><span class="p">,</span> <span class="s">&quot;hcw dtv stream on&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_HCW_DTV_STREAMING_OFF</span><span class="p">,</span> <span class="s">&quot;hcw dtv stream off&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_ONAIR_DTV_STREAMING_ON</span><span class="p">,</span> <span class="s">&quot;onair dtv stream on&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_ONAIR_DTV_STREAMING_OFF</span><span class="p">,</span> <span class="s">&quot;onair dtv stream off&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_ONAIR_DTV_POWER_ON</span><span class="p">,</span> <span class="s">&quot;onair dtv power on&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="n">FX2CMD_ONAIR_DTV_POWER_OFF</span><span class="p">,</span> <span class="s">&quot;onair dtv power off&quot;</span><span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_hdw_set_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_hdw_state_sched</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_hdw_state_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_hdw_set_cur_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_hdw_worker_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_hdw_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_hdw_untrip_unlocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_hdw_state_log_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_hdw_cmd_usbstream</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">runFl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_hdw_commit_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_hdw_get_eeprom_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_hdw_quiescent_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_hdw_decoder_stabilization_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_hdw_encoder_wait_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">pvr2_hdw_encoder_run_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">,</span><span class="n">u32</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_send_request_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span><span class="kt">int</span> <span class="n">probe_fl</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">write_data</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_len</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">read_data</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">);</span>
<span class="k">static</span> <span class="n">v4l2_std_id</span> <span class="n">pvr2_hdw_get_detected_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">trace_stbit</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STBITS</span><span class="p">,</span>
		   <span class="s">&quot;State bit %s &lt;-- %s&quot;</span><span class="p">,</span>
		   <span class="n">name</span><span class="p">,(</span><span class="n">val</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_channelfreq_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqProgSlot</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqProgSlot</span> <span class="o">&lt;=</span> <span class="n">FREQTABLE_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqTable</span><span class="p">[</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqProgSlot</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_channelfreq_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">m</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">slotId</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqProgSlot</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">slotId</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">slotId</span> <span class="o">&lt;=</span> <span class="n">FREQTABLE_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqTable</span><span class="p">[</span><span class="n">slotId</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="cm">/* Handle side effects correctly - if we&#39;re tuned to this</span>
<span class="cm">		   slot, then forgot the slot id relation since the stored</span>
<span class="cm">		   frequency has been changed. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotRadio</span> <span class="o">==</span> <span class="n">slotId</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotRadio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotTelevision</span> <span class="o">==</span> <span class="n">slotId</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotTelevision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_channelprog_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqProgSlot</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_channelprog_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">m</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">v</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;=</span> <span class="n">FREQTABLE_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqProgSlot</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_channel_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span> <span class="o">?</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotRadio</span> <span class="o">:</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotTelevision</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_channel_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">m</span><span class="p">,</span><span class="kt">int</span> <span class="n">slotId</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">freq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">slotId</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">slotId</span> <span class="o">&gt;</span> <span class="n">FREQTABLE_SIZE</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">slotId</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">freq</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqTable</span><span class="p">[</span><span class="n">slotId</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">freq</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pvr2_hdw_set_cur_freq</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">freq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotRadio</span> <span class="o">=</span> <span class="n">slotId</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotTelevision</span> <span class="o">=</span> <span class="n">slotId</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_freq_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">pvr2_hdw_get_cur_freq</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_freq_is_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqDirty</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ctrl_freq_clear_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqDirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_freq_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">m</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pvr2_hdw_set_cur_freq</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">,</span><span class="n">v</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_cropl_min_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">left</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_cropl_max_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">left</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">left</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropw_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">left</span> <span class="o">+=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropw_val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_cropt_min_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_cropt_max_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">top</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">croph_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">top</span> <span class="o">+=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">croph_val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_cropw_max_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">width</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">,</span> <span class="n">bleftend</span><span class="p">,</span> <span class="n">cleft</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">bleftend</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span><span class="o">+</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">cleft</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropl_val</span><span class="p">;</span>

	<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">cleft</span> <span class="o">&lt;</span> <span class="n">bleftend</span> <span class="o">?</span> <span class="n">bleftend</span><span class="o">-</span><span class="n">cleft</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_croph_max_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span><span class="p">,</span> <span class="n">btopend</span><span class="p">,</span> <span class="n">ctop</span><span class="p">;</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">btopend</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span><span class="o">+</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">ctop</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropt_val</span><span class="p">;</span>

	<span class="o">*</span><span class="n">height</span> <span class="o">=</span> <span class="n">ctop</span> <span class="o">&lt;</span> <span class="n">btopend</span> <span class="o">?</span> <span class="n">btopend</span><span class="o">-</span><span class="n">ctop</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcapbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcapbt</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcapbw</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcapbh</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcapdl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcapdt</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcapdw</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcapdh</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcappan</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_cropcappad</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_vres_max_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Actual maximum depends on the video standard in effect. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_vres_min_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Actual minimum depends on device digitizer type. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_has_cx25840</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="mi">75</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="mi">17</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_get_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_check_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">v</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_set_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">m</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pvr2_hdw_set_input</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">,</span><span class="n">v</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_isdirty_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_dirty</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ctrl_cleardirty_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_freq_max_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_stale</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_status_poll</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fv</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_info</span><span class="p">.</span><span class="n">rangehigh</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fv</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Safety fallback */</span>
		<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">TV_MAX_FREQ</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_info</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_CAP_LOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fv</span> <span class="o">=</span> <span class="p">(</span><span class="n">fv</span> <span class="o">*</span> <span class="mi">125</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fv</span> <span class="o">=</span> <span class="n">fv</span> <span class="o">*</span> <span class="mi">62500</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">fv</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_freq_min_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_stale</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_status_poll</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fv</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_info</span><span class="p">.</span><span class="n">rangelow</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fv</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Safety fallback */</span>
		<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">TV_MIN_FREQ</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_info</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_CAP_LOW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fv</span> <span class="o">=</span> <span class="p">(</span><span class="n">fv</span> <span class="o">*</span> <span class="mi">125</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fv</span> <span class="o">=</span> <span class="n">fv</span> <span class="o">*</span> <span class="mi">62500</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">fv</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_cx2341x_is_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_stale</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ctrl_cx2341x_clear_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_stale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_unsafe_stale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_cx2341x_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="n">c1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">c1</span><span class="p">));</span>
	<span class="n">cs</span><span class="p">.</span><span class="n">controls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c1</span><span class="p">;</span>
	<span class="n">cs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c1</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">v4l_id</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx2341x_ext_ctrls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span>
				<span class="n">VIDIOC_G_EXT_CTRLS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">c1</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_cx2341x_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">m</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="n">cs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="n">c1</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">c1</span><span class="p">));</span>
	<span class="n">cs</span><span class="p">.</span><span class="n">controls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c1</span><span class="p">;</span>
	<span class="n">cs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">c1</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">v4l_id</span><span class="p">;</span>
	<span class="n">c1</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx2341x_ext_ctrls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span>
				<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span>
				<span class="n">VIDIOC_S_EXT_CTRLS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Oops.  cx2341x is telling us it&#39;s not safe to change</span>
<span class="cm">		   this control while we&#39;re capturing.  Make a note of this</span>
<span class="cm">		   fact so that the pipeline will be stopped the next time</span>
<span class="cm">		   controls are committed.  Then go on ahead and store this</span>
<span class="cm">		   change anyway. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cx2341x_ext_ctrls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span>
					<span class="n">VIDIOC_S_EXT_CTRLS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_unsafe_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">ctrl_cx2341x_getv4lflags</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">qctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_ctl_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">qctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">v4l_id</span><span class="p">;</span>
	<span class="n">cx2341x_ctrl_query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span><span class="o">&amp;</span><span class="n">qctrl</span><span class="p">);</span>
	<span class="cm">/* Strip out the const so we can adjust a function pointer.  It&#39;s</span>
<span class="cm">	   OK to do this here because we know this is a dynamically created</span>
<span class="cm">	   control, so the underlying storage for the info pointer is (a)</span>
<span class="cm">	   private to us, and (b) not in read-only storage.  Either we do</span>
<span class="cm">	   this or we significantly complicate the underlying control</span>
<span class="cm">	   implementation. */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctl_info</span> <span class="o">*</span><span class="p">)(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">set_value</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">set_value</span> <span class="o">=</span> <span class="n">ctrl_cx2341x_set</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">qctrl</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_streamingenabled_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_masterstate_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">master_state</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_hsm_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">pvr2_hdw_is_hsm</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">PVR2_CVAL_HSM_FULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">PVR2_CVAL_HSM_FAIL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">PVR2_CVAL_HSM_HIGH</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_stddetect_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">pvr2_hdw_get_detected_std</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_stdavail_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_stdavail_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">m</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">ns</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span> <span class="o">==</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_cur</span><span class="p">.</span><span class="n">def</span><span class="p">.</span><span class="n">type_bitmask</span><span class="p">.</span><span class="n">valid_bits</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_std_val_to_sym</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">msk</span><span class="p">,</span><span class="kt">int</span> <span class="n">val</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">bufPtr</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufSize</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">pvr2_std_id_to_str</span><span class="p">(</span><span class="n">bufPtr</span><span class="p">,</span><span class="n">bufSize</span><span class="p">,</span><span class="n">msk</span> <span class="o">&amp;</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_std_sym_to_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bufPtr</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufSize</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="o">*</span><span class="n">mskp</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">valp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_std_str_to_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">id</span><span class="p">,</span><span class="n">bufPtr</span><span class="p">,</span><span class="n">bufSize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mskp</span><span class="p">)</span> <span class="o">*</span><span class="n">mskp</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">valp</span><span class="p">)</span> <span class="o">*</span><span class="n">valp</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_stdcur_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_stdcur_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="n">m</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">ns</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span><span class="p">;</span>
	<span class="n">ns</span> <span class="o">=</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">m</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span> <span class="o">==</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span> <span class="o">=</span> <span class="n">ns</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_stdcur_is_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_dirty</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ctrl_stdcur_clear_dirty</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_signal_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="n">pvr2_hdw_status_poll</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_info</span><span class="p">.</span><span class="n">signal</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ctrl_audio_modes_present_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="kt">int</span> <span class="o">*</span><span class="n">vp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">subchan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span><span class="p">;</span>
	<span class="n">pvr2_hdw_status_poll</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">subchan</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_info</span><span class="p">.</span><span class="n">rxsubchans</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subchan</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subchan</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subchan</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_LANG1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">subchan</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">vp</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#define DEFINT(vmin,vmax) \</span>
<span class="cp">	.type = pvr2_ctl_int, \</span>
<span class="cp">	.def.type_int.min_value = vmin, \</span>
<span class="cp">	.def.type_int.max_value = vmax</span>

<span class="cp">#define DEFENUM(tab) \</span>
<span class="cp">	.type = pvr2_ctl_enum, \</span>
<span class="cp">	.def.type_enum.count = ARRAY_SIZE(tab), \</span>
<span class="cp">	.def.type_enum.value_names = tab</span>

<span class="cp">#define DEFBOOL \</span>
<span class="cp">	.type = pvr2_ctl_bool</span>

<span class="cp">#define DEFMASK(msk,tab) \</span>
<span class="cp">	.type = pvr2_ctl_bitmask, \</span>
<span class="cp">	.def.type_bitmask.valid_bits = msk, \</span>
<span class="cp">	.def.type_bitmask.bit_names = tab</span>

<span class="cp">#define DEFREF(vname) \</span>
<span class="cp">	.set_value = ctrl_set_##vname, \</span>
<span class="cp">	.get_value = ctrl_get_##vname, \</span>
<span class="cp">	.is_dirty = ctrl_isdirty_##vname, \</span>
<span class="cp">	.clear_dirty = ctrl_cleardirty_##vname</span>


<span class="cp">#define VCREATE_FUNCS(vname) \</span>
<span class="cp">static int ctrl_get_##vname(struct pvr2_ctrl *cptr,int *vp) \</span>
<span class="cp">{*vp = cptr-&gt;hdw-&gt;vname##_val; return 0;} \</span>
<span class="cp">static int ctrl_set_##vname(struct pvr2_ctrl *cptr,int m,int v) \</span>
<span class="cp">{cptr-&gt;hdw-&gt;vname##_val = v; cptr-&gt;hdw-&gt;vname##_dirty = !0; return 0;} \</span>
<span class="cp">static int ctrl_isdirty_##vname(struct pvr2_ctrl *cptr) \</span>
<span class="cp">{return cptr-&gt;hdw-&gt;vname##_dirty != 0;} \</span>
<span class="cp">static void ctrl_cleardirty_##vname(struct pvr2_ctrl *cptr) \</span>
<span class="cp">{cptr-&gt;hdw-&gt;vname##_dirty = 0;}</span>

<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">brightness</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">contrast</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">saturation</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">hue</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">volume</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">balance</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">bass</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">treble</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">mute</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">cropl</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">cropt</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">cropw</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">croph</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">audiomode</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">res_hor</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">res_ver</span><span class="p">)</span>
<span class="n">VCREATE_FUNCS</span><span class="p">(</span><span class="n">srate</span><span class="p">)</span>

<span class="cm">/* Table definition of all controls which can be manipulated */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_ctl_info</span> <span class="n">control_defs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Brightness&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;brightness&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">brightness</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">255</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Contrast&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;contrast&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">68</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">contrast</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_SATURATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Saturation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;saturation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">saturation</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">127</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_HUE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Hue&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hue&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">hue</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="o">-</span><span class="mi">128</span><span class="p">,</span><span class="mi">127</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Volume&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;volume&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">62000</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">volume</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">65535</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Balance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;balance&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">balance</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">32767</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_BASS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Bass&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bass&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">bass</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">32767</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Treble&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;treble&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">treble</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="o">-</span><span class="mi">32768</span><span class="p">,</span><span class="mi">32767</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Mute&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;mute&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">mute</span><span class="p">),</span>
		<span class="n">DEFBOOL</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture crop left margin&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;crop_left&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">cropl</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="o">-</span><span class="mi">129</span><span class="p">,</span> <span class="mi">340</span><span class="p">),</span>
		<span class="p">.</span><span class="n">get_min_value</span> <span class="o">=</span> <span class="n">ctrl_cropl_min_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_max_value</span> <span class="o">=</span> <span class="n">ctrl_cropl_max_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_def_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcapdl</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture crop top margin&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;crop_top&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">cropt</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="o">-</span><span class="mi">35</span><span class="p">,</span> <span class="mi">544</span><span class="p">),</span>
		<span class="p">.</span><span class="n">get_min_value</span> <span class="o">=</span> <span class="n">ctrl_cropt_min_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_max_value</span> <span class="o">=</span> <span class="n">ctrl_cropt_max_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_def_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcapdt</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture crop width&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;crop_width&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">cropw</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">864</span><span class="p">),</span>
		<span class="p">.</span><span class="n">get_max_value</span> <span class="o">=</span> <span class="n">ctrl_cropw_max_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_def_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcapdw</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture crop height&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;crop_height&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">croph</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">576</span><span class="p">),</span>
		<span class="p">.</span><span class="n">get_max_value</span> <span class="o">=</span> <span class="n">ctrl_croph_max_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_def_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcapdh</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture capability pixel aspect numerator&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cropcap_pixel_numerator&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPCAPPAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcappan</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture capability pixel aspect denominator&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cropcap_pixel_denominator&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPCAPPAD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcappad</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture capability bounds top&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cropcap_bounds_top&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPCAPBT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcapbt</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture capability bounds left&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cropcap_bounds_left&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPCAPBL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcapbl</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture capability bounds width&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cropcap_bounds_width&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPCAPBW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcapbw</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Capture capability bounds height&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;cropcap_bounds_height&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_CROPCAPBH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_get_cropcapbh</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Video Source&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;input&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_INPUT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">PVR2_CVAL_INPUT_TV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">check_value</span> <span class="o">=</span> <span class="n">ctrl_check_input</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">input</span><span class="p">),</span>
		<span class="n">DEFENUM</span><span class="p">(</span><span class="n">control_values_input</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Audio Mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;audio_mode&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_AUDIOMODE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">audiomode</span><span class="p">),</span>
		<span class="n">DEFENUM</span><span class="p">(</span><span class="n">control_values_audiomode</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Horizontal capture resolution&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;resolution_hor&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_HRES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">res_hor</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">19</span><span class="p">,</span><span class="mi">720</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Vertical capture resolution&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;resolution_ver&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_VRES</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">res_ver</span><span class="p">),</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">17</span><span class="p">,</span><span class="mi">576</span><span class="p">),</span>
		<span class="cm">/* Hook in check for video standard and adjust maximum</span>
<span class="cm">		   depending on the standard. */</span>
		<span class="p">.</span><span class="n">get_max_value</span> <span class="o">=</span> <span class="n">ctrl_vres_max_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_min_value</span> <span class="o">=</span> <span class="n">ctrl_vres_min_get</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">V4L2_MPEG_AUDIO_SAMPLING_FREQ_48000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Audio Sampling Frequency&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;srate&quot;</span><span class="p">,</span>
		<span class="n">DEFREF</span><span class="p">(</span><span class="n">srate</span><span class="p">),</span>
		<span class="n">DEFENUM</span><span class="p">(</span><span class="n">control_values_srate</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Tuner Frequency (Hz)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;frequency&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_FREQUENCY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_value</span> <span class="o">=</span> <span class="n">ctrl_freq_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_freq_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_dirty</span> <span class="o">=</span> <span class="n">ctrl_freq_is_dirty</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clear_dirty</span> <span class="o">=</span> <span class="n">ctrl_freq_clear_dirty</span><span class="p">,</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
		<span class="cm">/* Hook in check for input value (tv/radio) and adjust</span>
<span class="cm">		   max/min values accordingly */</span>
		<span class="p">.</span><span class="n">get_max_value</span> <span class="o">=</span> <span class="n">ctrl_freq_max_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_min_value</span> <span class="o">=</span> <span class="n">ctrl_freq_min_get</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Channel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;channel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_value</span> <span class="o">=</span> <span class="n">ctrl_channel_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_channel_get</span><span class="p">,</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">FREQTABLE_SIZE</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Channel Program Frequency&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;freq_table_value&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_value</span> <span class="o">=</span> <span class="n">ctrl_channelfreq_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_channelfreq_get</span><span class="p">,</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
		<span class="cm">/* Hook in check for input value (tv/radio) and adjust</span>
<span class="cm">		   max/min values accordingly */</span>
		<span class="p">.</span><span class="n">get_max_value</span> <span class="o">=</span> <span class="n">ctrl_freq_max_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_min_value</span> <span class="o">=</span> <span class="n">ctrl_freq_min_get</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Channel Program ID&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;freq_table_channel&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_value</span> <span class="o">=</span> <span class="n">ctrl_channelprog_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_channelprog_get</span><span class="p">,</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">FREQTABLE_SIZE</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Streaming Enabled&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;streaming_enabled&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_streamingenabled_get</span><span class="p">,</span>
		<span class="n">DEFBOOL</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;USB Speed&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;usb_speed&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_hsm_get</span><span class="p">,</span>
		<span class="n">DEFENUM</span><span class="p">(</span><span class="n">control_values_hsm</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Master State&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;master_state&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_masterstate_get</span><span class="p">,</span>
		<span class="n">DEFENUM</span><span class="p">(</span><span class="n">pvr2_state_names</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Signal Present&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;signal_present&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_signal_get</span><span class="p">,</span>
		<span class="n">DEFINT</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">65535</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Audio Modes Present&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;audio_modes_present&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_audio_modes_present_get</span><span class="p">,</span>
		<span class="cm">/* For this type we &quot;borrow&quot; the V4L2_TUNER_MODE enum from</span>
<span class="cm">		   v4l.  Nothing outside of this module cares about this,</span>
<span class="cm">		   but I reuse it in order to also reuse the</span>
<span class="cm">		   control_values_audiomode string table. */</span>
		<span class="n">DEFMASK</span><span class="p">(((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">)</span><span class="o">|</span>
			 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">)</span><span class="o">|</span>
			 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">)</span><span class="o">|</span>
			 <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">)),</span>
			<span class="n">control_values_audiomode</span><span class="p">),</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Video Standards Available Mask&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;video_standard_mask_available&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_STDAVAIL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">skip_init</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_stdavail_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_value</span> <span class="o">=</span> <span class="n">ctrl_stdavail_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">val_to_sym</span> <span class="o">=</span> <span class="n">ctrl_std_val_to_sym</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_to_val</span> <span class="o">=</span> <span class="n">ctrl_std_sym_to_val</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">pvr2_ctl_bitmask</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Video Standards In Use Mask&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;video_standard_mask_active&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_STDCUR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">skip_init</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_stdcur_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set_value</span> <span class="o">=</span> <span class="n">ctrl_stdcur_set</span><span class="p">,</span>
		<span class="p">.</span><span class="n">is_dirty</span> <span class="o">=</span> <span class="n">ctrl_stdcur_is_dirty</span><span class="p">,</span>
		<span class="p">.</span><span class="n">clear_dirty</span> <span class="o">=</span> <span class="n">ctrl_stdcur_clear_dirty</span><span class="p">,</span>
		<span class="p">.</span><span class="n">val_to_sym</span> <span class="o">=</span> <span class="n">ctrl_std_val_to_sym</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_to_val</span> <span class="o">=</span> <span class="n">ctrl_std_sym_to_val</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">pvr2_ctl_bitmask</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">desc</span> <span class="o">=</span> <span class="s">&quot;Video Standards Detected Mask&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;video_standard_mask_detected&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">internal_id</span> <span class="o">=</span> <span class="n">PVR2_CID_STDDETECT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">skip_init</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_stddetect_get</span><span class="p">,</span>
		<span class="p">.</span><span class="n">val_to_sym</span> <span class="o">=</span> <span class="n">ctrl_std_val_to_sym</span><span class="p">,</span>
		<span class="p">.</span><span class="n">sym_to_val</span> <span class="o">=</span> <span class="n">ctrl_std_sym_to_val</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">pvr2_ctl_bitmask</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define CTRLDEF_COUNT ARRAY_SIZE(control_defs)</span>


<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pvr2_config_get_name</span><span class="p">(</span><span class="k">enum</span> <span class="n">pvr2_config</span> <span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cfg</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pvr2_config_empty</span>: <span class="k">return</span> <span class="s">&quot;empty&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_config_mpeg</span>: <span class="k">return</span> <span class="s">&quot;mpeg&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_config_vbi</span>: <span class="k">return</span> <span class="s">&quot;vbi&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_config_pcm</span>: <span class="k">return</span> <span class="s">&quot;pcm&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_config_rawvideo</span>: <span class="k">return</span> <span class="s">&quot;raw video&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;&lt;unknown&gt;&quot;</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pvr2_hdw_get_sn</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_bus_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_device_identifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">identifier</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pvr2_hdw_get_cur_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span> <span class="o">?</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqValTelevision</span> <span class="o">:</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqValRadio</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the currently tuned frequency and account for all possible</span>
<span class="cm">   driver-core side effects of this action. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_set_cur_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Swing over to radio frequency selection */</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqDirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqValRadio</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqValRadio</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotRadio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqDirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Swing over to television frequency selection */</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqDirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqValTelevision</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqValTelevision</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSlotTelevision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqDirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">pvr2_hdw_get_unit_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Attempt to locate one of the given set of files.  Messages are logged</span>
<span class="cm">   appropriate to what has been found.  The return value will be 0 or</span>
<span class="cm">   greater on success (it will be the index of the file name found) and</span>
<span class="cm">   fw_entry will be filled in.  Otherwise a negative error is returned on</span>
<span class="cm">   failure.  If the return value is -ENOENT then no viable firmware file</span>
<span class="cm">   could be located. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_locate_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw_entry</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fwtypename</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fwcount</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fwnames</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">fwcount</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">,</span>
				       <span class="n">fwnames</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
				       <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">trace_firmware</span><span class="p">(</span><span class="s">&quot;Located %s firmware: %s;&quot;</span>
				       <span class="s">&quot; uploading...&quot;</span><span class="p">,</span>
				       <span class="n">fwtypename</span><span class="p">,</span>
				       <span class="n">fwnames</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
			<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;request_firmware fatal error with code=%d&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
		   <span class="s">&quot;***WARNING***&quot;</span>
		   <span class="s">&quot; Device %s firmware&quot;</span>
		   <span class="s">&quot; seems to be missing.&quot;</span><span class="p">,</span>
		   <span class="n">fwtypename</span><span class="p">);</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
		   <span class="s">&quot;Did you install the pvrusb2 firmware files&quot;</span>
		   <span class="s">&quot; in their proper location?&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fwcount</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;request_firmware unable to locate %s file %s&quot;</span><span class="p">,</span>
			   <span class="n">fwtypename</span><span class="p">,</span><span class="n">fwnames</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;request_firmware unable to locate&quot;</span>
			   <span class="s">&quot; one of the following %s files:&quot;</span><span class="p">,</span>
			   <span class="n">fwtypename</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">fwcount</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				   <span class="s">&quot;request_firmware: Failed to find %s&quot;</span><span class="p">,</span>
				   <span class="n">fwnames</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * pvr2_upload_firmware1().</span>
<span class="cm"> *</span>
<span class="cm"> * Send the 8051 firmware to the device.  After the upload, arrange for</span>
<span class="cm"> * device to re-enumerate.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE : the pointer to the firmware data given by request_firmware()</span>
<span class="cm"> * is not suitable for an usb transaction.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_upload_firmware1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span>  <span class="o">*</span><span class="n">fw_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fwsize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">address</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">fx2_firmware</span><span class="p">.</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">=</span> <span class="n">FW1_STATE_OK</span><span class="p">;</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Connected device type defines&quot;</span>
			   <span class="s">&quot; no firmware to upload; ignoring firmware&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">=</span> <span class="n">FW1_STATE_FAILED</span><span class="p">;</span> <span class="c1">// default result</span>

	<span class="n">trace_firmware</span><span class="p">(</span><span class="s">&quot;pvr2_upload_firmware1&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_locate_firmware</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span><span class="s">&quot;fx2 controller&quot;</span><span class="p">,</span>
				   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">fx2_firmware</span><span class="p">.</span><span class="n">cnt</span><span class="p">,</span>
				   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">fx2_firmware</span><span class="p">.</span><span class="n">lst</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">=</span> <span class="n">FW1_STATE_MISSING</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usb_clear_halt</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">));</span>

	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">fwsize</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">fwsize</span> <span class="o">!=</span> <span class="mh">0x2000</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_fx2_16kb</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">fwsize</span> <span class="o">==</span> <span class="mh">0x4000</span><span class="p">))))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_fx2_16kb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				   <span class="s">&quot;Wrong fx2 firmware size&quot;</span>
				   <span class="s">&quot; (expected 8192 or 16384, got %u)&quot;</span><span class="p">,</span>
				   <span class="n">fwsize</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				   <span class="s">&quot;Wrong fx2 firmware size&quot;</span>
				   <span class="s">&quot; (expected 8192, got %u)&quot;</span><span class="p">,</span>
				   <span class="n">fwsize</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mh">0x800</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have to hold the CPU during firmware upload. */</span>
	<span class="n">pvr2_hdw_cpureset_assert</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* upload the firmware to address 0000-1fff in 2048 (=0x800) bytes</span>
<span class="cm">	   chunk. */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">fwsize</span><span class="p">;</span> <span class="n">address</span> <span class="o">+=</span> <span class="mh">0x800</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_ptr</span><span class="p">,</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">address</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">+=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">address</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="n">fw_ptr</span><span class="p">,</span> <span class="mh">0x800</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">trace_firmware</span><span class="p">(</span><span class="s">&quot;Upload done, releasing device&#39;s CPU&quot;</span><span class="p">);</span>

	<span class="cm">/* Now release the CPU.  It will disconnect and reconnect later. */</span>
	<span class="n">pvr2_hdw_cpureset_assert</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fw_ptr</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>

	<span class="n">trace_firmware</span><span class="p">(</span><span class="s">&quot;Upload done (%d bytes sent)&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* We should have written fwsize bytes */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">fwsize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">=</span> <span class="n">FW1_STATE_RELOAD</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * pvr2_upload_firmware2()</span>
<span class="cm"> *</span>
<span class="cm"> * This uploads encoder firmware on endpoint 2.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">pvr2_upload_firmware2</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_entry</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">void</span>  <span class="o">*</span><span class="n">fw_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">fw_len</span><span class="p">,</span> <span class="n">fw_done</span><span class="p">,</span> <span class="n">bcnt</span><span class="p">,</span> <span class="n">icnt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">actual_length</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fwidx</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fw_files</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">CX2341X_FIRM_ENC_FILENAME</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_skip_cx23416_firmware</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_firmware</span><span class="p">(</span><span class="s">&quot;pvr2_upload_firmware2&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_locate_firmware</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fw_entry</span><span class="p">,</span><span class="s">&quot;encoder&quot;</span><span class="p">,</span>
				   <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fw_files</span><span class="p">),</span> <span class="n">fw_files</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">fwidx</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Since we&#39;re about to completely reinitialize the encoder,</span>
<span class="cm">	   invalidate our cached copy of its configuration state.  Next</span>
<span class="cm">	   time we configure the encoder, then we&#39;ll fully configure it. */</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_cur_valid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Encoder is about to be reset so note that as far as we&#39;re</span>
<span class="cm">	   concerned now, the encoder has never been run. */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_encoder_runok&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* First prepare firmware loading */</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x0048</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span> <span class="cm">/*interrupt mask*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_hdw_gpio_chg_dir</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="mh">0x00000088</span><span class="p">);</span> <span class="cm">/*gpio dir*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_hdw_gpio_chg_out</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="mh">0x00000008</span><span class="p">);</span> <span class="cm">/*gpio output state*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_hdw_cmd_deep_reset</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0xa064</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span> <span class="cm">/*APU command*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_hdw_gpio_chg_dir</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="mh">0x00000408</span><span class="p">);</span> <span class="cm">/*gpio dir*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_hdw_gpio_chg_out</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mh">0xffffffff</span><span class="p">,</span><span class="mh">0x00000008</span><span class="p">);</span> <span class="cm">/*gpio output state*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x9058</span><span class="p">,</span> <span class="mh">0xffffffed</span><span class="p">);</span> <span class="cm">/*VPU ctrl*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x9054</span><span class="p">,</span> <span class="mh">0xfffffffd</span><span class="p">);</span> <span class="cm">/*reset hw blocks*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x07f8</span><span class="p">,</span> <span class="mh">0x80000800</span><span class="p">);</span> <span class="cm">/*encoder SDRAM refresh*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x07fc</span><span class="p">,</span> <span class="mh">0x0000001a</span><span class="p">);</span> <span class="cm">/*encoder SDRAM pre-charge*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x0700</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span> <span class="cm">/*I2C clock*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0xaa00</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span> <span class="cm">/*unknown*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0xaa04</span><span class="p">,</span> <span class="mh">0x00057810</span><span class="p">);</span> <span class="cm">/*unknown*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0xaa10</span><span class="p">,</span> <span class="mh">0x00148500</span><span class="p">);</span> <span class="cm">/*unknown*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0xaa18</span><span class="p">,</span> <span class="mh">0x00840000</span><span class="p">);</span> <span class="cm">/*unknown*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">FX2CMD_FWPOST1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">FX2CMD_MEMSEL</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;firmware2 upload prep failed, ret=%d&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now send firmware */</span>

	<span class="n">fw_len</span> <span class="o">=</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_len</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;size of %s firmware&quot;</span>
			   <span class="s">&quot; must be a multiple of %zu bytes&quot;</span><span class="p">,</span>
			   <span class="n">fw_files</span><span class="p">[</span><span class="n">fwidx</span><span class="p">],</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fw_ptr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">FIRMWARE_CHUNK_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw_ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">){</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;failed to allocate memory for firmware2 upload&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">PVR2_FIRMWARE_ENDPOINT</span><span class="p">);</span>

	<span class="n">fw_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">fw_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">fw_done</span> <span class="o">&lt;</span> <span class="n">fw_len</span><span class="p">;)</span> <span class="p">{</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="n">fw_len</span> <span class="o">-</span> <span class="n">fw_done</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bcnt</span> <span class="o">&gt;</span> <span class="n">FIRMWARE_CHUNK_SIZE</span><span class="p">)</span> <span class="n">bcnt</span> <span class="o">=</span> <span class="n">FIRMWARE_CHUNK_SIZE</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fw_ptr</span><span class="p">,</span> <span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">fw_done</span><span class="p">,</span> <span class="n">bcnt</span><span class="p">);</span>
		<span class="cm">/* Usbsnoop log shows that we must swap bytes... */</span>
		<span class="cm">/* Some background info: The data being swapped here is a</span>
<span class="cm">		   firmware image destined for the mpeg encoder chip that</span>
<span class="cm">		   lives at the other end of a USB endpoint.  The encoder</span>
<span class="cm">		   chip always talks in 32 bit chunks and its storage is</span>
<span class="cm">		   organized into 32 bit words.  However from the file</span>
<span class="cm">		   system to the encoder chip everything is purely a byte</span>
<span class="cm">		   stream.  The firmware file&#39;s contents are always 32 bit</span>
<span class="cm">		   swapped from what the encoder expects.  Thus the need</span>
<span class="cm">		   always exists to swap the bytes regardless of the endian</span>
<span class="cm">		   type of the host processor and therefore swab32() makes</span>
<span class="cm">		   the most sense. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">icnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">icnt</span> <span class="o">&lt;</span> <span class="n">bcnt</span><span class="o">/</span><span class="mi">4</span> <span class="p">;</span> <span class="n">icnt</span><span class="o">++</span><span class="p">)</span>
			<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_ptr</span><span class="p">)[</span><span class="n">icnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_ptr</span><span class="p">)[</span><span class="n">icnt</span><span class="p">]);</span>

		<span class="n">ret</span> <span class="o">|=</span> <span class="n">usb_bulk_msg</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">pipe</span><span class="p">,</span> <span class="n">fw_ptr</span><span class="p">,</span><span class="n">bcnt</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">actual_length</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">actual_length</span> <span class="o">!=</span> <span class="n">bcnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">fw_done</span> <span class="o">+=</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_firmware</span><span class="p">(</span><span class="s">&quot;upload of %s : %i / %i &quot;</span><span class="p">,</span>
		       <span class="n">fw_files</span><span class="p">[</span><span class="n">fwidx</span><span class="p">],</span><span class="n">fw_done</span><span class="p">,</span><span class="n">fw_len</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">fw_ptr</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw_entry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;firmware2 upload transfer failure&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finish upload */</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x9054</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">);</span> <span class="cm">/*reset hw blocks*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0x9058</span><span class="p">,</span> <span class="mh">0xffffffe8</span><span class="p">);</span> <span class="cm">/*VPU ctrl*/</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">FX2CMD_MEMSEL</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;firmware2 upload post-proc failure&quot;</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">signal_routing_scheme</span> <span class="o">==</span>
	    <span class="n">PVR2_ROUTING_SCHEME_GOTVIEW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ensure that GPIO 11 is set to output for GOTVIEW</span>
<span class="cm">		   hardware. */</span>
		<span class="n">pvr2_hdw_gpio_chg_dir</span><span class="p">(</span><span class="n">hdw</span><span class="p">,(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pvr2_get_state_name</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pvr2_state_names</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">pvr2_state_names</span><span class="p">[</span><span class="n">st</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;???&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_decoder_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">enablefl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Even though we really only care about the video decoder chip at</span>
<span class="cm">	   this point, we&#39;ll broadcast stream on/off to all sub-devices</span>
<span class="cm">	   anyway, just in case somebody else wants to hear the</span>
<span class="cm">	   command... */</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CHIPS</span><span class="p">,</span> <span class="s">&quot;subdev v4l2 stream=%s&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">enablefl</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">));</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="n">enablefl</span><span class="p">);</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="n">enablefl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_client_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We get here if the encoder has been noticed.  Otherwise</span>
<span class="cm">		   we&#39;ll issue a warning to the user (which should</span>
<span class="cm">		   normally never happen). */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_decoder_missed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;WARNING: No decoder present&quot;</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_decoder_missed</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;flag_decoder_missed&quot;</span><span class="p">,</span>
			    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_decoder_missed</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">master_state</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_untrip_unlocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_tripped</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_tripped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
		   <span class="s">&quot;Clearing driver error statuss&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_untrip</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fl</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">fl</span> <span class="o">=</span> <span class="n">pvr2_hdw_untrip_unlocked</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="p">)</span> <span class="n">pvr2_hdw_state_sched</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>




<span class="kt">int</span> <span class="nf">pvr2_hdw_get_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_set_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">enable_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span><span class="n">st</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_untrip_unlocked</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">enable_flag</span><span class="p">)</span> <span class="o">!=</span> <span class="o">!</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span> <span class="o">=</span> <span class="n">enable_flag</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_START_STOP</span><span class="p">,</span>
				   <span class="s">&quot;/*--TRACE_STREAM--*/ %s&quot;</span><span class="p">,</span>
				   <span class="n">enable_flag</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pvr2_hdw_state_sched</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_hdw_wait</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">st</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">master_state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">PVR2_STATE_RUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">!=</span> <span class="n">PVR2_STATE_READY</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_hdw_wait</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">st</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_set_stream_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="k">enum</span> <span class="n">pvr2_config</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fl</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fl</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">desired_stream_type</span> <span class="o">!=</span> <span class="n">config</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">desired_stream_type</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_pipeline_config&quot;</span><span class="p">,</span>
			    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span><span class="p">);</span>
		<span class="n">pvr2_hdw_state_sched</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pvr2_hdw_wait</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_default_tuner_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unit_number</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">unit_number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">unit_number</span> <span class="o">&lt;</span> <span class="n">PVR_NUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="n">tuner</span><span class="p">[</span><span class="n">unit_number</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">=</span> <span class="n">tp</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_updated</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">v4l2_std_id</span> <span class="nf">get_default_standard</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unit_number</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">unit_number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">unit_number</span> <span class="o">&lt;</span> <span class="n">PVR_NUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="n">video_std</span><span class="p">[</span><span class="n">unit_number</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="k">return</span> <span class="n">tp</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">get_default_error_tolerance</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unit_number</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">unit_number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">unit_number</span> <span class="o">&lt;</span> <span class="n">PVR_NUM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tp</span> <span class="o">=</span> <span class="n">tolerance</span><span class="p">[</span><span class="n">unit_number</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tp</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_check_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Try a harmless request to fetch the eeprom&#39;s address over</span>
<span class="cm">	   endpoint 1.  See what happens.  Only the full FX2 image can</span>
<span class="cm">	   respond to this.  If this probe fails then likely the FX2</span>
<span class="cm">	   firmware needs be loaded. */</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FX2CMD_GET_EEPROM_ADDR</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">pvr2_send_request_ex</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">HZ</span><span class="o">*</span><span class="mi">1</span><span class="p">,</span><span class="o">!</span><span class="mi">0</span><span class="p">,</span>
					   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
					   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
			   <span class="s">&quot;Probe of device endpoint 1 result status %d&quot;</span><span class="p">,</span>
			   <span class="n">result</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
			   <span class="s">&quot;Probe of device endpoint 1 succeeded&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">pvr2_std_hack</span> <span class="p">{</span>
	<span class="n">v4l2_std_id</span> <span class="n">pat</span><span class="p">;</span>  <span class="cm">/* Pattern to match */</span>
	<span class="n">v4l2_std_id</span> <span class="n">msk</span><span class="p">;</span>  <span class="cm">/* Which bits we care about */</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>  <span class="cm">/* What additional standards or default to set */</span>
<span class="p">};</span>

<span class="cm">/* This data structure labels specific combinations of standards from</span>
<span class="cm">   tveeprom that we&#39;ll try to recognize.  If we recognize one, then assume</span>
<span class="cm">   a specified default standard to use.  This is here because tveeprom only</span>
<span class="cm">   tells us about available standards not the intended default standard (if</span>
<span class="cm">   any) for the device in question.  We guess the default based on what has</span>
<span class="cm">   been reported as available.  Note that this is only for guessing a</span>
<span class="cm">   default - which can always be overridden explicitly - and if the user</span>
<span class="cm">   has otherwise named a default then that default will always be used in</span>
<span class="cm">   place of this table. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_std_hack</span> <span class="n">std_eeprom_maps</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="cm">/* PAL(B/G) */</span>
		<span class="p">.</span><span class="n">pat</span> <span class="o">=</span> <span class="n">V4L2_STD_B</span><span class="o">|</span><span class="n">V4L2_STD_GH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_B</span><span class="o">|</span><span class="n">V4L2_STD_PAL_B1</span><span class="o">|</span><span class="n">V4L2_STD_PAL_G</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* NTSC(M) */</span>
		<span class="p">.</span><span class="n">pat</span> <span class="o">=</span> <span class="n">V4L2_STD_MN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* PAL(I) */</span>
		<span class="p">.</span><span class="n">pat</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* SECAM(L/L&#39;) */</span>
		<span class="p">.</span><span class="n">pat</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_L</span><span class="o">|</span><span class="n">V4L2_STD_SECAM_LC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_L</span><span class="o">|</span><span class="n">V4L2_STD_SECAM_LC</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>	<span class="cm">/* PAL(D/D1/K) */</span>
		<span class="p">.</span><span class="n">pat</span> <span class="o">=</span> <span class="n">V4L2_STD_DK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_D</span><span class="o">|</span><span class="n">V4L2_STD_PAL_D1</span><span class="o">|</span><span class="n">V4L2_STD_PAL_K</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_setup_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bcnt</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">std1</span><span class="p">,</span><span class="n">std2</span><span class="p">,</span><span class="n">std3</span><span class="p">;</span>

	<span class="n">std1</span> <span class="o">=</span> <span class="n">get_default_standard</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">std3</span> <span class="o">=</span> <span class="n">std1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">default_std_mask</span><span class="p">;</span>

	<span class="n">bcnt</span> <span class="o">=</span> <span class="n">pvr2_std_id_to_str</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_eeprom</span><span class="p">);</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STD</span><span class="p">,</span>
		   <span class="s">&quot;Supported video standard(s) reported available&quot;</span>
		   <span class="s">&quot; in hardware: %.*s&quot;</span><span class="p">,</span>
		   <span class="n">bcnt</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_eeprom</span><span class="p">;</span>

	<span class="n">std2</span> <span class="o">=</span> <span class="p">(</span><span class="n">std1</span><span class="o">|</span><span class="n">std3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">std2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="n">pvr2_std_id_to_str</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span><span class="n">std2</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STD</span><span class="p">,</span>
			   <span class="s">&quot;Expanding supported video standards&quot;</span>
			   <span class="s">&quot; to include: %.*s&quot;</span><span class="p">,</span>
			   <span class="n">bcnt</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span> <span class="o">|=</span> <span class="n">std2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_cur</span><span class="p">.</span><span class="n">def</span><span class="p">.</span><span class="n">type_bitmask</span><span class="p">.</span><span class="n">valid_bits</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="n">pvr2_std_id_to_str</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span><span class="n">std1</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STD</span><span class="p">,</span>
			   <span class="s">&quot;Initial video standard forced to %.*s&quot;</span><span class="p">,</span>
			   <span class="n">bcnt</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span> <span class="o">=</span> <span class="n">std1</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">std3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="n">pvr2_std_id_to_str</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span><span class="n">std3</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STD</span><span class="p">,</span>
			   <span class="s">&quot;Initial video standard&quot;</span>
			   <span class="s">&quot; (determined by device type): %.*s&quot;</span><span class="p">,</span><span class="n">bcnt</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span> <span class="o">=</span> <span class="n">std3</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">std_eeprom_maps</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">std_eeprom_maps</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">msk</span> <span class="o">?</span>
			    <span class="p">((</span><span class="n">std_eeprom_maps</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pat</span> <span class="o">^</span>
			     <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_eeprom</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">std_eeprom_maps</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">msk</span><span class="p">)</span> <span class="o">:</span>
			    <span class="p">(</span><span class="n">std_eeprom_maps</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pat</span> <span class="o">!=</span>
			     <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_eeprom</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
			<span class="n">bcnt</span> <span class="o">=</span> <span class="n">pvr2_std_id_to_str</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span>
						  <span class="n">std_eeprom_maps</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">std</span><span class="p">);</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STD</span><span class="p">,</span>
				   <span class="s">&quot;Initial video standard guessed as %.*s&quot;</span><span class="p">,</span>
				   <span class="n">bcnt</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span> <span class="o">=</span> <span class="n">std_eeprom_maps</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pvr2_copy_i2c_addr_list</span><span class="p">(</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dst_max</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">src</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">src</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">dst_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">src</span><span class="p">[</span><span class="n">cnt</span><span class="p">];</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dst</span><span class="p">[</span><span class="n">cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">I2C_CLIENT_END</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">cnt</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_cx25840_vbi_hack</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	  Mike Isely &lt;isely@pobox.com&gt; 19-Nov-2006 - This bit of nuttiness</span>
<span class="cm">	  for cx25840 causes that module to correctly set up its video</span>
<span class="cm">	  scaling.  This is really a problem in the cx25840 module itself,</span>
<span class="cm">	  but we work around it here.  The problem has not been seen in</span>
<span class="cm">	  ivtv because there VBI is supported and set up.  We don&#39;t do VBI</span>
<span class="cm">	  here (at least not yet) and thus we never attempted to even set</span>
<span class="cm">	  it up.</span>
<span class="cm">	*/</span>
	<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_client_id</span> <span class="o">!=</span> <span class="n">PVR2_CLIENT_ID_CX25840</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We&#39;re not using a cx25840 so don&#39;t enable the hack */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
		   <span class="s">&quot;Module ID %u:&quot;</span>
		   <span class="s">&quot; Executing cx25840 VBI hack&quot;</span><span class="p">,</span>
		   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_client_id</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="p">));</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_SLICED_VBI_CAPTURE</span><span class="p">;</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">.</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">;</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">.</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">;</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_client_id</span><span class="p">,</span>
			     <span class="n">vbi</span><span class="p">,</span> <span class="n">s_sliced_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_load_subdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_device_client_desc</span> <span class="o">*</span><span class="n">cd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fname</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">mid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i2ccnt</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="cm">/* Arbitrary count - max # i2c addresses we will probe */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">i2caddr</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>

	<span class="n">mid</span> <span class="o">=</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">module_id</span><span class="p">;</span>
	<span class="n">fname</span> <span class="o">=</span> <span class="p">(</span><span class="n">mid</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">module_names</span><span class="p">))</span> <span class="o">?</span> <span class="n">module_names</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fname</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Module ID %u for device %s has no name?&quot;</span>
			   <span class="s">&quot;  The driver might have a configuration problem.&quot;</span><span class="p">,</span>
			   <span class="n">mid</span><span class="p">,</span>
			   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
		   <span class="s">&quot;Module ID %u (%s) for device %s being loaded...&quot;</span><span class="p">,</span>
		   <span class="n">mid</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span>
		   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">);</span>

	<span class="n">i2ccnt</span> <span class="o">=</span> <span class="n">pvr2_copy_i2c_addr_list</span><span class="p">(</span><span class="n">i2caddr</span><span class="p">,</span> <span class="n">cd</span><span class="o">-&gt;</span><span class="n">i2c_address_list</span><span class="p">,</span>
					 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">i2caddr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2ccnt</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">mid</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">module_i2c_addresses</span><span class="p">))</span> <span class="o">?</span>
			 <span class="n">module_i2c_addresses</span><span class="p">[</span><span class="n">mid</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Second chance: Try default i2c address list */</span>
		<span class="n">i2ccnt</span> <span class="o">=</span> <span class="n">pvr2_copy_i2c_addr_list</span><span class="p">(</span><span class="n">i2caddr</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span>
						 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">i2caddr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2ccnt</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
				   <span class="s">&quot;Module ID %u:&quot;</span>
				   <span class="s">&quot; Using default i2c address list&quot;</span><span class="p">,</span>
				   <span class="n">mid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2ccnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Module ID %u (%s) for device %s:&quot;</span>
			   <span class="s">&quot; No i2c addresses.&quot;</span>
			   <span class="s">&quot;  The driver might have a configuration problem.&quot;</span><span class="p">,</span>
			   <span class="n">mid</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2ccnt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
			   <span class="s">&quot;Module ID %u:&quot;</span>
			   <span class="s">&quot; Setting up with specified i2c address 0x%x&quot;</span><span class="p">,</span>
			   <span class="n">mid</span><span class="p">,</span> <span class="n">i2caddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">sd</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
					 <span class="n">fname</span><span class="p">,</span> <span class="n">i2caddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
			   <span class="s">&quot;Module ID %u:&quot;</span>
			   <span class="s">&quot; Setting up with address probe list&quot;</span><span class="p">,</span>
			   <span class="n">mid</span><span class="p">);</span>
		<span class="n">sd</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
					 <span class="n">fname</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i2caddr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Module ID %u (%s) for device %s failed to load.&quot;</span>
			   <span class="s">&quot;  Possible missing sub-device kernel module or&quot;</span>
			   <span class="s">&quot; initialization failure within module.&quot;</span><span class="p">,</span>
			   <span class="n">mid</span><span class="p">,</span> <span class="n">fname</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Tag this sub-device instance with the module ID we know about.</span>
<span class="cm">	   In other places we&#39;ll use that tag to determine if the instance</span>
<span class="cm">	   requires special handling. */</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>

	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INFO</span><span class="p">,</span> <span class="s">&quot;Attached sub-driver %s&quot;</span><span class="p">,</span> <span class="n">fname</span><span class="p">);</span>


	<span class="cm">/* client-specific setup... */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PVR2_CLIENT_ID_CX25840</span>:
	<span class="k">case</span> <span class="n">PVR2_CLIENT_ID_SAA7115</span>:
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_client_id</span> <span class="o">=</span> <span class="n">mid</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_load_modules</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_string_table</span> <span class="o">*</span><span class="n">cm</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_device_client_table</span> <span class="o">*</span><span class="n">ct</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">okFl</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">cm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">client_modules</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">cm</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="n">cm</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">ct</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">client_table</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ct</span><span class="o">-&gt;</span><span class="n">cnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_hdw_load_subdev</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">lst</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">okFl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">okFl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_modulefail</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">pvr2_hdw_render_useless</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_setup_low</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reloadFl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">fx2_firmware</span><span class="p">.</span><span class="n">cnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reloadFl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reloadFl</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span>
				 <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reloadFl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
					   <span class="s">&quot;USB endpoint config looks strange&quot;</span>
					   <span class="s">&quot;; possibly firmware needs to be&quot;</span>
					   <span class="s">&quot; loaded&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reloadFl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reloadFl</span> <span class="o">=</span> <span class="o">!</span><span class="n">pvr2_hdw_check_firmware</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reloadFl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
					   <span class="s">&quot;Check for FX2 firmware failed&quot;</span>
					   <span class="s">&quot;; possibly firmware needs to be&quot;</span>
					   <span class="s">&quot; loaded&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reloadFl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_upload_firmware1</span><span class="p">(</span><span class="n">hdw</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
					   <span class="s">&quot;Failure uploading firmware1&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">=</span> <span class="n">FW1_STATE_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">force_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_no_powerup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_cmd_powerup</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Take the IR chip out of reset, if appropriate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ir_scheme_active</span> <span class="o">==</span> <span class="n">PVR2_IR_SCHEME_ZILOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span>
				      <span class="n">FX2CMD_HCW_ZILOG_RESET</span> <span class="o">|</span>
				      <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				      <span class="p">((</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>This step MUST happen after the earlier powerup step.</p></td><td class="code"><div class="highlight"><pre>	<span class="n">pvr2_i2c_core_init</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">pvr2_hdw_load_modules</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">load_fw</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">CTRLDEF_COUNT</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">skip_init</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pvr2_hdw_cx25840_vbi_hack</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>

	<span class="cm">/* Set up special default values for the television and radio</span>
<span class="cm">	   frequencies here.  It&#39;s not really important what these defaults</span>
<span class="cm">	   are, but I set them to something usable in the Chicago area just</span>
<span class="cm">	   to make driver testing a little easier. */</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqValTelevision</span> <span class="o">=</span> <span class="n">default_tv_freq</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqValRadio</span> <span class="o">=</span> <span class="n">default_radio_freq</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>Do not use pvr2<em>reset</em>ctl<em>endpoints() here.  It is not
thread-safe against the normal pvr2</em>send_request() mechanism.
(We should make it thread safe).</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_has_hauppauge_rom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_hdw_get_eeprom_addr</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				   <span class="s">&quot;Unable to determine location of eeprom,&quot;</span>
				   <span class="s">&quot; skipping&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">eeprom_addr</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">pvr2_eeprom_analyze</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">default_tuner_type</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_updated</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_eeprom</span> <span class="o">=</span> <span class="n">V4L2_STD_ALL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">identifier</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">identifier</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				<span class="s">&quot;sn-%lu&quot;</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">serial_number</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">identifier</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">identifier</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				<span class="s">&quot;unit-%c&quot;</span><span class="p">,</span>
				<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span> <span class="o">+</span> <span class="sc">&#39;a&#39;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">identifier</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">identifier</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				<span class="s">&quot;unit-??&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">identifier</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pvr2_hdw_setup_std</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get_default_tuner_type</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
			   <span class="s">&quot;pvr2_hdw_setup: Tuner type overridden to %d&quot;</span><span class="p">,</span>
			   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">signal_routing_scheme</span> <span class="o">==</span>
	    <span class="n">PVR2_ROUTING_SCHEME_GOTVIEW</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Ensure that GPIO 11 is set to output for GOTVIEW</span>
<span class="cm">		   hardware. */</span>
		<span class="n">pvr2_hdw_gpio_chg_dir</span><span class="p">(</span><span class="n">hdw</span><span class="p">,(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pvr2_hdw_commit_setup</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span> <span class="o">=</span> <span class="n">pvr2_stream_create</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
		   <span class="s">&quot;pvr2_hdw_setup: video stream is %p&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">get_default_error_tolerance</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
				   <span class="s">&quot;pvr2_hdw_setup: video stream %p&quot;</span>
				   <span class="s">&quot; setting tolerance %u&quot;</span><span class="p">,</span>
				   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">,</span><span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">pvr2_stream_setup</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span>
				  <span class="n">PVR2_VID_ENDPOINT</span><span class="p">,</span><span class="n">idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_init_ok</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">pvr2_hdw_state_sched</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Set up the structure and attempt to put the device into a usable state.</span>
<span class="cm">   This can be a time-consuming operation, which is why it is not done</span>
<span class="cm">   internally as part of the create() step. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;pvr2_hdw_setup(hdw=%p) begin&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_setup_low</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
			   <span class="s">&quot;pvr2_hdw_setup(hdw=%p) done, ok=%d init_ok=%d&quot;</span><span class="p">,</span>
			   <span class="n">hdw</span><span class="p">,</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">),</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_init_ok</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_init_ok</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span>
					<span class="n">PVR2_TRACE_INFO</span><span class="p">,</span>
					<span class="s">&quot;Device initialization&quot;</span>
					<span class="s">&quot; completed successfully.&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">==</span> <span class="n">FW1_STATE_RELOAD</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span>
					<span class="n">PVR2_TRACE_INFO</span><span class="p">,</span>
					<span class="s">&quot;Device microcontroller firmware&quot;</span>
					<span class="s">&quot; (re)loaded; it should now reset&quot;</span>
					<span class="s">&quot; and reconnect.&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;Device initialization was not successful.&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">==</span> <span class="n">FW1_STATE_MISSING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span>
					<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
					<span class="s">&quot;Giving up since device&quot;</span>
					<span class="s">&quot; microcontroller firmware&quot;</span>
					<span class="s">&quot; appears to be missing.&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_modulefail</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;***WARNING*** pvrusb2 driver initialization&quot;</span>
				<span class="s">&quot; failed due to the failure of one or more&quot;</span>
				<span class="s">&quot; sub-device kernel modules.&quot;</span><span class="p">);</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;You need to resolve the failing condition&quot;</span>
				<span class="s">&quot; before this driver can function.  There&quot;</span>
				<span class="s">&quot; should be some earlier messages giving more&quot;</span>
				<span class="s">&quot; information about the problem.&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">procreload</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;Attempting pvrusb2 recovery by reloading&quot;</span>
				<span class="s">&quot; primary firmware.&quot;</span><span class="p">);</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;If this works, device should disconnect&quot;</span>
				<span class="s">&quot; and reconnect in a sane state.&quot;</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">=</span> <span class="n">FW1_STATE_UNKNOWN</span><span class="p">;</span>
			<span class="n">pvr2_upload_firmware1</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;***WARNING*** pvrusb2 device hardware&quot;</span>
				<span class="s">&quot; appears to be jammed&quot;</span>
				<span class="s">&quot; and I can&#39;t clear it.&quot;</span><span class="p">);</span>
			<span class="n">pvr2_trace</span><span class="p">(</span>
				<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				<span class="s">&quot;You might need to power cycle&quot;</span>
				<span class="s">&quot; the pvrusb2 device&quot;</span>
				<span class="s">&quot; in order to recover.&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;pvr2_hdw_setup(hdw=%p) end&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Perform second stage initialization.  Set callback pointer first so that</span>
<span class="cm">   we can avoid a possible initialization race (if the kernel thread runs</span>
<span class="cm">   before the callback has been set). */</span>
<span class="kt">int</span> <span class="nf">pvr2_hdw_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
			<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback_func</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="p">),</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">callback_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_disconnected</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Handle a race here: If we&#39;re already</span>
<span class="cm">			   disconnected by this point, then give up.  If we</span>
<span class="cm">			   get past this then we&#39;ll remain connected for</span>
<span class="cm">			   the duration of initialization since the entire</span>
<span class="cm">			   initialization sequence is now protected by the</span>
<span class="cm">			   big_lock. */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_data</span> <span class="o">=</span> <span class="n">callback_data</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_func</span> <span class="o">=</span> <span class="n">callback_func</span><span class="p">;</span>
		<span class="n">pvr2_hdw_setup</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_init_ok</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Create, set up, and return a structure for interacting with the</span>
<span class="cm">   underlying hardware.  */</span>
<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="nf">pvr2_hdw_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span><span class="n">cnt1</span><span class="p">,</span><span class="n">cnt2</span><span class="p">,</span><span class="n">m</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">valid_std_mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_device_desc</span> <span class="o">*</span><span class="n">hdw_desc</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">ifnum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">qctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_ctl_info</span> <span class="o">*</span><span class="n">ciptr</span><span class="p">;</span>

	<span class="n">usb_dev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="n">hdw_desc</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">pvr2_device_desc</span> <span class="o">*</span><span class="p">)(</span><span class="n">devid</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span> <span class="s">&quot;pvr2_hdw_create:&quot;</span>
			   <span class="s">&quot; No device description pointer,&quot;</span>
			   <span class="s">&quot; unable to continue.&quot;</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span> <span class="s">&quot;If you have a new device type,&quot;</span>
			   <span class="s">&quot; please contact Mike Isely &lt;isely@pobox.com&gt;&quot;</span>
			   <span class="s">&quot; to get it included in the driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdw</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">hdw</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;pvr2_hdw_create: hdw=%p, type </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">hdw</span><span class="p">,</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">);</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INFO</span><span class="p">,</span> <span class="s">&quot;Hardware description: %s&quot;</span><span class="p">,</span>
		<span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_is_experimental</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INFO</span><span class="p">,</span> <span class="s">&quot;**********&quot;</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INFO</span><span class="p">,</span>
			   <span class="s">&quot;WARNING: Support for this device (%s) is&quot;</span>
			   <span class="s">&quot; experimental.&quot;</span><span class="p">,</span> <span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INFO</span><span class="p">,</span>
			   <span class="s">&quot;Important functionality might not be&quot;</span>
			   <span class="s">&quot; entirely working.&quot;</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INFO</span><span class="p">,</span>
			   <span class="s">&quot;Please consider contacting the driver author to&quot;</span>
			   <span class="s">&quot; help with further stabilization of the driver.&quot;</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INFO</span><span class="p">,</span> <span class="s">&quot;**********&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdw</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">pvr2_hdw_quiescent_timeout</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_stabilization_timer</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_stabilization_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdw</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_stabilization_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span>
		<span class="n">pvr2_hdw_decoder_stabilization_timeout</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdw</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">pvr2_hdw_encoder_wait_timeout</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdw</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">pvr2_hdw_encoder_run_timeout</span><span class="p">;</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">master_state</span> <span class="o">=</span> <span class="n">PVR2_STATE_DEAD</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_wait_data</span><span class="p">);</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">cx2341x_fill_defaults</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">);</span>

	<span class="cm">/* Calculate which inputs are OK */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_has_analogtuner</span><span class="p">)</span> <span class="n">m</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PVR2_CVAL_INPUT_TV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">digital_control_scheme</span> <span class="o">!=</span> <span class="n">PVR2_DIGITAL_SCHEME_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">m</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PVR2_CVAL_INPUT_DTV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_has_svideo</span><span class="p">)</span> <span class="n">m</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PVR2_CVAL_INPUT_SVIDEO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_has_composite</span><span class="p">)</span> <span class="n">m</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PVR2_CVAL_INPUT_COMPOSITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_has_fmradio</span><span class="p">)</span> <span class="n">m</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PVR2_CVAL_INPUT_RADIO</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_avail_mask</span> <span class="o">=</span> <span class="n">m</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_avail_mask</span><span class="p">;</span>

	<span class="cm">/* If not a hybrid device, pathway_state never changes.  So</span>
<span class="cm">	   initialize it here to what it should forever be. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_avail_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PVR2_CVAL_INPUT_DTV</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">=</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_avail_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">PVR2_CVAL_INPUT_TV</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">=</span> <span class="n">PVR2_PATHWAY_DIGITAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span> <span class="o">=</span> <span class="n">CTRLDEF_COUNT</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span> <span class="o">+=</span> <span class="n">MPEGDEF_COUNT</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_ctrl</span><span class="p">)</span> <span class="o">*</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span><span class="p">,</span>
				<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span> <span class="o">=</span> <span class="n">hdw_desc</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ir_scheme_active</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">ir_scheme</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">hdw</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_ptrs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_names</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">CTRLDEF_COUNT</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">control_defs</span><span class="o">+</span><span class="n">idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure that default input choice is a valid one. */</span>
	<span class="n">m</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_avail_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Define and configure additional controls from cx2341x module. */</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">mpeg_ctrl_info</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">MPEGDEF_COUNT</span><span class="p">,</span>
				      <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">mpeg_ctrl_info</span><span class="p">)),</span>
				      <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">mpeg_ctrl_info</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">MPEGDEF_COUNT</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">+</span> <span class="n">CTRLDEF_COUNT</span><span class="p">;</span>
		<span class="n">ciptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">mpeg_ctrl_info</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">info</span><span class="p">);</span>
		<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">mpeg_ctrl_info</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
		<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">mpeg_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">strid</span><span class="p">;</span>
		<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">v4l_id</span> <span class="o">=</span> <span class="n">mpeg_ids</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>
		<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">skip_init</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">get_value</span> <span class="o">=</span> <span class="n">ctrl_cx2341x_get</span><span class="p">;</span>
		<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">get_v4lflags</span> <span class="o">=</span> <span class="n">ctrl_cx2341x_getv4lflags</span><span class="p">;</span>
		<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">is_dirty</span> <span class="o">=</span> <span class="n">ctrl_cx2341x_is_dirty</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">idx</span><span class="p">)</span> <span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">clear_dirty</span> <span class="o">=</span> <span class="n">ctrl_cx2341x_clear_dirty</span><span class="p">;</span>
		<span class="n">qctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">v4l_id</span><span class="p">;</span>
		<span class="n">cx2341x_ctrl_query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span><span class="o">&amp;</span><span class="n">qctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">qctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">set_value</span> <span class="o">=</span> <span class="n">ctrl_cx2341x_set</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">mpeg_ctrl_info</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span><span class="n">qctrl</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="n">PVR2_CTLD_INFO_DESC_SIZE</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">mpeg_ctrl_info</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">desc</span><span class="p">[</span><span class="n">PVR2_CTLD_INFO_DESC_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">qctrl</span><span class="p">.</span><span class="n">default_value</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">qctrl</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span>:
			<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">pvr2_ctl_int</span><span class="p">;</span>
			<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">.</span><span class="n">type_int</span><span class="p">.</span><span class="n">min_value</span> <span class="o">=</span> <span class="n">qctrl</span><span class="p">.</span><span class="n">minimum</span><span class="p">;</span>
			<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">.</span><span class="n">type_int</span><span class="p">.</span><span class="n">max_value</span> <span class="o">=</span> <span class="n">qctrl</span><span class="p">.</span><span class="n">maximum</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span>:
			<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">pvr2_ctl_bool</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>:
			<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">pvr2_ctl_enum</span><span class="p">;</span>
			<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">.</span><span class="n">type_enum</span><span class="p">.</span><span class="n">value_names</span> <span class="o">=</span>
				<span class="n">cx2341x_ctrl_get_menu</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span>
								<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">v4l_id</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">cnt1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			     <span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">.</span><span class="n">type_enum</span><span class="p">.</span><span class="n">value_names</span><span class="p">[</span><span class="n">cnt1</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
			     <span class="n">cnt1</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="p">}</span>
			<span class="n">ciptr</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">.</span><span class="n">type_enum</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">cnt1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">ciptr</span><span class="p">;</span>
	<span class="p">}</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>Initialize control data regarding video standard masks</p></td><td class="code"><div class="highlight"><pre>	<span class="n">valid_std_mask</span> <span class="o">=</span> <span class="n">pvr2_std_get_usable</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">valid_std_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">cnt1</span> <span class="o">=</span> <span class="n">pvr2_std_id_to_str</span><span class="p">(</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_names</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_names</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
			<span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_names</span><span class="p">[</span><span class="n">idx</span><span class="p">][</span><span class="n">cnt1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cptr</span> <span class="o">=</span> <span class="n">pvr2_hdw_get_ctrl_by_id</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_CID_STDAVAIL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_avail</span><span class="p">,</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_avail</span><span class="p">));</span>
		<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_avail</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_avail</span><span class="p">.</span><span class="n">def</span><span class="p">.</span><span class="n">type_bitmask</span><span class="p">.</span><span class="n">bit_names</span> <span class="o">=</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_ptrs</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_avail</span><span class="p">.</span><span class="n">def</span><span class="p">.</span><span class="n">type_bitmask</span><span class="p">.</span><span class="n">valid_bits</span> <span class="o">=</span>
			<span class="n">valid_std_mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cptr</span> <span class="o">=</span> <span class="n">pvr2_hdw_get_ctrl_by_id</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_CID_STDCUR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_cur</span><span class="p">,</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_cur</span><span class="p">));</span>
		<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_cur</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_cur</span><span class="p">.</span><span class="n">def</span><span class="p">.</span><span class="n">type_bitmask</span><span class="p">.</span><span class="n">bit_names</span> <span class="o">=</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_ptrs</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_cur</span><span class="p">.</span><span class="n">def</span><span class="p">.</span><span class="n">type_bitmask</span><span class="p">.</span><span class="n">valid_bits</span> <span class="o">=</span>
			<span class="n">valid_std_mask</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cptr</span> <span class="o">=</span> <span class="n">pvr2_hdw_get_ctrl_by_id</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_CID_STDDETECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_detect</span><span class="p">,</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_detect</span><span class="p">));</span>
		<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_detect</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_detect</span><span class="p">.</span><span class="n">def</span><span class="p">.</span><span class="n">type_bitmask</span><span class="p">.</span><span class="n">bit_names</span> <span class="o">=</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_ptrs</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_info_detect</span><span class="p">.</span><span class="n">def</span><span class="p">.</span><span class="n">type_bitmask</span><span class="p">.</span><span class="n">valid_bits</span> <span class="o">=</span>
			<span class="n">valid_std_mask</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">eeprom_addr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l_minor_number_video</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l_minor_number_vbi</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l_minor_number_radio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PVR2_CTL_BUFFSIZE</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_buffer</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_buffer</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">PVR2_CTL_BUFFSIZE</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_buffer</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="p">)</span> <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Error registering with v4l core, giving up&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvr2_unit_mtx</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">PVR_NUM</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unit_pointers</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="k">continue</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
			<span class="n">unit_pointers</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdw</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvr2_unit_mtx</span><span class="p">);</span>

	<span class="n">cnt1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cnt2</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">+</span><span class="n">cnt1</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="o">-</span><span class="n">cnt1</span><span class="p">,</span><span class="s">&quot;pvrusb2&quot;</span><span class="p">);</span>
	<span class="n">cnt1</span> <span class="o">+=</span> <span class="n">cnt2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt2</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="o">+</span><span class="n">cnt1</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="o">-</span><span class="n">cnt1</span><span class="p">,</span><span class="s">&quot;_%c&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="sc">&#39;a&#39;</span> <span class="o">+</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span><span class="p">));</span>
		<span class="n">cnt1</span> <span class="o">+=</span> <span class="n">cnt2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cnt1</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="n">cnt1</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="n">cnt1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workpoll</span><span class="p">,</span><span class="n">pvr2_hdw_worker_poll</span><span class="p">);</span>

	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;Driver unit number is %d, name is %s&quot;</span><span class="p">,</span>
		   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_intf</span> <span class="o">=</span> <span class="n">intf</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">usb_dev</span><span class="p">;</span>

	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>

	<span class="n">ifnum</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">usb_set_interface</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span><span class="n">ifnum</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock_mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">hdw</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_stabilization_timer</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">);</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
			<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_buffer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_buffer</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">mpeg_ctrl_info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Remove _all_ associations between this driver and the underlying USB</span>
<span class="cm">   layer. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_remove_usb_stuff</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_disconnected</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;pvr2_hdw_remove_usb_stuff: hdw=%p&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="p">);</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_buffer</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_buffer</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_disconnected</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* If we don&#39;t do this, then there will be a dangling struct device</span>
<span class="cm">	   reference to our disappearing device persisting inside the V4L</span>
<span class="cm">	   core... */</span>
	<span class="n">v4l2_device_disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_intf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pvr2_hdw_render_useless</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Destroy hardware interaction structure */</span>
<span class="kt">void</span> <span class="nf">pvr2_hdw_destroy</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;pvr2_hdw_destroy: hdw=%p&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
		<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_stabilization_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_stream_destroy</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pvr2_i2c_core_done</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">pvr2_hdw_remove_usb_stuff</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvr2_unit_mtx</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span> <span class="o">&lt;</span> <span class="n">PVR_NUM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">unit_pointers</span><span class="p">[</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span><span class="p">]</span> <span class="o">==</span> <span class="n">hdw</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">unit_pointers</span><span class="p">[</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">unit_number</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pvr2_unit_mtx</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">mpeg_ctrl_info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_dev_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">hdw</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Called when hardware has been unplugged */</span>
<span class="kt">void</span> <span class="nf">pvr2_hdw_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;pvr2_hdw_disconnect(hdw=%p)&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>
	<span class="n">pvr2_hdw_remove_usb_stuff</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>
	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Get the number of defined controls */</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_get_ctrl_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Retrieve a control handle given its index (0..count-1) */</span>
<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_ctrl_by_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
					     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span><span class="p">)</span> <span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Retrieve a control handle given its index (0..count-1) */</span>
<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_ctrl_by_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctl_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* This could be made a lot more efficient, but for now... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">internal_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ctl_id</span><span class="p">))</span> <span class="k">return</span> <span class="n">cptr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Given a V4L ID, retrieve the control structure associated with it. */</span>
<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_ctrl_v4l</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctl_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* This could be made a lot more efficient, but for now... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">v4l_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ctl_id</span><span class="p">))</span> <span class="k">return</span> <span class="n">cptr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Given a V4L ID for its immediate predecessor, retrieve the control</span>
<span class="cm">   structure associated with it. */</span>
<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_ctrl_nextv4l</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
					    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ctl_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">,</span><span class="o">*</span><span class="n">cp2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* This could be made a lot more efficient, but for now... */</span>
	<span class="n">cp2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">v4l_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">ctl_id</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cp2</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cp2</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">v4l_id</span> <span class="o">&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">cp2</span> <span class="o">=</span> <span class="n">cptr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">cp2</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">get_ctrl_typename</span><span class="p">(</span><span class="k">enum</span> <span class="n">pvr2_ctl_type</span> <span class="n">tp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">tp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pvr2_ctl_int</span>: <span class="k">return</span> <span class="s">&quot;integer&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_ctl_enum</span>: <span class="k">return</span> <span class="s">&quot;enum&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_ctl_bool</span>: <span class="k">return</span> <span class="s">&quot;boolean&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_ctl_bitmask</span>: <span class="k">return</span> <span class="s">&quot;bitmask&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_subdev_set_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CHIPS</span><span class="p">,</span> <span class="s">&quot;subdev v4l2 %s=%d&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ctrl</span><span class="p">));</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define PVR2_SUBDEV_SET_CONTROL(hdw, id, lab) \</span>
<span class="cp">	if ((hdw)-&gt;lab##_dirty || (hdw)-&gt;force_dirty) {		\</span>
<span class="cp">		pvr2_subdev_set_control(hdw, id, #lab, (hdw)-&gt;lab##_val); \</span>
<span class="cp">	}</span>

<span class="n">v4l2_std_id</span> <span class="nf">pvr2_hdw_get_detected_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
	<span class="n">std</span> <span class="o">=</span> <span class="p">(</span><span class="n">v4l2_std_id</span><span class="p">)</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_avail</span><span class="p">;</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="n">video</span><span class="p">,</span> <span class="n">querystd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">std</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">std</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Execute whatever commands are required to update the state of all the</span>
<span class="cm">   sub-devices so that they match our current control values. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_subdev_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">pvr2_subdev_update_func</span> <span class="n">fp</span><span class="p">;</span>

	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CHIPS</span><span class="p">,</span> <span class="s">&quot;subdev update...&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_updated</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">force_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tuner_setup</span> <span class="n">setup</span><span class="p">;</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CHIPS</span><span class="p">,</span> <span class="s">&quot;subdev tuner set_type(%d)&quot;</span><span class="p">,</span>
			   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(((</span><span class="kt">int</span><span class="p">)(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">))</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">setup</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">setup</span><span class="p">));</span>
			<span class="n">setup</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">ADDR_UNSET</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">;</span>
			<span class="n">setup</span><span class="p">.</span><span class="n">mode_mask</span> <span class="o">=</span> <span class="n">T_RADIO</span> <span class="o">|</span> <span class="n">T_ANALOG_TV</span><span class="p">;</span>
			<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">tuner</span><span class="p">,</span> <span class="n">s_type_addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">setup</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_dirty</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_dirty</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">force_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CHIPS</span><span class="p">,</span> <span class="s">&quot;subdev v4l2 set_standard&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_RADIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">tuner</span><span class="p">,</span> <span class="n">s_radio</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">v4l2_std_id</span> <span class="n">vs</span><span class="p">;</span>
			<span class="n">vs</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span><span class="p">;</span>
			<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					     <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">vs</span><span class="p">);</span>
			<span class="n">pvr2_hdw_cx25840_vbi_hack</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PVR2_SUBDEV_SET_CONTROL</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span> <span class="n">brightness</span><span class="p">);</span>
	<span class="n">PVR2_SUBDEV_SET_CONTROL</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span> <span class="n">contrast</span><span class="p">);</span>
	<span class="n">PVR2_SUBDEV_SET_CONTROL</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">V4L2_CID_SATURATION</span><span class="p">,</span> <span class="n">saturation</span><span class="p">);</span>
	<span class="n">PVR2_SUBDEV_SET_CONTROL</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">V4L2_CID_HUE</span><span class="p">,</span> <span class="n">hue</span><span class="p">);</span>
	<span class="n">PVR2_SUBDEV_SET_CONTROL</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">,</span> <span class="n">mute</span><span class="p">);</span>
	<span class="n">PVR2_SUBDEV_SET_CONTROL</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span><span class="p">,</span> <span class="n">volume</span><span class="p">);</span>
	<span class="n">PVR2_SUBDEV_SET_CONTROL</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span><span class="p">,</span> <span class="n">balance</span><span class="p">);</span>
	<span class="n">PVR2_SUBDEV_SET_CONTROL</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">V4L2_CID_AUDIO_BASS</span><span class="p">,</span> <span class="n">bass</span><span class="p">);</span>
	<span class="n">PVR2_SUBDEV_SET_CONTROL</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span><span class="p">,</span> <span class="n">treble</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_dirty</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">audiomode_dirty</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">force_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="n">vt</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vt</span><span class="p">));</span>
		<span class="n">vt</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_RADIO</span><span class="p">)</span> <span class="o">?</span>
			<span class="n">V4L2_TUNER_RADIO</span> <span class="o">:</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
		<span class="n">vt</span><span class="p">.</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">audiomode_val</span><span class="p">;</span>
		<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_tuner</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqDirty</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">force_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fv</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="n">freq</span><span class="p">;</span>
		<span class="n">fv</span> <span class="o">=</span> <span class="n">pvr2_hdw_get_cur_freq</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CHIPS</span><span class="p">,</span> <span class="s">&quot;subdev v4l2 set_freq(%lu)&quot;</span><span class="p">,</span> <span class="n">fv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_stale</span><span class="p">)</span> <span class="n">pvr2_hdw_status_poll</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">freq</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">freq</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_info</span><span class="p">.</span><span class="n">capability</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_CAP_LOW</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ((fv * 1000) / 62500) */</span>
			<span class="n">freq</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="p">(</span><span class="n">fv</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">125</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">freq</span><span class="p">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">fv</span> <span class="o">/</span> <span class="mi">62500</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* tuner-core currently doesn&#39;t seem to care about this, but</span>
<span class="cm">		   let&#39;s set it anyway for completeness. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_RADIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">freq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">freq</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">freq</span><span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span>
				     <span class="n">s_frequency</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">freq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_hor_dirty</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_dirty</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">force_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">fmt</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="p">));</span>
		<span class="n">fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_hor_val</span><span class="p">;</span>
		<span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_val</span><span class="p">;</span>
		<span class="n">fmt</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_FIXED</span><span class="p">;</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CHIPS</span><span class="p">,</span> <span class="s">&quot;subdev v4l2 set_size(%dx%d)&quot;</span><span class="p">,</span>
			   <span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">fmt</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
		<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">srate_dirty</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">force_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CHIPS</span><span class="p">,</span> <span class="s">&quot;subdev v4l2 set_audio %d&quot;</span><span class="p">,</span>
			   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">srate_val</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">srate_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_AUDIO_SAMPLING_FREQ_48000</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_AUDIO_SAMPLING_FREQ_44100</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="mi">44100</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MPEG_AUDIO_SAMPLING_FREQ_32000</span>:
			<span class="n">val</span> <span class="o">=</span> <span class="mi">32000</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">audio</span><span class="p">,</span> <span class="n">s_clock_freq</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Unable to set crop parameters; there is apparently no equivalent</span>
<span class="cm">	   for VIDIOC_S_CROP */</span>

	<span class="n">v4l2_device_for_each_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pvr2_module_update_functions</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">pvr2_module_update_functions</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fp</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_stale</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_stale</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_status_poll</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Figure out if we need to commit control changes.  If so, mark internal</span>
<span class="cm">   state flags to indicate this fact and return true.  Otherwise do nothing</span>
<span class="cm">   else and return false. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_commit_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">commit_flag</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">force_dirty</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bcnt</span><span class="p">,</span><span class="n">ccnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">is_dirty</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">is_dirty</span><span class="p">(</span><span class="n">cptr</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">commit_flag</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pvrusb2_debug</span> <span class="o">&amp;</span> <span class="n">PVR2_TRACE_CTL</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span><span class="s">&quot;</span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> &lt;-- &quot;</span><span class="p">,</span>
				 <span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span><span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">pvr2_ctrl_value_to_sym_internal</span><span class="p">(</span><span class="n">cptr</span><span class="p">,</span><span class="o">~</span><span class="mi">0</span><span class="p">,</span><span class="n">value</span><span class="p">,</span>
						<span class="n">buf</span><span class="o">+</span><span class="n">bcnt</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="n">bcnt</span><span class="p">,</span><span class="o">&amp;</span><span class="n">ccnt</span><span class="p">);</span>
		<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
		<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">bcnt</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">-</span><span class="n">bcnt</span><span class="p">,</span><span class="s">&quot; &lt;%s&gt;&quot;</span><span class="p">,</span>
				  <span class="n">get_ctrl_typename</span><span class="p">(</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">));</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CTL</span><span class="p">,</span>
			   <span class="s">&quot;/*--TRACE_COMMIT--*/ %.*s&quot;</span><span class="p">,</span>
			   <span class="n">bcnt</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">commit_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Nothing has changed */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_pipeline_config&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span><span class="p">);</span>
	<span class="n">pvr2_hdw_state_sched</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Perform all operations needed to commit all control changes.  This must</span>
<span class="cm">   be performed in synchronization with the pipeline state and is thus</span>
<span class="cm">   expected to be called as part of the driver&#39;s worker thread.  Return</span>
<span class="cm">   true if commit successful, otherwise return false to indicate that</span>
<span class="cm">   commit isn&#39;t possible at this time. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_commit_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_ctrl</span> <span class="o">*</span><span class="n">cptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disruptive_change</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_dirty</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_DTV</span><span class="p">)</span> <span class="o">?</span>
	      <span class="n">PVR2_PATHWAY_DIGITAL</span> <span class="o">:</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Change of mode being asked for... */</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_pathway_ok&quot;</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Can&#39;t commit anything until pathway is ok. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle some required side effects when the video standard is</span>
<span class="cm">	   changed.... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nvres</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">gop_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nvres</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
			<span class="n">gop_size</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nvres</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
			<span class="n">gop_size</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Rewrite the vertical resolution to be appropriate to the</span>
<span class="cm">		   video standard that has been selected. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nvres</span> <span class="o">!=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_val</span> <span class="o">=</span> <span class="n">nvres</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Rewrite the GOP size to be appropriate to the video</span>
<span class="cm">		   standard that has been selected. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gop_size</span> <span class="o">!=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">.</span><span class="n">video_gop_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="n">cs</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="n">c1</span><span class="p">;</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c1</span><span class="p">));</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">controls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c1</span><span class="p">;</span>
			<span class="n">cs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">c1</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_SIZE</span><span class="p">;</span>
			<span class="n">c1</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">gop_size</span><span class="p">;</span>
			<span class="n">cx2341x_ext_ctrls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span>
					  <span class="n">VIDIOC_S_EXT_CTRLS</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* The broadcast decoder can only scale down, so if</span>
<span class="cm">	 * res_*_dirty &amp;&amp; crop window &lt; output format ==&gt; enlarge crop.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The mpeg encoder receives fields of res_hor_val dots and</span>
<span class="cm">	 * res_ver_val halflines.  Limits: hor&lt;=720, ver&lt;=576.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_hor_dirty</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropw_val</span> <span class="o">&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_hor_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropw_val</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_hor_val</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropw_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropw_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_hor_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>           <span class="cm">/* must rescale */</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_hor_val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="mi">720</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropw_val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_dirty</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">croph_val</span> <span class="o">&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">croph_val</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_val</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">croph_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">croph_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">nvres</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_mask_cur</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span> <span class="o">?</span> <span class="mi">480</span> <span class="o">:</span> <span class="mi">576</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_val</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">nvres</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">croph_val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If any of the below has changed, then we can&#39;t do the update</span>
<span class="cm">	   while the pipeline is running.  Pipeline must be paused first</span>
<span class="cm">	   and decoder -&gt; encoder connection be made quiescent before we</span>
<span class="cm">	   can proceed. */</span>
	<span class="n">disruptive_change</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">std_dirty</span> <span class="o">||</span>
		 <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_unsafe_stale</span> <span class="o">||</span>
		 <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">srate_dirty</span> <span class="o">||</span>
		 <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_ver_dirty</span> <span class="o">||</span>
		 <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">res_hor_dirty</span> <span class="o">||</span>
		 <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropw_dirty</span> <span class="o">||</span>
		 <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">croph_dirty</span> <span class="o">||</span>
		 <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_dirty</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">active_stream_type</span> <span class="o">!=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">desired_stream_type</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disruptive_change</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Pipeline is not idle; we can&#39;t proceed.  Arrange to</span>
<span class="cm">		   cause pipeline to stop so that we can try this again</span>
<span class="cm">		   later.... */</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">srate_dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Write new sample rate into control structure since</span>
<span class="cm">		 * the master copy is stale.  We must track srate</span>
<span class="cm">		 * separate from the mpeg control structure because</span>
<span class="cm">		 * other logic also uses this value. */</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="n">cs</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="n">c1</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cs</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">c1</span><span class="p">));</span>
		<span class="n">cs</span><span class="p">.</span><span class="n">controls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">c1</span><span class="p">;</span>
		<span class="n">cs</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">c1</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ</span><span class="p">;</span>
		<span class="n">c1</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">srate_val</span><span class="p">;</span>
		<span class="n">cx2341x_ext_ctrls</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="p">,</span><span class="n">VIDIOC_S_EXT_CTRLS</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">active_stream_type</span> <span class="o">!=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">desired_stream_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Handle any side effects of stream config here */</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">active_stream_type</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">desired_stream_type</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">signal_routing_scheme</span> <span class="o">==</span>
	    <span class="n">PVR2_ROUTING_SCHEME_GOTVIEW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">b</span><span class="p">;</span>
		<span class="cm">/* Handle GOTVIEW audio switching */</span>
		<span class="n">pvr2_hdw_gpio_get_out</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="o">&amp;</span><span class="n">b</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_RADIO</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set GPIO 11 */</span>
			<span class="n">pvr2_hdw_gpio_chg_out</span><span class="p">(</span><span class="n">hdw</span><span class="p">,(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span><span class="o">~</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Clear GPIO 11 */</span>
			<span class="n">pvr2_hdw_gpio_chg_out</span><span class="p">(</span><span class="n">hdw</span><span class="p">,(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Check and update state for all sub-devices. */</span>
	<span class="n">pvr2_subdev_update</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">force_dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">control_cnt</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cptr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clear_dirty</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">cptr</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">clear_dirty</span><span class="p">(</span><span class="n">cptr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">==</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If encoder isn&#39;t running or it can&#39;t be touched, then</span>
<span class="cm">		   this will get worked out later when we start the</span>
<span class="cm">		   encoder. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_encoder_adjust</span><span class="p">(</span><span class="n">hdw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Hardware state may have changed in a way to cause the cropping</span>
<span class="cm">	   capabilities to have changed.  So mark it stale, which will</span>
<span class="cm">	   cause a later re-fetch. */</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_pipeline_config&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_commit_ctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fl</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="n">fl</span> <span class="o">=</span> <span class="n">pvr2_hdw_commit_setup</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fl</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pvr2_hdw_wait</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_worker_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span><span class="k">struct</span> <span class="n">pvr2_hdw</span><span class="p">,</span><span class="n">workpoll</span><span class="p">);</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">fl</span> <span class="o">=</span> <span class="n">pvr2_hdw_state_eval</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fl</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_func</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_func</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_data</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">wait_event_interruptible</span><span class="p">(</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_wait_data</span><span class="p">,</span>
		<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="o">!</span><span class="n">state</span> <span class="o">||</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">master_state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)));</span>
<span class="p">}</span>


<span class="cm">/* Return name for this driver instance */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_driver_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_desc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_is_hsm</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FX2CMD_GET_USB_SPEED</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">pvr2_send_request</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span>
					   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
					   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Execute poll of tuner status */</span>
<span class="kt">void</span> <span class="nf">pvr2_hdw_execute_tuner_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_status_poll</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_stale</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pvr2_hdw_status_poll</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_stale</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Return information about cropping capabilities */</span>
<span class="kt">int</span> <span class="nf">pvr2_hdw_get_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">pp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">pvr2_hdw_check_cropcap</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_info</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Return information about the tuner */</span>
<span class="kt">int</span> <span class="nf">pvr2_hdw_get_tuner_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vtp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_stale</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_hdw_status_poll</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">vtp</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_info</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_tuner</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Get handle to video output stream */</span>
<span class="k">struct</span> <span class="n">pvr2_stream</span> <span class="o">*</span><span class="nf">pvr2_hdw_get_video_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hp</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">pvr2_hdw_trigger_module_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">nr</span> <span class="o">=</span> <span class="n">pvr2_hdw_get_unit_number</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pvrusb2: =================  START STATUS CARD #%d  =================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
		<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">log_status</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INFO</span><span class="p">,</span><span class="s">&quot;cx2341x config:&quot;</span><span class="p">);</span>
		<span class="n">cx2341x_log_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">enc_ctl_state</span><span class="p">,</span> <span class="s">&quot;pvrusb2&quot;</span><span class="p">);</span>
		<span class="n">pvr2_hdw_state_log_state</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pvrusb2: ==================  END STATUS CARD #%d  ==================</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Grab EEPROM contents, needed for direct method. */</span>
<span class="cp">#define EEPROM_SIZE 8192</span>
<span class="cp">#define trace_eeprom(...) pvr2_trace(PVR2_TRACE_EEPROM,__VA_ARGS__)</span>
<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">pvr2_full_eeprom_fetch</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">iadd</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">eepromSize</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode16</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">pcnt</span><span class="p">,</span><span class="n">tcnt</span><span class="p">;</span>
	<span class="n">eeprom</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">EEPROM_SIZE</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">eeprom</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Failed to allocate memory&quot;</span>
			   <span class="s">&quot; required to read eeprom&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">trace_eeprom</span><span class="p">(</span><span class="s">&quot;Value for eeprom addr from controller was 0x%x&quot;</span><span class="p">,</span>
		     <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">eeprom_addr</span><span class="p">);</span>
	<span class="n">addr</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">eeprom_addr</span><span class="p">;</span>
	<span class="cm">/* Seems that if the high bit is set, then the *real* eeprom</span>
<span class="cm">	   address is shifted right now bit position (noticed this in</span>
<span class="cm">	   newer PVR USB2 hardware) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="n">addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* FX2 documentation states that a 16bit-addressed eeprom is</span>
<span class="cm">	   expected if the I2C address is an odd number (yeah, this is</span>
<span class="cm">	   strange but it&#39;s what they do) */</span>
	<span class="n">mode16</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">eepromSize</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode16</span> <span class="o">?</span> <span class="n">EEPROM_SIZE</span> <span class="o">:</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">trace_eeprom</span><span class="p">(</span><span class="s">&quot;Examining %d byte eeprom at location 0x%x&quot;</span>
		     <span class="s">&quot; using %d bit addressing&quot;</span><span class="p">,</span><span class="n">eepromSize</span><span class="p">,</span><span class="n">addr</span><span class="p">,</span>
		     <span class="n">mode16</span> <span class="o">?</span> <span class="mi">16</span> <span class="o">:</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">mode16</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">iadd</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>

	<span class="cm">/* We have to do the actual eeprom data fetch ourselves, because</span>
<span class="cm">	   (1) we&#39;re only fetching part of the eeprom, and (2) if we were</span>
<span class="cm">	   getting the whole thing our I2C driver can&#39;t grab it in one</span>
<span class="cm">	   pass - which is what tveeprom is otherwise going to attempt */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">eeprom</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">EEPROM_SIZE</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">tcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">tcnt</span> <span class="o">&lt;</span> <span class="n">EEPROM_SIZE</span><span class="p">;</span> <span class="n">tcnt</span> <span class="o">+=</span> <span class="n">pcnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcnt</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcnt</span> <span class="o">+</span> <span class="n">tcnt</span> <span class="o">&gt;</span> <span class="n">EEPROM_SIZE</span><span class="p">)</span> <span class="n">pcnt</span> <span class="o">=</span> <span class="n">EEPROM_SIZE</span><span class="o">-</span><span class="n">tcnt</span><span class="p">;</span>
		<span class="n">offs</span> <span class="o">=</span> <span class="n">tcnt</span> <span class="o">+</span> <span class="p">(</span><span class="n">eepromSize</span> <span class="o">-</span> <span class="n">EEPROM_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">iadd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offs</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">iadd</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">offs</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">iadd</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">offs</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">pcnt</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">eeprom</span><span class="o">+</span><span class="n">tcnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
					<span class="n">msg</span><span class="p">,</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msg</span><span class="p">)))</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				   <span class="s">&quot;eeprom fetch set offs err=%d&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">eeprom</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">eeprom</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">pvr2_hdw_cpufw_set_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">mode</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">enable_flag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">address</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="o">!</span><span class="n">enable_flag</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_FIRMWARE</span><span class="p">,</span>
				   <span class="s">&quot;Cleaning up after CPU firmware fetch&quot;</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_cpu_flag</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Now release the CPU.  It will disconnect</span>
<span class="cm">				   and reconnect later. */</span>
				<span class="n">pvr2_hdw_cpureset_assert</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_cpu_flag</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_cpu_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x4000</span> <span class="o">:</span> <span class="mh">0x2000</span><span class="p">;</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_FIRMWARE</span><span class="p">,</span>
				   <span class="s">&quot;Preparing to suck out CPU firmware&quot;</span>
				   <span class="s">&quot; (size=%u)&quot;</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* We have to hold the CPU during firmware upload. */</span>
			<span class="n">pvr2_hdw_cpureset_assert</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* download the firmware from address 0000-1fff in 2048</span>
<span class="cm">			   (=0x800) bytes chunk. */</span>

			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_FIRMWARE</span><span class="p">,</span>
				   <span class="s">&quot;Grabbing CPU firmware&quot;</span><span class="p">);</span>
			<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">for</span><span class="p">(</span><span class="n">address</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">address</span> <span class="o">&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">;</span>
			    <span class="n">address</span> <span class="o">+=</span> <span class="mh">0x800</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span><span class="n">pipe</span><span class="p">,</span>
						      <span class="mh">0xa0</span><span class="p">,</span><span class="mh">0xc0</span><span class="p">,</span>
						      <span class="n">address</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
						      <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span><span class="o">+</span><span class="n">address</span><span class="p">,</span>
						      <span class="mh">0x800</span><span class="p">,</span><span class="n">HZ</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_FIRMWARE</span><span class="p">,</span>
				   <span class="s">&quot;Done grabbing CPU firmware&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_FIRMWARE</span><span class="p">,</span>
				   <span class="s">&quot;Sucking down EEPROM contents&quot;</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span> <span class="o">=</span> <span class="n">pvr2_full_eeprom_fetch</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_FIRMWARE</span><span class="p">,</span>
					   <span class="s">&quot;EEPROM content suck failed.&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span> <span class="o">=</span> <span class="n">EEPROM_SIZE</span><span class="p">;</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_FIRMWARE</span><span class="p">,</span>
				   <span class="s">&quot;Done sucking down EEPROM contents&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Return true if we&#39;re in a mode for retrieval CPU firmware */</span>
<span class="kt">int</span> <span class="nf">pvr2_hdw_cpufw_get_enabled</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_cpufw_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offs</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cnt</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">&gt;=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_FIRMWARE</span><span class="p">,</span>
				   <span class="s">&quot;Read firmware data offs=%d EOF&quot;</span><span class="p">,</span>
				   <span class="n">offs</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">offs</span> <span class="o">+</span> <span class="n">cnt</span> <span class="o">&gt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span><span class="p">)</span> <span class="n">cnt</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_size</span> <span class="o">-</span> <span class="n">offs</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw_buffer</span><span class="o">+</span><span class="n">offs</span><span class="p">,</span><span class="n">cnt</span><span class="p">);</span>

		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_FIRMWARE</span><span class="p">,</span>
			   <span class="s">&quot;Read firmware data offs=%d cnt=%d&quot;</span><span class="p">,</span>
			   <span class="n">offs</span><span class="p">,</span><span class="n">cnt</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_v4l_get_minor_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				  <span class="k">enum</span> <span class="n">pvr2_v4l_type</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pvr2_v4l_type_video</span>: <span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l_minor_number_video</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_v4l_type_vbi</span>: <span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l_minor_number_vbi</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_v4l_type_radio</span>: <span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l_minor_number_radio</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Store a v4l minor device number */</span>
<span class="kt">void</span> <span class="nf">pvr2_hdw_v4l_store_minor_number</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				     <span class="k">enum</span> <span class="n">pvr2_v4l_type</span> <span class="n">index</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">pvr2_v4l_type_video</span>: <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l_minor_number_video</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_v4l_type_vbi</span>: <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l_minor_number_vbi</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">pvr2_v4l_type_radio</span>: <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l_minor_number_radio</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_ctl_write_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_pend_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_pend_flag</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_done</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_ctl_read_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_pend_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_pend_flag</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_done</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_ctl_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_pend_flag</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_pend_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_timeout_flag</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_pend_flag</span><span class="p">)</span>
			<span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_pend_flag</span><span class="p">)</span>
			<span class="n">usb_unlink_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Issue a command and get a response from the device.  This extended</span>
<span class="cm">   version includes a probe flag (which if set means that device errors</span>
<span class="cm">   should not be logged or treated as fatal) and a timeout in jiffies.</span>
<span class="cm">   This can be used to non-lethally probe the health of endpoint 1. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_send_request_ex</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span><span class="kt">int</span> <span class="n">probe_fl</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">write_data</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_len</span><span class="p">,</span>
				<span class="kt">void</span> <span class="o">*</span><span class="n">read_data</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock_held</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Attempted to execute control transfer&quot;</span>
			   <span class="s">&quot; without lock!!&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EDEADLK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">probe_fl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Attempted to execute control transfer&quot;</span>
			   <span class="s">&quot; when device not ok&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_fl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				   <span class="s">&quot;Attempted to execute control transfer&quot;</span>
				   <span class="s">&quot; when USB is disconnected&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Ensure that we have sane parameters */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">write_data</span><span class="p">)</span> <span class="n">write_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_data</span><span class="p">)</span> <span class="n">read_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_len</span> <span class="o">&gt;</span> <span class="n">PVR2_CTL_BUFFSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span>
			<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			<span class="s">&quot;Attempted to execute %d byte&quot;</span>
			<span class="s">&quot; control-write transfer (limit=%d)&quot;</span><span class="p">,</span>
			<span class="n">write_len</span><span class="p">,</span><span class="n">PVR2_CTL_BUFFSIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_len</span> <span class="o">&gt;</span> <span class="n">PVR2_CTL_BUFFSIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span>
			<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			<span class="s">&quot;Attempted to execute %d byte&quot;</span>
			<span class="s">&quot; control-read transfer (limit=%d)&quot;</span><span class="p">,</span>
			<span class="n">write_len</span><span class="p">,</span><span class="n">PVR2_CTL_BUFFSIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">write_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">read_len</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span>
			<span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			<span class="s">&quot;Attempted to execute null control transfer?&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_code</span> <span class="o">=</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">write_data</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_write_len</span> <span class="o">=</span> <span class="n">write_len</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_read_len</span> <span class="o">=</span> <span class="n">read_len</span><span class="p">;</span>

	<span class="cm">/* Initialize common stuff */</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_done</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_timeout_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_pend_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_pend_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">hdw</span><span class="p">;</span>
	<span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">pvr2_ctl_timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_state</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* Transfer write data to internal buffer */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">write_len</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_buffer</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">write_data</span><span class="p">)[</span><span class="n">idx</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="cm">/* Initiate a write request */</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="p">,</span>
				  <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span>
				  <span class="n">usb_sndbulkpipe</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span>
						  <span class="n">PVR2_CTL_WRITE_ENDPOINT</span><span class="p">),</span>
				  <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_buffer</span><span class="p">,</span>
				  <span class="n">write_len</span><span class="p">,</span>
				  <span class="n">pvr2_ctl_write_complete</span><span class="p">,</span>
				  <span class="n">hdw</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_pend_flag</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				   <span class="s">&quot;Failed to submit write-control&quot;</span>
				   <span class="s">&quot; URB status=%d&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_pend_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">read_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_state</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_buffer</span><span class="p">,</span><span class="mh">0x43</span><span class="p">,</span><span class="n">read_len</span><span class="p">);</span>
		<span class="cm">/* Initiate a read request */</span>
		<span class="n">usb_fill_bulk_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="p">,</span>
				  <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span>
				  <span class="n">usb_rcvbulkpipe</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span>
						  <span class="n">PVR2_CTL_READ_ENDPOINT</span><span class="p">),</span>
				  <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_buffer</span><span class="p">,</span>
				  <span class="n">read_len</span><span class="p">,</span>
				  <span class="n">pvr2_ctl_read_complete</span><span class="p">,</span>
				  <span class="n">hdw</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_pend_flag</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="p">,</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				   <span class="s">&quot;Failed to submit read-control&quot;</span>
				   <span class="s">&quot; URB status=%d&quot;</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_pend_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Start timer */</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>

	<span class="cm">/* Now wait for all I/O to complete */</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_state</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_pend_flag</span> <span class="o">||</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_pend_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_done</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_state</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="cm">/* Stop timer */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_state</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_timeout_flag</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_fl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
				   <span class="s">&quot;Timed out control-write&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">write_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Validate results of write request */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* USB subsystem is reporting some kind of failure</span>
<span class="cm">			   on the write */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_fl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
					   <span class="s">&quot;control-write URB failure,&quot;</span>
					   <span class="s">&quot; status=%d&quot;</span><span class="p">,</span>
					   <span class="n">status</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&lt;</span> <span class="n">write_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Failed to write enough data */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_fl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
					   <span class="s">&quot;control-write URB short,&quot;</span>
					   <span class="s">&quot; expected=%d got=%d&quot;</span><span class="p">,</span>
					   <span class="n">write_len</span><span class="p">,</span>
					   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_write_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">read_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Validate results of read request */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ESHUTDOWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ECONNRESET</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* USB subsystem is reporting some kind of failure</span>
<span class="cm">			   on the read */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_fl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
					   <span class="s">&quot;control-read URB failure,&quot;</span>
					   <span class="s">&quot; status=%d&quot;</span><span class="p">,</span>
					   <span class="n">status</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span> <span class="o">&lt;</span> <span class="n">read_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Failed to read enough data */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_fl</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
					   <span class="s">&quot;control-read URB short,&quot;</span>
					   <span class="s">&quot; expected=%d got=%d&quot;</span><span class="p">,</span>
					   <span class="n">read_len</span><span class="p">,</span>
					   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_urb</span><span class="o">-&gt;</span><span class="n">actual_length</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Transfer retrieved data out from internal buffer */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">read_len</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="p">((</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">read_data</span><span class="p">)[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_read_buffer</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">done:</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_debug_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">probe_fl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_render_useless</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="o">*</span><span class="n">write_data</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">write_len</span><span class="p">,</span>
		      <span class="kt">void</span> <span class="o">*</span><span class="n">read_data</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">read_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pvr2_send_request_ex</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">HZ</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span>
				    <span class="n">write_data</span><span class="p">,</span><span class="n">write_len</span><span class="p">,</span>
				    <span class="n">read_data</span><span class="p">,</span><span class="n">read_len</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="n">u32</span> <span class="n">cmdcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">args</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmdcode</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">;</span>
	<span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">;</span>
	<span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="n">args</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cnt</span> <span class="o">+=</span> <span class="n">args</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmdcode</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffu</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvrusb2_debug</span> <span class="o">&amp;</span> <span class="n">PVR2_TRACE_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccnt</span><span class="p">,</span><span class="n">bcnt</span><span class="p">;</span>
		<span class="kt">char</span> <span class="n">tbuf</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
		<span class="n">cmdcode</span> <span class="o">&amp;=</span> <span class="mh">0xffu</span><span class="p">;</span>
		<span class="n">bcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="o">+</span><span class="n">bcnt</span><span class="p">,</span>
				 <span class="k">sizeof</span><span class="p">(</span><span class="n">tbuf</span><span class="p">)</span><span class="o">-</span><span class="n">bcnt</span><span class="p">,</span>
				 <span class="s">&quot;Sending FX2 command 0x%x&quot;</span><span class="p">,</span><span class="n">cmdcode</span><span class="p">);</span>
		<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pvr2_fx2cmd_desc</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_fx2cmd_desc</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">cmdcode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="o">+</span><span class="n">bcnt</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">tbuf</span><span class="p">)</span><span class="o">-</span><span class="n">bcnt</span><span class="p">,</span>
						 <span class="s">&quot; </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span><span class="p">,</span>
						 <span class="n">pvr2_fx2cmd_desc</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">desc</span><span class="p">);</span>
				<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="o">+</span><span class="n">bcnt</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">tbuf</span><span class="p">)</span><span class="o">-</span><span class="n">bcnt</span><span class="p">,</span>
					 <span class="s">&quot; (%u&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="o">+</span><span class="n">bcnt</span><span class="p">,</span>
						 <span class="k">sizeof</span><span class="p">(</span><span class="n">tbuf</span><span class="p">)</span><span class="o">-</span><span class="n">bcnt</span><span class="p">,</span>
						 <span class="s">&quot;,%u&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
				<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">tbuf</span><span class="o">+</span><span class="n">bcnt</span><span class="p">,</span>
					 <span class="k">sizeof</span><span class="p">(</span><span class="n">tbuf</span><span class="p">)</span><span class="o">-</span><span class="n">bcnt</span><span class="p">,</span>
					 <span class="s">&quot;)&quot;</span><span class="p">);</span>
			<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;%.*s&quot;</span><span class="p">,</span><span class="n">bcnt</span><span class="p">,</span><span class="n">tbuf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_send_request</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="n">cnt</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FX2CMD_REG_WRITE</span><span class="p">;</span>  <span class="cm">/* write register prefix */</span>
	<span class="n">PVR2_DECOMPOSE_LE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">data</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>


	<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_send_request</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FX2CMD_REG_READ</span><span class="p">;</span>  <span class="cm">/* read register prefix */</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">|=</span> <span class="n">pvr2_send_request</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">PVR2_COMPOSE_LE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">pvr2_hdw_render_useless</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
		   <span class="s">&quot;Device being rendered inoperable&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_stream_setup</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">,</span><span class="nb">NULL</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;flag_ok&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span><span class="p">);</span>
	<span class="n">pvr2_hdw_state_sched</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">pvr2_hdw_device_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;Performing a device reset...&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_lock_device_for_reset</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_reset_device</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">);</span>
		<span class="n">usb_unlock_device</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Failed to lock USB device ret=%d&quot;</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_pause_msec</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INFO</span><span class="p">,</span>
			   <span class="s">&quot;Waiting %u msec for hardware to settle&quot;</span><span class="p">,</span>
			   <span class="n">init_pause_msec</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">init_pause_msec</span><span class="p">);</span>
	<span class="p">}</span>

<span class="p">}</span>


<span class="kt">void</span> <span class="nf">pvr2_hdw_cpureset_assert</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">da</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipe</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">da</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">da</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;Unable to allocate memory to control CPU reset&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span><span class="s">&quot;cpureset_assert(%d)&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>

	<span class="n">da</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="cm">/* Write the CPUCS register on the 8051.  The lsb of the register</span>
<span class="cm">	   is the reset bit; a 1 asserts reset while a 0 clears it. */</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">usb_dev</span><span class="p">,</span><span class="n">pipe</span><span class="p">,</span><span class="mh">0xa0</span><span class="p">,</span><span class="mh">0x40</span><span class="p">,</span><span class="mh">0xe600</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="n">da</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_ERROR_LEGS</span><span class="p">,</span>
			   <span class="s">&quot;cpureset_assert(%d) error=%d&quot;</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">ret</span><span class="p">);</span>
		<span class="n">pvr2_hdw_render_useless</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">da</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_cmd_deep_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">FX2CMD_DEEP_RESET</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_cmd_powerup</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">FX2CMD_POWER_ON</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_cmd_powerdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">FX2CMD_POWER_OFF</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_cmd_decoder_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
		   <span class="s">&quot;Requesting decoder reset&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_client_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_client_id</span><span class="p">,</span>
				     <span class="n">core</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pvr2_hdw_cx25840_vbi_hack</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_INIT</span><span class="p">,</span>
		   <span class="s">&quot;Unable to reset decoder: nothing attached&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_cmd_hcw_demod_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span>
				     <span class="n">FX2CMD_HCW_DEMOD_RESETIN</span> <span class="o">|</span>
				     <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				     <span class="p">((</span><span class="n">onoff</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_cmd_onair_fe_power_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,(</span><span class="n">onoff</span> <span class="o">?</span>
					  <span class="n">FX2CMD_ONAIR_DTV_POWER_ON</span> <span class="o">:</span>
					  <span class="n">FX2CMD_ONAIR_DTV_POWER_OFF</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_cmd_onair_digital_path_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,(</span><span class="n">onoff</span> <span class="o">?</span>
					  <span class="n">FX2CMD_ONAIR_DTV_STREAMING_ON</span> <span class="o">:</span>
					  <span class="n">FX2CMD_ONAIR_DTV_STREAMING_OFF</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_cmd_modeswitch</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">digitalFl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cmode</span><span class="p">;</span>
	<span class="cm">/* Compare digital/analog desired setting with current setting.  If</span>
<span class="cm">	   they don&#39;t match, fix it... */</span>
	<span class="n">cmode</span> <span class="o">=</span> <span class="p">(</span><span class="n">digitalFl</span> <span class="o">?</span> <span class="n">PVR2_PATHWAY_DIGITAL</span> <span class="o">:</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmode</span> <span class="o">==</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* They match; nothing to do */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">digital_control_scheme</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PVR2_DIGITAL_SCHEME_HAUPPAUGE</span>:
		<span class="n">pvr2_hdw_cmd_hcw_demod_reset</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">digitalFl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmode</span> <span class="o">==</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If moving to analog mode, also force the decoder</span>
<span class="cm">			   to reset.  If no decoder is attached, then it&#39;s</span>
<span class="cm">			   ok to ignore this because if/when the decoder</span>
<span class="cm">			   attaches, it will reset itself at that time. */</span>
			<span class="n">pvr2_hdw_cmd_decoder_reset</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PVR2_DIGITAL_SCHEME_ONAIR</span>:
		<span class="cm">/* Supposedly we should always have the power on whether in</span>
<span class="cm">		   digital or analog mode.  But for now do what appears to</span>
<span class="cm">		   work... */</span>
		<span class="n">pvr2_hdw_cmd_onair_fe_power_ctrl</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">digitalFl</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pvr2_hdw_untrip_unlocked</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">=</span> <span class="n">cmode</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_led_ctrl_hauppauge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* change some GPIO data</span>
<span class="cm">	 *</span>
<span class="cm">	 * note: bit d7 of dir appears to control the LED,</span>
<span class="cm">	 * so we shut it off here.</span>
<span class="cm">	 *</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_gpio_chg_dir</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000481</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_gpio_chg_dir</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000401</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pvr2_hdw_gpio_chg_out</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">led_method_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">,</span><span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="n">led_method_func</span> <span class="n">led_methods</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">PVR2_LED_SCHEME_HAUPPAUGE</span><span class="p">]</span> <span class="o">=</span> <span class="n">pvr2_led_ctrl_hauppauge</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* Toggle LED */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_led_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">scheme_id</span><span class="p">;</span>
	<span class="n">led_method_func</span> <span class="n">fp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">onoff</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">led_on</span><span class="p">))</span> <span class="k">return</span><span class="p">;</span>

	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">led_on</span> <span class="o">=</span> <span class="n">onoff</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">scheme_id</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">led_scheme</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scheme_id</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">led_methods</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="n">led_methods</span><span class="p">[</span><span class="n">scheme_id</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fp</span><span class="p">)</span> <span class="p">(</span><span class="o">*</span><span class="n">fp</span><span class="p">)(</span><span class="n">hdw</span><span class="p">,</span><span class="n">onoff</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Stop / start video stream transport */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_cmd_usbstream</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">runFl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* If we&#39;re in analog mode, then just issue the usual analog</span>
<span class="cm">	   command. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">==</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span>
					     <span class="p">(</span><span class="n">runFl</span> <span class="o">?</span>
					      <span class="n">FX2CMD_STREAMING_ON</span> <span class="o">:</span>
					      <span class="n">FX2CMD_STREAMING_OFF</span><span class="p">));</span>
		<span class="cm">/*Note: Not reached */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">!=</span> <span class="n">PVR2_PATHWAY_DIGITAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Whoops, we don&#39;t know what mode we&#39;re in... */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* To get here we have to be in digital mode.  The mechanism here</span>
<span class="cm">	   is unfortunately different for different vendors.  So we switch</span>
<span class="cm">	   on the device&#39;s digital scheme attribute in order to figure out</span>
<span class="cm">	   what to do. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">digital_control_scheme</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PVR2_DIGITAL_SCHEME_HAUPPAUGE</span>:
		<span class="k">return</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span>
					     <span class="p">(</span><span class="n">runFl</span> <span class="o">?</span>
					      <span class="n">FX2CMD_HCW_DTV_STREAMING_ON</span> <span class="o">:</span>
					      <span class="n">FX2CMD_HCW_DTV_STREAMING_OFF</span><span class="p">));</span>
	<span class="k">case</span> <span class="n">PVR2_DIGITAL_SCHEME_ONAIR</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_issue_simple_cmd</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">runFl</span> <span class="o">?</span>
					     <span class="n">FX2CMD_STREAMING_ON</span> <span class="o">:</span>
					     <span class="n">FX2CMD_STREAMING_OFF</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">pvr2_hdw_cmd_onair_digital_path_ctrl</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">runFl</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Evaluate whether or not state_pathway_ok can change */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_eval_pathway_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Nothing to do if pathway is already ok */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Not allowed to change anything if pipeline is not idle */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pvr2_hdw_cmd_modeswitch</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_DTV</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_pathway_ok&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Evaluate whether or not state_encoder_ok can change */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_eval_encoder_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_tripped</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_config</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_usbstream_run</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">==</span> <span class="n">PVR2_PATHWAY_DIGITAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_digital_requires_cx23416</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">!=</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_upload_firmware2</span><span class="p">(</span><span class="n">hdw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_tripped</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;flag_tripped&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_tripped</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_encoder_ok&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Evaluate whether or not state_encoder_config can change */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_eval_encoder_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_config</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_encoder_waitok&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span><span class="p">);</span>
		<span class="cm">/* paranoia - solve race if timer just completed */</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">!=</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_idle</span> <span class="o">||</span>
		    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We must reset the enforced wait interval if</span>
<span class="cm">			   anything has happened that might have disturbed</span>
<span class="cm">			   the encoder.  This should be a rare case. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Must clear the state - therefore we did</span>
<span class="cm">				   something to a state bit and must also</span>
<span class="cm">				   return true. */</span>
				<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_encoder_waitok&quot;</span><span class="p">,</span>
					    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* waitok flag wasn&#39;t set and timer isn&#39;t</span>
<span class="cm">				   running.  Check flag once more to avoid</span>
<span class="cm">				   a race then start the timer.  This is</span>
<span class="cm">				   the point when we measure out a minimal</span>
<span class="cm">				   quiet interval before doing something to</span>
<span class="cm">				   the encoder. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
						<span class="n">jiffies</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">TIME_MSEC_ENCODER_WAIT</span>
						 <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
					<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_wait_timer</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* We can&#39;t continue until we know we have been</span>
<span class="cm">			   quiet for the interval measured by this</span>
<span class="cm">			   timer. */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pvr2_encoder_configure</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_config</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_encoder_config&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_config</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Return true if the encoder should not be running. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_check_disable_encoder_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Encoder isn&#39;t healthy at the moment, so stop it. */</span>
		<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mode is not understood at the moment (i.e. it wants to</span>
<span class="cm">		   change), so encoder must be stopped. */</span>
		<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PVR2_PATHWAY_ANALOG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We&#39;re in analog mode and the decoder is not</span>
<span class="cm">			   running; thus the encoder should be stopped as</span>
<span class="cm">			   well. */</span>
			<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PVR2_PATHWAY_DIGITAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is a funny case.  We&#39;re in digital mode so</span>
<span class="cm">			   really the encoder should be stopped.  However</span>
<span class="cm">			   if it really is running, only kill it after</span>
<span class="cm">			   runok has been set.  This gives a chance for the</span>
<span class="cm">			   onair quirk to function (encoder must run</span>
<span class="cm">			   briefly first, at least once, before onair</span>
<span class="cm">			   digital streaming can work). */</span>
			<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Unknown mode; so encoder should be stopped. */</span>
		<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we get here, we haven&#39;t found a reason to stop the</span>
<span class="cm">	   encoder. */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Return true if the encoder should be running. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_check_enable_encoder_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t run the encoder if it isn&#39;t healthy... */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t run the encoder if we don&#39;t (yet) know what mode</span>
<span class="cm">		   we need to be in... */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PVR2_PATHWAY_ANALOG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_ready</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* In analog mode, if the decoder is running, then</span>
<span class="cm">			   run the encoder. */</span>
			<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PVR2_PATHWAY_DIGITAL</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">digital_control_scheme</span> <span class="o">==</span>
		     <span class="n">PVR2_DIGITAL_SCHEME_ONAIR</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is a quirk.  OnAir hardware won&#39;t stream</span>
<span class="cm">			   digital until the encoder has been run at least</span>
<span class="cm">			   once, for a minimal period of time (empiricially</span>
<span class="cm">			   measured to be 1/4 second).  So if we&#39;re on</span>
<span class="cm">			   OnAir hardware and the encoder has never been</span>
<span class="cm">			   run at all, then start the encoder.  Normal</span>
<span class="cm">			   state machine logic in the driver will</span>
<span class="cm">			   automatically handle the remaining bits. */</span>
			<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* For completeness (unknown mode; encoder won&#39;t run ever) */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If we get here, then we haven&#39;t found any reason to run the</span>
<span class="cm">	   encoder, so don&#39;t run it. */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Evaluate whether or not state_encoder_run can change */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_eval_encoder_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state_check_disable_encoder_run</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_encoder_stop</span><span class="p">(</span><span class="n">hdw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state_check_enable_encoder_run</span><span class="p">(</span><span class="n">hdw</span><span class="p">))</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_encoder_start</span><span class="p">(</span><span class="n">hdw</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
				<span class="n">jiffies</span> <span class="o">+</span> <span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">TIME_MSEC_ENCODER_OK</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">encoder_run_timer</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_encoder_run&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Timeout function for quiescent timer. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_quiescent_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_decoder_quiescent&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workpoll</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Timeout function for decoder stabilization timer. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_decoder_stabilization_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_ready</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_decoder_ready&quot;</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_ready</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workpoll</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Timeout function for encoder wait timer. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_encoder_wait_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_encoder_waitok&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workpoll</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Timeout function for encoder run timer. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_encoder_run_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_encoder_runok&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workpoll</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Evaluate whether or not state_decoder_run can change */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_eval_decoder_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span> <span class="o">&amp;&amp;</span>
			    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_decoder_missed</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pvr2_decoder_enable</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* paranoia - solve race if timer(s) just completed */</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">);</span>
		<span class="cm">/* Kill the stabilization timer, in case we&#39;re killing the</span>
<span class="cm">		   encoder before the previous stabilization interval has</span>
<span class="cm">		   been properly timed. */</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_stabilization_timer</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* We don&#39;t do something about the</span>
<span class="cm">				   quiescent timer until right here because</span>
<span class="cm">				   we also want to catch cases where the</span>
<span class="cm">				   decoder was already not running (like</span>
<span class="cm">				   after initialization) as opposed to</span>
<span class="cm">				   knowing that we had just stopped it.</span>
<span class="cm">				   The second flag check is here to cover a</span>
<span class="cm">				   race - the timer could have run and set</span>
<span class="cm">				   this flag just after the previous check</span>
<span class="cm">				   but before we did the pending check. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
						<span class="n">jiffies</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">TIME_MSEC_DECODER_WAIT</span>
						 <span class="o">/</span> <span class="mi">1000</span><span class="p">);</span>
					<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* Don&#39;t allow decoder to start again until it has</span>
<span class="cm">			   been quiesced first.  This little detail should</span>
<span class="cm">			   hopefully further stabilize the encoder. */</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">!=</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span> <span class="o">||</span>
		    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_config</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">quiescent_timer</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_decoder_missed</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_decoder_enable</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="o">!</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_ready</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_client_id</span> <span class="o">==</span> <span class="n">PVR2_CLIENT_ID_SAA7115</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_stabilization_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
				<span class="n">jiffies</span> <span class="o">+</span>
				<span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="n">TIME_MSEC_DECODER_STABILIZATION_WAIT</span> <span class="o">/</span>
				 <span class="mi">1000</span><span class="p">);</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">decoder_stabilization_timer</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_ready</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_decoder_quiescent&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span><span class="p">);</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_decoder_run&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span><span class="p">);</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_decoder_ready&quot;</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_ready</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Evaluate whether or not state_usbstream_run can change */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_eval_usbstream_run</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_usbstream_run</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fl</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">==</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fl</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span> <span class="o">&amp;&amp;</span>
			      <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">==</span> <span class="n">PVR2_PATHWAY_DIGITAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_digital_requires_cx23416</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fl</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fl</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span> <span class="o">&amp;&amp;</span>
		    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pvr2_hdw_cmd_usbstream</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_usbstream_run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span> <span class="o">||</span>
		    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">==</span> <span class="n">PVR2_PATHWAY_ANALOG</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span> <span class="o">||</span>
			    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">==</span> <span class="n">PVR2_PATHWAY_DIGITAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			   <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_digital_requires_cx23416</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">digital_control_scheme</span> <span class="o">==</span>
			    <span class="n">PVR2_DIGITAL_SCHEME_ONAIR</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* OnAir digital receivers won&#39;t stream</span>
<span class="cm">				   unless the analog encoder has run first.</span>
<span class="cm">				   Why?  I have no idea.  But don&#39;t even</span>
<span class="cm">				   try until we know the analog side is</span>
<span class="cm">				   known to have run. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pvr2_hdw_cmd_usbstream</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="o">!</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_usbstream_run</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_usbstream_run&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_usbstream_run</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Attempt to configure pipeline, if needed */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_eval_pipeline_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span> <span class="o">||</span>
	    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pvr2_hdw_commit_execute</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Update pipeline idle and pipeline pause tracking states based on other</span>
<span class="cm">   inputs.  This must be called whenever the other relevant inputs have</span>
<span class="cm">   changed. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_update_pipeline_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">st</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">updatedFl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Update pipeline state */</span>
	<span class="n">st</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span> <span class="o">||</span>
	       <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span> <span class="o">||</span>
	       <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_usbstream_run</span> <span class="o">||</span>
	       <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">st</span> <span class="o">!=</span> <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_idle</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
		<span class="n">updatedFl</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_idle</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">updatedFl</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">updatedFl</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">typedef</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">state_eval_func</span><span class="p">)(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="p">);</span>

<span class="cm">/* Set of functions to be run to evaluate various states in the driver. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">state_eval_func</span> <span class="n">eval_funcs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">state_eval_pathway_ok</span><span class="p">,</span>
	<span class="n">state_eval_pipeline_config</span><span class="p">,</span>
	<span class="n">state_eval_encoder_ok</span><span class="p">,</span>
	<span class="n">state_eval_encoder_config</span><span class="p">,</span>
	<span class="n">state_eval_decoder_run</span><span class="p">,</span>
	<span class="n">state_eval_encoder_run</span><span class="p">,</span>
	<span class="n">state_eval_usbstream_run</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/* Process various states and return true if we did anything interesting. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_state_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state_updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">check_flag</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">!=</span> <span class="n">FW1_STATE_OK</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* This loop is the heart of the entire driver.  It keeps trying to</span>
<span class="cm">	   evaluate various bits of driver state until nothing changes for</span>
<span class="cm">	   one full iteration.  Each &quot;bit of state&quot; tracks some global</span>
<span class="cm">	   aspect of the driver, e.g. whether decoder should run, if</span>
<span class="cm">	   pipeline is configured, usb streaming is on, etc.  We separately</span>
<span class="cm">	   evaluate each of those questions based on other driver state to</span>
<span class="cm">	   arrive at the correct running configuration. */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">check_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state_update_pipeline_state</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
		<span class="cm">/* Iterate over each bit of state */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span><span class="o">&lt;</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">eval_funcs</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">eval_funcs</span><span class="p">[</span><span class="n">i</span><span class="p">])(</span><span class="n">hdw</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">check_flag</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
				<span class="n">state_updated</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
				<span class="n">state_update_pipeline_state</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">check_flag</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span><span class="p">);</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_stale&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">state_updated</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">print_input_mask</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">msk</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">acnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span><span class="n">ccnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">control_values_input</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">msk</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
		<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">tcnt</span><span class="p">,</span>
				 <span class="n">acnt</span><span class="o">-</span><span class="n">tcnt</span><span class="p">,</span>
				 <span class="s">&quot;%s%s&quot;</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">tcnt</span> <span class="o">?</span> <span class="s">&quot;, &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
				 <span class="n">control_values_input</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tcnt</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">pvr2_pathway_state_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PVR2_PATHWAY_ANALOG</span>: <span class="k">return</span> <span class="s">&quot;analog&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PVR2_PATHWAY_DIGITAL</span>: <span class="k">return</span> <span class="s">&quot;digital&quot;</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_report_unlocked</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">which</span><span class="p">,</span>
					     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">acnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">which</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span>
			<span class="n">buf</span><span class="p">,</span><span class="n">acnt</span><span class="p">,</span>
			<span class="s">&quot;driver:%s%s%s%s%s &lt;mode=%s&gt;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span> <span class="o">?</span> <span class="s">&quot; &lt;ok&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot; &lt;fail&gt;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_init_ok</span> <span class="o">?</span> <span class="s">&quot; &lt;init&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot; &lt;uninitialized&gt;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_disconnected</span> <span class="o">?</span> <span class="s">&quot; &lt;disconnected&gt;&quot;</span> <span class="o">:</span>
			 <span class="s">&quot; &lt;connected&gt;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_tripped</span> <span class="o">?</span> <span class="s">&quot; &lt;tripped&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_decoder_missed</span> <span class="o">?</span> <span class="s">&quot; &lt;no decoder&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
			<span class="n">pvr2_pathway_state_name</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span><span class="p">));</span>

	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span>
			<span class="n">buf</span><span class="p">,</span><span class="n">acnt</span><span class="p">,</span>
			<span class="s">&quot;pipeline:%s%s%s%s&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_idle</span> <span class="o">?</span> <span class="s">&quot; &lt;idle&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_config</span> <span class="o">?</span>
			 <span class="s">&quot; &lt;configok&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot; &lt;stale&gt;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_req</span> <span class="o">?</span> <span class="s">&quot; &lt;req&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pipeline_pause</span> <span class="o">?</span> <span class="s">&quot; &lt;pause&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span>
			<span class="n">buf</span><span class="p">,</span><span class="n">acnt</span><span class="p">,</span>
			<span class="s">&quot;worker:%s%s%s%s%s%s%s&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span> <span class="o">?</span>
			 <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_ready</span> <span class="o">?</span>
			  <span class="s">&quot;&lt;decode:run&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot; &lt;decode:start&gt;&quot;</span><span class="p">)</span> <span class="o">:</span>
			 <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span> <span class="o">?</span>
			  <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; &lt;decode:stop&gt;&quot;</span><span class="p">)),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_quiescent</span> <span class="o">?</span>
			 <span class="s">&quot; &lt;decode:quiescent&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span> <span class="o">?</span>
			 <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; &lt;encode:init&gt;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span> <span class="o">?</span>
			 <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span> <span class="o">?</span>
			  <span class="s">&quot; &lt;encode:run&gt;&quot;</span> <span class="o">:</span>
			  <span class="s">&quot; &lt;encode:firstrun&gt;&quot;</span><span class="p">)</span> <span class="o">:</span>
			 <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_runok</span> <span class="o">?</span>
			  <span class="s">&quot; &lt;encode:stop&gt;&quot;</span> <span class="o">:</span>
			  <span class="s">&quot; &lt;encode:virgin&gt;&quot;</span><span class="p">)),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_config</span> <span class="o">?</span>
			 <span class="s">&quot; &lt;encode:configok&gt;&quot;</span> <span class="o">:</span>
			 <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_waitok</span> <span class="o">?</span>
			  <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot; &lt;encode:waitok&gt;&quot;</span><span class="p">)),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_usbstream_run</span> <span class="o">?</span>
			 <span class="s">&quot; &lt;usb:run&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot; &lt;usb:stop&gt;&quot;</span><span class="p">),</span>
			<span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_pathway_ok</span> <span class="o">?</span>
			 <span class="s">&quot; &lt;pathway:ok&gt;&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span>
			<span class="n">buf</span><span class="p">,</span><span class="n">acnt</span><span class="p">,</span>
			<span class="s">&quot;state: %s&quot;</span><span class="p">,</span>
			<span class="n">pvr2_get_state_name</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">master_state</span><span class="p">));</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccnt</span><span class="p">;</span>

		<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span>
				 <span class="n">acnt</span><span class="p">,</span>
				 <span class="s">&quot;Hardware supported inputs: &quot;</span><span class="p">);</span>
		<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
		<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">print_input_mask</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_avail_mask</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">+</span><span class="n">tcnt</span><span class="p">,</span>
					 <span class="n">acnt</span><span class="o">-</span><span class="n">tcnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_avail_mask</span> <span class="o">!=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">tcnt</span><span class="p">,</span>
					 <span class="n">acnt</span><span class="o">-</span><span class="n">tcnt</span><span class="p">,</span>
					 <span class="s">&quot;; allowed inputs: &quot;</span><span class="p">);</span>
			<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
			<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">print_input_mask</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span><span class="p">,</span>
						 <span class="n">buf</span><span class="o">+</span><span class="n">tcnt</span><span class="p">,</span>
						 <span class="n">acnt</span><span class="o">-</span><span class="n">tcnt</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">tcnt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">pvr2_stream_stats</span> <span class="n">stats</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">pvr2_stream_get_stats</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">vid_stream</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">stats</span><span class="p">,</span>
				      <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span>
			<span class="n">buf</span><span class="p">,</span><span class="n">acnt</span><span class="p">,</span>
			<span class="s">&quot;Bytes streamed=%u&quot;</span>
			<span class="s">&quot; URBs: queued=%u idle=%u ready=%u&quot;</span>
			<span class="s">&quot; processed=%u failed=%u&quot;</span><span class="p">,</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">bytes_processed</span><span class="p">,</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">buffers_in_queue</span><span class="p">,</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">buffers_in_idle</span><span class="p">,</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">buffers_in_ready</span><span class="p">,</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">buffers_processed</span><span class="p">,</span>
			<span class="n">stats</span><span class="p">.</span><span class="n">buffers_failed</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ir_scheme_active</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">acnt</span><span class="p">,</span> <span class="s">&quot;ir scheme: id=%d %s&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ir_scheme_names</span><span class="p">)</span> <span class="o">?</span>
				  <span class="s">&quot;?&quot;</span> <span class="o">:</span> <span class="n">ir_scheme_names</span><span class="p">[</span><span class="n">id</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="nl">default:</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Generate report containing info about attached sub-devices and attached</span>
<span class="cm">   i2c clients, including an indication of which attached i2c clients are</span>
<span class="cm">   actually sub-devices. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_report_clients</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
					    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">acnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccnt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">acnt</span><span class="p">,</span> <span class="s">&quot;Associated v4l2-subdev drivers and I2C clients:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
	<span class="n">v4l2_device_for_each_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">module_names</span><span class="p">))</span> <span class="n">p</span> <span class="o">=</span> <span class="n">module_names</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">tcnt</span><span class="p">,</span> <span class="n">acnt</span> <span class="o">-</span> <span class="n">tcnt</span><span class="p">,</span> <span class="s">&quot;  %s:&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
			<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">tcnt</span><span class="p">,</span> <span class="n">acnt</span> <span class="o">-</span> <span class="n">tcnt</span><span class="p">,</span>
					 <span class="s">&quot;  (unknown id=%u):&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">tcnt</span><span class="p">,</span> <span class="n">acnt</span> <span class="o">-</span> <span class="n">tcnt</span><span class="p">,</span>
					 <span class="s">&quot; %s @ %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					 <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
			<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ccnt</span> <span class="o">=</span> <span class="n">scnprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">tcnt</span><span class="p">,</span> <span class="n">acnt</span> <span class="o">-</span> <span class="n">tcnt</span><span class="p">,</span>
					 <span class="s">&quot; no i2c client</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tcnt</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_state_report</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">acnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bcnt</span><span class="p">,</span><span class="n">ccnt</span><span class="p">,</span><span class="n">idx</span><span class="p">;</span>
	<span class="n">bcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccnt</span> <span class="o">=</span> <span class="n">pvr2_hdw_report_unlocked</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">acnt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccnt</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span> <span class="n">acnt</span> <span class="o">-=</span> <span class="n">ccnt</span><span class="p">;</span> <span class="n">buf</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">acnt</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span> <span class="n">ccnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span> <span class="n">acnt</span> <span class="o">-=</span> <span class="n">ccnt</span><span class="p">;</span> <span class="n">buf</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccnt</span> <span class="o">=</span> <span class="n">pvr2_hdw_report_clients</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">acnt</span><span class="p">);</span>
	<span class="n">bcnt</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span> <span class="n">acnt</span> <span class="o">-=</span> <span class="n">ccnt</span><span class="p">;</span> <span class="n">buf</span> <span class="o">+=</span> <span class="n">ccnt</span><span class="p">;</span>
	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bcnt</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_state_log_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ccnt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">lcnt</span><span class="p">,</span> <span class="n">ucnt</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccnt</span> <span class="o">=</span> <span class="n">pvr2_hdw_report_unlocked</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">idx</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccnt</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">ccnt</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ccnt</span> <span class="o">=</span> <span class="n">pvr2_hdw_report_clients</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">ucnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ucnt</span> <span class="o">&lt;</span> <span class="n">ccnt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">lcnt</span> <span class="o">+</span> <span class="n">ucnt</span> <span class="o">&lt;</span> <span class="n">ccnt</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">lcnt</span> <span class="o">+</span> <span class="n">ucnt</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;\n&#39;</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">lcnt</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s %.*s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lcnt</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">ucnt</span><span class="p">);</span>
		<span class="n">ucnt</span> <span class="o">+=</span> <span class="n">lcnt</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Evaluate and update the driver&#39;s current state, taking various actions</span>
<span class="cm">   as appropriate for the update. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_state_eval</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">st</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">state_updated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">callback_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">analog_mode</span><span class="p">;</span>

	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STBITS</span><span class="p">,</span>
		   <span class="s">&quot;Drive state check START&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pvrusb2_debug</span> <span class="o">&amp;</span> <span class="n">PVR2_TRACE_STBITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_state_log_state</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Process all state and get back over disposition */</span>
	<span class="n">state_updated</span> <span class="o">=</span> <span class="n">pvr2_hdw_state_update</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>

	<span class="n">analog_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">pathway_state</span> <span class="o">!=</span> <span class="n">PVR2_PATHWAY_DIGITAL</span><span class="p">);</span>

	<span class="cm">/* Update master state based upon all other states. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">PVR2_STATE_DEAD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">fw1_state</span> <span class="o">!=</span> <span class="n">FW1_STATE_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">PVR2_STATE_COLD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">analog_mode</span> <span class="o">||</span>
		    <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">hdw_desc</span><span class="o">-&gt;</span><span class="n">flag_digital_requires_cx23416</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">PVR2_STATE_WARM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_tripped</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">analog_mode</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">flag_decoder_missed</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">PVR2_STATE_ERROR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_usbstream_run</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="o">!</span><span class="n">analog_mode</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_encoder_run</span> <span class="o">&amp;&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_decoder_run</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">PVR2_STATE_RUN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">st</span> <span class="o">=</span> <span class="n">PVR2_STATE_READY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">master_state</span> <span class="o">!=</span> <span class="n">st</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STATE</span><span class="p">,</span>
			   <span class="s">&quot;Device state change from %s to %s&quot;</span><span class="p">,</span>
			   <span class="n">pvr2_get_state_name</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">master_state</span><span class="p">),</span>
			   <span class="n">pvr2_get_state_name</span><span class="p">(</span><span class="n">st</span><span class="p">));</span>
		<span class="n">pvr2_led_ctrl</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">st</span> <span class="o">==</span> <span class="n">PVR2_STATE_RUN</span><span class="p">);</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">master_state</span> <span class="o">=</span> <span class="n">st</span><span class="p">;</span>
		<span class="n">state_updated</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
		<span class="n">callback_flag</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state_updated</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Trigger anyone waiting on any state changes here. */</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_wait_data</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pvrusb2_debug</span> <span class="o">&amp;</span> <span class="n">PVR2_TRACE_STBITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pvr2_hdw_state_log_state</span><span class="p">(</span><span class="n">hdw</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_STBITS</span><span class="p">,</span>
		   <span class="s">&quot;Drive state check DONE callback=%d&quot;</span><span class="p">,</span><span class="n">callback_flag</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">callback_flag</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Cause kernel thread to check / update driver state */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pvr2_hdw_state_sched</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span><span class="p">)</span> <span class="k">return</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="n">trace_stbit</span><span class="p">(</span><span class="s">&quot;state_stale&quot;</span><span class="p">,</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">state_stale</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">workpoll</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_gpio_get_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="n">u32</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pvr2_read_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_GPIO_DIR</span><span class="p">,</span><span class="n">dp</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_gpio_get_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="n">u32</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pvr2_read_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_GPIO_OUT</span><span class="p">,</span><span class="n">dp</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_gpio_get_in</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="n">u32</span> <span class="o">*</span><span class="n">dp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pvr2_read_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_GPIO_IN</span><span class="p">,</span><span class="n">dp</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_gpio_chg_dir</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="n">u32</span> <span class="n">msk</span><span class="p">,</span><span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cval</span><span class="p">,</span><span class="n">nval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">msk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_read_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_GPIO_DIR</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">nval</span> <span class="o">=</span> <span class="p">(</span><span class="n">cval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">msk</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">msk</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_GPIO</span><span class="p">,</span>
			   <span class="s">&quot;GPIO direction changing 0x%x:0x%x&quot;</span>
			   <span class="s">&quot; from 0x%x to 0x%x&quot;</span><span class="p">,</span>
			   <span class="n">msk</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">cval</span><span class="p">,</span><span class="n">nval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nval</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_GPIO</span><span class="p">,</span>
			   <span class="s">&quot;GPIO direction changing to 0x%x&quot;</span><span class="p">,</span><span class="n">nval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_GPIO_DIR</span><span class="p">,</span><span class="n">nval</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_gpio_chg_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="n">u32</span> <span class="n">msk</span><span class="p">,</span><span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cval</span><span class="p">,</span><span class="n">nval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">msk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pvr2_read_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_GPIO_OUT</span><span class="p">,</span><span class="o">&amp;</span><span class="n">cval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">nval</span> <span class="o">=</span> <span class="p">(</span><span class="n">cval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">msk</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">msk</span><span class="p">);</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_GPIO</span><span class="p">,</span>
			   <span class="s">&quot;GPIO output changing 0x%x:0x%x from 0x%x to 0x%x&quot;</span><span class="p">,</span>
			   <span class="n">msk</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">cval</span><span class="p">,</span><span class="n">nval</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">nval</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_GPIO</span><span class="p">,</span>
			   <span class="s">&quot;GPIO output changing to 0x%x&quot;</span><span class="p">,</span><span class="n">nval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">pvr2_write_register</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">PVR2_GPIO_OUT</span><span class="p">,</span><span class="n">nval</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">pvr2_hdw_status_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vtp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_info</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">vtp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vtp</span><span class="p">));</span>
	<span class="n">vtp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_RADIO</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">V4L2_TUNER_RADIO</span> <span class="o">:</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">tuner_signal_stale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Note: There apparently is no replacement for VIDIOC_CROPCAP</span>
<span class="cm">	   using v4l2-subdev - therefore we can&#39;t support that AT ALL right</span>
<span class="cm">	   now.  (Of course, no sub-drivers seem to implement it either.</span>
<span class="cm">	   But now it&#39;s a a chicken and egg problem...) */</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">g_tuner</span><span class="p">,</span> <span class="n">vtp</span><span class="p">);</span>
	<span class="n">pvr2_trace</span><span class="p">(</span><span class="n">PVR2_TRACE_CHIPS</span><span class="p">,</span> <span class="s">&quot;subdev status poll&quot;</span>
		   <span class="s">&quot; type=%u strength=%u audio=0x%x cap=0x%x&quot;</span>
		   <span class="s">&quot; low=%u hi=%u&quot;</span><span class="p">,</span>
		   <span class="n">vtp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
		   <span class="n">vtp</span><span class="o">-&gt;</span><span class="n">signal</span><span class="p">,</span> <span class="n">vtp</span><span class="o">-&gt;</span><span class="n">rxsubchans</span><span class="p">,</span> <span class="n">vtp</span><span class="o">-&gt;</span><span class="n">capability</span><span class="p">,</span>
		   <span class="n">vtp</span><span class="o">-&gt;</span><span class="n">rangelow</span><span class="p">,</span> <span class="n">vtp</span><span class="o">-&gt;</span><span class="n">rangehigh</span><span class="p">);</span>

	<span class="cm">/* We have to do this to avoid getting into constant polling if</span>
<span class="cm">	   there&#39;s nobody to answer a poll of cropcap info. */</span>
	<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cropcap_stale</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_get_input_available</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_avail_mask</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_get_input_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_set_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span><span class="kt">int</span> <span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">!=</span> <span class="n">v</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_dirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle side effects - if we switch to a mode that needs the RF</span>
<span class="cm">	   tuner, then select the right frequency choice as well and mark</span>
<span class="cm">	   it dirty. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_RADIO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqDirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_TV</span><span class="p">)</span> <span class="o">||</span>
		   <span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span> <span class="o">==</span> <span class="n">PVR2_CVAL_INPUT_DTV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqSelector</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">freqDirty</span> <span class="o">=</span> <span class="o">!</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_set_input_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">change_mask</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">change_val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nv</span><span class="p">,</span><span class="n">m</span><span class="p">,</span><span class="n">idx</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">nv</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">change_mask</span><span class="p">;</span>
		<span class="n">nv</span> <span class="o">|=</span> <span class="p">(</span><span class="n">change_val</span> <span class="o">&amp;</span> <span class="n">change_mask</span><span class="p">);</span>
		<span class="n">nv</span> <span class="o">&amp;=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_avail_mask</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">nv</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No legal modes left; return error instead. */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span> <span class="o">=</span> <span class="n">nv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_val</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Current mode is still in the allowed mask, so</span>
<span class="cm">			   we&#39;re done. */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Select and switch to a mode that is still in the allowed</span>
<span class="cm">		   mask */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Nothing legal; give up */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">m</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">input_allowed_mask</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">m</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">m</span><span class="p">))</span> <span class="k">continue</span><span class="p">;</span>
			<span class="n">pvr2_hdw_set_input</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span><span class="n">idx</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">big_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Find I2C address of eeprom */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pvr2_hdw_get_eeprom_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="n">LOCK_TAKE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span> <span class="k">do</span> <span class="p">{</span>
		<span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">FX2CMD_GET_EEPROM_ADDR</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">pvr2_send_request</span><span class="p">(</span><span class="n">hdw</span><span class="p">,</span>
					   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span>
					   <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">,</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">hdw</span><span class="o">-&gt;</span><span class="n">cmd_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span> <span class="n">LOCK_GIVE</span><span class="p">(</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">ctl_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">pvr2_hdw_register_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">pvr2_hdw</span> <span class="o">*</span><span class="n">hdw</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_dbg_match</span> <span class="o">*</span><span class="n">match</span><span class="p">,</span> <span class="n">u64</span> <span class="n">reg_id</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">setFl</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">val_ptr</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">okFl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">req</span><span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="o">*</span><span class="n">match</span><span class="p">;</span>
	<span class="n">req</span><span class="p">.</span><span class="n">reg</span> <span class="o">=</span> <span class="n">reg_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setFl</span><span class="p">)</span> <span class="n">req</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">val_ptr</span><span class="p">;</span>
	<span class="cm">/* It would be nice to know if a sub-device answered the request */</span>
	<span class="n">v4l2_device_call_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdw</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_register</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">setFl</span><span class="p">)</span> <span class="o">*</span><span class="n">val_ptr</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">okFl</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">  Stuff for Emacs to see, in order to encourage consistent editing style:</span>
<span class="cm">  *** Local Variables: ***</span>
<span class="cm">  *** mode: c ***</span>
<span class="cm">  *** fill-column: 75 ***</span>
<span class="cm">  *** tab-width: 8 ***</span>
<span class="cm">  *** c-basic-offset: 8 ***</span>
<span class="cm">  *** End: ***</span>
<span class="cm">  */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
