<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › sh_vou.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sh_vou.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SuperH Video Output Unit (VOU) driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010, Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;media/sh_vou.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;media/videobuf-dma-contig.h&gt;</span>

<span class="cm">/* Mirror addresses are not available for all registers */</span>
<span class="cp">#define VOUER	0</span>
<span class="cp">#define VOUCR	4</span>
<span class="cp">#define VOUSTR	8</span>
<span class="cp">#define VOUVCR	0xc</span>
<span class="cp">#define VOUISR	0x10</span>
<span class="cp">#define VOUBCR	0x14</span>
<span class="cp">#define VOUDPR	0x18</span>
<span class="cp">#define VOUDSR	0x1c</span>
<span class="cp">#define VOUVPR	0x20</span>
<span class="cp">#define VOUIR	0x24</span>
<span class="cp">#define VOUSRR	0x28</span>
<span class="cp">#define VOUMSR	0x2c</span>
<span class="cp">#define VOUHIR	0x30</span>
<span class="cp">#define VOUDFR	0x34</span>
<span class="cp">#define VOUAD1R	0x38</span>
<span class="cp">#define VOUAD2R	0x3c</span>
<span class="cp">#define VOUAIR	0x40</span>
<span class="cp">#define VOUSWR	0x44</span>
<span class="cp">#define VOURCR	0x48</span>
<span class="cp">#define VOURPR	0x50</span>

<span class="k">enum</span> <span class="n">sh_vou_status</span> <span class="p">{</span>
	<span class="n">SH_VOU_IDLE</span><span class="p">,</span>
	<span class="n">SH_VOU_INITIALISING</span><span class="p">,</span>
	<span class="n">SH_VOU_RUNNING</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define VOU_MAX_IMAGE_WIDTH	720</span>
<span class="cp">#define VOU_MAX_IMAGE_HEIGHT	576</span>

<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="n">atomic_t</span> <span class="n">use_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_vou_pdata</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="cm">/* State information */</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="n">pix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">rect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">queue</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pix_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">active</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">sh_vou_status</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">fop_lock</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="n">vbq</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Register access routines for sides A, B and mirror addresses */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_reg_a_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_reg_ab_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_reg_m_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			       <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span> <span class="o">+</span> <span class="mh">0x2000</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">sh_vou_reg_a_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_reg_a_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">old</span> <span class="o">=</span> <span class="n">__raw_readl</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">);</span>
	<span class="n">__raw_writel</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">+</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_reg_b_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sh_vou_reg_a_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">reg</span> <span class="o">+</span> <span class="mh">0x1000</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_reg_ab_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sh_vou_reg_a_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">sh_vou_reg_b_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sh_vou_fmt</span> <span class="p">{</span>
	<span class="n">u32</span>		<span class="n">pfmt</span><span class="p">;</span>
	<span class="kt">char</span>		<span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">bpp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">rgb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">yf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	<span class="n">pkf</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Further pixel formats can be added */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sh_vou_fmt</span> <span class="n">vou_fmt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">pfmt</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bpp</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>	<span class="o">=</span> <span class="s">&quot;YVU420 planar&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yf</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rgb</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">pfmt</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bpp</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>	<span class="o">=</span> <span class="s">&quot;YVYU planar&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yf</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rgb</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">pfmt</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bpp</span>	<span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>	<span class="o">=</span> <span class="s">&quot;RGB24&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pkf</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rgb</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">pfmt</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bpp</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>	<span class="o">=</span> <span class="s">&quot;RGB565&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pkf</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rgb</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">pfmt</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bpp</span>	<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">desc</span>	<span class="o">=</span> <span class="s">&quot;RGB565 byteswapped&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pkf</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rgb</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_schedule_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">addr1</span><span class="p">,</span> <span class="n">addr2</span><span class="p">;</span>

	<span class="n">addr1</span> <span class="o">=</span> <span class="n">videobuf_to_dma_contig</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV12</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV16</span>:
		<span class="n">addr2</span> <span class="o">=</span> <span class="n">addr1</span> <span class="o">+</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">addr2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sh_vou_reg_m_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUAD1R</span><span class="p">,</span> <span class="n">addr1</span><span class="p">);</span>
	<span class="n">sh_vou_reg_m_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUAD2R</span><span class="p">,</span> <span class="n">addr2</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_stream_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">row_coeff</span><span class="p">;</span>
<span class="cp">#ifdef __LITTLE_ENDIAN</span>
	<span class="n">u32</span> <span class="n">dataswap</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">u32</span> <span class="n">dataswap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV12</span>:
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_NV16</span>:
		<span class="n">row_coeff</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
		<span class="n">dataswap</span> <span class="o">^=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565X</span>:
		<span class="n">row_coeff</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
		<span class="n">row_coeff</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUSWR</span><span class="p">,</span> <span class="n">dataswap</span><span class="p">);</span>
	<span class="n">sh_vou_reg_ab_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUAIR</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">row_coeff</span><span class="p">);</span>
	<span class="n">sh_vou_schedule_next</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">free_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>

	<span class="cm">/* Wait until this buffer is no longer in STATE_QUEUED or STATE_ACTIVE */</span>
	<span class="n">videobuf_waiton</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">videobuf_dma_contig_free</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Locking: caller holds fop_lock mutex */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_buf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">vou_fmt</span><span class="p">[</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix_idx</span><span class="p">].</span><span class="n">bpp</span> <span class="o">*</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span>
		<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Taking into account maximum frame size, *count will stay &gt;= 2 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">)</span> <span class="o">*</span> <span class="o">*</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">/</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(): count=%d, size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="o">*</span><span class="n">size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Locking: caller holds fop_lock mutex */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_buf_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_per_line</span> <span class="o">=</span> <span class="n">vou_fmt</span><span class="p">[</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix_idx</span><span class="p">].</span><span class="n">bpp</span> <span class="o">*</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">!=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">||</span>
	    <span class="n">vb</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">!=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">||</span>
	    <span class="n">vb</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">!=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">field</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">)</span>
			<span class="n">free_buffer</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">bytes_per_line</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">baddr</span> <span class="o">&amp;&amp;</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">bsize</span> <span class="o">&lt;</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* User buffer too small */</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;User buffer too small: [%u] @ %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">vb</span><span class="o">-&gt;</span><span class="n">bsize</span><span class="p">,</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">baddr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_iolock</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IOLOCK buf-type %d: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">vb</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s(): fmt #%d, %u bytes per line, phys 0x%x, type %d, state %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix_idx</span><span class="p">,</span> <span class="n">bytes_per_line</span><span class="p">,</span>
		<span class="n">videobuf_to_dma_contig</span><span class="p">(</span><span class="n">vb</span><span class="p">),</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">memory</span><span class="p">,</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Locking: caller holds fop_lock mutex and vq-&gt;irqlock spinlock */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_buf_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">;</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">SH_VOU_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">vb</span><span class="p">;</span>
		<span class="cm">/* Start from side A: we use mirror addresses, so, set B */</span>
		<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOURPR</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: first buffer status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">sh_vou_reg_a_read</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUSTR</span><span class="p">));</span>
		<span class="n">sh_vou_schedule_next</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
		<span class="cm">/* Only activate VOU after the second buffer */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Second buffer - initialise register side B */</span>
		<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOURPR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">sh_vou_stream_start</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>

		<span class="cm">/* Register side switching with frame VSYNC */</span>
		<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOURCR</span><span class="p">,</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: second buffer status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">sh_vou_reg_a_read</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUSTR</span><span class="p">));</span>

		<span class="cm">/* Enable End-of-Frame (VSYNC) interrupts */</span>
		<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUIR</span><span class="p">,</span> <span class="mh">0x10004</span><span class="p">);</span>
		<span class="cm">/* Two buffers on the queue - activate the hardware */</span>

		<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SH_VOU_RUNNING</span><span class="p">;</span>
		<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUER</span><span class="p">,</span> <span class="mh">0x107</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_buf_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vq</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">==</span> <span class="n">vb</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* disable output */</span>
		<span class="n">sh_vou_reg_a_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* ...but the current frame will complete */</span>
		<span class="n">sh_vou_reg_a_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x30000</span><span class="p">);</span>
		<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VIDEOBUF_ACTIVE</span> <span class="o">||</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ERROR</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">free_buffer</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue_ops</span> <span class="n">sh_vou_video_qops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buf_setup</span>	<span class="o">=</span> <span class="n">sh_vou_buf_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span>	<span class="o">=</span> <span class="n">sh_vou_buf_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span>	<span class="o">=</span> <span class="n">sh_vou_buf_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_release</span>	<span class="o">=</span> <span class="n">sh_vou_buf_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Video IOCTLs */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;SuperH VOU&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span> <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Enumerate formats, that the device can accept from the user */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_enum_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vou_fmt</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">vou_fmt</span><span class="p">[</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">desc</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">));</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">vou_fmt</span><span class="p">[</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">pfmt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_g_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span> <span class="o">=</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vou_scale_h_num</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vou_scale_h_den</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vou_scale_h_fld</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vou_scale_v_num</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vou_scale_v_den</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">vou_scale_v_fld</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sh_vou_configure_geometry</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">,</span>
				      <span class="kt">int</span> <span class="n">pix_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w_idx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">h_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_fmt</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">vou_fmt</span> <span class="o">+</span> <span class="n">pix_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">black_left</span><span class="p">,</span> <span class="n">black_top</span><span class="p">,</span> <span class="n">width_max</span><span class="p">,</span> <span class="n">height_max</span><span class="p">,</span>
		<span class="n">frame_in_height</span><span class="p">,</span> <span class="n">frame_out_height</span><span class="p">,</span> <span class="n">frame_out_top</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vouvcr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dsr_h</span><span class="p">,</span> <span class="n">dsr_v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">width_max</span> <span class="o">=</span> <span class="mi">858</span><span class="p">;</span>
		<span class="n">height_max</span> <span class="o">=</span> <span class="mi">262</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">width_max</span> <span class="o">=</span> <span class="mi">864</span><span class="p">;</span>
		<span class="n">height_max</span> <span class="o">=</span> <span class="mi">312</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame_in_height</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">frame_out_height</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">frame_out_top</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Cropping scheme: max useful image is 720x480, and the total video</span>
<span class="cm">	 * area is 858x525 (NTSC) or 864x625 (PAL). AK8813 / 8814 starts</span>
<span class="cm">	 * sampling data beginning with fixed 276th (NTSC) / 288th (PAL) clock,</span>
<span class="cm">	 * of which the first 33 / 25 clocks HSYNC must be held active. This</span>
<span class="cm">	 * has to be configured in CR[HW]. 1 pixel equals 2 clock periods.</span>
<span class="cm">	 * This gives CR[HW] = 16 / 12, VPR[HVP] = 138 / 144, which gives</span>
<span class="cm">	 * exactly 858 - 138 = 864 - 144 = 720! We call the out-of-display area,</span>
<span class="cm">	 * beyond DSR, specified on the left and top by the VPR register &quot;black</span>
<span class="cm">	 * pixels&quot; and out-of-image area (DPR) &quot;background pixels.&quot; We fix VPR</span>
<span class="cm">	 * at 138 / 144 : 20, because that&#39;s the HSYNC timing, that our first</span>
<span class="cm">	 * client requires, and that&#39;s exactly what leaves us 720 pixels for the</span>
<span class="cm">	 * image; we leave VPR[VVP] at default 20 for now, because the client</span>
<span class="cm">	 * doesn&#39;t seem to have any special requirements for it. Otherwise we</span>
<span class="cm">	 * could also set it to max - 240 = 22 / 72. Thus VPR depends only on</span>
<span class="cm">	 * the selected standard, and DPR and DSR are selected according to</span>
<span class="cm">	 * cropping. Q: how does the client detect the first valid line? Does</span>
<span class="cm">	 * HSYNC stay inactive during invalid (black) lines?</span>
<span class="cm">	 */</span>
	<span class="n">black_left</span> <span class="o">=</span> <span class="n">width_max</span> <span class="o">-</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">;</span>
	<span class="n">black_top</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="n">dsr_h</span> <span class="o">=</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
	<span class="n">dsr_v</span> <span class="o">=</span> <span class="n">frame_out_height</span> <span class="o">+</span> <span class="n">frame_out_top</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;image %ux%u, black %u:%u, offset %u:%u, display %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">frame_in_height</span><span class="p">,</span> <span class="n">black_left</span><span class="p">,</span> <span class="n">black_top</span><span class="p">,</span>
		<span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">frame_out_top</span><span class="p">,</span> <span class="n">dsr_h</span><span class="p">,</span> <span class="n">dsr_v</span><span class="p">);</span>

	<span class="cm">/* VOUISR height - half of a frame height in frame mode */</span>
	<span class="n">sh_vou_reg_ab_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUISR</span><span class="p">,</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">frame_in_height</span><span class="p">);</span>
	<span class="n">sh_vou_reg_ab_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUVPR</span><span class="p">,</span> <span class="p">(</span><span class="n">black_left</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">black_top</span><span class="p">);</span>
	<span class="n">sh_vou_reg_ab_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUDPR</span><span class="p">,</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">frame_out_top</span><span class="p">);</span>
	<span class="n">sh_vou_reg_ab_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUDSR</span><span class="p">,</span> <span class="p">(</span><span class="n">dsr_h</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">dsr_v</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * if necessary, we could set VOUHIR to</span>
<span class="cm">	 * max(black_left + dsr_h, width_max) here</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w_idx</span><span class="p">)</span>
		<span class="n">vouvcr</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">15</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vou_scale_h_fld</span><span class="p">[</span><span class="n">w_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">h_idx</span><span class="p">)</span>
		<span class="n">vouvcr</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="n">vou_scale_v_fld</span><span class="p">[</span><span class="n">h_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: scaling 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">,</span> <span class="n">vouvcr</span><span class="p">);</span>

	<span class="cm">/* To produce a colour bar for testing set bit 23 of VOUVCR */</span>
	<span class="n">sh_vou_reg_ab_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUVCR</span><span class="p">,</span> <span class="n">vouvcr</span><span class="p">);</span>
	<span class="n">sh_vou_reg_ab_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUDFR</span><span class="p">,</span>
			    <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pkf</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">yf</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">rgb</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">sh_vou_geometry</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">output</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">in_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scale_idx_h</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scale_idx_v</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Find input geometry, that we can use to produce output, closest to the</span>
<span class="cm"> * requested rectangle, using VOU scaling</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vou_adjust_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The compiler cannot know, that best and idx will indeed be set */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">best_err</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span> <span class="n">best</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_height_max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">img_height_max</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">img_height_max</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>

	<span class="cm">/* Image width must be a multiple of 4 */</span>
	<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_height_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Select scales to come as close as possible to the output image */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vou_scale_h_num</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">vou_scale_h_den</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
			<span class="n">vou_scale_h_num</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&gt;</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">)</span>
			<span class="cm">/* scales increase */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_width</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="n">best_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_width</span> <span class="o">=</span> <span class="n">best</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">scale_idx_h</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">best_err</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>

	<span class="cm">/* This loop can be replaced with one division */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vou_scale_v_num</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">vou_scale_v_den</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
			<span class="n">vou_scale_v_num</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&gt;</span> <span class="n">img_height_max</span><span class="p">)</span>
			<span class="cm">/* scales increase */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="n">best_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_height</span> <span class="o">=</span> <span class="n">best</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">scale_idx_v</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find output geometry, that we can produce, using VOU scaling, closest to</span>
<span class="cm"> * the requested rectangle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vou_adjust_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_geometry</span> <span class="o">*</span><span class="n">geo</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">best_err</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">,</span> <span class="n">best</span><span class="p">,</span> <span class="n">width_max</span><span class="p">,</span> <span class="n">height_max</span><span class="p">,</span>
		<span class="n">img_height_max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">width_max</span> <span class="o">=</span> <span class="mi">858</span><span class="p">;</span>
		<span class="n">height_max</span> <span class="o">=</span> <span class="mi">262</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">img_height_max</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">width_max</span> <span class="o">=</span> <span class="mi">864</span><span class="p">;</span>
		<span class="n">height_max</span> <span class="o">=</span> <span class="mi">312</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">img_height_max</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Select scales to come as close as possible to the output image */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vou_scale_h_num</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_width</span> <span class="o">*</span> <span class="n">vou_scale_h_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
			<span class="n">vou_scale_h_den</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&gt;</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">)</span>
			<span class="cm">/* scales increase */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="n">best_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">best</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">scale_idx_h</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">best</span> <span class="o">&gt;</span> <span class="n">width_max</span><span class="p">)</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">width_max</span> <span class="o">-</span> <span class="n">best</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s(): W %u * %u/%u = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_width</span><span class="p">,</span>
		 <span class="n">vou_scale_h_num</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vou_scale_h_den</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">best</span><span class="p">);</span>

	<span class="n">best_err</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>

	<span class="cm">/* This loop can be replaced with one division */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vou_scale_v_num</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_height</span> <span class="o">*</span> <span class="n">vou_scale_v_num</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">/</span>
			<span class="n">vou_scale_v_den</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span> <span class="o">&gt;</span> <span class="n">img_height_max</span><span class="p">)</span>
			<span class="cm">/* scales increase */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">found</span> <span class="o">-</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="n">best_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">best_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">found</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">best</span><span class="p">;</span>
	<span class="n">geo</span><span class="o">-&gt;</span><span class="n">scale_idx_v</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">best</span> <span class="o">&gt;</span> <span class="n">height_max</span><span class="p">)</span>
		<span class="n">geo</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">height_max</span> <span class="o">-</span> <span class="n">best</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s(): H %u * %u/%u = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">geo</span><span class="o">-&gt;</span><span class="n">in_height</span><span class="p">,</span>
		 <span class="n">vou_scale_v_num</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">vou_scale_v_den</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">best</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_s_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">img_height_max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pix_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_vou_geometry</span> <span class="n">geo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mbfmt</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Revisit: is this the correct code? */</span>
		<span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(): %ux%u -&gt; %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">)</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">||</span>
	    <span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">!=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">pix_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pix_idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vou_fmt</span><span class="p">);</span> <span class="n">pix_idx</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vou_fmt</span><span class="p">[</span><span class="n">pix_idx</span><span class="p">].</span><span class="n">pfmt</span> <span class="o">==</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pix_idx</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vou_fmt</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">img_height_max</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">img_height_max</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>

	<span class="cm">/* Image width must be a multiple of 4 */</span>
	<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_height_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">geo</span><span class="p">.</span><span class="n">in_width</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">geo</span><span class="p">.</span><span class="n">in_height</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">geo</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">;</span>

	<span class="n">vou_adjust_output</span><span class="p">(</span><span class="o">&amp;</span><span class="n">geo</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>

	<span class="n">mbfmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mbfmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span>
					 <span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbfmt</span><span class="p">);</span>
	<span class="cm">/* Must be implemented, so, don&#39;t check for -ENOIOCTLCMD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(): %ux%u -&gt; %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">mbfmt</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mbfmt</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* Sanity checks */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">mbfmt</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span> <span class="o">||</span>
	    <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">mbfmt</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">img_height_max</span> <span class="o">||</span>
	    <span class="n">mbfmt</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mbfmt</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span>
	    <span class="n">mbfmt</span><span class="p">.</span><span class="n">height</span> <span class="o">!=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">mbfmt</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">mbfmt</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

		<span class="n">vou_adjust_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">geo</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We tried to preserve output rectangle, but it could have changed */</span>
	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">rect</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">in_width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">in_height</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(): %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix_idx</span> <span class="o">=</span> <span class="n">pix_idx</span><span class="p">;</span>

	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span> <span class="o">=</span> <span class="o">*</span><span class="n">pix</span><span class="p">;</span>

	<span class="n">sh_vou_configure_geometry</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">pix_idx</span><span class="p">,</span>
				  <span class="n">geo</span><span class="p">.</span><span class="n">scale_idx_h</span><span class="p">,</span> <span class="n">geo</span><span class="p">.</span><span class="n">scale_idx_v</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_try_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VOU_MAX_IMAGE_HEIGHT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vou_fmt</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vou_fmt</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pfmt</span> <span class="o">==</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">vou_fmt</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pfmt</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">videobuf_reqbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_querybuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_qbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">buftype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* This calls our .buf_queue() (== sh_vou_buf_queue) */</span>
	<span class="k">return</span> <span class="n">videobuf_streamon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">buftype</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * This calls buf_release from host driver&#39;s videobuf_queue_ops for all</span>
<span class="cm">	 * remaining buffers. When the last buffer is freed, stop streaming</span>
<span class="cm">	 */</span>
	<span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">);</span>
	<span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">sh_vou_ntsc_mode</span><span class="p">(</span><span class="k">enum</span> <span class="n">sh_vou_bus_fmt</span> <span class="n">bus_fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bus_fmt</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s(): Invalid bus-format code %d, using default 8-bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">bus_fmt</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">SH_VOU_BUS_8BIT</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SH_VOU_BUS_16BIT</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SH_VOU_BUS_BT656</span>:
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(): 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">std_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std_id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">tvnorms</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span>
					 <span class="n">s_std_output</span><span class="p">,</span> <span class="o">*</span><span class="n">std_id</span><span class="p">);</span>
	<span class="cm">/* Shall we continue, if the subdev doesn&#39;t support .s_std_output()? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std_id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">sh_vou_reg_ab_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUCR</span><span class="p">,</span>
			<span class="n">sh_vou_ntsc_mode</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus_fmt</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">sh_vou_reg_ab_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUCR</span><span class="p">,</span> <span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">);</span>

	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="o">*</span><span class="n">std_id</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">=</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Assume a dull encoder, do all the work ourselves. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="n">sd_crop</span> <span class="o">=</span> <span class="p">{.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_vou_geometry</span> <span class="n">geo</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mbfmt</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Revisit: is this the correct code? */</span>
		<span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">img_height_max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(): %ux%u@%u:%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">img_height_max</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">img_height_max</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>

	<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">img_height_max</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">)</span>
		<span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&gt;</span> <span class="n">img_height_max</span><span class="p">)</span>
		<span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">img_height_max</span> <span class="o">-</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="n">geo</span><span class="p">.</span><span class="n">output</span> <span class="o">=</span> <span class="o">*</span><span class="n">rect</span><span class="p">;</span>
	<span class="n">geo</span><span class="p">.</span><span class="n">in_width</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">geo</span><span class="p">.</span><span class="n">in_height</span> <span class="o">=</span> <span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/* Configure the encoder one-to-one, position at 0, ignore errors */</span>
	<span class="n">sd_crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">sd_crop</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We first issue a S_CROP, so that the subsequent S_FMT delivers the</span>
<span class="cm">	 * final encoder configuration.</span>
<span class="cm">	 */</span>
	<span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span>
				   <span class="n">s_crop</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sd_crop</span><span class="p">);</span>
	<span class="n">mbfmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mbfmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span>
					 <span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbfmt</span><span class="p">);</span>
	<span class="cm">/* Must be implemented, so, don&#39;t check for -ENOIOCTLCMD */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Sanity checks */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">mbfmt</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span> <span class="o">||</span>
	    <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span><span class="n">mbfmt</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">img_height_max</span> <span class="o">||</span>
	    <span class="n">mbfmt</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">mbfmt</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">mbfmt</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * No down-scaling. According to the API, current call has precedence:</span>
<span class="cm">	 * http://v4l2spec.bytesex.org/spec/x1904.htm#AEN1954 paragraph two.</span>
<span class="cm">	 */</span>
	<span class="n">vou_adjust_input</span><span class="p">(</span><span class="o">&amp;</span><span class="n">geo</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>

	<span class="cm">/* We tried to preserve output rectangle, but it could have changed */</span>
	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">rect</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">output</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">in_width</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">geo</span><span class="p">.</span><span class="n">in_height</span><span class="p">;</span>

	<span class="n">sh_vou_configure_geometry</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix_idx</span><span class="p">,</span>
				  <span class="n">geo</span><span class="p">.</span><span class="n">scale_idx_h</span><span class="p">,</span> <span class="n">geo</span><span class="p">.</span><span class="n">scale_idx_v</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Total field: NTSC 858 x 2 * 262/263, PAL 864 x 2 * 312/313, default rectangle</span>
<span class="cm"> * is the initial register values, height takes the interlaced format into</span>
<span class="cm"> * account. The actual image can only go up to 720 x 2 * 240, So, VOUVPR can</span>
<span class="cm"> * actually only meaningfully contain values &lt;= 720 and &lt;= 240 respectively, and</span>
<span class="cm"> * not &lt;= 864 and &lt;= 312.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>				<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span>			<span class="o">=</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">VOU_MAX_IMAGE_HEIGHT</span><span class="p">;</span>
	<span class="cm">/* Default = max, set VOUDPR = 0, which is not hardware default */</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">left</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">top</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">width</span>		<span class="o">=</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span><span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">VOU_MAX_IMAGE_HEIGHT</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sh_vou_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">side</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irq_status</span> <span class="o">=</span> <span class="n">sh_vou_reg_a_read</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUIR</span><span class="p">),</span> <span class="n">masked</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">vou_status</span> <span class="o">=</span> <span class="n">sh_vou_reg_a_read</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUSTR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">irq_status</span> <span class="o">&amp;</span> <span class="mh">0x300</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_timed_ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">j</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ status 0x%x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">irq_status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">||</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">printk_timed_ratelimit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">j</span><span class="p">,</span> <span class="mi">500</span><span class="p">))</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
				 <span class="s">&quot;IRQ without active buffer: %x!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_status</span><span class="p">);</span>
		<span class="cm">/* Just ack: buf_release will disable further interrupts */</span>
		<span class="n">sh_vou_reg_a_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">masked</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x300</span> <span class="o">&amp;</span> <span class="n">irq_status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">irq_status</span> <span class="o">&amp;</span> <span class="mh">0x30304</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;IRQ status 0x%x -&gt; 0x%x, VOU status 0x%x, cnt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">irq_status</span><span class="p">,</span> <span class="n">masked</span><span class="p">,</span> <span class="n">vou_status</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>

	<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">side</span> <span class="o">=</span> <span class="n">vou_status</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">;</span>

	<span class="cm">/* Clear only set interrupts */</span>
	<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUIR</span><span class="p">,</span> <span class="n">masked</span><span class="p">);</span>

	<span class="n">vb</span> <span class="o">=</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Stop VOU */</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: queue empty after %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
		<span class="n">sh_vou_reg_a_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SH_VOU_INITIALISING</span><span class="p">;</span>
		<span class="cm">/* Disable End-of-Frame (VSYNC) interrupts */</span>
		<span class="n">sh_vou_reg_a_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x30000</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">new</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">,</span> <span class="n">queue</span><span class="p">);</span>
		<span class="n">sh_vou_schedule_next</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_pdata</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">voucr</span> <span class="o">=</span> <span class="n">sh_vou_ntsc_mode</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus_fmt</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* Disable all IRQs */</span>
	<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUIR</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Reset VOU interfaces - registers unaffected */</span>
	<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUSRR</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sh_vou_reg_a_read</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUSRR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x101</span><span class="p">))</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reset took %dus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_VOU_PCLK_FALLING</span><span class="p">)</span>
		<span class="n">voucr</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_VOU_HSYNC_LOW</span><span class="p">)</span>
		<span class="n">voucr</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">27</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SH_VOU_VSYNC_LOW</span><span class="p">)</span>
		<span class="n">voucr</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">26</span><span class="p">;</span>
	<span class="n">sh_vou_reg_ab_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUCR</span><span class="p">,</span> <span class="n">voucr</span><span class="p">,</span> <span class="mh">0xfc000000</span><span class="p">);</span>

	<span class="cm">/* Manual register side switching at first */</span>
	<span class="n">sh_vou_reg_a_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOURCR</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* Default - fixed HSYNC length, can be made configurable is required */</span>
	<span class="n">sh_vou_reg_ab_write</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUMSR</span><span class="p">,</span> <span class="mh">0x800000</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* File operations */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sh_vou_file</span><span class="p">),</span>
					       <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vou_file</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">vou_file</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
		<span class="cm">/* First open */</span>
		<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SH_VOU_INITIALISING</span><span class="p">;</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_vou_hw_init</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">);</span>
			<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SH_VOU_IDLE</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">videobuf_queue_dma_contig_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sh_vou_video_qops</span><span class="p">,</span>
				       <span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span>
				       <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">,</span>
				       <span class="n">V4L2_FIELD_NONE</span><span class="p">,</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">),</span> <span class="n">vdev</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">fop_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Last close */</span>
		<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SH_VOU_IDLE</span><span class="p">;</span>
		<span class="n">sh_vou_reg_a_set</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">,</span> <span class="n">VOUER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x101</span><span class="p">);</span>
		<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vou_file</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_mmap_mapper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">sh_vou_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_file</span> <span class="o">*</span><span class="n">vou_file</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_poll_stream</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vou_file</span><span class="o">-&gt;</span><span class="n">vbq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_chip_ident</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_register</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sh_vou_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_device_call_until_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_register</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* sh_vou display ioctl operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">sh_vou_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>        	<span class="o">=</span> <span class="n">sh_vou_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_out</span>	<span class="o">=</span> <span class="n">sh_vou_enum_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_out</span>		<span class="o">=</span> <span class="n">sh_vou_g_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_out</span>		<span class="o">=</span> <span class="n">sh_vou_s_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_out</span>		<span class="o">=</span> <span class="n">sh_vou_try_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>			<span class="o">=</span> <span class="n">sh_vou_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>		<span class="o">=</span> <span class="n">sh_vou_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>			<span class="o">=</span> <span class="n">sh_vou_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>			<span class="o">=</span> <span class="n">sh_vou_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>		<span class="o">=</span> <span class="n">sh_vou_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>		<span class="o">=</span> <span class="n">sh_vou_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span>			<span class="o">=</span> <span class="n">sh_vou_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_std</span>			<span class="o">=</span> <span class="n">sh_vou_g_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>			<span class="o">=</span> <span class="n">sh_vou_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_crop</span>			<span class="o">=</span> <span class="n">sh_vou_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_crop</span>			<span class="o">=</span> <span class="n">sh_vou_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_chip_ident</span>		<span class="o">=</span> <span class="n">sh_vou_g_chip_ident</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">vidioc_g_register</span>		<span class="o">=</span> <span class="n">sh_vou_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_register</span>		<span class="o">=</span> <span class="n">sh_vou_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">sh_vou_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">sh_vou_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">sh_vou_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">sh_vou_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">sh_vou_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">sh_vou_video_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sh_vou&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_vou_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sh_vou_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span>	<span class="o">=</span> <span class="n">V4L2_STD_525_60</span><span class="p">,</span> <span class="cm">/* PAL only supported in 8-bit non-bt656 mode */</span>
	<span class="p">.</span><span class="n">current_norm</span>	<span class="o">=</span> <span class="n">V4L2_STD_NTSC_M</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sh_vou_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sh_vou_pdata</span> <span class="o">*</span><span class="n">vou_pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pix</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">i2c_adap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">reg_res</span><span class="p">,</span> <span class="o">*</span><span class="n">region</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vou_pdata</span> <span class="o">||</span> <span class="o">!</span><span class="n">reg_res</span> <span class="o">||</span> <span class="n">irq</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Insufficient VOU platform information.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vou_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vou_dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vou_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">fop_lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">vou_pdata</span><span class="p">;</span>
	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">SH_VOU_IDLE</span><span class="p">;</span>

	<span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">;</span>
	<span class="n">pix</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">pix</span><span class="p">;</span>

	<span class="cm">/* Fill in defaults */</span>
	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">std</span>		<span class="o">=</span> <span class="n">sh_vou_video_template</span><span class="p">.</span><span class="n">current_norm</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span>		<span class="o">=</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">width</span>		<span class="o">=</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">height</span>		<span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">pixelformat</span>	<span class="o">=</span> <span class="n">V4L2_PIX_FMT_YVYU</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">field</span>		<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">bytesperline</span>	<span class="o">=</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">sizeimage</span>		<span class="o">=</span> <span class="n">VOU_MAX_IMAGE_WIDTH</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">480</span><span class="p">;</span>
	<span class="n">pix</span><span class="o">-&gt;</span><span class="n">colorspace</span>		<span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>

	<span class="n">region</span> <span class="o">=</span> <span class="n">request_mem_region</span><span class="p">(</span><span class="n">reg_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">reg_res</span><span class="p">),</span>
				    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">region</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VOU region already claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ereqmemreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">reg_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">reg_res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">emap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">sh_vou_isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;vou&quot;</span><span class="p">,</span> <span class="n">vou_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ereqirq</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Error registering v4l2 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">ev4l2devreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate memory for video device */</span>
	<span class="n">vdev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">evdevalloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">sh_vou_video_template</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vou_pdata</span><span class="o">-&gt;</span><span class="n">bus_fmt</span> <span class="o">==</span> <span class="n">SH_VOU_BUS_8BIT</span><span class="p">)</span>
		<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">tvnorms</span> <span class="o">|=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">fop_lock</span><span class="p">;</span>
	<span class="cm">/* Locking in file operations other than ioctl should be done</span>
<span class="cm">	   by the driver, not the V4L2 core.</span>
<span class="cm">	   This driver needs auditing so that this flag can be removed. */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_LOCK_ALL_FOPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="p">;</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">vou_dev</span><span class="p">);</span>

	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">i2c_adap</span> <span class="o">=</span> <span class="n">i2c_get_adapter</span><span class="p">(</span><span class="n">vou_pdata</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_adap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ei2cgadap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sh_vou_hw_init</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ereset</span><span class="p">;</span>

	<span class="n">subdev</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev_board</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">i2c_adap</span><span class="p">,</span>
			<span class="n">vou_pdata</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">subdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">ei2cnd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">evregdev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">evregdev:</span>
<span class="nl">ei2cnd:</span>
<span class="nl">ereset:</span>
	<span class="n">i2c_put_adapter</span><span class="p">(</span><span class="n">i2c_adap</span><span class="p">);</span>
<span class="nl">ei2cgadap:</span>
	<span class="n">video_device_release</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">evdevalloc:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="nl">ev4l2devreg:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">vou_dev</span><span class="p">);</span>
<span class="nl">ereqirq:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
<span class="nl">emap:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">reg_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">reg_res</span><span class="p">));</span>
<span class="nl">ereqmemreg:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">sh_vou_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sh_vou_device</span> <span class="o">*</span><span class="n">vou_dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">sh_vou_device</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">v4l2_subdev</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">reg_res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">vou_dev</span><span class="p">);</span>
	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">i2c_put_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">vou_dev</span><span class="o">-&gt;</span><span class="n">base</span><span class="p">);</span>
	<span class="n">reg_res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg_res</span><span class="p">)</span>
		<span class="n">release_mem_region</span><span class="p">(</span><span class="n">reg_res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">reg_res</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vou_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">__refdata</span> <span class="n">sh_vou</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">remove</span>  <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sh_vou_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span>  <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;sh-vou&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sh_vou_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh_vou</span><span class="p">,</span> <span class="n">sh_vou_probe</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sh_vou_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sh_vou</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sh_vou_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sh_vou_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SuperH VOU driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;0.1.0&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:sh-vou&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
