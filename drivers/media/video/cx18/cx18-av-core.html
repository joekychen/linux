<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cx18 › cx18-av-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cx18-av-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  cx18 ADEC audio functions</span>
<span class="cm"> *</span>
<span class="cm"> *  Derived from cx25840-core.c</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007  Hans Verkuil &lt;hverkuil@xs4all.nl&gt;</span>
<span class="cm"> *  Copyright (C) 2008  Andy Walls &lt;awalls@md.metrocast.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or</span>
<span class="cm"> *  modify it under the terms of the GNU General Public License</span>
<span class="cm"> *  as published by the Free Software Foundation; either version 2</span>
<span class="cm"> *  of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> *  02110-1301, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &quot;cx18-driver.h&quot;</span>
<span class="cp">#include &quot;cx18-io.h&quot;</span>
<span class="cp">#include &quot;cx18-cards.h&quot;</span>

<span class="kt">int</span> <span class="nf">cx18_av_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mh">0xc40000</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">x</span> <span class="o">=</span> <span class="n">cx18_read_reg</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">cx18_write_reg</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx18_av_write_expect</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">,</span> <span class="n">u8</span> <span class="n">eval</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mh">0xc40000</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">x</span> <span class="o">=</span> <span class="n">cx18_read_reg</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="mh">0xff</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">))</span> <span class="o">|</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">);</span>
	<span class="n">cx18_write_reg_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span>
				<span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">eval</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">),</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">mask</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx18_av_write4</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cx18_write_reg</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mh">0xc40000</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">cx18_av_write4_expect</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">eval</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cx18_write_reg_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mh">0xc40000</span> <span class="o">+</span> <span class="n">addr</span><span class="p">,</span> <span class="n">eval</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx18_av_write4_noretry</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cx18_write_reg_noretry</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mh">0xc40000</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">cx18_av_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">x</span> <span class="o">=</span> <span class="n">cx18_read_reg</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0xc40000</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">cx18_av_read4</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx18_read_reg</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0xc40000</span> <span class="o">+</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx18_av_and_or</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">and_mask</span><span class="p">,</span>
		   <span class="n">u8</span> <span class="n">or_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">and_mask</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">or_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx18_av_and_or4</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">and_mask</span><span class="p">,</span>
		   <span class="n">u32</span> <span class="n">or_value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">cx18_av_read4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">and_mask</span><span class="p">)</span> <span class="o">|</span>
			     <span class="n">or_value</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx18_av_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * The crystal freq used in calculations in this driver will be</span>
<span class="cm">	 * 28.636360 MHz.</span>
<span class="cm">	 * Aim to run the PLLs&#39; VCOs near 400 MHz to minimze errors.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * VDCLK  Integer = 0x0f, Post Divider = 0x04</span>
<span class="cm">	 * AIMCLK Integer = 0x0e, Post Divider = 0x16</span>
<span class="cm">	 */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_PLL_CTRL1</span><span class="p">,</span> <span class="mh">0x160e040f</span><span class="p">);</span>

	<span class="cm">/* VDCLK Fraction = 0x2be2fe */</span>
	<span class="cm">/* xtal * 0xf.15f17f0/4 = 108 MHz: 432 MHz before post divide */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_VID_PLL_FRAC</span><span class="p">,</span> <span class="mh">0x002be2fe</span><span class="p">);</span>

	<span class="cm">/* AIMCLK Fraction = 0x05227ad */</span>
	<span class="cm">/* xtal * 0xe.2913d68/0x16 = 48000 * 384: 406 MHz pre post-div*/</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_AUX_PLL_FRAC</span><span class="p">,</span> <span class="mh">0x005227ad</span><span class="p">);</span>

	<span class="cm">/* SA_MCLK_SEL=1, SA_MCLK_DIV=0x16 */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_I2S_MCLK</span><span class="p">,</span> <span class="mh">0x56</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx18_av_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">default_volume</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v</span><span class="p">;</span>

	<span class="n">cx18_av_loadfw</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="cm">/* Stop 8051 code execution */</span>
	<span class="n">cx18_av_write4_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_DL_CTL</span><span class="p">,</span> <span class="mh">0x03000000</span><span class="p">,</span>
						 <span class="mh">0x03000000</span><span class="p">,</span> <span class="mh">0x13000000</span><span class="p">);</span>

	<span class="cm">/* initallize the PLL by toggling sleep bit */</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">cx18_av_read4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_HOST_REG1</span><span class="p">);</span>
	<span class="cm">/* enable sleep mode - register appears to be read only... */</span>
	<span class="n">cx18_av_write4_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_HOST_REG1</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span> <span class="mi">1</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mh">0xfffe</span><span class="p">);</span>
	<span class="cm">/* disable sleep mode */</span>
	<span class="n">cx18_av_write4_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_HOST_REG1</span><span class="p">,</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">,</span>
						    <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xfffe</span><span class="p">,</span> <span class="mh">0xffff</span><span class="p">);</span>

	<span class="cm">/* initialize DLLs */</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">cx18_av_read4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_DLL1_DIAG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE1FFFEFF</span><span class="p">;</span>
	<span class="cm">/* disable FLD */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_DLL1_DIAG_CTRL</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="cm">/* enable FLD */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_DLL1_DIAG_CTRL</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span> <span class="mh">0x10000100</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">cx18_av_read4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_DLL2_DIAG_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xE1FFFEFF</span><span class="p">;</span>
	<span class="cm">/* disable FLD */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_DLL2_DIAG_CTRL</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>
	<span class="cm">/* enable FLD */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_DLL2_DIAG_CTRL</span><span class="p">,</span> <span class="n">v</span> <span class="o">|</span> <span class="mh">0x06000100</span><span class="p">);</span>

	<span class="cm">/* set analog bias currents. Set Vreg to 1.20V. */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_AFE_DIAG_CTRL1</span><span class="p">,</span> <span class="mh">0x000A1802</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">cx18_av_read4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_AFE_DIAG_CTRL3</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* enable TUNE_FIL_RST */</span>
	<span class="n">cx18_av_write4_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_AFE_DIAG_CTRL3</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mh">0x03009F0F</span><span class="p">);</span>
	<span class="cm">/* disable TUNE_FIL_RST */</span>
	<span class="n">cx18_av_write4_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_AFE_DIAG_CTRL3</span><span class="p">,</span>
			      <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">,</span> <span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFE</span><span class="p">,</span> <span class="mh">0x03009F0F</span><span class="p">);</span>

	<span class="cm">/* enable 656 output */</span>
	<span class="n">cx18_av_and_or4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_PIN_CTRL1</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x040C00</span><span class="p">);</span>

	<span class="cm">/* video output drive strength */</span>
	<span class="n">cx18_av_and_or4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_PIN_CTRL2</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">);</span>

	<span class="cm">/* reset video */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_SOFT_RST_CTRL</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_SOFT_RST_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable Video Auto-config of the Analog Front End and Video PLL.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Since we only use BT.656 pixel mode, which works for both 525 and 625</span>
<span class="cm">	 * line systems, it&#39;s just easier for us to set registers</span>
<span class="cm">	 * 0x102 (CXADEC_CHIP_CTRL), 0x104-0x106 (CXADEC_AFE_CTRL),</span>
<span class="cm">	 * 0x108-0x109 (CXADEC_PLL_CTRL1), and 0x10c-0x10f (CXADEC_VID_PLL_FRAC)</span>
<span class="cm">	 * ourselves, than to run around cleaning up after the auto-config.</span>
<span class="cm">	 *</span>
<span class="cm">	 * (Note: my CX23418 chip doesn&#39;t seem to let the ACFG_DIS bit</span>
<span class="cm">	 * get set to 1, but OTOH, it doesn&#39;t seem to do AFE and VID PLL</span>
<span class="cm">	 * autoconfig either.)</span>
<span class="cm">	 *</span>
<span class="cm">	 * As a default, also turn off Dual mode for ADC2 and set ADC2 to CH3.</span>
<span class="cm">	 */</span>
	<span class="n">cx18_av_and_or4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_CHIP_CTRL</span><span class="p">,</span> <span class="mh">0xFFFBFFFF</span><span class="p">,</span> <span class="mh">0x00120000</span><span class="p">);</span>

	<span class="cm">/* Setup the Video and and Aux/Audio PLLs */</span>
	<span class="n">cx18_av_init</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>

	<span class="cm">/* set video to auto-detect */</span>
	<span class="cm">/* Clear bits 11-12 to enable slow locking mode.  Set autodetect mode */</span>
	<span class="cm">/* set the comb notch = 1 */</span>
	<span class="n">cx18_av_and_or4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_MODE_CTRL</span><span class="p">,</span> <span class="mh">0xFFF7E7F0</span><span class="p">,</span> <span class="mh">0x02040800</span><span class="p">);</span>

	<span class="cm">/* Enable wtw_en in CRUSH_CTRL (Set bit 22) */</span>
	<span class="cm">/* Enable maj_sel in CRUSH_CTRL (Set bit 20) */</span>
	<span class="n">cx18_av_and_or4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_CRUSH_CTRL</span><span class="p">,</span> <span class="o">~</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x00500000</span><span class="p">);</span>

	<span class="cm">/* Set VGA_TRACK_RANGE to 0x20 */</span>
	<span class="n">cx18_av_and_or4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_DFE_CTRL2</span><span class="p">,</span> <span class="mh">0xFFFF00FF</span><span class="p">,</span> <span class="mh">0x00002000</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initial VBI setup</span>
<span class="cm">	 * VIP-1.1, 10 bit mode, enable Raw, disable sliced,</span>
<span class="cm">	 * don&#39;t clamp raw samples when codes are in use, 1 byte user D-words,</span>
<span class="cm">	 * IDID0 has line #, RP code V bit transition on VBLANK, data during</span>
<span class="cm">	 * blanking intervals</span>
<span class="cm">	 */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_OUT_CTRL1</span><span class="p">,</span> <span class="mh">0x4013252e</span><span class="p">);</span>

	<span class="cm">/* Set the video input.</span>
<span class="cm">	   The setting in MODE_CTRL gets lost when we do the above setup */</span>
	<span class="cm">/* EncSetSignalStd(dwDevNum, pEnc-&gt;dwSigStd); */</span>
	<span class="cm">/* EncSetVideoInput(dwDevNum, pEnc-&gt;VidIndSelection); */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Analog Front End (AFE)</span>
<span class="cm">	 * Default to luma on ch1/ADC1, chroma on ch2/ADC2, SIF on ch3/ADC2</span>
<span class="cm">	 *  bypass_ch[1-3]     use filter</span>
<span class="cm">	 *  droop_comp_ch[1-3] disable</span>
<span class="cm">	 *  clamp_en_ch[1-3]   disable</span>
<span class="cm">	 *  aud_in_sel         ADC2</span>
<span class="cm">	 *  luma_in_sel        ADC1</span>
<span class="cm">	 *  chroma_in_sel      ADC2</span>
<span class="cm">	 *  clamp_sel_ch[2-3]  midcode</span>
<span class="cm">	 *  clamp_sel_ch1      video decoder</span>
<span class="cm">	 *  vga_sel_ch3        audio decoder</span>
<span class="cm">	 *  vga_sel_ch[1-2]    video decoder</span>
<span class="cm">	 *  half_bw_ch[1-3]    disable</span>
<span class="cm">	 *  +12db_ch[1-3]      disable</span>
<span class="cm">	 */</span>
	<span class="n">cx18_av_and_or4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_AFE_CTRL</span><span class="p">,</span> <span class="mh">0xFF000000</span><span class="p">,</span> <span class="mh">0x00005D00</span><span class="p">);</span>

<span class="cm">/* 	if(dwEnable &amp;&amp; dw3DCombAvailable) { */</span>
<span class="cm">/*      	CxDevWrReg(CXADEC_SRC_COMB_CFG, 0x7728021F); */</span>
<span class="cm">/*    } else { */</span>
<span class="cm">/*      	CxDevWrReg(CXADEC_SRC_COMB_CFG, 0x6628021F); */</span>
<span class="cm">/*    } */</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_SRC_COMB_CFG</span><span class="p">,</span> <span class="mh">0x6628021F</span><span class="p">);</span>
	<span class="n">default_volume</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x8d4</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Enforce the legacy volume scale mapping limits to avoid</span>
<span class="cm">	 * -ERANGE errors when initializing the volume control</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">default_volume</span> <span class="o">&gt;</span> <span class="mi">228</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Bottom out at -96 dB, v4l2 vol range 0x2e00-0x2fff */</span>
		<span class="n">default_volume</span> <span class="o">=</span> <span class="mi">228</span><span class="p">;</span>
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x8d4</span><span class="p">,</span> <span class="mi">228</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">default_volume</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Top out at + 8 dB, v4l2 vol range 0xfe00-0xffff */</span>
		<span class="n">default_volume</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x8d4</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">default_volume</span> <span class="o">=</span> <span class="p">(((</span><span class="mi">228</span> <span class="o">-</span> <span class="n">default_volume</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">23</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">volume</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">default_volume</span><span class="p">;</span>
	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cx18_av_initialize</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_load_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">is_initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* initialize on first use */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">is_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">cx18_av_initialize</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx18_av_std_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">av_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Video ADC crystal clock to pixel clock SRC decimation ratio</span>
<span class="cm">	 * 28.636360 MHz/13.5 Mpps * 256 = 0x21f.07b</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">src_decimation</span> <span class="o">=</span> <span class="mh">0x21f</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">hblank</span><span class="p">,</span> <span class="n">hactive</span><span class="p">,</span> <span class="n">burst</span><span class="p">,</span> <span class="n">vblank</span><span class="p">,</span> <span class="n">vactive</span><span class="p">,</span> <span class="n">sc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vblank656</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">luma_lpf</span><span class="p">,</span> <span class="n">uv_lpf</span><span class="p">,</span> <span class="n">comb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pll_int</span><span class="p">,</span> <span class="n">pll_frac</span><span class="p">,</span> <span class="n">pll_post</span><span class="p">;</span>

	<span class="cm">/* datasheet startup, step 8d */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">V4L2_STD_NTSC</span><span class="p">)</span>
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x49f</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x49f</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note: At the end of a field, there are 3 sets of half line duration</span>
<span class="cm">	 * (double horizontal rate) pulses:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 5 (625) or 6 (525) half-lines to blank for the vertical retrace</span>
<span class="cm">	 * 5 (625) or 6 (525) vertical sync pulses of half line duration</span>
<span class="cm">	 * 5 (625) or 6 (525) half-lines of equalization pulses</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The following relationships of half line counts should hold:</span>
<span class="cm">		 * 625 = vblank656 + vactive</span>
<span class="cm">		 * 10 = vblank656 - vblank = vsync pulses + equalization pulses</span>
<span class="cm">		 *</span>
<span class="cm">		 * vblank656: half lines after line 625/mid-313 of blanked video</span>
<span class="cm">		 * vblank:    half lines, after line 5/317, of blanked video</span>
<span class="cm">		 * vactive:   half lines of active video +</span>
<span class="cm">		 * 		5 half lines after the end of active video</span>
<span class="cm">		 *</span>
<span class="cm">		 * As far as I can tell:</span>
<span class="cm">		 * vblank656 starts counting from the falling edge of the first</span>
<span class="cm">		 * 	vsync pulse (start of line 1 or mid-313)</span>
<span class="cm">		 * vblank starts counting from the after the 5 vsync pulses and</span>
<span class="cm">		 * 	5 or 4 equalization pulses (start of line 6 or 318)</span>
<span class="cm">		 *</span>
<span class="cm">		 * For 625 line systems the driver will extract VBI information</span>
<span class="cm">		 * from lines 6-23 and lines 318-335 (but the slicer can only</span>
<span class="cm">		 * handle 17 lines, not the 18 in the vblank region).</span>
<span class="cm">		 * In addition, we need vblank656 and vblank to be one whole</span>
<span class="cm">		 * line longer, to cover line 24 and 336, so the SAV/EAV RP</span>
<span class="cm">		 * codes get generated such that the encoder can actually</span>
<span class="cm">		 * extract line 23 &amp; 335 (WSS).  We&#39;ll lose 1 line in each field</span>
<span class="cm">		 * at the top of the screen.</span>
<span class="cm">		 *</span>
<span class="cm">		 * It appears the 5 half lines that happen after active</span>
<span class="cm">		 * video must be included in vactive (579 instead of 574),</span>
<span class="cm">		 * otherwise the colors get badly displayed in various regions</span>
<span class="cm">		 * of the screen.  I guess the chroma comb filter gets confused</span>
<span class="cm">		 * without them (at least when a PVR-350 is the PAL source).</span>
<span class="cm">		 */</span>
		<span class="n">vblank656</span> <span class="o">=</span> <span class="mi">48</span><span class="p">;</span> <span class="cm">/* lines  1 -  24  &amp;  313 - 336 */</span>
		<span class="n">vblank</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span>    <span class="cm">/* lines  6 -  24  &amp;  318 - 336 */</span>
		<span class="n">vactive</span> <span class="o">=</span> <span class="mi">579</span><span class="p">;</span>  <span class="cm">/* lines 24 - 313  &amp;  337 - 626 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * For a 13.5 Mpps clock and 15,625 Hz line rate, a line is</span>
<span class="cm">		 * is 864 pixels = 720 active + 144 blanking.  ITU-R BT.601</span>
<span class="cm">		 * specifies 12 luma clock periods or ~ 0.9 * 13.5 Mpps after</span>
<span class="cm">		 * the end of active video to start a horizontal line, so that</span>
<span class="cm">		 * leaves 132 pixels of hblank to ignore.</span>
<span class="cm">		 */</span>
		<span class="n">hblank</span> <span class="o">=</span> <span class="mi">132</span><span class="p">;</span>
		<span class="n">hactive</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Burst gate delay (for 625 line systems)</span>
<span class="cm">		 * Hsync leading edge to color burst rise = 5.6 us</span>
<span class="cm">		 * Color burst width = 2.25 us</span>
<span class="cm">		 * Gate width = 4 pixel clocks</span>
<span class="cm">		 * (5.6 us + 2.25/2 us) * 13.5 Mpps + 4/2 clocks = 92.79 clocks</span>
<span class="cm">		 */</span>
		<span class="n">burst</span> <span class="o">=</span> <span class="mi">93</span><span class="p">;</span>
		<span class="n">luma_lpf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uv_lpf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">comb</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="cm">/* sc = 4433618.75 * src_decimation/28636360 * 2^13 */</span>
			<span class="n">sc</span> <span class="o">=</span> <span class="mi">688700</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uv_lpf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">comb</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="cm">/* sc = 3582056.25 * src_decimation/28636360 * 2^13 */</span>
			<span class="n">sc</span> <span class="o">=</span> <span class="mi">556422</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* SECAM */</span>
			<span class="n">uv_lpf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">comb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* (fr + fb)/2 = (4406260 + 4250000)/2 = 4328130 */</span>
			<span class="cm">/* sc = 4328130 * src_decimation/28636360 * 2^13 */</span>
			<span class="n">sc</span> <span class="o">=</span> <span class="mi">672314</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * The following relationships of half line counts should hold:</span>
<span class="cm">		 * 525 = prevsync + vblank656 + vactive</span>
<span class="cm">		 * 12 = vblank656 - vblank = vsync pulses + equalization pulses</span>
<span class="cm">		 *</span>
<span class="cm">		 * prevsync:  6 half-lines before the vsync pulses</span>
<span class="cm">		 * vblank656: half lines, after line 3/mid-266, of blanked video</span>
<span class="cm">		 * vblank:    half lines, after line 9/272, of blanked video</span>
<span class="cm">		 * vactive:   half lines of active video</span>
<span class="cm">		 *</span>
<span class="cm">		 * As far as I can tell:</span>
<span class="cm">		 * vblank656 starts counting from the falling edge of the first</span>
<span class="cm">		 * 	vsync pulse (start of line 4 or mid-266)</span>
<span class="cm">		 * vblank starts counting from the after the 6 vsync pulses and</span>
<span class="cm">		 * 	6 or 5 equalization pulses (start of line 10 or 272)</span>
<span class="cm">		 *</span>
<span class="cm">		 * For 525 line systems the driver will extract VBI information</span>
<span class="cm">		 * from lines 10-21 and lines 273-284.</span>
<span class="cm">		 */</span>
		<span class="n">vblank656</span> <span class="o">=</span> <span class="mi">38</span><span class="p">;</span> <span class="cm">/* lines  4 -  22  &amp;  266 - 284 */</span>
		<span class="n">vblank</span> <span class="o">=</span> <span class="mi">26</span><span class="p">;</span>	<span class="cm">/* lines 10 -  22  &amp;  272 - 284 */</span>
		<span class="n">vactive</span> <span class="o">=</span> <span class="mi">481</span><span class="p">;</span>  <span class="cm">/* lines 23 - 263  &amp;  285 - 525 */</span>

		<span class="cm">/*</span>
<span class="cm">		 * For a 13.5 Mpps clock and 15,734.26 Hz line rate, a line is</span>
<span class="cm">		 * is 858 pixels = 720 active + 138 blanking.  The Hsync leading</span>
<span class="cm">		 * edge should happen 1.2 us * 13.5 Mpps ~= 16 pixels after the</span>
<span class="cm">		 * end of active video, leaving 122 pixels of hblank to ignore</span>
<span class="cm">		 * before active video starts.</span>
<span class="cm">		 */</span>
		<span class="n">hactive</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">hblank</span> <span class="o">=</span> <span class="mi">122</span><span class="p">;</span>
		<span class="n">luma_lpf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">uv_lpf</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Burst gate delay (for 525 line systems)</span>
<span class="cm">		 * Hsync leading edge to color burst rise = 5.3 us</span>
<span class="cm">		 * Color burst width = 2.5 us</span>
<span class="cm">		 * Gate width = 4 pixel clocks</span>
<span class="cm">		 * (5.3 us + 2.5/2 us) * 13.5 Mpps + 4/2 clocks = 90.425 clocks</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_60</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
			<span class="n">luma_lpf</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">comb</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="cm">/* sc = 4433618.75 * src_decimation/28636360 * 2^13 */</span>
			<span class="n">sc</span> <span class="o">=</span> <span class="mi">688700</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* The 97 needs to be verified against PAL-M timings */</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mi">97</span><span class="p">;</span>
			<span class="n">comb</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="cm">/* sc = 3575611.49 * src_decimation/28636360 * 2^13 */</span>
			<span class="n">sc</span> <span class="o">=</span> <span class="mi">555421</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">burst</span> <span class="o">=</span> <span class="mi">90</span><span class="p">;</span>
			<span class="n">comb</span> <span class="o">=</span> <span class="mh">0x66</span><span class="p">;</span>
			<span class="cm">/* sc = 3579545.45.. * src_decimation/28636360 * 2^13 */</span>
			<span class="n">sc</span> <span class="o">=</span> <span class="mi">556032</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* DEBUG: Displays configured PLL frequency */</span>
	<span class="n">pll_int</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x108</span><span class="p">);</span>
	<span class="n">pll_frac</span> <span class="o">=</span> <span class="n">cx18_av_read4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x10c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1ffffff</span><span class="p">;</span>
	<span class="n">pll_post</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x109</span><span class="p">);</span>
	<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;PLL regs = int: %u, frac: %u, post: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">pll_int</span><span class="p">,</span> <span class="n">pll_frac</span><span class="p">,</span> <span class="n">pll_post</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pll_post</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">fsc</span><span class="p">,</span> <span class="n">pll</span><span class="p">;</span>
		<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>

		<span class="n">pll</span> <span class="o">=</span> <span class="p">(</span><span class="mi">28636360L</span> <span class="o">*</span> <span class="p">((((</span><span class="n">u64</span><span class="p">)</span><span class="n">pll_int</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">25</span><span class="p">)</span> <span class="o">+</span> <span class="n">pll_frac</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">25</span><span class="p">;</span>
		<span class="n">pll</span> <span class="o">/=</span> <span class="n">pll_post</span><span class="p">;</span>
		<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Video PLL = %d.%06d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pll</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span> <span class="n">pll</span> <span class="o">%</span> <span class="mi">1000000</span><span class="p">);</span>
		<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Pixel rate = %d.%06d Mpixel/sec</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">pll</span> <span class="o">/</span> <span class="mi">8000000</span><span class="p">,</span> <span class="p">(</span><span class="n">pll</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000000</span><span class="p">);</span>

		<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;ADC XTAL/pixel clock decimation ratio &quot;</span>
				    <span class="s">&quot;= %d.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">src_decimation</span> <span class="o">/</span> <span class="mi">256</span><span class="p">,</span>
				    <span class="p">((</span><span class="n">src_decimation</span> <span class="o">%</span> <span class="mi">256</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="mi">256</span><span class="p">);</span>

		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">28636360</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span> <span class="n">sc</span><span class="p">;</span>
		<span class="n">do_div</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">src_decimation</span><span class="p">);</span>
		<span class="n">fsc</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">;</span>
		<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
				    <span class="s">&quot;Chroma sub-carrier initial freq = %d.%06d &quot;</span>
				    <span class="s">&quot;MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fsc</span> <span class="o">/</span> <span class="mi">1000000</span><span class="p">,</span> <span class="n">fsc</span> <span class="o">%</span> <span class="mi">1000000</span><span class="p">);</span>

		<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;hblank %i, hactive %i, vblank %i, &quot;</span>
				    <span class="s">&quot;vactive %i, vblank656 %i, src_dec %i, &quot;</span>
				    <span class="s">&quot;burst 0x%02x, luma_lpf %i, uv_lpf %i, &quot;</span>
				    <span class="s">&quot;comb 0x%02x, sc 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">hblank</span><span class="p">,</span> <span class="n">hactive</span><span class="p">,</span> <span class="n">vblank</span><span class="p">,</span> <span class="n">vactive</span><span class="p">,</span> <span class="n">vblank656</span><span class="p">,</span>
				    <span class="n">src_decimation</span><span class="p">,</span> <span class="n">burst</span><span class="p">,</span> <span class="n">luma_lpf</span><span class="p">,</span> <span class="n">uv_lpf</span><span class="p">,</span>
				    <span class="n">comb</span><span class="p">,</span> <span class="n">sc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Sets horizontal blanking delay and active lines */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x470</span><span class="p">,</span> <span class="n">hblank</span><span class="p">);</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x471</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">hblank</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">(</span><span class="n">hactive</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)));</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x472</span><span class="p">,</span> <span class="n">hactive</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Sets burst gate delay */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x473</span><span class="p">,</span> <span class="n">burst</span><span class="p">);</span>

	<span class="cm">/* Sets vertical blanking delay and active duration */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x474</span><span class="p">,</span> <span class="n">vblank</span><span class="p">);</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x475</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">vblank</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">|</span>
						<span class="p">(</span><span class="n">vactive</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)));</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x476</span><span class="p">,</span> <span class="n">vactive</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x477</span><span class="p">,</span> <span class="n">vblank656</span><span class="p">);</span>

	<span class="cm">/* Sets src decimation rate */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x478</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">src_decimation</span><span class="p">);</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x479</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">src_decimation</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* Sets Luma and UV Low pass filters */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x47a</span><span class="p">,</span> <span class="n">luma_lpf</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span> <span class="o">|</span> <span class="p">((</span><span class="n">uv_lpf</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">));</span>

	<span class="cm">/* Enables comb filters */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x47b</span><span class="p">,</span> <span class="n">comb</span><span class="p">);</span>

	<span class="cm">/* Sets SC Step*/</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x47c</span><span class="p">,</span> <span class="n">sc</span><span class="p">);</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x47d</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">sc</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x47e</span><span class="p">,</span> <span class="mh">0xff</span> <span class="o">&amp;</span> <span class="n">sc</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_delay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">6</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_delay</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_delay</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x47f</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">input_change</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">av_state</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>

	<span class="cm">/* Follow step 8c and 8d of section 3.16 in the cx18_av datasheet */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x49f</span><span class="p">,</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x14</span> <span class="o">:</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="n">cx18_av_and_or</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x401</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x60</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cx18_av_and_or</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x401</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x60</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Japan uses EIAJ audio standard */</span>
			<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x808</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x80b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC_M_KR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* South Korea uses A2 audio standard */</span>
			<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x808</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x80b</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Others use the BTSC audio standard */</span>
			<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x808</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xf6</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x80b</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Follow tuner change procedure for PAL */</span>
		<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x808</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x80b</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Select autodetect for SECAM */</span>
		<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x808</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x80b</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x803</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* restart audio decoder microcontroller */</span>
		<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x10</span><span class="p">;</span>
		<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x803</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x803</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">input_change</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">enum</span> <span class="n">cx18_av_video_input</span> <span class="n">vid_input</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">cx18_av_audio_input</span> <span class="n">aud_input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">av_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">analog_signal_type</span> <span class="p">{</span>
		<span class="n">NONE</span><span class="p">,</span> <span class="n">CVBS</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">SIF</span><span class="p">,</span> <span class="n">Pb</span><span class="p">,</span> <span class="n">Pr</span>
	<span class="p">}</span> <span class="n">ch</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">NONE</span><span class="p">,</span> <span class="n">NONE</span><span class="p">,</span> <span class="n">NONE</span><span class="p">};</span>

	<span class="n">u8</span> <span class="n">afe_mux_cfg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">adc2_cfg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">input_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">afe_cfg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;decoder set video input %d, audio input %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">vid_input</span><span class="p">,</span> <span class="n">aud_input</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vid_input</span> <span class="o">&gt;=</span> <span class="n">CX18_AV_COMPOSITE1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vid_input</span> <span class="o">&lt;=</span> <span class="n">CX18_AV_COMPOSITE8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">afe_mux_cfg</span> <span class="o">=</span> <span class="mh">0xf0</span> <span class="o">+</span> <span class="p">(</span><span class="n">vid_input</span> <span class="o">-</span> <span class="n">CX18_AV_COMPOSITE1</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CVBS</span><span class="p">;</span>
		<span class="n">input_mode</span> <span class="o">=</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">vid_input</span> <span class="o">&gt;=</span> <span class="n">CX18_AV_COMPONENT_LUMA1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">luma</span> <span class="o">=</span> <span class="n">vid_input</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">r_chroma</span> <span class="o">=</span> <span class="n">vid_input</span> <span class="o">&amp;</span> <span class="mh">0xf0000</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">b_chroma</span> <span class="o">=</span> <span class="n">vid_input</span> <span class="o">&amp;</span> <span class="mh">0xf00000</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">vid_input</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xfff000</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">luma</span> <span class="o">&lt;</span> <span class="n">CX18_AV_COMPONENT_LUMA1</span> <span class="o">||</span>
		    <span class="n">luma</span> <span class="o">&gt;</span> <span class="n">CX18_AV_COMPONENT_LUMA8</span> <span class="o">||</span>
		    <span class="n">r_chroma</span> <span class="o">&lt;</span> <span class="n">CX18_AV_COMPONENT_R_CHROMA4</span> <span class="o">||</span>
		    <span class="n">r_chroma</span> <span class="o">&gt;</span> <span class="n">CX18_AV_COMPONENT_R_CHROMA6</span> <span class="o">||</span>
		    <span class="n">b_chroma</span> <span class="o">&lt;</span> <span class="n">CX18_AV_COMPONENT_B_CHROMA7</span> <span class="o">||</span>
		    <span class="n">b_chroma</span> <span class="o">&gt;</span> <span class="n">CX18_AV_COMPONENT_B_CHROMA8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CX18_ERR_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;0x%06x is not a valid video input!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">vid_input</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">afe_mux_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">luma</span> <span class="o">-</span> <span class="n">CX18_AV_COMPONENT_LUMA1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="p">;</span>
		<span class="n">afe_mux_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">r_chroma</span> <span class="o">-</span> <span class="n">CX18_AV_COMPONENT_R_CHROMA4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pr</span><span class="p">;</span>
		<span class="n">afe_mux_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">b_chroma</span> <span class="o">-</span> <span class="n">CX18_AV_COMPONENT_B_CHROMA7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">14</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">Pb</span><span class="p">;</span>
		<span class="n">input_mode</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">luma</span> <span class="o">=</span> <span class="n">vid_input</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">chroma</span> <span class="o">=</span> <span class="n">vid_input</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">vid_input</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff0</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">luma</span> <span class="o">&lt;</span> <span class="n">CX18_AV_SVIDEO_LUMA1</span> <span class="o">||</span>
		    <span class="n">luma</span> <span class="o">&gt;</span> <span class="n">CX18_AV_SVIDEO_LUMA8</span> <span class="o">||</span>
		    <span class="n">chroma</span> <span class="o">&lt;</span> <span class="n">CX18_AV_SVIDEO_CHROMA4</span> <span class="o">||</span>
		    <span class="n">chroma</span> <span class="o">&gt;</span> <span class="n">CX18_AV_SVIDEO_CHROMA8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CX18_ERR_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;0x%06x is not a valid video input!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">vid_input</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">afe_mux_cfg</span> <span class="o">=</span> <span class="mh">0xf0</span> <span class="o">+</span> <span class="p">((</span><span class="n">luma</span> <span class="o">-</span> <span class="n">CX18_AV_SVIDEO_LUMA1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">Y</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chroma</span> <span class="o">&gt;=</span> <span class="n">CX18_AV_SVIDEO_CHROMA7</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">afe_mux_cfg</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">afe_mux_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chroma</span> <span class="o">-</span> <span class="n">CX18_AV_SVIDEO_CHROMA7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">afe_mux_cfg</span> <span class="o">&amp;=</span> <span class="mh">0xcf</span><span class="p">;</span>
			<span class="n">afe_mux_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">chroma</span> <span class="o">-</span> <span class="n">CX18_AV_SVIDEO_CHROMA4</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">input_mode</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">aud_input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX18_AV_AUDIO_SERIAL1</span>:
	<span class="k">case</span> <span class="n">CX18_AV_AUDIO_SERIAL2</span>:
		<span class="cm">/* do nothing, use serial audio input */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX18_AV_AUDIO4</span>:
		<span class="n">afe_mux_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x30</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX18_AV_AUDIO5</span>:
		<span class="n">afe_mux_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">afe_mux_cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX18_AV_AUDIO6</span>:
		<span class="n">afe_mux_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">afe_mux_cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x30</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX18_AV_AUDIO7</span>:
		<span class="n">afe_mux_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xc0</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX18_AV_AUDIO8</span>:
		<span class="n">afe_mux_cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">afe_mux_cfg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xc0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SIF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">CX18_ERR_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;0x%04x is not a valid audio input!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">aud_input</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up analog front end multiplexers */</span>
	<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x103</span><span class="p">,</span> <span class="n">afe_mux_cfg</span><span class="p">,</span> <span class="n">afe_mux_cfg</span><span class="p">,</span> <span class="mh">0xf7</span><span class="p">);</span>
	<span class="cm">/* Set INPUT_MODE to Composite, S-Video, or Component */</span>
	<span class="n">cx18_av_and_or</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x401</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x6</span><span class="p">,</span> <span class="n">input_mode</span><span class="p">);</span>

	<span class="cm">/* Set CH_SEL_ADC2 to 1 if input comes from CH3 */</span>
	<span class="n">adc2_cfg</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x102</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">NONE</span><span class="p">)</span>
		<span class="n">adc2_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x2</span><span class="p">;</span> <span class="cm">/* No sig on CH3, set ADC2 to CH2 for input */</span>
	<span class="k">else</span>
		<span class="n">adc2_cfg</span> <span class="o">|=</span> <span class="mh">0x2</span><span class="p">;</span>  <span class="cm">/* Signal on CH3, set ADC2 to CH3 for input */</span>

	<span class="cm">/* Set DUAL_MODE_ADC2 to 1 if input comes from both CH2 and CH3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NONE</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NONE</span><span class="p">)</span>
		<span class="n">adc2_cfg</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span> <span class="cm">/* Set dual mode */</span>
	<span class="k">else</span>
		<span class="n">adc2_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x4</span><span class="p">;</span> <span class="cm">/* Clear dual mode */</span>
	<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x102</span><span class="p">,</span> <span class="n">adc2_cfg</span><span class="p">,</span> <span class="n">adc2_cfg</span><span class="p">,</span> <span class="mh">0x17</span><span class="p">);</span>

	<span class="cm">/* Configure the analog front end */</span>
	<span class="n">afe_cfg</span> <span class="o">=</span> <span class="n">cx18_av_read4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_AFE_CTRL</span><span class="p">);</span>
	<span class="n">afe_cfg</span> <span class="o">&amp;=</span> <span class="mh">0xff000000</span><span class="p">;</span>
	<span class="n">afe_cfg</span> <span class="o">|=</span> <span class="mh">0x00005000</span><span class="p">;</span> <span class="cm">/* CHROMA_IN, AUD_IN: ADC2; LUMA_IN: ADC1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NONE</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NONE</span><span class="p">)</span>
		<span class="n">afe_cfg</span> <span class="o">|=</span> <span class="mh">0x00000030</span><span class="p">;</span> <span class="cm">/* half_bw_ch[2-3] since in dual mode */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ch</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
		<span class="nl">default:</span>
		<span class="k">case</span> <span class="n">NONE</span>:
			<span class="cm">/* CLAMP_SEL = Fixed to midcode clamp level */</span>
			<span class="n">afe_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x00000200</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CVBS</span>:
		<span class="k">case</span> <span class="n">Y</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">afe_cfg</span> <span class="o">|=</span> <span class="mh">0x00002000</span><span class="p">;</span> <span class="cm">/* LUMA_IN_SEL: ADC2 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">C</span>:
		<span class="k">case</span> <span class="n">Pb</span>:
		<span class="k">case</span> <span class="n">Pr</span>:
			<span class="cm">/* CLAMP_SEL = Fixed to midcode clamp level */</span>
			<span class="n">afe_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x00000200</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ch</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">C</span><span class="p">)</span>
				<span class="n">afe_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00001000</span><span class="p">;</span> <span class="cm">/* CHROMA_IN_SEL ADC1 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SIF</span>:
			<span class="cm">/*</span>
<span class="cm">			 * VGA_GAIN_SEL = Audio Decoder</span>
<span class="cm">			 * CLAMP_SEL = Fixed to midcode clamp level</span>
<span class="cm">			 */</span>
			<span class="n">afe_cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="mh">0x00000240</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">afe_cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00004000</span><span class="p">;</span> <span class="cm">/* AUD_IN_SEL ADC1 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_AFE_CTRL</span><span class="p">,</span> <span class="n">afe_cfg</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">vid_input</span> <span class="o">=</span> <span class="n">vid_input</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">aud_input</span> <span class="o">=</span> <span class="n">aud_input</span><span class="p">;</span>
	<span class="n">cx18_av_audio_set_path</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="n">input_change</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_video_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">input</span><span class="p">,</span> <span class="n">u32</span> <span class="n">output</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">set_input</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">aud_input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_audio_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">input</span><span class="p">,</span> <span class="n">u32</span> <span class="n">output</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">set_input</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">vid_input</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">vpres</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vpres</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x40e</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">vpres</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>

	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span>
		    <span class="n">V4L2_TUNER_CAP_STEREO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_LANG1</span> <span class="o">|</span>
		    <span class="n">V4L2_TUNER_CAP_LANG2</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_SAP</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x804</span><span class="p">);</span>

	<span class="cm">/* get rxsubchans and audmode */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_SAP</span><span class="p">;</span>

	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">v</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x809</span><span class="p">);</span>
	<span class="n">v</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="cm">/* mono      -&gt; mono</span>
<span class="cm">		   stereo    -&gt; mono</span>
<span class="cm">		   bilingual -&gt; lang1 */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
		<span class="cm">/* mono      -&gt; mono</span>
<span class="cm">		   stereo    -&gt; stereo</span>
<span class="cm">		   bilingual -&gt; lang1 */</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span>:
		<span class="cm">/* mono      -&gt; mono</span>
<span class="cm">		   stereo    -&gt; stereo</span>
<span class="cm">		   bilingual -&gt; lang1/lang2 */</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="mh">0x7</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
		<span class="cm">/* mono      -&gt; mono</span>
<span class="cm">		   stereo    -&gt; stereo</span>
<span class="cm">		   bilingual -&gt; lang2 */</span>
		<span class="n">v</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cx18_av_write_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x809</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">vt</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">u8</span> <span class="n">fmt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 	<span class="cm">/* zero is autodetect */</span>
	<span class="n">u8</span> <span class="n">pal_m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">norm</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">norm</span><span class="p">;</span>

	<span class="cm">/* First tests should be against specific std */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC_443</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pal_m</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x5</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_N</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x6</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_60</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x8</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Then, test against generic ones */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x4</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0xc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;changing video std to fmt %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="cm">/* Follow step 9 of section 3.16 in the cx18_av datasheet.</span>
<span class="cm">	   Without this PAL may display a vertical ghosting effect.</span>
<span class="cm">	   This happens for example with the Yuan MPC622. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">fmt</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set format to NTSC-M */</span>
		<span class="n">cx18_av_and_or</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="o">~</span><span class="mh">0xf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* Turn off LCOMB */</span>
		<span class="n">cx18_av_and_or</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x47b</span><span class="p">,</span> <span class="o">~</span><span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">cx18_av_and_or</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x2f</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="n">cx18_av_and_or</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x403</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x3</span><span class="p">,</span> <span class="n">pal_m</span><span class="p">);</span>
	<span class="n">cx18_av_std_setup</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="n">input_change</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">to_sd</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x414</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">-</span> <span class="mi">128</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x415</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x420</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x421</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x422</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_mbus_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">HSC</span><span class="p">,</span> <span class="n">VSC</span><span class="p">,</span> <span class="n">Vsrc</span><span class="p">,</span> <span class="n">Hsrc</span><span class="p">,</span> <span class="n">filter</span><span class="p">,</span> <span class="n">Vlines</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_50Hz</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_FIXED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>

	<span class="n">Vsrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x476</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">Vsrc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x475</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">Hsrc</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x472</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">Hsrc</span> <span class="o">|=</span> <span class="p">(</span><span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x471</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * This adjustment reflects the excess of vactive, set in</span>
<span class="cm">	 * cx18_av_std_setup(), above standard values:</span>
<span class="cm">	 *</span>
<span class="cm">	 * 480 + 1 for 60 Hz systems</span>
<span class="cm">	 * 576 + 3 for 50 Hz systems</span>
<span class="cm">	 */</span>
	<span class="n">Vlines</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="p">(</span><span class="n">is_50Hz</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Invalid height and width scaling requests are:</span>
<span class="cm">	 * 1. width less than 1/16 of the source width</span>
<span class="cm">	 * 2. width greater than the source width</span>
<span class="cm">	 * 3. height less than 1/8 of the source height</span>
<span class="cm">	 * 4. height greater than the source height</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">&lt;</span> <span class="n">Hsrc</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Hsrc</span> <span class="o">&lt;</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">Vlines</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">&lt;</span> <span class="n">Vsrc</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">Vsrc</span> <span class="o">&lt;</span> <span class="n">Vlines</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CX18_ERR_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%dx%d is not a valid size!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">HSC</span> <span class="o">=</span> <span class="p">(</span><span class="n">Hsrc</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">))</span> <span class="o">/</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">);</span>
	<span class="n">VSC</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">Vsrc</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">/</span> <span class="n">Vlines</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">9</span><span class="p">));</span>
	<span class="n">VSC</span> <span class="o">&amp;=</span> <span class="mh">0x1fff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;=</span> <span class="mi">385</span><span class="p">)</span>
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">192</span><span class="p">)</span>
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">96</span><span class="p">)</span>
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">filter</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
			    <span class="s">&quot;decoder set size %dx%d -&gt; scale  %ux%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">HSC</span><span class="p">,</span> <span class="n">VSC</span><span class="p">);</span>

	<span class="cm">/* HSCALE=HSC */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x418</span><span class="p">,</span> <span class="n">HSC</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x419</span><span class="p">,</span> <span class="p">(</span><span class="n">HSC</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x41a</span><span class="p">,</span> <span class="n">HSC</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="cm">/* VSCALE=VSC */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x41c</span><span class="p">,</span> <span class="n">VSC</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x41d</span><span class="p">,</span> <span class="n">VSC</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="cm">/* VS_INTRLACE=1 VFILT=filter */</span>
	<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x41e</span><span class="p">,</span> <span class="mh">0x8</span> <span class="o">|</span> <span class="n">filter</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">CX18_DEBUG_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x115</span><span class="p">,</span> <span class="mh">0x8c</span><span class="p">);</span>
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x116</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x115</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">cx18_av_write</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x116</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">log_video_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">fmt_strs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;0x0&quot;</span><span class="p">,</span>
		<span class="s">&quot;NTSC-M&quot;</span><span class="p">,</span> <span class="s">&quot;NTSC-J&quot;</span><span class="p">,</span> <span class="s">&quot;NTSC-4.43&quot;</span><span class="p">,</span>
		<span class="s">&quot;PAL-BDGHI&quot;</span><span class="p">,</span> <span class="s">&quot;PAL-M&quot;</span><span class="p">,</span> <span class="s">&quot;PAL-N&quot;</span><span class="p">,</span> <span class="s">&quot;PAL-Nc&quot;</span><span class="p">,</span> <span class="s">&quot;PAL-60&quot;</span><span class="p">,</span>
		<span class="s">&quot;0x9&quot;</span><span class="p">,</span> <span class="s">&quot;0xA&quot;</span><span class="p">,</span> <span class="s">&quot;0xB&quot;</span><span class="p">,</span>
		<span class="s">&quot;SECAM&quot;</span><span class="p">,</span>
		<span class="s">&quot;0xD&quot;</span><span class="p">,</span> <span class="s">&quot;0xE&quot;</span><span class="p">,</span> <span class="s">&quot;0xF&quot;</span>
	<span class="p">};</span>

	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">av_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vidfmt_sel</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x400</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gen_stat1</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x40d</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">gen_stat2</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x40e</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">vid_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">vid_input</span><span class="p">;</span>

	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Video signal:              %spresent</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">gen_stat2</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not &quot;</span><span class="p">);</span>
	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Detected format:           %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">fmt_strs</span><span class="p">[</span><span class="n">gen_stat1</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]);</span>

	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Specified standard:        %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">vidfmt_sel</span> <span class="o">?</span> <span class="n">fmt_strs</span><span class="p">[</span><span class="n">vidfmt_sel</span><span class="p">]</span>
				 <span class="o">:</span> <span class="s">&quot;automatic detection&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vid_input</span> <span class="o">&gt;=</span> <span class="n">CX18_AV_COMPOSITE1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vid_input</span> <span class="o">&lt;=</span> <span class="n">CX18_AV_COMPOSITE8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Specified video input:     Composite %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">vid_input</span> <span class="o">-</span> <span class="n">CX18_AV_COMPOSITE1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Specified video input:     &quot;</span>
			      <span class="s">&quot;S-Video (Luma In%d, Chroma In%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">vid_input</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">vid_input</span> <span class="o">&amp;</span> <span class="mh">0xf00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Specified audioclock freq: %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">state</span><span class="o">-&gt;</span><span class="n">audclk_freq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">log_audio_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">av_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">download_ctl</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x803</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mod_det_stat0</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x804</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mod_det_stat1</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x805</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">audio_config</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x808</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">pref_mode</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x809</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">afc0</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x80b</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mute_ctl</span> <span class="o">=</span> <span class="n">cx18_av_read</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mh">0x8d3</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">aud_input</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">aud_input</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mod_det_stat0</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;mono&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;stereo&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;dual&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;tri&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x10</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;mono with SAP&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x11</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;stereo with SAP&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x12</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;dual with SAP&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x14</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;tri with SAP&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xfe</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;forced mode&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;not defined&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Detected audio mode:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mod_det_stat1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;not defined&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;EIAJ&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-M&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-BG&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-DK1&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-DK2&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-DK3&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A1 (6.0 MHz FM Mono)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x08</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;AM-L&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x09</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;NICAM-BG&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0a</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;NICAM-DK&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0b</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;NICAM-I&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0c</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;NICAM-L&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0d</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;BTSC/EIAJ/A2-M Mono (4.5 MHz FMMono)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0e</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;IF FM Radio&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0f</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;BTSC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x10</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;detected chrominance&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xfd</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;unknown audio standard&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xfe</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;forced audio standard&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0xff</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;no detected audio standard&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;not defined&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Detected audio standard:   %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Audio muted:               %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">mute_ctl</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Audio microcontroller:     %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">download_ctl</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;running&quot;</span> <span class="o">:</span> <span class="s">&quot;stopped&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">audio_config</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x00</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;undefined&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x01</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;BTSC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x02</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;EIAJ&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x03</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-M&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x04</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-BG&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x05</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-DK1&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x06</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-DK2&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x07</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-DK3&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x08</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A1 (6.0 MHz FM Mono)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x09</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;AM-L&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0a</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;NICAM-BG&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0b</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;NICAM-DK&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0c</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;NICAM-I&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0d</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;NICAM-L&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0e</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;FM radio&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x0f</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;automatic detection&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;undefined&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Configured audio standard: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">audio_config</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">audio_config</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;MONO1 (LANGUAGE A/Mono L+R channel for BTSC, EIAJ, A2)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;MONO2 (LANGUAGE B)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;MONO3 (STEREO forced MONO)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;MONO4 (NICAM ANALOG-Language C/Analog Fallback)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;STEREO&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;DUAL1 (AC)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;DUAL2 (BC)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;DUAL3 (AB)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;undefined&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Configured audio mode:     %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">audio_config</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x00</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;BG&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x01</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;DK1&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x02</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;DK2&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x03</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;DK3&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x04</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;I&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x05</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;L&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x06</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;BTSC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x07</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;EIAJ&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x08</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-M&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x09</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;FM Radio (4.5 MHz)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0a</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;FM Radio (5.5 MHz)&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0b</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;S-Video&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0f</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;automatic standard and mode detection&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;undefined&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Configured audio system:   %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">aud_input</span><span class="p">)</span>
		<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Specified audio input:     Tuner (In%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">aud_input</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Specified audio input:     External</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pref_mode</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;mono/language A&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;language B&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;language C&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;analog fallback&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;stereo&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;language AC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;language BC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;language AB&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span> <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;undefined&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Preferred audio mode:      %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">audio_config</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xf</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">((</span><span class="n">afc0</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;system DK&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;system L&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Selected 65 MHz format:    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">afc0</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;Chroma&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;BTSC&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;EIAJ&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;A2-M&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>: <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;autodetect&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span> <span class="n">p</span> <span class="o">=</span> <span class="s">&quot;undefined&quot;</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">CX18_INFO_DEV</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Selected 45 MHz format:    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">log_video_status</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="n">log_audio_status</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">cx18_av_dbg_match</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_dbg_match</span> <span class="o">*</span><span class="n">match</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CHIP_MATCH_HOST</span> <span class="o">&amp;&amp;</span> <span class="n">match</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_cx18_av_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx18_av_dbg_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cx18_av_dbg_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">cx18_av_read4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x00000ffc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_av_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cx18_av_dbg_match</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">cx18_av_write4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x00000ffc</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">cx18_av_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">cx18_av_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">cx18_av_general_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_chip_ident</span> <span class="o">=</span> <span class="n">cx18_av_g_chip_ident</span><span class="p">,</span>
	<span class="p">.</span><span class="n">log_status</span> <span class="o">=</span> <span class="n">cx18_av_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">load_fw</span> <span class="o">=</span> <span class="n">cx18_av_load_fw</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">cx18_av_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_s_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_try_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_g_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queryctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">querymenu</span> <span class="o">=</span> <span class="n">v4l2_subdev_querymenu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_std</span> <span class="o">=</span> <span class="n">cx18_av_s_std</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">g_register</span> <span class="o">=</span> <span class="n">cx18_av_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_register</span> <span class="o">=</span> <span class="n">cx18_av_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_tuner_ops</span> <span class="n">cx18_av_tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_radio</span> <span class="o">=</span> <span class="n">cx18_av_s_radio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_frequency</span> <span class="o">=</span> <span class="n">cx18_av_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_tuner</span> <span class="o">=</span> <span class="n">cx18_av_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_tuner</span> <span class="o">=</span> <span class="n">cx18_av_s_tuner</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_audio_ops</span> <span class="n">cx18_av_audio_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_clock_freq</span> <span class="o">=</span> <span class="n">cx18_av_s_clock_freq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_routing</span> <span class="o">=</span> <span class="n">cx18_av_s_audio_routing</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">cx18_av_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_routing</span> <span class="o">=</span> <span class="n">cx18_av_s_video_routing</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_stream</span> <span class="o">=</span> <span class="n">cx18_av_s_stream</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span> <span class="o">=</span> <span class="n">cx18_av_s_mbus_fmt</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_vbi_ops</span> <span class="n">cx18_av_vbi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">decode_vbi_line</span> <span class="o">=</span> <span class="n">cx18_av_decode_vbi_line</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_sliced_fmt</span> <span class="o">=</span> <span class="n">cx18_av_g_sliced_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_sliced_fmt</span> <span class="o">=</span> <span class="n">cx18_av_s_sliced_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_raw_fmt</span> <span class="o">=</span> <span class="n">cx18_av_s_raw_fmt</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">cx18_av_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx18_av_general_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx18_av_tuner_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">audio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx18_av_audio_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx18_av_video_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx18_av_vbi_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">cx18_av_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_av_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">av_state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">cx18_av_read4</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CXADEC_CHIP_CTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="n">CXADEC_CHIP_TYPE_MAKO</span><span class="p">)</span>
		    <span class="o">?</span> <span class="n">V4L2_IDENT_CX23418_843</span> <span class="o">:</span> <span class="n">V4L2_IDENT_UNKNOWN</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">vid_input</span> <span class="o">=</span> <span class="n">CX18_AV_COMPOSITE7</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">aud_input</span> <span class="o">=</span> <span class="n">CX18_AV_AUDIO8</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">audclk_freq</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_delay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_offset</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span> <span class="o">+</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">slicer_line_delay</span> <span class="o">-</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx18_av_ops</span><span class="p">);</span>
	<span class="n">v4l2_set_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">cx</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
		 <span class="s">&quot;%s %03x&quot;</span><span class="p">,</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">));</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="n">CX18_HW_418_AV</span><span class="p">;</span>
	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx18_av_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx18_av_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx18_av_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_SATURATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx18_av_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_HUE</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">volume</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">cx18_av_audio_ctrl_ops</span><span class="p">,</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="mi">65535</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">cx18_av_audio_ctrl_ops</span><span class="p">,</span> <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx18_av_audio_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_AUDIO_BALANCE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="mi">65535</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">32768</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx18_av_audio_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_AUDIO_BASS</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="mi">65535</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">32768</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx18_av_audio_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_AUDIO_TREBLE</span><span class="p">,</span>
			<span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="mi">65535</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">32768</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">cx18_av_init</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
