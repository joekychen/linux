<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › cx18 › cx18-mailbox.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cx18-mailbox.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  cx18 mailbox functions</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007  Hans Verkuil &lt;hverkuil@xs4all.nl&gt;</span>
<span class="cm"> *  Copyright (C) 2008  Andy Walls &lt;awalls@md.metrocast.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA</span>
<span class="cm"> *  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;stdarg.h&gt;</span>

<span class="cp">#include &quot;cx18-driver.h&quot;</span>
<span class="cp">#include &quot;cx18-io.h&quot;</span>
<span class="cp">#include &quot;cx18-scb.h&quot;</span>
<span class="cp">#include &quot;cx18-irq.h&quot;</span>
<span class="cp">#include &quot;cx18-mailbox.h&quot;</span>
<span class="cp">#include &quot;cx18-queue.h&quot;</span>
<span class="cp">#include &quot;cx18-streams.h&quot;</span>
<span class="cp">#include &quot;cx18-alsa-pcm.h&quot; </span><span class="cm">/* FIXME make configurable */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">rpu_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;APU&quot;</span><span class="p">,</span> <span class="s">&quot;CPU&quot;</span><span class="p">,</span> <span class="s">&quot;EPU&quot;</span><span class="p">,</span> <span class="s">&quot;HPU&quot;</span> <span class="p">};</span>

<span class="cp">#define API_FAST (1 &lt;&lt; 2) </span><span class="cm">/* Short timeout */</span><span class="cp"></span>
<span class="cp">#define API_SLOW (1 &lt;&lt; 3) </span><span class="cm">/* Additional 300ms timeout */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">cx18_api_info</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>		<span class="cm">/* Flags, see above */</span>
	<span class="n">u8</span> <span class="n">rpu</span><span class="p">;</span>			<span class="cm">/* Processing unit */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span> 	<span class="cm">/* The name of the command */</span>
<span class="p">};</span>

<span class="cp">#define API_ENTRY(rpu, x, f) { (x), (f), (rpu), #x }</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cx18_api_info</span> <span class="n">api_info</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MPEG encoder API */</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_CHANNEL_TYPE</span><span class="p">,</span>		<span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_EPU_DEBUG</span><span class="p">,</span> 				<span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CREATE_TASK</span><span class="p">,</span> 			<span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_DESTROY_TASK</span><span class="p">,</span> 			<span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_CAPTURE_START</span><span class="p">,</span>                  <span class="n">API_SLOW</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_CAPTURE_STOP</span><span class="p">,</span>                   <span class="n">API_SLOW</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_CAPTURE_PAUSE</span><span class="p">,</span>                  <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_CAPTURE_RESUME</span><span class="p">,</span>                 <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_CHANNEL_TYPE</span><span class="p">,</span>               <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_STREAM_OUTPUT_TYPE</span><span class="p">,</span>         <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VIDEO_IN</span><span class="p">,</span>                   <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VIDEO_RATE</span><span class="p">,</span>                 <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VIDEO_RESOLUTION</span><span class="p">,</span>           <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_FILTER_PARAM</span><span class="p">,</span>               <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_SPATIAL_FILTER_TYPE</span><span class="p">,</span>        <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_MEDIAN_CORING</span><span class="p">,</span>              <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_INDEXTABLE</span><span class="p">,</span>                 <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_AUDIO_PARAMETERS</span><span class="p">,</span>           <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VIDEO_MUTE</span><span class="p">,</span>                 <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_AUDIO_MUTE</span><span class="p">,</span>                 <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_MISC_PARAMETERS</span><span class="p">,</span>            <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_RAW_VBI_PARAM</span><span class="p">,</span>              <span class="n">API_SLOW</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_CAPTURE_LINE_NO</span><span class="p">,</span>            <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_COPYRIGHT</span><span class="p">,</span>                  <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_AUDIO_PID</span><span class="p">,</span>                  <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VIDEO_PID</span><span class="p">,</span>                  <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VER_CROP_LINE</span><span class="p">,</span>              <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_GOP_STRUCTURE</span><span class="p">,</span>              <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_SCENE_CHANGE_DETECTION</span><span class="p">,</span>     <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_ASPECT_RATIO</span><span class="p">,</span>               <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_SKIP_INPUT_FRAME</span><span class="p">,</span>           <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_SLICED_VBI_PARAM</span><span class="p">,</span>           <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_USERDATA_PLACE_HOLDER</span><span class="p">,</span>      <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_GET_ENC_PTS</span><span class="p">,</span>                    <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VFC_PARAM</span><span class="p">,</span>                  <span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_DE_SET_MDL_ACK</span><span class="p">,</span>			<span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_DE_SET_MDL</span><span class="p">,</span>			<span class="n">API_FAST</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_DE_RELEASE_MDL</span><span class="p">,</span>			<span class="n">API_SLOW</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">APU</span><span class="p">,</span> <span class="n">CX18_APU_START</span><span class="p">,</span>				<span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">APU</span><span class="p">,</span> <span class="n">CX18_APU_STOP</span><span class="p">,</span>				<span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">APU</span><span class="p">,</span> <span class="n">CX18_APU_RESETAI</span><span class="p">,</span>			<span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="n">CPU</span><span class="p">,</span> <span class="n">CX18_CPU_DEBUG_PEEK32</span><span class="p">,</span>			<span class="mi">0</span><span class="p">),</span>
	<span class="n">API_ENTRY</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>						<span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cx18_api_info</span> <span class="o">*</span><span class="nf">find_api_info</span><span class="p">(</span><span class="n">u32</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">api_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">api_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">cmd</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">api_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Call with buf of n*11+1 bytes */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">u32arr2hex</span><span class="p">(</span><span class="n">u32</span> <span class="n">data</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* kernel snprintf() appends &#39;\0&#39; always */</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="s">&quot; %#010x&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_mb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_mailbox</span> <span class="o">*</span><span class="n">mb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">argstr</span><span class="p">[</span><span class="n">MAX_MB_ARGUMENTS</span><span class="o">*</span><span class="mi">11</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cx18_debug</span> <span class="o">&amp;</span> <span class="n">CX18_DBGFLG_API</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">CX18_DEBUG_API</span><span class="p">(</span><span class="s">&quot;%s: req %#010x ack %#010x cmd %#010x err %#010x args%s&quot;</span>
		       <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">,</span>
		       <span class="n">u32arr2hex</span><span class="p">(</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">,</span> <span class="n">MAX_MB_ARGUMENTS</span><span class="p">,</span> <span class="n">argstr</span><span class="p">));</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Functions that run in a work_queue work handling context</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx18_mdl_send_to_dvb</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_mdl</span> <span class="o">*</span><span class="n">mdl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dvb</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">||</span> <span class="n">mdl</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We ignore mdl and buf readpos accounting here - it doesn&#39;t matter */</span>

	<span class="cm">/* The likely case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_is_singular</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdl</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdl</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_buffer</span><span class="p">,</span>
				       <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">)</span>
			<span class="n">dvb_dmx_swfilter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span>
					 <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdl</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dvb_dmx_swfilter</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="o">-&gt;</span><span class="n">demux</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx18_mdl_send_to_videobuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">cx18_mdl</span> <span class="o">*</span><span class="n">mdl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_videobuf_buffer</span> <span class="o">*</span><span class="n">vb_buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dispatch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdl</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Acquire a videobuf buffer, clone to and and release it */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">vb_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">vb_capture</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">vb_buf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">vb_capture</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_videobuf_buffer</span><span class="p">,</span>
		<span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">videobuf_to_vmalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">bytes_used</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdl</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">offset</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">bsize</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>
			<span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">bytes_used</span> <span class="o">+=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If we&#39;ve filled the buffer as per the callers res then dispatch it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">bytes_used</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">vb_bytes_per_frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dispatch</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">bytes_used</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dispatch</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span> <span class="o">=</span> <span class="n">ktime_to_timeval</span><span class="p">(</span><span class="n">ktime_get</span><span class="p">());</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb_buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">vb_timeout</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">)</span> <span class="o">+</span> <span class="n">jiffies</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">vb_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cx18_mdl_send_to_alsa</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">cx18_mdl</span> <span class="o">*</span><span class="n">mdl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mdl</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* We ignore mdl and buf readpos accounting here - it doesn&#39;t matter */</span>

	<span class="cm">/* The likely case */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_is_singular</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdl</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mdl</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_buffer</span><span class="p">,</span>
				       <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">)</span>
			<span class="n">cx</span><span class="o">-&gt;</span><span class="n">pcm_announce_callback</span><span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">alsa</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span>
						  <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mdl</span><span class="o">-&gt;</span><span class="n">buf_list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">cx</span><span class="o">-&gt;</span><span class="n">pcm_announce_callback</span><span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">alsa</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">epu_dma_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">handle</span><span class="p">,</span> <span class="n">mdl_ack_count</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_mailbox</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_mdl_ack</span> <span class="o">*</span><span class="n">mdl_ack</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_mdl</span> <span class="o">*</span><span class="n">mdl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">cx18_handle_to_stream</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Got DMA done notification for unknown/inactive&quot;</span>
			  <span class="s">&quot; handle %d, %s mailbox seq no %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">handle</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CX18_F_EWO_MB_STALE_UPON_RECEIPT</span><span class="p">)</span> <span class="o">?</span>
			  <span class="s">&quot;stale&quot;</span> <span class="o">:</span> <span class="s">&quot;good&quot;</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mdl_ack_count</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">mdl_ack</span> <span class="o">=</span> <span class="n">order</span><span class="o">-&gt;</span><span class="n">mdl_ack</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mdl_ack_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mdl_ack</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="n">mdl_ack</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Simple integrity check for processing a stale (and possibly</span>
<span class="cm">		 * inconsistent mailbox): make sure the MDL id is in the</span>
<span class="cm">		 * valid range for the stream.</span>
<span class="cm">		 *</span>
<span class="cm">		 * We go through the trouble of dealing with stale mailboxes</span>
<span class="cm">		 * because most of the time, the mailbox data is still valid and</span>
<span class="cm">		 * unchanged (and in practice the firmware ping-pongs the</span>
<span class="cm">		 * two mdl_ack buffers so mdl_acks are not stale).</span>
<span class="cm">		 *</span>
<span class="cm">		 * There are occasions when we get a half changed mailbox,</span>
<span class="cm">		 * which this check catches for a handle &amp; id mismatch.  If the</span>
<span class="cm">		 * handle and id do correspond, the worst case is that we</span>
<span class="cm">		 * completely lost the old MDL, but pick up the new MDL</span>
<span class="cm">		 * early (but the new mdl_ack is guaranteed to be good in this</span>
<span class="cm">		 * case as the firmware wouldn&#39;t point us to a new mdl_ack until</span>
<span class="cm">		 * it&#39;s filled in).</span>
<span class="cm">		 *</span>
<span class="cm">		 * cx18_queue_get_mdl() will detect the lost MDLs</span>
<span class="cm">		 * and send them back to q_free for fw rotation eventually.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CX18_F_EWO_MB_STALE_UPON_RECEIPT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">mdl_base_idx</span> <span class="o">&amp;&amp;</span>
		      <span class="n">id</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mdl_base_idx</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Fell behind! Ignoring stale mailbox with &quot;</span>
				  <span class="s">&quot; inconsistent data. Lost MDL for mailbox &quot;</span>
				  <span class="s">&quot;seq no %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">mdl</span> <span class="o">=</span> <span class="n">cx18_queue_get_mdl</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">mdl_ack</span><span class="o">-&gt;</span><span class="n">data_used</span><span class="p">);</span>

		<span class="n">CX18_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;DMA DONE for %s (MDL %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mdl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Could not find MDL %d for stream %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">id</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">CX18_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;%s recv bytesused = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mdl</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CX18_ENC_STREAM_TYPE_TS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx18_mdl_send_to_dvb</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mdl</span><span class="p">);</span>
			<span class="n">cx18_enqueue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_free</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CX18_ENC_STREAM_TYPE_PCM</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Pass the data to cx18-alsa */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">pcm_announce_callback</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cx18_mdl_send_to_alsa</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">mdl</span><span class="p">);</span>
				<span class="n">cx18_enqueue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_free</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">cx18_enqueue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_full</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CX18_ENC_STREAM_TYPE_YUV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cx18_mdl_send_to_videobuf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mdl</span><span class="p">);</span>
			<span class="n">cx18_enqueue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_free</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cx18_enqueue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">mdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_full</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">CX18_ENC_STREAM_TYPE_IDX</span><span class="p">)</span>
				<span class="n">cx18_stream_rotate_idx_mdls</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* Put as many MDLs as possible back into fw use */</span>
	<span class="n">cx18_stream_load_fw_queue</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">epu_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">order</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">;</span>

	<span class="n">CX18_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;%x %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">str</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="sc">&#39;.&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">CX18_F_I_LOADED_FW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">str</span><span class="p">)</span>
		<span class="n">CX18_INFO</span><span class="p">(</span><span class="s">&quot;FW version: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">epu_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">rpu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU</span>:
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CX18_EPU_DMA_DONE</span>:
			<span class="n">epu_dma_done</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CX18_EPU_DEBUG</span>:
			<span class="n">epu_debug</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Unknown CPU to EPU mailbox command %#0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">APU</span>:
		<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Unknown APU to EPU mailbox command %#0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="nf">free_in_work_order</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx18_in_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_in_work_order</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">order</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
	<span class="n">epu_cmd</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="n">free_in_work_order</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Functions that run in an interrupt handling context</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mb_ack_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_mailbox</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ack_mb</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ack_irq</span><span class="p">,</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">rpu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APU</span>:
		<span class="n">ack_irq</span> <span class="o">=</span> <span class="n">IRQ_EPU_TO_APU_ACK</span><span class="p">;</span>
		<span class="n">ack_mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">apu2epu_mb</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU</span>:
		<span class="n">ack_irq</span> <span class="o">=</span> <span class="n">IRQ_EPU_TO_CPU_ACK</span><span class="p">;</span>
		<span class="n">ack_mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cpu2epu_mb</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Unhandled RPU (%d) for command %x ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">order</span><span class="o">-&gt;</span><span class="n">rpu</span><span class="p">,</span> <span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>
	<span class="cm">/* Don&#39;t ack if the RPU has gotten impatient and timed us out */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_mb</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">req</span> <span class="o">==</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_mb</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">CX18_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Possibly falling behind: %s self-ack&#39;ed our &quot;</span>
				<span class="s">&quot;incoming %s to EPU mailbox (sequence no. %u) &quot;</span>
				<span class="s">&quot;while processing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rpu_str</span><span class="p">[</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">rpu</span><span class="p">],</span> <span class="n">rpu_str</span><span class="p">[</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">rpu</span><span class="p">],</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">order</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CX18_F_EWO_MB_STALE_WHILE_PROC</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cx18_writel</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_mb</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">);</span>
	<span class="n">cx18_write_reg_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">ack_irq</span><span class="p">,</span> <span class="n">SW2_INT_SET</span><span class="p">,</span> <span class="n">ack_irq</span><span class="p">,</span> <span class="n">ack_irq</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">epu_dma_done_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">handle</span><span class="p">,</span> <span class="n">mdl_ack_offset</span><span class="p">,</span> <span class="n">mdl_ack_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_mailbox</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">mdl_ack_offset</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">mdl_ack_count</span> <span class="o">=</span> <span class="n">mb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="n">CX18_INVALID_TASK_HANDLE</span> <span class="o">||</span>
	    <span class="n">mdl_ack_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mdl_ack_count</span> <span class="o">&gt;</span> <span class="n">CX18_MAX_MDL_ACKS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CX18_F_EWO_MB_STALE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">mb_ack_irq</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18_mdl_ack</span><span class="p">)</span> <span class="o">*</span> <span class="n">mdl_ack_count</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">mdl_ack</span><span class="p">)[</span><span class="n">i</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)]</span> <span class="o">=</span>
			<span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">enc_mem</span> <span class="o">+</span> <span class="n">mdl_ack_offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CX18_F_EWO_MB_STALE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mb_ack_irq</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">int</span> <span class="nf">epu_debug_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">str_offset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">order</span><span class="o">-&gt;</span><span class="n">str</span><span class="p">;</span>

	<span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">str_offset</span> <span class="o">=</span> <span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">str_offset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cx18_setup_page</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">str_offset</span><span class="p">);</span>
		<span class="n">cx18_memcpy_fromio</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">enc_mem</span> <span class="o">+</span> <span class="n">str_offset</span><span class="p">,</span> <span class="mi">252</span><span class="p">);</span>
		<span class="n">str</span><span class="p">[</span><span class="mi">252</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">cx18_setup_page</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">SCB_OFFSET</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CX18_F_EWO_MB_STALE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mb_ack_irq</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">str_offset</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">int</span> <span class="nf">epu_cmd_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">rpu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU</span>:
	<span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">CX18_EPU_DMA_DONE</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">epu_dma_done_irq</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CX18_EPU_DEBUG</span>:
			<span class="n">ret</span> <span class="o">=</span> <span class="n">epu_debug_irq</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Unknown CPU to EPU mailbox command %#0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">APU</span>:
		<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Unknown APU to EPU mailbox command %#0x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="nf">alloc_in_work_order_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CX18_MAX_IN_WORK_ORDERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We only need &quot;pending&quot; atomic to inspect its contents,</span>
<span class="cm">		 * and need not do a check and set because:</span>
<span class="cm">		 * 1. Any work handler thread only clears &quot;pending&quot; and only</span>
<span class="cm">		 * on one, particular work order at a time, per handler thread.</span>
<span class="cm">		 * 2. &quot;pending&quot; is only set here, and we&#39;re serialized because</span>
<span class="cm">		 * we&#39;re called in an IRQ handler context.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">in_work_order</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">order</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">in_work_order</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">pending</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">order</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">cx18_api_epu_cmd_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rpu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_mailbox</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_mailbox</span> <span class="o">*</span><span class="n">order_mb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_in_work_order</span> <span class="o">*</span><span class="n">order</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">submit</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">rpu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CPU</span>:
		<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">cpu2epu_mb</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">APU</span>:
		<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">apu2epu_mb</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">order</span> <span class="o">=</span> <span class="n">alloc_in_work_order_irq</span><span class="p">(</span><span class="n">cx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">order</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Unable to find blank work order form to schedule &quot;</span>
			  <span class="s">&quot;incoming mailbox command processing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">order</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">order</span><span class="o">-&gt;</span><span class="n">rpu</span> <span class="o">=</span> <span class="n">rpu</span><span class="p">;</span>
	<span class="n">order_mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">mb</span><span class="p">;</span>

	<span class="cm">/* mb-&gt;cmd and mb-&gt;args[0] through mb-&gt;args[2] */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">(</span><span class="o">&amp;</span><span class="n">order_mb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* mb-&gt;request and mb-&gt;ack.  N.B. we want to read mb-&gt;ack last */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">(</span><span class="o">&amp;</span><span class="n">order_mb</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">order_mb</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">==</span> <span class="n">order_mb</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CX18_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Possibly falling behind: %s self-ack&#39;ed our &quot;</span>
				<span class="s">&quot;incoming %s to EPU mailbox (sequence no. %u)&quot;</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rpu_str</span><span class="p">[</span><span class="n">rpu</span><span class="p">],</span> <span class="n">rpu_str</span><span class="p">[</span><span class="n">rpu</span><span class="p">],</span> <span class="n">order_mb</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cx18_debug</span> <span class="o">&amp;</span> <span class="n">CX18_DBGFLG_WARN</span><span class="p">)</span>
			<span class="n">dump_mb</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order_mb</span><span class="p">,</span> <span class="s">&quot;incoming&quot;</span><span class="p">);</span>
		<span class="n">order</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CX18_F_EWO_MB_STALE_UPON_RECEIPT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Individual EPU command processing is responsible for ack-ing</span>
<span class="cm">	 * a non-stale mailbox as soon as possible</span>
<span class="cm">	 */</span>
	<span class="n">submit</span> <span class="o">=</span> <span class="n">epu_cmd_irq</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">submit</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">in_work_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">order</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Functions called from a non-interrupt, non work_queue context</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_api_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">args</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cx18_api_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">find_api_info</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">irq</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18_mailbox</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mb</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">waitq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="o">*</span><span class="n">mb_lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">t0</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">argstr</span><span class="p">[</span><span class="n">MAX_MB_ARGUMENTS</span><span class="o">*</span><span class="mi">11</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">w</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;unknown cmd %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx18_debug</span> <span class="o">&amp;</span> <span class="n">CX18_DBGFLG_API</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* only call u32arr2hex if needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">CX18_CPU_DE_SET_MDL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cx18_debug</span> <span class="o">&amp;</span> <span class="n">CX18_DBGFLG_HIGHVOL</span><span class="p">)</span>
				<span class="n">CX18_DEBUG_HI_API</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\t</span><span class="s">cmd %#010x args%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
						<span class="n">u32arr2hex</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">argstr</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">CX18_DEBUG_API</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\t</span><span class="s">cmd %#010x args%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span>
				       <span class="n">u32arr2hex</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">argstr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">rpu</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">APU</span>:
		<span class="n">waitq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">mb_apu_waitq</span><span class="p">;</span>
		<span class="n">mb_lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">epu2apu_mb_lock</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_EPU_TO_APU</span><span class="p">;</span>
		<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">epu2apu_mb</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CPU</span>:
		<span class="n">waitq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">mb_cpu_waitq</span><span class="p">;</span>
		<span class="n">mb_lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">epu2cpu_mb_lock</span><span class="p">;</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ_EPU_TO_CPU</span><span class="p">;</span>
		<span class="n">mb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">epu2cpu_mb</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Unknown RPU (%d) for API call</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rpu</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">mb_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Wait for an in-use mailbox to complete</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the XPU is responding with Ack&#39;s, the mailbox shouldn&#39;t be in</span>
<span class="cm">	 * a busy state, since we serialize access to it on our end.</span>
<span class="cm">	 *</span>
<span class="cm">	 * If the wait for ack after sending a previous command was interrupted</span>
<span class="cm">	 * by a signal, we may get here and find a busy mailbox.  After waiting,</span>
<span class="cm">	 * mark it &quot;not busy&quot; from our end, if the XPU hasn&#39;t ack&#39;ed it still.</span>
<span class="cm">	 */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="o">*</span><span class="n">waitq</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">ack</span> <span class="o">=</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">))</span> <span class="o">==</span> <span class="n">req</span><span class="p">,</span>
				 <span class="n">timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* waited long enough, make the mbox &quot;not busy&quot; from our end */</span>
		<span class="n">cx18_writel</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">);</span>
		<span class="n">CX18_ERR</span><span class="p">(</span><span class="s">&quot;mbox was found stuck busy when setting up for %s; &quot;</span>
			 <span class="s">&quot;clearing busy and trying to proceed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">timeout</span><span class="p">)</span>
		<span class="n">CX18_DEBUG_API</span><span class="p">(</span><span class="s">&quot;waited %u msecs for busy mbox to be acked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">timeout</span><span class="o">-</span><span class="n">ret</span><span class="p">));</span>

	<span class="cm">/* Build the outgoing mailbox */</span>
	<span class="n">req</span> <span class="o">=</span> <span class="p">((</span><span class="n">req</span> <span class="o">&amp;</span> <span class="mh">0xfffffffe</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xfffffffe</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">req</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cx18_writel</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cx18_writel</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">cx18_writel</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="n">cx18_writel</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">req</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
	<span class="n">cx18_writel</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">req</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">);</span> <span class="cm">/* ensure ack &amp; req are distinct */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Notify the XPU and wait for it to send an Ack back</span>
<span class="cm">	 */</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">API_FAST</span><span class="p">)</span> <span class="o">?</span> <span class="mi">10</span> <span class="o">:</span> <span class="mi">20</span><span class="p">);</span>

	<span class="n">CX18_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;sending interrupt SW1: %x to send %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">irq</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* So we don&#39;t miss the wakeup, prepare to wait before notifying fw */</span>
	<span class="n">prepare_to_wait</span><span class="p">(</span><span class="n">waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">,</span> <span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
	<span class="n">cx18_write_reg_expect</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">SW1_INT_SET</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="n">t0</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">ack</span> <span class="o">=</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack</span> <span class="o">!=</span> <span class="n">req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">t0</span><span class="p">;</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">ack</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">t0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">finish_wait</span><span class="p">(</span><span class="n">waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="n">ack</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">mb_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Timed out */</span>
			<span class="n">CX18_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;sending %s timed out waiting %d msecs &quot;</span>
					<span class="s">&quot;for RPU acknowledgement</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">CX18_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;woken up before mailbox ack was ready &quot;</span>
					<span class="s">&quot;after submitting %s to RPU.  only &quot;</span>
					<span class="s">&quot;waited %d msecs on req %u but awakened&quot;</span>
					<span class="s">&quot; with unmatched ack %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">ret</span><span class="p">),</span>
					<span class="n">req</span><span class="p">,</span> <span class="n">ack</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="n">timeout</span><span class="p">)</span>
		<span class="n">CX18_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;failed to be awakened upon RPU acknowledgment &quot;</span>
				<span class="s">&quot;sending %s; timed out waiting %d msecs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">ret</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">CX18_DEBUG_HI_API</span><span class="p">(</span><span class="s">&quot;waited %u msecs for %s to be acked</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">ret</span><span class="p">),</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Collect data returned by the XPU */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_MB_ARGUMENTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">cx18_readl</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mb</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">mb_lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait for XPU to perform extra actions for the caller in some cases.</span>
<span class="cm">	 * e.g. CX18_CPU_DE_RELEASE_MDL will cause the CPU to send all MDLs</span>
<span class="cm">	 * back in a burst shortly thereafter</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">API_SLOW</span><span class="p">)</span>
		<span class="n">cx18_msleep_timeout</span><span class="p">(</span><span class="mi">300</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">CX18_DEBUG_API</span><span class="p">(</span><span class="s">&quot;mailbox error %08x for command %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
				<span class="n">info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="o">-</span><span class="n">EIO</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx18_api</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">args</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cx18_api_call</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cx18_set_filter_param</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">filter_mode</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">spatial_strength</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_FILTER_PARAM</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">spatial_strength</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">filter_mode</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="p">(</span><span class="n">cx</span><span class="o">-&gt;</span><span class="n">temporal_strength</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_FILTER_PARAM</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">temporal_strength</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_FILTER_PARAM</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cx</span><span class="o">-&gt;</span><span class="n">filter_mode</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx18_api_func</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">,</span> <span class="kt">int</span> <span class="n">out</span><span class="p">,</span>
		<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cx18_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">cx</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_OUTPUT_PORT</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_FRAME_RATE</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VIDEO_IN</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_FRAME_SIZE</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VIDEO_RESOLUTION</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_STREAM_TYPE</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_STREAM_OUTPUT_TYPE</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_ASPECT_RATIO</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_ASPECT_RATIO</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_GOP_PROPERTIES</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_GOP_STRUCTURE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_GOP_CLOSURE</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_AUDIO_PROPERTIES</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_AUDIO_PARAMETERS</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_MUTE_AUDIO</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_AUDIO_MUTE</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_BIT_RATE</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VIDEO_RATE</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_MUTE_VIDEO</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_VIDEO_MUTE</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_FRAME_DROP_RATE</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_SKIP_INPUT_FRAME</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_MISC</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_MISC_PARAMETERS</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_DNR_FILTER_MODE</span>:
		<span class="n">cx</span><span class="o">-&gt;</span><span class="n">filter_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">cx18_set_filter_param</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_DNR_FILTER_PROPS</span>:
		<span class="n">cx</span><span class="o">-&gt;</span><span class="n">spatial_strength</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">cx</span><span class="o">-&gt;</span><span class="n">temporal_strength</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">return</span> <span class="n">cx18_set_filter_param</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_SPATIAL_FILTER_TYPE</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_SPATIAL_FILTER_TYPE</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">case</span> <span class="n">CX2341X_ENC_SET_CORING_LEVELS</span>:
		<span class="k">return</span> <span class="n">cx18_vapi</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">CX18_CPU_SET_MEDIAN_CORING</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">CX18_WARN</span><span class="p">(</span><span class="s">&quot;Unknown cmd %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx18_vapi_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">MAX_MB_ARGUMENTS</span><span class="p">],</span>
		<span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">args</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cx18_api</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">cx18_vapi</span><span class="p">(</span><span class="k">struct</span> <span class="n">cx18</span> <span class="o">*</span><span class="n">cx</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">args</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">MAX_MB_ARGUMENTS</span><span class="p">];</span>
	<span class="kt">va_list</span> <span class="n">ap</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cx</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CX18_ERR</span><span class="p">(</span><span class="s">&quot;cx == NULL (cmd=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="o">&gt;</span> <span class="n">MAX_MB_ARGUMENTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">CX18_ERR</span><span class="p">(</span><span class="s">&quot;args too big (cmd=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="n">args</span> <span class="o">=</span> <span class="n">MAX_MB_ARGUMENTS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">ap</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">ap</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">cx18_api</span><span class="p">(</span><span class="n">cx</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
