<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › sta2x11_vip.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sta2x11_vip.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This is the driver for the STA2x11 Video Input Port.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010       WindRiver Systems, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms and conditions of the GNU General Public License,</span>
<span class="cm"> * version 2, as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin St - Fifth Floor, Boston, MA 02110-1301 USA.</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in</span>
<span class="cm"> * the file called &quot;COPYING&quot;.</span>
<span class="cm"> *</span>
<span class="cm"> * Author: Andreas Kies &lt;andreas.kies@windriver.com&gt;</span>
<span class="cm"> *		Vlad Lungu &lt;vlad.lungu@windriver.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &lt;linux/videodev2.h&gt;</span>

<span class="cp">#include &lt;linux/kmod.h&gt;</span>

<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/videobuf-dma-contig.h&gt;</span>

<span class="cp">#include &quot;sta2x11_vip.h&quot;</span>

<span class="cp">#define DRV_NAME &quot;sta2x11_vip&quot;</span>
<span class="cp">#define DRV_VERSION &quot;1.3&quot;</span>

<span class="cp">#ifndef PCI_DEVICE_ID_STMICRO_VIP</span>
<span class="cp">#define PCI_DEVICE_ID_STMICRO_VIP 0xCC0D</span>
<span class="cp">#endif</span>

<span class="cp">#define MAX_FRAMES 4</span>

<span class="cm">/*Register offsets*/</span>
<span class="cp">#define DVP_CTL		0x00</span>
<span class="cp">#define DVP_TFO		0x04</span>
<span class="cp">#define DVP_TFS		0x08</span>
<span class="cp">#define DVP_BFO		0x0C</span>
<span class="cp">#define DVP_BFS		0x10</span>
<span class="cp">#define DVP_VTP         0x14</span>
<span class="cp">#define DVP_VBP         0x18</span>
<span class="cp">#define DVP_VMP		0x1C</span>
<span class="cp">#define DVP_ITM		0x98</span>
<span class="cp">#define DVP_ITS		0x9C</span>
<span class="cp">#define DVP_STA		0xA0</span>
<span class="cp">#define DVP_HLFLN	0xA8</span>
<span class="cp">#define DVP_RGB		0xC0</span>
<span class="cp">#define DVP_PKZ		0xF0</span>

<span class="cm">/*Register fields*/</span>
<span class="cp">#define DVP_CTL_ENA	0x00000001</span>
<span class="cp">#define DVP_CTL_RST	0x80000000</span>
<span class="cp">#define DVP_CTL_DIS	(~0x00040001)</span>

<span class="cp">#define DVP_IT_VSB	0x00000008</span>
<span class="cp">#define DVP_IT_VST	0x00000010</span>
<span class="cp">#define DVP_IT_FIFO	0x00000020</span>

<span class="cp">#define DVP_HLFLN_SD	0x00000001</span>

<span class="cp">#define REG_WRITE(vip, reg, value) iowrite32((value), (vip-&gt;iomem)+(reg))</span>
<span class="cp">#define REG_READ(vip, reg) ioread32((vip-&gt;iomem)+(reg))</span>

<span class="cp">#define SAVE_COUNT 8</span>
<span class="cp">#define AUX_COUNT 3</span>
<span class="cp">#define IRQ_COUNT 1</span>

<span class="cm">/**</span>
<span class="cm"> * struct sta2x11_vip - All internal data for one instance of device</span>
<span class="cm"> * @v4l2_dev: device registered in v4l layer</span>
<span class="cm"> * @video_dev: properties of our device</span>
<span class="cm"> * @pdev: PCI device</span>
<span class="cm"> * @adapter: contains I2C adapter information</span>
<span class="cm"> * @register_save_area: All relevant register are saved here during suspend</span>
<span class="cm"> * @decoder: contains information about video DAC</span>
<span class="cm"> * @format: pixel format, fixed UYVY</span>
<span class="cm"> * @std: video standard (e.g. PAL/NTSC)</span>
<span class="cm"> * @input: input line for video signal ( 0 or 1 )</span>
<span class="cm"> * @users: Number of open of device ( max. 1 )</span>
<span class="cm"> * @disabled: Device is in power down state</span>
<span class="cm"> * @mutex: ensures exclusive opening of device</span>
<span class="cm"> * @slock: for excluse acces of registers</span>
<span class="cm"> * @vb_vidq: queue maintained by videobuf layer</span>
<span class="cm"> * @capture: linked list of capture buffer</span>
<span class="cm"> * @active: struct videobuf_buffer currently beingg filled</span>
<span class="cm"> * @started: device is ready to capture frame</span>
<span class="cm"> * @closing: device will be shut down</span>
<span class="cm"> * @tcount: Number of top frames</span>
<span class="cm"> * @bcount: Number of bottom frames</span>
<span class="cm"> * @overflow: Number of FIFO overflows</span>
<span class="cm"> * @mem_spare: small buffer of unused frame</span>
<span class="cm"> * @dma_spare: dma addres of mem_spare</span>
<span class="cm"> * @iomem: hardware base address</span>
<span class="cm"> * @config: I2C and gpio config from platform</span>
<span class="cm"> *</span>
<span class="cm"> * All non-local data is accessed via this structure.</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">video_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">register_save_area</span><span class="p">[</span><span class="n">IRQ_COUNT</span> <span class="o">+</span> <span class="n">SAVE_COUNT</span> <span class="o">+</span> <span class="n">AUX_COUNT</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">decoder</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">users</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">disabled</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">mutex</span><span class="p">;</span>	<span class="cm">/* exclusive access during open */</span>
	<span class="n">spinlock_t</span> <span class="n">slock</span><span class="p">;</span>	<span class="cm">/* spin lock for hardware and queue access */</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="n">vb_vidq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">capture</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">active</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">started</span><span class="p">,</span> <span class="n">closing</span><span class="p">,</span> <span class="n">tcount</span><span class="p">,</span> <span class="n">bcount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">overflow</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem_spare</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">dma_spare</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">iomem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vip_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">registers_to_save</span><span class="p">[</span><span class="n">AUX_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">DVP_HLFLN</span><span class="p">,</span> <span class="n">DVP_RGB</span><span class="p">,</span> <span class="n">DVP_PKZ</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="n">formats_50</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>			<span class="cm">/*PAL interlaced */</span>
	 <span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">576</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">576</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/*PAL top */</span>
	 <span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">288</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">288</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/*PAL bottom */</span>
	 <span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">288</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">288</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">},</span>

<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="n">formats_60</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>			<span class="cm">/*NTSC interlaced */</span>
	 <span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">480</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">480</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/*NTSC top */</span>
	 <span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">240</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">},</span>
	<span class="p">{</span>			<span class="cm">/*NTSC bottom */</span>
	 <span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">240</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">240</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">},</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * buf_setup - Get size and number of video buffer</span>
<span class="cm"> * @vq: queue in videobuf</span>
<span class="cm"> * @count: Number of buffers (1..MAX_FRAMES).</span>
<span class="cm"> *		0 use default value.</span>
<span class="cm"> * @size:  size of buffer in bytes</span>
<span class="cm"> *</span>
<span class="cm"> * returns size and number of buffers</span>
<span class="cm"> * a preset value of 0 returns the default number.</span>
<span class="cm"> * return value: 0, always succesfull.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">buf_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="o">*</span><span class="n">count</span> <span class="o">||</span> <span class="n">MAX_FRAMES</span> <span class="o">&lt;</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">MAX_FRAMES</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * buf_prepare - prepare buffer for usage</span>
<span class="cm"> * @vq: queue in videobuf layer</span>
<span class="cm"> * @vb: buffer to be prepared</span>
<span class="cm"> * @field: type of video data (interlaced/non-interlaced)</span>
<span class="cm"> *</span>
<span class="cm"> * Allocate or realloc buffer</span>
<span class="cm"> * return value: 0, successful.</span>
<span class="cm"> *</span>
<span class="cm"> * -EINVAL, supplied buffer is too small.</span>
<span class="cm"> *</span>
<span class="cm"> *  other, buffer could not be locked.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">buf_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">bsize</span> <span class="o">&lt;</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">==</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">videobuf_iolock</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="n">videobuf_dma_contig_free</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * buf_queu - queue buffer for filling</span>
<span class="cm"> * @vq: queue in videobuf layer</span>
<span class="cm"> * @vb: buffer to be queued</span>
<span class="cm"> *</span>
<span class="cm"> * if capturing is already running, the buffer will be queued. Otherwise</span>
<span class="cm"> * capture is started and the buffer is used directly.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">buf_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma</span><span class="p">;</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">tcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">bcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">vb</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>

	<span class="n">dma</span> <span class="o">=</span> <span class="n">videobuf_to_dma_contig</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_TFO</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="cm">/* despite of interlace mode, upper and lower frames start at zero */</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_BFO</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_TFS</span><span class="p">,</span>
			  <span class="p">((</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_BFS</span><span class="p">,</span> <span class="p">((</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VTP</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VBP</span><span class="p">,</span> <span class="n">dma</span> <span class="o">+</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VMP</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_TFS</span><span class="p">,</span>
			  <span class="p">((</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_BFS</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VTP</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VBP</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VMP</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_TFS</span><span class="p">,</span> <span class="p">((</span><span class="mi">0</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_BFS</span><span class="p">,</span>
			  <span class="p">((</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			  <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VTP</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VBP</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VMP</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;VIP: unknown field format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">,</span> <span class="n">DVP_CTL_ENA</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * buff_release - release buffer</span>
<span class="cm"> * @vq: queue in videobuf layer</span>
<span class="cm"> * @vb: buffer to be released</span>
<span class="cm"> *</span>
<span class="cm"> * release buffer in videobuf layer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">buf_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">videobuf_dma_contig_free</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">vb</span><span class="p">);</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue_ops</span> <span class="n">vip_qops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buf_setup</span> <span class="o">=</span> <span class="n">buf_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span> <span class="o">=</span> <span class="n">buf_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span> <span class="o">=</span> <span class="n">buf_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_release</span> <span class="o">=</span> <span class="n">buf_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * vip_open - open video device</span>
<span class="cm"> * @file: descriptor of device</span>
<span class="cm"> *</span>
<span class="cm"> * open device, make sure it is only opened once.</span>
<span class="cm"> * return value: 0, no error.</span>
<span class="cm"> *</span>
<span class="cm"> * -EBUSY, device is already opened</span>
<span class="cm"> *</span>
<span class="cm"> * -ENOMEM, no memory for auxiliary DMA buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vip_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">users</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">overflow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">mem_spare</span> <span class="o">=</span> <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span>
					    <span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">dma_spare</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mem_spare</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">--</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">videobuf_queue_dma_contig_init_cached</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">vip_qops</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span>
					      <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">,</span>
					      <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">),</span>
					      <span class="n">vip</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_ITS</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_HLFLN</span><span class="p">,</span> <span class="n">DVP_HLFLN_SD</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_ITM</span><span class="p">,</span> <span class="n">DVP_IT_VSB</span> <span class="o">|</span> <span class="n">DVP_IT_VST</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">,</span> <span class="n">DVP_CTL_RST</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_ITS</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vip_close - close video device</span>
<span class="cm"> * @file: descriptor of device</span>
<span class="cm"> *</span>
<span class="cm"> * close video device, wait until all pending operations are finished</span>
<span class="cm"> * ( maximum FRAME_MAX buffers pending )</span>
<span class="cm"> * Turn off interrupts.</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, always succesful.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vip_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">closing</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span>
		<span class="n">videobuf_waiton</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_ITM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">,</span> <span class="n">DVP_CTL_RST</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_ITS</span><span class="p">);</span>

	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="n">videobuf_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">);</span>
	<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">);</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">mem_spare</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">dma_spare</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vip_read - read from video input</span>
<span class="cm"> * @file: descriptor of device</span>
<span class="cm"> * @data: user buffer</span>
<span class="cm"> * @count: number of bytes to be read</span>
<span class="cm"> * @ppos: position within stream</span>
<span class="cm"> *</span>
<span class="cm"> * read video data from video device.</span>
<span class="cm"> * handling is done in generic videobuf layer</span>
<span class="cm"> * return value: provided by videobuf layer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">vip_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_read_stream</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				    <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vip_mmap - map user buffer</span>
<span class="cm"> * @file: descriptor of device</span>
<span class="cm"> * @vma: user buffer</span>
<span class="cm"> *</span>
<span class="cm"> * map user space buffer into kernel mode, including DMA address.</span>
<span class="cm"> * handling is done in generic videobuf layer.</span>
<span class="cm"> * return value: provided by videobuf layer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vip_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_mmap_mapper</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vip_poll - poll for event</span>
<span class="cm"> * @file: descriptor of device</span>
<span class="cm"> * @wait: contains events to be waited for</span>
<span class="cm"> *</span>
<span class="cm"> * wait for event related to video device.</span>
<span class="cm"> * handling is done in generic videobuf layer.</span>
<span class="cm"> * return value: provided by videobuf layer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">vip_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_poll_stream</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_querycap - return capabilities of device</span>
<span class="cm"> * @file: descriptor of device (not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @cap: contains return values</span>
<span class="cm"> *</span>
<span class="cm"> * the capabilities of the device are returned</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, no error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_capability</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">),</span> <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span>
		 <span class="n">pci_name</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span> <span class="n">V4L2_CAP_READWRITE</span> <span class="o">|</span>
	    <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_s_std - set video standard</span>
<span class="cm"> * @file: descriptor of device (not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @std: contains standard to be set</span>
<span class="cm"> *</span>
<span class="cm"> * the video standard is set</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, no error.</span>
<span class="cm"> *</span>
<span class="cm"> * -EIO, no input signal detected</span>
<span class="cm"> *</span>
<span class="cm"> * other, returned from video DAC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">v4l2_std_id</span> <span class="n">oldstd</span> <span class="o">=</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">,</span> <span class="n">newstd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_ALL</span> <span class="o">==</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="o">*</span><span class="n">std</span><span class="p">);</span>
		<span class="n">ssleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">querystd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newstd</span><span class="p">);</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">g_input_status</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">V4L2_IN_ST_NO_SIGNAL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">newstd</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">oldstd</span> <span class="o">!=</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_525_60</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span><span class="p">))</span>
				<span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats_60</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats_50</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">oldstd</span> <span class="o">!=</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_525_60</span> <span class="o">&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span><span class="p">))</span>
			<span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats_60</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats_50</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="o">*</span><span class="n">std</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_g_std - get video standard</span>
<span class="cm"> * @file: descriptor of device (not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @std: contains return values</span>
<span class="cm"> *</span>
<span class="cm"> * the current video standard is returned</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, no error.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_querystd - get possible video standards</span>
<span class="cm"> * @file: descriptor of device (not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @std: contains return values</span>
<span class="cm"> *</span>
<span class="cm"> * all possible video standards are returned</span>
<span class="cm"> *</span>
<span class="cm"> * return value: delivered by video DAC routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querystd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">querystd</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_queryctl - get possible control settings</span>
<span class="cm"> * @file: descriptor of device (not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @ctrl: contains return values</span>
<span class="cm"> *</span>
<span class="cm"> * return possible values for a control</span>
<span class="cm"> * return value: delivered by video DAC routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">queryctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_g_ctl - get control value</span>
<span class="cm"> * @file: descriptor of device (not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @ctrl: contains return values</span>
<span class="cm"> *</span>
<span class="cm"> * return setting for a control value</span>
<span class="cm"> * return value: delivered by video DAC routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_s_ctl - set control value</span>
<span class="cm"> * @file: descriptor of device (not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @ctrl: contains value to be set</span>
<span class="cm"> *</span>
<span class="cm"> * set value for a specific control</span>
<span class="cm"> * return value: delivered by video DAC routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_enum_input - return name of input line</span>
<span class="cm"> * @file: descriptor of device (not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @inp: contains return values</span>
<span class="cm"> *</span>
<span class="cm"> * the user friendly name of the input line is returned</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, no error.</span>
<span class="cm"> *</span>
<span class="cm"> * -EINVAL, input line number out of range</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">inp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">inp</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_ALL</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">inp</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Camera %u&quot;</span><span class="p">,</span> <span class="n">inp</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_s_input - set input line</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @i: new input line number</span>
<span class="cm"> *</span>
<span class="cm"> * the current active input line is set</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, no error.</span>
<span class="cm"> *</span>
<span class="cm"> * -EINVAL, line number out of range</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_g_input - return input line</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @i: returned input line number</span>
<span class="cm"> *</span>
<span class="cm"> * the current active input line is returned</span>
<span class="cm"> *</span>
<span class="cm"> * return value: always 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_enum_fmt_vid_cap - return video capture format</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @f: returned format information</span>
<span class="cm"> *</span>
<span class="cm"> * returns name and format of video capture</span>
<span class="cm"> * Only UYVY is supported by hardware.</span>
<span class="cm"> *</span>
<span class="cm"> * return value: always 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="s">&quot;4:2:2, packed, UYVY&quot;</span><span class="p">);</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_try_fmt_vid_cap - set video capture format</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @f: new format</span>
<span class="cm"> *</span>
<span class="cm"> * new video format is set which includes width and</span>
<span class="cm"> * field type. width is fixed to 720, no scaling.</span>
<span class="cm"> * Only UYVY is supported by this hardware.</span>
<span class="cm"> * the minimum height is 200, the maximum is 576 (PAL)</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, no error</span>
<span class="cm"> *</span>
<span class="cm"> * -EINVAL, pixel or field format not supported</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">interlace_lim</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_PIX_FMT_UYVY</span> <span class="o">!=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_STD_525_60</span> <span class="o">&amp;</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">)</span>
		<span class="n">interlace_lim</span> <span class="o">=</span> <span class="mi">240</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">interlace_lim</span> <span class="o">=</span> <span class="mi">288</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_ANY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">interlace_lim</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">interlace_lim</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
			<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">interlace_lim</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">interlace_lim</span> <span class="o">&lt;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">interlace_lim</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">200</span> <span class="o">&gt;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_s_fmt_vid_cap - set current video format parameters</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @f: returned format information</span>
<span class="cm"> *</span>
<span class="cm"> * set new capture format</span>
<span class="cm"> * return value: 0, no error</span>
<span class="cm"> *</span>
<span class="cm"> * other, delivered by video DAC routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vidioc_try_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_g_fmt_vid_cap - get current video format parameters</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @f: contains format information</span>
<span class="cm"> *</span>
<span class="cm"> * returns current video format parameters</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, always successful</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_pix_format</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_reqfs - request buffer</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @p: video buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Handling is done in generic videobuf layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_reqbufs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_querybuf - query buffer</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @p: video buffer</span>
<span class="cm"> *</span>
<span class="cm"> * query buffer state.</span>
<span class="cm"> * Handling is done in generic videobuf layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_querybuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_qbuf - queue a buffer</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @p: video buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Handling is done in generic videobuf layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_qbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_dqbuf - dequeue a buffer</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @p: video buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Handling is done in generic videobuf layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_streamon - turn on streaming</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @type: type of capture</span>
<span class="cm"> *</span>
<span class="cm"> * turn on streaming.</span>
<span class="cm"> * Handling is done in generic videobuf layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_streamon</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vidioc_streamoff - turn off streaming</span>
<span class="cm"> * @file: descriptor of device ( not used)</span>
<span class="cm"> * @priv: points to current videodevice</span>
<span class="cm"> * @type: type of capture</span>
<span class="cm"> *</span>
<span class="cm"> * turn off streaming.</span>
<span class="cm"> * Handling is done in generic videobuf layer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">vb_vidq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">vip_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">vip_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">vip_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">vip_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span> <span class="o">=</span> <span class="n">vip_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span> <span class="o">=</span> <span class="n">vip_poll</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">vip_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span> <span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span> <span class="o">=</span> <span class="n">vidioc_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_std</span> <span class="o">=</span> <span class="n">vidioc_g_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querystd</span> <span class="o">=</span> <span class="n">vidioc_querystd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span> <span class="o">=</span> <span class="n">vidioc_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span> <span class="o">=</span> <span class="n">vidioc_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span> <span class="o">=</span> <span class="n">vidioc_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span> <span class="o">=</span> <span class="n">vidioc_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span> <span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span> <span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span> <span class="o">=</span> <span class="n">vidioc_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span> <span class="o">=</span> <span class="n">vidioc_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span> <span class="o">=</span> <span class="n">vidioc_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span> <span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span> <span class="o">=</span> <span class="n">vidioc_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span> <span class="o">=</span> <span class="n">vidioc_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span> <span class="o">=</span> <span class="n">vidioc_streamoff</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">video_dev_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vip_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">vip_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span> <span class="o">=</span> <span class="n">V4L2_STD_ALL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * vip_irq - interrupt routine</span>
<span class="cm"> * @irq: Number of interrupt ( not used, correct number is assumed )</span>
<span class="cm"> * @vip: local data structure containing all information</span>
<span class="cm"> *</span>
<span class="cm"> * check for both frame interrupts set ( top and bottom ).</span>
<span class="cm"> * check FIFO overflow, but limit number of log messages after open.</span>
<span class="cm"> * signal a complete buffer if done.</span>
<span class="cm"> * dequeue a new buffer if available.</span>
<span class="cm"> * disable VIP if no buffer available.</span>
<span class="cm"> *</span>
<span class="cm"> * return value: IRQ_NONE, interrupt was not generated by VIP</span>
<span class="cm"> *</span>
<span class="cm"> * IRQ_HANDLED, interrupt done.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">vip_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">,</span> <span class="n">dma</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_ITS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;VIP: irq ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">started</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DVP_IT_VSB</span><span class="p">)</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">bcount</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DVP_IT_VST</span><span class="p">)</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">DVP_IT_VSB</span> <span class="o">|</span> <span class="n">DVP_IT_VST</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DVP_IT_VST</span> <span class="o">|</span> <span class="n">DVP_IT_VSB</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* this is bad, we are too slow, hope the condition is gone</span>
<span class="cm">		 * on the next frame */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;VIP: both irqs</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DVP_IT_FIFO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&gt;</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">overflow</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;VIP: fifo overflow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">tcount</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DVP_IT_VSB</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DVP_CTL_ENA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">ts</span><span class="p">);</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">field_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_DONE</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">);</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">closing</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">vb</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">,</span>
				      <span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">vb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;VIP: no buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">vb</span><span class="p">;</span>
		<span class="n">dma</span> <span class="o">=</span> <span class="n">videobuf_to_dma_contig</span><span class="p">(</span><span class="n">vb</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VTP</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VBP</span><span class="p">,</span> <span class="n">dma</span> <span class="o">+</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
		<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VTP</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
			<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_VBP</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;VIP: unknown field format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">,</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">)</span> <span class="o">|</span> <span class="n">DVP_CTL_ENA</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vip_gpio_reserve - reserve gpio pin</span>
<span class="cm"> * @dev: device</span>
<span class="cm"> * @pin: GPIO pin number</span>
<span class="cm"> * @dir: direction, input or output</span>
<span class="cm"> * @name: GPIO pin name</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vip_gpio_reserve</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dir</span><span class="p">,</span>
			    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to allocate pin %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="n">dir</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to set direction for pin %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pin</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pin</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_export</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to export pin %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pin</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * vip_gpio_release - release gpio pin</span>
<span class="cm"> * @dev: device</span>
<span class="cm"> * @pin: GPIO pin number</span>
<span class="cm"> * @name: GPIO pin name</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">vip_gpio_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pin</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pin</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;releasing pin %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>	<span class="n">pin</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">gpio_unexport</span><span class="p">(</span><span class="n">pin</span><span class="p">);</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">pin</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sta2x11_vip_init_one - init one instance of video device</span>
<span class="cm"> * @pdev: PCI device</span>
<span class="cm"> * @ent: (not used)</span>
<span class="cm"> *</span>
<span class="cm"> * allocate reset pins for DAC.</span>
<span class="cm"> * Reset video DAC, this is done via reset line.</span>
<span class="cm"> * allocate memory for managing device</span>
<span class="cm"> * request interrupt</span>
<span class="cm"> * map IO region</span>
<span class="cm"> * register device</span>
<span class="cm"> * find and initialize video DAC</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, no error</span>
<span class="cm"> *</span>
<span class="cm"> * -ENOMEM, no memory</span>
<span class="cm"> *</span>
<span class="cm"> * -ENODEV, device could not be detected or registered</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">sta2x11_vip_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
					  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">vip_config</span> <span class="o">*</span><span class="n">config</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">dev_get_platdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VIP slot disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">disable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vip_gpio_reserve</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">disable</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_pin</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">vip_gpio_reserve</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">vip_gpio_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_pin</span><span class="p">,</span>
					 <span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">disable</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_pin</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Datasheet says 5ms between PWR and RST */</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">25000</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_pin</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Datasheet says 5ms between PWR and RST */</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">25000</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">25000</span><span class="p">);</span>

	<span class="n">vip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sta2x11_vip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_gpios</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">formats_50</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">free_mem</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BAR #0 at 0x%lx 0x%lx irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unreg</span><span class="p">;</span>

	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">iomem</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span> <span class="cm">/* FIXME */</span>
		<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">capture</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">started</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
			  <span class="p">(</span><span class="n">irq_handler_t</span><span class="p">)</span> <span class="n">vip_irq</span><span class="p">,</span>
			  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">vip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;request_irq failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">unmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">release_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">)</span> <span class="o">=</span> <span class="n">video_dev_template</span><span class="p">;</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">vip</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">vrelease</span><span class="p">;</span>

	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">i2c_get_adapter</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">i2c_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no I2C adapter found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">vunreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
					   <span class="s">&quot;adv7180&quot;</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">i2c_addr</span><span class="p">,</span>
					   <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no decoder found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">vunreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i2c_put_adapter</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">);</span>

	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">decoder</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">init</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;STA2X11 Video Input Port (VIP) loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">vunreg:</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">vrelease:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">))</span>
		<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">video_device_release</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
<span class="nl">release_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">vip</span><span class="p">);</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">unmap:</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="nl">release:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">unreg:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="nl">free_mem:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">vip</span><span class="p">);</span>
<span class="nl">release_gpios:</span>
	<span class="n">vip_gpio_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_name</span><span class="p">);</span>
	<span class="n">vip_gpio_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_pin</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_name</span><span class="p">);</span>
<span class="nl">disable:</span>
	<span class="cm">/*</span>
<span class="cm">	 * do not call pci_disable_device on sta2x11 because it break all</span>
<span class="cm">	 * other Bus masters on this EP</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sta2x11_vip_remove_one - release device</span>
<span class="cm"> * @pdev: PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * Undo everything done in .._init_one</span>
<span class="cm"> *</span>
<span class="cm"> * unregister video device</span>
<span class="cm"> * free interrupt</span>
<span class="cm"> * unmap ioadresses</span>
<span class="cm"> * free memory</span>
<span class="cm"> * free GPIO pins</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">sta2x11_vip_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta2x11_vip</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
	<span class="cm">/*do not call video_device_release() here, is already done */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">vip</span><span class="p">);</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">iomem</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">vip_gpio_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_pin</span><span class="p">,</span>
			 <span class="n">vip</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">pwr_name</span><span class="p">);</span>
	<span class="n">vip_gpio_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_pin</span><span class="p">,</span>
			 <span class="n">vip</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">reset_name</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vip</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * do not call pci_disable_device on sta2x11 because it break all</span>
<span class="cm">	 * other Bus masters on this EP</span>
<span class="cm">	 */</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/**</span>
<span class="cm"> * sta2x11_vip_suspend - set device into power save mode</span>
<span class="cm"> * @pdev: PCI device</span>
<span class="cm"> * @state: new state of device</span>
<span class="cm"> *</span>
<span class="cm"> * all relevant registers are saved and an attempt to set a new state is made.</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0 always indicate success,</span>
<span class="cm"> * even if device could not be disabled. (workaround for hardware problem)</span>
<span class="cm"> *</span>
<span class="cm"> * reurn value : 0, always succesful, even if hardware does not not support</span>
<span class="cm"> * power down mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sta2x11_vip_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta2x11_vip</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">register_save_area</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">register_save_area</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">DVP_CTL_DIS</span><span class="p">);</span>
	<span class="n">vip</span><span class="o">-&gt;</span><span class="n">register_save_area</span><span class="p">[</span><span class="n">SAVE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_ITM</span><span class="p">);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_ITM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SAVE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">register_save_area</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AUX_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">register_save_area</span><span class="p">[</span><span class="n">SAVE_COUNT</span> <span class="o">+</span> <span class="n">IRQ_COUNT</span> <span class="o">+</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">REG_READ</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">registers_to_save</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* save pci state */</span>
	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * do not call pci_disable_device on sta2x11 because it</span>
<span class="cm">		 * break all other Bus masters on this EP</span>
<span class="cm">		 */</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;VIP: suspend</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * sta2x11_vip_resume - resume device operation</span>
<span class="cm"> * @pdev : PCI device</span>
<span class="cm"> *</span>
<span class="cm"> * re-enable device, set PCI state to powered and restore registers.</span>
<span class="cm"> * resume normal device operation afterwards.</span>
<span class="cm"> *</span>
<span class="cm"> * return value: 0, no error.</span>
<span class="cm"> *</span>
<span class="cm"> * other, could not set device to power on state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">sta2x11_vip_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sta2x11_vip</span> <span class="o">*</span><span class="n">vip</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sta2x11_vip</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;VIP: resume</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* restore pci state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;VIP: Can&#39;t enable device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * do not call pci_disable_device on sta2x11 because it</span>
<span class="cm">		 * break all other Bus masters on this EP</span>
<span class="cm">		 */</span>
		<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;VIP: Can&#39;t enable device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">vip</span><span class="o">-&gt;</span><span class="n">disabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SAVE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">register_save_area</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">AUX_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">registers_to_save</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			  <span class="n">vip</span><span class="o">-&gt;</span><span class="n">register_save_area</span><span class="p">[</span><span class="n">SAVE_COUNT</span> <span class="o">+</span> <span class="n">IRQ_COUNT</span> <span class="o">+</span> <span class="n">i</span><span class="p">]);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_CTL</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">register_save_area</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">REG_WRITE</span><span class="p">(</span><span class="n">vip</span><span class="p">,</span> <span class="n">DVP_ITM</span><span class="p">,</span> <span class="n">vip</span><span class="o">-&gt;</span><span class="n">register_save_area</span><span class="p">[</span><span class="n">SAVE_COUNT</span><span class="p">]);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vip</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">sta2x11_vip_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_DEVICE</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_STMICRO</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_STMICRO_VIP</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">sta2x11_vip_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">sta2x11_vip_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">sta2x11_vip_remove_one</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">sta2x11_vip_pci_tbl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">sta2x11_vip_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">sta2x11_vip_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sta2x11_vip_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta2x11_vip_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sta2x11_vip_exit_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta2x11_vip_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef MODULE</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">sta2x11_vip_init_module</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sta2x11_vip_exit_module</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">late_initcall_sync</span><span class="p">(</span><span class="n">sta2x11_vip_init_module</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;STA2X11 Video Input Port driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Wind River&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;sta2x11 video input&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">sta2x11_vip_pci_tbl</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
