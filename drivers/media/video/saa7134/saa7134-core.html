<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › saa7134 › saa7134-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>saa7134-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * device driver for philips saa7134 based TV cards</span>
<span class="cm"> * driver core</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2001-03 Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/sound.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>

<span class="cp">#include &quot;saa7134-reg.h&quot;</span>
<span class="cp">#include &quot;saa7134.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;v4l2 driver module for saa7130/34 based TV cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">SAA7134_VERSION</span><span class="p">);</span>


<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">irq_debug</span><span class="p">,</span><span class="s">&quot;enable debug messages [IRQ handler]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">core_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span><span class="s">&quot;enable debug messages [core]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio_tracking</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">gpio_tracking</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gpio_tracking</span><span class="p">,</span><span class="s">&quot;enable debug messages [gpio]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">alsa</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">alsa</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">alsa</span><span class="p">,</span><span class="s">&quot;enable/disable ALSA DMA sound [dmasound]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">latency</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">latency</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">latency</span><span class="p">,</span><span class="s">&quot;pci latency timer&quot;</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">saa7134_no_overlay</span><span class="o">=-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">no_overlay</span><span class="p">,</span> <span class="n">saa7134_no_overlay</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">no_overlay</span><span class="p">,</span><span class="s">&quot;allow override overlay default (0 disables, 1 enables)&quot;</span>
		<span class="s">&quot; [some VIA/SIS chipsets are known to have problem with overlay]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">video_nr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SAA7134_MAXBOARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">UNSET</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vbi_nr</span><span class="p">[]</span>   <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SAA7134_MAXBOARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">UNSET</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">radio_nr</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SAA7134_MAXBOARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">UNSET</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tuner</span><span class="p">[]</span>    <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SAA7134_MAXBOARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">UNSET</span> <span class="p">};</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">card</span><span class="p">[]</span>     <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SAA7134_MAXBOARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">UNSET</span> <span class="p">};</span>


<span class="n">module_param_array</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">vbi_nr</span><span class="p">,</span>   <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">tuner</span><span class="p">,</span>    <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>     <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="s">&quot;video device number&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vbi_nr</span><span class="p">,</span>   <span class="s">&quot;vbi device number&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="s">&quot;radio device number&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">tuner</span><span class="p">,</span>    <span class="s">&quot;tuner type&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>     <span class="s">&quot;card type&quot;</span><span class="p">);</span>

<span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">saa7134_devlist</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_devlist</span><span class="p">);</span>
<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">mops_list</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">saa7134_devcount</span><span class="p">;</span>

<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">saa7134_dmasound_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">saa7134_dmasound_exit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#define dprintk(fmt, arg...)	if (core_debug) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s/core: &quot; fmt, dev-&gt;name , ## arg)</span>

<span class="kt">void</span> <span class="nf">saa7134_track_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mode</span><span class="p">,</span><span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_tracking</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* rising SAA7134_GPIO_GPRESCAN reads the status */</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span><span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span><span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">,</span><span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>
	<span class="n">mode</span>   <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE0</span>   <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffff</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfffffff</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
	       <span class="s">&quot;%s: gpio: mode=0x%07lx in=0x%07lx out=0x%07lx [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="p">(</span><span class="o">~</span><span class="n">mode</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">,</span> <span class="n">mode</span> <span class="o">&amp;</span> <span class="n">status</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_set_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit_no</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">,</span> <span class="n">bitval</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bit_no</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* static value */</span>
	<span class="k">case</span> <span class="mi">1</span>:	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting GPIO%d to static %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bit_no</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="cm">/* turn sync mode off if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mh">0x00c00000</span><span class="p">)</span>
			<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL6</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
			<span class="n">bitval</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">bitval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">saa_andorl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="n">saa_andorl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">bitval</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:	<span class="cm">/* tristate */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setting GPIO%d to tristate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bit_no</span><span class="p">);</span>
		<span class="n">saa_andorl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>


<span class="cm">/* ----------------------------------------------------------- */</span>
<span class="cm">/* delayed request_module                                      */</span>

<span class="cp">#if defined(CONFIG_MODULES) &amp;&amp; defined(MODULE)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">request_module_async</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">){</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span><span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_dev</span><span class="p">,</span> <span class="n">request_module_wk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_is_empress</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;saa7134-empress&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_is_dvb</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;saa7134-dvb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alsa</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7130</span><span class="p">)</span>
			<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;saa7134-alsa&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">request_submodules</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_module_wk</span><span class="p">,</span> <span class="n">request_module_async</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_module_wk</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">flush_request_submodules</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">request_module_wk</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define request_submodules(dev)</span>
<span class="cp">#define flush_request_submodules(dev)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_MODULES */</span><span class="cp"></span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="cm">/* nr of (saa7134-)pages for the given buffer size */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">saa7134_buffer_pages</span><span class="p">(</span><span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">size</span>  <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">size</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span> <span class="cm">/* for non-page-aligned buffers */</span>
	<span class="n">size</span> <span class="o">/=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* calc max # of buffers from size (must not exceed the 4MB virtual</span>
<span class="cm"> * address space per DMA channel) */</span>
<span class="kt">int</span> <span class="n">saa7134_buffer_count</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxcount</span><span class="p">;</span>

	<span class="n">maxcount</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">/</span> <span class="n">saa7134_buffer_pages</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">maxcount</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">maxcount</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">saa7134_buffer_startpage</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">saa7134_buffer_pages</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">bsize</span><span class="p">)</span> <span class="o">*</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">saa7134_buffer_base</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_dmabuf</span> <span class="o">*</span><span class="n">dma</span><span class="o">=</span><span class="n">videobuf_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>

	<span class="n">base</span>  <span class="o">=</span> <span class="n">saa7134_buffer_startpage</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">+=</span> <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">base</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="kt">int</span> <span class="n">saa7134_pgtable_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_pgtable</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span>       <span class="o">*</span><span class="n">cpu</span><span class="p">;</span>
	<span class="n">dma_addr_t</span>   <span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cpu</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">SAA7134_PGTABLE_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dma_addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">cpu</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">SAA7134_PGTABLE_SIZE</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">cpu</span>  <span class="o">=</span> <span class="n">cpu</span><span class="p">;</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">dma</span>  <span class="o">=</span> <span class="n">dma_addr</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">saa7134_pgtable_build</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_pgtable</span> <span class="o">*</span><span class="n">pt</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">scatterlist</span> <span class="o">*</span><span class="n">list</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">startpage</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span>        <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pt</span> <span class="o">||</span> <span class="nb">NULL</span> <span class="o">==</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">+</span> <span class="n">startpage</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">list</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">*</span> <span class="mi">4096</span> <span class="o">&lt;</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">ptr</span><span class="o">++</span><span class="p">)</span>
			<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">sg_dma_address</span><span class="p">(</span><span class="n">list</span><span class="p">)</span> <span class="o">-</span> <span class="n">list</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">saa7134_pgtable_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_pgtable</span> <span class="o">*</span><span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">pt</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">pt</span><span class="o">-&gt;</span><span class="n">cpu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="kt">void</span> <span class="n">saa7134_dma_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span><span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">videobuf_dmabuf</span> <span class="o">*</span><span class="n">dma</span><span class="o">=</span><span class="n">videobuf_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">in_interrupt</span><span class="p">());</span>

	<span class="n">videobuf_waiton</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">videobuf_dma_unmap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma</span><span class="p">);</span>
	<span class="n">videobuf_dma_free</span><span class="p">(</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_NEEDS_INIT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="kt">int</span> <span class="n">saa7134_buffer_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">saa7134_dmaqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer_queue %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">need_two</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="k">struct</span> <span class="n">saa7134_buf</span><span class="p">,</span>
					  <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">next</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">,</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_QUEUED</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">saa7134_buffer_finish</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">saa7134_dmaqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer_finish %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">);</span>

	<span class="cm">/* finish current buffer */</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">ts</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">done</span><span class="p">);</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">saa7134_buffer_next</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">saa7134_dmaqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span><span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* activate next one from queue */</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="k">struct</span> <span class="n">saa7134_buf</span><span class="p">,</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer_next %p [prev=%p/next=%p]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">buf</span><span class="p">,</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
			<span class="n">next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span><span class="k">struct</span> <span class="n">saa7134_buf</span><span class="p">,</span>
					  <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
		<span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">buf</span><span class="p">,</span><span class="n">next</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer_next #2 prev=%p/next=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">prev</span><span class="p">,</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* nothing to do -- just stop DMA */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer_next %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="nb">NULL</span><span class="p">);</span>
		<span class="n">saa7134_set_dmabits</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card_has_mpeg</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts_started</span><span class="p">)</span>
				<span class="n">saa7134_ts_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="n">saa7134_buffer_timeout</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dmaqueue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dmaqueue</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* try to reset the hardware (SWRST) */</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_REGION_ENABLE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_REGION_ENABLE</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_REGION_ENABLE</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* flag current buffer as failed,</span>
<span class="cm">	   try to start over with the next one. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;timeout on %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">);</span>
		<span class="n">saa7134_buffer_finish</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">q</span><span class="p">,</span><span class="n">VIDEOBUF_ERROR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">saa7134_buffer_next</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">q</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="kt">int</span> <span class="n">saa7134_set_dmabits</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">split</span><span class="p">,</span> <span class="n">task</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">irq</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">cap</span> <span class="o">=</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">ov</span>  <span class="o">=</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">;</span>

	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">insuspend</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* video capture -- dma 0 + video task A */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SAA7134_MAIN_CTRL_TE0</span><span class="p">;</span>
		<span class="n">irq</span>  <span class="o">|=</span> <span class="n">SAA7134_IRQ1_INTE_RA0_1</span> <span class="o">|</span>
			<span class="n">SAA7134_IRQ1_INTE_RA0_0</span><span class="p">;</span>
		<span class="n">cap</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* video capture -- dma 1+2 (planar modes) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">planar</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SAA7134_MAIN_CTRL_TE4</span> <span class="o">|</span>
			<span class="n">SAA7134_MAIN_CTRL_TE5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* screen overlay -- dma 0 + video task B */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovenable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SAA7134_MAIN_CTRL_TE1</span><span class="p">;</span>
		<span class="n">ov</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfield</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* vbi capture -- dma 0 + vbi task A+B */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_q</span><span class="p">.</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">task</span> <span class="o">|=</span> <span class="mh">0x22</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SAA7134_MAIN_CTRL_TE2</span> <span class="o">|</span>
			<span class="n">SAA7134_MAIN_CTRL_TE3</span><span class="p">;</span>
		<span class="n">irq</span>  <span class="o">|=</span> <span class="n">SAA7134_IRQ1_INTE_RA0_7</span> <span class="o">|</span>
			<span class="n">SAA7134_IRQ1_INTE_RA0_6</span> <span class="o">|</span>
			<span class="n">SAA7134_IRQ1_INTE_RA0_5</span> <span class="o">|</span>
			<span class="n">SAA7134_IRQ1_INTE_RA0_4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* audio capture -- dma 3 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_running</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SAA7134_MAIN_CTRL_TE6</span><span class="p">;</span>
		<span class="n">irq</span>  <span class="o">|=</span> <span class="n">SAA7134_IRQ1_INTE_RA3_1</span> <span class="o">|</span>
			<span class="n">SAA7134_IRQ1_INTE_RA3_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TS capture -- dma 5 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts_q</span><span class="p">.</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">|=</span> <span class="n">SAA7134_MAIN_CTRL_TE5</span><span class="p">;</span>
		<span class="n">irq</span>  <span class="o">|=</span> <span class="n">SAA7134_IRQ1_INTE_RA2_1</span> <span class="o">|</span>
			<span class="n">SAA7134_IRQ1_INTE_RA2_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set task conditions + field handling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">cap</span><span class="p">)</span> <span class="o">||</span> <span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">ov</span><span class="p">)</span> <span class="o">||</span> <span class="n">cap</span> <span class="o">==</span> <span class="n">ov</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* default config -- use full frames */</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_TASK_CONDITIONS</span><span class="p">(</span><span class="n">TASK_A</span><span class="p">),</span> <span class="mh">0x0d</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_TASK_CONDITIONS</span><span class="p">(</span><span class="n">TASK_B</span><span class="p">),</span> <span class="mh">0x0d</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FIELD_HANDLING</span><span class="p">(</span><span class="n">TASK_A</span><span class="p">),</span>  <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FIELD_HANDLING</span><span class="p">(</span><span class="n">TASK_B</span><span class="p">),</span>  <span class="mh">0x02</span><span class="p">);</span>
		<span class="n">split</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* split fields between tasks */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_TOP</span> <span class="o">==</span> <span class="n">cap</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* odd A, even B, repeat */</span>
			<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_TASK_CONDITIONS</span><span class="p">(</span><span class="n">TASK_A</span><span class="p">),</span> <span class="mh">0x0d</span><span class="p">);</span>
			<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_TASK_CONDITIONS</span><span class="p">(</span><span class="n">TASK_B</span><span class="p">),</span> <span class="mh">0x0e</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* odd B, even A, repeat */</span>
			<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_TASK_CONDITIONS</span><span class="p">(</span><span class="n">TASK_A</span><span class="p">),</span> <span class="mh">0x0e</span><span class="p">);</span>
			<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_TASK_CONDITIONS</span><span class="p">(</span><span class="n">TASK_B</span><span class="p">),</span> <span class="mh">0x0d</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FIELD_HANDLING</span><span class="p">(</span><span class="n">TASK_A</span><span class="p">),</span>  <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FIELD_HANDLING</span><span class="p">(</span><span class="n">TASK_B</span><span class="p">),</span>  <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">split</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* irqs */</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_REGION_ENABLE</span><span class="p">,</span> <span class="n">task</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ1</span><span class="p">,</span>          <span class="n">irq</span><span class="p">);</span>
	<span class="n">saa_andorl</span><span class="p">(</span><span class="n">SAA7134_MAIN_CTRL</span><span class="p">,</span>
		   <span class="n">SAA7134_MAIN_CTRL_TE0</span> <span class="o">|</span>
		   <span class="n">SAA7134_MAIN_CTRL_TE1</span> <span class="o">|</span>
		   <span class="n">SAA7134_MAIN_CTRL_TE2</span> <span class="o">|</span>
		   <span class="n">SAA7134_MAIN_CTRL_TE3</span> <span class="o">|</span>
		   <span class="n">SAA7134_MAIN_CTRL_TE4</span> <span class="o">|</span>
		   <span class="n">SAA7134_MAIN_CTRL_TE5</span> <span class="o">|</span>
		   <span class="n">SAA7134_MAIN_CTRL_TE6</span><span class="p">,</span>
		   <span class="n">ctrl</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;dmabits: task=0x%02x ctrl=0x%02x irq=0x%x split=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">task</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">split</span> <span class="o">?</span> <span class="s">&quot;no&quot;</span> <span class="o">:</span> <span class="s">&quot;yes&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* IRQ handler + helpers                                              */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">irqbits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;DONE_RA0&quot;</span><span class="p">,</span> <span class="s">&quot;DONE_RA1&quot;</span><span class="p">,</span> <span class="s">&quot;DONE_RA2&quot;</span><span class="p">,</span> <span class="s">&quot;DONE_RA3&quot;</span><span class="p">,</span>
	<span class="s">&quot;AR&quot;</span><span class="p">,</span> <span class="s">&quot;PE&quot;</span><span class="p">,</span> <span class="s">&quot;PWR_ON&quot;</span><span class="p">,</span> <span class="s">&quot;RDCAP&quot;</span><span class="p">,</span> <span class="s">&quot;INTL&quot;</span><span class="p">,</span> <span class="s">&quot;FIDT&quot;</span><span class="p">,</span> <span class="s">&quot;MMC&quot;</span><span class="p">,</span>
	<span class="s">&quot;TRIG_ERR&quot;</span><span class="p">,</span> <span class="s">&quot;CONF_ERR&quot;</span><span class="p">,</span> <span class="s">&quot;LOAD_ERR&quot;</span><span class="p">,</span>
	<span class="s">&quot;GPIO16&quot;</span><span class="p">,</span> <span class="s">&quot;GPIO18&quot;</span><span class="p">,</span> <span class="s">&quot;GPIO22&quot;</span><span class="p">,</span> <span class="s">&quot;GPIO23&quot;</span>
<span class="p">};</span>
<span class="cp">#define IRQBITS ARRAY_SIZE(irqbits)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">print_irqstatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">loop</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">report</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s/irq[%d,%ld]: r=0x%lx s=0x%02lx&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">loop</span><span class="p">,</span><span class="n">jiffies</span><span class="p">,</span><span class="n">report</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IRQBITS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">report</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span><span class="n">irqbits</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_DONE_RA0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; | RA0=%s,%s,%s,%ld&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;vbi&quot;</span>  <span class="o">:</span> <span class="s">&quot;video&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;b&quot;</span>    <span class="o">:</span> <span class="s">&quot;a&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;odd&quot;</span>  <span class="o">:</span> <span class="s">&quot;even&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">saa7134_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span><span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">report</span><span class="p">,</span><span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">insuspend</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">report</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_IRQ_REPORT</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_IRQ_STATUS</span><span class="p">);</span>

		<span class="cm">/* If dmasound support is active and we get a sound report,</span>
<span class="cm">		 * mask out the report and let the saa7134-alsa module deal</span>
<span class="cm">		 * with it */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_DONE_RA3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">priv_data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">)</span>
		<span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s/irq: preserving DMA sound interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">report</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SAA7134_IRQ_REPORT_DONE_RA3</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">report</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s/irq: no (more) work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ_REPORT</span><span class="p">,</span><span class="n">report</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_debug</span><span class="p">)</span>
			<span class="n">print_irqstatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">loop</span><span class="p">,</span><span class="n">report</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>


		<span class="k">if</span> <span class="p">((</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_RDCAP</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_INTL</span><span class="p">))</span>
				<span class="n">saa7134_irq_video_signalchange</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


		<span class="k">if</span> <span class="p">((</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_DONE_RA0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x60</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">saa7134_irq_video_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_DONE_RA0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span>
			<span class="n">saa7134_irq_vbi_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_DONE_RA2</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">card_has_mpeg</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">saa7134_irq_ts_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_GPIO16</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_remote</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">SAA7134_REMOTE_GPIO</span>:
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">if</span>  <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">mask_keydown</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">saa7134_input_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">SAA7134_REMOTE_I2C</span>:
					<span class="k">break</span><span class="p">;</span>			<span class="cm">/* FIXME: invoke I2C get_key() */</span>

				<span class="nl">default:</span>			<span class="cm">/* GPIO16 not used by IR remote */</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_GPIO18</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_remote</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">SAA7134_REMOTE_GPIO</span>:
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">mask_keydown</span> <span class="o">&amp;</span> <span class="mh">0x40000</span><span class="p">)</span> <span class="o">||</span>
					    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">&amp;</span> <span class="mh">0x40000</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">saa7134_input_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="k">case</span> <span class="n">SAA7134_REMOTE_I2C</span>:
					<span class="k">break</span><span class="p">;</span>			<span class="cm">/* FIXME: invoke I2C get_key() */</span>

				<span class="nl">default:</span>			<span class="cm">/* GPIO18 not used by IR remote */</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">10</span> <span class="o">==</span> <span class="n">loop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">print_irqstatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">loop</span><span class="p">,</span><span class="n">report</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_PE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* disable all parity error */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s/irq: looping -- &quot;</span>
			       <span class="s">&quot;clearing PE (parity error!) enable bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">saa_clearl</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span><span class="n">SAA7134_IRQ2_INTE_PE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_GPIO16</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* disable gpio16 IRQ */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s/irq: looping -- &quot;</span>
			       <span class="s">&quot;clearing GPIO16 enable bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">saa_clearl</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span> <span class="n">SAA7134_IRQ2_INTE_GPIO16_P</span><span class="p">);</span>
			<span class="n">saa_clearl</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span> <span class="n">SAA7134_IRQ2_INTE_GPIO16_N</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_GPIO18</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* disable gpio18 IRQs */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s/irq: looping -- &quot;</span>
			       <span class="s">&quot;clearing GPIO18 enable bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">saa_clearl</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span> <span class="n">SAA7134_IRQ2_INTE_GPIO18_P</span><span class="p">);</span>
			<span class="n">saa_clearl</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span> <span class="n">SAA7134_IRQ2_INTE_GPIO18_N</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* disable all irqs */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s/irq: looping -- &quot;</span>
			       <span class="s">&quot;clearing all enable bits</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="cm">/* early init (no i2c, no irq) */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_hw_enable1</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* RAM FIFO config */</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_FIFO_SIZE</span><span class="p">,</span> <span class="mh">0x08070503</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_THRESHOULD</span><span class="p">,</span> <span class="mh">0x02020202</span><span class="p">);</span>

	<span class="cm">/* enable audio + video processing */</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_MAIN_CTRL</span><span class="p">,</span>
			<span class="n">SAA7134_MAIN_CTRL_VPLLE</span> <span class="o">|</span>
			<span class="n">SAA7134_MAIN_CTRL_APLLE</span> <span class="o">|</span>
			<span class="n">SAA7134_MAIN_CTRL_EXOSC</span> <span class="o">|</span>
			<span class="n">SAA7134_MAIN_CTRL_EVFE1</span> <span class="o">|</span>
			<span class="n">SAA7134_MAIN_CTRL_EVFE2</span> <span class="o">|</span>
			<span class="n">SAA7134_MAIN_CTRL_ESFE</span>  <span class="o">|</span>
			<span class="n">SAA7134_MAIN_CTRL_EBDAC</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	* Initialize OSS _after_ enabling audio clock PLL and audio processing.</span>
<span class="cm">	* OSS initialization writes to registers via the audio DSP; these</span>
<span class="cm">	* writes will fail unless the audio clock has been started.  At worst,</span>
<span class="cm">	* audio will not work.</span>
<span class="cm">	*/</span>

	<span class="cm">/* enable peripheral devices */</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_SPECIAL_MODE</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="cm">/* set vertical line numbering start (vbi needs this) */</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_SOURCE_TIMING2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_hwinit1</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;hwinit1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Clear any stale IRQ reports */</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ_REPORT</span><span class="p">,</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_IRQ_REPORT</span><span class="p">));</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="n">saa7134_track_gpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="s">&quot;pre-init&quot;</span><span class="p">);</span>
	<span class="n">saa7134_video_init1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_vbi_init1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_has_mpeg</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">saa7134_ts_init1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_input_init1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">saa7134_hw_enable1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* late init (with i2c + irq) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_hw_enable2</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq2_mask</span><span class="p">;</span>

	<span class="cm">/* enable IRQ&#39;s */</span>
	<span class="n">irq2_mask</span> <span class="o">=</span>
		<span class="n">SAA7134_IRQ2_INTE_DEC3</span>    <span class="o">|</span>
		<span class="n">SAA7134_IRQ2_INTE_DEC2</span>    <span class="o">|</span>
		<span class="n">SAA7134_IRQ2_INTE_DEC1</span>    <span class="o">|</span>
		<span class="n">SAA7134_IRQ2_INTE_DEC0</span>    <span class="o">|</span>
		<span class="n">SAA7134_IRQ2_INTE_PE</span>      <span class="o">|</span>
		<span class="n">SAA7134_IRQ2_INTE_AR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_remote</span> <span class="o">==</span> <span class="n">SAA7134_REMOTE_GPIO</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">mask_keydown</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span>
			<span class="n">irq2_mask</span> <span class="o">|=</span> <span class="n">SAA7134_IRQ2_INTE_GPIO16_N</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>		<span class="cm">/* Allow enabling both IRQ edge triggers */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">mask_keydown</span> <span class="o">&amp;</span> <span class="mh">0x40000</span><span class="p">)</span>
				<span class="n">irq2_mask</span> <span class="o">|=</span> <span class="n">SAA7134_IRQ2_INTE_GPIO18_P</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">mask_keyup</span> <span class="o">&amp;</span> <span class="mh">0x40000</span><span class="p">)</span>
				<span class="n">irq2_mask</span> <span class="o">|=</span> <span class="n">SAA7134_IRQ2_INTE_GPIO18_N</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_remote</span> <span class="o">==</span> <span class="n">SAA7134_REMOTE_I2C</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;ir-kbd-i2c&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span> <span class="n">irq2_mask</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_hwinit2</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;hwinit2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">saa7134_video_init2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_tvaudio_init2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">saa7134_hw_enable2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* shutdown */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_hwfini</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;hwfini</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card_has_mpeg</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">saa7134_ts_fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_input_fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_vbi_fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_tvaudio_fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span> <span class="nf">must_configure_manually</span><span class="p">(</span><span class="kt">int</span> <span class="n">has_eeprom</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_eeprom</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;saa7134: &lt;rant&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134:  Congratulations!  Your TV card vendor saved a few</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134:  cents for a eeprom, thus your pci board has no</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134:  subsystem ID and I can&#39;t identify it automatically</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134: &lt;/rant&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134: I feel better now.  Ok, here are the good news:</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134: You can use the card=&lt;nr&gt; insmod option to specify</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134: which board do you have.  The list:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
		       <span class="s">&quot;saa7134: Board is currently unknown. You might try to use the card=&lt;nr&gt;</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134: insmod option to specify which board do you have, but this is</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134: somewhat risky, as might damage your card. It is better to ask</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134: for support at linux-media@vger.kernel.org.</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;saa7134: The supported cards are:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">saa7134_bcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;saa7134:   card=%d -&gt; %-40.40s&quot;</span><span class="p">,</span>
		       <span class="n">i</span><span class="p">,</span><span class="n">saa7134_boards</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">saa7134_pci_tbl</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">driver_data</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_pci_tbl</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">driver_data</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %04x:%04x&quot;</span><span class="p">,</span>
			       <span class="n">saa7134_pci_tbl</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">subvendor</span><span class="p">,</span>
			       <span class="n">saa7134_pci_tbl</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">subdevice</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="nf">vdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">template</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span><span class="p">;</span>

	<span class="n">vfd</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">vfd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">vfd</span> <span class="o">=</span> <span class="o">*</span><span class="n">template</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">video_device_release</span><span class="p">;</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">debug</span>   <span class="o">=</span> <span class="n">video_debug</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s %s (%s)&quot;</span><span class="p">,</span>
		 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vfd</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vfd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7134_unregister_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">))</span>
			<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">))</span>
			<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">))</span>
			<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpeg_ops_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_mpeg_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mops</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">mpeg</span> <span class="o">!=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mpeg_ops_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_mpeg_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mops</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mops</span> <span class="o">!=</span> <span class="n">ops</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mops</span><span class="o">-&gt;</span><span class="n">fini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">saa7134_initdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_mpeg_ops</span> <span class="o">*</span><span class="n">mops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_devcount</span> <span class="o">==</span> <span class="n">SAA7134_MAXBOARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail0</span><span class="p">;</span>

	<span class="cm">/* pci init */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">saa7134_devcount</span><span class="p">;</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="s">&quot;saa%x[%d]&quot;</span><span class="p">,</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="cm">/* pci quirks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_pci_problems</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_pci_problems</span> <span class="o">&amp;</span> <span class="n">PCIPCI_TRITON</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: quirk: PCIPCI_TRITON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_pci_problems</span> <span class="o">&amp;</span> <span class="n">PCIPCI_NATOMA</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: quirk: PCIPCI_NATOMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_pci_problems</span> <span class="o">&amp;</span> <span class="n">PCIPCI_VIAETBF</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: quirk: PCIPCI_VIAETBF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_pci_problems</span> <span class="o">&amp;</span> <span class="n">PCIPCI_VSFX</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: quirk: PCIPCI_VSFX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#ifdef PCIPCI_ALIMAGIK</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_pci_problems</span> <span class="o">&amp;</span> <span class="n">PCIPCI_ALIMAGIK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: quirk: PCIPCI_ALIMAGIK -- latency fixup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">latency</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_pci_problems</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">PCIPCI_FAIL</span><span class="o">|</span><span class="n">PCIAGP_FAIL</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: quirk: this driver and your &quot;</span>
					<span class="s">&quot;chipset may not work together&quot;</span>
					<span class="s">&quot; in overlay mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saa7134_no_overlay</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: quirk: overlay &quot;</span>
						<span class="s">&quot;mode will be disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">saa7134_no_overlay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: quirk: overlay &quot;</span>
						<span class="s">&quot;mode will be forced. Use this&quot;</span>
						<span class="s">&quot; option at your own risk.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">latency</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: setting pci latency timer to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">latency</span><span class="p">);</span>
		<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="n">latency</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* print pci info */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_rev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_lat</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: found at %s, rev: %d, irq: %d, &quot;</span>
	       <span class="s">&quot;latency: %d, mmio: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_rev</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_lat</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_dma_supported</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Oops: no 32bit PCI DMA ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* board config */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">pci_id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">saa7134_bcount</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SAA7134_BOARD_UNKNOWN</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span>
		<span class="n">must_configure_manually</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">SAA7134_BOARD_NOAUTO</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">must_configure_manually</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">SAA7134_BOARD_UNKNOWN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">autodetected</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">=</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">tuner_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_addr</span> <span class="o">=</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">tuner_addr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_type</span> <span class="o">=</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">radio_type</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_addr</span> <span class="o">=</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">radio_addr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tda9887_conf</span> <span class="o">=</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">tda9887_conf</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">tuner</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">])</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">=</span> <span class="n">tuner</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: subsystem: %04x:%04x, board: %s [card=%d,%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
		<span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">,</span><span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">autodetected</span> <span class="o">?</span>
		<span class="s">&quot;autodetected&quot;</span> <span class="o">:</span> <span class="s">&quot;insmod option&quot;</span><span class="p">);</span>

	<span class="cm">/* get mmio */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
				<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t get MMIO memory @ 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t ioremap() MMIO memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* initialize hardware #1 */</span>
	<span class="n">saa7134_board_init1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_hwinit1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* get irq */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">saa7134_irq</span><span class="p">,</span>
			  <span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wait a bit, register i2c bus */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">saa7134_i2c_register</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_board_init2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">saa7134_hwinit2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* load i2c helpers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_is_empress</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span>
			<span class="n">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span>
				<span class="s">&quot;saa6752hs&quot;</span><span class="p">,</span>
				<span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">empress_addr</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="p">)</span>
			<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="n">GRP_EMPRESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">rds_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>

		<span class="n">sd</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="s">&quot;saa6588&quot;</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">I2C_ADDRS</span><span class="p">(</span><span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">rds_addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: found RDS decoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_rds</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">v4l2_prio_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mops_list</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span>
		<span class="n">mpeg_ops_attach</span><span class="p">(</span><span class="n">mops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa7134_devlist</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>

	<span class="cm">/* check for signal */</span>
	<span class="n">saa7134_irq_video_signalchange</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">TUNER_ABSENT</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">)</span>
		<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_power</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* register v4l devices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_no_overlay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Overlay support disabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_dev</span> <span class="o">=</span> <span class="n">vdev_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">saa7134_video_template</span><span class="p">,</span><span class="s">&quot;video&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">,</span><span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span>
				    <span class="n">video_nr</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: can&#39;t register video device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: registered device %s [v4l2]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_dev</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_dev</span> <span class="o">=</span> <span class="n">vdev_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa7134_video_template</span><span class="p">,</span> <span class="s">&quot;vbi&quot;</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">,</span><span class="n">VFL_TYPE_VBI</span><span class="p">,</span>
				    <span class="n">vbi_nr</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: registered device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card_has_radio</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_dev</span> <span class="o">=</span> <span class="n">vdev_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">saa7134_radio_template</span><span class="p">,</span><span class="s">&quot;radio&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">,</span><span class="n">VFL_TYPE_RADIO</span><span class="p">,</span>
					    <span class="n">radio_nr</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: registered device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_dev</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* everything worked */</span>
	<span class="n">saa7134_devcount</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_dmasound_init</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">priv_data</span><span class="p">)</span>
		<span class="n">saa7134_dmasound_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">request_submodules</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail4:</span>
	<span class="n">saa7134_unregister_video</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_i2c_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
 <span class="nl">fail3:</span>
	<span class="n">saa7134_hwfini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span><span class="p">);</span>
 <span class="nl">fail2:</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>
 <span class="nl">fail1:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
 <span class="nl">fail0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">saa7134_finidev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_dev</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_mpeg_ops</span> <span class="o">*</span><span class="n">mops</span><span class="p">;</span>

	<span class="n">flush_request_submodules</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Release DMA sound modules if present */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_dmasound_exit</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">priv_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7134_dmasound_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* debugging ... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq_debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">report</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_IRQ_REPORT</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_IRQ_STATUS</span><span class="p">);</span>
		<span class="n">print_irqstatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">42</span><span class="p">,</span><span class="n">report</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* disable peripheral devices */</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_SPECIAL_MODE</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* shutdown hardware */</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ1</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_MAIN_CTRL</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* shutdown subsystems */</span>
	<span class="n">saa7134_hwfini</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* unregister */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">mops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mops_list</span><span class="p">,</span> <span class="n">next</span><span class="p">)</span>
		<span class="n">mpeg_ops_detach</span><span class="p">(</span><span class="n">mops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>
	<span class="n">saa7134_devcount</span><span class="o">--</span><span class="p">;</span>

	<span class="n">saa7134_i2c_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_unregister_video</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>


	<span class="cm">/* the DMA sound modules should be unloaded before reaching</span>
<span class="cm">	   this, but just in case they are still present... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">priv_data</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">priv_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* release resources */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span><span class="p">);</span>
	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span>
			   <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span><span class="mi">0</span><span class="p">));</span>


	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="cm">/* free memory */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/* resends a current buffer in queue after resume */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_buffer_requeue</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">saa7134_dmaqueue</span> <span class="o">*</span><span class="n">q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="n">assert_spin_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="n">buf</span>  <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">curr</span><span class="p">;</span>
	<span class="n">next</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer_requeue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer_requeue : resending active buffers </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_buf</span><span class="p">,</span>
					  <span class="n">vb</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">activate</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span> <span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_dev</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="cm">/* disable overlay - apps should enable it explicitly on resume*/</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovenable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Disable interrupts, DMA, and rest of the chip*/</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_MAIN_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">insuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* ACK interrupts once more, just in case,</span>
<span class="cm">		since the IRQ handler won&#39;t ack them anymore*/</span>

	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ_REPORT</span><span class="p">,</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_IRQ_REPORT</span><span class="p">));</span>

	<span class="cm">/* Disable timeout timers - if we have active buffers, we will</span>
<span class="cm">	   fill them on resume*/</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_q</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts_q</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span>
		<span class="n">saa7134_ir_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">pci_save_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_dev</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="cm">/* Do things that are done in saa7134_initdev ,</span>
<span class="cm">		except of initializing memory structures.*/</span>

	<span class="n">saa7134_board_init1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* saa7134_hwinit1 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">video_out</span><span class="p">)</span>
		<span class="n">saa7134_videoport_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_has_mpeg</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">saa7134_ts_init_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span>
		<span class="n">saa7134_ir_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_hw_enable1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">saa7134_board_init2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*saa7134_hwinit2*/</span>
	<span class="n">saa7134_set_tvnorm_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_tvaudio_setvolume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_volume</span><span class="p">);</span>
	<span class="n">saa7134_tvaudio_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_enable_i2s</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_hw_enable2</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">saa7134_irq_video_signalchange</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*resume unfinished buffer(s)*/</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">saa7134_buffer_requeue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">);</span>
	<span class="n">saa7134_buffer_requeue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vbi_q</span><span class="p">);</span>
	<span class="n">saa7134_buffer_requeue</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ts_q</span><span class="p">);</span>

	<span class="cm">/* FIXME: Disable DMA audio sound - temporary till proper support</span>
<span class="cm">		  is implemented*/</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* start DMA now*/</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">insuspend</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">smp_wmb</span><span class="p">();</span>
	<span class="n">saa7134_set_dmabits</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* ----------------------------------------------------------- */</span>

<span class="kt">int</span> <span class="nf">saa7134_ts_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_mpeg_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa7134_devlist</span><span class="p">,</span> <span class="n">devlist</span><span class="p">)</span>
		<span class="n">mpeg_ops_attach</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">,</span><span class="o">&amp;</span><span class="n">mops_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_ts_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_mpeg_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa7134_devlist</span><span class="p">,</span> <span class="n">devlist</span><span class="p">)</span>
		<span class="n">mpeg_ops_detach</span><span class="p">(</span><span class="n">ops</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_devlist_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_ts_register</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_ts_unregister</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">saa7134_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;saa7134&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">saa7134_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">saa7134_initdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">saa7134_finidev</span><span class="p">),</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">saa7134_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">saa7134_resume</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">saa7134_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_devlist</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;saa7130/34: v4l2 driver version %s loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">SAA7134_VERSION</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">saa7134_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7134_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">saa7134_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">saa7134_fini</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------- */</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_set_gpio</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_boards</span><span class="p">);</span>

<span class="cm">/* ----------------- for the DMA sound modules --------------- */</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_dmasound_init</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_dmasound_exit</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_pgtable_free</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_pgtable_build</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_pgtable_alloc</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_set_dmabits</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
