<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › saa7134 › saa7134-video.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>saa7134-video.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * device driver for philips saa7134 based TV cards</span>
<span class="cm"> * video4linux video interface</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2001-03 Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sort.h&gt;</span>

<span class="cp">#include &quot;saa7134-reg.h&quot;</span>
<span class="cp">#include &quot;saa7134.h&quot;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/saa6588.h&gt;</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">video_debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gbuffers</span>      <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">noninterlaced</span><span class="p">;</span> <span class="cm">/* 0 */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gbufsize</span>      <span class="o">=</span> <span class="mi">720</span><span class="o">*</span><span class="mi">576</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gbufsize_max</span>  <span class="o">=</span> <span class="mi">720</span><span class="o">*</span><span class="mi">576</span><span class="o">*</span><span class="mi">4</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">secam</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;--&quot;</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video_debug</span><span class="p">,</span><span class="s">&quot;enable debug messages [video]&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">gbuffers</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">gbuffers</span><span class="p">,</span><span class="s">&quot;number of capture buffers, range 2-32&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">noninterlaced</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">noninterlaced</span><span class="p">,</span><span class="s">&quot;capture non interlaced video&quot;</span><span class="p">);</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">secam</span><span class="p">,</span> <span class="n">secam</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">secam</span><span class="p">),</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">secam</span><span class="p">,</span> <span class="s">&quot;force SECAM variant, either DK,L or Lc&quot;</span><span class="p">);</span>


<span class="cp">#define dprintk(fmt, arg...)	if (video_debug&amp;0x04) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s/video: &quot; fmt, dev-&gt;name , ## arg)</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* Defines for Video Output Port Register at address 0x191            */</span>

<span class="cm">/* Bit 0: VIP code T bit polarity */</span>

<span class="cp">#define VP_T_CODE_P_NON_INVERTED	0x00</span>
<span class="cp">#define VP_T_CODE_P_INVERTED		0x01</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* Defines for Video Output Port Register at address 0x195            */</span>

<span class="cm">/* Bit 2: Video output clock delay control */</span>

<span class="cp">#define VP_CLK_CTRL2_NOT_DELAYED	0x00</span>
<span class="cp">#define VP_CLK_CTRL2_DELAYED		0x04</span>

<span class="cm">/* Bit 1: Video output clock invert control */</span>

<span class="cp">#define VP_CLK_CTRL1_NON_INVERTED	0x00</span>
<span class="cp">#define VP_CLK_CTRL1_INVERTED		0x02</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* Defines for Video Output Port Register at address 0x196            */</span>

<span class="cm">/* Bits 2 to 0: VSYNC pin video vertical sync type */</span>

<span class="cp">#define VP_VS_TYPE_MASK			0x07</span>

<span class="cp">#define VP_VS_TYPE_OFF			0x00</span>
<span class="cp">#define VP_VS_TYPE_V123			0x01</span>
<span class="cp">#define VP_VS_TYPE_V_ITU		0x02</span>
<span class="cp">#define VP_VS_TYPE_VGATE_L		0x03</span>
<span class="cp">#define VP_VS_TYPE_RESERVED1		0x04</span>
<span class="cp">#define VP_VS_TYPE_RESERVED2		0x05</span>
<span class="cp">#define VP_VS_TYPE_F_ITU		0x06</span>
<span class="cp">#define VP_VS_TYPE_SC_FID		0x07</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* data structs for video                                             */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">video_out</span><span class="p">[][</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CCIR656</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xb1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7134_format</span> <span class="n">formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;8 bpp gray&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_GREY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;15 bpp RGB, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB555</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x13</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;15 bpp RGB, be&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB555X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x13</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bswap</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;16 bpp RGB, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x10</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;16 bpp RGB, be&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565X</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x10</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bswap</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;24 bpp RGB, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_BGR24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;24 bpp RGB, be&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bswap</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;32 bpp RGB, le&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_BGR32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;32 bpp RGB, be&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bswap</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">wswap</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:2 packed, YUYV&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bswap</span>    <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yuv</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:2 packed, UYVY&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yuv</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:2 planar, Y-Cb-Cr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV422P</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x09</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yuv</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">planar</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vshift</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:0 planar, Y-Cb-Cr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV420</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yuv</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">planar</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;4:2:0 planar, Y-Cb-Cr&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fourcc</span>   <span class="o">=</span> <span class="n">V4L2_PIX_FMT_YVU420</span><span class="p">,</span>
		<span class="p">.</span><span class="n">depth</span>    <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>       <span class="o">=</span> <span class="mh">0x0a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">yuv</span>      <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">planar</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">uvswap</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">hshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vshift</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cp">#define FORMATS ARRAY_SIZE(formats)</span>

<span class="cp">#define NORM_625_50			\</span>
<span class="cp">		.h_start       = 0,	\</span>
<span class="cp">		.h_stop        = 719,	\</span>
<span class="cp">		.video_v_start = 24,	\</span>
<span class="cp">		.video_v_stop  = 311,	\</span>
<span class="cp">		.vbi_v_start_0 = 7,	\</span>
<span class="cp">		.vbi_v_stop_0  = 22,	\</span>
<span class="cp">		.vbi_v_start_1 = 319,   \</span>
<span class="cp">		.src_timing    = 4</span>

<span class="cp">#define NORM_525_60			\</span>
<span class="cp">		.h_start       = 0,	\</span>
<span class="cp">		.h_stop        = 719,	\</span>
<span class="cp">		.video_v_start = 23,	\</span>
<span class="cp">		.video_v_stop  = 262,	\</span>
<span class="cp">		.vbi_v_start_0 = 10,	\</span>
<span class="cp">		.vbi_v_stop_0  = 21,	\</span>
<span class="cp">		.vbi_v_start_1 = 273,	\</span>
<span class="cp">		.src_timing    = 7</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7134_tvnorm</span> <span class="n">tvnorms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL&quot;</span><span class="p">,</span> <span class="cm">/* autodetect */</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">,</span>
		<span class="n">NORM_625_50</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-BG&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">,</span>
		<span class="n">NORM_625_50</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-I&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">,</span>
		<span class="n">NORM_625_50</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-DK&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">,</span>
		<span class="n">NORM_625_50</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;NTSC&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">,</span>
		<span class="n">NORM_525_60</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x59</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0x89</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;SECAM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_SECAM</span><span class="p">,</span>
		<span class="n">NORM_625_50</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x1b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0xd1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;SECAM-DK&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_SECAM_DK</span><span class="p">,</span>
		<span class="n">NORM_625_50</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x1b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0xd1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;SECAM-L&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">,</span>
		<span class="n">NORM_625_50</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x1b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0xd1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;SECAM-Lc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">,</span>
		<span class="n">NORM_625_50</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x1b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0xd1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-M&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">,</span>
		<span class="n">NORM_525_60</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x59</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0xb9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x0e</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-Nc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">,</span>
		<span class="n">NORM_625_50</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0xa1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>

	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-60&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_STD_PAL_60</span><span class="p">,</span>

		<span class="p">.</span><span class="n">h_start</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">h_stop</span>        <span class="o">=</span> <span class="mi">719</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_v_start</span> <span class="o">=</span> <span class="mi">23</span><span class="p">,</span>
		<span class="p">.</span><span class="n">video_v_stop</span>  <span class="o">=</span> <span class="mi">262</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbi_v_start_0</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbi_v_stop_0</span>  <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vbi_v_start_1</span> <span class="o">=</span> <span class="mi">273</span><span class="p">,</span>
		<span class="p">.</span><span class="n">src_timing</span>    <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>

		<span class="p">.</span><span class="n">sync_control</span>  <span class="o">=</span> <span class="mh">0x18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">luma_control</span>  <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl1</span>  <span class="o">=</span> <span class="mh">0x81</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_gain</span>   <span class="o">=</span> <span class="mh">0x2a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">chroma_ctrl2</span>  <span class="o">=</span> <span class="mh">0x06</span><span class="p">,</span>
		<span class="p">.</span><span class="n">vgate_misc</span>    <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cp">#define TVNORMS ARRAY_SIZE(tvnorms)</span>

<span class="cp">#define V4L2_CID_PRIVATE_INVERT      (V4L2_CID_PRIVATE_BASE + 0)</span>
<span class="cp">#define V4L2_CID_PRIVATE_Y_ODD       (V4L2_CID_PRIVATE_BASE + 1)</span>
<span class="cp">#define V4L2_CID_PRIVATE_Y_EVEN      (V4L2_CID_PRIVATE_BASE + 2)</span>
<span class="cp">#define V4L2_CID_PRIVATE_AUTOMUTE    (V4L2_CID_PRIVATE_BASE + 3)</span>
<span class="cp">#define V4L2_CID_PRIVATE_LASTP1      (V4L2_CID_PRIVATE_BASE + 4)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">no_ctrl</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>  <span class="o">=</span> <span class="s">&quot;42&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_CTRL_FLAG_DISABLED</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">video_ctrls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* --- video --- */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Brightness&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">255</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Contrast&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">127</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">68</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_SATURATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Saturation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">127</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_HUE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Hue&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">127</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_HFLIP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Mirror&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* --- audio --- */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Mute&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Volume&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="o">-</span><span class="mi">15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* --- private --- */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_INVERT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;Invert&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_Y_ODD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;y offset odd field&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_Y_EVEN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;y offset even field&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">128</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>          <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">id</span>            <span class="o">=</span> <span class="n">V4L2_CID_PRIVATE_AUTOMUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;automute&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">minimum</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">maximum</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>          <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">CTRLS</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">video_ctrls</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span><span class="o">*</span> <span class="nf">ctrl_by_id</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CTRLS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_ctrls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">video_ctrls</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7134_format</span><span class="o">*</span> <span class="nf">format_by_fourcc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fourcc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FORMATS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fourcc</span> <span class="o">==</span> <span class="n">fourcc</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">formats</span><span class="o">+</span><span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>
<span class="cm">/* resource management                                                     */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">res_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span>
		<span class="cm">/* have it already allocated */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* is it free? */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no, someone else uses it */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* it&#39;s free, grab it */</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span>  <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">|=</span> <span class="n">bit</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;res: get %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">bit</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">res_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">res_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="nf">res_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bits</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">((</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">!=</span> <span class="n">bits</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">resources</span>  <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">resources</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">bits</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;res: put %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">bits</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_tvnorm</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_tvnorm</span> <span class="o">*</span><span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;set tv norm = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">norm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span> <span class="o">=</span> <span class="n">norm</span><span class="p">;</span>

	<span class="cm">/* setup cropping */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">.</span><span class="n">left</span>    <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">h_start</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_defrect</span><span class="p">.</span><span class="n">left</span>   <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">h_start</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">.</span><span class="n">width</span>   <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">h_stop</span> <span class="o">-</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">h_start</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_defrect</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">h_stop</span> <span class="o">-</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">h_start</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">.</span><span class="n">top</span>     <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="o">-&gt;</span><span class="n">vbi_v_stop_0</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_defrect</span><span class="p">.</span><span class="n">top</span>    <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">video_v_start</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">.</span><span class="n">height</span>  <span class="o">=</span> <span class="p">((</span><span class="n">norm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="o">?</span> <span class="mi">524</span> <span class="o">:</span> <span class="mi">624</span><span class="p">)</span>
		<span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_defrect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm</span><span class="o">-&gt;</span><span class="n">video_v_stop</span> <span class="o">-</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">video_v_start</span> <span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_defrect</span><span class="p">;</span>

	<span class="n">saa7134_set_tvnorm_hw</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">video_mux</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;video input = %d [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">input</span><span class="p">).</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
	<span class="n">set_tvnorm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">);</span>
	<span class="n">saa7134_tvaudio_setinput</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">input</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7134_set_decoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">luma_control</span><span class="p">,</span> <span class="n">sync_control</span><span class="p">,</span> <span class="n">mux</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">saa7134_tvnorm</span> <span class="o">*</span><span class="n">norm</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">;</span>
	<span class="n">mux</span> <span class="o">=</span> <span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">).</span><span class="n">vmux</span><span class="p">;</span>

	<span class="n">luma_control</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">luma_control</span><span class="p">;</span>
	<span class="n">sync_control</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">sync_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mux</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">luma_control</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* svideo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">noninterlaced</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nosignal</span><span class="p">)</span>
		<span class="n">sync_control</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>

	<span class="cm">/* setup video decoder */</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_INCR_DELAY</span><span class="p">,</span>            <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IN_CTRL1</span><span class="p">,</span>       <span class="mh">0xc0</span> <span class="o">|</span> <span class="n">mux</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IN_CTRL2</span><span class="p">,</span>       <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IN_CTRL3</span><span class="p">,</span>       <span class="mh">0x90</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IN_CTRL4</span><span class="p">,</span>       <span class="mh">0x90</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_HSYNC_START</span><span class="p">,</span>           <span class="mh">0xeb</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_HSYNC_STOP</span><span class="p">,</span>            <span class="mh">0xe0</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_SOURCE_TIMING1</span><span class="p">,</span>        <span class="n">norm</span><span class="o">-&gt;</span><span class="n">src_timing</span><span class="p">);</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_SYNC_CTRL</span><span class="p">,</span>             <span class="n">sync_control</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_LUMA_CTRL</span><span class="p">,</span>             <span class="n">luma_control</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_LUMA_BRIGHT</span><span class="p">,</span>       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_bright</span><span class="p">);</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_LUMA_CONTRAST</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_invert</span> <span class="o">?</span> <span class="o">-</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span><span class="p">);</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_CHROMA_SATURATION</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_invert</span> <span class="o">?</span> <span class="o">-</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span><span class="p">);</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_CHROMA_HUE</span><span class="p">,</span>        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_hue</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_CHROMA_CTRL1</span><span class="p">,</span>          <span class="n">norm</span><span class="o">-&gt;</span><span class="n">chroma_ctrl1</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_CHROMA_GAIN</span><span class="p">,</span>           <span class="n">norm</span><span class="o">-&gt;</span><span class="n">chroma_gain</span><span class="p">);</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_CHROMA_CTRL2</span><span class="p">,</span>          <span class="n">norm</span><span class="o">-&gt;</span><span class="n">chroma_ctrl2</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_MODE_DELAY_CTRL</span><span class="p">,</span>       <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_ADC</span><span class="p">,</span>            <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VGATE_START</span><span class="p">,</span>           <span class="mh">0x11</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VGATE_STOP</span><span class="p">,</span>            <span class="mh">0xfe</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_MISC_VGATE_MSB</span><span class="p">,</span>        <span class="n">norm</span><span class="o">-&gt;</span><span class="n">vgate_misc</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_RAW_DATA_GAIN</span><span class="p">,</span>         <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_RAW_DATA_OFFSET</span><span class="p">,</span>       <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_set_tvnorm_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">saa7134_set_decoder</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">).</span><span class="n">tv</span><span class="p">)</span>
		<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="cm">/* Set the correct norm for the saa6752hs. This function</span>
<span class="cm">	   does nothing if there is no saa6752hs. */</span>
	<span class="n">saa_call_empress</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_h_prescale</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prescale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">xpsc</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">xacl</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">xc2_1</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">xdcg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">vpfy</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">vals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* XPSC XACL XC2_1 XDCG VPFY */</span>
		<span class="p">{</span>    <span class="mi">1</span><span class="p">,</span>   <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>   <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span>    <span class="mi">2</span><span class="p">,</span>   <span class="mi">2</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span>    <span class="mi">2</span><span class="p">,</span>   <span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span>    <span class="mi">3</span><span class="p">,</span>   <span class="mi">4</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span>    <span class="mi">3</span><span class="p">,</span>   <span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span>    <span class="mi">4</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>   <span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span>    <span class="mi">5</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>   <span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span>    <span class="mi">6</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>   <span class="mi">3</span> <span class="p">},</span>
		<span class="p">{</span>    <span class="mi">7</span><span class="p">,</span>   <span class="mi">8</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>   <span class="mi">3</span> <span class="p">},</span>
		<span class="p">{</span>    <span class="mi">8</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>   <span class="mi">3</span> <span class="p">},</span>
		<span class="p">{</span>    <span class="mi">9</span><span class="p">,</span>  <span class="mi">15</span><span class="p">,</span>    <span class="mi">0</span><span class="p">,</span>    <span class="mi">4</span><span class="p">,</span>   <span class="mi">3</span> <span class="p">},</span>
		<span class="p">{</span>   <span class="mi">10</span><span class="p">,</span>  <span class="mi">16</span><span class="p">,</span>    <span class="mi">1</span><span class="p">,</span>    <span class="mi">5</span><span class="p">,</span>   <span class="mi">3</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">vals</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xpsc</span> <span class="o">==</span> <span class="n">prescale</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_H_PRESCALE</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xpsc</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_ACC_LENGTH</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xacl</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_LEVEL_CTRL</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xc2_1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">xdcg</span><span class="p">));</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_FIR_PREFILTER_CTRL</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="mh">0x0f</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vpfy</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">vals</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vpfy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_v_scale</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">task</span><span class="p">,</span> <span class="kt">int</span> <span class="n">yscale</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span><span class="n">mirror</span><span class="p">;</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_V_SCALE_RATIO1</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">yscale</span> <span class="o">&amp;</span>  <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_V_SCALE_RATIO2</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">yscale</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">mirror</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mirror</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x02</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yscale</span> <span class="o">&lt;</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* LPI */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;yscale LPI yscale=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">yscale</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_V_FILTER</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="mh">0x00</span> <span class="o">|</span> <span class="n">mirror</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_LUMA_CONTRAST</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="mh">0x40</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_CHROMA_SATURATION</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* ACM */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mh">0x40</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">/</span> <span class="n">yscale</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;yscale ACM yscale=%d val=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">yscale</span><span class="p">,</span><span class="n">val</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_V_FILTER</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="mh">0x01</span> <span class="o">|</span> <span class="n">mirror</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_LUMA_CONTRAST</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_CHROMA_SATURATION</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_LUMA_BRIGHT</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>       <span class="mh">0x80</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">task</span><span class="p">,</span>
		     <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interlace</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">prescale</span><span class="p">,</span><span class="n">xscale</span><span class="p">,</span><span class="n">yscale</span><span class="p">,</span><span class="n">y_even</span><span class="p">,</span><span class="n">y_odd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h_start</span><span class="p">,</span> <span class="n">h_stop</span><span class="p">,</span> <span class="n">v_start</span><span class="p">,</span> <span class="n">v_stop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">div</span> <span class="o">=</span> <span class="n">interlace</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* setup video scaler */</span>
	<span class="n">h_start</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="n">v_start</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">top</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>
	<span class="n">h_stop</span>  <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">width</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">v_stop</span>  <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">height</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">;</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_H_START1</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">h_start</span> <span class="o">&amp;</span>  <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_H_START2</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">h_start</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_H_STOP1</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>  <span class="n">h_stop</span>  <span class="o">&amp;</span>  <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_H_STOP2</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>  <span class="n">h_stop</span>  <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_V_START1</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">v_start</span> <span class="o">&amp;</span>  <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_V_START2</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">v_start</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_V_STOP1</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>  <span class="n">v_stop</span>  <span class="o">&amp;</span>  <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_V_STOP2</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>  <span class="n">v_stop</span>  <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">prescale</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">width</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">prescale</span><span class="p">)</span>
		<span class="n">prescale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xscale</span> <span class="o">=</span> <span class="mi">1024</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">width</span> <span class="o">/</span> <span class="n">prescale</span> <span class="o">/</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">yscale</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">*</span> <span class="n">div</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">height</span> <span class="o">/</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;prescale=%d xscale=%d yscale=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">prescale</span><span class="p">,</span><span class="n">xscale</span><span class="p">,</span><span class="n">yscale</span><span class="p">);</span>
	<span class="n">set_h_prescale</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">task</span><span class="p">,</span><span class="n">prescale</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_H_SCALE_INC1</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>      <span class="n">xscale</span> <span class="o">&amp;</span>  <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_H_SCALE_INC2</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>      <span class="n">xscale</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">set_v_scale</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">task</span><span class="p">,</span><span class="n">yscale</span><span class="p">);</span>

	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PIXELS1</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>     <span class="n">width</span>  <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PIXELS2</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>     <span class="n">width</span>  <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_LINES1</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>      <span class="n">height</span><span class="o">/</span><span class="n">div</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_LINES2</span><span class="p">(</span><span class="n">task</span><span class="p">),</span>      <span class="n">height</span><span class="o">/</span><span class="n">div</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="cm">/* deinterlace y offsets */</span>
	<span class="n">y_odd</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_y_odd</span><span class="p">;</span>
	<span class="n">y_even</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_y_even</span><span class="p">;</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_V_PHASE_OFFSET0</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">y_odd</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_V_PHASE_OFFSET1</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">y_even</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_V_PHASE_OFFSET2</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">y_odd</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_V_PHASE_OFFSET3</span><span class="p">(</span><span class="n">task</span><span class="p">),</span> <span class="n">y_even</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">struct</span> <span class="n">cliplist</span> <span class="p">{</span>
	<span class="n">__u16</span> <span class="n">position</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">enable</span><span class="p">;</span>
	<span class="n">__u8</span>  <span class="n">disable</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_cliplist</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cliplist</span> <span class="o">*</span><span class="n">cl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">entries</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u8</span> <span class="n">winbits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">winbits</span> <span class="o">|=</span> <span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">enable</span><span class="p">;</span>
		<span class="n">winbits</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">disable</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span> <span class="o">&amp;&amp;</span> <span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">==</span> <span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">].</span><span class="n">position</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="n">winbits</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;clip: %s winbits=%02x pos=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">,</span><span class="n">winbits</span><span class="p">,</span><span class="n">cl</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">position</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x400</span><span class="p">;</span> <span class="n">reg</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">reg</span> <span class="o">+</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clip_range</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Sort into smallest position first order */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cliplist_cmp</span><span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cliplist</span> <span class="o">*</span><span class="n">cla</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">cliplist</span> <span class="o">*</span><span class="n">clb</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cla</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">&lt;</span> <span class="n">clb</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cla</span><span class="o">-&gt;</span><span class="n">position</span> <span class="o">&gt;</span> <span class="n">clb</span><span class="o">-&gt;</span><span class="n">position</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">setup_clipping</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_clip</span> <span class="o">*</span><span class="n">clips</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">nclips</span><span class="p">,</span> <span class="kt">int</span> <span class="n">interlace</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cliplist</span> <span class="n">col</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">row</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">cols</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rows</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">div</span> <span class="o">=</span> <span class="n">interlace</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">col</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">row</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nclips</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">col</span><span class="p">[</span><span class="n">cols</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">clip_range</span><span class="p">(</span><span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c</span><span class="p">.</span><span class="n">left</span><span class="p">);</span>
		<span class="n">col</span><span class="p">[</span><span class="n">cols</span><span class="p">].</span><span class="n">enable</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">cols</span><span class="o">++</span><span class="p">;</span>
		<span class="n">col</span><span class="p">[</span><span class="n">cols</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">clip_range</span><span class="p">(</span><span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c</span><span class="p">.</span><span class="n">left</span><span class="o">+</span><span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
		<span class="n">col</span><span class="p">[</span><span class="n">cols</span><span class="p">].</span><span class="n">disable</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">cols</span><span class="o">++</span><span class="p">;</span>
		<span class="n">row</span><span class="p">[</span><span class="n">rows</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">clip_range</span><span class="p">(</span><span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">/</span> <span class="n">div</span><span class="p">);</span>
		<span class="n">row</span><span class="p">[</span><span class="n">rows</span><span class="p">].</span><span class="n">enable</span>   <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">rows</span><span class="o">++</span><span class="p">;</span>
		<span class="n">row</span><span class="p">[</span><span class="n">rows</span><span class="p">].</span><span class="n">position</span> <span class="o">=</span> <span class="n">clip_range</span><span class="p">((</span><span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">clips</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">c</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
						<span class="o">/</span> <span class="n">div</span><span class="p">);</span>
		<span class="n">row</span><span class="p">[</span><span class="n">rows</span><span class="p">].</span><span class="n">disable</span>  <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">rows</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sort</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">cols</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">col</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cliplist_cmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sort</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cliplist_cmp</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">set_cliplist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mh">0x380</span><span class="p">,</span><span class="n">col</span><span class="p">,</span><span class="n">cols</span><span class="p">,</span><span class="s">&quot;cols&quot;</span><span class="p">);</span>
	<span class="n">set_cliplist</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mh">0x384</span><span class="p">,</span><span class="n">row</span><span class="p">,</span><span class="n">rows</span><span class="p">,</span><span class="s">&quot;rows&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">verify_preview</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span><span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">maxw</span><span class="p">,</span> <span class="n">maxh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span><span class="p">.</span><span class="n">base</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">48</span> <span class="o">||</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span>  <span class="mi">32</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">clipcount</span> <span class="o">&gt;</span> <span class="mi">2048</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">field</span><span class="p">;</span>
	<span class="n">maxw</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">maxh</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_ANY</span> <span class="o">==</span> <span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">maxh</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">V4L2_FIELD_INTERLACED</span>
			<span class="o">:</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
		<span class="n">maxh</span> <span class="o">=</span> <span class="n">maxh</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">win</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">maxw</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">maxw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">maxh</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">maxh</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">start_preview</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span><span class="n">control</span><span class="p">,</span><span class="n">bpl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfield</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;start_preview %dx%d+%d+%d %s field=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">top</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">v4l2_field_names</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfield</span><span class="p">]);</span>

	<span class="cm">/* setup window + clipping */</span>
	<span class="n">set_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">TASK_B</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
		 <span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfield</span><span class="p">));</span>
	<span class="n">setup_clipping</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">clips</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">nclips</span><span class="p">,</span>
		       <span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfield</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">yuv</span><span class="p">)</span>
		<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_DATA_PATH</span><span class="p">(</span><span class="n">TASK_B</span><span class="p">),</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_DATA_PATH</span><span class="p">(</span><span class="n">TASK_B</span><span class="p">),</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_OFMT_VIDEO_B</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">pm</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="cm">/* dma: setup channel 1 (= Video Task B) */</span>
	<span class="n">base</span>  <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">top</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">/</span><span class="mi">8</span>         <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">.</span><span class="n">w</span><span class="p">.</span><span class="n">left</span><span class="p">;</span>
	<span class="n">bpl</span>   <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">SAA7134_RS_CONTROL_BURST_16</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">bswap</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SAA7134_RS_CONTROL_BSWAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfmt</span><span class="o">-&gt;</span><span class="n">wswap</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SAA7134_RS_CONTROL_WSWAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfield</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">base</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">base</span><span class="o">+</span><span class="n">bpl</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_PITCH</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">bpl</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_CONTROL</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">base</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">base</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_PITCH</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">bpl</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_CONTROL</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* start dma */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovenable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">saa7134_set_dmabits</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">stop_preview</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovenable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">saa7134_set_dmabits</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">base</span><span class="p">,</span><span class="n">control</span><span class="p">,</span><span class="n">bpl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">bpl_uv</span><span class="p">,</span><span class="n">lines_uv</span><span class="p">,</span><span class="n">base2</span><span class="p">,</span><span class="n">base3</span><span class="p">,</span><span class="n">tmp</span><span class="p">;</span> <span class="cm">/* planar */</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer_activate buf=%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_ACTIVE</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">top_seen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">set_size</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">TASK_A</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
		 <span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">yuv</span><span class="p">)</span>
		<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_DATA_PATH</span><span class="p">(</span><span class="n">TASK_A</span><span class="p">),</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_DATA_PATH</span><span class="p">(</span><span class="n">TASK_A</span><span class="p">),</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_OFMT_VIDEO_A</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">);</span>

	<span class="cm">/* DMA: setup channel 0 (= Video Task A0) */</span>
	<span class="n">base</span>  <span class="o">=</span> <span class="n">saa7134_buffer_base</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">planar</span><span class="p">)</span>
		<span class="n">bpl</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bpl</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">SAA7134_RS_CONTROL_BURST_16</span> <span class="o">|</span>
		<span class="n">SAA7134_RS_CONTROL_ME</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bswap</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SAA7134_RS_CONTROL_BSWAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">wswap</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SAA7134_RS_CONTROL_WSWAP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* interlaced */</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">base</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">base</span><span class="o">+</span><span class="n">bpl</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_PITCH</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">bpl</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* non-interlaced */</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">base</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">base</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_PITCH</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">bpl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_CONTROL</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">control</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">planar</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DMA: setup channel 4+5 (= planar task A) */</span>
		<span class="n">bpl_uv</span>   <span class="o">=</span> <span class="n">bpl</span> <span class="o">&gt;&gt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">hshift</span><span class="p">;</span>
		<span class="n">lines_uv</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">vshift</span><span class="p">;</span>
		<span class="n">base2</span>    <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="n">bpl</span> <span class="o">*</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">base3</span>    <span class="o">=</span> <span class="n">base2</span> <span class="o">+</span> <span class="n">bpl_uv</span> <span class="o">*</span> <span class="n">lines_uv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">uvswap</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">base2</span><span class="p">,</span> <span class="n">base2</span> <span class="o">=</span> <span class="n">base3</span><span class="p">,</span> <span class="n">base3</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;uv: bpl=%ld lines=%ld base2/3=%ld/%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bpl_uv</span><span class="p">,</span><span class="n">lines_uv</span><span class="p">,</span><span class="n">base2</span><span class="p">,</span><span class="n">base3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* interlaced */</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">base2</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">base2</span><span class="o">+</span><span class="n">bpl_uv</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_PITCH</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">bpl_uv</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">base3</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">base3</span><span class="o">+</span><span class="n">bpl_uv</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_PITCH</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">bpl_uv</span><span class="o">*</span><span class="mi">2</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* non-interlaced */</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">base2</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">base2</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_PITCH</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">bpl_uv</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">base3</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">base3</span><span class="p">);</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_PITCH</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">bpl_uv</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_CONTROL</span><span class="p">(</span><span class="mi">4</span><span class="p">),</span><span class="n">control</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_CONTROL</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span><span class="n">control</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* start DMA */</span>
	<span class="n">saa7134_set_dmabits</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">timeout</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">BUFFER_TIMEOUT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">buffer_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">,</span>
			  <span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span><span class="k">struct</span> <span class="n">saa7134_buf</span><span class="p">,</span><span class="n">vb</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* sanity checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span>    <span class="o">&lt;</span> <span class="mi">48</span> <span class="o">||</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span>   <span class="o">&lt;</span> <span class="mi">32</span> <span class="o">||</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span><span class="o">/</span><span class="mi">4</span>  <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">width</span>  <span class="o">||</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span><span class="o">/</span><span class="mi">4</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">height</span> <span class="o">||</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span>    <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">.</span><span class="n">width</span>  <span class="o">||</span>
	    <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span>   <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">baddr</span>  <span class="o">&amp;&amp;</span>  <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">bsize</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;buffer_prepare [%d,size=%dx%d,bytes=%d,fields=%s,%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">i</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span><span class="n">size</span><span class="p">,</span><span class="n">v4l2_field_names</span><span class="p">[</span><span class="n">field</span><span class="p">],</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span>  <span class="o">!=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span>  <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">!=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span>   <span class="o">!=</span> <span class="n">size</span>       <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span>  <span class="o">!=</span> <span class="n">field</span>      <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span>       <span class="o">!=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7134_dma_free</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">VIDEOBUF_NEEDS_INIT</span> <span class="o">==</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">videobuf_dmabuf</span> <span class="o">*</span><span class="n">dma</span><span class="o">=</span><span class="n">videobuf_to_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">);</span>

		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">size</span>   <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span>  <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">fmt</span>       <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span>        <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">pt_cap</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">videobuf_iolock</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">oops</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">saa7134_pgtable_build</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">pt</span><span class="p">,</span>
					    <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglist</span><span class="p">,</span>
					    <span class="n">dma</span><span class="o">-&gt;</span><span class="n">sglen</span><span class="p">,</span>
					    <span class="n">saa7134_buffer_startpage</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">oops</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">VIDEOBUF_PREPARED</span><span class="p">;</span>
	<span class="n">buf</span><span class="o">-&gt;</span><span class="n">activate</span> <span class="o">=</span> <span class="n">buffer_activate</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">oops:</span>
	<span class="n">saa7134_dma_free</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">buffer_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">count</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>

	<span class="o">*</span><span class="n">size</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="o">*</span><span class="n">count</span><span class="p">)</span>
		<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">gbuffers</span><span class="p">;</span>
	<span class="o">*</span><span class="n">count</span> <span class="o">=</span> <span class="n">saa7134_buffer_count</span><span class="p">(</span><span class="o">*</span><span class="n">size</span><span class="p">,</span><span class="o">*</span><span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buffer_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span><span class="k">struct</span> <span class="n">saa7134_buf</span><span class="p">,</span><span class="n">vb</span><span class="p">);</span>

	<span class="n">saa7134_buffer_queue</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">buffer_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">videobuf_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_buf</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">vb</span><span class="p">,</span><span class="k">struct</span> <span class="n">saa7134_buf</span><span class="p">,</span><span class="n">vb</span><span class="p">);</span>

	<span class="n">saa7134_dma_free</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue_ops</span> <span class="n">video_qops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">buf_setup</span>    <span class="o">=</span> <span class="n">buffer_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_prepare</span>  <span class="o">=</span> <span class="n">buffer_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_queue</span>    <span class="o">=</span> <span class="n">buffer_queue</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buf_release</span>  <span class="o">=</span> <span class="n">buffer_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="kt">int</span> <span class="nf">saa7134_g_ctrl_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span><span class="o">*</span> <span class="n">ctrl</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">ctrl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_bright</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_hue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_volume</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_INVERT</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_invert</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mirror</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_Y_EVEN</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_y_even</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_Y_ODD</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_y_odd</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_AUTOMUTE</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_automute</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">saa7134_g_ctrl_internal</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">saa7134_g_ctrl_internal</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_s_ctrl_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span><span class="o">*</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">restart_overlay</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* When called from the empress code fh == NULL.</span>
<span class="cm">	   That needs to be fixed somehow, but for now this is</span>
<span class="cm">	   good enough. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">ctrl</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;set_control name=%s val=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* nothing */</span><span class="p">;</span>
	<span class="p">};</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_bright</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_LUMA_BRIGHT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_bright</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_hue</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_CHROMA_HUE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_hue</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_LUMA_CONTRAST</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_invert</span> <span class="o">?</span> <span class="o">-</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_CHROMA_SATURATION</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_invert</span> <span class="o">?</span> <span class="o">-</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_volume</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">saa7134_tvaudio_setvolume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_volume</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_INVERT</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_invert</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_LUMA_CONTRAST</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_invert</span> <span class="o">?</span> <span class="o">-</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEC_CHROMA_SATURATION</span><span class="p">,</span>
			   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_invert</span> <span class="o">?</span> <span class="o">-</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span> <span class="o">:</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mirror</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">restart_overlay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_Y_EVEN</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_y_even</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">restart_overlay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_Y_ODD</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_y_odd</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">restart_overlay</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVATE_AUTOMUTE</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_priv_tun_config</span> <span class="n">tda9887_cfg</span><span class="p">;</span>

		<span class="n">tda9887_cfg</span><span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="n">TUNER_TDA9887</span><span class="p">;</span>
		<span class="n">tda9887_cfg</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tda9887_conf</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_automute</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tda9887_conf</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_automute</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tda9887_conf</span> <span class="o">|=</span> <span class="n">TDA9887_AUTOMUTE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tda9887_conf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TDA9887_AUTOMUTE</span><span class="p">;</span>

			<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tda9887_cfg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">restart_overlay</span> <span class="o">&amp;&amp;</span> <span class="n">fh</span> <span class="o">&amp;&amp;</span> <span class="n">res_check</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">stop_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">fh</span><span class="p">);</span>
		<span class="n">start_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">fh</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">saa7134_s_ctrl_internal</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">saa7134_s_ctrl_internal</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">videobuf_queue</span><span class="o">*</span> <span class="nf">saa7134_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">videobuf_queue</span><span class="o">*</span> <span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span>:
		<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">q</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESOURCE_VIDEO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">RESOURCE_VBI</span><span class="p">;</span>

	<span class="n">BUG</span><span class="p">();</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">radio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vfl_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VFL_TYPE_GRABBER</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VFL_TYPE_VBI</span>:
		<span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">VFL_TYPE_RADIO</span>:
		<span class="n">radio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;open dev=%s radio=%d type=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">vdev</span><span class="p">),</span>
		<span class="n">radio</span><span class="p">,</span> <span class="n">v4l2_type_names</span><span class="p">[</span><span class="n">type</span><span class="p">]);</span>

	<span class="cm">/* allocate + initialize per filehandle data */</span>
	<span class="n">fh</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fh</span><span class="p">),</span><span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fh</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">fh</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span>      <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">radio</span>    <span class="o">=</span> <span class="n">radio</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span>     <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span>      <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">V4L2_PIX_FMT_BGR24</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span>    <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span>   <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="n">v4l2_prio_open</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>

	<span class="n">videobuf_queue_sg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">video_qops</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span>
			    <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">,</span>
			    <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_buf</span><span class="p">),</span>
			    <span class="n">fh</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">videobuf_queue_sg_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa7134_vbi_qops</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span>
			    <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span><span class="p">,</span>
			    <span class="n">V4L2_FIELD_SEQ_TB</span><span class="p">,</span>
			    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_buf</span><span class="p">),</span>
			    <span class="n">fh</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">saa7134_pgtable_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">pt_cap</span><span class="p">);</span>
	<span class="n">saa7134_pgtable_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">pt_vbi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switch to radio mode */</span>
		<span class="n">saa7134_tvaudio_setinput</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">radio</span><span class="p">);</span>
		<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_radio</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* switch to video/vbi mode */</span>
		<span class="n">video_mux</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">video_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">res_locked</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">RESOURCE_VIDEO</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">videobuf_read_one</span><span class="p">(</span><span class="n">saa7134_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span>
					 <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span>
					 <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_get</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_VBI</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">videobuf_read_stream</span><span class="p">(</span><span class="n">saa7134_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span>
					    <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
					    <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">video_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">videobuf_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">videobuf_poll_stream</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_check</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_VIDEO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">vb_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">stream</span><span class="p">))</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">stream</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">videobuf_buffer</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">vb_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_off</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* need to capture a new frame */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res_locked</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span><span class="n">RESOURCE_VIDEO</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">buf_prepare</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">field</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">buf_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">);</span>
			<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_off</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VIDEOBUF_DONE</span> <span class="o">||</span>
	    <span class="n">buf</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">VIDEOBUF_ERROR</span><span class="p">)</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">POLLIN</span><span class="o">|</span><span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">vb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">vb_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">POLLERR</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span>  <span class="o">*</span><span class="n">fh</span>  <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa6588_command</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">saa7134_tvaudio_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* turn off overlay */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_check</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">stop_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">fh</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">res_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_OVERLAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* stop video capture */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_check</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_VIDEO</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">videobuf_streamoff</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">);</span>
		<span class="n">res_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_VIDEO</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer_release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">,</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">read_buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* stop vbi capture */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_check</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_VBI</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">videobuf_stop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">);</span>
		<span class="n">res_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">fh</span><span class="p">,</span><span class="n">RESOURCE_VBI</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ts-capture will not work in planar mode, so turn it off Hac: 04.05*/</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_OFMT_VIDEO_A</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_OFMT_VIDEO_B</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_OFMT_DATA_A</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_OFMT_DATA_B</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_power</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
		<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">,</span> <span class="n">SAA6588_CMD_CLOSE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="cm">/* free stuff */</span>
	<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">);</span>
	<span class="n">videobuf_mmap_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">);</span>
	<span class="n">saa7134_pgtable_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">pt_cap</span><span class="p">);</span>
	<span class="n">saa7134_pgtable_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">pt_vbi</span><span class="p">);</span>

	<span class="n">v4l2_prio_close</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">video_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span> <span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">videobuf_mmap_mapper</span><span class="p">(</span><span class="n">saa7134_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">vma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">radio_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa6588_command</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">block_count</span> <span class="o">=</span> <span class="n">count</span><span class="o">/</span><span class="mi">3</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">,</span> <span class="n">SAA6588_CMD_READ</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="p">.</span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">radio_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa6588_command</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">instance</span> <span class="o">=</span> <span class="n">file</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">event_list</span> <span class="o">=</span> <span class="n">wait</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">,</span> <span class="n">SAA6588_CMD_POLL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">cmd</span><span class="p">.</span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_try_get_set_fmt_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_tvnorm</span> <span class="o">*</span><span class="n">norm</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">sampling_rate</span> <span class="o">=</span> <span class="mi">6750000</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">samples_per_line</span> <span class="o">=</span> <span class="mi">2048</span> <span class="cm">/* VBI_LINE_LENGTH */</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">sample_format</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_GREY</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">vbi_v_start_0</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">vbi_v_stop_0</span> <span class="o">-</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">vbi_v_start_0</span> <span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">norm</span><span class="o">-&gt;</span><span class="n">vbi_v_start_1</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* VBI_UNSYNC VBI_INTERLACED */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span>        <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span>       <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span>        <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span>  <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fourcc</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_no_overlay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;V4L2_BUF_TYPE_VIDEO_OVERLAY: no_overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maxw</span><span class="p">,</span> <span class="n">maxh</span><span class="p">;</span>

	<span class="n">fmt</span> <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">field</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="n">maxw</span>  <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">width</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="n">maxh</span>  <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">.</span><span class="n">height</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_ANY</span> <span class="o">==</span> <span class="n">field</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">maxh</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
			<span class="o">?</span> <span class="n">V4L2_FIELD_INTERLACED</span>
			<span class="o">:</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_TOP</span>:
	<span class="k">case</span> <span class="n">V4L2_FIELD_BOTTOM</span>:
		<span class="n">maxh</span> <span class="o">=</span> <span class="n">maxh</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span>  <span class="o">&lt;</span> <span class="mi">48</span><span class="p">)</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span>  <span class="o">=</span> <span class="mi">48</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">maxw</span><span class="p">)</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">maxw</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">maxh</span><span class="p">)</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">maxh</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x03</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span>
		<span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">*</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_try_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_no_overlay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;V4L2_BUF_TYPE_VIDEO_OVERLAY: no_overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">verify_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">saa7134_try_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">fmt</span>       <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">width</span>     <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">height</span>    <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">cap</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_no_overlay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;V4L2_BUF_TYPE_VIDEO_OVERLAY: no_overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">verify_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">win</span>    <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">;</span>
	<span class="n">fh</span><span class="o">-&gt;</span><span class="n">nclips</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">clipcount</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">nclips</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">fh</span><span class="o">-&gt;</span><span class="n">nclips</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">clips</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">clips</span><span class="p">,</span>
			   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_clip</span><span class="p">)</span><span class="o">*</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">nclips</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_check</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">stop_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>
		<span class="n">start_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span>  <span class="n">V4L2_CID_BASE</span> <span class="o">||</span>
	     <span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_LASTP1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span>  <span class="n">V4L2_CID_PRIVATE_BASE</span> <span class="o">||</span>
	     <span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_PRIVATE_LASTP1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">ctrl</span><span class="p">)</span> <span class="o">?</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">:</span> <span class="n">no_ctrl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">saa7134_queryctrl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">n</span> <span class="o">=</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">SAA7134_INPUT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span>  <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n</span><span class="p">).</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n</span><span class="p">).</span><span class="n">tv</span><span class="p">)</span>
		<span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_TUNER</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">audioset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7134_STATUS_VIDEO1</span><span class="p">);</span>
		<span class="kt">int</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7134_STATUS_VIDEO2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">V4L2_IN_ST_NO_H_LOCK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">V4L2_IN_ST_NO_SYNC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">v2</span> <span class="o">&amp;</span> <span class="mh">0x0e</span><span class="p">))</span>
			<span class="n">i</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">|=</span> <span class="n">V4L2_IN_ST_MACROVISION</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">SAA7134_NORMS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">SAA7134_INPUT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">).</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">video_mux</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tuner_type</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;saa7134&quot;</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span>
		<span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_VBI_CAPTURE</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_READWRITE</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_STREAMING</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_TUNER</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_rds</span><span class="p">)</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">V4L2_CAP_RDS_CAPTURE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_no_overlay</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">|=</span> <span class="n">V4L2_CAP_VIDEO_OVERLAY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_ABSENT</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">UNSET</span><span class="p">))</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_CAP_TUNER</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_s_std_internal</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">fixup</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* When called from the empress code fh == NULL.</span>
<span class="cm">	   That needs to be fixed somehow, but for now this is</span>
<span class="cm">	   good enough. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">res_locked</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t change the std from the mpeg device</span>
<span class="cm">		   if overlay is active. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TVNORMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span> <span class="o">==</span> <span class="n">tvnorms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TVNORMS</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TVNORMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">tvnorms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TVNORMS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">secam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">secam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;L&#39;</span> <span class="o">||</span> <span class="n">secam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;l&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">secam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;C&#39;</span> <span class="o">||</span> <span class="n">secam</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;c&#39;</span><span class="p">)</span>
				<span class="n">fixup</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fixup</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">secam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;D&#39;</span> <span class="o">||</span> <span class="n">secam</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;d&#39;</span><span class="p">)</span>
				<span class="n">fixup</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM_DK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">fixup</span> <span class="o">=</span> <span class="n">V4L2_STD_SECAM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TVNORMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fixup</span> <span class="o">==</span> <span class="n">tvnorms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">TVNORMS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">tvnorms</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fh</span> <span class="o">&amp;&amp;</span> <span class="n">res_check</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">stop_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">set_tvnorm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvnorms</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">start_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">set_tvnorm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvnorms</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">saa7134_tvaudio_do_scan</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">saa7134_s_std_internal</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">saa7134_s_std_internal</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">cap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">bounds</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">defrect</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_defrect</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>   <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>   <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>   <span class="o">=</span> <span class="mi">54</span><span class="p">;</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">59</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_bounds</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OVERLAY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res_locked</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res_locked</span><span class="p">(</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">RESOURCE_VIDEO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">)</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">)</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">)</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">crop_current</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">SAA7134_INPUT_MAX</span><span class="p">;</span> <span class="n">n</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n</span><span class="p">).</span><span class="n">tv</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">SAA7134_INPUT_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">!=</span> <span class="n">card_in</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">n</span><span class="p">).</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Television&quot;</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_TUNER_CAP_NORM</span> <span class="o">|</span>
			<span class="n">V4L2_TUNER_CAP_STEREO</span> <span class="o">|</span>
			<span class="n">V4L2_TUNER_CAP_LANG1</span> <span class="o">|</span>
			<span class="n">V4L2_TUNER_CAP_LANG2</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">rangehigh</span> <span class="o">=</span> <span class="mh">0xffffffffUL</span><span class="p">;</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">saa7134_tvaudio_getstereo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">saa7134_tvaudio_rx2mode</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">rxsubchans</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7134_STATUS_VIDEO1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx</span><span class="p">,</span> <span class="n">mode</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rx</span>   <span class="o">=</span> <span class="n">saa7134_tvaudio_getstereo</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">saa7134_tvaudio_rx2mode</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">?</span> <span class="n">V4L2_TUNER_RADIO</span> <span class="o">:</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
	<span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_freq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">v4l2_prio_check</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">tuner</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">&amp;&amp;</span> <span class="n">V4L2_TUNER_ANALOG_TV</span> <span class="o">!=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">&amp;&amp;</span> <span class="n">V4L2_TUNER_RADIO</span> <span class="o">!=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_freq</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>

	<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_frequency</span><span class="p">,</span> <span class="n">f</span><span class="p">);</span>

	<span class="n">saa7134_tvaudio_do_scan</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;audio&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_priority</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">v4l2_prio_max</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_priority</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">v4l2_priority</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l2_prio_change</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">prio</span><span class="p">,</span> <span class="n">prio</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">FORMATS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">formats</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">));</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">fourcc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_enum_fmt_vid_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_no_overlay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;V4L2_BUF_TYPE_VIDEO_OVERLAY: no_overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">FORMATS</span><span class="p">)</span> <span class="o">||</span> <span class="n">formats</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">planar</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">formats</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">));</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">fourcc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fb</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_FBUF_CAP_LIST_CLIPPING</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_s_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	   <span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* check args */</span>
	<span class="n">fmt</span> <span class="o">=</span> <span class="n">format_by_fourcc</span><span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">fmt</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* ok, accept it */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span> <span class="o">=</span> <span class="o">*</span><span class="n">fb</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovfmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ovbuf</span><span class="p">.</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="o">*</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">depth</span><span class="o">/</span><span class="mi">8</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_no_overlay</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;no_overlay</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">start_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_check</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">stop_preview</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">res_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESOURCE_OVERLAY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videobuf_reqbufs</span><span class="p">(</span><span class="n">saa7134_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videobuf_querybuf</span><span class="p">(</span><span class="n">saa7134_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videobuf_qbuf</span><span class="p">(</span><span class="n">saa7134_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">b</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">videobuf_dqbuf</span><span class="p">(</span><span class="n">saa7134_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">),</span> <span class="n">b</span><span class="p">,</span>
				<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">saa7134_resource</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res_get</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">res</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">videobuf_streamon</span><span class="p">(</span><span class="n">saa7134_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">saa7134_resource</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">videobuf_streamoff</span><span class="p">(</span><span class="n">saa7134_queue</span><span class="p">(</span><span class="n">fh</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">res_free</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_g_parm</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_register</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_register</span> <span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">&amp;</span><span class="mh">0xffffff</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;saa7134&quot;</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_TUNER</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">t</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>

	<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">g_tuner</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">amux</span> <span class="o">==</span> <span class="n">TV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="mh">0xf800</span> <span class="o">-</span> <span class="p">((</span><span class="n">saa_readb</span><span class="p">(</span><span class="mh">0x581</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">);</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="p">(</span><span class="n">saa_readb</span><span class="p">(</span><span class="mh">0x529</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">V4L2_TUNER_SUB_STEREO</span> <span class="o">:</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">fh</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">saa_call_all</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_tuner</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">i</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">);</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_TUNER</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_g_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">a</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_s_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">norm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">radio_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span>  <span class="n">V4L2_CID_BASE</span> <span class="o">||</span>
	    <span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_LASTP1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">V4L2_CID_AUDIO_MUTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">no_ctrl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">video_fops</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	  <span class="o">=</span> <span class="n">video_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>  <span class="o">=</span> <span class="n">video_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>	  <span class="o">=</span> <span class="n">video_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>     <span class="o">=</span> <span class="n">video_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>	  <span class="o">=</span> <span class="n">video_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>	  <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">video_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>		<span class="o">=</span> <span class="n">saa7134_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span>	<span class="o">=</span> <span class="n">saa7134_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span>		<span class="o">=</span> <span class="n">saa7134_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>		<span class="o">=</span> <span class="n">saa7134_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>		<span class="o">=</span> <span class="n">saa7134_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_overlay</span>	<span class="o">=</span> <span class="n">saa7134_enum_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_overlay</span>	<span class="o">=</span> <span class="n">saa7134_g_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_overlay</span>	<span class="o">=</span> <span class="n">saa7134_try_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_overlay</span>	<span class="o">=</span> <span class="n">saa7134_s_fmt_vid_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vbi_cap</span>		<span class="o">=</span> <span class="n">saa7134_try_get_set_fmt_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vbi_cap</span>		<span class="o">=</span> <span class="n">saa7134_try_get_set_fmt_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vbi_cap</span>		<span class="o">=</span> <span class="n">saa7134_try_get_set_fmt_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audio</span>			<span class="o">=</span> <span class="n">saa7134_g_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audio</span>			<span class="o">=</span> <span class="n">saa7134_s_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>			<span class="o">=</span> <span class="n">saa7134_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>			<span class="o">=</span> <span class="n">saa7134_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>		<span class="o">=</span> <span class="n">saa7134_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>			<span class="o">=</span> <span class="n">saa7134_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>			<span class="o">=</span> <span class="n">saa7134_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span>			<span class="o">=</span> <span class="n">saa7134_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_std</span>			<span class="o">=</span> <span class="n">saa7134_g_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>		<span class="o">=</span> <span class="n">saa7134_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>			<span class="o">=</span> <span class="n">saa7134_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>			<span class="o">=</span> <span class="n">saa7134_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>		<span class="o">=</span> <span class="n">saa7134_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>			<span class="o">=</span> <span class="n">saa7134_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>			<span class="o">=</span> <span class="n">saa7134_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>		<span class="o">=</span> <span class="n">saa7134_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>		<span class="o">=</span> <span class="n">saa7134_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>			<span class="o">=</span> <span class="n">saa7134_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>			<span class="o">=</span> <span class="n">saa7134_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_crop</span>			<span class="o">=</span> <span class="n">saa7134_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_crop</span>			<span class="o">=</span> <span class="n">saa7134_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fbuf</span>			<span class="o">=</span> <span class="n">saa7134_g_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fbuf</span>			<span class="o">=</span> <span class="n">saa7134_s_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_overlay</span>			<span class="o">=</span> <span class="n">saa7134_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_priority</span>		<span class="o">=</span> <span class="n">saa7134_g_priority</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_priority</span>		<span class="o">=</span> <span class="n">saa7134_s_priority</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_parm</span>			<span class="o">=</span> <span class="n">saa7134_g_parm</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span>		<span class="o">=</span> <span class="n">saa7134_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>		<span class="o">=</span> <span class="n">saa7134_s_frequency</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">vidioc_g_register</span>              <span class="o">=</span> <span class="n">vidioc_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_register</span>              <span class="o">=</span> <span class="n">vidioc_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">radio_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>	  <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>	  <span class="o">=</span> <span class="n">video_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>     <span class="o">=</span> <span class="n">radio_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>  <span class="o">=</span> <span class="n">video_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span>	  <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>     <span class="o">=</span> <span class="n">radio_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">radio_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>	<span class="o">=</span> <span class="n">radio_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>		<span class="o">=</span> <span class="n">radio_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>	<span class="o">=</span> <span class="n">radio_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audio</span>		<span class="o">=</span> <span class="n">radio_g_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>		<span class="o">=</span> <span class="n">radio_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audio</span>		<span class="o">=</span> <span class="n">radio_s_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>		<span class="o">=</span> <span class="n">radio_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span>		<span class="o">=</span> <span class="n">radio_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>	<span class="o">=</span> <span class="n">radio_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>		<span class="o">=</span> <span class="n">radio_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>		<span class="o">=</span> <span class="n">saa7134_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>		<span class="o">=</span> <span class="n">saa7134_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span>	<span class="o">=</span> <span class="n">saa7134_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>	<span class="o">=</span> <span class="n">saa7134_s_frequency</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ----------------------------------------------------------- */</span>
<span class="cm">/* exported stuff                                              */</span>

<span class="k">struct</span> <span class="n">video_device</span> <span class="n">saa7134_video_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>				<span class="o">=</span> <span class="s">&quot;saa7134-video&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>				<span class="o">=</span> <span class="o">&amp;</span><span class="n">video_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> 			<span class="o">=</span> <span class="o">&amp;</span><span class="n">video_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span>			<span class="o">=</span> <span class="n">SAA7134_NORMS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">current_norm</span>			<span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">video_device</span> <span class="n">saa7134_radio_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;saa7134-radio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fops</span>			<span class="o">=</span> <span class="o">&amp;</span><span class="n">radio_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span> 		<span class="o">=</span> <span class="o">&amp;</span><span class="n">radio_ioctl_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">saa7134_video_init1</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* sanitycheck insmod options */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gbuffers</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">gbuffers</span> <span class="o">&gt;</span> <span class="n">VIDEO_MAX_FRAME</span><span class="p">)</span>
		<span class="n">gbuffers</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gbufsize</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">gbufsize</span> <span class="o">&gt;</span> <span class="n">gbufsize_max</span><span class="p">)</span>
		<span class="n">gbufsize</span> <span class="o">=</span> <span class="n">gbufsize_max</span><span class="p">;</span>
	<span class="n">gbufsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">gbufsize</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">PAGE_MASK</span><span class="p">;</span>

	<span class="cm">/* put some sensible defaults into the data structures ... */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_bright</span>     <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span>   <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">V4L2_CID_CONTRAST</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_hue</span>        <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">V4L2_CID_HUE</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span> <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">V4L2_CID_SATURATION</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_volume</span>     <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">V4L2_CID_AUDIO_VOLUME</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span>       <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">// ctrl_by_id(V4L2_CID_AUDIO_MUTE)-&gt;default_value;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_invert</span>     <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">V4L2_CID_PRIVATE_INVERT</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_automute</span>   <span class="o">=</span> <span class="n">ctrl_by_id</span><span class="p">(</span><span class="n">V4L2_CID_PRIVATE_AUTOMUTE</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tda9887_conf</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_automute</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tda9887_conf</span> <span class="o">|=</span> <span class="n">TDA9887_AUTOMUTE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">queue</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">saa7134_buffer_timeout</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">timeout</span><span class="p">.</span><span class="n">data</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">dev</span>              <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">video_out</span><span class="p">)</span>
		<span class="n">saa7134_videoport_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_videoport_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* enable video output */</span>
	<span class="kt">int</span> <span class="n">vo</span> <span class="o">=</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">video_out</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">video_reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vid_port_opts</span> <span class="o">=</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">vid_port_opts</span><span class="p">;</span>

	<span class="cm">/* Configure videoport */</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL0</span><span class="p">,</span> <span class="n">video_out</span><span class="p">[</span><span class="n">vo</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">video_reg</span> <span class="o">=</span> <span class="n">video_out</span><span class="p">[</span><span class="n">vo</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vid_port_opts</span> <span class="o">&amp;</span> <span class="n">SET_T_CODE_POLARITY_NON_INVERTED</span><span class="p">)</span>
		<span class="n">video_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VP_T_CODE_P_INVERTED</span><span class="p">;</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL1</span><span class="p">,</span> <span class="n">video_reg</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL2</span><span class="p">,</span> <span class="n">video_out</span><span class="p">[</span><span class="n">vo</span><span class="p">][</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL4</span><span class="p">,</span> <span class="n">video_out</span><span class="p">[</span><span class="n">vo</span><span class="p">][</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">video_reg</span> <span class="o">=</span> <span class="n">video_out</span><span class="p">[</span><span class="n">vo</span><span class="p">][</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vid_port_opts</span> <span class="o">&amp;</span> <span class="n">SET_CLOCK_NOT_DELAYED</span><span class="p">)</span>
		<span class="n">video_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VP_CLK_CTRL2_DELAYED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vid_port_opts</span> <span class="o">&amp;</span> <span class="n">SET_CLOCK_INVERTED</span><span class="p">)</span>
		<span class="n">video_reg</span> <span class="o">|=</span> <span class="n">VP_CLK_CTRL1_INVERTED</span><span class="p">;</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL5</span><span class="p">,</span> <span class="n">video_reg</span><span class="p">);</span>
	<span class="n">video_reg</span> <span class="o">=</span> <span class="n">video_out</span><span class="p">[</span><span class="n">vo</span><span class="p">][</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vid_port_opts</span> <span class="o">&amp;</span> <span class="n">SET_VSYNC_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">video_reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">VP_VS_TYPE_MASK</span><span class="p">;</span>
		<span class="n">video_reg</span> <span class="o">|=</span> <span class="n">VP_VS_TYPE_OFF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL6</span><span class="p">,</span> <span class="n">video_reg</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL7</span><span class="p">,</span> <span class="n">video_out</span><span class="p">[</span><span class="n">vo</span><span class="p">][</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL8</span><span class="p">,</span> <span class="n">video_out</span><span class="p">[</span><span class="n">vo</span><span class="p">][</span><span class="mi">8</span><span class="p">]);</span>

	<span class="cm">/* Start videoport */</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_VIDEO_PORT_CTRL3</span><span class="p">,</span> <span class="n">video_out</span><span class="p">[</span><span class="n">vo</span><span class="p">][</span><span class="mi">3</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_video_init2</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* init video hw */</span>
	<span class="n">set_tvnorm</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tvnorms</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">video_mux</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">saa7134_tvaudio_setvolume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_volume</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_irq_video_signalchange</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">st</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;(no signal)&quot;</span><span class="p">,</span> <span class="s">&quot;NTSC&quot;</span><span class="p">,</span> <span class="s">&quot;PAL&quot;</span><span class="p">,</span> <span class="s">&quot;SECAM&quot;</span> <span class="p">};</span>
	<span class="n">u32</span> <span class="n">st1</span><span class="p">,</span><span class="n">st2</span><span class="p">;</span>

	<span class="n">st1</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7134_STATUS_VIDEO1</span><span class="p">);</span>
	<span class="n">st2</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7134_STATUS_VIDEO2</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;DCSDT: pll: %s, sync: %s, norm: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">st1</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;not locked&quot;</span> <span class="o">:</span> <span class="s">&quot;locked&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">st2</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;no&quot;</span>         <span class="o">:</span> <span class="s">&quot;yes&quot;</span><span class="p">,</span>
		<span class="n">st</span><span class="p">[</span><span class="n">st1</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">]);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nosignal</span> <span class="o">=</span> <span class="p">(</span><span class="n">st1</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">st2</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>  <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">st2</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nosignal</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no video signal -&gt; mute audio */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_automute</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* wake up tvaudio audio carrier scan thread */</span>
		<span class="n">saa7134_tvaudio_do_scan</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">st2</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">noninterlaced</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nosignal</span><span class="p">)</span>
		<span class="n">saa_clearb</span><span class="p">(</span><span class="n">SAA7134_SYNC_CTRL</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_SYNC_CTRL</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mops</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mops</span><span class="o">-&gt;</span><span class="n">signal_change</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mops</span><span class="o">-&gt;</span><span class="n">signal_change</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">saa7134_irq_video_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">v4l2_field</span> <span class="n">field</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_fieldcount</span><span class="o">++</span><span class="p">;</span>
		<span class="n">field</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_FIELD_HAS_BOTH</span><span class="p">(</span><span class="n">field</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* make sure we have seen both fields */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">top_seen</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">top_seen</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x10</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">field</span> <span class="o">==</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">.</span><span class="n">curr</span><span class="o">-&gt;</span><span class="n">vb</span><span class="p">.</span><span class="n">field_count</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_fieldcount</span><span class="p">;</span>
		<span class="n">saa7134_buffer_finish</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">,</span><span class="n">VIDEOBUF_DONE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">saa7134_buffer_next</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">video_q</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
