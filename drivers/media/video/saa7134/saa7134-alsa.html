<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › saa7134 › saa7134-alsa.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>saa7134-alsa.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *   SAA713x ALSA support for V4L</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *   it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *   the Free Software Foundation, version 2</span>
<span class="cm"> *</span>
<span class="cm"> *   This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *   but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *   GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *   You should have received a copy of the GNU General Public License</span>
<span class="cm"> *   along with this program; if not, write to the Free Software</span>
<span class="cm"> *   Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;sound/core.h&gt;</span>
<span class="cp">#include &lt;sound/control.h&gt;</span>
<span class="cp">#include &lt;sound/pcm.h&gt;</span>
<span class="cp">#include &lt;sound/pcm_params.h&gt;</span>
<span class="cp">#include &lt;sound/initval.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>

<span class="cp">#include &quot;saa7134.h&quot;</span>
<span class="cp">#include &quot;saa7134-reg.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span><span class="s">&quot;enable debug messages [alsa]&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Configuration macros</span>
<span class="cm"> */</span>

<span class="cm">/* defaults */</span>
<span class="cp">#define MIXER_ADDR_UNSELECTED	-1</span>
<span class="cp">#define MIXER_ADDR_TVTUNER	0</span>
<span class="cp">#define MIXER_ADDR_LINE1	1</span>
<span class="cp">#define MIXER_ADDR_LINE2	2</span>
<span class="cp">#define MIXER_ADDR_LAST		2</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">index</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_IDX</span><span class="p">;</span>	<span class="cm">/* Index 0-MAX */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">id</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="n">SNDRV_DEFAULT_STR</span><span class="p">;</span>	<span class="cm">/* ID for this card */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span> <span class="p">...</span> <span class="p">(</span><span class="n">SNDRV_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">};</span>

<span class="n">module_param_array</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="s">&quot;Index value for SAA7134 capture interface(s).&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">enable</span><span class="p">,</span> <span class="s">&quot;Enable (or not) the SAA7134 capture interface(s).&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(fmt, arg...)    if (debug) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s/alsa: &quot; fmt, dev-&gt;name , ##arg)</span>



<span class="cm">/*</span>
<span class="cm"> * Main chip structure</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">snd_card_saa7134</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">spinlock_t</span> <span class="n">mixer_lock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mixer_volume</span><span class="p">[</span><span class="n">MIXER_ADDR_LAST</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">capture_source_addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">capture_source</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">capture_ctl</span><span class="p">[</span><span class="n">MIXER_ADDR_LAST</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iobase</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">mute_was_on</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
<span class="p">}</span> <span class="n">snd_card_saa7134_t</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * PCM structure</span>
<span class="cm"> */</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">snd_card_saa7134_pcm</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">;</span>
<span class="p">}</span> <span class="n">snd_card_saa7134_pcm_t</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">snd_saa7134_cards</span><span class="p">[</span><span class="n">SNDRV_CARDS</span><span class="p">];</span>


<span class="cm">/*</span>
<span class="cm"> * saa7134 DMA audio stop</span>
<span class="cm"> *</span>
<span class="cm"> *   Called when the capture device is released or the buffer overflows</span>
<span class="cm"> *</span>
<span class="cm"> *   - Copied verbatim from saa7134-oss&#39;s dsp_dma_stop.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7134_dma_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_blk</span>     <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_running</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">saa7134_set_dmabits</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * saa7134 DMA audio start</span>
<span class="cm"> *</span>
<span class="cm"> *   Called when preparing the capture device for use</span>
<span class="cm"> *</span>
<span class="cm"> *   - Copied verbatim from saa7134-oss&#39;s dsp_dma_start.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7134_dma_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_blk</span>     <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">saa7134_set_dmabits</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * saa7134 audio DMA IRQ handler</span>
<span class="cm"> *</span>
<span class="cm"> *   Called whenever we get an SAA7134_IRQ_REPORT_DONE_RA3 interrupt</span>
<span class="cm"> *   Handles shifting between the 2 buffers, manages the read counters,</span>
<span class="cm"> *  and notifies ALSA when periods elapse</span>
<span class="cm"> *</span>
<span class="cm"> *   - Mostly copied from saa7134-oss&#39;s saa7134_irq_oss_done.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7134_irq_alsa_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">next_blk</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_blk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;irq: recording stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x0f000000</span><span class="p">))</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;irq: lost %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* odd */</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_blk</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* even */</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_blk</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">=</span> <span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;irq: field oops [%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;even&quot;</span> <span class="o">:</span> <span class="s">&quot;odd&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_count</span> <span class="o">&gt;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span> <span class="o">*</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blocks</span><span class="o">-</span><span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;irq: overrun [full=%d/%d] - Blocks in %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_count</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bufsize</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blocks</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">snd_pcm_stop</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">substream</span><span class="p">,</span><span class="n">SNDRV_PCM_STATE_XRUN</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* next block addr */</span>
	<span class="n">next_blk</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_blk</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">%</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blocks</span><span class="p">;</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">next_blk</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;irq: ok, %s, next_blk=%d, addr=%x, blocks=%u, size=%u, read=%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x10000000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;even&quot;</span> <span class="o">:</span> <span class="s">&quot;odd &quot;</span><span class="p">,</span> <span class="n">next_blk</span><span class="p">,</span>
			<span class="n">next_blk</span> <span class="o">*</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blocks</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_count</span><span class="p">);</span>

	<span class="cm">/* update status &amp; wake waiting readers */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_blk</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma_blk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blocks</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_count</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">recording_on</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_count</span> <span class="o">&gt;=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">substream</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
		<span class="n">snd_pcm_period_elapsed</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">substream</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IRQ request handler</span>
<span class="cm"> *</span>
<span class="cm"> *   Runs along with saa7134&#39;s IRQ handler, discards anything that isn&#39;t</span>
<span class="cm"> *   DMA sound</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">saa7134_alsa_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dmasound</span> <span class="o">*</span><span class="n">dmasound</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dmasound</span><span class="o">-&gt;</span><span class="n">priv_data</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">report</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">loop</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">report</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_IRQ_REPORT</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_IRQ_STATUS</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">report</span> <span class="o">&amp;</span> <span class="n">SAA7134_IRQ_REPORT_DONE_RA3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_IRQ_REPORT</span><span class="p">,</span>
				   <span class="n">SAA7134_IRQ_REPORT_DONE_RA3</span><span class="p">);</span>
			<span class="n">saa7134_irq_alsa_done</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;error! looping IRQ!&quot;</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA capture trigger</span>
<span class="cm"> *</span>
<span class="cm"> *   - One of the ALSA capture callbacks.</span>
<span class="cm"> *</span>
<span class="cm"> *   Called whenever a capture is started or stopped. Must be defined,</span>
<span class="cm"> *   but there&#39;s nothing we want to do here</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_card_saa7134_capture_trigger</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span> <span class="n">substream</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_card_saa7134_pcm_t</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_START</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* start dma */</span>
		<span class="n">saa7134_dma_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SNDRV_PCM_TRIGGER_STOP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* stop dma */</span>
		<span class="n">saa7134_dma_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DMA buffer initialization</span>
<span class="cm"> *</span>
<span class="cm"> *   Uses V4L functions to initialize the DMA. Shouldn&#39;t be necessary in</span>
<span class="cm"> *  ALSA, but I was unable to use ALSA&#39;s own DMA, and had to force the</span>
<span class="cm"> *  usage of V4L&#39;s</span>
<span class="cm"> *</span>
<span class="cm"> *   - Copied verbatim from saa7134-oss.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsp_buffer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bufsize</span><span class="p">);</span>

	<span class="n">videobuf_dma_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">videobuf_dma_init_kernel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">,</span>
				       <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bufsize</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DMA buffer release</span>
<span class="cm"> *</span>
<span class="cm"> *   Called after closing the device, during snd_card_saa7134_capture_close</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dsp_buffer_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span><span class="p">);</span>

	<span class="n">videobuf_dma_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blocks</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bufsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setting the capture source and updating the ALSA controls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_saa7134_capsrc_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="kt">int</span> <span class="n">right</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force_notify</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">active</span><span class="p">,</span> <span class="n">old_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">anabar</span><span class="p">,</span> <span class="n">xbarin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">analog_io</span><span class="p">,</span> <span class="n">rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">);</span>

	<span class="n">active</span> <span class="o">=</span> <span class="n">left</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">right</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">old_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source_addr</span><span class="p">;</span>

	<span class="cm">/* The active capture source cannot be deactivated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="n">old_addr</span> <span class="o">!=</span> <span class="n">addr</span> <span class="o">||</span>
			 <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">left</span> <span class="o">||</span>
			 <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">right</span><span class="p">;</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">input</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MIXER_ADDR_TVTUNER</span>:
				<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_FORMAT_CTRL</span><span class="p">,</span>
					   <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">);</span>
				<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_SIF_SAMPLE_FREQ</span><span class="p">,</span>
					   <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MIXER_ADDR_LINE1</span>:
			<span class="k">case</span> <span class="n">MIXER_ADDR_LINE2</span>:
				<span class="n">analog_io</span> <span class="o">=</span> <span class="p">(</span><span class="n">MIXER_ADDR_LINE1</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="o">?</span>
					     <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x08</span><span class="p">;</span>
				<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="mi">32000</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">rate</span><span class="p">)</span> <span class="o">?</span>
					<span class="mh">0x01</span> <span class="o">:</span> <span class="mh">0x03</span><span class="p">;</span>
				<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IO_SELECT</span><span class="p">,</span>
					   <span class="mh">0x08</span><span class="p">,</span> <span class="n">analog_io</span><span class="p">);</span>
				<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_FORMAT_CTRL</span><span class="p">,</span>
					   <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
				<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_SIF_SAMPLE_FREQ</span><span class="p">,</span>
					   <span class="mh">0x03</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7133</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7135</span>:
			<span class="n">xbarin</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span> <span class="cm">/* adc */</span>
			<span class="n">anabar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">MIXER_ADDR_TVTUNER</span>:
				<span class="n">xbarin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Demodulator */</span>
				<span class="n">anabar</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="cm">/* DACs */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MIXER_ADDR_LINE1</span>:
				<span class="n">anabar</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* aux1, aux1 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">MIXER_ADDR_LINE2</span>:
				<span class="n">anabar</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>  <span class="cm">/* aux2, aux2 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* output xbar always main channel */</span>
			<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7133_DIGITAL_OUTPUT_SEL1</span><span class="p">,</span>
				       <span class="mh">0xbbbb10</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">||</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* We&#39;ve got data, turn the input on */</span>
				<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7133_DIGITAL_INPUT_XBAR1</span><span class="p">,</span>
					       <span class="n">xbarin</span><span class="p">);</span>
				<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7133_ANALOG_IO_SELECT</span><span class="p">,</span> <span class="n">anabar</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7133_DIGITAL_INPUT_XBAR1</span><span class="p">,</span>
					       <span class="mi">0</span><span class="p">);</span>
				<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7133_ANALOG_IO_SELECT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">force_notify</span><span class="p">)</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				       <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_ctl</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">old_addr</span> <span class="o">!=</span> <span class="n">MIXER_ADDR_UNSELECTED</span> <span class="o">&amp;&amp;</span> <span class="n">old_addr</span> <span class="o">!=</span> <span class="n">addr</span><span class="p">)</span>
			<span class="n">snd_ctl_notify</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				       <span class="n">SNDRV_CTL_EVENT_MASK_VALUE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_ctl</span><span class="p">[</span><span class="n">old_addr</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA PCM preparation</span>
<span class="cm"> *</span>
<span class="cm"> *   - One of the ALSA capture callbacks.</span>
<span class="cm"> *</span>
<span class="cm"> *   Called right after the capture device is opened, this function configures</span>
<span class="cm"> *  the buffer using the previously defined functions, allocates the memory,</span>
<span class="cm"> *  sets up the hardware registers, and then starts the DMA. When this function</span>
<span class="cm"> *  returns, the audio should be flowing.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_card_saa7134_capture_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span> <span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bswap</span><span class="p">,</span> <span class="n">sign</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">control</span><span class="p">;</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">saa7134</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">snd_card_saa7134_pcm_t</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_width</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fmt</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_signed</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">))</span>
		<span class="n">sign</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sign</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">snd_pcm_format_big_endian</span><span class="p">(</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">))</span>
		<span class="n">bswap</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">bswap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	  <span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>

		<span class="n">fmt</span> <span class="o">|=</span> <span class="p">(</span><span class="n">MIXER_ADDR_TVTUNER</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">input</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xc0</span> <span class="o">:</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_NUM_SAMPLES0</span><span class="p">,</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0000ff</span><span class="p">));</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_NUM_SAMPLES1</span><span class="p">,</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_NUM_SAMPLES2</span><span class="p">,</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_FORMAT_CTRL</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>
	  <span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7133</span>:
	  <span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7135</span>:
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">==</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sign</span><span class="p">)</span>
			<span class="n">fmt</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7133_NUM_SAMPLES</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7133_AUDIO_CHANNEL</span><span class="p">,</span> <span class="mh">0x543210</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;rec_start: afmt=%d ch=%d  =&gt;  fmt=0x%x swap=%c</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span>
		<span class="n">bswap</span> <span class="o">?</span> <span class="sc">&#39;b&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">);</span>
	<span class="cm">/* dma: setup channel 6 (= AUDIO) */</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">SAA7134_RS_CONTROL_BURST_16</span> <span class="o">|</span>
		<span class="n">SAA7134_RS_CONTROL_ME</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">pt</span><span class="p">.</span><span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bswap</span><span class="p">)</span>
		<span class="n">control</span> <span class="o">|=</span> <span class="n">SAA7134_RS_CONTROL_BSWAP</span><span class="p">;</span>

	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA1</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_BA2</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_PITCH</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_RS_CONTROL</span><span class="p">(</span><span class="mi">6</span><span class="p">),</span><span class="n">control</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* Setup and update the card/ALSA controls */</span>
	<span class="n">snd_saa7134_capsrc_set</span><span class="p">(</span><span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">capture_ctl</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">input</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA pointer fetching</span>
<span class="cm"> *</span>
<span class="cm"> *   - One of the ALSA capture callbacks.</span>
<span class="cm"> *</span>
<span class="cm"> *   Called whenever a period elapses, it must return the current hardware</span>
<span class="cm"> *  position of the buffer.</span>
<span class="cm"> *   Also resets the read counter used to prevent overruns</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">snd_pcm_uframes_t</span>
<span class="nf">snd_card_saa7134_capture_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span> <span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_card_saa7134_pcm_t</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="o">=</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_count</span>  <span class="o">-=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_offset</span> <span class="o">+=</span> <span class="n">snd_pcm_lib_period_bytes</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_offset</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bufsize</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">bytes_to_frames</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA hardware capabilities definition</span>
<span class="cm"> *</span>
<span class="cm"> *  Report only 32kHz for ALSA:</span>
<span class="cm"> *</span>
<span class="cm"> *  - SAA7133/35 uses DDEP (DemDec Easy Programming mode), which works in 32kHz</span>
<span class="cm"> *    only</span>
<span class="cm"> *  - SAA7134 for TV mode uses DemDec mode (32kHz)</span>
<span class="cm"> *  - Radio works in 32kHz only</span>
<span class="cm"> *  - When recording 48kHz from Line1/Line2, switching of capture source to TV</span>
<span class="cm"> *    means</span>
<span class="cm"> *    switching to 32kHz without any frequency translation</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_hardware</span> <span class="n">snd_card_saa7134_capture</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">info</span> <span class="o">=</span>                 <span class="p">(</span><span class="n">SNDRV_PCM_INFO_MMAP</span> <span class="o">|</span> <span class="n">SNDRV_PCM_INFO_INTERLEAVED</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_BLOCK_TRANSFER</span> <span class="o">|</span>
				 <span class="n">SNDRV_PCM_INFO_MMAP_VALID</span><span class="p">),</span>
	<span class="p">.</span><span class="n">formats</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_FMTBIT_S16_LE</span> <span class="o">|</span> \
				<span class="n">SNDRV_PCM_FMTBIT_S16_BE</span> <span class="o">|</span> \
				<span class="n">SNDRV_PCM_FMTBIT_S8</span> <span class="o">|</span> \
				<span class="n">SNDRV_PCM_FMTBIT_U8</span> <span class="o">|</span> \
				<span class="n">SNDRV_PCM_FMTBIT_U16_LE</span> <span class="o">|</span> \
				<span class="n">SNDRV_PCM_FMTBIT_U16_BE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rates</span> <span class="o">=</span>		<span class="n">SNDRV_PCM_RATE_32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_min</span> <span class="o">=</span>		<span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_max</span> <span class="o">=</span>		<span class="mi">32000</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_min</span> <span class="o">=</span>		<span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels_max</span> <span class="o">=</span>		<span class="mi">2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">buffer_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">period_bytes_min</span> <span class="o">=</span>	<span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">period_bytes_max</span> <span class="o">=</span>	<span class="p">(</span><span class="mi">256</span><span class="o">*</span><span class="mi">1024</span><span class="p">),</span>
	<span class="p">.</span><span class="n">periods_min</span> <span class="o">=</span>		<span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">periods_max</span> <span class="o">=</span>		<span class="mi">1024</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_card_saa7134_runtime_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_saa7134_pcm_t</span> <span class="o">*</span><span class="n">pcm</span> <span class="o">=</span> <span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pcm</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * ALSA hardware params</span>
<span class="cm"> *</span>
<span class="cm"> *   - One of the ALSA capture callbacks.</span>
<span class="cm"> *</span>
<span class="cm"> *   Called on initialization, right before the PCM preparation</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_card_saa7134_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span> <span class="n">substream</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">snd_pcm_hw_params</span> <span class="o">*</span> <span class="n">hw_params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">saa7134</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">period_size</span><span class="p">,</span> <span class="n">periods</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">period_size</span> <span class="o">=</span> <span class="n">params_period_bytes</span><span class="p">(</span><span class="n">hw_params</span><span class="p">);</span>
	<span class="n">periods</span> <span class="o">=</span> <span class="n">params_periods</span><span class="p">(</span><span class="n">hw_params</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">period_size</span> <span class="o">&lt;</span> <span class="mh">0x100</span> <span class="o">||</span> <span class="n">period_size</span> <span class="o">&gt;</span> <span class="mh">0x10000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">periods</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">period_size</span> <span class="o">*</span> <span class="n">periods</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blocks</span> <span class="o">==</span> <span class="n">periods</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span> <span class="o">==</span> <span class="n">period_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* release the old buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7134_pgtable_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">pt</span><span class="p">);</span>
		<span class="n">videobuf_dma_unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">dsp_buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blocks</span>  <span class="o">=</span> <span class="n">periods</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span> <span class="o">=</span> <span class="n">period_size</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">period_size</span> <span class="o">*</span> <span class="n">periods</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">dsp_buffer_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blocks</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">blksize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bufsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">videobuf_dma_map</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">dsp_buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">saa7134_pgtable_alloc</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">pt</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">videobuf_dma_unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">dsp_buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">err</span> <span class="o">=</span> <span class="n">saa7134_pgtable_build</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">pt</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">.</span><span class="n">sglist</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">.</span><span class="n">sglen</span><span class="p">,</span>
						<span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">saa7134_pgtable_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">pt</span><span class="p">);</span>
		<span class="n">videobuf_dma_unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">dsp_buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* I should be able to use runtime-&gt;dma_addr in the control</span>
<span class="cm">	   byte, but it doesn&#39;t work. So I allocate the DMA using the</span>
<span class="cm">	   V4L functions, and force ALSA to use that as the DMA area */</span>

	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">.</span><span class="n">vaddr</span><span class="p">;</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_bytes</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">bufsize</span><span class="p">;</span>
	<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA hardware release</span>
<span class="cm"> *</span>
<span class="cm"> *   - One of the ALSA capture callbacks.</span>
<span class="cm"> *</span>
<span class="cm"> *   Called after closing the device, but before snd_card_saa7134_capture_close</span>
<span class="cm"> *   It stops the DMA audio and releases the buffers.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_card_saa7134_hw_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span> <span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">saa7134</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7134_pgtable_free</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">pt</span><span class="p">);</span>
		<span class="n">videobuf_dma_unmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">dma</span><span class="p">);</span>
		<span class="n">dsp_buffer_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA capture finish</span>
<span class="cm"> *</span>
<span class="cm"> *   - One of the ALSA capture callbacks.</span>
<span class="cm"> *</span>
<span class="cm"> *   Called after closing the device.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_card_saa7134_capture_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span> <span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">saa7134</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">mute_was_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA capture start</span>
<span class="cm"> *</span>
<span class="cm"> *   - One of the ALSA capture callbacks.</span>
<span class="cm"> *</span>
<span class="cm"> *   Called when opening the device. It creates and populates the PCM</span>
<span class="cm"> *  structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_card_saa7134_capture_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span> <span class="n">substream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm_runtime</span> <span class="o">*</span><span class="n">runtime</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="p">;</span>
	<span class="n">snd_card_saa7134_pcm_t</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">saa7134</span> <span class="o">=</span> <span class="n">snd_pcm_substream_chip</span><span class="p">(</span><span class="n">substream</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">amux</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saa7134</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;BUG: saa7134 can&#39;t find device struct.&quot;</span>
				<span class="s">&quot; Can&#39;t proceed with open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_count</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">read_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">amux</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">amux</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">amux</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">amux</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">amux</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">input</span>  <span class="o">=</span>  <span class="n">amux</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pcm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pcm</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">=</span><span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">substream</span> <span class="o">=</span> <span class="n">substream</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">pcm</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_card_saa7134_runtime_free</span><span class="p">;</span>
	<span class="n">runtime</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">snd_card_saa7134_capture</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">mute_was_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_integer</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span>
						<span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_hw_constraint_step</span><span class="p">(</span><span class="n">runtime</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">SNDRV_PCM_HW_PARAM_PERIODS</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * page callback (needed for mmap)</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="nf">snd_card_saa7134_page</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_pcm_substream</span> <span class="o">*</span><span class="n">substream</span><span class="p">,</span>
					<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pageptr</span> <span class="o">=</span> <span class="n">substream</span><span class="o">-&gt;</span><span class="n">runtime</span><span class="o">-&gt;</span><span class="n">dma_area</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">vmalloc_to_page</span><span class="p">(</span><span class="n">pageptr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA capture callbacks definition</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_pcm_ops</span> <span class="n">snd_card_saa7134_capture_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span>			<span class="n">snd_card_saa7134_capture_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span>		<span class="n">snd_card_saa7134_capture_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span>		<span class="n">snd_pcm_lib_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_params</span> <span class="o">=</span>		<span class="n">snd_card_saa7134_hw_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_free</span> <span class="o">=</span>		<span class="n">snd_card_saa7134_hw_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span>		<span class="n">snd_card_saa7134_capture_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">trigger</span> <span class="o">=</span>		<span class="n">snd_card_saa7134_capture_trigger</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pointer</span> <span class="o">=</span>		<span class="n">snd_card_saa7134_capture_pointer</span><span class="p">,</span>
	<span class="p">.</span><span class="n">page</span> <span class="o">=</span>			<span class="n">snd_card_saa7134_page</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA PCM setup</span>
<span class="cm"> *</span>
<span class="cm"> *   Called when initializing the board. Sets up the name and hooks up</span>
<span class="cm"> *  the callbacks</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_card_saa7134_pcm</span><span class="p">(</span><span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">saa7134</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_pcm</span> <span class="o">*</span><span class="n">pcm</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_pcm_new</span><span class="p">(</span><span class="n">saa7134</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;SAA7134 PCM&quot;</span><span class="p">,</span> <span class="n">device</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcm</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">snd_pcm_set_ops</span><span class="p">(</span><span class="n">pcm</span><span class="p">,</span> <span class="n">SNDRV_PCM_STREAM_CAPTURE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">snd_card_saa7134_capture_ops</span><span class="p">);</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">saa7134</span><span class="p">;</span>
	<span class="n">pcm</span><span class="o">-&gt;</span><span class="n">info_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;SAA7134 PCM&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SAA713x_VOLUME(xname, xindex, addr) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_saa7134_volume_info, \</span>
<span class="cp">  .get = snd_saa7134_volume_get, .put = snd_saa7134_volume_put, \</span>
<span class="cp">  .private_value = addr }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_saa7134_volume_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span> <span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span> <span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_INTEGER</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_saa7134_volume_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span> <span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span> <span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_volume</span><span class="p">[</span><span class="n">addr</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_volume</span><span class="p">[</span><span class="n">addr</span><span class="p">][</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_saa7134_volume_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span> <span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span> <span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">change</span><span class="p">,</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>

	<span class="n">left</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">left</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">right</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">right</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">right</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">);</span>
	<span class="n">change</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_volume</span><span class="p">[</span><span class="n">addr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">left</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">right</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_volume</span><span class="p">[</span><span class="n">addr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">right</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">change</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">left</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">MIXER_ADDR_TVTUNER</span>:
						<span class="n">left</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">MIXER_ADDR_LINE1</span>:
						<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IO_SELECT</span><span class="p">,</span>  <span class="mh">0x10</span><span class="p">,</span>
							   <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x10</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">MIXER_ADDR_LINE2</span>:
						<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IO_SELECT</span><span class="p">,</span>  <span class="mh">0x20</span><span class="p">,</span>
							   <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7133</span>:
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7135</span>:
				<span class="k">switch</span> <span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">case</span> <span class="n">MIXER_ADDR_TVTUNER</span>:
						<span class="n">left</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">MIXER_ADDR_LINE1</span>:
						<span class="n">saa_andorb</span><span class="p">(</span><span class="mh">0x0594</span><span class="p">,</span>  <span class="mh">0x10</span><span class="p">,</span>
							   <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x10</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">MIXER_ADDR_LINE2</span>:
						<span class="n">saa_andorb</span><span class="p">(</span><span class="mh">0x0594</span><span class="p">,</span>  <span class="mh">0x20</span><span class="p">,</span>
							   <span class="p">(</span><span class="n">left</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x20</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_volume</span><span class="p">[</span><span class="n">addr</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">left</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_volume</span><span class="p">[</span><span class="n">addr</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">right</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">change</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SAA713x_CAPSRC(xname, xindex, addr) \</span>
<span class="cp">{ .iface = SNDRV_CTL_ELEM_IFACE_MIXER, .name = xname, .index = xindex, \</span>
<span class="cp">  .info = snd_saa7134_capsrc_info, \</span>
<span class="cp">  .get = snd_saa7134_capsrc_get, .put = snd_saa7134_capsrc_put, \</span>
<span class="cp">  .private_value = addr }</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_saa7134_capsrc_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span> <span class="n">kcontrol</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">snd_ctl_elem_info</span> <span class="o">*</span> <span class="n">uinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SNDRV_CTL_ELEM_TYPE_BOOLEAN</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">uinfo</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_saa7134_capsrc_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span> <span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span> <span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">snd_kcontrol_chip</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="o">-&gt;</span><span class="n">private_value</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source_addr</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_saa7134_capsrc_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span> <span class="n">kcontrol</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">snd_ctl_elem_value</span> <span class="o">*</span> <span class="n">ucontrol</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">ucontrol</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">.</span><span class="n">integer</span><span class="p">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">snd_saa7134_capsrc_set</span><span class="p">(</span><span class="n">kcontrol</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_saa7134_volume_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SAA713x_VOLUME</span><span class="p">(</span><span class="s">&quot;Video Volume&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MIXER_ADDR_TVTUNER</span><span class="p">),</span>
<span class="n">SAA713x_VOLUME</span><span class="p">(</span><span class="s">&quot;Line Volume&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MIXER_ADDR_LINE1</span><span class="p">),</span>
<span class="n">SAA713x_VOLUME</span><span class="p">(</span><span class="s">&quot;Line Volume&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MIXER_ADDR_LINE2</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">snd_kcontrol_new</span> <span class="n">snd_saa7134_capture_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="n">SAA713x_CAPSRC</span><span class="p">(</span><span class="s">&quot;Video Capture Switch&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MIXER_ADDR_TVTUNER</span><span class="p">),</span>
<span class="n">SAA713x_CAPSRC</span><span class="p">(</span><span class="s">&quot;Line Capture Switch&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">MIXER_ADDR_LINE1</span><span class="p">),</span>
<span class="n">SAA713x_CAPSRC</span><span class="p">(</span><span class="s">&quot;Line Capture Switch&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">MIXER_ADDR_LINE2</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA mixer setup</span>
<span class="cm"> *</span>
<span class="cm"> *   Called when initializing the board. Sets up the name and hooks up</span>
<span class="cm"> *  the callbacks</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">snd_card_saa7134_new_mixer</span><span class="p">(</span><span class="n">snd_card_saa7134_t</span> <span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">snd_kcontrol</span> <span class="o">*</span><span class="n">kcontrol</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">addr</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mixername</span><span class="p">,</span> <span class="s">&quot;SAA7134 Mixer&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_saa7134_volume_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kcontrol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_saa7134_volume_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
					<span class="n">chip</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">snd_saa7134_capture_controls</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kcontrol</span> <span class="o">=</span> <span class="n">snd_ctl_new1</span><span class="p">(</span><span class="o">&amp;</span><span class="n">snd_saa7134_capture_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span>
					<span class="n">chip</span><span class="p">);</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">snd_saa7134_capture_controls</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">private_value</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_ctl</span><span class="p">[</span><span class="n">addr</span><span class="p">]</span> <span class="o">=</span> <span class="n">kcontrol</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">snd_ctl_add</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">kcontrol</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">capture_source_addr</span> <span class="o">=</span> <span class="n">MIXER_ADDR_UNSELECTED</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">snd_saa7134_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span> <span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">priv_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">priv_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ALSA initialization</span>
<span class="cm"> *</span>
<span class="cm"> *   Called by the init routine, once for each saa7134 device present,</span>
<span class="cm"> *  it creates the basic structures and registers the ALSA devices</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alsa_card_saa7134_create</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">devnum</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">snd_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="n">snd_card_saa7134_t</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">devnum</span> <span class="o">&gt;=</span> <span class="n">SNDRV_CARDS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">[</span><span class="n">devnum</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_create</span><span class="p">(</span><span class="n">index</span><span class="p">[</span><span class="n">devnum</span><span class="p">],</span> <span class="n">id</span><span class="p">[</span><span class="n">devnum</span><span class="p">],</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
			      <span class="k">sizeof</span><span class="p">(</span><span class="n">snd_card_saa7134_t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;SAA7134&quot;</span><span class="p">);</span>

	<span class="cm">/* Card &quot;creation&quot; */</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">private_free</span> <span class="o">=</span> <span class="n">snd_saa7134_free</span><span class="p">;</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mixer_lock</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">saa7134_alsa_irq</span><span class="p">,</span>
				<span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t get IRQ %d for ALSA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">__nodev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_saa7134_new_mixer</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__nodev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_saa7134_pcm</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">__nodev</span><span class="p">;</span>

	<span class="n">snd_card_set_dev</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* End of &quot;creation&quot; */</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">shortname</span><span class="p">,</span> <span class="s">&quot;SAA7134&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span> <span class="s">&quot;%s at 0x%lx irq %d&quot;</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">iobase</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s/alsa: %s registered as card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">longname</span><span class="p">,</span><span class="n">index</span><span class="p">[</span><span class="n">devnum</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">snd_card_register</span><span class="p">(</span><span class="n">card</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_saa7134_cards</span><span class="p">[</span><span class="n">devnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">__nodev:</span>
	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">alsa_device_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dmasound</span><span class="p">.</span><span class="n">priv_data</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">alsa_card_saa7134_create</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">alsa_device_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">snd_card_free</span><span class="p">(</span><span class="n">snd_saa7134_cards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]);</span>
	<span class="n">snd_saa7134_cards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Module initializer</span>
<span class="cm"> *</span>
<span class="cm"> * Loops through present saa7134 cards, and assigns an ALSA device</span>
<span class="cm"> * to each one</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_alsa_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>

	<span class="n">saa7134_dmasound_init</span> <span class="o">=</span> <span class="n">alsa_device_init</span><span class="p">;</span>
	<span class="n">saa7134_dmasound_exit</span> <span class="o">=</span> <span class="n">alsa_device_exit</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;saa7134 ALSA driver for DMA sound loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">list</span><span class="p">,</span><span class="o">&amp;</span><span class="n">saa7134_devlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_dev</span><span class="p">,</span> <span class="n">devlist</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7130</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s/alsa: %s doesn&#39;t support digital audio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">alsa_device_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;saa7134 ALSA: no saa7134 cards found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Module destructor</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7134_alsa_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">SNDRV_CARDS</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snd_card_free</span><span class="p">(</span><span class="n">snd_saa7134_cards</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">saa7134_dmasound_init</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">saa7134_dmasound_exit</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;saa7134 ALSA driver for DMA sound unloaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We initialize this late, to make sure the sound system is up and running */</span>
<span class="n">late_initcall</span><span class="p">(</span><span class="n">saa7134_alsa_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">saa7134_alsa_exit</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ricardo Cerqueira&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
