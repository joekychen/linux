<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › saa7134 › saa7134-tvaudio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>saa7134-tvaudio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * device driver for philips saa7134 based TV cards</span>
<span class="cm"> * tv audio decoder (fm stereo, nicam, ...)</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 2001-03 Gerd Knorr &lt;kraxel@bytesex.org&gt; [SuSE Labs]</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#include &quot;saa7134-reg.h&quot;</span>
<span class="cp">#include &quot;saa7134.h&quot;</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">audio_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">audio_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">audio_debug</span><span class="p">,</span><span class="s">&quot;enable debug messages [tv audio]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">audio_ddep</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">audio_ddep</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">audio_ddep</span><span class="p">,</span><span class="s">&quot;audio ddep overwrite&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">audio_clock_override</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">audio_clock_override</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">audio_clock_tweak</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">audio_clock_tweak</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">audio_clock_tweak</span><span class="p">,</span> <span class="s">&quot;Audio clock tick fine tuning for cards with audio crystal that&#39;s slightly off (range [-1024 .. 1024])&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(fmt, arg...)	if (audio_debug) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s/audio: &quot; fmt, dev-&gt;name , ## arg)</span>
<span class="cp">#define d2printk(fmt, arg...)	if (audio_debug &gt; 1) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s/audio: &quot; fmt, dev-&gt;name, ## arg)</span>

<span class="cp">#define print_regb(reg) printk(&quot;%s:   reg 0x%03x [%-16s]: 0x%02x\n&quot;, \</span>
<span class="cp">		dev-&gt;name,(SAA7134_##reg),(#reg),saa_readb((SAA7134_##reg)))</span>

<span class="cm">/* msecs */</span>
<span class="cp">#define SCAN_INITIAL_DELAY     1000</span>
<span class="cp">#define SCAN_SAMPLE_DELAY       200</span>
<span class="cp">#define SCAN_SUBCARRIER_DELAY  2000</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* saa7134 code                                                       */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">mainscan</span> <span class="p">{</span>
	<span class="kt">char</span>         <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span>  <span class="n">std</span><span class="p">;</span>
	<span class="kt">int</span>          <span class="n">carr</span><span class="p">;</span>
<span class="p">}</span> <span class="n">mainscan</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MN&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>  <span class="o">=</span> <span class="n">V4L2_STD_MN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr</span> <span class="o">=</span> <span class="mi">4500</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BGH&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>  <span class="o">=</span> <span class="n">V4L2_STD_B</span> <span class="o">|</span> <span class="n">V4L2_STD_GH</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr</span> <span class="o">=</span> <span class="mi">5500</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;I&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>  <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr</span> <span class="o">=</span> <span class="mi">6000</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;DKL&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>  <span class="o">=</span> <span class="n">V4L2_STD_DK</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_L</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr</span> <span class="o">=</span> <span class="mi">6500</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">saa7134_tvaudio</span> <span class="n">tvaudio</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-B/G FM-stereo&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_FM_BG_STEREO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">5500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">5742</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-D/K1 FM-stereo&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">6500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">6258</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_FM_BG_STEREO</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-D/K2 FM-stereo&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">6500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">6742</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_FM_BG_STEREO</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-D/K3 FM-stereo&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">6500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">5742</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_FM_BG_STEREO</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-B/G NICAM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_PAL_BG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">5500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">5850</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_NICAM_FM</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-I NICAM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">6000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">6552</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_NICAM_FM</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;PAL-D/K NICAM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">6500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">5850</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_NICAM_FM</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;SECAM-L NICAM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">6500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">5850</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_NICAM_AM</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;SECAM-D/K NICAM&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_SECAM_DK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">6500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">5850</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_NICAM_FM</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;NTSC-A2 FM-stereo&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">4500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="mi">4724</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_FM_K_STEREO</span><span class="p">,</span>
	<span class="p">},{</span>
		<span class="p">.</span><span class="n">name</span>          <span class="o">=</span> <span class="s">&quot;NTSC-M&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">std</span>           <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr1</span>         <span class="o">=</span> <span class="mi">4500</span><span class="p">,</span>
		<span class="p">.</span><span class="n">carr2</span>         <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>          <span class="o">=</span> <span class="n">TVAUDIO_FM_MONO</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="cp">#define TVAUDIO ARRAY_SIZE(tvaudio)</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">tvaudio_carr2reg</span><span class="p">(</span><span class="n">u32</span> <span class="n">carrier</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">a</span> <span class="o">=</span> <span class="n">carrier</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">&lt;&lt;=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="mi">12288</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">a</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tvaudio_setcarrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">primary</span><span class="p">,</span> <span class="kt">int</span> <span class="n">secondary</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="n">secondary</span><span class="p">)</span>
		<span class="n">secondary</span> <span class="o">=</span> <span class="n">primary</span><span class="p">;</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_CARRIER1_FREQ0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tvaudio_carr2reg</span><span class="p">(</span><span class="n">primary</span><span class="p">));</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">SAA7134_CARRIER2_FREQ0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tvaudio_carr2reg</span><span class="p">(</span><span class="n">secondary</span><span class="p">));</span>
<span class="p">}</span>

<span class="cp">#define SAA7134_MUTE_MASK 0xbb</span>
<span class="cp">#define SAA7134_MUTE_ANALOG 0x04</span>
<span class="cp">#define SAA7134_MUTE_I2S 0x40</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">mute_input_7134</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_input</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ausel</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ics</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ocs</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* look what is to do ... */</span>
	<span class="n">in</span>   <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="n">mute</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span> <span class="o">||</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span>  <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">radio</span><span class="p">)</span> <span class="o">!=</span> <span class="n">in</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">mute</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * 7130 - we&#39;ll mute using some unconnected audio input</span>
<span class="cm">		 * 7134 - we&#39;ll probably should switch external mux with gpio</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mute</span><span class="p">)</span>
			<span class="n">in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">mute</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_mute</span>  <span class="o">==</span> <span class="n">mute</span> <span class="o">&amp;&amp;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_input</span> <span class="o">==</span> <span class="n">in</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">insuspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;mute/input: nothing to do [mute=%d,input=%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mute</span><span class="p">,</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ctl_mute=%d automute=%d input=%s  =&gt;  mute=%d input=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span><span class="n">mute</span><span class="p">,</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_mute</span>  <span class="o">=</span> <span class="n">mute</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hw_input</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="cm">/* 7134 mute */</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_MUTE_CTRL</span><span class="p">,</span> <span class="n">mute</span> <span class="o">?</span>
						    <span class="n">SAA7134_MUTE_MASK</span> <span class="o">|</span>
						    <span class="n">SAA7134_MUTE_ANALOG</span> <span class="o">|</span>
						    <span class="n">SAA7134_MUTE_I2S</span> <span class="o">:</span>
						    <span class="n">SAA7134_MUTE_MASK</span><span class="p">);</span>

	<span class="cm">/* switch internal audio mux */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">amux</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TV</span>:         <span class="n">ausel</span><span class="o">=</span><span class="mh">0xc0</span><span class="p">;</span> <span class="n">ics</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span> <span class="n">ocs</span><span class="o">=</span><span class="mh">0x02</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LINE1</span>:      <span class="n">ausel</span><span class="o">=</span><span class="mh">0x80</span><span class="p">;</span> <span class="n">ics</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span> <span class="n">ocs</span><span class="o">=</span><span class="mh">0x00</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LINE2</span>:      <span class="n">ausel</span><span class="o">=</span><span class="mh">0x80</span><span class="p">;</span> <span class="n">ics</span><span class="o">=</span><span class="mh">0x08</span><span class="p">;</span> <span class="n">ocs</span><span class="o">=</span><span class="mh">0x01</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LINE2_LEFT</span>: <span class="n">ausel</span><span class="o">=</span><span class="mh">0x80</span><span class="p">;</span> <span class="n">ics</span><span class="o">=</span><span class="mh">0x08</span><span class="p">;</span> <span class="n">ocs</span><span class="o">=</span><span class="mh">0x05</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_FORMAT_CTRL</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="n">ausel</span><span class="p">);</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IO_SELECT</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">ics</span><span class="p">);</span>
	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IO_SELECT</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="n">ocs</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>for oss, we need to change the clock configuration</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">amux</span> <span class="o">==</span> <span class="n">TV</span><span class="p">)</span>
		<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_SIF_SAMPLE_FREQ</span><span class="p">,</span>   <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_SIF_SAMPLE_FREQ</span><span class="p">,</span>   <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>

	<span class="cm">/* switch gpio-connected external audio mux */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">gpiomask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">gpiomask</span><span class="p">;</span>
	<span class="n">saa_andorl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span>   <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
	<span class="n">saa_andorl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
	<span class="n">saa7134_track_gpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tvaudio_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">saa7134_tvaudio</span> <span class="o">*</span><span class="n">audio</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">note</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">acpf</span><span class="p">,</span> <span class="n">tweak</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpf</span> <span class="o">=</span> <span class="mh">0x19066</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">acpf</span> <span class="o">=</span> <span class="mh">0x1e000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">audio_clock_tweak</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1024</span> <span class="o">&amp;&amp;</span> <span class="n">audio_clock_tweak</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">)</span>
		<span class="n">tweak</span> <span class="o">=</span> <span class="n">audio_clock_tweak</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">note</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tvaudio_setmode: %s %s [%d.%03d/%d.%03d MHz] acpf=%d%+d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">note</span><span class="p">,</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">audio</span><span class="o">-&gt;</span><span class="n">carr1</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">audio</span><span class="o">-&gt;</span><span class="n">carr1</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">,</span>
			<span class="n">audio</span><span class="o">-&gt;</span><span class="n">carr2</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">audio</span><span class="o">-&gt;</span><span class="n">carr2</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">,</span>
			<span class="n">acpf</span><span class="p">,</span> <span class="n">tweak</span><span class="p">);</span>

	<span class="n">acpf</span> <span class="o">+=</span> <span class="n">tweak</span><span class="p">;</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_CLOCKS_PER_FIELD0</span><span class="p">,</span> <span class="p">(</span><span class="n">acpf</span> <span class="o">&amp;</span> <span class="mh">0x0000ff</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_CLOCKS_PER_FIELD1</span><span class="p">,</span> <span class="p">(</span><span class="n">acpf</span> <span class="o">&amp;</span> <span class="mh">0x00ff00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_CLOCKS_PER_FIELD2</span><span class="p">,</span> <span class="p">(</span><span class="n">acpf</span> <span class="o">&amp;</span> <span class="mh">0x030000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">tvaudio_setcarrier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">carr1</span><span class="p">,</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">carr2</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TVAUDIO_FM_MONO</span>:
	<span class="k">case</span> <span class="n">TVAUDIO_FM_BG_STEREO</span>:
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEMODULATOR</span><span class="p">,</span>               <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DCXO_IDENT_CTRL</span><span class="p">,</span>           <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FM_DEEMPHASIS</span><span class="p">,</span>             <span class="mh">0x22</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FM_DEMATRIX</span><span class="p">,</span>               <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_STEREO_DAC_OUTPUT_SELECT</span><span class="p">,</span>  <span class="mh">0xa0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVAUDIO_FM_K_STEREO</span>:
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEMODULATOR</span><span class="p">,</span>               <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DCXO_IDENT_CTRL</span><span class="p">,</span>           <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FM_DEEMPHASIS</span><span class="p">,</span>             <span class="mh">0x22</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FM_DEMATRIX</span><span class="p">,</span>               <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_STEREO_DAC_OUTPUT_SELECT</span><span class="p">,</span>  <span class="mh">0xa0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVAUDIO_NICAM_FM</span>:
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEMODULATOR</span><span class="p">,</span>               <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DCXO_IDENT_CTRL</span><span class="p">,</span>           <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FM_DEEMPHASIS</span><span class="p">,</span>             <span class="mh">0x44</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_STEREO_DAC_OUTPUT_SELECT</span><span class="p">,</span>  <span class="mh">0xa1</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_NICAM_CONFIG</span><span class="p">,</span>              <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVAUDIO_NICAM_AM</span>:
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DEMODULATOR</span><span class="p">,</span>               <span class="mh">0x12</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_DCXO_IDENT_CTRL</span><span class="p">,</span>           <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FM_DEEMPHASIS</span><span class="p">,</span>             <span class="mh">0x44</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_STEREO_DAC_OUTPUT_SELECT</span><span class="p">,</span>  <span class="mh">0xa1</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_NICAM_CONFIG</span><span class="p">,</span>              <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVAUDIO_FM_SAT_STEREO</span>:
		<span class="cm">/* not implemented (yet) */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_sleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan1</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan2</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">schedule_timeout_interruptible</span>
						<span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan1</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan2</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_checkcarrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">mainscan</span> <span class="o">*</span><span class="n">scan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__s32</span> <span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">,</span><span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;skipping %d.%03d MHz [%4s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">audio_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;debug %d:&quot;</span><span class="p">,</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">150</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">150</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tvaudio_setcarrier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span><span class="o">+</span><span class="n">i</span><span class="p">,</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
			<span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_LEVEL_READOUT1</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tvaudio_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">SCAN_SAMPLE_DELAY</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_LEVEL_READOUT1</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">i</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;  #  %6d  # &quot;</span><span class="p">,</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %6d&quot;</span><span class="p">,</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tvaudio_setcarrier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span><span class="o">-</span><span class="mi">90</span><span class="p">);</span>
	<span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_LEVEL_READOUT1</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tvaudio_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">SCAN_SAMPLE_DELAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">left</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_LEVEL_READOUT1</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">tvaudio_setcarrier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span><span class="o">+</span><span class="mi">90</span><span class="p">,</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span><span class="o">+</span><span class="mi">90</span><span class="p">);</span>
	<span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_LEVEL_READOUT1</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tvaudio_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">SCAN_SAMPLE_DELAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_LEVEL_READOUT1</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">left</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">right</span> <span class="o">&gt;&gt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">left</span> <span class="o">&gt;</span> <span class="n">right</span> <span class="o">?</span> <span class="n">left</span> <span class="o">-</span> <span class="n">right</span> <span class="o">:</span> <span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;scanning %d.%03d MHz [%4s] =&gt;  dc is %5d [%d/%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">carr</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">,</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_getstereo</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_tvaudio</span> <span class="o">*</span><span class="n">audio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">idp</span><span class="p">,</span> <span class="n">nicam</span><span class="p">,</span> <span class="n">nicam_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TVAUDIO_FM_MONO</span>:
		<span class="k">return</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVAUDIO_FM_K_STEREO</span>:
	<span class="k">case</span> <span class="n">TVAUDIO_FM_BG_STEREO</span>:
		<span class="n">idp</span> <span class="o">=</span> <span class="p">(</span><span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7134_IDENT_SIF</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xe0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;getstereo: fm/stereo: idp=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">idp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">==</span> <span class="p">(</span><span class="n">idp</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">))</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x05</span> <span class="o">==</span> <span class="p">(</span><span class="n">idp</span> <span class="o">&amp;</span> <span class="mh">0x05</span><span class="p">))</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mh">0x01</span> <span class="o">==</span> <span class="p">(</span><span class="n">idp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVAUDIO_FM_SAT_STEREO</span>:
		<span class="cm">/* not implemented (yet) */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVAUDIO_NICAM_FM</span>:
	<span class="k">case</span> <span class="n">TVAUDIO_NICAM_AM</span>:
		<span class="n">nicam</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_STATUS</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;getstereo: nicam=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">nicam</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nicam</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nicam_status</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7134_NICAM_STATUS</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;getstereo: nicam_status=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nicam_status</span><span class="p">);</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">nicam_status</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
			    <span class="k">case</span> <span class="mh">0x01</span>:
				<span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			    <span class="k">case</span> <span class="mh">0x02</span>:
				<span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			    <span class="nl">default:</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* No nicam detected */</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found audio subchannels:%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">retval</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">)</span>   <span class="o">?</span> <span class="s">&quot; mono&quot;</span>   <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">retval</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; stereo&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">retval</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_LANG1</span><span class="p">)</span>  <span class="o">?</span> <span class="s">&quot; lang1&quot;</span>  <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">retval</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">)</span>  <span class="o">?</span> <span class="s">&quot; lang2&quot;</span>  <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_setstereo</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7134_tvaudio</span> <span class="o">*</span><span class="n">audio</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_MONO</span>   <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;mono&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_STEREO</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;stereo&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>  <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;lang1&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>  <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;lang2&quot;</span><span class="p">,</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span>  <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;lang1+lang2&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">fm</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_MONO</span>   <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* ch1  */</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_STEREO</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>  <span class="cm">/* auto */</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>  <span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">,</span>  <span class="cm">/* ch1  */</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>  <span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>  <span class="cm">/* ch2  */</span>
		<span class="p">[</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span> <span class="p">]</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>  <span class="cm">/* auto */</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">audio</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TVAUDIO_FM_MONO</span>:
		<span class="cm">/* nothing to do ... */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVAUDIO_FM_K_STEREO</span>:
	<span class="k">case</span> <span class="n">TVAUDIO_FM_BG_STEREO</span>:
	<span class="k">case</span> <span class="n">TVAUDIO_NICAM_AM</span>:
	<span class="k">case</span> <span class="n">TVAUDIO_NICAM_FM</span>:
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;setstereo [fm] =&gt; %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">name</span><span class="p">[</span> <span class="n">mode</span> <span class="o">%</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="p">]);</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">fm</span><span class="p">[</span> <span class="n">mode</span> <span class="o">%</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fm</span><span class="p">)</span> <span class="p">];</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FM_DEMATRIX</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TVAUDIO_FM_SAT_STEREO</span>:
		<span class="cm">/* Not implemented */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">carr_vals</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mainscan</span><span class="p">)];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">audio</span><span class="p">,</span> <span class="n">nscan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max1</span><span class="p">,</span><span class="n">max2</span><span class="p">,</span><span class="n">carrier</span><span class="p">,</span><span class="n">rx</span><span class="p">,</span><span class="n">mode</span><span class="p">,</span><span class="n">lastmode</span><span class="p">,</span><span class="n">default_carrier</span><span class="p">;</span>

	<span class="n">set_freezable</span><span class="p">();</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">tvaudio_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="nl">restart:</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan1</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan2</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tvaudio thread scan start [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan1</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvaudio</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_MONITOR_SELECT</span><span class="p">,</span>   <span class="mh">0xa0</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_FM_DEMATRIX</span><span class="p">,</span>      <span class="mh">0x80</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_automute</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">mute_input_7134</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* give the tuner some time */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tvaudio_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">SCAN_INITIAL_DELAY</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>

		<span class="n">max1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">max2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">nscan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">carrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">default_carrier</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mainscan</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">mainscan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">std</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">default_carrier</span><span class="p">)</span>
				<span class="n">default_carrier</span> <span class="o">=</span> <span class="n">mainscan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">carr</span><span class="p">;</span>
			<span class="n">nscan</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">nscan</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* only one candidate -- skip scan ;) */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;only one main carrier candidate - skipping scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">max1</span> <span class="o">=</span> <span class="mi">12345</span><span class="p">;</span>
			<span class="n">carrier</span> <span class="o">=</span> <span class="n">default_carrier</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* scan for the main carrier */</span>
			<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_MONITOR_SELECT</span><span class="p">,</span><span class="mh">0x00</span><span class="p">);</span>
			<span class="n">tvaudio_setmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tvaudio</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="nb">NULL</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mainscan</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">carr_vals</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tvaudio_checkcarrier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mainscan</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan1</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan2</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">max1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mainscan</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">max1</span> <span class="o">&lt;</span> <span class="n">carr_vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">max2</span> <span class="o">=</span> <span class="n">max1</span><span class="p">;</span>
					<span class="n">max1</span> <span class="o">=</span> <span class="n">carr_vals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
					<span class="n">carrier</span> <span class="o">=</span> <span class="n">mainscan</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">carr</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max2</span> <span class="o">&lt;</span> <span class="n">carr_vals</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="n">max2</span> <span class="o">=</span> <span class="n">carr_vals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">carrier</span> <span class="o">&amp;&amp;</span> <span class="n">max1</span> <span class="o">&gt;</span> <span class="mi">2000</span> <span class="o">&amp;&amp;</span> <span class="n">max1</span> <span class="o">&gt;</span> <span class="n">max2</span><span class="o">*</span><span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* found good carrier */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;found %s main sound carrier @ %d.%03d MHz [%d/%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">carrier</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">carrier</span><span class="o">%</span><span class="mi">1000</span><span class="p">,</span>
				<span class="n">max1</span><span class="p">,</span> <span class="n">max2</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_carrier</span> <span class="o">=</span> <span class="n">carrier</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_carrier</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no carrier -- try last detected one as fallback */</span>
			<span class="n">carrier</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">last_carrier</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;audio carrier scan failed, &quot;</span>
				<span class="s">&quot;using %d.%03d MHz [last detected]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">carrier</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">carrier</span><span class="o">%</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* no carrier + no fallback -- use default */</span>
			<span class="n">carrier</span> <span class="o">=</span> <span class="n">default_carrier</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;audio carrier scan failed, &quot;</span>
				<span class="s">&quot;using %d.%03d MHz [default]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">carrier</span><span class="o">/</span><span class="mi">1000</span><span class="p">,</span> <span class="n">carrier</span><span class="o">%</span><span class="mi">1000</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tvaudio_setcarrier</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">carrier</span><span class="p">,</span><span class="n">carrier</span><span class="p">);</span>
		<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_STEREO_DAC_OUTPUT_SELECT</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* find the exact tv audio norm */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">audio</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TVAUDIO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">UNSET</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">tvaudio</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">std</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tvaudio</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">carr1</span> <span class="o">!=</span> <span class="n">carrier</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/* Note: at least the primary carrier is right here */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">==</span> <span class="n">audio</span><span class="p">)</span>
				<span class="n">audio</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">tvaudio_setmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tvaudio</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="s">&quot;trying&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tvaudio_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">SCAN_SUBCARRIER_DELAY</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">tvaudio_getstereo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tvaudio</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">audio</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_STEREO_DAC_OUTPUT_SELECT</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">==</span> <span class="n">audio</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">tvaudio_setmode</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tvaudio</span><span class="p">[</span><span class="n">audio</span><span class="p">],</span><span class="s">&quot;using&quot;</span><span class="p">);</span>

		<span class="n">tvaudio_setstereo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tvaudio</span><span class="p">[</span><span class="n">audio</span><span class="p">],</span><span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvaudio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvaudio</span><span class="p">[</span><span class="n">audio</span><span class="p">];</span>

		<span class="n">lastmode</span> <span class="o">=</span> <span class="mi">42</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>

			<span class="n">try_to_freeze</span><span class="p">();</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tvaudio_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">5000</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rx</span> <span class="o">=</span> <span class="n">tvaudio_getstereo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvaudio</span><span class="p">[</span><span class="n">audio</span><span class="p">]);</span>
				<span class="n">mode</span> <span class="o">=</span> <span class="n">saa7134_tvaudio_rx2mode</span><span class="p">(</span><span class="n">rx</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">mode</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">mode</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lastmode</span> <span class="o">!=</span> <span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tvaudio_setstereo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tvaudio</span><span class="p">[</span><span class="n">audio</span><span class="p">],</span><span class="n">mode</span><span class="p">);</span>
				<span class="n">lastmode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* saa7133 / saa7135 code                                             */</span>

<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">stdres</span><span class="p">[</span><span class="mh">0x20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;no standard detected&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;B/G (in progress)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;D/K (in progress)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;M (in progress)&quot;</span><span class="p">,</span>

	<span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;B/G A2&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;B/G NICAM&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;D/K A2 (1)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;D/K A2 (2)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;D/K A2 (3)&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;D/K NICAM&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;L NICAM&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;I NICAM&quot;</span><span class="p">,</span>

	<span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;M Korea&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;M BTSC &quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;M EIAJ&quot;</span><span class="p">,</span>

	<span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FM radio / IF 10.7 / 50 deemp&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FM radio / IF 10.7 / 75 deemp&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FM radio / IF sel / 50 deemp&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;FM radio / IF sel / 75 deemp&quot;</span><span class="p">,</span>

	<span class="p">[</span><span class="mh">0x13</span> <span class="p">...</span> <span class="mh">0x1e</span> <span class="p">]</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x1f</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;??? [in progress]&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define DSP_RETRY 32</span>
<span class="cp">#define DSP_DELAY 16</span>
<span class="cp">#define SAA7135_DSP_RWCLEAR_RERR 1</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">saa_dsp_reset_error_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7135_DSP_RWSTATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SAA7135_DSP_RWSTATE_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">d2printk</span><span class="p">(</span><span class="s">&quot;%s: resetting error bit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7135_DSP_RWCLEAR</span><span class="p">,</span> <span class="n">SAA7135_DSP_RWCLEAR_RERR</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">saa_dsp_wait_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">state</span><span class="p">,</span> <span class="n">count</span> <span class="o">=</span> <span class="n">DSP_RETRY</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7135_DSP_RWSTATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SAA7135_DSP_RWSTATE_ERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: dsp access error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">saa_dsp_reset_error_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">bit</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: dsp access wait timeout [bit=%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">SAA7135_DSP_RWSTATE_WRR</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;WRR&quot;</span> <span class="o">:</span>
			       <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">SAA7135_DSP_RWSTATE_RDB</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;RDB&quot;</span> <span class="o">:</span>
			       <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="n">SAA7135_DSP_RWSTATE_IDA</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IDA&quot;</span> <span class="o">:</span>
			       <span class="s">&quot;???&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">saa_wait</span><span class="p">(</span><span class="n">DSP_DELAY</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">=</span> <span class="n">saa_readb</span><span class="p">(</span><span class="n">SAA7135_DSP_RWSTATE</span><span class="p">);</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">saa_dsp_writel</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">d2printk</span><span class="p">(</span><span class="s">&quot;dsp write reg 0x%x = 0x%06x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">reg</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">saa_dsp_wait_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">SAA7135_DSP_RWSTATE_WRR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">saa_writel</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span><span class="n">value</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">saa_dsp_wait_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">SAA7135_DSP_RWSTATE_WRR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">getstereo_7133</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="mh">0x528</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">mute_input_7133</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xbarin</span><span class="p">,</span> <span class="n">xbarout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_input</span> <span class="o">*</span><span class="n">in</span><span class="p">;</span>

	<span class="n">xbarin</span> <span class="o">=</span> <span class="mh">0x03</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">amux</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TV</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="n">xbarin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LINE1</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">LINE2</span>:
	<span class="k">case</span> <span class="n">LINE2_LEFT</span>:
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x09</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x464</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xbarin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>
		<span class="n">xbarout</span> <span class="o">=</span> <span class="mh">0xbbbbbb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">xbarout</span> <span class="o">=</span> <span class="mh">0xbbbb10</span><span class="p">;</span>
	<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x46c</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">xbarout</span><span class="p">);</span>

	<span class="n">saa_writel</span><span class="p">(</span><span class="mh">0x594</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>


	<span class="cm">/* switch gpio-connected external audio mux */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">gpiomask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">gpiomask</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">mute</span><span class="p">.</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ctl_mute</span><span class="p">)</span>
			<span class="n">in</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">mute</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">in</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

		<span class="n">saa_andorl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span>   <span class="n">mask</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">saa_andorl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">in</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span>
		<span class="n">saa7134_track_gpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">in</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_thread_ddep</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="n">norms</span><span class="p">;</span>

	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">tvaudio_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="nl">restart:</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan1</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan2</span><span class="p">;</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tvaudio thread scan start [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">audio_ddep</span> <span class="o">&gt;=</span> <span class="mh">0x04</span> <span class="o">&amp;&amp;</span> <span class="n">audio_ddep</span> <span class="o">&lt;=</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* insmod option override */</span>
			<span class="n">norms</span> <span class="o">=</span> <span class="p">(</span><span class="n">audio_ddep</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;ddep override: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">stdres</span><span class="p">[</span><span class="n">audio_ddep</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="p">(</span><span class="n">dev</span><span class="p">).</span><span class="n">radio</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;FM Radio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">==</span> <span class="n">TUNER_PHILIPS_TDA8290</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">norms</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x11</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x42c</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x729555</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">norms</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x0f</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* (let chip) scan for sound carrier */</span>
			<span class="n">norms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_B</span> <span class="o">|</span> <span class="n">V4L2_STD_GH</span><span class="p">))</span>
				<span class="n">norms</span> <span class="o">|=</span> <span class="mh">0x04</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">)</span>
				<span class="n">norms</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_DK</span><span class="p">)</span>
				<span class="n">norms</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_MN</span><span class="p">)</span>
				<span class="n">norms</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvnorm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_STD_SECAM_L</span> <span class="o">|</span> <span class="n">V4L2_STD_SECAM_LC</span><span class="p">))</span>
				<span class="n">norms</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">norms</span><span class="p">)</span>
				<span class="n">norms</span> <span class="o">=</span> <span class="mh">0x7c</span><span class="p">;</span> <span class="cm">/* all */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;scanning:%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">norms</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; B/G&quot;</span>  <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">norms</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; D/K&quot;</span>  <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">norms</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; L/L&#39;&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">norms</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; I&quot;</span>    <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">norms</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; M&quot;</span>    <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* kick automatic standard detection */</span>
		<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x454</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x454</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">norms</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>

		<span class="cm">/* setup crossbars */</span>
		<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x464</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x000000</span><span class="p">);</span>
		<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x470</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x101010</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tvaudio_sleep</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">3000</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="mh">0x528</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffffff</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;tvaudio thread status: 0x%x [%s%s%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">value</span><span class="p">,</span> <span class="n">stdres</span><span class="p">[</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">],</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000020</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;,stereo&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000040</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;,dual&quot;</span>   <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;detailed status: &quot;</span>
			<span class="s">&quot;%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s#%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000080</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; A2/EIAJ pilot tone &quot;</span>     <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000100</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; A2/EIAJ dual &quot;</span>           <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000200</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; A2/EIAJ stereo &quot;</span>         <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000400</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; A2/EIAJ noise mute &quot;</span>     <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x000800</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; BTSC/FM radio pilot &quot;</span>    <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x001000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; SAP carrier &quot;</span>            <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x002000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; BTSC stereo noise mute &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x004000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; SAP noise mute &quot;</span>         <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x008000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; VDSP &quot;</span>                   <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x010000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; NICST &quot;</span>                  <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x020000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; NICDU &quot;</span>                  <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x040000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; NICAM muted &quot;</span>            <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x080000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; NICAM reserve sound &quot;</span>    <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>

			<span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x100000</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; init done &quot;</span>              <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">done:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">stopped</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------ */</span>
<span class="cm">/* common stuff + external entry points                               */</span>

<span class="kt">void</span> <span class="nf">saa7134_enable_i2s</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i2s_format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">card_is_empress</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">==</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7130</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* configure GPIO for out */</span>
	<span class="n">saa_andorl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x0E000000</span><span class="p">,</span> <span class="mh">0x00000000</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7133</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7135</span>:
	    <span class="cm">/* Set I2S format (SONY)  */</span>
	    <span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7133_I2S_AUDIO_CONTROL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	    <span class="cm">/* Start I2S */</span>
	    <span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_I2S_AUDIO_OUTPUT</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
	    <span class="n">i2s_format</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">amux</span> <span class="o">==</span> <span class="n">TV</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x00</span> <span class="o">:</span> <span class="mh">0x01</span><span class="p">;</span>

	    <span class="cm">/* enable I2S audio output for the mpeg encoder */</span>
	    <span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_I2S_OUTPUT_SELECT</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	    <span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_I2S_OUTPUT_FORMAT</span><span class="p">,</span> <span class="n">i2s_format</span><span class="p">);</span>
	    <span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_I2S_OUTPUT_LEVEL</span><span class="p">,</span>  <span class="mh">0x0F</span><span class="p">);</span>
	    <span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_I2S_AUDIO_OUTPUT</span><span class="p">,</span>  <span class="mh">0x01</span><span class="p">);</span>

	<span class="nl">default:</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_tvaudio_rx2mode</span><span class="p">(</span><span class="n">u32</span> <span class="n">rx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_LANG1</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rx</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7130</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
		<span class="n">mute_input_7134</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7133</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7135</span>:
		<span class="n">mute_input_7133</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_tvaudio_setinput</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">saa7134_input</span> <span class="o">*</span><span class="n">in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">in</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7130</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
		<span class="n">mute_input_7134</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7133</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7135</span>:
		<span class="n">mute_input_7133</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">saa7134_enable_i2s</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_tvaudio_setvolume</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_CHANNEL1_LEVEL</span><span class="p">,</span>     <span class="n">level</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_CHANNEL2_LEVEL</span><span class="p">,</span>     <span class="n">level</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_NICAM_LEVEL_ADJUST</span><span class="p">,</span> <span class="n">level</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_tvaudio_getstereo</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvaudio</span><span class="p">)</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">tvaudio_getstereo</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">tvaudio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7133</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7135</span>:
		<span class="n">retval</span> <span class="o">=</span> <span class="n">getstereo_7133</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_tvaudio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">clock</span> <span class="o">=</span> <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">audio_clock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">!=</span> <span class="n">audio_clock_override</span><span class="p">)</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="n">audio_clock_override</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
		<span class="cm">/* init all audio registers */</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_PLL_CTRL</span><span class="p">,</span>   <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">need_resched</span><span class="p">())</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="k">else</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_CLOCK0</span><span class="p">,</span>      <span class="n">clock</span>        <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_CLOCK1</span><span class="p">,</span>     <span class="p">(</span><span class="n">clock</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_CLOCK2</span><span class="p">,</span>     <span class="p">(</span><span class="n">clock</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="cm">/* frame locked audio is mandatory for NICAM */</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_AUDIO_PLL_CTRL</span><span class="p">,</span>   <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_NICAM_ERROR_LOW</span><span class="p">,</span>  <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">saa_writeb</span><span class="p">(</span><span class="n">SAA7134_NICAM_ERROR_HIGH</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7133</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7135</span>:
		<span class="n">saa_writel</span><span class="p">(</span><span class="mh">0x598</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">clock</span><span class="p">);</span>
		<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x474</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="n">saa_dsp_writel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x450</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_tvaudio_init2</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">my_thread</span><span class="p">)(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7134</span>:
		<span class="n">my_thread</span> <span class="o">=</span> <span class="n">tvaudio_thread</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7133</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_PHILIPS_SAA7135</span>:
		<span class="n">my_thread</span> <span class="o">=</span> <span class="n">tvaudio_thread_ddep</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan1</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">my_thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7134_tvaudio_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* start tvaudio thread */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">my_thread</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: kernel_thread() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* XXX: missing error handling here */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">saa7134_enable_i2s</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_tvaudio_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* anything else to undo? */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_tvaudio_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* shutdown tvaudio thread */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="kr">thread</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">stopped</span><span class="p">)</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="kr">thread</span><span class="p">);</span>

	<span class="n">saa_andorb</span><span class="p">(</span><span class="n">SAA7134_ANALOG_IO_SELECT</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* LINE1 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_tvaudio_do_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">amux</span> <span class="o">!=</span> <span class="n">TV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;sound IF not in use, skipping scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">scan2</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">insuspend</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="n">stopped</span><span class="p">)</span>
			<span class="n">wake_up_process</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">.</span><span class="kr">thread</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">automute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">saa7134_tvaudio_setmute</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa_dsp_writel</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">saa7134_tvaudio_setmute</span><span class="p">);</span>

<span class="cm">/* ----------------------------------------------------------- */</span>
<span class="cm">/*</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
