<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › saa7134 › saa7134-input.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>saa7134-input.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * handle saa7134 IR remotes via linux kernel input layer.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;saa7134-reg.h&quot;</span>
<span class="cp">#include &quot;saa7134.h&quot;</span>

<span class="cp">#define MODULE_NAME &quot;saa7134&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">disable_ir</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">disable_ir</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_ir</span><span class="p">,</span><span class="s">&quot;disable infrared remote support&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ir_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ir_debug</span><span class="p">,</span><span class="s">&quot;enable debug messages [IR]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pinnacle_remote</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pinnacle_remote</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>    <span class="cm">/* Choose Pinnacle PCTV remote */</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pinnacle_remote</span><span class="p">,</span> <span class="s">&quot;Specify Pinnacle PCTV remote: 0=coloured, 1=grey (defaults to 0)&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(fmt, arg...)	if (ir_debug) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s/ir: &quot; fmt, dev-&gt;name , ## arg)</span>
<span class="cp">#define i2cdprintk(fmt, arg...)    if (ir_debug) \</span>
<span class="cp">	printk(KERN_DEBUG &quot;%s/ir: &quot; fmt, ir-&gt;name , ## arg)</span>

<span class="cm">/* Helper function for raw decoding at GPIO16 or GPIO18 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">saa7134_raw_decode_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* -------------------- GPIO generic keycode builder -------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">build_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_card_ir</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">gpio</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* here comes the additional handshake steps for some cards */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_GOTVIEW_7135</span>:
		<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">saa_clearb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* rising SAA7134_GPIO_GPRESCAN reads the status */</span>
	<span class="n">saa_clearb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span><span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>
	<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span><span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">last_gpio</span> <span class="o">==</span> <span class="n">gpio</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">last_gpio</span> <span class="o">=</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">ir_extract_bits</span><span class="p">(</span><span class="n">gpio</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;build_key gpio=0x%x mask=0x%x data=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">gpio</span><span class="p">,</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_KWORLD_PLUS_TV_ANALOG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span><span class="p">)</span>
			<span class="n">rc_keyup</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">rc_keydown_notimeout</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span>  <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span><span class="p">)))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span>    <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">rc_keydown_notimeout</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rc_keyup</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>	<span class="cm">/* IRQ driven mode - handle key press and release in one go */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span>  <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="mi">0</span> <span class="o">!=</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span><span class="p">)))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span>    <span class="o">&amp;&amp;</span>  <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span><span class="p">))))</span> <span class="p">{</span>
			<span class="n">rc_keydown_notimeout</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">rc_keyup</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------- Chip specific I2C key builders ----------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_flydvb_trio</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">gpio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">attempt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">;</span>

	<span class="cm">/* We need this to access GPI Used by the saa_readl macro. */</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;get_key_flydvb_trio: &quot;</span>
			   <span class="s">&quot;ir-&gt;c-&gt;adapter-&gt;algo_data is NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rising SAA7134_GPIGPRESCAN reads the status */</span>
	<span class="n">saa_clearb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>
	<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mh">0x40000</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">gpio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No button press */</span>

	<span class="cm">/* No button press - only before first key pressed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* poll IR chip */</span>
	<span class="cm">/* weak up the IR chip */</span>
	<span class="n">b</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">attempt</span><span class="o">++</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * wait a bit for next attempt -</span>
<span class="cm">			 * I don&#39;t know how make it better</span>
<span class="cm">			 */</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;send wake up byte to pic16C505 (IR chip)&quot;</span>
			   <span class="s">&quot;failed %dx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">attempt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_msi_tvanywhere_plus</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">gpio</span><span class="p">;</span>

	<span class="cm">/* &lt;dev&gt; is needed to access GPIO. Used by the saa_readl macro. */</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;get_key_msi_tvanywhere_plus: &quot;</span>
			   <span class="s">&quot;ir-&gt;c-&gt;adapter-&gt;algo_data is NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rising SAA7134_GPIO_GPRESCAN reads the status */</span>

	<span class="n">saa_clearb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>
	<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* GPIO&amp;0x40 is pulsed low when a button is pressed. Don&#39;t do</span>
<span class="cm">	   I2C receive if gpio&amp;0x40 is not low. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>       <span class="cm">/* No button press */</span>

	<span class="cm">/* GPIO says there is a button press. Get it. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No button press */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Button pressed */</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;get_key_msi_tvanywhere_plus: Key = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* copied and modified from get_key_msi_tvanywhere_plus() */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_kworld_pc150u</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span>
					<span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">gpio</span><span class="p">;</span>

	<span class="cm">/* &lt;dev&gt; is needed to access GPIO. Used by the saa_readl macro. */</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;get_key_kworld_pc150u: &quot;</span>
			   <span class="s">&quot;ir-&gt;c-&gt;adapter-&gt;algo_data is NULL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* rising SAA7134_GPIO_GPRESCAN reads the status */</span>

	<span class="n">saa_clearb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>
	<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* GPIO&amp;0x100 is pulsed low when a button is pressed. Don&#39;t do</span>
<span class="cm">	   I2C receive if gpio&amp;0x100 is not low. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">gpio</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>       <span class="cm">/* No button press */</span>

	<span class="cm">/* GPIO says there is a button press. Get it. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* No button press */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">==</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Button pressed */</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;get_key_kworld_pc150u: Key = 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">b</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_purpletv</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">;</span>

	<span class="cm">/* poll IR chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">b</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* no button press */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* repeating */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_hvr1110</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="cm">/* poll IR chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">5</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Check if some key were pressed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * buf[3] &amp; 0x80 is always high.</span>
<span class="cm">	 * buf[3] &amp; 0x40 is a parity bit. A repeat event is marked</span>
<span class="cm">	 * by preserving it into two separate readings</span>
<span class="cm">	 * buf[4] bits 0 and 1, and buf[1] and buf[2] are always</span>
<span class="cm">	 * zero.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="mh">0x1fff</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">));</span>
	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_beholdm6xx</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span><span class="p">[</span><span class="mi">12</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">gpio</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">algo_data</span><span class="p">;</span>

	<span class="cm">/* rising SAA7134_GPIO_GPRESCAN reads the status */</span>
	<span class="n">saa_clearb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>
	<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mh">0x400000</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">gpio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* No button press */</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x5a</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">12</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="o">~</span><span class="n">data</span><span class="p">[</span><span class="mi">8</span><span class="p">]))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Common (grey or coloured) pinnacle PCTV remote handling</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_pinnacle</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">parity_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">marker</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code_modulo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">b</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">parity</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span><span class="n">code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* poll IR chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">start</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b</span><span class="p">);</span> <span class="n">start</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="n">start</span><span class="p">]</span> <span class="o">==</span> <span class="n">marker</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">code</span><span class="o">=</span><span class="n">b</span><span class="p">[(</span><span class="n">start</span><span class="o">+</span><span class="n">parity_offset</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">];</span>
			<span class="n">parity</span><span class="o">=</span><span class="n">b</span><span class="p">[(</span><span class="n">start</span><span class="o">+</span><span class="n">parity_offset</span><span class="p">)</span> <span class="o">%</span> <span class="mi">4</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Empty Request */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parity</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Repeating... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">old</span> <span class="o">==</span> <span class="n">parity</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">old</span> <span class="o">=</span> <span class="n">parity</span><span class="p">;</span>

	<span class="cm">/* drop special codes when a key is held down a long time for the grey controller</span>
<span class="cm">	   In this case, the second bit of the code is asserted */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">marker</span> <span class="o">==</span> <span class="mh">0xfe</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">code</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">code</span> <span class="o">%=</span> <span class="n">code_modulo</span><span class="p">;</span>

	<span class="o">*</span><span class="n">ir_raw</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>
	<span class="o">*</span><span class="n">ir_key</span> <span class="o">=</span> <span class="n">code</span><span class="p">;</span>

	<span class="n">i2cdprintk</span><span class="p">(</span><span class="s">&quot;Pinnacle PCTV key %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The grey pinnacle PCTV remote</span>
<span class="cm"> *</span>
<span class="cm"> *  There are one issue with this remote:</span>
<span class="cm"> *   - I2c packet does not change when the same key is pressed quickly. The workaround</span>
<span class="cm"> *     is to hold down each key for about half a second, so that another code is generated</span>
<span class="cm"> *     in the i2c packet, and the function can distinguish key presses.</span>
<span class="cm"> *</span>
<span class="cm"> * Sylvain Pasche &lt;sylvain.pasche@gmail.com&gt;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_pinnacle_grey</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">return</span> <span class="n">get_key_pinnacle</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">ir_key</span><span class="p">,</span> <span class="n">ir_raw</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mh">0xfe</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* The new pinnacle PCTV remote (with the colored buttons)</span>
<span class="cm"> *</span>
<span class="cm"> * Ricardo Cerqueira &lt;v4l@cerqueira.org&gt;</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_key_pinnacle_color</span><span class="p">(</span><span class="k">struct</span> <span class="n">IR_i2c</span> <span class="o">*</span><span class="n">ir</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_key</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">ir_raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* code_modulo parameter (0x88) is used to reduce code value to fit inside IR_KEYTAB_SIZE</span>
<span class="cm">	 *</span>
<span class="cm">	 * this is the only value that results in 42 unique</span>
<span class="cm">	 * codes &lt; 128</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="n">get_key_pinnacle</span><span class="p">(</span><span class="n">ir</span><span class="p">,</span> <span class="n">ir_key</span><span class="p">,</span> <span class="n">ir_raw</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_input_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_card_ir</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">raw_decode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">build_key</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">raw_decode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7134_raw_decode_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7134_input_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_card_ir</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">;</span>

	<span class="n">build_key</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ir_raw_decode_timer_end</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_card_ir</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">;</span>

	<span class="n">ir_raw_event_handle</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__saa7134_ir_start</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_card_ir</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ir</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Moved here from saa7134_input_init1() because the latter</span>
<span class="cm">	 * is not called on device resume */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_MD2819</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_KWORLD_VSTREAM_XPERT</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_305</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_307</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_305</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_505</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_307</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_507</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_507UA</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_GO_007_FM</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_M102</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_GO_007_FM_PLUS</span>:
		<span class="cm">/* Without this we won&#39;t receive key up events */</span>
		<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span><span class="p">,</span> <span class="mh">0x4</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_777</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_A16AR</span>:
		<span class="cm">/* Without this we won&#39;t receive key up events */</span>
		<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_A16D</span>:
		<span class="cm">/* Without this we won&#39;t receive key up events */</span>
		<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS1</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_GOTVIEW_7135</span>:
		<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE1</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">saa7134_input_timer</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">raw_decode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* set timer_end for code completion */</span>
		<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">ir_raw_decode_timer_end</span><span class="p">,</span>
			    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__saa7134_ir_stop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7134_card_ir</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ir</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">running</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span> <span class="o">||</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">raw_decode</span><span class="p">)</span>
		<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_ir_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">__saa7134_ir_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_ir_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="n">__saa7134_ir_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_ir_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">__saa7134_ir_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7134_ir_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">users</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span>
		<span class="n">__saa7134_ir_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7134_input_init1</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_card_ir</span> <span class="o">*</span><span class="n">ir</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rc_dev</span> <span class="o">*</span><span class="n">rc</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask_keycode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask_keydown</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">polling</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">raw_decode</span>  <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_remote</span> <span class="o">!=</span> <span class="n">SAA7134_REMOTE_GPIO</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable_ir</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* detect &amp; configure */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_FLYVIDEO2000</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_FLYVIDEO3000</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_FLYTVPLATINUM_FM</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_FLYTVPLATINUM_MINI2</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ROVERMEDIA_LINK_PRO_FM</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_FLYVIDEO</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xEC00000</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_CINERGY400</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_CINERGY600</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_CINERGY600_MK3</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_CINERGY</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x00003f</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x040000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ECS_TVP3XP</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ECS_TVP3XP_4CB5</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_EZTV</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x00017c</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x000002</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_KWORLD_XPERT</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVACSSMARTTV</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_PIXELVIEW</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x00001F</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x000020</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_MD2819</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_KWORLD_VSTREAM_XPERT</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_305</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_307</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_305</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_505</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_307</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_507</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_STUDIO_507UA</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_GO_007_FM</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_M102</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_GO_007_FM_PLUS</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_AVERMEDIA</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x0007C8</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x000010</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="cm">/* GPIO stuff moved to __saa7134_ir_start() */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_M135A</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_AVERMEDIA_M135A</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>	<span class="cm">/* Enable GPIO18 line on both edges */</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">raw_decode</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_M733A</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_AVERMEDIA_M733A_RM_K6</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">raw_decode</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_777</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_A16AR</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_AVERMEDIA</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x02F200</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x000400</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="cm">/* GPIO stuff moved to __saa7134_ir_start() */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_A16D</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_AVERMEDIA_A16D</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x02F200</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x000400</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="cm">/* GPIO stuff moved to __saa7134_ir_start() */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_KWORLD_TERMINATOR</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_PIXELVIEW</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x00001f</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x000060</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_MANLI_MTV001</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_MANLI_MTV002</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_MANLI</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x001f00</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x004000</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_409FM</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_401</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_403</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_403FM</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_405</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_405FM</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_407</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_407FM</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_409</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_505FM</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_505RDS_MK5</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_505RDS_MK3</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_507_9FM</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_507RDS_MK3</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_507RDS_MK5</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_MANLI</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x003f00</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x004000</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_COLUMBUS_TVFM</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_BEHOLD_COLUMBUS</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x003f00</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x004000</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_SEDNA_PC_TV_CARDBUS</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_PCTV_SEDNA</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x001f00</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x004000</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_GOTVIEW_7135</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_GOTVIEW7135</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x0003CC</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x000010</span><span class="p">;</span>
		<span class="n">polling</span>	     <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="cm">/* GPIO stuff moved to __saa7134_ir_start() */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_VIDEOMATE_TV_PVR</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_VIDEOMATE_GOLD_PLUS</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_VIDEOMATE_TV_GOLD_PLUSII</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_VIDEOMATE_TV_PVR</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x00003F</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x400000</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_PROTEUS_2309</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_PROTEUS_2309</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x00007F</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x000080</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_VIDEOMATE_DVBT_300</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_VIDEOMATE_DVBT_200</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_VIDEOMATE_TV_PVR</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x003F00</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x040000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_FLYDVBS_LR300</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_FLYDVBT_LR301</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_FLYDVBTDUO</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_FLYDVB</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x0001F00</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ASUSTeK_P7131_DUAL</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ASUSTeK_P7131_HYBRID_LNA</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ASUSTeK_P7131_ANALOG</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_ASUS_PC39</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>	<span class="cm">/* Enable GPIO18 line on both edges */</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">raw_decode</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ASUSTeK_PS3_100</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_ASUS_PS3_100</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">raw_decode</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ENCORE_ENLTV</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ENCORE_ENLTV_FM</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_ENCORE_ENLTV</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x00007f</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x040000</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">// ms</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ENCORE_ENLTV_FM53</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_ENCORE_ENLTV_FM3</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_ENCORE_ENLTV_FM53</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>	<span class="cm">/* Enable GPIO18 line on both edges */</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">raw_decode</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_10MOONSTVMASTER3</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_ENCORE_ENLTV</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x5f80000</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x8000000</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="c1">//ms</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_GENIUS_TVGO_A11MCE</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_GENIUS_TVGO_A11MCE</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0xf00000</span><span class="p">;</span>
		<span class="n">polling</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_REAL_ANGEL_220</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_REAL_AUDIO_220_32_KEYS</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x3f00</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x4000</span><span class="p">;</span>
		<span class="n">polling</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_KWORLD_PLUS_TV_ANALOG</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_KWORLD_PLUS_TV_ANALOG</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="n">polling</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_VIDEOMATE_S350</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_VIDEOMATE_S350</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x003f00</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x040000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_LEADTEK_WINFAST_DTV1000S</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_WINFAST</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x5f00</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x020000</span><span class="p">;</span>
		<span class="n">polling</span>      <span class="o">=</span> <span class="mi">50</span><span class="p">;</span> <span class="cm">/* ms */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_VIDEOMATE_M1F</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_VIDEOMATE_K100</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0x0ff00</span><span class="p">;</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x040000</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_HAUPPAUGE_HVR1150</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_HAUPPAUGE_HVR1120</span>:
		<span class="n">ir_codes</span>     <span class="o">=</span> <span class="n">RC_MAP_HAUPPAUGE</span><span class="p">;</span>
		<span class="n">mask_keydown</span> <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>	<span class="cm">/* Enable GPIO18 line on both edges */</span>
		<span class="n">mask_keyup</span>   <span class="o">=</span> <span class="mh">0x0040000</span><span class="p">;</span>
		<span class="n">mask_keycode</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
		<span class="n">raw_decode</span>   <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">ir_codes</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: Oops: IR config error [card=%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ir</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ir</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">rc_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span> <span class="o">||</span> <span class="o">!</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span> <span class="o">=</span> <span class="n">ir</span><span class="p">;</span>

	<span class="cm">/* init hardware-specific stuff */</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keycode</span> <span class="o">=</span> <span class="n">mask_keycode</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span> <span class="o">=</span> <span class="n">mask_keydown</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keyup</span>   <span class="o">=</span> <span class="n">mask_keyup</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">polling</span>      <span class="o">=</span> <span class="n">polling</span><span class="p">;</span>
	<span class="n">ir</span><span class="o">-&gt;</span><span class="n">raw_decode</span>	 <span class="o">=</span> <span class="n">raw_decode</span><span class="p">;</span>

	<span class="cm">/* init input device */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;saa7134 IR (%s)&quot;</span><span class="p">,</span>
		 <span class="n">saa7134_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">),</span> <span class="s">&quot;pci-%s/ir0&quot;</span><span class="p">,</span>
		 <span class="n">pci_name</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">));</span>

	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">saa7134_ir_open</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">saa7134_ir_close</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raw_decode</span><span class="p">)</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">driver_type</span> <span class="o">=</span> <span class="n">RC_DRIVER_IR_RAW</span><span class="p">;</span>

	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_name</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_phys</span> <span class="o">=</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_PCI</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span>
		<span class="n">rc</span><span class="o">-&gt;</span><span class="n">input_id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">map_name</span> <span class="o">=</span> <span class="n">ir_codes</span><span class="p">;</span>
	<span class="n">rc</span><span class="o">-&gt;</span><span class="n">driver_name</span> <span class="o">=</span> <span class="n">MODULE_NAME</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">rc_register_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out_free</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_out_free:</span>
	<span class="n">rc_free_device</span><span class="p">(</span><span class="n">rc</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ir</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_input_fini</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">saa7134_ir_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rc_unregister_device</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7134_probe_i2c_ir</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_board_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg_msi</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">disable_ir</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;IR has been disabled, not probing for i2c remote</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_board_info</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">info</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="s">&quot;ir_video&quot;</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_PINNACLE_PCTV_110i</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_PINNACLE_PCTV_310i</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Pinnacle PCTV&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pinnacle_remote</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">get_key_pinnacle_color</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_PINNACLE_COLOR</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">get_key_pinnacle_grey</span><span class="p">;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_PINNACLE_GREY</span><span class="p">;</span>
			<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_UPMOST_PURPLE_TV</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Purple TV&quot;</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">get_key_purpletv</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_PURPLETV</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x7a</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_MSI_TVATANYWHERE_PLUS</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;MSI TV@nywhere Plus&quot;</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">get_key_msi_tvanywhere_plus</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_MSI_TVANYWHERE_PLUS</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * MSI TV@nyware Plus requires more frequent polling</span>
<span class="cm">		 * otherwise it will miss some keypresses</span>
<span class="cm">		 */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">polling_interval</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="cm">/* MSI TV@nywhere Plus controller doesn&#39;t seem to</span>
<span class="cm">		   respond to probes unless we read something from</span>
<span class="cm">		   an existing device. Weird...</span>
<span class="cm">		   REVISIT: might no longer be needed */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_msi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;probe 0x%02x @ %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg_msi</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">rc</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_KWORLD_PC150U</span>:
		<span class="cm">/* copied and modified from MSI TV@nywhere Plus */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;Kworld PC150-U&quot;</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">get_key_kworld_pc150u</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_KWORLD_PC150U</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="cm">/* MSI TV@nywhere Plus controller doesn&#39;t seem to</span>
<span class="cm">		   respond to probes unless we read something from</span>
<span class="cm">		   an existing device. Weird...</span>
<span class="cm">		   REVISIT: might no longer be needed */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_msi</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;probe 0x%02x @ %s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg_msi</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">==</span> <span class="n">rc</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;yes&quot;</span> <span class="o">:</span> <span class="s">&quot;no&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_HAUPPAUGE_HVR1110</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;HVR 1110&quot;</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">get_key_hvr1110</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_HAUPPAUGE</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x71</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_607FM_MK3</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_607FM_MK5</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_609FM_MK3</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_609FM_MK5</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_607RDS_MK3</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_607RDS_MK5</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_609RDS_MK3</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_609RDS_MK5</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_M6</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_M63</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_M6_EXTRA</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_H6</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_X7</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_H7</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_BEHOLD_A7</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;BeholdTV&quot;</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">get_key_beholdm6xx</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_BEHOLD</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">RC_TYPE_NEC</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x2d</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_CARDBUS_501</span>:
	<span class="k">case</span> <span class="n">SAA7134_BOARD_AVERMEDIA_CARDBUS_506</span>:
		<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SAA7134_BOARD_FLYDVB_TRIO</span>:
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;FlyDVB Trio&quot;</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">get_key</span> <span class="o">=</span> <span class="n">get_key_flydvb_trio</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">ir_codes</span> <span class="o">=</span> <span class="n">RC_MAP_FLYDVB</span><span class="p">;</span>
		<span class="n">info</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="mh">0x0b</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;No I2C IR support for board %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
		<span class="n">info</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">init_data</span><span class="p">;</span>
	<span class="n">i2c_new_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7134_raw_decode_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7134_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7134_card_ir</span> <span class="o">*</span><span class="n">ir</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">space</span><span class="p">;</span>

	<span class="cm">/* Generate initial event */</span>
	<span class="n">saa_clearb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>
	<span class="n">saa_setb</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPMODE3</span><span class="p">,</span> <span class="n">SAA7134_GPIO_GPRESCAN</span><span class="p">);</span>
	<span class="n">space</span> <span class="o">=</span> <span class="n">saa_readl</span><span class="p">(</span><span class="n">SAA7134_GPIO_GPSTATUS0</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ir</span><span class="o">-&gt;</span><span class="n">mask_keydown</span><span class="p">;</span>
	<span class="n">ir_raw_event_store_edge</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">space</span> <span class="o">?</span> <span class="n">IR_SPACE</span> <span class="o">:</span> <span class="n">IR_PULSE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wait 15 ms from the start of the first IR event before processing</span>
<span class="cm">	 * the event. This time is enough for NEC protocol. May need adjustments</span>
<span class="cm">	 * to work with other protocols.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">15</span><span class="p">);</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ir</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">timeout</span><span class="p">);</span>
		<span class="n">ir</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
