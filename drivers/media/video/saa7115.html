<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › saa7115.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>saa7115.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* saa711x - Philips SAA711x video decoder driver</span>
<span class="cm"> * This driver can work with saa7111, saa7111a, saa7113, saa7114,</span>
<span class="cm"> *			     saa7115 and saa7118.</span>
<span class="cm"> *</span>
<span class="cm"> * Based on saa7114 driver by Maxim Yevtyushkin, which is based on</span>
<span class="cm"> * the saa7111 driver by Dave Perks.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1998 Dave Perks &lt;dperks@ibm.net&gt;</span>
<span class="cm"> * Copyright (C) 2002 Maxim Yevtyushkin &lt;max@linuxmedialabs.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Slight changes for video timing and attachment output by</span>
<span class="cm"> * Wolfgang Scherr &lt;scherr@net4you.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Moved over to the linux &gt;= 2.4.x i2c protocol (1/1/2003)</span>
<span class="cm"> * by Ronald Bultje &lt;rbultje@ronald.bitfreak.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Added saa7115 support by Kevin Thayer &lt;nufan_wfk at yahoo.com&gt;</span>
<span class="cm"> * (2/17/2003)</span>
<span class="cm"> *</span>
<span class="cm"> * VBI support (2004) and cleanups (2005) by Hans Verkuil &lt;hverkuil@xs4all.nl&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2005-2006 Mauro Carvalho Chehab &lt;mchehab@infradead.org&gt;</span>
<span class="cm"> *	SAA7111, SAA7113 and SAA7118 support</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;saa711x_regs.h&quot;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &lt;media/saa7115.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#define VRES_60HZ	(480+16)</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Philips SAA7111/SAA7113/SAA7114/SAA7115/SAA7118 video decoder driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span>  <span class="s">&quot;Maxim Yevtyushkin, Kevin Thayer, Chris Kennedy, &quot;</span>
		<span class="s">&quot;Hans Verkuil, Mauro Carvalho Chehab&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;Debug level (0-1)&quot;</span><span class="p">);</span>


<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">hdl</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="cm">/* chroma gain control cluster */</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">agc</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">gain</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">output</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">enable</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">radio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">height</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ident</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">audclk_freq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crystal_freq</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ucgc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cgcdiv</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">apll</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="nf">to_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa711x_state</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">to_sd</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa711x_state</span><span class="p">,</span> <span class="n">hdl</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">saa711x_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Sanity routine to check if a register is present */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_has_reg</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">V4L2_IDENT_SAA7111</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x0f</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x13</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x19</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x1d</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x1e</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="n">V4L2_IDENT_SAA7111A</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x0f</span> <span class="o">&amp;&amp;</span>
		       <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x14</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x18</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x19</span> <span class="o">&amp;&amp;</span>
		       <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x1d</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x1e</span><span class="p">;</span>

	<span class="cm">/* common for saa7113/4/5/8 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x3b</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0x5c</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0x5f</span> <span class="o">||</span>
	    <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xa3</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xa7</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xab</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xaf</span> <span class="o">||</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0xb5</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0xb7</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xd3</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xd7</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xdb</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">==</span> <span class="mh">0xdf</span> <span class="o">||</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0xe5</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0xe7</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">reg</span> <span class="o">==</span> <span class="mh">0x82</span> <span class="o">||</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="mh">0x89</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;=</span> <span class="mh">0x8e</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_IDENT_SAA7113</span>:
		<span class="k">return</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x14</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x18</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x5d</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x63</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_IDENT_SAA7114</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x1a</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x2f</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x63</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x33</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x37</span> <span class="o">&amp;&amp;</span>
		       <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x81</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_IDENT_SAA7115</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x2f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x65</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xfc</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0xfe</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_IDENT_SAA7118</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x1a</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x1d</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x20</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x22</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x26</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x28</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x33</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x37</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0x63</span> <span class="o">||</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">!=</span> <span class="mh">0x81</span> <span class="o">&amp;&amp;</span> <span class="n">reg</span> <span class="o">&lt;</span> <span class="mh">0xf0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_writeregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">regs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">regs</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">regs</span><span class="o">++</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">regs</span><span class="o">++</span><span class="p">);</span>

		<span class="cm">/* According with datasheets, reserved regs should be</span>
<span class="cm">		   filled with 0 - seems better not to touch on they */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saa711x_has_reg</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">reg</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tried to access reserved reg 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">saa711x_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="cm">/* SAA7111 initialization table */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7111_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">R_01_INC_DELAY</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="cm">/* reserved */</span>

	<span class="cm">/*front end */</span>
	<span class="n">R_02_INPUT_CNTL_1</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>	<span class="cm">/* FUSE=3, GUDL=2, MODE=0 */</span>
	<span class="n">R_03_INPUT_CNTL_2</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span>	<span class="cm">/* HLNRS=0, VBSL=1, WPOFF=0, HOLDG=0,</span>
<span class="cm">					 * GAFIX=0, GAI1=256, GAI2=256 */</span>
	<span class="n">R_04_INPUT_CNTL_3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* GAI1=256 */</span>
	<span class="n">R_05_INPUT_CNTL_4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* GAI2=256 */</span>

	<span class="cm">/* decoder */</span>
	<span class="n">R_06_H_SYNC_START</span><span class="p">,</span> <span class="mh">0xf3</span><span class="p">,</span>	<span class="cm">/* HSB at  13(50Hz) /  17(60Hz)</span>
<span class="cm">					 * pixels after end of last line */</span>
	<span class="n">R_07_H_SYNC_STOP</span><span class="p">,</span> <span class="mh">0xe8</span><span class="p">,</span>		<span class="cm">/* HSS seems to be needed to</span>
<span class="cm">					 * work with NTSC, too */</span>
	<span class="n">R_08_SYNC_CNTL</span><span class="p">,</span> <span class="mh">0xc8</span><span class="p">,</span>		<span class="cm">/* AUFD=1, FSEL=1, EXFIL=0,</span>
<span class="cm">					 * VTRC=1, HPLL=0, VNOI=0 */</span>
	<span class="n">R_09_LUMA_CNTL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>		<span class="cm">/* BYPS=0, PREF=0, BPSS=0,</span>
<span class="cm">					 * VBLB=0, UPTCV=0, APER=1 */</span>
	<span class="n">R_0A_LUMA_BRIGHT_CNTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">R_0B_LUMA_CONTRAST_CNTL</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span>	<span class="cm">/* 0b - CONT=1.109 */</span>
	<span class="n">R_0C_CHROMA_SAT_CNTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">R_0D_CHROMA_HUE_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_0E_CHROMA_CNTL_1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* 0e - CDTO=0, CSTD=0, DCCF=0,</span>
<span class="cm">					 * FCTC=0, CHBW=1 */</span>
	<span class="n">R_0F_CHROMA_GAIN_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* reserved */</span>
	<span class="n">R_10_CHROMA_CNTL_2</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>	<span class="cm">/* 10 - OFTS=1, HDEL=0, VRLN=1, YDEL=0 */</span>
	<span class="n">R_11_MODE_DELAY_CNTL</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span>	<span class="cm">/* 11 - GPSW=0, CM99=0, FECO=0, COMPO=1,</span>
<span class="cm">					 * OEYC=1, OEHV=1, VIPB=0, COLO=0 */</span>
	<span class="n">R_12_RT_SIGNAL_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* 12 - output control 2 */</span>
	<span class="n">R_13_RT_X_PORT_OUT_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* 13 - output control 3 */</span>
	<span class="n">R_14_ANAL_ADC_COMPAT_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_15_VGATE_START_FID_CHG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_16_VGATE_STOP</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_17_MISC_VGATE_CONF_AND_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="cm">/* SAA7113 init codes */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7113_init</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">R_01_INC_DELAY</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">R_02_INPUT_CNTL_1</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span>
	<span class="n">R_03_INPUT_CNTL_2</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>
	<span class="n">R_04_INPUT_CNTL_3</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_05_INPUT_CNTL_4</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_06_H_SYNC_START</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span>
	<span class="n">R_07_H_SYNC_STOP</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span>
	<span class="n">R_08_SYNC_CNTL</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span>
	<span class="n">R_09_LUMA_CNTL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">R_0A_LUMA_BRIGHT_CNTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">R_0B_LUMA_CONTRAST_CNTL</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span>
	<span class="n">R_0C_CHROMA_SAT_CNTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">R_0D_CHROMA_HUE_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_0E_CHROMA_CNTL_1</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">R_0F_CHROMA_GAIN_CNTL</span><span class="p">,</span> <span class="mh">0x2a</span><span class="p">,</span>
	<span class="n">R_10_CHROMA_CNTL_2</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">R_11_MODE_DELAY_CNTL</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="n">R_12_RT_SIGNAL_CNTL</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>
	<span class="n">R_13_RT_X_PORT_OUT_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_14_ANAL_ADC_COMPAT_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_15_VGATE_START_FID_CHG</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_16_VGATE_STOP</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_17_MISC_VGATE_CONF_AND_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="cm">/* If a value differs from the Hauppauge driver values, then the comment starts with</span>
<span class="cm">   &#39;was 0xXX&#39; to denote the Hauppauge value. Otherwise the value is identical to what the</span>
<span class="cm">   Hauppauge driver sets. */</span>

<span class="cm">/* SAA7114 and SAA7115 initialization table */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7115_init_auto_input</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="cm">/* Front-End Part */</span>
	<span class="n">R_01_INC_DELAY</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>			<span class="cm">/* white peak control disabled */</span>
	<span class="n">R_03_INPUT_CNTL_2</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>		<span class="cm">/* was 0x30. 0x20: long vertical blanking */</span>
	<span class="n">R_04_INPUT_CNTL_3</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span>		<span class="cm">/* analog gain set to 0 */</span>
	<span class="n">R_05_INPUT_CNTL_4</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span>		<span class="cm">/* analog gain set to 0 */</span>
		<span class="cm">/* Decoder Part */</span>
	<span class="n">R_06_H_SYNC_START</span><span class="p">,</span> <span class="mh">0xeb</span><span class="p">,</span>		<span class="cm">/* horiz sync begin = -21 */</span>
	<span class="n">R_07_H_SYNC_STOP</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span>			<span class="cm">/* horiz sync stop = -17 */</span>
	<span class="n">R_09_LUMA_CNTL</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">,</span>			<span class="cm">/* 0x53, was 0x56 for 60hz. luminance control */</span>
	<span class="n">R_0A_LUMA_BRIGHT_CNTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>		<span class="cm">/* was 0x88. decoder brightness, 0x80 is itu standard */</span>
	<span class="n">R_0B_LUMA_CONTRAST_CNTL</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span>		<span class="cm">/* was 0x48. decoder contrast, 0x44 is itu standard */</span>
	<span class="n">R_0C_CHROMA_SAT_CNTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>		<span class="cm">/* was 0x47. decoder saturation, 0x40 is itu standard */</span>
	<span class="n">R_0D_CHROMA_HUE_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_0F_CHROMA_GAIN_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>		<span class="cm">/* use automatic gain  */</span>
	<span class="n">R_10_CHROMA_CNTL_2</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span>		<span class="cm">/* chroma: active adaptive combfilter */</span>
	<span class="n">R_11_MODE_DELAY_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_12_RT_SIGNAL_CNTL</span><span class="p">,</span> <span class="mh">0x9d</span><span class="p">,</span>		<span class="cm">/* RTS0 output control: VGATE */</span>
	<span class="n">R_13_RT_X_PORT_OUT_CNTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>		<span class="cm">/* ITU656 standard mode, RTCO output enable RTCE */</span>
	<span class="n">R_14_ANAL_ADC_COMPAT_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_18_RAW_DATA_GAIN_CNTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>		<span class="cm">/* gain 0x00 = nominal */</span>
	<span class="n">R_19_RAW_DATA_OFF_CNTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">R_1A_COLOR_KILL_LVL_CNTL</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span>		<span class="cm">/* recommended value */</span>
	<span class="n">R_1B_MISC_TVVCRDET</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span>		<span class="cm">/* recommended value */</span>
	<span class="n">R_1C_ENHAN_COMB_CTRL1</span><span class="p">,</span> <span class="mh">0xa9</span><span class="p">,</span>		<span class="cm">/* recommended value */</span>
	<span class="n">R_1D_ENHAN_COMB_CTRL2</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>		<span class="cm">/* recommended value */</span>


	<span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span>		<span class="cm">/* No tasks enabled at init */</span>

		<span class="cm">/* Power Device Control */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>	<span class="cm">/* reset device */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>	<span class="cm">/* set device programmed, all in operational mode */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="cm">/* Used to reset saa7113, saa7114 and saa7115 */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7115_cfg_reset_scaler</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">R_87_I_PORT_I_O_ENA_OUT_CLK_AND_GATED</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* disable I-port output */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>		<span class="cm">/* reset scaler */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>		<span class="cm">/* activate scaler */</span>
	<span class="n">R_87_I_PORT_I_O_ENA_OUT_CLK_AND_GATED</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* enable I-port output */</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="cm">/* ============== SAA7715 VIDEO templates =============  */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7115_cfg_60hz_video</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* reset tasks */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>		<span class="cm">/* reset scaler */</span>

	<span class="n">R_15_VGATE_START_FID_CHG</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">R_16_VGATE_STOP</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span>
	<span class="n">R_17_MISC_VGATE_CONF_AND_MSB</span><span class="p">,</span> <span class="mh">0x9c</span><span class="p">,</span>

	<span class="n">R_08_SYNC_CNTL</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span>			<span class="cm">/* 0xBO: auto detection, 0x68 = NTSC */</span>
	<span class="n">R_0E_CHROMA_CNTL_1</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>		<span class="cm">/* video autodetection is on */</span>

	<span class="n">R_5A_V_OFF_FOR_SLICER</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span>		<span class="cm">/* standard 60hz value for ITU656 line counting */</span>

	<span class="cm">/* Task A */</span>
	<span class="n">R_90_A_TASK_HANDLING_CNTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">R_91_A_X_PORT_FORMATS_AND_CONF</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="n">R_92_A_X_PORT_INPUT_REFERENCE_SIGNAL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">R_93_A_I_PORT_OUTPUT_FORMATS_AND_CONF</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>

	<span class="cm">/* hoffset low (input), 0x0002 is minimum */</span>
	<span class="n">R_94_A_HORIZ_INPUT_WINDOW_START</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">R_95_A_HORIZ_INPUT_WINDOW_START_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* hsize low (input), 0x02d0 = 720 */</span>
	<span class="n">R_96_A_HORIZ_INPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="n">R_97_A_HORIZ_INPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>

	<span class="n">R_98_A_VERT_INPUT_WINDOW_START</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>
	<span class="n">R_99_A_VERT_INPUT_WINDOW_START_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="n">R_9A_A_VERT_INPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="n">R_9B_A_VERT_INPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="n">R_9C_A_HORIZ_OUTPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span>
	<span class="n">R_9D_A_HORIZ_OUTPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>

	<span class="n">R_9E_A_VERT_OUTPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span>
	<span class="n">R_9F_A_VERT_OUTPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* Task B */</span>
	<span class="n">R_C0_B_TASK_HANDLING_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_C1_B_X_PORT_FORMATS_AND_CONF</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">R_C2_B_INPUT_REFERENCE_SIGNAL_DEFINITION</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_C3_B_I_PORT_FORMATS_AND_CONF</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>

	<span class="cm">/* 0x0002 is minimum */</span>
	<span class="n">R_C4_B_HORIZ_INPUT_WINDOW_START</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">R_C5_B_HORIZ_INPUT_WINDOW_START_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* 0x02d0 = 720 */</span>
	<span class="n">R_C6_B_HORIZ_INPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="n">R_C7_B_HORIZ_INPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>

	<span class="cm">/* vwindow start 0x12 = 18 */</span>
	<span class="n">R_C8_B_VERT_INPUT_WINDOW_START</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="n">R_C9_B_VERT_INPUT_WINDOW_START_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* vwindow length 0xf8 = 248 */</span>
	<span class="n">R_CA_B_VERT_INPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="n">VRES_60HZ</span><span class="o">&gt;&gt;</span><span class="mi">1</span><span class="p">,</span>
	<span class="n">R_CB_B_VERT_INPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="n">VRES_60HZ</span><span class="o">&gt;&gt;</span><span class="mi">9</span><span class="p">,</span>

	<span class="cm">/* hwindow 0x02d0 = 720 */</span>
	<span class="n">R_CC_B_HORIZ_OUTPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="n">R_CD_B_HORIZ_OUTPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>

	<span class="n">R_F0_LFCO_PER_LINE</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span>		<span class="cm">/* Set PLL Register. 60hz 525 lines per frame, 27 MHz */</span>
	<span class="n">R_F1_P_I_PARAM_SELECT</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>		<span class="cm">/* low bit with 0xF0 */</span>
	<span class="n">R_F5_PULSGEN_LINE_LENGTH</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">,</span>
	<span class="n">R_F6_PULSE_A_POS_LSB_AND_PULSEGEN_CONFIG</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7115_cfg_50hz_video</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>	<span class="cm">/* reset scaler */</span>

	<span class="n">R_15_VGATE_START_FID_CHG</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">,</span>		<span class="cm">/* VGATE start */</span>
	<span class="n">R_16_VGATE_STOP</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span>
	<span class="n">R_17_MISC_VGATE_CONF_AND_MSB</span><span class="p">,</span> <span class="mh">0x99</span><span class="p">,</span>

	<span class="n">R_08_SYNC_CNTL</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span>			<span class="cm">/* 0x28 = PAL */</span>
	<span class="n">R_0E_CHROMA_CNTL_1</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span>

	<span class="n">R_5A_V_OFF_FOR_SLICER</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>		<span class="cm">/* standard 50hz value */</span>

	<span class="cm">/* Task A */</span>
	<span class="n">R_90_A_TASK_HANDLING_CNTL</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span>
	<span class="n">R_91_A_X_PORT_FORMATS_AND_CONF</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span>
	<span class="n">R_92_A_X_PORT_INPUT_REFERENCE_SIGNAL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">R_93_A_I_PORT_OUTPUT_FORMATS_AND_CONF</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>

	<span class="cm">/* This is weird: the datasheet says that you should use 2 as the minimum value, */</span>
	<span class="cm">/* but Hauppauge uses 0, and changing that to 2 causes indeed problems (for 50hz) */</span>
	<span class="cm">/* hoffset low (input), 0x0002 is minimum */</span>
	<span class="n">R_94_A_HORIZ_INPUT_WINDOW_START</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_95_A_HORIZ_INPUT_WINDOW_START_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* hsize low (input), 0x02d0 = 720 */</span>
	<span class="n">R_96_A_HORIZ_INPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="n">R_97_A_HORIZ_INPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>

	<span class="n">R_98_A_VERT_INPUT_WINDOW_START</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span>
	<span class="n">R_99_A_VERT_INPUT_WINDOW_START_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* vsize 0x12 = 18 */</span>
	<span class="n">R_9A_A_VERT_INPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>
	<span class="n">R_9B_A_VERT_INPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* hsize 0x05a0 = 1440 */</span>
	<span class="n">R_9C_A_HORIZ_OUTPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span>
	<span class="n">R_9D_A_HORIZ_OUTPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>	<span class="cm">/* hsize hi (output) */</span>
	<span class="n">R_9E_A_VERT_OUTPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span>		<span class="cm">/* vsize low (output), 0x12 = 18 */</span>
	<span class="n">R_9F_A_VERT_OUTPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* vsize hi (output) */</span>

	<span class="cm">/* Task B */</span>
	<span class="n">R_C0_B_TASK_HANDLING_CNTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_C1_B_X_PORT_FORMATS_AND_CONF</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="n">R_C2_B_INPUT_REFERENCE_SIGNAL_DEFINITION</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_C3_B_I_PORT_FORMATS_AND_CONF</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>

	<span class="cm">/* This is weird: the datasheet says that you should use 2 as the minimum value, */</span>
	<span class="cm">/* but Hauppauge uses 0, and changing that to 2 causes indeed problems (for 50hz) */</span>
	<span class="cm">/* hoffset low (input), 0x0002 is minimum. See comment above. */</span>
	<span class="n">R_C4_B_HORIZ_INPUT_WINDOW_START</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_C5_B_HORIZ_INPUT_WINDOW_START_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* hsize 0x02d0 = 720 */</span>
	<span class="n">R_C6_B_HORIZ_INPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="n">R_C7_B_HORIZ_INPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>

	<span class="cm">/* voffset 0x16 = 22 */</span>
	<span class="n">R_C8_B_VERT_INPUT_WINDOW_START</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span>
	<span class="n">R_C9_B_VERT_INPUT_WINDOW_START_MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* vsize 0x0120 = 288 */</span>
	<span class="n">R_CA_B_VERT_INPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">R_CB_B_VERT_INPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="cm">/* hsize 0x02d0 = 720 */</span>
	<span class="n">R_CC_B_HORIZ_OUTPUT_WINDOW_LENGTH</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="n">R_CD_B_HORIZ_OUTPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>

	<span class="n">R_F0_LFCO_PER_LINE</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span>		<span class="cm">/* Set PLL Register. 50hz 625 lines per frame, 27 MHz */</span>
	<span class="n">R_F1_P_I_PARAM_SELECT</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span>		<span class="cm">/* low bit with 0xF0, (was 0x05) */</span>
	<span class="n">R_F5_PULSGEN_LINE_LENGTH</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span>
	<span class="n">R_F6_PULSE_A_POS_LSB_AND_PULSEGEN_CONFIG</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="cm">/* ============== SAA7715 VIDEO templates (end) =======  */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7115_cfg_vbi_on</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* reset tasks */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>		<span class="cm">/* reset scaler */</span>
	<span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span>			<span class="cm">/* Activate both tasks */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>		<span class="cm">/* activate scaler */</span>
	<span class="n">R_87_I_PORT_I_O_ENA_OUT_CLK_AND_GATED</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* Enable I-port output */</span>

	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7115_cfg_vbi_off</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>			<span class="cm">/* reset tasks */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>		<span class="cm">/* reset scaler */</span>
	<span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>			<span class="cm">/* Activate only task &quot;B&quot; */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>		<span class="cm">/* activate scaler */</span>
	<span class="n">R_87_I_PORT_I_O_ENA_OUT_CLK_AND_GATED</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>	<span class="cm">/* Enable I-port output */</span>

	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">saa7115_init_misc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">R_81_V_SYNC_FLD_ID_SRC_SEL_AND_RETIMED_V_F</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">R_83_X_PORT_I_O_ENA_AND_OUT_CLK</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">R_84_I_PORT_SIGNAL_DEF</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>
	<span class="n">R_85_I_PORT_SIGNAL_POLAR</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span>
	<span class="n">R_86_I_PORT_FIFO_FLAG_CNTL_AND_ARBIT</span><span class="p">,</span> <span class="mh">0xc5</span><span class="p">,</span>
	<span class="n">R_87_I_PORT_I_O_ENA_OUT_CLK_AND_GATED</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="cm">/* Task A */</span>
	<span class="n">R_A0_A_HORIZ_PRESCALING</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">R_A1_A_ACCUMULATION_LENGTH</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_A2_A_PRESCALER_DC_GAIN_AND_FIR_PREFILTER</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* Configure controls at nominal value*/</span>
	<span class="n">R_A4_A_LUMA_BRIGHTNESS_CNTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">R_A5_A_LUMA_CONTRAST_CNTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">R_A6_A_CHROMA_SATURATION_CNTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>

	<span class="cm">/* note: 2 x zoom ensures that VBI lines have same length as video lines. */</span>
	<span class="n">R_A8_A_HORIZ_LUMA_SCALING_INC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_A9_A_HORIZ_LUMA_SCALING_INC_MSB</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>

	<span class="n">R_AA_A_HORIZ_LUMA_PHASE_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* must be horiz lum scaling / 2 */</span>
	<span class="n">R_AC_A_HORIZ_CHROMA_SCALING_INC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_AD_A_HORIZ_CHROMA_SCALING_INC_MSB</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="cm">/* must be offset luma / 2 */</span>
	<span class="n">R_AE_A_HORIZ_CHROMA_PHASE_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="n">R_B0_A_VERT_LUMA_SCALING_INC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_B1_A_VERT_LUMA_SCALING_INC_MSB</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>

	<span class="n">R_B2_A_VERT_CHROMA_SCALING_INC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_B3_A_VERT_CHROMA_SCALING_INC_MSB</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>

	<span class="n">R_B4_A_VERT_SCALING_MODE_CNTL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="n">R_B8_A_VERT_CHROMA_PHASE_OFF_00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_B9_A_VERT_CHROMA_PHASE_OFF_01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_BA_A_VERT_CHROMA_PHASE_OFF_10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_BB_A_VERT_CHROMA_PHASE_OFF_11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="n">R_BC_A_VERT_LUMA_PHASE_OFF_00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_BD_A_VERT_LUMA_PHASE_OFF_01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_BE_A_VERT_LUMA_PHASE_OFF_10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_BF_A_VERT_LUMA_PHASE_OFF_11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* Task B */</span>
	<span class="n">R_D0_B_HORIZ_PRESCALING</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">R_D1_B_ACCUMULATION_LENGTH</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_D2_B_PRESCALER_DC_GAIN_AND_FIR_PREFILTER</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* Configure controls at nominal value*/</span>
	<span class="n">R_D4_B_LUMA_BRIGHTNESS_CNTL</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">R_D5_B_LUMA_CONTRAST_CNTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">R_D6_B_CHROMA_SATURATION_CNTL</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>

	<span class="cm">/* hor lum scaling 0x0400 = 1 */</span>
	<span class="n">R_D8_B_HORIZ_LUMA_SCALING_INC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_D9_B_HORIZ_LUMA_SCALING_INC_MSB</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>

	<span class="n">R_DA_B_HORIZ_LUMA_PHASE_OFF</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="cm">/* must be hor lum scaling / 2 */</span>
	<span class="n">R_DC_B_HORIZ_CHROMA_SCALING</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_DD_B_HORIZ_CHROMA_SCALING_MSB</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span>

	<span class="cm">/* must be offset luma / 2 */</span>
	<span class="n">R_DE_B_HORIZ_PHASE_OFFSET_CRHOMA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="n">R_E0_B_VERT_LUMA_SCALING_INC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_E1_B_VERT_LUMA_SCALING_INC_MSB</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>

	<span class="n">R_E2_B_VERT_CHROMA_SCALING_INC</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_E3_B_VERT_CHROMA_SCALING_INC_MSB</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span>

	<span class="n">R_E4_B_VERT_SCALING_MODE_CNTL</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span>

	<span class="n">R_E8_B_VERT_CHROMA_PHASE_OFF_00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_E9_B_VERT_CHROMA_PHASE_OFF_01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_EA_B_VERT_CHROMA_PHASE_OFF_10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_EB_B_VERT_CHROMA_PHASE_OFF_11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="n">R_EC_B_VERT_LUMA_PHASE_OFF_00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_ED_B_VERT_LUMA_PHASE_OFF_01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_EE_B_VERT_LUMA_PHASE_OFF_10</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_EF_B_VERT_LUMA_PHASE_OFF_11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>

	<span class="n">R_F2_NOMINAL_PLL2_DTO</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span>		<span class="cm">/* crystal clock = 24.576 MHz, target = 27MHz */</span>
	<span class="n">R_F3_PLL_INCREMENT</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">,</span>
	<span class="n">R_F4_PLL2_STATUS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_F7_PULSE_A_POS_MSB</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>		<span class="cm">/* not the recommended settings! */</span>
	<span class="n">R_F8_PULSE_B_POS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_F9_PULSE_B_POS_MSB</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>
	<span class="n">R_FA_PULSE_C_POS</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span>
	<span class="n">R_FB_PULSE_C_POS_MSB</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span>

	<span class="cm">/* PLL2 lock detection settings: 71 lines 50% phase error */</span>
	<span class="n">R_FF_S_PLL_MAX_PHASE_ERR_THRESH_NUM_LINES</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span>

	<span class="cm">/* Turn off VBI */</span>
	<span class="n">R_40_SLICER_CNTL_1</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>             <span class="cm">/* No framing code errors allowed. */</span>
	<span class="n">R_41_LCR_BASE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">3</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">4</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">5</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">6</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">7</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">9</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">10</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">11</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">12</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">13</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">14</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">15</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">16</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">17</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">18</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">19</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">20</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">21</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_41_LCR_BASE</span><span class="o">+</span><span class="mi">22</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
	<span class="n">R_58_PROGRAM_FRAMING_CODE</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">R_59_H_OFF_FOR_SLICER</span><span class="p">,</span> <span class="mh">0x47</span><span class="p">,</span>
	<span class="n">R_5B_FLD_OFF_AND_MSB_FOR_H_AND_V_OFF</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span>
	<span class="n">R_5D_DID</span><span class="p">,</span> <span class="mh">0xbd</span><span class="p">,</span>
	<span class="n">R_5E_SDID</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">,</span>

	<span class="n">R_02_INPUT_CNTL_1</span><span class="p">,</span> <span class="mh">0xc4</span><span class="p">,</span> <span class="cm">/* input tuner -&gt; input 4, amplifier active */</span>

	<span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span>		<span class="cm">/* enable task B */</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>
	<span class="n">R_88_POWER_SAVE_ADC_PORT_CNTL</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_odd_parity</span><span class="p">(</span><span class="n">u8</span> <span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">c</span> <span class="o">^=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">^=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">c</span> <span class="o">^=</span> <span class="p">(</span><span class="n">c</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_decode_vps</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">biphase_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span>
		<span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
		<span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span>
		<span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span>
		<span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span>
		<span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>
		<span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span>
		<span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
		<span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span>
		<span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span>
		<span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span>
		<span class="mh">0x83</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span> <span class="mh">0x4b</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0xc3</span><span class="p">,</span>
		<span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x85</span><span class="p">,</span>
		<span class="mh">0x81</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x81</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span> <span class="mh">0x49</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0xc1</span><span class="p">,</span>
		<span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">,</span>
		<span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0xa1</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">,</span> <span class="mh">0x61</span><span class="p">,</span> <span class="mh">0xe1</span><span class="p">,</span>
		<span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span>
		<span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span>
		<span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">,</span>
		<span class="mh">0x82</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span> <span class="mh">0x4a</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0xc2</span><span class="p">,</span>
		<span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">,</span>
		<span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span>
		<span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span>
		<span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">,</span> <span class="mh">0xe0</span><span class="p">,</span>
		<span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span>
		<span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
		<span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span>
		<span class="mh">0x92</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x92</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x52</span><span class="p">,</span> <span class="mh">0xd2</span><span class="p">,</span>
		<span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x94</span><span class="p">,</span>
		<span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span> <span class="mh">0x58</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">,</span>
		<span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span> <span class="mh">0x3c</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0xb4</span><span class="p">,</span>
		<span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="mh">0xb0</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">,</span> <span class="mh">0x70</span><span class="p">,</span> <span class="mh">0xf0</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">c</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">biphase_tbl</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">|</span> <span class="n">biphase_tbl</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]];</span>
		<span class="n">c</span> <span class="o">=</span> <span class="p">(</span><span class="n">biphase_tbl</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">biphase_tbl</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">dst</span><span class="p">[</span><span class="n">i</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_decode_wss</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">wss_bits</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">parity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wss</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">b1</span> <span class="o">=</span> <span class="n">wss_bits</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">b2</span> <span class="o">=</span> <span class="n">wss_bits</span><span class="p">[(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b1</span> <span class="o">==</span> <span class="n">b2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">wss</span> <span class="o">|=</span> <span class="n">b2</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">parity</span> <span class="o">=</span> <span class="n">wss</span> <span class="o">&amp;</span> <span class="mi">15</span><span class="p">;</span>
	<span class="n">parity</span> <span class="o">^=</span> <span class="n">parity</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">parity</span> <span class="o">^=</span> <span class="n">parity</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">parity</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">wss</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_clock_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">acpf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">acni</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hz</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">f</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">acc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 	<span class="cm">/* reg 0x3a, audio clock control */</span>

	<span class="cm">/* Checks for chips that don&#39;t have audio clock (saa7111, saa7113) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saa711x_has_reg</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">R_30_AUD_MAST_CLK_CYCLES_PER_FIELD</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;set audio clock freq: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="cm">/* sanity check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="mi">32000</span> <span class="o">||</span> <span class="n">freq</span> <span class="o">&gt;</span> <span class="mi">48000</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* hz is the refresh rate times 100 */</span>
	<span class="n">hz</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="o">?</span> <span class="mi">5994</span> <span class="o">:</span> <span class="mi">5000</span><span class="p">;</span>
	<span class="cm">/* acpf = (256 * freq) / field_frequency == (256 * 100 * freq) / hz */</span>
	<span class="n">acpf</span> <span class="o">=</span> <span class="p">(</span><span class="mi">25600</span> <span class="o">*</span> <span class="n">freq</span><span class="p">)</span> <span class="o">/</span> <span class="n">hz</span><span class="p">;</span>
	<span class="cm">/* acni = (256 * freq * 2^23) / crystal_frequency =</span>
<span class="cm">		  (freq * 2^(8+23)) / crystal_frequency =</span>
<span class="cm">		  (freq &lt;&lt; 31) / crystal_frequency */</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">f</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">;</span>
	<span class="n">do_div</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">crystal_freq</span><span class="p">);</span>
	<span class="n">acni</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ucgc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">acpf</span> <span class="o">=</span> <span class="n">acpf</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cgcdiv</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">acni</span> <span class="o">=</span> <span class="n">acni</span> <span class="o">*</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">cgcdiv</span> <span class="o">/</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">acc</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">cgcdiv</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">acc</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">apll</span><span class="p">)</span>
		<span class="n">acc</span> <span class="o">|=</span> <span class="mh">0x08</span><span class="p">;</span>

	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_38_CLK_RATIO_AMXCLK_TO_ASCLK</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_39_CLK_RATIO_ASCLK_TO_ALRCLK</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_3A_AUD_CLK_GEN_BASIC_SETUP</span><span class="p">,</span> <span class="n">acc</span><span class="p">);</span>

	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_30_AUD_MAST_CLK_CYCLES_PER_FIELD</span><span class="p">,</span> <span class="n">acpf</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_30_AUD_MAST_CLK_CYCLES_PER_FIELD</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
							<span class="p">(</span><span class="n">acpf</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_30_AUD_MAST_CLK_CYCLES_PER_FIELD</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span>
							<span class="p">(</span><span class="n">acpf</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>

	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_34_AUD_MAST_CLK_NOMINAL_INC</span><span class="p">,</span> <span class="n">acni</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_34_AUD_MAST_CLK_NOMINAL_INC</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">acni</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_34_AUD_MAST_CLK_NOMINAL_INC</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="p">(</span><span class="n">acni</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">audclk_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_g_volatile_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">to_sd</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CHROMA_AGC</span>:
		<span class="cm">/* chroma gain cluster */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">gain</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span>
				<span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_0F_CHROMA_GAIN_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">to_sd</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_0A_LUMA_BRIGHT_CNTL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_0B_LUMA_CONTRAST_CNTL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_0C_CHROMA_SAT_CNTL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
		<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_0D_CHROMA_HUE_CNTL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_CHROMA_AGC</span>:
		<span class="cm">/* chroma gain cluster */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">agc</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_0F_CHROMA_GAIN_CNTL</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">gain</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_0F_CHROMA_GAIN_CNTL</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">gain</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_set_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span> <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">HPSC</span><span class="p">,</span> <span class="n">HFSC</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">VSCY</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_50hz</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">Vsrc</span> <span class="o">=</span> <span class="n">is_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;decoder set size to %ix%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="cm">/* FIXME need better bounds checking here */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">width</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">1440</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">height</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">Vsrc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saa711x_has_reg</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">R_D0_B_HORIZ_PRESCALING</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Decoder only supports 720 columns and 480 or 576 lines */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">!=</span> <span class="mi">720</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">!=</span> <span class="n">Vsrc</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saa711x_has_reg</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">R_CC_B_HORIZ_OUTPUT_WINDOW_LENGTH</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* probably have a valid size, let&#39;s set it */</span>
	<span class="cm">/* Set output width/height */</span>
	<span class="cm">/* width */</span>

	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_CC_B_HORIZ_OUTPUT_WINDOW_LENGTH</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">width</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_CD_B_HORIZ_OUTPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="cm">/* Vertical Scaling uses height/2 */</span>
	<span class="n">res</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* On 60Hz, it is using a higher Vertical Output Size */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_50hz</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">VRES_60HZ</span> <span class="o">-</span> <span class="mi">480</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* height */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_CE_B_VERT_OUTPUT_WINDOW_LENGTH</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">res</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_CF_B_VERT_OUTPUT_WINDOW_LENGTH_MSB</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">res</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="cm">/* Scaling settings */</span>
	<span class="cm">/* Hprescaler is floor(inres/outres) */</span>
	<span class="n">HPSC</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="mi">720</span> <span class="o">/</span> <span class="n">width</span><span class="p">);</span>
	<span class="cm">/* 0 is not allowed (div. by zero) */</span>
	<span class="n">HPSC</span> <span class="o">=</span> <span class="n">HPSC</span> <span class="o">?</span> <span class="n">HPSC</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">HFSC</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="mi">1024</span> <span class="o">*</span> <span class="mi">720</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">HPSC</span> <span class="o">*</span> <span class="n">width</span><span class="p">));</span>
	<span class="cm">/* FIXME hardcodes to &quot;Task B&quot;</span>
<span class="cm">	 * write H prescaler integer */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_D0_B_HORIZ_PRESCALING</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">HPSC</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">));</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Hpsc: 0x%05x, Hfsc: 0x%05x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">HPSC</span><span class="p">,</span> <span class="n">HFSC</span><span class="p">);</span>
	<span class="cm">/* write H fine-scaling (luminance) */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_D8_B_HORIZ_LUMA_SCALING_INC</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">HFSC</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_D9_B_HORIZ_LUMA_SCALING_INC_MSB</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">HFSC</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="cm">/* write H fine-scaling (chrominance)</span>
<span class="cm">	 * must be lum/2, so i&#39;ll just bitshift :) */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_DC_B_HORIZ_CHROMA_SCALING</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">HFSC</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_DD_B_HORIZ_CHROMA_SCALING_MSB</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">HFSC</span> <span class="o">&gt;&gt;</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">VSCY</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)((</span><span class="mi">1024</span> <span class="o">*</span> <span class="n">Vsrc</span><span class="p">)</span> <span class="o">/</span> <span class="n">height</span><span class="p">);</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Vsrc: %d, Vscy: 0x%05x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">Vsrc</span><span class="p">,</span> <span class="n">VSCY</span><span class="p">);</span>

	<span class="cm">/* Correct Contrast and Luminance */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_D5_B_LUMA_CONTRAST_CNTL</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">/</span> <span class="n">VSCY</span><span class="p">));</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_D6_B_CHROMA_SATURATION_CNTL</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="mi">64</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">/</span> <span class="n">VSCY</span><span class="p">));</span>

		<span class="cm">/* write V fine-scaling (luminance) */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_E0_B_VERT_LUMA_SCALING_INC</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">VSCY</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_E1_B_VERT_LUMA_SCALING_INC_MSB</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">VSCY</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
		<span class="cm">/* write V fine-scaling (chrominance) */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_E2_B_VERT_CHROMA_SCALING_INC</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">VSCY</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_E3_B_VERT_CHROMA_SCALING_INC_MSB</span><span class="p">,</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">((</span><span class="n">VSCY</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">));</span>

	<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">saa7115_cfg_reset_scaler</span><span class="p">);</span>

	<span class="cm">/* Activates task &quot;B&quot; */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">,</span>
				<span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa711x_set_v4lstd</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="cm">/* Prevent unnecessary standard changes. During a standard</span>
<span class="cm">	   change the I-Port is temporarily disabled. Any devices</span>
<span class="cm">	   reading from that port can get confused.</span>
<span class="cm">	   Note that s_std is also used to switch from</span>
<span class="cm">	   radio to TV mode, so if a s_std is broadcast to</span>
<span class="cm">	   all I2C devices then you do not want to have an unwanted</span>
<span class="cm">	   side-effect here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">std</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>This works for NTSC-M, SECAM-L and the 50Hz PAL variants.</p></td><td class="code"><div class="highlight"><pre>	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;decoder set standard 60 Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">saa7115_cfg_60hz_video</span><span class="p">);</span>
		<span class="n">saa711x_set_size</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">480</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;decoder set standard 50 Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">saa7115_cfg_50hz_video</span><span class="p">);</span>
		<span class="n">saa711x_set_size</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">720</span><span class="p">,</span> <span class="mi">576</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register 0E - Bits D6-D4 on NO-AUTO mode</span>
<span class="cm">		(SAA7111 and SAA7113 doesn&#39;t have auto mode)</span>
<span class="cm">	    50 Hz / 625 lines           60 Hz / 525 lines</span>
<span class="cm">	000 PAL BGDHI (4.43Mhz)         NTSC M (3.58MHz)</span>
<span class="cm">	001 NTSC 4.43 (50 Hz)           PAL 4.43 (60 Hz)</span>
<span class="cm">	010 Combination-PAL N (3.58MHz) NTSC 4.43 (60 Hz)</span>
<span class="cm">	011 NTSC N (3.58MHz)            PAL M (3.58MHz)</span>
<span class="cm">	100 reserved                    NTSC-Japan (3.58MHz)</span>
<span class="cm">	*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">&lt;=</span> <span class="n">V4L2_IDENT_SAA7113</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_0E_CHROMA_CNTL_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x8f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL_60</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="mh">0x50</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_0E_CHROMA_CNTL_1</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* restart task B if needed */</span>
		<span class="kt">int</span> <span class="n">taskb</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">taskb</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">V4L2_IDENT_SAA7114</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">saa7115_cfg_vbi_on</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* switch audio mode too! */</span>
		<span class="n">saa711x_s_clock_freq</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">audclk_freq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* setup the sliced VBI lcr registers according to the sliced VBI format */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa711x_set_lcr</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_50hz</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">lcr</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">x</span><span class="p">;</span>

<span class="cp">#if 1</span>
	<span class="cm">/* saa7113/7114/7118 VBI support are experimental */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saa711x_has_reg</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">R_41_LCR_BASE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

<span class="cp">#else</span>
	<span class="cm">/* SAA7113 and SAA7118 also should support VBI - Need testing */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">!=</span> <span class="n">V4L2_IDENT_SAA7115</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* raw VBI */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_50hz</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdd</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">21</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xdd</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* sliced VBI */</span>
		<span class="cm">/* first clear lines that cannot be captured */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_50hz</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">9</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">22</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now set the lcr values according to the specified service */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">x</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">][</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
					<span class="k">case</span> <span class="mi">0</span>:
						<span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">V4L2_SLICED_TELETEXT_B</span>:
						<span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">V4L2_SLICED_CAPTION_525</span>:
						<span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">4</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">V4L2_SLICED_WSS_625</span>:
						<span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="k">case</span> <span class="n">V4L2_SLICED_VPS</span>:
						<span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">7</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* write the lcr registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">R_41_LCR_BASE</span><span class="p">,</span> <span class="n">lcr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="cm">/* enable/disable raw VBI capturing */</span>
	<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fmt</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">?</span>
				<span class="n">saa7115_cfg_vbi_on</span> <span class="o">:</span>
				<span class="n">saa7115_cfg_vbi_off</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_g_sliced_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">sliced</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="n">u16</span> <span class="n">lcr2vbi</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_SLICED_TELETEXT_B</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* 1 */</span>
		<span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">,</span>	<span class="cm">/* 4 */</span>
		<span class="n">V4L2_SLICED_WSS_625</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>		<span class="cm">/* 5 */</span>
		<span class="n">V4L2_SLICED_VPS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* 7 */</span>
		<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sliced</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sliced</span><span class="p">));</span>
	<span class="cm">/* done if using raw VBI */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_80_GLOBAL_CNTL_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="mi">23</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">v</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">R_41_LCR_BASE</span><span class="p">);</span>

		<span class="n">sliced</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcr2vbi</span><span class="p">[</span><span class="n">v</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">];</span>
		<span class="n">sliced</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcr2vbi</span><span class="p">[</span><span class="n">v</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">];</span>
		<span class="n">sliced</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">|=</span>
			<span class="n">sliced</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">sliced</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_raw_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_vbi_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">saa711x_set_lcr</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_sliced_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">saa711x_set_lcr</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_mbus_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_FIXED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">saa711x_set_size</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Decode the sliced VBI data stream as created by the saa7115.</span>
<span class="cm">   The format is described in the saa7115 datasheet in Tables 25 and 26</span>
<span class="cm">   and in Figure 33.</span>
<span class="cm">   The current implementation uses SAV/EAV codes and not the ancillary data</span>
<span class="cm">   headers. The vbi-&gt;p pointer points to the R_5E_SDID byte right after the SAV</span>
<span class="cm">   code. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_decode_vbi_line</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_decode_vbi_line</span> <span class="o">*</span><span class="n">vbi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">vbi_no_data_pattern</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">vbi</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">wss</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id1</span><span class="p">,</span> <span class="n">id2</span><span class="p">;</span>   <span class="cm">/* the ID1 and ID2 bytes from the internal header */</span>

	<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="cm">/* mark result as a failure */</span>
	<span class="n">id1</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">id2</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="cm">/* Note: the field bit is inverted for 60 Hz video */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">id1</span> <span class="o">^=</span> <span class="mh">0x40</span><span class="p">;</span>

	<span class="cm">/* Skip internal header, p now points to the start of the payload */</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">p</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="cm">/* calculate field and line number of the VBI packet (1-23) */</span>
	<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">is_second_field</span> <span class="o">=</span> <span class="p">((</span><span class="n">id1</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">=</span> <span class="p">(</span><span class="n">id1</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">line</span> <span class="o">|=</span> <span class="p">(</span><span class="n">id2</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* Obtain data type */</span>
	<span class="n">id2</span> <span class="o">&amp;=</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="cm">/* If the VBI slicer does not detect any signal it will fill up</span>
<span class="cm">	   the payload buffer with 0xa0 bytes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">memcmp</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">vbi_no_data_pattern</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vbi_no_data_pattern</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* decode payloads */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id2</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_SLICED_TELETEXT_B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saa711x_odd_parity</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">||</span> <span class="o">!</span><span class="n">saa711x_odd_parity</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="n">wss</span> <span class="o">=</span> <span class="n">saa711x_decode_wss</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wss</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">wss</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">wss</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_SLICED_WSS_625</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">7</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">saa711x_decode_vps</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">vbi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_SLICED_VPS</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ============ SAA7115 AUDIO settings (end) ============= */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1F_STATUS_BYTE_2_VD_DEC</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;status: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xffff</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">saa711x_set_v4lstd</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">input</span><span class="p">,</span> <span class="n">u32</span> <span class="n">output</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">&lt;=</span> <span class="n">V4L2_IDENT_SAA7111A</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0xf8</span> <span class="o">:</span> <span class="mh">0xf0</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;decoder set input %d output %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">input</span><span class="p">,</span> <span class="n">output</span><span class="p">);</span>

	<span class="cm">/* saa7111/3 does not have these inputs */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">&lt;=</span> <span class="n">V4L2_IDENT_SAA7113</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="n">SAA7115_COMPOSITE4</span> <span class="o">||</span>
	     <span class="n">input</span> <span class="o">==</span> <span class="n">SAA7115_COMPOSITE5</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&gt;</span> <span class="n">SAA7115_SVIDEO3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">input</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">==</span> <span class="n">output</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;now setting %s input %s output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="n">SAA7115_SVIDEO0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;S-Video&quot;</span> <span class="o">:</span> <span class="s">&quot;Composite&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">output</span> <span class="o">==</span> <span class="n">SAA7115_IPORT_ON</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;iport on&quot;</span> <span class="o">:</span> <span class="s">&quot;iport off&quot;</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>

	<span class="cm">/* saa7111 has slightly different input numbering */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">&lt;=</span> <span class="n">V4L2_IDENT_SAA7111A</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="n">SAA7115_COMPOSITE4</span><span class="p">)</span>
			<span class="n">input</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/* saa7111 specific */</span>
		<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_10_CHROMA_CNTL_2</span><span class="p">,</span>
				<span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_10_CHROMA_CNTL_2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">output</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">^</span> <span class="mh">0x40</span><span class="p">));</span>
		<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_13_RT_X_PORT_OUT_CNTL</span><span class="p">,</span>
				<span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_13_RT_X_PORT_OUT_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">output</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x0a</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* select mode */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_02_INPUT_CNTL_1</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_02_INPUT_CNTL_1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">input</span><span class="p">);</span>

	<span class="cm">/* bypass chrominance trap for S-Video modes */</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_09_LUMA_CNTL</span><span class="p">,</span>
			<span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_09_LUMA_CNTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="n">SAA7115_SVIDEO0</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x0</span><span class="p">));</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">output</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">V4L2_IDENT_SAA7114</span> <span class="o">||</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">V4L2_IDENT_SAA7115</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_83_X_PORT_I_O_ENA_AND_OUT_CLK</span><span class="p">,</span>
				<span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_83_X_PORT_I_O_ENA_AND_OUT_CLK</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xfe</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">&gt;</span> <span class="n">V4L2_IDENT_SAA7111A</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">val</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s output</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">enable</span> <span class="o">?</span> <span class="s">&quot;enable&quot;</span> <span class="o">:</span> <span class="s">&quot;disable&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">==</span> <span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">saa711x_has_reg</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="n">R_87_I_PORT_I_O_ENA_OUT_CLK_AND_GATED</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_87_I_PORT_I_O_ENA_OUT_CLK_AND_GATED</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_crystal_freq</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">freq</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">freq</span> <span class="o">!=</span> <span class="n">SAA7115_FREQ_32_11_MHZ</span> <span class="o">&amp;&amp;</span> <span class="n">freq</span> <span class="o">!=</span> <span class="n">SAA7115_FREQ_24_576_MHZ</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">crystal_freq</span> <span class="o">=</span> <span class="n">freq</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">cgcdiv</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SAA7115_FREQ_FL_CGCDIV</span><span class="p">)</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">ucgc</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SAA7115_FREQ_FL_UCGC</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">apll</span> <span class="o">=</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SAA7115_FREQ_FL_APLL</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">saa711x_s_clock_freq</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">audclk_freq</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;decoder RESET</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">saa7115_cfg_reset_scaler</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_g_vbi_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_sliced_vbi_data</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Note: the internal field ID is inverted for NTSC,</span>
<span class="cm">	   so data-&gt;field 0 maps to the saa7115 even field,</span>
<span class="cm">	   whereas for PAL it maps to the saa7115 odd field. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_SLICED_WSS_625</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x6c</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x6d</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_SLICED_CAPTION_525</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* CC */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x69</span><span class="p">);</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x6a</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* XDS */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x67</span><span class="p">);</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_querystd</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg1f</span><span class="p">,</span> <span class="n">reg1e</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The V4L2 core already initializes std with all supported</span>
<span class="cm">	 * Standards. All driver needs to do is to mask it, to remove</span>
<span class="cm">	 * standards that don&#39;t apply from the mask</span>
<span class="cm">	 */</span>

	<span class="n">reg1f</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1F_STATUS_BYTE_2_VD_DEC</span><span class="p">);</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Status byte 2 (0x1f)=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg1f</span><span class="p">);</span>

	<span class="cm">/* horizontal/vertical not locked */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg1f</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg1f</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="o">*</span><span class="n">std</span> <span class="o">&amp;=</span> <span class="n">V4L2_STD_525_60</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">std</span> <span class="o">&amp;=</span> <span class="n">V4L2_STD_625_50</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">!=</span> <span class="n">V4L2_IDENT_SAA7115</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg1e</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1E_STATUS_BYTE_1_VD_DEC</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg1e</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="o">*</span><span class="n">std</span> <span class="o">&amp;=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/*</span>
<span class="cm">		 * V4L2_STD_PAL just cover the european PAL standards.</span>
<span class="cm">		 * This is wrong, as the device could also be using an</span>
<span class="cm">		 * other PAL standard.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="n">std</span> <span class="o">&amp;=</span> <span class="n">V4L2_STD_PAL</span>   <span class="o">|</span> <span class="n">V4L2_STD_PAL_N</span>  <span class="o">|</span> <span class="n">V4L2_STD_PAL_Nc</span> <span class="o">|</span>
			<span class="n">V4L2_STD_PAL_M</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_60</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="o">*</span><span class="n">std</span> <span class="o">&amp;=</span> <span class="n">V4L2_STD_SECAM</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Can&#39;t detect anything */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Status byte 1 (0x1e)=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reg1e</span><span class="p">);</span>

<span class="nl">ret:</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;detected std mask = %08Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">std</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_g_input_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg1e</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reg1f</span><span class="p">;</span>

	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">V4L2_IN_ST_NO_SIGNAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">==</span> <span class="n">V4L2_IDENT_SAA7115</span><span class="p">)</span>
		<span class="n">reg1e</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1E_STATUS_BYTE_1_VD_DEC</span><span class="p">);</span>
	<span class="n">reg1f</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1F_STATUS_BYTE_2_VD_DEC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">reg1f</span> <span class="o">&amp;</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x81</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg1e</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">)</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="n">saa711x_write</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_chip_ident_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg1e</span><span class="p">,</span> <span class="n">reg1f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">signalOk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">vcr</span><span class="p">;</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Audio frequency: %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">audclk_freq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">!=</span> <span class="n">V4L2_IDENT_SAA7115</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* status for the saa7114 */</span>
		<span class="n">reg1f</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1F_STATUS_BYTE_2_VD_DEC</span><span class="p">);</span>
		<span class="n">signalOk</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg1f</span> <span class="o">&amp;</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x81</span><span class="p">;</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Video signal:    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signalOk</span> <span class="o">?</span> <span class="s">&quot;ok&quot;</span> <span class="o">:</span> <span class="s">&quot;bad&quot;</span><span class="p">);</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Frequency:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">reg1f</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;60 Hz&quot;</span> <span class="o">:</span> <span class="s">&quot;50 Hz&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* status for the saa7115 */</span>
	<span class="n">reg1e</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1E_STATUS_BYTE_1_VD_DEC</span><span class="p">);</span>
	<span class="n">reg1f</span> <span class="o">=</span> <span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1F_STATUS_BYTE_2_VD_DEC</span><span class="p">);</span>

	<span class="n">signalOk</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg1f</span> <span class="o">&amp;</span> <span class="mh">0xc1</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x81</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">reg1e</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="n">vcr</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">reg1f</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Input:           S-Video %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Input:           Composite %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Video signal:    %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">signalOk</span> <span class="o">?</span> <span class="p">(</span><span class="n">vcr</span> <span class="o">?</span> <span class="s">&quot;VCR&quot;</span> <span class="o">:</span> <span class="s">&quot;broadcast/DVD&quot;</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;bad&quot;</span><span class="p">);</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Frequency:       %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">reg1f</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;60 Hz&quot;</span> <span class="o">:</span> <span class="s">&quot;50 Hz&quot;</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">reg1e</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Detected format: NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Detected format: PAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Detected format: SECAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Detected format: BW/No color</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Width, Height:   %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_log_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">saa711x_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">saa711x_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_volatile_ctrl</span> <span class="o">=</span> <span class="n">saa711x_g_volatile_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">saa711x_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">log_status</span> <span class="o">=</span> <span class="n">saa711x_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_chip_ident</span> <span class="o">=</span> <span class="n">saa711x_g_chip_ident</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_g_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_try_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ext_ctrls</span> <span class="o">=</span> <span class="n">v4l2_subdev_s_ext_ctrls</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queryctrl</span> <span class="o">=</span> <span class="n">v4l2_subdev_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">querymenu</span> <span class="o">=</span> <span class="n">v4l2_subdev_querymenu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_std</span> <span class="o">=</span> <span class="n">saa711x_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span> <span class="n">saa711x_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_gpio</span> <span class="o">=</span> <span class="n">saa711x_s_gpio</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">g_register</span> <span class="o">=</span> <span class="n">saa711x_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_register</span> <span class="o">=</span> <span class="n">saa711x_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_tuner_ops</span> <span class="n">saa711x_tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_radio</span> <span class="o">=</span> <span class="n">saa711x_s_radio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_tuner</span> <span class="o">=</span> <span class="n">saa711x_g_tuner</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_audio_ops</span> <span class="n">saa711x_audio_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_clock_freq</span> <span class="o">=</span> <span class="n">saa711x_s_clock_freq</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">saa711x_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_routing</span> <span class="o">=</span> <span class="n">saa711x_s_routing</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_crystal_freq</span> <span class="o">=</span> <span class="n">saa711x_s_crystal_freq</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span> <span class="o">=</span> <span class="n">saa711x_s_mbus_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_stream</span> <span class="o">=</span> <span class="n">saa711x_s_stream</span><span class="p">,</span>
	<span class="p">.</span><span class="n">querystd</span> <span class="o">=</span> <span class="n">saa711x_querystd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_input_status</span> <span class="o">=</span> <span class="n">saa711x_g_input_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_vbi_ops</span> <span class="n">saa711x_vbi_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_vbi_data</span> <span class="o">=</span> <span class="n">saa711x_g_vbi_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">decode_vbi_line</span> <span class="o">=</span> <span class="n">saa711x_decode_vbi_line</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_sliced_fmt</span> <span class="o">=</span> <span class="n">saa711x_g_sliced_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_sliced_fmt</span> <span class="o">=</span> <span class="n">saa711x_s_sliced_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_raw_fmt</span> <span class="o">=</span> <span class="n">saa711x_s_raw_fmt</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">saa711x_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">saa711x_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">saa711x_tuner_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">audio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">saa711x_audio_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">saa711x_video_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">saa711x_vbi_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa711x_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">17</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">chip_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">autodetect</span> <span class="o">=</span> <span class="o">!</span><span class="n">id</span> <span class="o">||</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Check if the adapter supports the needed features */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x0f</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">+</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="sc">&#39;9&#39;</span><span class="p">)</span>
			<span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="sc">&#39;a&#39;</span> <span class="o">-</span> <span class="sc">&#39;9&#39;</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="n">chip_id</span> <span class="o">=</span> <span class="n">name</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="cm">/* Check whether this chip is part of the saa711x series */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">name</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;f711&quot;</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;chip found @ 0x%x (ID %s) does not match a known saa711x chip.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Safety check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">autodetect</span> <span class="o">&amp;&amp;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">!=</span> <span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l_warn</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;found saa711%c while %s was expected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">chip_id</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;saa711%c&quot;</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">);</span>
	<span class="n">v4l_info</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;saa711%c found (%s) @ 0x%x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip_id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
		 <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa711x_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa711x_ops</span><span class="p">);</span>

	<span class="n">hdl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
	<span class="cm">/* add in ascending ID order */</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa711x_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa711x_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa711x_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_SATURATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">64</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa711x_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_HUE</span><span class="p">,</span> <span class="o">-</span><span class="mi">128</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">agc</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa711x_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_CHROMA_AGC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">gain</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa711x_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_CHROMA_GAIN</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">40</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>

		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_ctrl_auto_cluster</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">agc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">SAA7115_IPORT_ON</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chip_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;1&#39;</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_SAA7111</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_00_CHIP_VERSION</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l_info</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="s">&quot;saa7111a variant found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_SAA7111A</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;3&#39;</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_SAA7113</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;4&#39;</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_SAA7114</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;5&#39;</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_SAA7115</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="sc">&#39;8&#39;</span>:
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_SAA7118</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_SAA7111</span><span class="p">;</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;WARNING: Chip is not known - Falling back to saa7111</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">audclk_freq</span> <span class="o">=</span> <span class="mi">48000</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;writing init values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* init to 60hz/48khz */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">crystal_freq</span> <span class="o">=</span> <span class="n">SAA7115_FREQ_24_576_MHZ</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_IDENT_SAA7111</span>:
	<span class="k">case</span> <span class="n">V4L2_IDENT_SAA7111A</span>:
		<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">saa7111_init</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_IDENT_SAA7113</span>:
		<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">saa7113_init</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">crystal_freq</span> <span class="o">=</span> <span class="n">SAA7115_FREQ_32_11_MHZ</span><span class="p">;</span>
		<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">saa7115_init_auto_input</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">&gt;</span> <span class="n">V4L2_IDENT_SAA7111A</span><span class="p">)</span>
		<span class="n">saa711x_writeregs</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">saa7115_init_misc</span><span class="p">);</span>
	<span class="n">saa711x_set_v4lstd</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">V4L2_STD_NTSC</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="n">hdl</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;status: (1E) 0x%02x, (1F) 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1E_STATUS_BYTE_1_VD_DEC</span><span class="p">),</span>
		<span class="n">saa711x_read</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">R_1F_STATUS_BYTE_2_VD_DEC</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa711x_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">saa711x_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;saa7115_auto&quot;</span><span class="p">,</span> <span class="mi">1</span> <span class="p">},</span> <span class="cm">/* autodetect */</span>
	<span class="p">{</span> <span class="s">&quot;saa7111&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;saa7113&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;saa7114&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;saa7115&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;saa7118&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">saa711x_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">saa711x_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;saa7115&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">saa711x_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">saa711x_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">saa711x_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">saa711x_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
