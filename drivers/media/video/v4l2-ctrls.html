<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › v4l2-ctrls.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>v4l2-ctrls.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    V4L2 controls framework implementation.</span>

<span class="cm">    Copyright (C) 2010  Hans Verkuil &lt;hverkuil@xs4all.nl&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-dev.h&gt;</span>

<span class="cp">#define has_op(master, op) \</span>
<span class="cp">	(master-&gt;ops &amp;&amp; master-&gt;ops-&gt;op)</span>
<span class="cp">#define call_op(master, op) \</span>
<span class="cp">	(has_op(master, op) ? master-&gt;ops-&gt;op(master) : 0)</span>

<span class="cm">/* Internal temporary helper struct, one for each v4l2_ext_control */</span>
<span class="k">struct</span> <span class="n">v4l2_ctrl_helper</span> <span class="p">{</span>
	<span class="cm">/* Pointer to the control reference of the master control */</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">mref</span><span class="p">;</span>
	<span class="cm">/* The control corresponding to the v4l2_ext_control ID field. */</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="cm">/* v4l2_ext_control index of the next control belonging to the</span>
<span class="cm">	   same cluster, or 0 if there isn&#39;t any. */</span>
	<span class="n">u32</span> <span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Small helper function to determine if the autocluster is set to manual</span>
<span class="cm">   mode. */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_cur_manual</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">is_auto</span> <span class="o">&amp;&amp;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span> <span class="o">==</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">manual_mode_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Same as above, but this checks the against the new value instead of the</span>
<span class="cm">   current value. */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_new_manual</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">is_auto</span> <span class="o">&amp;&amp;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">==</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">manual_mode_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Returns NULL or a character pointer array containing the menu for</span>
<span class="cm">   the given control ID. The pointer array ends with a NULL pointer.</span>
<span class="cm">   An empty string signifies a menu entry that is invalid. This allows</span>
<span class="cm">   drivers to disable certain options if it is not supported. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="nf">v4l2_ctrl_get_menu</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_sampling_freq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;44.1 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;48 kHz&quot;</span><span class="p">,</span>
		<span class="s">&quot;32 kHz&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_encoding</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;MPEG-1/2 Layer I&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-1/2 Layer II&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-1/2 Layer III&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-2/4 AAC&quot;</span><span class="p">,</span>
		<span class="s">&quot;AC-3&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_l1_bitrate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;32 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;64 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;96 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;128 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;160 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;192 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;224 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;256 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;288 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;320 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;352 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;384 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;416 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;448 kbps&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_l2_bitrate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;32 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;48 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;56 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;64 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;80 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;96 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;112 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;128 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;160 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;192 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;224 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;256 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;320 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;384 kbps&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_l3_bitrate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;32 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;40 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;48 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;56 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;64 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;80 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;96 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;112 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;128 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;160 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;192 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;224 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;256 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;320 kbps&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_ac3_bitrate</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;32 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;40 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;48 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;56 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;64 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;80 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;96 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;112 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;128 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;160 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;192 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;224 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;256 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;320 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;384 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;448 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;512 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;576 kbps&quot;</span><span class="p">,</span>
		<span class="s">&quot;640 kbps&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Stereo&quot;</span><span class="p">,</span>
		<span class="s">&quot;Joint Stereo&quot;</span><span class="p">,</span>
		<span class="s">&quot;Dual&quot;</span><span class="p">,</span>
		<span class="s">&quot;Mono&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_mode_extension</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Bound 4&quot;</span><span class="p">,</span>
		<span class="s">&quot;Bound 8&quot;</span><span class="p">,</span>
		<span class="s">&quot;Bound 12&quot;</span><span class="p">,</span>
		<span class="s">&quot;Bound 16&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_emphasis</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;No Emphasis&quot;</span><span class="p">,</span>
		<span class="s">&quot;50/15 us&quot;</span><span class="p">,</span>
		<span class="s">&quot;CCITT J17&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_crc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;No CRC&quot;</span><span class="p">,</span>
		<span class="s">&quot;16-bit CRC&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_audio_dec_playback</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Auto&quot;</span><span class="p">,</span>
		<span class="s">&quot;Stereo&quot;</span><span class="p">,</span>
		<span class="s">&quot;Left&quot;</span><span class="p">,</span>
		<span class="s">&quot;Right&quot;</span><span class="p">,</span>
		<span class="s">&quot;Mono&quot;</span><span class="p">,</span>
		<span class="s">&quot;Swapped Stereo&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_video_encoding</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;MPEG-1&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-2&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-4 AVC&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_video_aspect</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;1x1&quot;</span><span class="p">,</span>
		<span class="s">&quot;4x3&quot;</span><span class="p">,</span>
		<span class="s">&quot;16x9&quot;</span><span class="p">,</span>
		<span class="s">&quot;2.21x1&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_video_bitrate_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Variable Bitrate&quot;</span><span class="p">,</span>
		<span class="s">&quot;Constant Bitrate&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_stream_type</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;MPEG-2 Program Stream&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-2 Transport Stream&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-1 System Stream&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-2 DVD-compatible Stream&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-1 VCD-compatible Stream&quot;</span><span class="p">,</span>
		<span class="s">&quot;MPEG-2 SVCD-compatible Stream&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_stream_vbi_fmt</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;No VBI&quot;</span><span class="p">,</span>
		<span class="s">&quot;Private Packet, IVTV Format&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">camera_power_line_frequency</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Disabled&quot;</span><span class="p">,</span>
		<span class="s">&quot;50 Hz&quot;</span><span class="p">,</span>
		<span class="s">&quot;60 Hz&quot;</span><span class="p">,</span>
		<span class="s">&quot;Auto&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">camera_exposure_auto</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Auto Mode&quot;</span><span class="p">,</span>
		<span class="s">&quot;Manual Mode&quot;</span><span class="p">,</span>
		<span class="s">&quot;Shutter Priority Mode&quot;</span><span class="p">,</span>
		<span class="s">&quot;Aperture Priority Mode&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">camera_exposure_metering</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Average&quot;</span><span class="p">,</span>
		<span class="s">&quot;Center Weighted&quot;</span><span class="p">,</span>
		<span class="s">&quot;Spot&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">camera_auto_focus_range</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Auto&quot;</span><span class="p">,</span>
		<span class="s">&quot;Normal&quot;</span><span class="p">,</span>
		<span class="s">&quot;Macro&quot;</span><span class="p">,</span>
		<span class="s">&quot;Infinity&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">colorfx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;None&quot;</span><span class="p">,</span>
		<span class="s">&quot;Black &amp; White&quot;</span><span class="p">,</span>
		<span class="s">&quot;Sepia&quot;</span><span class="p">,</span>
		<span class="s">&quot;Negative&quot;</span><span class="p">,</span>
		<span class="s">&quot;Emboss&quot;</span><span class="p">,</span>
		<span class="s">&quot;Sketch&quot;</span><span class="p">,</span>
		<span class="s">&quot;Sky Blue&quot;</span><span class="p">,</span>
		<span class="s">&quot;Grass Green&quot;</span><span class="p">,</span>
		<span class="s">&quot;Skin Whiten&quot;</span><span class="p">,</span>
		<span class="s">&quot;Vivid&quot;</span><span class="p">,</span>
		<span class="s">&quot;Aqua&quot;</span><span class="p">,</span>
		<span class="s">&quot;Art Freeze&quot;</span><span class="p">,</span>
		<span class="s">&quot;Silhouette&quot;</span><span class="p">,</span>
		<span class="s">&quot;Solarization&quot;</span><span class="p">,</span>
		<span class="s">&quot;Antique&quot;</span><span class="p">,</span>
		<span class="s">&quot;Set Cb/Cr&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">auto_n_preset_white_balance</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Manual&quot;</span><span class="p">,</span>
		<span class="s">&quot;Auto&quot;</span><span class="p">,</span>
		<span class="s">&quot;Incandescent&quot;</span><span class="p">,</span>
		<span class="s">&quot;Fluorescent&quot;</span><span class="p">,</span>
		<span class="s">&quot;Fluorescent H&quot;</span><span class="p">,</span>
		<span class="s">&quot;Horizon&quot;</span><span class="p">,</span>
		<span class="s">&quot;Daylight&quot;</span><span class="p">,</span>
		<span class="s">&quot;Flash&quot;</span><span class="p">,</span>
		<span class="s">&quot;Cloudy&quot;</span><span class="p">,</span>
		<span class="s">&quot;Shade&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">camera_iso_sensitivity_auto</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Manual&quot;</span><span class="p">,</span>
		<span class="s">&quot;Auto&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">scene_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;None&quot;</span><span class="p">,</span>
		<span class="s">&quot;Backlight&quot;</span><span class="p">,</span>
		<span class="s">&quot;Beach/Snow&quot;</span><span class="p">,</span>
		<span class="s">&quot;Candle Light&quot;</span><span class="p">,</span>
		<span class="s">&quot;Dusk/Dawn&quot;</span><span class="p">,</span>
		<span class="s">&quot;Fall Colors&quot;</span><span class="p">,</span>
		<span class="s">&quot;Fireworks&quot;</span><span class="p">,</span>
		<span class="s">&quot;Landscape&quot;</span><span class="p">,</span>
		<span class="s">&quot;Night&quot;</span><span class="p">,</span>
		<span class="s">&quot;Party/Indoor&quot;</span><span class="p">,</span>
		<span class="s">&quot;Portrait&quot;</span><span class="p">,</span>
		<span class="s">&quot;Sports&quot;</span><span class="p">,</span>
		<span class="s">&quot;Sunset&quot;</span><span class="p">,</span>
		<span class="s">&quot;Text&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">tune_preemphasis</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;No Preemphasis&quot;</span><span class="p">,</span>
		<span class="s">&quot;50 Microseconds&quot;</span><span class="p">,</span>
		<span class="s">&quot;75 Microseconds&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">header_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Separate Buffer&quot;</span><span class="p">,</span>
		<span class="s">&quot;Joined With 1st Frame&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">multi_slice</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Single&quot;</span><span class="p">,</span>
		<span class="s">&quot;Max Macroblocks&quot;</span><span class="p">,</span>
		<span class="s">&quot;Max Bytes&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">entropy_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;CAVLC&quot;</span><span class="p">,</span>
		<span class="s">&quot;CABAC&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_h264_level</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;1&quot;</span><span class="p">,</span>
		<span class="s">&quot;1b&quot;</span><span class="p">,</span>
		<span class="s">&quot;1.1&quot;</span><span class="p">,</span>
		<span class="s">&quot;1.2&quot;</span><span class="p">,</span>
		<span class="s">&quot;1.3&quot;</span><span class="p">,</span>
		<span class="s">&quot;2&quot;</span><span class="p">,</span>
		<span class="s">&quot;2.1&quot;</span><span class="p">,</span>
		<span class="s">&quot;2.2&quot;</span><span class="p">,</span>
		<span class="s">&quot;3&quot;</span><span class="p">,</span>
		<span class="s">&quot;3.1&quot;</span><span class="p">,</span>
		<span class="s">&quot;3.2&quot;</span><span class="p">,</span>
		<span class="s">&quot;4&quot;</span><span class="p">,</span>
		<span class="s">&quot;4.1&quot;</span><span class="p">,</span>
		<span class="s">&quot;4.2&quot;</span><span class="p">,</span>
		<span class="s">&quot;5&quot;</span><span class="p">,</span>
		<span class="s">&quot;5.1&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">h264_loop_filter</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Enabled&quot;</span><span class="p">,</span>
		<span class="s">&quot;Disabled&quot;</span><span class="p">,</span>
		<span class="s">&quot;Disabled at Slice Boundary&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">h264_profile</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Baseline&quot;</span><span class="p">,</span>
		<span class="s">&quot;Constrained Baseline&quot;</span><span class="p">,</span>
		<span class="s">&quot;Main&quot;</span><span class="p">,</span>
		<span class="s">&quot;Extended&quot;</span><span class="p">,</span>
		<span class="s">&quot;High&quot;</span><span class="p">,</span>
		<span class="s">&quot;High 10&quot;</span><span class="p">,</span>
		<span class="s">&quot;High 422&quot;</span><span class="p">,</span>
		<span class="s">&quot;High 444 Predictive&quot;</span><span class="p">,</span>
		<span class="s">&quot;High 10 Intra&quot;</span><span class="p">,</span>
		<span class="s">&quot;High 422 Intra&quot;</span><span class="p">,</span>
		<span class="s">&quot;High 444 Intra&quot;</span><span class="p">,</span>
		<span class="s">&quot;CAVLC 444 Intra&quot;</span><span class="p">,</span>
		<span class="s">&quot;Scalable Baseline&quot;</span><span class="p">,</span>
		<span class="s">&quot;Scalable High&quot;</span><span class="p">,</span>
		<span class="s">&quot;Scalable High Intra&quot;</span><span class="p">,</span>
		<span class="s">&quot;Multiview High&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">vui_sar_idc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Unspecified&quot;</span><span class="p">,</span>
		<span class="s">&quot;1:1&quot;</span><span class="p">,</span>
		<span class="s">&quot;12:11&quot;</span><span class="p">,</span>
		<span class="s">&quot;10:11&quot;</span><span class="p">,</span>
		<span class="s">&quot;16:11&quot;</span><span class="p">,</span>
		<span class="s">&quot;40:33&quot;</span><span class="p">,</span>
		<span class="s">&quot;24:11&quot;</span><span class="p">,</span>
		<span class="s">&quot;20:11&quot;</span><span class="p">,</span>
		<span class="s">&quot;32:11&quot;</span><span class="p">,</span>
		<span class="s">&quot;80:33&quot;</span><span class="p">,</span>
		<span class="s">&quot;18:11&quot;</span><span class="p">,</span>
		<span class="s">&quot;15:11&quot;</span><span class="p">,</span>
		<span class="s">&quot;64:33&quot;</span><span class="p">,</span>
		<span class="s">&quot;160:99&quot;</span><span class="p">,</span>
		<span class="s">&quot;4:3&quot;</span><span class="p">,</span>
		<span class="s">&quot;3:2&quot;</span><span class="p">,</span>
		<span class="s">&quot;2:1&quot;</span><span class="p">,</span>
		<span class="s">&quot;Extended SAR&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg_mpeg4_level</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;0&quot;</span><span class="p">,</span>
		<span class="s">&quot;0b&quot;</span><span class="p">,</span>
		<span class="s">&quot;1&quot;</span><span class="p">,</span>
		<span class="s">&quot;2&quot;</span><span class="p">,</span>
		<span class="s">&quot;3&quot;</span><span class="p">,</span>
		<span class="s">&quot;3b&quot;</span><span class="p">,</span>
		<span class="s">&quot;4&quot;</span><span class="p">,</span>
		<span class="s">&quot;5&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">mpeg4_profile</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Simple&quot;</span><span class="p">,</span>
		<span class="s">&quot;Advanced Simple&quot;</span><span class="p">,</span>
		<span class="s">&quot;Core&quot;</span><span class="p">,</span>
		<span class="s">&quot;Simple Scalable&quot;</span><span class="p">,</span>
		<span class="s">&quot;Advanced Coding Efficency&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">flash_led_mode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Off&quot;</span><span class="p">,</span>
		<span class="s">&quot;Flash&quot;</span><span class="p">,</span>
		<span class="s">&quot;Torch&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">flash_strobe_source</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;Software&quot;</span><span class="p">,</span>
		<span class="s">&quot;External&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">jpeg_chroma_subsampling</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;4:4:4&quot;</span><span class="p">,</span>
		<span class="s">&quot;4:2:2&quot;</span><span class="p">,</span>
		<span class="s">&quot;4:2:0&quot;</span><span class="p">,</span>
		<span class="s">&quot;4:1:1&quot;</span><span class="p">,</span>
		<span class="s">&quot;4:1:0&quot;</span><span class="p">,</span>
		<span class="s">&quot;Gray&quot;</span><span class="p">,</span>
		<span class="nb">NULL</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_sampling_freq</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_ENCODING</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_encoding</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_L1_BITRATE</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_l1_bitrate</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_L2_BITRATE</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_l2_bitrate</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_L3_BITRATE</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_l3_bitrate</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_AC3_BITRATE</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_ac3_bitrate</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_MODE</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_mode</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_MODE_EXTENSION</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_mode_extension</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_EMPHASIS</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_emphasis</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_CRC</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_crc</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_DEC_PLAYBACK</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_DEC_MULTILINGUAL_PLAYBACK</span>:
		<span class="k">return</span> <span class="n">mpeg_audio_dec_playback</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ENCODING</span>:
		<span class="k">return</span> <span class="n">mpeg_video_encoding</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ASPECT</span>:
		<span class="k">return</span> <span class="n">mpeg_video_aspect</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE_MODE</span>:
		<span class="k">return</span> <span class="n">mpeg_video_bitrate_mode</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_TYPE</span>:
		<span class="k">return</span> <span class="n">mpeg_stream_type</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_VBI_FMT</span>:
		<span class="k">return</span> <span class="n">mpeg_stream_vbi_fmt</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY</span>:
		<span class="k">return</span> <span class="n">camera_power_line_frequency</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_AUTO</span>:
		<span class="k">return</span> <span class="n">camera_exposure_auto</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_METERING</span>:
		<span class="k">return</span> <span class="n">camera_exposure_metering</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_RANGE</span>:
		<span class="k">return</span> <span class="n">camera_auto_focus_range</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_COLORFX</span>:
		<span class="k">return</span> <span class="n">colorfx</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE</span>:
		<span class="k">return</span> <span class="n">auto_n_preset_white_balance</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ISO_SENSITIVITY_AUTO</span>:
		<span class="k">return</span> <span class="n">camera_iso_sensitivity_auto</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SCENE_MODE</span>:
		<span class="k">return</span> <span class="n">scene_mode</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_PREEMPHASIS</span>:
		<span class="k">return</span> <span class="n">tune_preemphasis</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_LED_MODE</span>:
		<span class="k">return</span> <span class="n">flash_led_mode</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE_SOURCE</span>:
		<span class="k">return</span> <span class="n">flash_strobe_source</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_HEADER_MODE</span>:
		<span class="k">return</span> <span class="n">header_mode</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MODE</span>:
		<span class="k">return</span> <span class="n">multi_slice</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_ENTROPY_MODE</span>:
		<span class="k">return</span> <span class="n">entropy_mode</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LEVEL</span>:
		<span class="k">return</span> <span class="n">mpeg_h264_level</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_MODE</span>:
		<span class="k">return</span> <span class="n">h264_loop_filter</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_PROFILE</span>:
		<span class="k">return</span> <span class="n">h264_profile</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_IDC</span>:
		<span class="k">return</span> <span class="n">vui_sar_idc</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_LEVEL</span>:
		<span class="k">return</span> <span class="n">mpeg_mpeg4_level</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_PROFILE</span>:
		<span class="k">return</span> <span class="n">mpeg4_profile</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_CHROMA_SUBSAMPLING</span>:
		<span class="k">return</span> <span class="n">jpeg_chroma_subsampling</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_get_menu</span><span class="p">);</span>

<span class="cm">/* Return the control name. */</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">v4l2_ctrl_get_name</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* USER controls */</span>
	<span class="cm">/* Keep the order of the &#39;case&#39;s the same as in videodev2.h! */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_USER_CLASS</span>:		<span class="k">return</span> <span class="s">&quot;User Controls&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:		<span class="k">return</span> <span class="s">&quot;Brightness&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:			<span class="k">return</span> <span class="s">&quot;Contrast&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:		<span class="k">return</span> <span class="s">&quot;Saturation&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:			<span class="k">return</span> <span class="s">&quot;Hue&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:		<span class="k">return</span> <span class="s">&quot;Volume&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span>:		<span class="k">return</span> <span class="s">&quot;Balance&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BASS</span>:		<span class="k">return</span> <span class="s">&quot;Bass&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span>:		<span class="k">return</span> <span class="s">&quot;Treble&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:		<span class="k">return</span> <span class="s">&quot;Mute&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LOUDNESS</span>:		<span class="k">return</span> <span class="s">&quot;Loudness&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BLACK_LEVEL</span>:		<span class="k">return</span> <span class="s">&quot;Black Level&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span>:	<span class="k">return</span> <span class="s">&quot;White Balance, Automatic&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_DO_WHITE_BALANCE</span>:		<span class="k">return</span> <span class="s">&quot;Do White Balance&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RED_BALANCE</span>:		<span class="k">return</span> <span class="s">&quot;Red Balance&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BLUE_BALANCE</span>:		<span class="k">return</span> <span class="s">&quot;Blue Balance&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_GAMMA</span>:			<span class="k">return</span> <span class="s">&quot;Gamma&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE</span>:			<span class="k">return</span> <span class="s">&quot;Exposure&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTOGAIN</span>:			<span class="k">return</span> <span class="s">&quot;Gain, Automatic&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_GAIN</span>:			<span class="k">return</span> <span class="s">&quot;Gain&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:			<span class="k">return</span> <span class="s">&quot;Horizontal Flip&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:			<span class="k">return</span> <span class="s">&quot;Vertical Flip&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HCENTER</span>:			<span class="k">return</span> <span class="s">&quot;Horizontal Center&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VCENTER</span>:			<span class="k">return</span> <span class="s">&quot;Vertical Center&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY</span>:	<span class="k">return</span> <span class="s">&quot;Power Line Frequency&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HUE_AUTO</span>:			<span class="k">return</span> <span class="s">&quot;Hue, Automatic&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_WHITE_BALANCE_TEMPERATURE</span>: <span class="k">return</span> <span class="s">&quot;White Balance Temperature&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SHARPNESS</span>:		<span class="k">return</span> <span class="s">&quot;Sharpness&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BACKLIGHT_COMPENSATION</span>:	<span class="k">return</span> <span class="s">&quot;Backlight Compensation&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CHROMA_AGC</span>:		<span class="k">return</span> <span class="s">&quot;Chroma AGC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_COLOR_KILLER</span>:		<span class="k">return</span> <span class="s">&quot;Color Killer&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_COLORFX</span>:			<span class="k">return</span> <span class="s">&quot;Color Effects&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTOBRIGHTNESS</span>:		<span class="k">return</span> <span class="s">&quot;Brightness, Automatic&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BAND_STOP_FILTER</span>:		<span class="k">return</span> <span class="s">&quot;Band-Stop Filter&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ROTATE</span>:			<span class="k">return</span> <span class="s">&quot;Rotate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BG_COLOR</span>:			<span class="k">return</span> <span class="s">&quot;Background Color&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CHROMA_GAIN</span>:		<span class="k">return</span> <span class="s">&quot;Chroma Gain&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ILLUMINATORS_1</span>:		<span class="k">return</span> <span class="s">&quot;Illuminator 1&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ILLUMINATORS_2</span>:		<span class="k">return</span> <span class="s">&quot;Illuminator 2&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MIN_BUFFERS_FOR_CAPTURE</span>:	<span class="k">return</span> <span class="s">&quot;Min Number of Capture Buffers&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MIN_BUFFERS_FOR_OUTPUT</span>:	<span class="k">return</span> <span class="s">&quot;Min Number of Output Buffers&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ALPHA_COMPONENT</span>:		<span class="k">return</span> <span class="s">&quot;Alpha Component&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_COLORFX_CBCR</span>:		<span class="k">return</span> <span class="s">&quot;Color Effects, CbCr&quot;</span><span class="p">;</span>

	<span class="cm">/* MPEG controls */</span>
	<span class="cm">/* Keep the order of the &#39;case&#39;s the same as in videodev2.h! */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_CLASS</span>:		<span class="k">return</span> <span class="s">&quot;MPEG Encoder Controls&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_TYPE</span>:		<span class="k">return</span> <span class="s">&quot;Stream Type&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_PID_PMT</span>:	<span class="k">return</span> <span class="s">&quot;Stream PMT Program ID&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_PID_AUDIO</span>:	<span class="k">return</span> <span class="s">&quot;Stream Audio Program ID&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_PID_VIDEO</span>:	<span class="k">return</span> <span class="s">&quot;Stream Video Program ID&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_PID_PCR</span>:	<span class="k">return</span> <span class="s">&quot;Stream PCR Program ID&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_PES_ID_AUDIO</span>: <span class="k">return</span> <span class="s">&quot;Stream PES Audio ID&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_PES_ID_VIDEO</span>: <span class="k">return</span> <span class="s">&quot;Stream PES Video ID&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_VBI_FMT</span>:	<span class="k">return</span> <span class="s">&quot;Stream VBI Format&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ</span>: <span class="k">return</span> <span class="s">&quot;Audio Sampling Frequency&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_ENCODING</span>:	<span class="k">return</span> <span class="s">&quot;Audio Encoding&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_L1_BITRATE</span>:	<span class="k">return</span> <span class="s">&quot;Audio Layer I Bitrate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_L2_BITRATE</span>:	<span class="k">return</span> <span class="s">&quot;Audio Layer II Bitrate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_L3_BITRATE</span>:	<span class="k">return</span> <span class="s">&quot;Audio Layer III Bitrate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_MODE</span>:		<span class="k">return</span> <span class="s">&quot;Audio Stereo Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_MODE_EXTENSION</span>: <span class="k">return</span> <span class="s">&quot;Audio Stereo Mode Extension&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_EMPHASIS</span>:	<span class="k">return</span> <span class="s">&quot;Audio Emphasis&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_CRC</span>:		<span class="k">return</span> <span class="s">&quot;Audio CRC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_MUTE</span>:		<span class="k">return</span> <span class="s">&quot;Audio Mute&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_AAC_BITRATE</span>:	<span class="k">return</span> <span class="s">&quot;Audio AAC Bitrate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_AC3_BITRATE</span>:	<span class="k">return</span> <span class="s">&quot;Audio AC-3 Bitrate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_DEC_PLAYBACK</span>:	<span class="k">return</span> <span class="s">&quot;Audio Playback&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_DEC_MULTILINGUAL_PLAYBACK</span>: <span class="k">return</span> <span class="s">&quot;Audio Multilingual Playback&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ENCODING</span>:	<span class="k">return</span> <span class="s">&quot;Video Encoding&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ASPECT</span>:	<span class="k">return</span> <span class="s">&quot;Video Aspect&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_B_FRAMES</span>:	<span class="k">return</span> <span class="s">&quot;Video B Frames&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_SIZE</span>:	<span class="k">return</span> <span class="s">&quot;Video GOP Size&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_CLOSURE</span>:	<span class="k">return</span> <span class="s">&quot;Video GOP Closure&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_PULLDOWN</span>:	<span class="k">return</span> <span class="s">&quot;Video Pulldown&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE_MODE</span>:	<span class="k">return</span> <span class="s">&quot;Video Bitrate Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE</span>:	<span class="k">return</span> <span class="s">&quot;Video Bitrate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE_PEAK</span>:	<span class="k">return</span> <span class="s">&quot;Video Peak Bitrate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_TEMPORAL_DECIMATION</span>: <span class="k">return</span> <span class="s">&quot;Video Temporal Decimation&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MUTE</span>:		<span class="k">return</span> <span class="s">&quot;Video Mute&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MUTE_YUV</span>:	<span class="k">return</span> <span class="s">&quot;Video Mute YUV&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_DECODER_SLICE_INTERFACE</span>:	<span class="k">return</span> <span class="s">&quot;Decoder Slice Interface&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_DECODER_MPEG4_DEBLOCK_FILTER</span>:	<span class="k">return</span> <span class="s">&quot;MPEG4 Loop Filter Enable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_CYCLIC_INTRA_REFRESH_MB</span>:	<span class="k">return</span> <span class="s">&quot;Number of Intra Refresh MBs&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_FRAME_RC_ENABLE</span>:		<span class="k">return</span> <span class="s">&quot;Frame Level Rate Control Enable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MB_RC_ENABLE</span>:			<span class="k">return</span> <span class="s">&quot;H264 MB Level Rate Control&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_HEADER_MODE</span>:			<span class="k">return</span> <span class="s">&quot;Sequence Header Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MAX_REF_PIC</span>:			<span class="k">return</span> <span class="s">&quot;Max Number of Reference Pics&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_I_FRAME_QP</span>:		<span class="k">return</span> <span class="s">&quot;H263 I-Frame QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_P_FRAME_QP</span>:		<span class="k">return</span> <span class="s">&quot;H263 P-Frame QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_B_FRAME_QP</span>:		<span class="k">return</span> <span class="s">&quot;H263 B-Frame QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_MIN_QP</span>:			<span class="k">return</span> <span class="s">&quot;H263 Minimum QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H263_MAX_QP</span>:			<span class="k">return</span> <span class="s">&quot;H263 Maximum QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_I_FRAME_QP</span>:		<span class="k">return</span> <span class="s">&quot;H264 I-Frame QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_P_FRAME_QP</span>:		<span class="k">return</span> <span class="s">&quot;H264 P-Frame QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_B_FRAME_QP</span>:		<span class="k">return</span> <span class="s">&quot;H264 B-Frame QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_MAX_QP</span>:			<span class="k">return</span> <span class="s">&quot;H264 Maximum QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_MIN_QP</span>:			<span class="k">return</span> <span class="s">&quot;H264 Minimum QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_8X8_TRANSFORM</span>:		<span class="k">return</span> <span class="s">&quot;H264 8x8 Transform Enable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_CPB_SIZE</span>:			<span class="k">return</span> <span class="s">&quot;H264 CPB Buffer Size&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_ENTROPY_MODE</span>:		<span class="k">return</span> <span class="s">&quot;H264 Entropy Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_I_PERIOD</span>:			<span class="k">return</span> <span class="s">&quot;H264 I-Frame Period&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LEVEL</span>:			<span class="k">return</span> <span class="s">&quot;H264 Level&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_ALPHA</span>:	<span class="k">return</span> <span class="s">&quot;H264 Loop Filter Alpha Offset&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_BETA</span>:		<span class="k">return</span> <span class="s">&quot;H264 Loop Filter Beta Offset&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_MODE</span>:		<span class="k">return</span> <span class="s">&quot;H264 Loop Filter Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_PROFILE</span>:			<span class="k">return</span> <span class="s">&quot;H264 Profile&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_EXT_SAR_HEIGHT</span>:	<span class="k">return</span> <span class="s">&quot;Vertical Size of SAR&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_EXT_SAR_WIDTH</span>:	<span class="k">return</span> <span class="s">&quot;Horizontal Size of SAR&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_ENABLE</span>:		<span class="k">return</span> <span class="s">&quot;Aspect Ratio VUI Enable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_IDC</span>:		<span class="k">return</span> <span class="s">&quot;VUI Aspect Ratio IDC&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_I_FRAME_QP</span>:		<span class="k">return</span> <span class="s">&quot;MPEG4 I-Frame QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_P_FRAME_QP</span>:		<span class="k">return</span> <span class="s">&quot;MPEG4 P-Frame QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_B_FRAME_QP</span>:		<span class="k">return</span> <span class="s">&quot;MPEG4 B-Frame QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_MIN_QP</span>:			<span class="k">return</span> <span class="s">&quot;MPEG4 Minimum QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_MAX_QP</span>:			<span class="k">return</span> <span class="s">&quot;MPEG4 Maximum QP Value&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_LEVEL</span>:			<span class="k">return</span> <span class="s">&quot;MPEG4 Level&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_PROFILE</span>:			<span class="k">return</span> <span class="s">&quot;MPEG4 Profile&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_QPEL</span>:			<span class="k">return</span> <span class="s">&quot;Quarter Pixel Search Enable&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_BYTES</span>:		<span class="k">return</span> <span class="s">&quot;Maximum Bytes in a Slice&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MAX_MB</span>:		<span class="k">return</span> <span class="s">&quot;Number of MBs in a Slice&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MODE</span>:		<span class="k">return</span> <span class="s">&quot;Slice Partitioning Method&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_VBV_SIZE</span>:			<span class="k">return</span> <span class="s">&quot;VBV Buffer Size&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_DEC_PTS</span>:			<span class="k">return</span> <span class="s">&quot;Video Decoder PTS&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_DEC_FRAME</span>:			<span class="k">return</span> <span class="s">&quot;Video Decoder Frame Count&quot;</span><span class="p">;</span>

	<span class="cm">/* CAMERA controls */</span>
	<span class="cm">/* Keep the order of the &#39;case&#39;s the same as in videodev2.h! */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_CAMERA_CLASS</span>:		<span class="k">return</span> <span class="s">&quot;Camera Controls&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_AUTO</span>:		<span class="k">return</span> <span class="s">&quot;Auto Exposure&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_ABSOLUTE</span>:	<span class="k">return</span> <span class="s">&quot;Exposure Time, Absolute&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_AUTO_PRIORITY</span>:	<span class="k">return</span> <span class="s">&quot;Exposure, Dynamic Framerate&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PAN_RELATIVE</span>:		<span class="k">return</span> <span class="s">&quot;Pan, Relative&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TILT_RELATIVE</span>:		<span class="k">return</span> <span class="s">&quot;Tilt, Relative&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PAN_RESET</span>:		<span class="k">return</span> <span class="s">&quot;Pan, Reset&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TILT_RESET</span>:		<span class="k">return</span> <span class="s">&quot;Tilt, Reset&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PAN_ABSOLUTE</span>:		<span class="k">return</span> <span class="s">&quot;Pan, Absolute&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TILT_ABSOLUTE</span>:		<span class="k">return</span> <span class="s">&quot;Tilt, Absolute&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FOCUS_ABSOLUTE</span>:		<span class="k">return</span> <span class="s">&quot;Focus, Absolute&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FOCUS_RELATIVE</span>:		<span class="k">return</span> <span class="s">&quot;Focus, Relative&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FOCUS_AUTO</span>:		<span class="k">return</span> <span class="s">&quot;Focus, Automatic Continuous&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ZOOM_ABSOLUTE</span>:		<span class="k">return</span> <span class="s">&quot;Zoom, Absolute&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ZOOM_RELATIVE</span>:		<span class="k">return</span> <span class="s">&quot;Zoom, Relative&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ZOOM_CONTINUOUS</span>:		<span class="k">return</span> <span class="s">&quot;Zoom, Continuous&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVACY</span>:			<span class="k">return</span> <span class="s">&quot;Privacy&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_IRIS_ABSOLUTE</span>:		<span class="k">return</span> <span class="s">&quot;Iris, Absolute&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_IRIS_RELATIVE</span>:		<span class="k">return</span> <span class="s">&quot;Iris, Relative&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_EXPOSURE_BIAS</span>:	<span class="k">return</span> <span class="s">&quot;Auto Exposure, Bias&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE</span>: <span class="k">return</span> <span class="s">&quot;White Balance, Auto &amp; Preset&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_WIDE_DYNAMIC_RANGE</span>:	<span class="k">return</span> <span class="s">&quot;Wide Dynamic Range&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_IMAGE_STABILIZATION</span>:	<span class="k">return</span> <span class="s">&quot;Image Stabilization&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ISO_SENSITIVITY</span>:		<span class="k">return</span> <span class="s">&quot;ISO Sensitivity&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ISO_SENSITIVITY_AUTO</span>:	<span class="k">return</span> <span class="s">&quot;ISO Sensitivity, Auto&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_METERING</span>:	<span class="k">return</span> <span class="s">&quot;Exposure, Metering Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_SCENE_MODE</span>:		<span class="k">return</span> <span class="s">&quot;Scene Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_3A_LOCK</span>:			<span class="k">return</span> <span class="s">&quot;3A Lock&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_START</span>:		<span class="k">return</span> <span class="s">&quot;Auto Focus, Start&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_STOP</span>:		<span class="k">return</span> <span class="s">&quot;Auto Focus, Stop&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_STATUS</span>:	<span class="k">return</span> <span class="s">&quot;Auto Focus, Status&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_RANGE</span>:		<span class="k">return</span> <span class="s">&quot;Auto Focus, Range&quot;</span><span class="p">;</span>

	<span class="cm">/* FM Radio Modulator control */</span>
	<span class="cm">/* Keep the order of the &#39;case&#39;s the same as in videodev2.h! */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FM_TX_CLASS</span>:		<span class="k">return</span> <span class="s">&quot;FM Radio Modulator Controls&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_DEVIATION</span>:		<span class="k">return</span> <span class="s">&quot;RDS Signal Deviation&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PI</span>:		<span class="k">return</span> <span class="s">&quot;RDS Program ID&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PTY</span>:		<span class="k">return</span> <span class="s">&quot;RDS Program Type&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PS_NAME</span>:		<span class="k">return</span> <span class="s">&quot;RDS PS Name&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_RADIO_TEXT</span>:	<span class="k">return</span> <span class="s">&quot;RDS Radio Text&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_ENABLED</span>:	<span class="k">return</span> <span class="s">&quot;Audio Limiter Feature Enabled&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_RELEASE_TIME</span>: <span class="k">return</span> <span class="s">&quot;Audio Limiter Release Time&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_DEVIATION</span>:	<span class="k">return</span> <span class="s">&quot;Audio Limiter Deviation&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ENABLED</span>: <span class="k">return</span> <span class="s">&quot;Audio Compression Enabled&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_GAIN</span>:	<span class="k">return</span> <span class="s">&quot;Audio Compression Gain&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_THRESHOLD</span>: <span class="k">return</span> <span class="s">&quot;Audio Compression Threshold&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ATTACK_TIME</span>: <span class="k">return</span> <span class="s">&quot;Audio Compression Attack Time&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_RELEASE_TIME</span>: <span class="k">return</span> <span class="s">&quot;Audio Compression Release Time&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_ENABLED</span>:	<span class="k">return</span> <span class="s">&quot;Pilot Tone Feature Enabled&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_DEVIATION</span>:	<span class="k">return</span> <span class="s">&quot;Pilot Tone Deviation&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_FREQUENCY</span>:	<span class="k">return</span> <span class="s">&quot;Pilot Tone Frequency&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_PREEMPHASIS</span>:		<span class="k">return</span> <span class="s">&quot;Pre-Emphasis&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span>:		<span class="k">return</span> <span class="s">&quot;Tune Power Level&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span>:	<span class="k">return</span> <span class="s">&quot;Tune Antenna Capacitor&quot;</span><span class="p">;</span>

	<span class="cm">/* Flash controls */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_CLASS</span>:		<span class="k">return</span> <span class="s">&quot;Flash Controls&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_LED_MODE</span>:		<span class="k">return</span> <span class="s">&quot;LED Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE_SOURCE</span>:	<span class="k">return</span> <span class="s">&quot;Strobe Source&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE</span>:		<span class="k">return</span> <span class="s">&quot;Strobe&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE_STOP</span>:	<span class="k">return</span> <span class="s">&quot;Stop Strobe&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE_STATUS</span>:	<span class="k">return</span> <span class="s">&quot;Strobe Status&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_TIMEOUT</span>:		<span class="k">return</span> <span class="s">&quot;Strobe Timeout&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_INTENSITY</span>:		<span class="k">return</span> <span class="s">&quot;Intensity, Flash Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_TORCH_INTENSITY</span>:	<span class="k">return</span> <span class="s">&quot;Intensity, Torch Mode&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_INDICATOR_INTENSITY</span>: <span class="k">return</span> <span class="s">&quot;Intensity, Indicator&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_FAULT</span>:		<span class="k">return</span> <span class="s">&quot;Faults&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_CHARGE</span>:		<span class="k">return</span> <span class="s">&quot;Charge&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_READY</span>:		<span class="k">return</span> <span class="s">&quot;Ready to Strobe&quot;</span><span class="p">;</span>

	<span class="cm">/* JPEG encoder controls */</span>
	<span class="cm">/* Keep the order of the &#39;case&#39;s the same as in videodev2.h! */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_CLASS</span>:		<span class="k">return</span> <span class="s">&quot;JPEG Compression Controls&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_CHROMA_SUBSAMPLING</span>:	<span class="k">return</span> <span class="s">&quot;Chroma Subsampling&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_RESTART_INTERVAL</span>:	<span class="k">return</span> <span class="s">&quot;Restart Interval&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_COMPRESSION_QUALITY</span>:	<span class="k">return</span> <span class="s">&quot;Compression Quality&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_ACTIVE_MARKER</span>:	<span class="k">return</span> <span class="s">&quot;Active Markers&quot;</span><span class="p">;</span>

	<span class="cm">/* Image source controls */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_IMAGE_SOURCE_CLASS</span>:	<span class="k">return</span> <span class="s">&quot;Image Source Controls&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VBLANK</span>:			<span class="k">return</span> <span class="s">&quot;Vertical Blanking&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HBLANK</span>:			<span class="k">return</span> <span class="s">&quot;Horizontal Blanking&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ANALOGUE_GAIN</span>:		<span class="k">return</span> <span class="s">&quot;Analogue Gain&quot;</span><span class="p">;</span>

	<span class="cm">/* Image processing controls */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_IMAGE_PROC_CLASS</span>:		<span class="k">return</span> <span class="s">&quot;Image Processing Controls&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_LINK_FREQ</span>:		<span class="k">return</span> <span class="s">&quot;Link Frequency&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PIXEL_RATE</span>:		<span class="k">return</span> <span class="s">&quot;Pixel Rate&quot;</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_get_name</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">v4l2_ctrl_fill</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">**</span><span class="n">name</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_ctrl_type</span> <span class="o">*</span><span class="n">type</span><span class="p">,</span>
		    <span class="n">s32</span> <span class="o">*</span><span class="n">min</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">max</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">step</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">def</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">v4l2_ctrl_get_name</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="o">*</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LOUDNESS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUTOGAIN</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_HUE_AUTO</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_CHROMA_AGC</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_COLOR_KILLER</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_MUTE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MUTE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_GOP_CLOSURE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_PULLDOWN</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_AUTO_PRIORITY</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FOCUS_AUTO</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_PRIVACY</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_ENABLED</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ENABLED</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_ENABLED</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_ILLUMINATORS_1</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_ILLUMINATORS_2</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE_STATUS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_CHARGE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_READY</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_DECODER_MPEG4_DEBLOCK_FILTER</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_DECODER_SLICE_INTERFACE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_FRAME_RC_ENABLE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MB_RC_ENABLE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_8X8_TRANSFORM</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_ENABLE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_QPEL</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_WIDE_DYNAMIC_RANGE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_IMAGE_STABILIZATION</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">;</span>
		<span class="o">*</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="o">*</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PAN_RESET</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_TILT_RESET</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE_STOP</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_START</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_STOP</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_WRITE_ONLY</span><span class="p">;</span>
		<span class="o">*</span><span class="n">min</span> <span class="o">=</span> <span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="o">*</span><span class="n">step</span> <span class="o">=</span> <span class="o">*</span><span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_SAMPLING_FREQ</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_ENCODING</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_L1_BITRATE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_L2_BITRATE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_L3_BITRATE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_AC3_BITRATE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_MODE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_MODE_EXTENSION</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_EMPHASIS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_CRC</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_DEC_PLAYBACK</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_DEC_MULTILINGUAL_PLAYBACK</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ENCODING</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_ASPECT</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE_MODE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_TYPE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_VBI_FMT</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_AUTO</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_RANGE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_COLORFX</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_PREEMPHASIS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_LED_MODE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE_SOURCE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_HEADER_MODE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MULTI_SLICE_MODE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_ENTROPY_MODE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LEVEL</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_LOOP_FILTER_MODE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_PROFILE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_H264_VUI_SAR_IDC</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_LEVEL</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_MPEG4_PROFILE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_CHROMA_SUBSAMPLING</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_ISO_SENSITIVITY_AUTO</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_METERING</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_SCENE_MODE</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_LINK_FREQ</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_PS_NAME</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_RADIO_TEXT</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_STRING</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ISO_SENSITIVITY</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_EXPOSURE_BIAS</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_USER_CLASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_CAMERA_CLASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_CLASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FM_TX_CLASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_CLASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_CLASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_IMAGE_SOURCE_CLASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_IMAGE_PROC_CLASS</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_CTRL_CLASS</span><span class="p">;</span>
		<span class="cm">/* You can neither read not write these */</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span> <span class="o">|</span> <span class="n">V4L2_CTRL_FLAG_WRITE_ONLY</span><span class="p">;</span>
		<span class="o">*</span><span class="n">min</span> <span class="o">=</span> <span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="o">*</span><span class="n">step</span> <span class="o">=</span> <span class="o">*</span><span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BG_COLOR</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="o">*</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">*</span><span class="n">min</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Max is calculated as RGB888 that is 2^24 */</span>
		<span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="mh">0xFFFFFF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_FAULT</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_JPEG_ACTIVE_MARKER</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_3A_LOCK</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_STATUS</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BITMASK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MIN_BUFFERS_FOR_CAPTURE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MIN_BUFFERS_FOR_OUTPUT</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_DEC_FRAME</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_DEC_PTS</span>:
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">;</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PIXEL_RATE</span>:
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span><span class="p">;</span>
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">;</span>
		<span class="o">*</span><span class="n">min</span> <span class="o">=</span> <span class="o">*</span><span class="n">max</span> <span class="o">=</span> <span class="o">*</span><span class="n">step</span> <span class="o">=</span> <span class="o">*</span><span class="n">def</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_ENCODING</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_AUDIO_MODE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_BITRATE_MODE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_VIDEO_B_FRAMES</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_MPEG_STREAM_TYPE</span>:
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_UPDATE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_HUE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_RED_BALANCE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_BLUE_BALANCE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_GAMMA</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_SHARPNESS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_CHROMA_GAIN</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_RDS_TX_DEVIATION</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_RELEASE_TIME</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_LIMITER_DEVIATION</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_GAIN</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_THRESHOLD</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_ATTACK_TIME</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_COMPRESSION_RELEASE_TIME</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_DEVIATION</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_PILOT_TONE_FREQUENCY</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_POWER_LEVEL</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_TUNE_ANTENNA_CAPACITOR</span>:
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_SLIDER</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_PAN_RELATIVE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_TILT_RELATIVE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FOCUS_RELATIVE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_IRIS_RELATIVE</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_ZOOM_RELATIVE</span>:
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_WRITE_ONLY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_STROBE_STATUS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_FOCUS_STATUS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_FLASH_READY</span>:
		<span class="o">*</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_fill</span><span class="p">);</span>

<span class="cm">/* Helper function to determine whether the control type is compatible with</span>
<span class="cm">   VIDIOC_G/S_CTRL. */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">type_is_int</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_STRING</span>:
		<span class="cm">/* Nope, these need v4l2_ext_control */</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">));</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_EVENT_CTRL</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">changes</span> <span class="o">=</span> <span class="n">changes</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_STRING</span><span class="p">)</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">value64</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">value64</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val64</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>
	    <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span><span class="p">)</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">send_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_event</span> <span class="n">ev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subscribed_event</span> <span class="o">*</span><span class="n">sev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ev_subs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">fill_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">changes</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ev_subs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span> <span class="o">!=</span> <span class="n">fh</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_EVENT_SUB_FL_ALLOW_FEEDBACK</span><span class="p">))</span>
			<span class="n">v4l2_event_queue_fh</span><span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Helper function: copy the current control value back to the caller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cur_to_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_STRING</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">string</span><span class="p">,</span>
						<span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value64</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Helper function: copy the caller-provider value as the new control value */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">user_to_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val64</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_STRING</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="n">last</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">[</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="cm">/* If the string was longer than ctrl-&gt;maximum,</span>
<span class="cm">			   then return an error. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">)</span> <span class="o">==</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">&amp;&amp;</span> <span class="n">last</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Helper function: copy the new control value back to the caller */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">new_to_user</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_STRING</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span>
						<span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span>:
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value64</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Copy the new value to the current value. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">new_to_cur</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
						<span class="n">bool</span> <span class="n">update_inactive</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">changed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span>:
		<span class="n">changed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_STRING</span>:
		<span class="cm">/* strings are always 0-terminated */</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span>:
		<span class="n">changed</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val64</span> <span class="o">!=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val64</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val64</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">changed</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">!=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_inactive</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Note: update_inactive can only be true for auto clusters. */</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span>
			<span class="o">~</span><span class="p">(</span><span class="n">V4L2_CTRL_FLAG_INACTIVE</span> <span class="o">|</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cur_manual</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_INACTIVE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">has_volatiles</span><span class="p">)</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">||</span> <span class="n">update_inactive</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If a control was changed that was not one of the controls</span>
<span class="cm">		   modified by the application, then send the event to all. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">is_new</span><span class="p">)</span>
			<span class="n">fh</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">send_event</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span>
			<span class="p">(</span><span class="n">changed</span> <span class="o">?</span> <span class="n">V4L2_EVENT_CTRL_CH_VALUE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">update_inactive</span> <span class="o">?</span> <span class="n">V4L2_EVENT_CTRL_CH_FLAGS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Copy the current value to the new value */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cur_to_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_STRING</span>:
		<span class="cm">/* strings are always 0-terminated */</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span>:
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val64</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val64</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Return non-zero if one or more of the controls in the cluster has a new</span>
<span class="cm">   value that differs from the current value. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cluster_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">diff</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">diff</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span>:
			<span class="cm">/* Button controls are always &#39;different&#39; */</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_STRING</span>:
			<span class="cm">/* strings are always 0-terminated */</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="n">strcmp</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span>:
			<span class="n">diff</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val64</span> <span class="o">!=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val64</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">diff</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">!=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">diff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Validate integer-type control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_new_int</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">pval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">pval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span>:
		<span class="cm">/* Round towards the closest legal value */</span>
		<span class="n">val</span> <span class="o">+=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">val</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">*</span> <span class="p">(</span><span class="n">offset</span> <span class="o">/</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
		<span class="o">*</span><span class="n">pval</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span>:
		<span class="o">*</span><span class="n">pval</span> <span class="o">=</span> <span class="o">!!</span><span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">menu_skip_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">val</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu</span><span class="p">[</span><span class="n">val</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BITMASK</span>:
		<span class="o">*</span><span class="n">pval</span> <span class="o">&amp;=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_CTRL_CLASS</span>:
		<span class="o">*</span><span class="n">pval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Validate a new control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_new</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">c</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">string</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BITMASK</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_CTRL_CLASS</span>:
		<span class="k">return</span> <span class="n">validate_new_int</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_STRING</span>:
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">)</span> <span class="o">%</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">node2id</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">node</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the handler&#39;s error code if it wasn&#39;t set earlier already */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">handler_set_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">err</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the handler */</span>
<span class="kt">int</span> <span class="nf">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="n">nr_of_controls_hint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">_lock</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">);</span>
	<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">nr_of_buckets</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">nr_of_controls_hint</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">nr_of_buckets</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			       <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_handler_init</span><span class="p">);</span>

<span class="cm">/* Free all controls and control refs */</span>
<span class="kt">void</span> <span class="nf">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">,</span> <span class="o">*</span><span class="n">next_ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">*</span><span class="n">next_ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subscribed_event</span> <span class="o">*</span><span class="n">sev</span><span class="p">,</span> <span class="o">*</span><span class="n">next_sev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* Free all nodes */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">next_ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ref</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Free all controls owned by the handler */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">next_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sev</span><span class="p">,</span> <span class="n">next_sev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ev_subs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
			<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span><span class="p">);</span>
	<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">cached</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_handler_free</span><span class="p">);</span>

<span class="cm">/* For backwards compatibility: V4L2_CID_PRIVATE_BASE should no longer</span>
<span class="cm">   be used except in G_CTRL, S_CTRL, QUERYCTRL and QUERYMENU when dealing</span>
<span class="cm">   with applications that do not use the NEXT_CTRL flag.</span>

<span class="cm">   We just find the n-th private user control. It&#39;s O(N), but that should not</span>
<span class="cm">   be an issue in this particular case. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="nf">find_private_ref</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">-=</span> <span class="n">V4L2_CID_PRIVATE_BASE</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Search for private user controls that are compatible with</span>
<span class="cm">		   VIDIOC_G/S_CTRL. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">V4L2_CTRL_ID2CLASS</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">==</span> <span class="n">V4L2_CTRL_CLASS_USER</span> <span class="o">&amp;&amp;</span>
		    <span class="n">V4L2_CTRL_DRIVER_PRIV</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">type_is_int</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ref</span><span class="p">;</span>
			<span class="n">id</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find a control with the given ID. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="nf">find_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bucket</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">&amp;=</span> <span class="n">V4L2_CTRL_ID_MASK</span><span class="p">;</span>

	<span class="cm">/* Old-style private controls need special handling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_PRIVATE_BASE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">find_private_ref</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">bucket</span> <span class="o">=</span> <span class="n">id</span> <span class="o">%</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">nr_of_buckets</span><span class="p">;</span>

	<span class="cm">/* Simple optimization: cache the last control found */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">cached</span> <span class="o">&amp;&amp;</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">cached</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">cached</span><span class="p">;</span>

	<span class="cm">/* Not in cache, search the hash */</span>
	<span class="n">ref</span> <span class="o">=</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span> <span class="o">?</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ref</span> <span class="o">&amp;&amp;</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span>
		<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">cached</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span> <span class="cm">/* cache it! */</span>
	<span class="k">return</span> <span class="n">ref</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find a control with the given ID. Take the handler&#39;s lock first. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="nf">find_ref_lock</span><span class="p">(</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="n">find_ref</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ref</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find a control with the given ID. */</span>
<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="nf">v4l2_ctrl_find</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">ref</span> <span class="o">=</span> <span class="n">find_ref_lock</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ref</span> <span class="o">?</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_find</span><span class="p">);</span>

<span class="cm">/* Allocate a new v4l2_ctrl_ref and hook it into the handler. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">handler_new_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">new_ref</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">class_ctrl</span> <span class="o">=</span> <span class="n">V4L2_CTRL_ID2CLASS</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">|</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bucket</span> <span class="o">=</span> <span class="n">id</span> <span class="o">%</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">nr_of_buckets</span><span class="p">;</span>	<span class="cm">/* which bucket to use */</span>

	<span class="cm">/* Automatically add the control class if it is not yet present. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="n">class_ctrl</span> <span class="o">&amp;&amp;</span> <span class="n">find_ref_lock</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">class_ctrl</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">class_ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>

	<span class="n">new_ref</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">new_ref</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_ref</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">==</span> <span class="n">hdl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* By default each control starts in a cluster of its own.</span>
<span class="cm">		   new_ref-&gt;ctrl is basically a cluster array with one</span>
<span class="cm">		   element, so that&#39;s perfect to use as the cluster pointer.</span>
<span class="cm">		   But only do this for the handler that owns the control. */</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cluster</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ncontrols</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Add immediately at the end of the list if the list is empty, or if</span>
<span class="cm">	   the last element in the list has a lower ID.</span>
<span class="cm">	   This ensures that when elements are added in ascending order the</span>
<span class="cm">	   insertion is an O(1) operation. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">)</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&gt;</span> <span class="n">node2id</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">.</span><span class="n">prev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">insert_in_hash</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find insert position in sorted list */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Don&#39;t add duplicates */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">new_ref</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">prev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">insert_in_hash:</span>
	<span class="cm">/* Insert the control node in the hash */</span>
	<span class="n">new_ref</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket</span><span class="p">];</span>
	<span class="n">hdl</span><span class="o">-&gt;</span><span class="n">buckets</span><span class="p">[</span><span class="n">bucket</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_ref</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Add a new control */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="nf">v4l2_ctrl_new</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_ctrl_type</span> <span class="n">type</span><span class="p">,</span>
			<span class="n">s32</span> <span class="n">min</span><span class="p">,</span> <span class="n">s32</span> <span class="n">max</span><span class="p">,</span> <span class="n">u32</span> <span class="n">step</span><span class="p">,</span> <span class="n">s32</span> <span class="n">def</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">qmenu</span><span class="p">,</span>
			<span class="k">const</span> <span class="n">s64</span> <span class="o">*</span><span class="n">qmenu_int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">sz_extra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Sanity checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_PRIVATE_BASE</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span> <span class="o">&amp;&amp;</span> <span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_BITMASK</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span> <span class="o">&amp;&amp;</span> <span class="n">qmenu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span> <span class="o">&amp;&amp;</span> <span class="n">qmenu_int</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_STRING</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CTRL_TYPE_BITMASK</span> <span class="o">&amp;&amp;</span> <span class="n">max</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span> <span class="o">||</span>
	     <span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span> <span class="o">||</span>
	     <span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span> <span class="o">||</span>
	     <span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">def</span> <span class="o">&lt;</span> <span class="n">min</span> <span class="o">||</span> <span class="n">def</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_BITMASK</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">def</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">max</span><span class="p">)</span> <span class="o">||</span> <span class="n">min</span> <span class="o">||</span> <span class="n">step</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_WRITE_ONLY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_CTRL_CLASS</span><span class="p">)</span>
		<span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_STRING</span><span class="p">)</span>
		<span class="n">sz_extra</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">+</span> <span class="n">sz_extra</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ev_subs</span><span class="p">);</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">step</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">)</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu</span> <span class="o">=</span> <span class="n">qmenu</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span><span class="p">)</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu_int</span> <span class="o">=</span> <span class="n">qmenu_int</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">def</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_STRING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">sz_extra</span> <span class="o">-</span> <span class="p">(</span><span class="n">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">string</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">sz_extra</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">string</span><span class="p">,</span> <span class="sc">&#39; &#39;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handler_new_ref</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ctrl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="nf">v4l2_ctrl_new_custom</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_menu</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">qmenu</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">qmenu</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">s64</span> <span class="o">*</span><span class="n">qmenu_int</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">qmenu_int</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_ctrl_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">min</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">min</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">max</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">max</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">step</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">def</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">def</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">v4l2_ctrl_fill</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step</span><span class="p">,</span>
								<span class="o">&amp;</span><span class="n">def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">is_menu</span> <span class="o">=</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span> <span class="o">||</span>
		   <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_menu</span><span class="p">)</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">step</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">menu_skip_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span> <span class="o">&amp;&amp;</span> <span class="n">qmenu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">qmenu</span> <span class="o">=</span> <span class="n">v4l2_ctrl_get_menu</span><span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span> <span class="o">&amp;&amp;</span>
		 <span class="n">qmenu_int</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
			<span class="n">type</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span>
			<span class="n">is_menu</span> <span class="o">?</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">menu_skip_mask</span> <span class="o">:</span> <span class="n">step</span><span class="p">,</span>
			<span class="n">def</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">qmenu</span><span class="p">,</span> <span class="n">qmenu_int</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="p">)</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">is_private</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">is_private</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ctrl</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_new_custom</span><span class="p">);</span>

<span class="cm">/* Helper function for standard non-menu controls */</span>
<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="nf">v4l2_ctrl_new_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">s32</span> <span class="n">min</span><span class="p">,</span> <span class="n">s32</span> <span class="n">max</span><span class="p">,</span> <span class="n">u32</span> <span class="n">step</span><span class="p">,</span> <span class="n">s32</span> <span class="n">def</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_ctrl_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_fill</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>
	    <span class="o">||</span> <span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">v4l2_ctrl_new</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
			     <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">step</span><span class="p">,</span> <span class="n">def</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_new_std</span><span class="p">);</span>

<span class="cm">/* Helper function for standard menu controls */</span>
<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="nf">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">s32</span> <span class="n">max</span><span class="p">,</span> <span class="n">s32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">s32</span> <span class="n">def</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="o">*</span><span class="n">qmenu</span> <span class="o">=</span> <span class="n">v4l2_ctrl_get_menu</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_ctrl_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">step</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_fill</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">v4l2_ctrl_new</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">def</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">qmenu</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_new_std_menu</span><span class="p">);</span>

<span class="cm">/* Helper function for standard integer menu controls */</span>
<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="nf">v4l2_ctrl_new_int_menu</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">id</span><span class="p">,</span> <span class="n">s32</span> <span class="n">max</span><span class="p">,</span> <span class="n">s32</span> <span class="n">def</span><span class="p">,</span> <span class="k">const</span> <span class="n">s64</span> <span class="o">*</span><span class="n">qmenu_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_ctrl_type</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">step</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_fill</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">step</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">def</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">v4l2_ctrl_new</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span>
			     <span class="mi">0</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">def</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">qmenu_int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_new_int_menu</span><span class="p">);</span>

<span class="cm">/* Add a control from another handler to this handler */</span>
<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="nf">v4l2_ctrl_add_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handler_set_err</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span> <span class="o">==</span> <span class="n">hdl</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">handler_new_ref</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">)</span> <span class="o">?</span> <span class="nb">NULL</span> <span class="o">:</span> <span class="n">ctrl</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_add_ctrl</span><span class="p">);</span>

<span class="cm">/* Add the controls from another handler to our own. */</span>
<span class="kt">int</span> <span class="nf">v4l2_ctrl_add_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Do nothing if either handler is NULL or if they are the same */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hdl</span> <span class="o">||</span> <span class="o">!</span><span class="n">add</span> <span class="o">||</span> <span class="n">hdl</span> <span class="o">==</span> <span class="n">add</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">add</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">add</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

		<span class="cm">/* Skip handler-private controls. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">is_private</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* And control classes */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_CTRL_CLASS</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">handler_new_ref</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">add</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_add_handler</span><span class="p">);</span>

<span class="cm">/* Cluster controls */</span>
<span class="kt">void</span> <span class="nf">v4l2_ctrl_cluster</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">ncontrols</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">**</span><span class="n">controls</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">has_volatiles</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* The first control is the master control and it must not be NULL */</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ncontrols</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">controls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">cluster</span> <span class="o">=</span> <span class="n">controls</span><span class="p">;</span>
			<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ncontrols</span> <span class="o">=</span> <span class="n">ncontrols</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">)</span>
				<span class="n">has_volatiles</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">controls</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">has_volatiles</span> <span class="o">=</span> <span class="n">has_volatiles</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_cluster</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">v4l2_ctrl_auto_cluster</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">ncontrols</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">**</span><span class="n">controls</span><span class="p">,</span>
			    <span class="n">u8</span> <span class="n">manual_val</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set_volatile</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_cluster</span><span class="p">(</span><span class="n">ncontrols</span><span class="p">,</span> <span class="n">controls</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ncontrols</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">manual_val</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">||</span> <span class="n">manual_val</span> <span class="o">&gt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">);</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">set_volatile</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">has_op</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">g_volatile_ctrl</span><span class="p">));</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">is_auto</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">has_volatiles</span> <span class="o">=</span> <span class="n">set_volatile</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">manual_mode_value</span> <span class="o">=</span> <span class="n">manual_val</span><span class="p">;</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_UPDATE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_cur_manual</span><span class="p">(</span><span class="n">master</span><span class="p">))</span>
		<span class="n">flag</span> <span class="o">=</span> <span class="n">V4L2_CTRL_FLAG_INACTIVE</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">set_volatile</span> <span class="o">?</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">flag</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_auto_cluster</span><span class="p">);</span>

<span class="cm">/* Activate/deactivate a control. */</span>
<span class="kt">void</span> <span class="nf">v4l2_ctrl_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">bool</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* invert since the actual flag is called &#39;inactive&#39; */</span>
	<span class="n">bool</span> <span class="n">inactive</span> <span class="o">=</span> <span class="o">!</span><span class="n">active</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">old</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inactive</span><span class="p">)</span>
		<span class="cm">/* set V4L2_CTRL_FLAG_INACTIVE */</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* clear V4L2_CTRL_FLAG_INACTIVE */</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">inactive</span><span class="p">)</span>
		<span class="n">send_event</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">V4L2_EVENT_CTRL_CH_FLAGS</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_activate</span><span class="p">);</span>

<span class="cm">/* Grab/ungrab a control.</span>
<span class="cm">   Typically used when streaming starts and you want to grab controls,</span>
<span class="cm">   preventing the user from changing them.</span>

<span class="cm">   Just call this and the framework will block any attempts to change</span>
<span class="cm">   these controls. */</span>
<span class="kt">void</span> <span class="nf">v4l2_ctrl_grab</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">bool</span> <span class="n">grabbed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">old</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_lock</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">grabbed</span><span class="p">)</span>
		<span class="cm">/* set V4L2_CTRL_FLAG_GRABBED */</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* clear V4L2_CTRL_FLAG_GRABBED */</span>
		<span class="n">old</span> <span class="o">=</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old</span> <span class="o">!=</span> <span class="n">grabbed</span><span class="p">)</span>
		<span class="n">send_event</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">V4L2_EVENT_CTRL_CH_FLAGS</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_unlock</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_grab</span><span class="p">);</span>

<span class="cm">/* Log the control name and value */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">log_ctrl</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">colon</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_CTRL_FLAG_DISABLED</span> <span class="o">|</span> <span class="n">V4L2_CTRL_FLAG_WRITE_ONLY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_CTRL_CLASS</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s%s%s: &quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">colon</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu</span><span class="p">[</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu_int</span><span class="p">[</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BITMASK</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;0x%08x&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER64</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%lld&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val64</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_STRING</span>:
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">string</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;unknown type %d&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_CTRL_FLAG_INACTIVE</span> <span class="o">|</span>
			   <span class="n">V4L2_CTRL_FLAG_GRABBED</span> <span class="o">|</span>
			   <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_INACTIVE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; inactive&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_GRABBED</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; grabbed&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; volatile&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Log all controls owned by the handler */</span>
<span class="kt">void</span> <span class="nf">v4l2_ctrl_handler_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">colon</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prefix</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">prefix</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">prefix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">prefix</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
		<span class="n">colon</span> <span class="o">=</span> <span class="s">&quot;: &quot;</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_DISABLED</span><span class="p">))</span>
			<span class="n">log_ctrl</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">colon</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_handler_log_status</span><span class="p">);</span>

<span class="cm">/* Call s_ctrl for all controls owned by the handler */</span>
<span class="kt">int</span> <span class="nf">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Skip if this control was already handled by a cluster. */</span>
		<span class="cm">/* Skip button controls and read-only controls. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">cur_to_new</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">call_op</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_handler_setup</span><span class="p">);</span>

<span class="cm">/* Implement VIDIOC_QUERYCTRL */</span>
<span class="kt">int</span> <span class="nf">v4l2_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">id</span> <span class="o">=</span> <span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_ID_MASK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Try to find it */</span>
	<span class="n">ref</span> <span class="o">=</span> <span class="n">find_ref</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_NEXT_CTRL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Find the next control with ID &gt; qc-&gt;id */</span>

		<span class="cm">/* Did we reach the end of the control list? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">node2id</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">.</span><span class="n">prev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Yes, so there is no next control */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* We found a control with the given ID, so just get</span>
<span class="cm">			   the next one in the list. */</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ref</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ref</span><span class="p">),</span> <span class="n">node</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* No control with the given ID exists, so start</span>
<span class="cm">			   searching for the next largest ID. We know there</span>
<span class="cm">			   is one, otherwise the first &#39;if&#39; above would have</span>
<span class="cm">			   been true. */</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ref</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">qc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_PRIVATE_BASE</span><span class="p">)</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">;</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">;</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>
	    <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span><span class="p">)</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">qc</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">step</span><span class="p">;</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">qc</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_queryctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_subdev_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_NEXT_CTRL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">v4l2_queryctrl</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">qc</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_subdev_queryctrl</span><span class="p">);</span>

<span class="cm">/* Implement VIDIOC_QUERYMENU */</span>
<span class="kt">int</span> <span class="nf">v4l2_querymenu</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_querymenu</span> <span class="o">*</span><span class="n">qm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span> <span class="o">=</span> <span class="n">qm</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">v4l2_ctrl_find</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">qm</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">qm</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Sanity checks */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER_MENU</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu_int</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Use mask to see if this menu item should be skipped */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">menu_skip_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Empty menu items should also be skipped */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">qm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">qm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">qm</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">qmenu_int</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_querymenu</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_subdev_querymenu</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_querymenu</span> <span class="o">*</span><span class="n">qm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v4l2_querymenu</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">qm</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_subdev_querymenu</span><span class="p">);</span>



<span class="cm">/* Some general notes on the atomic requirements of VIDIOC_G/TRY/S_EXT_CTRLS:</span>

<span class="cm">   It is not a fully atomic operation, just best-effort only. After all, if</span>
<span class="cm">   multiple controls have to be set through multiple i2c writes (for example)</span>
<span class="cm">   then some initial writes may succeed while others fail. Thus leaving the</span>
<span class="cm">   system in an inconsistent state. The question is how much effort you are</span>
<span class="cm">   willing to spend on trying to make something atomic that really isn&#39;t.</span>

<span class="cm">   From the point of view of an application the main requirement is that</span>
<span class="cm">   when you call VIDIOC_S_EXT_CTRLS and some values are invalid then an</span>
<span class="cm">   error should be returned without actually affecting any controls.</span>

<span class="cm">   If all the values are correct, then it is acceptable to just give up</span>
<span class="cm">   in case of low-level errors.</span>

<span class="cm">   It is important though that the application can tell when only a partial</span>
<span class="cm">   configuration was done. The way we do that is through the error_idx field</span>
<span class="cm">   of struct v4l2_ext_controls: if that is equal to the count field then no</span>
<span class="cm">   controls were affected. Otherwise all controls before that index were</span>
<span class="cm">   successful in performing their &#39;get&#39; or &#39;set&#39; operation, the control at</span>
<span class="cm">   the given index failed, and you don&#39;t know what happened with the controls</span>
<span class="cm">   after the failed one. Since if they were part of a control cluster they</span>
<span class="cm">   could have been successfully processed (if a cluster member was encountered</span>
<span class="cm">   at index &lt; error_idx), they could have failed (if a cluster member was at</span>
<span class="cm">   error_idx), or they may not have been processed yet (if the first cluster</span>
<span class="cm">   member appeared after error_idx).</span>

<span class="cm">   It is all fairly theoretical, though. In practice all you can do is to</span>
<span class="cm">   bail out. If error_idx == count, then it is an application bug. If</span>
<span class="cm">   error_idx &lt; count then it is only an application bug if the error code was</span>
<span class="cm">   EBUSY. That usually means that something started streaming just when you</span>
<span class="cm">   tried to set the controls. In all other cases it is a driver/hardware</span>
<span class="cm">   problem and all you can do is to retry or bail out.</span>

<span class="cm">   Note that these rules do not apply to VIDIOC_TRY_EXT_CTRLS: since that</span>
<span class="cm">   never modifies controls the error_idx is just set to whatever control</span>
<span class="cm">   has an invalid value.</span>
<span class="cm"> */</span>

<span class="cm">/* Prepare for the extended g/s/try functions.</span>
<span class="cm">   Find the controls in the control array and do some basic checks. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">prepare_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_ctrl_helper</span> <span class="o">*</span><span class="n">helpers</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_helper</span> <span class="o">*</span><span class="n">h</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">have_clusters</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">helpers</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">ref</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">id</span> <span class="o">=</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_ID_MASK</span><span class="p">;</span>

		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ctrl_class</span> <span class="o">&amp;&amp;</span> <span class="n">V4L2_CTRL_ID2CLASS</span><span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">ctrl_class</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* Old-style private controls are not allowed for</span>
<span class="cm">		   extended controls */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">V4L2_CID_PRIVATE_BASE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ref</span> <span class="o">=</span> <span class="n">find_ref_lock</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">ref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_DISABLED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ncontrols</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">have_clusters</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ctrl</span><span class="p">)</span>
			<span class="n">ref</span> <span class="o">=</span> <span class="n">find_ref_lock</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="cm">/* Store the ref to the master control of the cluster */</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">mref</span> <span class="o">=</span> <span class="n">ref</span><span class="p">;</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
		<span class="cm">/* Initially set next to 0, meaning that there is no other</span>
<span class="cm">		   control in this helper array belonging to the same</span>
<span class="cm">		   cluster */</span>
		<span class="n">h</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We are done if there were no controls that belong to a multi-</span>
<span class="cm">	   control cluster. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_clusters</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The code below figures out in O(n) time which controls in the list</span>
<span class="cm">	   belong to the same cluster. */</span>

	<span class="cm">/* This has to be done with the handler lock taken. */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* First zero the helper field in the master control references */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">helpers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mref</span><span class="o">-&gt;</span><span class="n">helper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">h</span> <span class="o">=</span> <span class="n">helpers</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">h</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl_ref</span> <span class="o">*</span><span class="n">mref</span> <span class="o">=</span> <span class="n">h</span><span class="o">-&gt;</span><span class="n">mref</span><span class="p">;</span>

		<span class="cm">/* If the mref-&gt;helper is set, then it points to an earlier</span>
<span class="cm">		   helper that belongs to the same cluster. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mref</span><span class="o">-&gt;</span><span class="n">helper</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Set the next field of mref-&gt;helper to the current</span>
<span class="cm">			   index: this means that that earlier helper now</span>
<span class="cm">			   points to the next helper in the same cluster. */</span>
			<span class="n">mref</span><span class="o">-&gt;</span><span class="n">helper</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="cm">/* mref should be set only for the first helper in the</span>
<span class="cm">			   cluster, clear the others. */</span>
			<span class="n">h</span><span class="o">-&gt;</span><span class="n">mref</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Point the mref helper to the current helper struct. */</span>
		<span class="n">mref</span><span class="o">-&gt;</span><span class="n">helper</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Handles the corner case where cs-&gt;count == 0. It checks whether the</span>
<span class="cm">   specified control class exists. If that class ID is 0, then it checks</span>
<span class="cm">   whether there are any controls at all. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">class_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ctrl_class</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl_class</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">ctrl_refs</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">find_ref_lock</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ctrl_class</span> <span class="o">|</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/* Get extended controls. Allocates the helpers array if needed. */</span>
<span class="kt">int</span> <span class="nf">v4l2_g_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_helper</span> <span class="n">helper</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_helper</span> <span class="o">*</span><span class="n">helpers</span> <span class="o">=</span> <span class="n">helper</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ctrl_class</span> <span class="o">=</span> <span class="n">V4L2_CTRL_ID2CLASS</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ctrl_class</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">class_check</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">ctrl_class</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">helper</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">helpers</span> <span class="o">=</span> <span class="n">kmalloc_array</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">helper</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">helpers</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">prepare_ext_ctrls</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">helpers</span><span class="p">);</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">helpers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_WRITE_ONLY</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">ctrl_to_user</span><span class="p">)(</span><span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span> <span class="o">=</span> <span class="n">cur_to_user</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">helpers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">master</span> <span class="o">=</span> <span class="n">helpers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">v4l2_ctrl_lock</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

		<span class="cm">/* g_volatile_ctrl will update the new control values */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">has_volatiles</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_cur_manual</span><span class="p">(</span><span class="n">master</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">cur_to_new</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">]);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">call_op</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">g_volatile_ctrl</span><span class="p">);</span>
			<span class="n">ctrl_to_user</span> <span class="o">=</span> <span class="n">new_to_user</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* If OK, then copy the current (for non-volatile controls)</span>
<span class="cm">		   or the new (for volatile controls) control values to the</span>
<span class="cm">		   caller */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ctrl_to_user</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span>
						   <span class="n">helpers</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ctrl</span><span class="p">);</span>
				<span class="n">idx</span> <span class="o">=</span> <span class="n">helpers</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">v4l2_ctrl_unlock</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">helper</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">helpers</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_g_ext_ctrls</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_subdev_g_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v4l2_g_ext_ctrls</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">cs</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_subdev_g_ext_ctrls</span><span class="p">);</span>

<span class="cm">/* Helper function to get a single control */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_WRITE_ONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_lock</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="cm">/* g_volatile_ctrl will update the current control values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_VOLATILE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cur_to_new</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">call_op</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">g_volatile_ctrl</span><span class="p">);</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_ctrl_unlock</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">v4l2_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">v4l2_ctrl_find</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">type_is_int</span><span class="p">(</span><span class="n">ctrl</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">get_ctrl</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_g_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_subdev_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v4l2_g_ctrl</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_subdev_g_ctrl</span><span class="p">);</span>

<span class="n">s32</span> <span class="nf">v4l2_ctrl_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* It&#39;s a driver bug if this happens. */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">type_is_int</span><span class="p">(</span><span class="n">ctrl</span><span class="p">));</span>
	<span class="n">get_ctrl</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_g_ctrl</span><span class="p">);</span>


<span class="cm">/* Core function that calls try/s_ctrl and ensures that the new value is</span>
<span class="cm">   copied to the current value on a set.</span>
<span class="cm">   Must be called with ctrl-&gt;handler-&gt;lock held. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_or_set_cluster</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">update_flag</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Go through the cluster and either validate the new value or</span>
<span class="cm">	   (if no new value was set), copy the current value to the new</span>
<span class="cm">	   value, ensuring a consistent view for the control ops when</span>
<span class="cm">	   called. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">is_new</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cur_to_new</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Check again: it may have changed since the</span>
<span class="cm">		   previous check in try_or_set_ext_ctrls(). */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_GRABBED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">call_op</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">try_ctrl</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t set if there is no change */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="o">!</span><span class="n">set</span> <span class="o">||</span> <span class="o">!</span><span class="n">cluster_changed</span><span class="p">(</span><span class="n">master</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">call_op</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* If OK, then make the new values permanent. */</span>
	<span class="n">update_flag</span> <span class="o">=</span> <span class="n">is_cur_manual</span><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">!=</span> <span class="n">is_new_manual</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">new_to_cur</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">update_flag</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Validate controls. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_ctrl_helper</span> <span class="o">*</span><span class="n">helpers</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">helpers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl</span><span class="p">;</span>

		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="cm">/* This test is also done in try_set_control_cluster() which</span>
<span class="cm">		   is called in atomic context, so that has the final say,</span>
<span class="cm">		   but it makes sense to do an up-front check as well. Once</span>
<span class="cm">		   an error occurs in try_set_control_cluster() some other</span>
<span class="cm">		   controls may have been set already and we want to do a</span>
<span class="cm">		   best-effort to avoid that. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_GRABBED</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">validate_new</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Obtain the current volatile values of an autocluster and mark them</span>
<span class="cm">   as new. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_from_auto_cluster</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cur_to_new</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">call_op</span><span class="p">(</span><span class="n">master</span><span class="p">,</span> <span class="n">g_volatile_ctrl</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Try or try-and-set controls */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_set_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">cs</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_helper</span> <span class="n">helper</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_helper</span> <span class="o">*</span><span class="n">helpers</span> <span class="o">=</span> <span class="n">helper</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="n">cs</span><span class="o">-&gt;</span><span class="n">ctrl_class</span> <span class="o">=</span> <span class="n">V4L2_CTRL_ID2CLASS</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">ctrl_class</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">class_check</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">ctrl_class</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">helper</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">helpers</span> <span class="o">=</span> <span class="n">kmalloc_array</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">helper</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
					<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">helpers</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">prepare_ext_ctrls</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="n">helpers</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">validate_ctrls</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">helpers</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">set</span><span class="p">)</span>
		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">helpers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mref</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">cs</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">master</span> <span class="o">=</span> <span class="n">helpers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mref</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="n">v4l2_ctrl_lock</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

		<span class="cm">/* Reset the &#39;is_new&#39; flags of the cluster */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* For volatile autoclusters that are currently in auto mode</span>
<span class="cm">		   we need to discover if it will be set to manual mode.</span>
<span class="cm">		   If so, then we have to copy the current volatile values</span>
<span class="cm">		   first since those will become the new manual values (which</span>
<span class="cm">		   may be overwritten by explicit new values from this set</span>
<span class="cm">		   of controls). */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">is_auto</span> <span class="o">&amp;&amp;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">has_volatiles</span> <span class="o">&amp;&amp;</span>
						<span class="o">!</span><span class="n">is_cur_manual</span><span class="p">(</span><span class="n">master</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Pick an initial non-manual value */</span>
			<span class="n">s32</span> <span class="n">new_auto_val</span> <span class="o">=</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">manual_mode_value</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">tmp_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

			<span class="k">do</span> <span class="p">{</span>
				<span class="cm">/* Check if the auto control is part of the</span>
<span class="cm">				   list, and remember the new value. */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">helpers</span><span class="p">[</span><span class="n">tmp_idx</span><span class="p">].</span><span class="n">ctrl</span> <span class="o">==</span> <span class="n">master</span><span class="p">)</span>
					<span class="n">new_auto_val</span> <span class="o">=</span> <span class="n">cs</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">tmp_idx</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>
				<span class="n">tmp_idx</span> <span class="o">=</span> <span class="n">helpers</span><span class="p">[</span><span class="n">tmp_idx</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">tmp_idx</span><span class="p">);</span>
			<span class="cm">/* If the new value == the manual value, then copy</span>
<span class="cm">			   the current volatile values. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_auto_val</span> <span class="o">==</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">manual_mode_value</span><span class="p">)</span>
				<span class="n">update_from_auto_cluster</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Copy the new caller-supplied control values.</span>
<span class="cm">		   user_to_new() sets &#39;is_new&#39; to 1. */</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">user_to_new</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="n">helpers</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ctrl</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">helpers</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">try_or_set_cluster</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>

		<span class="cm">/* Copy the new values back to userspace. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">new_to_user</span><span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span>
						<span class="n">helpers</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">ctrl</span><span class="p">);</span>
				<span class="n">idx</span> <span class="o">=</span> <span class="n">helpers</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">next</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">v4l2_ctrl_unlock</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cs</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">helper</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">helpers</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">v4l2_try_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">try_set_ext_ctrls</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">hdl</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_try_ext_ctrls</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_s_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">try_set_ext_ctrls</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">hdl</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_s_ext_ctrls</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_subdev_try_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">try_set_ext_ctrls</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_subdev_try_ext_ctrls</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_subdev_s_ext_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">cs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">try_set_ext_ctrls</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">cs</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_subdev_s_ext_ctrls</span><span class="p">);</span>

<span class="cm">/* Helper function for VIDIOC_S_CTRL compatibility */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">s32</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">master</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">validate_new_int</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_lock</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>

	<span class="cm">/* Reset the &#39;is_new&#39; flags of the cluster */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">master</span><span class="o">-&gt;</span><span class="n">cluster</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* For autoclusters with volatiles that are switched from auto to</span>
<span class="cm">	   manual mode we have to update the current volatile values since</span>
<span class="cm">	   those will become the initial manual values after such a switch. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">is_auto</span> <span class="o">&amp;&amp;</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">has_volatiles</span> <span class="o">&amp;&amp;</span> <span class="n">ctrl</span> <span class="o">==</span> <span class="n">master</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">is_cur_manual</span><span class="p">(</span><span class="n">master</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">val</span> <span class="o">==</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">manual_mode_value</span><span class="p">)</span>
		<span class="n">update_from_auto_cluster</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="n">val</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">is_new</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">try_or_set_cluster</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">master</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span><span class="p">;</span>
	<span class="n">v4l2_ctrl_unlock</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">v4l2_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">v4l2_ctrl_find</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">type_is_int</span><span class="p">(</span><span class="n">ctrl</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">set_ctrl</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">control</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_s_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_subdev_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">control</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v4l2_s_ctrl</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_subdev_s_ctrl</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_ctrl_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">s32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* It&#39;s a driver bug if this happens. */</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">type_is_int</span><span class="p">(</span><span class="n">ctrl</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">set_ctrl</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_s_ctrl</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">v4l2_ctrl_add_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subscribed_event</span> <span class="o">*</span><span class="n">sev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">elems</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">v4l2_ctrl_find</span><span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">sev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_lock</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">ev_subs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CTRL_TYPE_CTRL_CLASS</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_EVENT_SUB_FL_SEND_INITIAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_event</span> <span class="n">ev</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">changes</span> <span class="o">=</span> <span class="n">V4L2_EVENT_CTRL_CH_FLAGS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_WRITE_ONLY</span><span class="p">))</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">V4L2_EVENT_CTRL_CH_VALUE</span><span class="p">;</span>
		<span class="n">fill_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">changes</span><span class="p">);</span>
		<span class="cm">/* Mark the queue as active, allowing this initial</span>
<span class="cm">		   event to be accepted. */</span>
		<span class="n">sev</span><span class="o">-&gt;</span><span class="n">elems</span> <span class="o">=</span> <span class="n">elems</span><span class="p">;</span>
		<span class="n">v4l2_event_queue_fh</span><span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">v4l2_ctrl_unlock</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">v4l2_ctrl_del_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subscribed_event</span> <span class="o">*</span><span class="n">sev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">v4l2_ctrl_find</span><span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">sev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_lock</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_unlock</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">v4l2_ctrl_replace</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_event</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_event</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">old_changes</span> <span class="o">=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">changes</span><span class="p">;</span>

	<span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">new</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">changes</span> <span class="o">|=</span> <span class="n">old_changes</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_replace</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">v4l2_ctrl_merge</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_event</span> <span class="o">*</span><span class="n">old</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_event</span> <span class="o">*</span><span class="n">new</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">new</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">changes</span> <span class="o">|=</span> <span class="n">old</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">changes</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_merge</span><span class="p">);</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subscribed_event_ops</span> <span class="n">v4l2_ctrl_sub_ev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">v4l2_ctrl_add_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del</span> <span class="o">=</span> <span class="n">v4l2_ctrl_del_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">replace</span> <span class="o">=</span> <span class="n">v4l2_ctrl_replace</span><span class="p">,</span>
	<span class="p">.</span><span class="n">merge</span> <span class="o">=</span> <span class="n">v4l2_ctrl_merge</span><span class="p">,</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_sub_ev_ops</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_ctrl_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">vfh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">V4L2_FL_USES_V4L2_FH</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">vfd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">)</span>
		<span class="n">v4l2_ctrl_handler_log_status</span><span class="p">(</span><span class="n">vfh</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span>
			<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_log_status</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">v4l2_ctrl_subscribe_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_event_subscription</span> <span class="o">*</span><span class="n">sub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_EVENT_CTRL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v4l2_event_subscribe</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4l2_ctrl_sub_ev_ops</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_subscribe_event</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">v4l2_ctrl_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">poll_table_struct</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_event_pending</span><span class="p">(</span><span class="n">fh</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">POLLPRI</span><span class="p">;</span>
	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fh</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">v4l2_ctrl_poll</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
