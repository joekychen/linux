<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › tvaudio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>tvaudio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for simple i2c audio chips.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2000 Gerd Knorr</span>
<span class="cm"> * based on code by:</span>
<span class="cm"> *   Eric Sandeen (eric_sandeen@bigfoot.com)</span>
<span class="cm"> *   Steve VanDeBogart (vandebo@uclink.berkeley.edu)</span>
<span class="cm"> *   Greg Alexander (galexand@acm.org)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2005-2008 Mauro Carvalho Chehab</span>
<span class="cm"> *	- Some cleanups, code fixes, etc</span>
<span class="cm"> *	- Convert it to V4L2 API</span>
<span class="cm"> *</span>
<span class="cm"> * This code is placed under the terms of the GNU General Public License</span>
<span class="cm"> *</span>
<span class="cm"> * OPTIONS:</span>
<span class="cm"> *   debug - set to 1 if you&#39;d like to see debug messages</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>

<span class="cp">#include &lt;media/tvaudio.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>

<span class="cp">#include &lt;media/i2c-addr.h&gt;</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* insmod args                                                            */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>	<span class="cm">/* insmod parameter */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;device driver for various i2c TV sound decoder / audiomux chips&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Eric Sandeen, Steve VanDeBogart, Greg Alexander, Gerd Knorr&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define UNSET    (-1U)</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* our structs                                                            */</span>

<span class="cp">#define MAXREGS 256</span>

<span class="k">struct</span> <span class="n">CHIPSTATE</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">getvalue</span><span class="p">)(</span><span class="kt">int</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">checkit</span><span class="p">)(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span><span class="o">*</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">initialize</span><span class="p">)(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span><span class="o">*</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">int</span>  <span class="p">(</span><span class="o">*</span><span class="n">getmode</span><span class="p">)(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span><span class="o">*</span><span class="p">);</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">setmode</span><span class="p">)(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span><span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>

<span class="cm">/* i2c command */</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">AUDIOCMD</span> <span class="p">{</span>
	<span class="kt">int</span>             <span class="n">count</span><span class="p">;</span>             <span class="cm">/* # of bytes to send */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>   <span class="n">bytes</span><span class="p">[</span><span class="n">MAXREGS</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>  <span class="cm">/* addr, data, data, ... */</span>
<span class="p">}</span> <span class="n">audiocmd</span><span class="p">;</span>

<span class="cm">/* chip description */</span>
<span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="p">{</span>
	<span class="kt">char</span>       <span class="o">*</span><span class="n">name</span><span class="p">;</span>             <span class="cm">/* chip name         */</span>
	<span class="kt">int</span>        <span class="n">addr_lo</span><span class="p">,</span> <span class="n">addr_hi</span><span class="p">;</span>  <span class="cm">/* i2c address range */</span>
	<span class="kt">int</span>        <span class="n">registers</span><span class="p">;</span>         <span class="cm">/* # of registers    */</span>

	<span class="kt">int</span>        <span class="o">*</span><span class="n">insmodopt</span><span class="p">;</span>
	<span class="n">checkit</span>    <span class="n">checkit</span><span class="p">;</span>
	<span class="n">initialize</span> <span class="n">initialize</span><span class="p">;</span>
	<span class="kt">int</span>        <span class="n">flags</span><span class="p">;</span>
<span class="cp">#define CHIP_HAS_VOLUME      1</span>
<span class="cp">#define CHIP_HAS_BASSTREBLE  2</span>
<span class="cp">#define CHIP_HAS_INPUTSEL    4</span>
<span class="cp">#define CHIP_NEED_CHECKMODE  8</span>

	<span class="cm">/* various i2c command sequences */</span>
	<span class="n">audiocmd</span>   <span class="n">init</span><span class="p">;</span>

	<span class="cm">/* which register has which value */</span>
	<span class="kt">int</span>    <span class="n">leftreg</span><span class="p">,</span><span class="n">rightreg</span><span class="p">,</span><span class="n">treblereg</span><span class="p">,</span><span class="n">bassreg</span><span class="p">;</span>

	<span class="cm">/* initialize with (defaults to 65535/65535/32768/32768 */</span>
	<span class="kt">int</span>    <span class="n">leftinit</span><span class="p">,</span><span class="n">rightinit</span><span class="p">,</span><span class="n">trebleinit</span><span class="p">,</span><span class="n">bassinit</span><span class="p">;</span>

	<span class="cm">/* functions to convert the values (v4l -&gt; chip) */</span>
	<span class="n">getvalue</span> <span class="n">volfunc</span><span class="p">,</span><span class="n">treblefunc</span><span class="p">,</span><span class="n">bassfunc</span><span class="p">;</span>

	<span class="cm">/* get/set mode */</span>
	<span class="n">getmode</span>  <span class="n">getmode</span><span class="p">;</span>
	<span class="n">setmode</span>  <span class="n">setmode</span><span class="p">;</span>

	<span class="cm">/* input switch register + values for v4l inputs */</span>
	<span class="kt">int</span>  <span class="n">inputreg</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">inputmap</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span>  <span class="n">inputmute</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">inputmask</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* current state of the chip */</span>
<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="n">sd</span><span class="p">;</span>

	<span class="cm">/* chip-specific description - should point to</span>
<span class="cm">	   an entry at CHIPDESC table */</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="o">*</span><span class="n">desc</span><span class="p">;</span>

	<span class="cm">/* shadow register set */</span>
	<span class="n">audiocmd</span>   <span class="n">shadow</span><span class="p">;</span>

	<span class="cm">/* current settings */</span>
	<span class="n">__u16</span> <span class="n">left</span><span class="p">,</span><span class="n">right</span><span class="p">,</span><span class="n">treble</span><span class="p">,</span><span class="n">bass</span><span class="p">,</span><span class="n">muted</span><span class="p">,</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prevmode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">radio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">input</span><span class="p">;</span>

	<span class="cm">/* thread */</span>
	<span class="k">struct</span> <span class="n">task_struct</span>   <span class="o">*</span><span class="kr">thread</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span>    <span class="n">wt</span><span class="p">;</span>
	<span class="kt">int</span>                  <span class="n">watch_stereo</span><span class="p">;</span>
	<span class="kt">int</span> 		     <span class="n">audmode</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="nf">to_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CHIPSTATE</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* i2c I/O functions                                                      */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chip_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subaddr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;chip_write: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;I/O error (write 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subaddr</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
				<span class="s">&quot;Tried to access a non-existent register: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">subaddr</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;chip_write: reg%d=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">subaddr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">subaddr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">subaddr</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;I/O error (write reg%d=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">subaddr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chip_write_masked</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">subaddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mask</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subaddr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">subaddr</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
					<span class="s">&quot;Tried to access a non-existent register: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">subaddr</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">subaddr</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">subaddr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chip_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">1</span> <span class="o">!=</span> <span class="n">i2c_master_recv</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;I/O error (read)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;chip_read: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chip_read2</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">subaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">write</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">read</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>        <span class="mi">1</span><span class="p">,</span> <span class="n">write</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">c</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">I2C_M_RD</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">read</span>  <span class="p">}</span>
	<span class="p">};</span>

	<span class="n">write</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">subaddr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">2</span> <span class="o">!=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;I/O error (read2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;chip_read2: reg%d=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">subaddr</span><span class="p">,</span> <span class="n">read</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">return</span> <span class="n">read</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chip_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span> <span class="n">audiocmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span>
			 <span class="s">&quot;Tried to access a non-existent register range: %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: it seems that the shadow bytes are wrong bellow !*/</span>

	<span class="cm">/* update our shadow register set; print bytes if (debug &gt; 0) */</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;chip_cmd(%s): reg=%d, data:&quot;</span><span class="p">,</span>
		<span class="n">name</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot; 0x%x&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* send data to the chip */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">!=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">bytes</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;I/O error (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* kernel thread for doing i2c stuff asyncronly</span>
<span class="cm"> *   right now it is used only to check the audio mode (mono/stereo/whatever)</span>
<span class="cm"> *   some time after switching to another TV channel, then turn on stereo</span>
<span class="cm"> *   if available, ...</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">chip_thread_wake</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">chip_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span>  <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;thread started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;thread wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* don&#39;t do anything for radio or if mode != auto */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">||</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* have a look what&#39;s going on */</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">getmode</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prevmode</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* chip detected a new audio mode - set it */</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;thread checkmode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prevmode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">)</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">setmode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span><span class="p">)</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">setmode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">)</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">setmode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">)</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">setmode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">setmode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">);</span>

		<span class="cm">/* schedule next check */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">wt</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;thread exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip descriptions - defines+functions for tda9840                */</span>

<span class="cp">#define TDA9840_SW         0x00</span>
<span class="cp">#define TDA9840_LVADJ      0x02</span>
<span class="cp">#define TDA9840_STADJ      0x03</span>
<span class="cp">#define TDA9840_TEST       0x04</span>

<span class="cp">#define TDA9840_MONO       0x10</span>
<span class="cp">#define TDA9840_STEREO     0x2a</span>
<span class="cp">#define TDA9840_DUALA      0x12</span>
<span class="cp">#define TDA9840_DUALB      0x1e</span>
<span class="cp">#define TDA9840_DUALAB     0x1a</span>
<span class="cp">#define TDA9840_DUALBA     0x16</span>
<span class="cp">#define TDA9840_EXTERNAL   0x7a</span>

<span class="cp">#define TDA9840_DS_DUAL    0x20 </span><span class="cm">/* Dual sound identified          */</span><span class="cp"></span>
<span class="cp">#define TDA9840_ST_STEREO  0x40 </span><span class="cm">/* Stereo sound identified        */</span><span class="cp"></span>
<span class="cp">#define TDA9840_PONRES     0x80 </span><span class="cm">/* Power-on reset detected if = 1 */</span><span class="cp"></span>

<span class="cp">#define TDA9840_TEST_INT1SN 0x1 </span><span class="cm">/* Integration time 0.5s when set */</span><span class="cp"></span>
<span class="cp">#define TDA9840_TEST_INTFU 0x02 </span><span class="cm">/* Disables integrator function */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9840_getmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">chip_read</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TDA9840_DS_DUAL</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TDA9840_ST_STEREO</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9840_getmode(): raw chip read: %d, return: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">val</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda9840_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">t</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">TDA9840_SW</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7e</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="n">t</span> <span class="o">|=</span> <span class="n">TDA9840_MONO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
		<span class="n">t</span> <span class="o">|=</span> <span class="n">TDA9840_STEREO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
		<span class="n">t</span> <span class="o">|=</span> <span class="n">TDA9840_DUALA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
		<span class="n">t</span> <span class="o">|=</span> <span class="n">TDA9840_DUALB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9840_SW</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9840_checkit</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">chip_read</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="cm">/* lower 5 bits should be 0 */</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip descriptions - defines+functions for tda985x                */</span>

<span class="cm">/* subaddresses for TDA9855 */</span>
<span class="cp">#define TDA9855_VR	0x00 </span><span class="cm">/* Volume, right */</span><span class="cp"></span>
<span class="cp">#define TDA9855_VL	0x01 </span><span class="cm">/* Volume, left */</span><span class="cp"></span>
<span class="cp">#define TDA9855_BA	0x02 </span><span class="cm">/* Bass */</span><span class="cp"></span>
<span class="cp">#define TDA9855_TR	0x03 </span><span class="cm">/* Treble */</span><span class="cp"></span>
<span class="cp">#define TDA9855_SW	0x04 </span><span class="cm">/* Subwoofer - not connected on DTV2000 */</span><span class="cp"></span>

<span class="cm">/* subaddresses for TDA9850 */</span>
<span class="cp">#define TDA9850_C4	0x04 </span><span class="cm">/* Control 1 for TDA9850 */</span><span class="cp"></span>

<span class="cm">/* subaddesses for both chips */</span>
<span class="cp">#define TDA985x_C5	0x05 </span><span class="cm">/* Control 2 for TDA9850, Control 1 for TDA9855 */</span><span class="cp"></span>
<span class="cp">#define TDA985x_C6	0x06 </span><span class="cm">/* Control 3 for TDA9850, Control 2 for TDA9855 */</span><span class="cp"></span>
<span class="cp">#define TDA985x_C7	0x07 </span><span class="cm">/* Control 4 for TDA9850, Control 3 for TDA9855 */</span><span class="cp"></span>
<span class="cp">#define TDA985x_A1	0x08 </span><span class="cm">/* Alignment 1 for both chips */</span><span class="cp"></span>
<span class="cp">#define TDA985x_A2	0x09 </span><span class="cm">/* Alignment 2 for both chips */</span><span class="cp"></span>
<span class="cp">#define TDA985x_A3	0x0a </span><span class="cm">/* Alignment 3 for both chips */</span><span class="cp"></span>

<span class="cm">/* Masks for bits in TDA9855 subaddresses */</span>
<span class="cm">/* 0x00 - VR in TDA9855 */</span>
<span class="cm">/* 0x01 - VL in TDA9855 */</span>
<span class="cm">/* lower 7 bits control gain from -71dB (0x28) to 16dB (0x7f)</span>
<span class="cm"> * in 1dB steps - mute is 0x27 */</span>


<span class="cm">/* 0x02 - BA in TDA9855 */</span>
<span class="cm">/* lower 5 bits control bass gain from -12dB (0x06) to 16.5dB (0x19)</span>
<span class="cm"> * in .5dB steps - 0 is 0x0E */</span>


<span class="cm">/* 0x03 - TR in TDA9855 */</span>
<span class="cm">/* 4 bits &lt;&lt; 1 control treble gain from -12dB (0x3) to 12dB (0xb)</span>
<span class="cm"> * in 3dB steps - 0 is 0x7 */</span>

<span class="cm">/* Masks for bits in both chips&#39; subaddresses */</span>
<span class="cm">/* 0x04 - SW in TDA9855, C4/Control 1 in TDA9850 */</span>
<span class="cm">/* Unique to TDA9855: */</span>
<span class="cm">/* 4 bits &lt;&lt; 2 control subwoofer/surround gain from -14db (0x1) to 14db (0xf)</span>
<span class="cm"> * in 3dB steps - mute is 0x0 */</span>

<span class="cm">/* Unique to TDA9850: */</span>
<span class="cm">/* lower 4 bits control stereo noise threshold, over which stereo turns off</span>
<span class="cm"> * set to values of 0x00 through 0x0f for Ster1 through Ster16 */</span>


<span class="cm">/* 0x05 - C5 - Control 1 in TDA9855 , Control 2 in TDA9850*/</span>
<span class="cm">/* Unique to TDA9855: */</span>
<span class="cp">#define TDA9855_MUTE	1&lt;&lt;7 </span><span class="cm">/* GMU, Mute at outputs */</span><span class="cp"></span>
<span class="cp">#define TDA9855_AVL	1&lt;&lt;6 </span><span class="cm">/* AVL, Automatic Volume Level */</span><span class="cp"></span>
<span class="cp">#define TDA9855_LOUD	1&lt;&lt;5 </span><span class="cm">/* Loudness, 1==off */</span><span class="cp"></span>
<span class="cp">#define TDA9855_SUR	1&lt;&lt;3 </span><span class="cm">/* Surround / Subwoofer 1==.5(L-R) 0==.5(L+R) */</span><span class="cp"></span>
			     <span class="cm">/* Bits 0 to 3 select various combinations</span>
<span class="cm">			      * of line in and line out, only the</span>
<span class="cm">			      * interesting ones are defined */</span>
<span class="cp">#define TDA9855_EXT	1&lt;&lt;2 </span><span class="cm">/* Selects inputs LIR and LIL.  Pins 41 &amp; 12 */</span><span class="cp"></span>
<span class="cp">#define TDA9855_INT	0    </span><span class="cm">/* Selects inputs LOR and LOL.  (internal) */</span><span class="cp"></span>

<span class="cm">/* Unique to TDA9850:  */</span>
<span class="cm">/* lower 4 bits contol SAP noise threshold, over which SAP turns off</span>
<span class="cm"> * set to values of 0x00 through 0x0f for SAP1 through SAP16 */</span>


<span class="cm">/* 0x06 - C6 - Control 2 in TDA9855, Control 3 in TDA9850 */</span>
<span class="cm">/* Common to TDA9855 and TDA9850: */</span>
<span class="cp">#define TDA985x_SAP	3&lt;&lt;6 </span><span class="cm">/* Selects SAP output, mute if not received */</span><span class="cp"></span>
<span class="cp">#define TDA985x_STEREO	1&lt;&lt;6 </span><span class="cm">/* Selects Stereo ouput, mono if not received */</span><span class="cp"></span>
<span class="cp">#define TDA985x_MONO	0    </span><span class="cm">/* Forces Mono output */</span><span class="cp"></span>
<span class="cp">#define TDA985x_LMU	1&lt;&lt;3 </span><span class="cm">/* Mute (LOR/LOL for 9855, OUTL/OUTR for 9850) */</span><span class="cp"></span>

<span class="cm">/* Unique to TDA9855: */</span>
<span class="cp">#define TDA9855_TZCM	1&lt;&lt;5 </span><span class="cm">/* If set, don&#39;t mute till zero crossing */</span><span class="cp"></span>
<span class="cp">#define TDA9855_VZCM	1&lt;&lt;4 </span><span class="cm">/* If set, don&#39;t change volume till zero crossing*/</span><span class="cp"></span>
<span class="cp">#define TDA9855_LINEAR	0    </span><span class="cm">/* Linear Stereo */</span><span class="cp"></span>
<span class="cp">#define TDA9855_PSEUDO	1    </span><span class="cm">/* Pseudo Stereo */</span><span class="cp"></span>
<span class="cp">#define TDA9855_SPAT_30	2    </span><span class="cm">/* Spatial Stereo, 30% anti-phase crosstalk */</span><span class="cp"></span>
<span class="cp">#define TDA9855_SPAT_50	3    </span><span class="cm">/* Spatial Stereo, 52% anti-phase crosstalk */</span><span class="cp"></span>
<span class="cp">#define TDA9855_E_MONO	7    </span><span class="cm">/* Forced mono - mono select elseware, so useless*/</span><span class="cp"></span>

<span class="cm">/* 0x07 - C7 - Control 3 in TDA9855, Control 4 in TDA9850 */</span>
<span class="cm">/* Common to both TDA9855 and TDA9850: */</span>
<span class="cm">/* lower 4 bits control input gain from -3.5dB (0x0) to 4dB (0xF)</span>
<span class="cm"> * in .5dB steps -  0dB is 0x7 */</span>

<span class="cm">/* 0x08, 0x09 - A1 and A2 (read/write) */</span>
<span class="cm">/* Common to both TDA9855 and TDA9850: */</span>
<span class="cm">/* lower 5 bites are wideband and spectral expander alignment</span>
<span class="cm"> * from 0x00 to 0x1f - nominal at 0x0f and 0x10 (read/write) */</span>
<span class="cp">#define TDA985x_STP	1&lt;&lt;5 </span><span class="cm">/* Stereo Pilot/detect (read-only) */</span><span class="cp"></span>
<span class="cp">#define TDA985x_SAPP	1&lt;&lt;6 </span><span class="cm">/* SAP Pilot/detect (read-only) */</span><span class="cp"></span>
<span class="cp">#define TDA985x_STS	1&lt;&lt;7 </span><span class="cm">/* Stereo trigger 1= &lt;35mV 0= &lt;30mV (write-only)*/</span><span class="cp"></span>

<span class="cm">/* 0x0a - A3 */</span>
<span class="cm">/* Common to both TDA9855 and TDA9850: */</span>
<span class="cm">/* lower 3 bits control timing current for alignment: -30% (0x0), -20% (0x1),</span>
<span class="cm"> * -10% (0x2), nominal (0x3), +10% (0x6), +20% (0x5), +30% (0x4) */</span>
<span class="cp">#define TDA985x_ADJ	1&lt;&lt;7 </span><span class="cm">/* Stereo adjust on/off (wideband and spectral */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9855_volume</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">val</span><span class="o">/</span><span class="mh">0x2e8</span><span class="o">+</span><span class="mh">0x27</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9855_bass</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span>   <span class="p">{</span> <span class="k">return</span> <span class="n">val</span><span class="o">/</span><span class="mh">0xccc</span><span class="o">+</span><span class="mh">0x06</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9855_treble</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">val</span><span class="o">/</span><span class="mh">0x1c71</span><span class="o">+</span><span class="mh">0x3</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">;</span> <span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>  <span class="nf">tda985x_getmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="p">((</span><span class="n">TDA985x_STP</span> <span class="o">|</span> <span class="n">TDA985x_SAPP</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">chip_read</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="cm">/* Add mono mode regardless of SAP and stereo */</span>
	<span class="cm">/* Allows forced mono */</span>
	<span class="k">return</span> <span class="n">mode</span> <span class="o">|</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda985x_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">c6</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">TDA985x_C6</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="n">c6</span> <span class="o">|=</span> <span class="n">TDA985x_MONO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
		<span class="n">c6</span> <span class="o">|=</span> <span class="n">TDA985x_STEREO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
		<span class="n">c6</span> <span class="o">|=</span> <span class="n">TDA985x_SAP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update</span><span class="p">)</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">TDA985x_C6</span><span class="p">,</span><span class="n">c6</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip descriptions - defines+functions for tda9873h               */</span>

<span class="cm">/* Subaddresses for TDA9873H */</span>

<span class="cp">#define TDA9873_SW	0x00 </span><span class="cm">/* Switching                    */</span><span class="cp"></span>
<span class="cp">#define TDA9873_AD	0x01 </span><span class="cm">/* Adjust                       */</span><span class="cp"></span>
<span class="cp">#define TDA9873_PT	0x02 </span><span class="cm">/* Port                         */</span><span class="cp"></span>

<span class="cm">/* Subaddress 0x00: Switching Data</span>
<span class="cm"> * B7..B0:</span>
<span class="cm"> *</span>
<span class="cm"> * B1, B0: Input source selection</span>
<span class="cm"> *  0,  0  internal</span>
<span class="cm"> *  1,  0  external stereo</span>
<span class="cm"> *  0,  1  external mono</span>
<span class="cm"> */</span>
<span class="cp">#define TDA9873_INP_MASK    3</span>
<span class="cp">#define TDA9873_INTERNAL    0</span>
<span class="cp">#define TDA9873_EXT_STEREO  2</span>
<span class="cp">#define TDA9873_EXT_MONO    1</span>

<span class="cm">/*    B3, B2: output signal select</span>
<span class="cm"> * B4    : transmission mode</span>
<span class="cm"> *  0, 0, 1   Mono</span>
<span class="cm"> *  1, 0, 0   Stereo</span>
<span class="cm"> *  1, 1, 1   Stereo (reversed channel)</span>
<span class="cm"> *  0, 0, 0   Dual AB</span>
<span class="cm"> *  0, 0, 1   Dual AA</span>
<span class="cm"> *  0, 1, 0   Dual BB</span>
<span class="cm"> *  0, 1, 1   Dual BA</span>
<span class="cm"> */</span>

<span class="cp">#define TDA9873_TR_MASK     (7 &lt;&lt; 2)</span>
<span class="cp">#define TDA9873_TR_MONO     4</span>
<span class="cp">#define TDA9873_TR_STEREO   1 &lt;&lt; 4</span>
<span class="cp">#define TDA9873_TR_REVERSE  (1 &lt;&lt; 3) &amp; (1 &lt;&lt; 2)</span>
<span class="cp">#define TDA9873_TR_DUALA    1 &lt;&lt; 2</span>
<span class="cp">#define TDA9873_TR_DUALB    1 &lt;&lt; 3</span>

<span class="cm">/* output level controls</span>
<span class="cm"> * B5:  output level switch (0 = reduced gain, 1 = normal gain)</span>
<span class="cm"> * B6:  mute                (1 = muted)</span>
<span class="cm"> * B7:  auto-mute           (1 = auto-mute enabled)</span>
<span class="cm"> */</span>

<span class="cp">#define TDA9873_GAIN_NORMAL 1 &lt;&lt; 5</span>
<span class="cp">#define TDA9873_MUTE        1 &lt;&lt; 6</span>
<span class="cp">#define TDA9873_AUTOMUTE    1 &lt;&lt; 7</span>

<span class="cm">/* Subaddress 0x01:  Adjust/standard */</span>

<span class="cm">/* Lower 4 bits (C3..C0) control stereo adjustment on R channel (-0.6 - +0.7 dB)</span>
<span class="cm"> * Recommended value is +0 dB</span>
<span class="cm"> */</span>

<span class="cp">#define	TDA9873_STEREO_ADJ	0x06 </span><span class="cm">/* 0dB gain */</span><span class="cp"></span>

<span class="cm">/* Bits C6..C4 control FM stantard</span>
<span class="cm"> * C6, C5, C4</span>
<span class="cm"> *  0,  0,  0   B/G (PAL FM)</span>
<span class="cm"> *  0,  0,  1   M</span>
<span class="cm"> *  0,  1,  0   D/K(1)</span>
<span class="cm"> *  0,  1,  1   D/K(2)</span>
<span class="cm"> *  1,  0,  0   D/K(3)</span>
<span class="cm"> *  1,  0,  1   I</span>
<span class="cm"> */</span>
<span class="cp">#define TDA9873_BG		0</span>
<span class="cp">#define TDA9873_M       1</span>
<span class="cp">#define TDA9873_DK1     2</span>
<span class="cp">#define TDA9873_DK2     3</span>
<span class="cp">#define TDA9873_DK3     4</span>
<span class="cp">#define TDA9873_I       5</span>

<span class="cm">/* C7 controls identification response time (1=fast/0=normal)</span>
<span class="cm"> */</span>
<span class="cp">#define TDA9873_IDR_NORM 0</span>
<span class="cp">#define TDA9873_IDR_FAST 1 &lt;&lt; 7</span>


<span class="cm">/* Subaddress 0x02: Port data */</span>

<span class="cm">/* E1, E0   free programmable ports P1/P2</span>
<span class="cm">    0,  0   both ports low</span>
<span class="cm">    0,  1   P1 high</span>
<span class="cm">    1,  0   P2 high</span>
<span class="cm">    1,  1   both ports high</span>
<span class="cm">*/</span>

<span class="cp">#define TDA9873_PORTS    3</span>

<span class="cm">/* E2: test port */</span>
<span class="cp">#define TDA9873_TST_PORT 1 &lt;&lt; 2</span>

<span class="cm">/* E5..E3 control mono output channel (together with transmission mode bit B4)</span>
<span class="cm"> *</span>
<span class="cm"> * E5 E4 E3 B4     OUTM</span>
<span class="cm"> *  0  0  0  0     mono</span>
<span class="cm"> *  0  0  1  0     DUAL B</span>
<span class="cm"> *  0  1  0  1     mono (from stereo decoder)</span>
<span class="cm"> */</span>
<span class="cp">#define TDA9873_MOUT_MONO   0</span>
<span class="cp">#define TDA9873_MOUT_FMONO  0</span>
<span class="cp">#define TDA9873_MOUT_DUALA  0</span>
<span class="cp">#define TDA9873_MOUT_DUALB  1 &lt;&lt; 3</span>
<span class="cp">#define TDA9873_MOUT_ST     1 &lt;&lt; 4</span>
<span class="cp">#define TDA9873_MOUT_EXTM   (1 &lt;&lt; 4 ) &amp; (1 &lt;&lt; 3)</span>
<span class="cp">#define TDA9873_MOUT_EXTL   1 &lt;&lt; 5</span>
<span class="cp">#define TDA9873_MOUT_EXTR   (1 &lt;&lt; 5 ) &amp; (1 &lt;&lt; 3)</span>
<span class="cp">#define TDA9873_MOUT_EXTLR  (1 &lt;&lt; 5 ) &amp; (1 &lt;&lt; 4)</span>
<span class="cp">#define TDA9873_MOUT_MUTE   (1 &lt;&lt; 5 ) &amp; (1 &lt;&lt; 4) &amp; (1 &lt;&lt; 3)</span>

<span class="cm">/* Status bits: (chip read) */</span>
<span class="cp">#define TDA9873_PONR        0 </span><span class="cm">/* Power-on reset detected if = 1 */</span><span class="cp"></span>
<span class="cp">#define TDA9873_STEREO      2 </span><span class="cm">/* Stereo sound is identified     */</span><span class="cp"></span>
<span class="cp">#define TDA9873_DUAL        4 </span><span class="cm">/* Dual sound is identified       */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9873_getmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span><span class="n">mode</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">chip_read</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TDA9873_STEREO</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TDA9873_DUAL</span><span class="p">)</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">;</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9873_getmode(): raw chip read: %d, return: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">val</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda9873_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sw_data</span>  <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">TDA9873_SW</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span> <span class="n">TDA9873_TR_MASK</span><span class="p">;</span>
	<span class="cm">/*	int adj_data = chip-&gt;shadow.bytes[TDA9873_AD+1] ; */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sw_data</span> <span class="o">&amp;</span> <span class="n">TDA9873_INP_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">TDA9873_INTERNAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9873_setmode(): external input</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9873_setmode(): chip-&gt;shadow.bytes[%d] = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">TDA9873_SW</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">TDA9873_SW</span><span class="o">+</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9873_setmode(): sw_data  = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sw_data</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="n">sw_data</span> <span class="o">|=</span> <span class="n">TDA9873_TR_MONO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
		<span class="n">sw_data</span> <span class="o">|=</span> <span class="n">TDA9873_TR_STEREO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
		<span class="n">sw_data</span> <span class="o">|=</span> <span class="n">TDA9873_TR_DUALA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
		<span class="n">sw_data</span> <span class="o">|=</span> <span class="n">TDA9873_TR_DUALB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9873_SW</span><span class="p">,</span> <span class="n">sw_data</span><span class="p">);</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9873_setmode(): req. mode %d; chip_write: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">mode</span><span class="p">,</span> <span class="n">sw_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9873_checkit</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="n">rc</span> <span class="o">=</span> <span class="n">chip_read2</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="mi">254</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x80</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip description - defines+functions for tda9874h and tda9874a   */</span>
<span class="cm">/* Dariusz Kowalewski &lt;darekk@automex.pl&gt;                                 */</span>

<span class="cm">/* Subaddresses for TDA9874H and TDA9874A (slave rx) */</span>
<span class="cp">#define TDA9874A_AGCGR		0x00	</span><span class="cm">/* AGC gain */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_GCONR		0x01	</span><span class="cm">/* general config */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_MSR		0x02	</span><span class="cm">/* monitor select */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_C1FRA		0x03	</span><span class="cm">/* carrier 1 freq. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_C1FRB		0x04	</span><span class="cm">/* carrier 1 freq. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_C1FRC		0x05	</span><span class="cm">/* carrier 1 freq. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_C2FRA		0x06	</span><span class="cm">/* carrier 2 freq. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_C2FRB		0x07	</span><span class="cm">/* carrier 2 freq. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_C2FRC		0x08	</span><span class="cm">/* carrier 2 freq. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_DCR		0x09	</span><span class="cm">/* demodulator config */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_FMER		0x0a	</span><span class="cm">/* FM de-emphasis */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_FMMR		0x0b	</span><span class="cm">/* FM dematrix */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_C1OLAR		0x0c	</span><span class="cm">/* ch.1 output level adj. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_C2OLAR		0x0d	</span><span class="cm">/* ch.2 output level adj. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_NCONR		0x0e	</span><span class="cm">/* NICAM config */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_NOLAR		0x0f	</span><span class="cm">/* NICAM output level adj. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_NLELR		0x10	</span><span class="cm">/* NICAM lower error limit */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_NUELR		0x11	</span><span class="cm">/* NICAM upper error limit */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_AMCONR		0x12	</span><span class="cm">/* audio mute control */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_SDACOSR	0x13	</span><span class="cm">/* stereo DAC output select */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_AOSR		0x14	</span><span class="cm">/* analog output select */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_DAICONR	0x15	</span><span class="cm">/* digital audio interface config */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_I2SOSR		0x16	</span><span class="cm">/* I2S-bus output select */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_I2SOLAR	0x17	</span><span class="cm">/* I2S-bus output level adj. */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_MDACOSR	0x18	</span><span class="cm">/* mono DAC output select (tda9874a) */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_ESP		0xFF	</span><span class="cm">/* easy standard progr. (tda9874a) */</span><span class="cp"></span>

<span class="cm">/* Subaddresses for TDA9874H and TDA9874A (slave tx) */</span>
<span class="cp">#define TDA9874A_DSR		0x00	</span><span class="cm">/* device status */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_NSR		0x01	</span><span class="cm">/* NICAM status */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_NECR		0x02	</span><span class="cm">/* NICAM error count */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_DR1		0x03	</span><span class="cm">/* add. data LSB */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_DR2		0x04	</span><span class="cm">/* add. data MSB */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_LLRA		0x05	</span><span class="cm">/* monitor level read-out LSB */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_LLRB		0x06	</span><span class="cm">/* monitor level read-out MSB */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_SIFLR		0x07	</span><span class="cm">/* SIF level */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_TR2		252	</span><span class="cm">/* test reg. 2 */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_TR1		253	</span><span class="cm">/* test reg. 1 */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_DIC		254	</span><span class="cm">/* device id. code */</span><span class="cp"></span>
<span class="cp">#define TDA9874A_SIC		255	</span><span class="cm">/* software id. code */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9874a_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* 0: A2, 1: NICAM */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9874a_GCONR</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>	<span class="cm">/* default config. input pin: SIFSEL=0 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9874a_NCONR</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* default NICAM config.: AMSEL=0,AMUTE=1 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9874a_ESP</span> <span class="o">=</span> <span class="mh">0x07</span><span class="p">;</span>		<span class="cm">/* default standard: NICAM D/K */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9874a_dic</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>		<span class="cm">/* device id. code */</span>

<span class="cm">/* insmod options for tda9874a */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tda9874a_SIF</span>   <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tda9874a_AMSEL</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tda9874a_STD</span>   <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tda9874a_SIF</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tda9874a_AMSEL</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tda9874a_STD</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * initialization table for tda9874 decoder:</span>
<span class="cm"> *  - carrier 1 freq. registers (3 bytes)</span>
<span class="cm"> *  - carrier 2 freq. registers (3 bytes)</span>
<span class="cm"> *  - demudulator config register</span>
<span class="cm"> *  - FM de-emphasis register (slow identification mode)</span>
<span class="cm"> * Note: frequency registers must be written in single i2c transfer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">tda9874a_MODES</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">audiocmd</span> <span class="n">cmd</span><span class="p">;</span>
<span class="p">}</span> <span class="n">tda9874a_modelist</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
  <span class="p">{</span>	<span class="s">&quot;A2, B/G&quot;</span><span class="p">,</span> <span class="cm">/* default */</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9874A_C1FRA</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span><span class="mh">0x95</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span><span class="mh">0xA0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span> <span class="p">}}</span> <span class="p">},</span>
  <span class="p">{</span>	<span class="s">&quot;A2, M (Korea)&quot;</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9874A_C1FRA</span><span class="p">,</span> <span class="mh">0x5D</span><span class="p">,</span><span class="mh">0xC0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x62</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span><span class="mh">0x22</span> <span class="p">}}</span> <span class="p">},</span>
  <span class="p">{</span>	<span class="s">&quot;A2, D/K (1)&quot;</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9874A_C1FRA</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">,</span><span class="mh">0x60</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span> <span class="p">}}</span> <span class="p">},</span>
  <span class="p">{</span>	<span class="s">&quot;A2, D/K (2)&quot;</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9874A_C1FRA</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span><span class="mh">0x75</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span> <span class="p">}}</span> <span class="p">},</span>
  <span class="p">{</span>	<span class="s">&quot;A2, D/K (3)&quot;</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9874A_C1FRA</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x77</span><span class="p">,</span><span class="mh">0xA0</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span> <span class="p">}}</span> <span class="p">},</span>
  <span class="p">{</span>	<span class="s">&quot;NICAM, I&quot;</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9874A_C1FRA</span><span class="p">,</span> <span class="mh">0x7D</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span><span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span><span class="mh">0x8A</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span><span class="mh">0x33</span> <span class="p">}}</span> <span class="p">},</span>
  <span class="p">{</span>	<span class="s">&quot;NICAM, B/G&quot;</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9874A_C1FRA</span><span class="p">,</span> <span class="mh">0x72</span><span class="p">,</span><span class="mh">0x95</span><span class="p">,</span><span class="mh">0x55</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span><span class="mh">0xEA</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span><span class="mh">0x33</span> <span class="p">}}</span> <span class="p">},</span>
  <span class="p">{</span>	<span class="s">&quot;NICAM, D/K&quot;</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9874A_C1FRA</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span><span class="mh">0xEA</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span><span class="mh">0x33</span> <span class="p">}}</span> <span class="p">},</span>
  <span class="p">{</span>	<span class="s">&quot;NICAM, L&quot;</span><span class="p">,</span>
	<span class="p">{</span> <span class="mi">9</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9874A_C1FRA</span><span class="p">,</span> <span class="mh">0x87</span><span class="p">,</span><span class="mh">0x6A</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x79</span><span class="p">,</span><span class="mh">0xEA</span><span class="p">,</span><span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span><span class="mh">0x33</span> <span class="p">}}</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9874a_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>

	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_AGCGR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* 0 dB */</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_GCONR</span><span class="p">,</span> <span class="n">tda9874a_GCONR</span><span class="p">);</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_MSR</span><span class="p">,</span> <span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x03</span><span class="o">:</span><span class="mh">0x02</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tda9874a_dic</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_FMMR</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* dic == 0x07 */</span>
		<span class="n">chip_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="s">&quot;tda9874_modelist&quot;</span><span class="p">,</span><span class="o">&amp;</span><span class="n">tda9874a_modelist</span><span class="p">[</span><span class="n">tda9874a_STD</span><span class="p">].</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_FMMR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_C1OLAR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* 0 dB */</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_C2OLAR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* 0 dB */</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_NCONR</span><span class="p">,</span> <span class="n">tda9874a_NCONR</span><span class="p">);</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_NOLAR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* 0 dB */</span>
	<span class="cm">/* Note: If signal quality is poor you may want to change NICAM */</span>
	<span class="cm">/* error limit registers (NLELR and NUELR) to some greater values. */</span>
	<span class="cm">/* Then the sound would remain stereo, but won&#39;t be so clear. */</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_NLELR</span><span class="p">,</span> <span class="mh">0x14</span><span class="p">);</span> <span class="cm">/* default */</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_NUELR</span><span class="p">,</span> <span class="mh">0x50</span><span class="p">);</span> <span class="cm">/* default */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tda9874a_dic</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_AMCONR</span><span class="p">,</span> <span class="mh">0xf9</span><span class="p">);</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_SDACOSR</span><span class="p">,</span> <span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x81</span><span class="o">:</span><span class="mh">0x80</span><span class="p">);</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_AOSR</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_MDACOSR</span><span class="p">,</span> <span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x82</span><span class="o">:</span><span class="mh">0x80</span><span class="p">);</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_ESP</span><span class="p">,</span> <span class="n">tda9874a_ESP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* dic == 0x07 */</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_AMCONR</span><span class="p">,</span> <span class="mh">0xfb</span><span class="p">);</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_SDACOSR</span><span class="p">,</span> <span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x81</span><span class="o">:</span><span class="mh">0x80</span><span class="p">);</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_AOSR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* or 0x10 */</span>
	<span class="p">}</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9874a_setup(): %s [0x%02X].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">tda9874a_modelist</span><span class="p">[</span><span class="n">tda9874a_STD</span><span class="p">].</span><span class="n">name</span><span class="p">,</span><span class="n">tda9874a_STD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9874a_getmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsr</span><span class="p">,</span><span class="n">nsr</span><span class="p">,</span><span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">necr</span><span class="p">;</span> <span class="cm">/* just for debugging */</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="n">dsr</span> <span class="o">=</span> <span class="n">chip_read2</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">TDA9874A_DSR</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="n">nsr</span> <span class="o">=</span> <span class="n">chip_read2</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">TDA9874A_NSR</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="n">necr</span> <span class="o">=</span> <span class="n">chip_read2</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">TDA9874A_NECR</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>

	<span class="cm">/* need to store dsr/nsr somewhere */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">MAXREGS</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dsr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">MAXREGS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nsr</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Note: DSR.RSSF and DSR.AMSTAT bits are also checked.</span>
<span class="cm">		 * If NICAM auto-muting is enabled, DSR.AMSTAT=1 indicates</span>
<span class="cm">		 * that sound has (temporarily) switched from NICAM to</span>
<span class="cm">		 * mono FM (or AM) on 1st sound carrier due to high NICAM bit</span>
<span class="cm">		 * error count. So in fact there is no stereo in this case :-(</span>
<span class="cm">		 * But changing the mode to V4L2_TUNER_MODE_MONO would switch</span>
<span class="cm">		 * external 4052 multiplexer in audio_hook().</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">nsr</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="cm">/* NSR.S/MB=1 */</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">nsr</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="cm">/* NSR.D/SB=1 */</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">dsr</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="cm">/* DSR.IDSTE=1 */</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">dsr</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="cm">/* DSR.IDDUA=1 */</span>
			<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9874a_getmode(): DSR=0x%X, NSR=0x%X, NECR=0x%X, return: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">dsr</span><span class="p">,</span> <span class="n">nsr</span><span class="p">,</span> <span class="n">necr</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda9874a_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>

	<span class="cm">/* Disable/enable NICAM auto-muting (based on DSR.RSSF status bit). */</span>
	<span class="cm">/* If auto-muting is disabled, we can hear a signal of degrading quality. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">MAXREGS</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="cm">/* DSR.RSSF=1 */</span>
			<span class="n">tda9874a_NCONR</span> <span class="o">&amp;=</span> <span class="mh">0xfe</span><span class="p">;</span> <span class="cm">/* enable */</span>
		<span class="k">else</span>
			<span class="n">tda9874a_NCONR</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* disable */</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_NCONR</span><span class="p">,</span> <span class="n">tda9874a_NCONR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Note: TDA9874A supports automatic FM dematrixing (FMMR register)</span>
<span class="cm">	 * and has auto-select function for audio output (AOSR register).</span>
<span class="cm">	 * Old TDA9874H doesn&#39;t support these features.</span>
<span class="cm">	 * TDA9874A also has additional mono output pin (OUTM), which</span>
<span class="cm">	 * on same (all?) tv-cards is not used, anyway (as well as MONOIN).</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tda9874a_dic</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">aosr</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mdacosr</span> <span class="o">=</span> <span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x82</span><span class="o">:</span><span class="mh">0x80</span><span class="p">;</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
			<span class="n">aosr</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">;</span> <span class="cm">/* auto-select, dual A/A */</span>
			<span class="n">mdacosr</span> <span class="o">=</span> <span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x82</span><span class="o">:</span><span class="mh">0x80</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
			<span class="n">aosr</span> <span class="o">=</span> <span class="mh">0xa0</span><span class="p">;</span> <span class="cm">/* auto-select, dual B/B */</span>
			<span class="n">mdacosr</span> <span class="o">=</span> <span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x83</span><span class="o">:</span><span class="mh">0x81</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_AOSR</span><span class="p">,</span> <span class="n">aosr</span><span class="p">);</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_MDACOSR</span><span class="p">,</span> <span class="n">mdacosr</span><span class="p">);</span>

		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9874a_setmode(): req. mode %d; AOSR=0x%X, MDACOSR=0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mode</span><span class="p">,</span> <span class="n">aosr</span><span class="p">,</span> <span class="n">mdacosr</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* dic == 0x07 */</span>
		<span class="kt">int</span> <span class="n">fmmr</span><span class="p">,</span><span class="n">aosr</span><span class="p">;</span>

		<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
			<span class="n">fmmr</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* mono */</span>
			<span class="n">aosr</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* A/A */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
			<span class="k">if</span><span class="p">(</span><span class="n">tda9874a_mode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">fmmr</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
				<span class="n">aosr</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="cm">/* handled by NICAM auto-mute */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">fmmr</span> <span class="o">=</span> <span class="p">(</span><span class="n">tda9874a_ESP</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x05</span> <span class="o">:</span> <span class="mh">0x04</span><span class="p">;</span> <span class="cm">/* stereo */</span>
				<span class="n">aosr</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
			<span class="n">fmmr</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* dual */</span>
			<span class="n">aosr</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span> <span class="cm">/* dual A/A */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
			<span class="n">fmmr</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* dual */</span>
			<span class="n">aosr</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span> <span class="cm">/* dual B/B */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_FMMR</span><span class="p">,</span> <span class="n">fmmr</span><span class="p">);</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9874A_AOSR</span><span class="p">,</span> <span class="n">aosr</span><span class="p">);</span>

		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9874a_setmode(): req. mode %d; FMMR=0x%X, AOSR=0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mode</span><span class="p">,</span> <span class="n">fmmr</span><span class="p">,</span> <span class="n">aosr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9874a_checkit</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dic</span><span class="p">,</span><span class="n">sic</span><span class="p">;</span>	<span class="cm">/* device id. and software id. codes */</span>

	<span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="n">dic</span> <span class="o">=</span> <span class="n">chip_read2</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">TDA9874A_DIC</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">==</span> <span class="p">(</span><span class="n">sic</span> <span class="o">=</span> <span class="n">chip_read2</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">TDA9874A_SIC</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;tda9874a_checkit(): DIC=0x%X, SIC=0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dic</span><span class="p">,</span> <span class="n">sic</span><span class="p">);</span>

	<span class="k">if</span><span class="p">((</span><span class="n">dic</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">dic</span> <span class="o">==</span> <span class="mh">0x07</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;found tda9874%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">dic</span> <span class="o">==</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;a&quot;</span> <span class="o">:</span> <span class="s">&quot;h&quot;</span><span class="p">);</span>
		<span class="n">tda9874a_dic</span> <span class="o">=</span> <span class="n">dic</span><span class="p">;</span>	<span class="cm">/* remember device id. */</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* not found */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9874a_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda9874a_SIF</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">tda9874a_SIF</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tda9874a_STD</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tda9874a_modelist</span><span class="p">))</span>
		<span class="n">tda9874a_STD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span><span class="n">tda9874a_AMSEL</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tda9874a_AMSEL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tda9874a_SIF</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">tda9874a_GCONR</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">;</span>	<span class="cm">/* sound IF input 1 */</span>
	<span class="k">else</span>
		<span class="n">tda9874a_GCONR</span> <span class="o">=</span> <span class="mh">0xc1</span><span class="p">;</span>	<span class="cm">/* sound IF input 2 */</span>

	<span class="n">tda9874a_ESP</span> <span class="o">=</span> <span class="n">tda9874a_STD</span><span class="p">;</span>
	<span class="n">tda9874a_mode</span> <span class="o">=</span> <span class="p">(</span><span class="n">tda9874a_STD</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">tda9874a_AMSEL</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">tda9874a_NCONR</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span> <span class="cm">/* auto-mute: analog mono input */</span>
	<span class="k">else</span>
		<span class="n">tda9874a_NCONR</span> <span class="o">=</span> <span class="mh">0x05</span><span class="p">;</span> <span class="cm">/* auto-mute: 1st carrier FM or AM */</span>

	<span class="n">tda9874a_setup</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip description - defines+functions for tda9875                 */</span>
<span class="cm">/* The TDA9875 is made by Philips Semiconductor</span>
<span class="cm"> * http://www.semiconductors.philips.com</span>
<span class="cm"> * TDA9875: I2C-bus controlled DSP audio processor, FM demodulator</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* subaddresses for TDA9875 */</span>
<span class="cp">#define TDA9875_MUT         0x12  </span><span class="cm">/*General mute  (value --&gt; 0b11001100*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_CFG         0x01  </span><span class="cm">/* Config register (value --&gt; 0b00000000 */</span><span class="cp"></span>
<span class="cp">#define TDA9875_DACOS       0x13  </span><span class="cm">/*DAC i/o select (ADC) 0b0000100*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_LOSR        0x16  </span><span class="cm">/*Line output select regirter 0b0100 0001*/</span><span class="cp"></span>

<span class="cp">#define TDA9875_CH1V        0x0c  </span><span class="cm">/*Channel 1 volume (mute)*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_CH2V        0x0d  </span><span class="cm">/*Channel 2 volume (mute)*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_SC1         0x14  </span><span class="cm">/*SCART 1 in (mono)*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_SC2         0x15  </span><span class="cm">/*SCART 2 in (mono)*/</span><span class="cp"></span>

<span class="cp">#define TDA9875_ADCIS       0x17  </span><span class="cm">/*ADC input select (mono) 0b0110 000*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_AER         0x19  </span><span class="cm">/*Audio effect (AVL+Pseudo) 0b0000 0110*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_MCS         0x18  </span><span class="cm">/*Main channel select (DAC) 0b0000100*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_MVL         0x1a  </span><span class="cm">/* Main volume gauche */</span><span class="cp"></span>
<span class="cp">#define TDA9875_MVR         0x1b  </span><span class="cm">/* Main volume droite */</span><span class="cp"></span>
<span class="cp">#define TDA9875_MBA         0x1d  </span><span class="cm">/* Main Basse */</span><span class="cp"></span>
<span class="cp">#define TDA9875_MTR         0x1e  </span><span class="cm">/* Main treble */</span><span class="cp"></span>
<span class="cp">#define TDA9875_ACS         0x1f  </span><span class="cm">/* Auxiliary channel select (FM) 0b0000000*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_AVL         0x20  </span><span class="cm">/* Auxiliary volume gauche */</span><span class="cp"></span>
<span class="cp">#define TDA9875_AVR         0x21  </span><span class="cm">/* Auxiliary volume droite */</span><span class="cp"></span>
<span class="cp">#define TDA9875_ABA         0x22  </span><span class="cm">/* Auxiliary Basse */</span><span class="cp"></span>
<span class="cp">#define TDA9875_ATR         0x23  </span><span class="cm">/* Auxiliary treble */</span><span class="cp"></span>

<span class="cp">#define TDA9875_MSR         0x02  </span><span class="cm">/* Monitor select register */</span><span class="cp"></span>
<span class="cp">#define TDA9875_C1MSB       0x03  </span><span class="cm">/* Carrier 1 (FM) frequency register MSB */</span><span class="cp"></span>
<span class="cp">#define TDA9875_C1MIB       0x04  </span><span class="cm">/* Carrier 1 (FM) frequency register (16-8]b */</span><span class="cp"></span>
<span class="cp">#define TDA9875_C1LSB       0x05  </span><span class="cm">/* Carrier 1 (FM) frequency register LSB */</span><span class="cp"></span>
<span class="cp">#define TDA9875_C2MSB       0x06  </span><span class="cm">/* Carrier 2 (nicam) frequency register MSB */</span><span class="cp"></span>
<span class="cp">#define TDA9875_C2MIB       0x07  </span><span class="cm">/* Carrier 2 (nicam) frequency register (16-8]b */</span><span class="cp"></span>
<span class="cp">#define TDA9875_C2LSB       0x08  </span><span class="cm">/* Carrier 2 (nicam) frequency register LSB */</span><span class="cp"></span>
<span class="cp">#define TDA9875_DCR         0x09  </span><span class="cm">/* Demodulateur configuration regirter*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_DEEM        0x0a  </span><span class="cm">/* FM de-emphasis regirter*/</span><span class="cp"></span>
<span class="cp">#define TDA9875_FMAT        0x0b  </span><span class="cm">/* FM Matrix regirter*/</span><span class="cp"></span>

<span class="cm">/* values */</span>
<span class="cp">#define TDA9875_MUTE_ON	    0xff </span><span class="cm">/* general mute */</span><span class="cp"></span>
<span class="cp">#define TDA9875_MUTE_OFF    0xcc </span><span class="cm">/* general no mute */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9875_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_CFG</span><span class="p">,</span> <span class="mh">0xd0</span><span class="p">);</span> <span class="cm">/*reg de config 0 (reset)*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_MSR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>    <span class="cm">/* Monitor 0b00000XXX*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_C1MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="cm">/*Car1(FM) MSB XMHz*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_C1MIB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="cm">/*Car1(FM) MIB XMHz*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_C1LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="cm">/*Car1(FM) LSB XMHz*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_C2MSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="cm">/*Car2(NICAM) MSB XMHz*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_C2MIB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="cm">/*Car2(NICAM) MIB XMHz*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_C2LSB</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="cm">/*Car2(NICAM) LSB XMHz*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_DCR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>    <span class="cm">/*Demod config 0x00*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_DEEM</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>   <span class="cm">/*DE-Emph 0b0100 0100*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_FMAT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>   <span class="cm">/*FM Matrix reg 0x00*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_SC1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>    <span class="cm">/* SCART 1 (SC1)*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_SC2</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>    <span class="cm">/* SCART 2 (sc2)*/</span>

	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_CH1V</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>  <span class="cm">/* Channel volume 1 mute*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_CH2V</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>  <span class="cm">/* Channel volume 2 mute */</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_DACOS</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span> <span class="cm">/* sig DAC i/o(in:nicam)*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_ADCIS</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">);</span> <span class="cm">/* sig ADC input(in:mono)*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_LOSR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>  <span class="cm">/* line out (in:mono)*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_AER</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>   <span class="cm">/*06 Effect (AVL+PSEUDO) */</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_MCS</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>   <span class="cm">/* Main ch select (DAC) */</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_MVL</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>   <span class="cm">/* Vol Main left 10dB */</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_MVR</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>   <span class="cm">/* Vol Main right 10dB*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_MBA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>   <span class="cm">/* Main Bass Main 0dB*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_MTR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>   <span class="cm">/* Main Treble Main 0dB*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_ACS</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>   <span class="cm">/* Aux chan select (dac)*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_AVL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>   <span class="cm">/* Vol Aux left 0dB*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_AVR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>   <span class="cm">/* Vol Aux right 0dB*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_ABA</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>   <span class="cm">/* Aux Bass Main 0dB*/</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_ATR</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>   <span class="cm">/* Aux Aigus Main 0dB*/</span>

	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TDA9875_MUT</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">);</span>   <span class="cm">/* General mute  */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9875_volume</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">val</span> <span class="o">/</span> <span class="mi">602</span> <span class="o">-</span> <span class="mi">84</span><span class="p">);</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9875_bass</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">max</span><span class="p">(</span><span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="n">val</span> <span class="o">/</span> <span class="mi">2115</span> <span class="o">-</span> <span class="mi">15</span><span class="p">));</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9875_treble</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">val</span> <span class="o">/</span> <span class="mi">2622</span> <span class="o">-</span> <span class="mi">12</span><span class="p">);</span> <span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>


<span class="cm">/* *********************** *</span>
<span class="cm"> * i2c interface functions *</span>
<span class="cm"> * *********************** */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda9875_checkit</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dic</span><span class="p">,</span> <span class="n">rev</span><span class="p">;</span>

	<span class="n">dic</span> <span class="o">=</span> <span class="n">chip_read2</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">254</span><span class="p">);</span>
	<span class="n">rev</span> <span class="o">=</span> <span class="n">chip_read2</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mi">255</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dic</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">dic</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* tda9875 and tda9875A */</span>
		<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;found tda9875%s rev. %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dic</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;A&quot;</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip descriptions - defines+functions for tea6420                */</span>

<span class="cp">#define TEA6300_VL         0x00  </span><span class="cm">/* volume left */</span><span class="cp"></span>
<span class="cp">#define TEA6300_VR         0x01  </span><span class="cm">/* volume right */</span><span class="cp"></span>
<span class="cp">#define TEA6300_BA         0x02  </span><span class="cm">/* bass */</span><span class="cp"></span>
<span class="cp">#define TEA6300_TR         0x03  </span><span class="cm">/* treble */</span><span class="cp"></span>
<span class="cp">#define TEA6300_FA         0x04  </span><span class="cm">/* fader control */</span><span class="cp"></span>
<span class="cp">#define TEA6300_S          0x05  </span><span class="cm">/* switch register */</span><span class="cp"></span>
				 <span class="cm">/* values for those registers: */</span>
<span class="cp">#define TEA6300_S_SA       0x01  </span><span class="cm">/* stereo A input */</span><span class="cp"></span>
<span class="cp">#define TEA6300_S_SB       0x02  </span><span class="cm">/* stereo B */</span><span class="cp"></span>
<span class="cp">#define TEA6300_S_SC       0x04  </span><span class="cm">/* stereo C */</span><span class="cp"></span>
<span class="cp">#define TEA6300_S_GMU      0x80  </span><span class="cm">/* general mute */</span><span class="cp"></span>

<span class="cp">#define TEA6320_V          0x00  </span><span class="cm">/* volume (0-5)/loudness off (6)/zero crossing mute(7) */</span><span class="cp"></span>
<span class="cp">#define TEA6320_FFR        0x01  </span><span class="cm">/* fader front right (0-5) */</span><span class="cp"></span>
<span class="cp">#define TEA6320_FFL        0x02  </span><span class="cm">/* fader front left (0-5) */</span><span class="cp"></span>
<span class="cp">#define TEA6320_FRR        0x03  </span><span class="cm">/* fader rear right (0-5) */</span><span class="cp"></span>
<span class="cp">#define TEA6320_FRL        0x04  </span><span class="cm">/* fader rear left (0-5) */</span><span class="cp"></span>
<span class="cp">#define TEA6320_BA         0x05  </span><span class="cm">/* bass (0-4) */</span><span class="cp"></span>
<span class="cp">#define TEA6320_TR         0x06  </span><span class="cm">/* treble (0-4) */</span><span class="cp"></span>
<span class="cp">#define TEA6320_S          0x07  </span><span class="cm">/* switch register */</span><span class="cp"></span>
				 <span class="cm">/* values for those registers: */</span>
<span class="cp">#define TEA6320_S_SA       0x07  </span><span class="cm">/* stereo A input */</span><span class="cp"></span>
<span class="cp">#define TEA6320_S_SB       0x06  </span><span class="cm">/* stereo B */</span><span class="cp"></span>
<span class="cp">#define TEA6320_S_SC       0x05  </span><span class="cm">/* stereo C */</span><span class="cp"></span>
<span class="cp">#define TEA6320_S_SD       0x04  </span><span class="cm">/* stereo D */</span><span class="cp"></span>
<span class="cp">#define TEA6320_S_GMU      0x80  </span><span class="cm">/* general mute */</span><span class="cp"></span>

<span class="cp">#define TEA6420_S_SA       0x00  </span><span class="cm">/* stereo A input */</span><span class="cp"></span>
<span class="cp">#define TEA6420_S_SB       0x01  </span><span class="cm">/* stereo B */</span><span class="cp"></span>
<span class="cp">#define TEA6420_S_SC       0x02  </span><span class="cm">/* stereo C */</span><span class="cp"></span>
<span class="cp">#define TEA6420_S_SD       0x03  </span><span class="cm">/* stereo D */</span><span class="cp"></span>
<span class="cp">#define TEA6420_S_SE       0x04  </span><span class="cm">/* stereo E */</span><span class="cp"></span>
<span class="cp">#define TEA6420_S_GMU      0x05  </span><span class="cm">/* general mute */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tea6300_shift10</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tea6300_shift12</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span> <span class="p">}</span>

<span class="cm">/* Assumes 16bit input (values 0x3f to 0x0c are unique, values less than */</span>
<span class="cm">/* 0x0c mirror those immediately higher) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tea6320_volume</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">/</span> <span class="p">(</span><span class="mi">65535</span><span class="o">/</span><span class="p">(</span><span class="mi">63</span><span class="o">-</span><span class="mi">12</span><span class="p">))</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tea6320_shift11</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tea6320_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span> <span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TEA6320_FFR</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TEA6320_FFL</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TEA6320_FRR</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">TEA6320_FRL</span><span class="p">,</span> <span class="mh">0x3f</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip descriptions - defines+functions for tda8425                */</span>

<span class="cp">#define TDA8425_VL         0x00  </span><span class="cm">/* volume left */</span><span class="cp"></span>
<span class="cp">#define TDA8425_VR         0x01  </span><span class="cm">/* volume right */</span><span class="cp"></span>
<span class="cp">#define TDA8425_BA         0x02  </span><span class="cm">/* bass */</span><span class="cp"></span>
<span class="cp">#define TDA8425_TR         0x03  </span><span class="cm">/* treble */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1         0x08  </span><span class="cm">/* switch functions */</span><span class="cp"></span>
				 <span class="cm">/* values for those registers: */</span>
<span class="cp">#define TDA8425_S1_OFF     0xEE  </span><span class="cm">/* audio off (mute on) */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_CH1     0xCE  </span><span class="cm">/* audio channel 1 (mute off) - &quot;linear stereo&quot; mode */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_CH2     0xCF  </span><span class="cm">/* audio channel 2 (mute off) - &quot;linear stereo&quot; mode */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_MU      0x20  </span><span class="cm">/* mute bit */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_STEREO  0x18  </span><span class="cm">/* stereo bits */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_STEREO_SPATIAL 0x18 </span><span class="cm">/* spatial stereo */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_STEREO_LINEAR  0x08 </span><span class="cm">/* linear stereo */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_STEREO_PSEUDO  0x10 </span><span class="cm">/* pseudo stereo */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_STEREO_MONO    0x00 </span><span class="cm">/* forced mono */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_ML      0x06        </span><span class="cm">/* language selector */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_ML_SOUND_A 0x02     </span><span class="cm">/* sound a */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_ML_SOUND_B 0x04     </span><span class="cm">/* sound b */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_ML_STEREO  0x06     </span><span class="cm">/* stereo */</span><span class="cp"></span>
<span class="cp">#define TDA8425_S1_IS      0x01        </span><span class="cm">/* channel selector */</span><span class="cp"></span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda8425_shift10</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xc0</span><span class="p">;</span> <span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">tda8425_shift12</span><span class="p">(</span><span class="kt">int</span> <span class="n">val</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf0</span><span class="p">;</span> <span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">tda8425_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">bytes</span><span class="p">[</span><span class="n">TDA8425_S1</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xe1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s1</span> <span class="o">|=</span> <span class="n">TDA8425_S1_ML_SOUND_A</span><span class="p">;</span>
		<span class="n">s1</span> <span class="o">|=</span> <span class="n">TDA8425_S1_STEREO_PSEUDO</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s1</span> <span class="o">|=</span> <span class="n">TDA8425_S1_ML_SOUND_B</span><span class="p">;</span>
		<span class="n">s1</span> <span class="o">|=</span> <span class="n">TDA8425_S1_STEREO_PSEUDO</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">s1</span> <span class="o">|=</span> <span class="n">TDA8425_S1_ML_STEREO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">)</span>
			<span class="n">s1</span> <span class="o">|=</span> <span class="n">TDA8425_S1_STEREO_MONO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">)</span>
			<span class="n">s1</span> <span class="o">|=</span> <span class="n">TDA8425_S1_STEREO_SPATIAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">TDA8425_S1</span><span class="p">,</span><span class="n">s1</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip descriptions - defines+functions for pic16c54 (PV951)       */</span>

<span class="cm">/* the registers of 16C54, I2C sub address. */</span>
<span class="cp">#define PIC16C54_REG_KEY_CODE     0x01	       </span><span class="cm">/* Not use. */</span><span class="cp"></span>
<span class="cp">#define PIC16C54_REG_MISC         0x02</span>

<span class="cm">/* bit definition of the RESET register, I2C data. */</span>
<span class="cp">#define PIC16C54_MISC_RESET_REMOTE_CTL 0x01 </span><span class="cm">/* bit 0, Reset to receive the key */</span><span class="cp"></span>
					    <span class="cm">/*        code of remote controller */</span>
<span class="cp">#define PIC16C54_MISC_MTS_MAIN         0x02 </span><span class="cm">/* bit 1 */</span><span class="cp"></span>
<span class="cp">#define PIC16C54_MISC_MTS_SAP          0x04 </span><span class="cm">/* bit 2 */</span><span class="cp"></span>
<span class="cp">#define PIC16C54_MISC_MTS_BOTH         0x08 </span><span class="cm">/* bit 3 */</span><span class="cp"></span>
<span class="cp">#define PIC16C54_MISC_SND_MUTE         0x10 </span><span class="cm">/* bit 4, Mute Audio(Line-in and Tuner) */</span><span class="cp"></span>
<span class="cp">#define PIC16C54_MISC_SND_NOTMUTE      0x20 </span><span class="cm">/* bit 5 */</span><span class="cp"></span>
<span class="cp">#define PIC16C54_MISC_SWITCH_TUNER     0x40 </span><span class="cm">/* bit 6	, Switch to Line-in */</span><span class="cp"></span>
<span class="cp">#define PIC16C54_MISC_SWITCH_LINE      0x80 </span><span class="cm">/* bit 7	, Switch to Tuner */</span><span class="cp"></span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip descriptions - defines+functions for TA8874Z                */</span>

<span class="cm">/* write 1st byte */</span>
<span class="cp">#define TA8874Z_LED_STE	0x80</span>
<span class="cp">#define TA8874Z_LED_BIL	0x40</span>
<span class="cp">#define TA8874Z_LED_EXT	0x20</span>
<span class="cp">#define TA8874Z_MONO_SET	0x10</span>
<span class="cp">#define TA8874Z_MUTE	0x08</span>
<span class="cp">#define TA8874Z_F_MONO	0x04</span>
<span class="cp">#define TA8874Z_MODE_SUB	0x02</span>
<span class="cp">#define TA8874Z_MODE_MAIN	0x01</span>

<span class="cm">/* write 2nd byte */</span>
<span class="cm">/*#define TA8874Z_TI	0x80  */</span> <span class="cm">/* test mode */</span>
<span class="cp">#define TA8874Z_SEPARATION	0x3f</span>
<span class="cp">#define TA8874Z_SEPARATION_DEFAULT	0x10</span>

<span class="cm">/* read */</span>
<span class="cp">#define TA8874Z_B1	0x80</span>
<span class="cp">#define TA8874Z_B0	0x40</span>
<span class="cp">#define TA8874Z_CHAG_FLAG	0x20</span>

<span class="cm">/*</span>
<span class="cm"> *        B1 B0</span>
<span class="cm"> * mono    L  H</span>
<span class="cm"> * stereo  L  L</span>
<span class="cm"> * BIL     H  L</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ta8874z_getmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">chip_read</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TA8874Z_B1</span><span class="p">){</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">;</span>
	<span class="p">}</span><span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TA8874Z_B0</span><span class="p">)){</span>
		<span class="n">mode</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* v4l_dbg(1, debug, chip-&gt;c, &quot;ta8874z_getmode(): raw chip read: 0x%02x, return: 0x%02x\n&quot;, val, mode); */</span>
	<span class="k">return</span> <span class="n">mode</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">audiocmd</span> <span class="n">ta8874z_stereo</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="n">TA8874Z_SEPARATION_DEFAULT</span><span class="p">}};</span>
<span class="k">static</span> <span class="n">audiocmd</span> <span class="n">ta8874z_mono</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="n">TA8874Z_MONO_SET</span><span class="p">,</span> <span class="n">TA8874Z_SEPARATION_DEFAULT</span><span class="p">}};</span>
<span class="k">static</span> <span class="n">audiocmd</span> <span class="n">ta8874z_main</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="n">TA8874Z_SEPARATION_DEFAULT</span><span class="p">}};</span>
<span class="k">static</span> <span class="n">audiocmd</span> <span class="n">ta8874z_sub</span> <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="n">TA8874Z_MODE_SUB</span><span class="p">,</span> <span class="n">TA8874Z_SEPARATION_DEFAULT</span><span class="p">}};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ta8874z_setmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">audiocmd</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;ta8874z_setmode(): mode: 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">mode</span><span class="p">){</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ta8874z_mono</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
		<span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ta8874z_stereo</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
		<span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ta8874z_main</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
		<span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ta8874z_sub</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">update</span><span class="p">)</span>
		<span class="n">chip_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;TA8874Z&quot;</span><span class="p">,</span> <span class="n">t</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ta8874z_checkit</span><span class="p">(</span><span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">chip_read</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">((</span><span class="n">rc</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* audio chip descriptions - struct CHIPDESC                              */</span>

<span class="cm">/* insmod options to enable/disable individual audio chips */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda8425</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9840</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9850</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9855</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9873</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9874a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tda9875</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tea6300</span><span class="p">;</span>	<span class="cm">/* default 0 - address clash with msp34xx */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tea6320</span><span class="p">;</span>	<span class="cm">/* default 0 - address clash with msp34xx */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tea6420</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pic16c54</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ta8874z</span><span class="p">;</span>	<span class="cm">/* default 0 - address clash with tda9840 */</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">tda8425</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tda9840</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tda9850</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tda9855</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tda9873</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tda9874a</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tda9875</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tea6300</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tea6320</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">tea6420</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">pic16c54</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ta8874z</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="n">chiplist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tda9840&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tda9840</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA9840</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA9840</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_NEED_CHECKMODE</span><span class="p">,</span>

		<span class="cm">/* callbacks */</span>
		<span class="p">.</span><span class="n">checkit</span>    <span class="o">=</span> <span class="n">tda9840_checkit</span><span class="p">,</span>
		<span class="p">.</span><span class="n">getmode</span>    <span class="o">=</span> <span class="n">tda9840_getmode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setmode</span>    <span class="o">=</span> <span class="n">tda9840_setmode</span><span class="p">,</span>

		<span class="p">.</span><span class="n">init</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9840_TEST</span><span class="p">,</span> <span class="n">TDA9840_TEST_INT1SN</span>
				<span class="cm">/* ,TDA9840_SW, TDA9840_MONO */</span><span class="p">}</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tda9873h&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tda9873</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA985x_L</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA985x_H</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_HAS_INPUTSEL</span> <span class="o">|</span> <span class="n">CHIP_NEED_CHECKMODE</span><span class="p">,</span>

		<span class="cm">/* callbacks */</span>
		<span class="p">.</span><span class="n">checkit</span>    <span class="o">=</span> <span class="n">tda9873_checkit</span><span class="p">,</span>
		<span class="p">.</span><span class="n">getmode</span>    <span class="o">=</span> <span class="n">tda9873_getmode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setmode</span>    <span class="o">=</span> <span class="n">tda9873_setmode</span><span class="p">,</span>

		<span class="p">.</span><span class="n">init</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9873_SW</span><span class="p">,</span> <span class="mh">0xa4</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">}</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">inputreg</span>   <span class="o">=</span> <span class="n">TDA9873_SW</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inputmute</span>  <span class="o">=</span> <span class="n">TDA9873_MUTE</span> <span class="o">|</span> <span class="n">TDA9873_AUTOMUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inputmap</span>   <span class="o">=</span> <span class="p">{</span><span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa2</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">},</span>
		<span class="p">.</span><span class="n">inputmask</span>  <span class="o">=</span> <span class="n">TDA9873_INP_MASK</span><span class="o">|</span><span class="n">TDA9873_MUTE</span><span class="o">|</span><span class="n">TDA9873_AUTOMUTE</span><span class="p">,</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tda9874h/a&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tda9874a</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA9874</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA9874</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_NEED_CHECKMODE</span><span class="p">,</span>

		<span class="cm">/* callbacks */</span>
		<span class="p">.</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">tda9874a_initialize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">checkit</span>    <span class="o">=</span> <span class="n">tda9874a_checkit</span><span class="p">,</span>
		<span class="p">.</span><span class="n">getmode</span>    <span class="o">=</span> <span class="n">tda9874a_getmode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setmode</span>    <span class="o">=</span> <span class="n">tda9874a_setmode</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tda9875&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tda9875</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA9875</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA9875</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_HAS_VOLUME</span> <span class="o">|</span> <span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">,</span>

		<span class="cm">/* callbacks */</span>
		<span class="p">.</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">tda9875_initialize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">checkit</span>    <span class="o">=</span> <span class="n">tda9875_checkit</span><span class="p">,</span>
		<span class="p">.</span><span class="n">volfunc</span>    <span class="o">=</span> <span class="n">tda9875_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassfunc</span>   <span class="o">=</span> <span class="n">tda9875_bass</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblefunc</span> <span class="o">=</span> <span class="n">tda9875_treble</span><span class="p">,</span>
		<span class="p">.</span><span class="n">leftreg</span>    <span class="o">=</span> <span class="n">TDA9875_MVL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rightreg</span>   <span class="o">=</span> <span class="n">TDA9875_MVR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassreg</span>    <span class="o">=</span> <span class="n">TDA9875_MBA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblereg</span>  <span class="o">=</span> <span class="n">TDA9875_MTR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">leftinit</span>   <span class="o">=</span> <span class="mi">58880</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rightinit</span>  <span class="o">=</span> <span class="mi">58880</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tda9850&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tda9850</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA985x_L</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA985x_H</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>

		<span class="p">.</span><span class="n">getmode</span>    <span class="o">=</span> <span class="n">tda985x_getmode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setmode</span>    <span class="o">=</span> <span class="n">tda985x_setmode</span><span class="p">,</span>

		<span class="p">.</span><span class="n">init</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="p">{</span> <span class="n">TDA9850_C4</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="n">TDA985x_STEREO</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">}</span> <span class="p">}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tda9855&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tda9855</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA985x_L</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA985x_H</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_HAS_VOLUME</span> <span class="o">|</span> <span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">,</span>

		<span class="p">.</span><span class="n">leftreg</span>    <span class="o">=</span> <span class="n">TDA9855_VL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rightreg</span>   <span class="o">=</span> <span class="n">TDA9855_VR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassreg</span>    <span class="o">=</span> <span class="n">TDA9855_BA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblereg</span>  <span class="o">=</span> <span class="n">TDA9855_TR</span><span class="p">,</span>

		<span class="cm">/* callbacks */</span>
		<span class="p">.</span><span class="n">volfunc</span>    <span class="o">=</span> <span class="n">tda9855_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassfunc</span>   <span class="o">=</span> <span class="n">tda9855_bass</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblefunc</span> <span class="o">=</span> <span class="n">tda9855_treble</span><span class="p">,</span>
		<span class="p">.</span><span class="n">getmode</span>    <span class="o">=</span> <span class="n">tda985x_getmode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setmode</span>    <span class="o">=</span> <span class="n">tda985x_setmode</span><span class="p">,</span>

		<span class="p">.</span><span class="n">init</span>       <span class="o">=</span> <span class="p">{</span> <span class="mi">12</span><span class="p">,</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x6f</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x07</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="mh">0x8</span><span class="o">&lt;&lt;</span><span class="mi">2</span><span class="p">,</span>
				    <span class="n">TDA9855_MUTE</span> <span class="o">|</span> <span class="n">TDA9855_AVL</span> <span class="o">|</span> <span class="n">TDA9855_LOUD</span> <span class="o">|</span> <span class="n">TDA9855_INT</span><span class="p">,</span>
				    <span class="n">TDA985x_STEREO</span> <span class="o">|</span> <span class="n">TDA9855_LINEAR</span> <span class="o">|</span> <span class="n">TDA9855_TZCM</span> <span class="o">|</span> <span class="n">TDA9855_VZCM</span><span class="p">,</span>
				    <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x03</span> <span class="p">}}</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tea6300&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tea6300</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TEA6300</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TEA6300</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_HAS_VOLUME</span> <span class="o">|</span> <span class="n">CHIP_HAS_BASSTREBLE</span> <span class="o">|</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">,</span>

		<span class="p">.</span><span class="n">leftreg</span>    <span class="o">=</span> <span class="n">TEA6300_VR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rightreg</span>   <span class="o">=</span> <span class="n">TEA6300_VL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassreg</span>    <span class="o">=</span> <span class="n">TEA6300_BA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblereg</span>  <span class="o">=</span> <span class="n">TEA6300_TR</span><span class="p">,</span>

		<span class="cm">/* callbacks */</span>
		<span class="p">.</span><span class="n">volfunc</span>    <span class="o">=</span> <span class="n">tea6300_shift10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassfunc</span>   <span class="o">=</span> <span class="n">tea6300_shift12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblefunc</span> <span class="o">=</span> <span class="n">tea6300_shift12</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputreg</span>   <span class="o">=</span> <span class="n">TEA6300_S</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inputmap</span>   <span class="o">=</span> <span class="p">{</span> <span class="n">TEA6300_S_SA</span><span class="p">,</span> <span class="n">TEA6300_S_SB</span><span class="p">,</span> <span class="n">TEA6300_S_SC</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">inputmute</span>  <span class="o">=</span> <span class="n">TEA6300_S_GMU</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tea6320&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tea6320</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TEA6300</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TEA6300</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_HAS_VOLUME</span> <span class="o">|</span> <span class="n">CHIP_HAS_BASSTREBLE</span> <span class="o">|</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">,</span>

		<span class="p">.</span><span class="n">leftreg</span>    <span class="o">=</span> <span class="n">TEA6320_V</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rightreg</span>   <span class="o">=</span> <span class="n">TEA6320_V</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassreg</span>    <span class="o">=</span> <span class="n">TEA6320_BA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblereg</span>  <span class="o">=</span> <span class="n">TEA6320_TR</span><span class="p">,</span>

		<span class="cm">/* callbacks */</span>
		<span class="p">.</span><span class="n">initialize</span> <span class="o">=</span> <span class="n">tea6320_initialize</span><span class="p">,</span>
		<span class="p">.</span><span class="n">volfunc</span>    <span class="o">=</span> <span class="n">tea6320_volume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassfunc</span>   <span class="o">=</span> <span class="n">tea6320_shift11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblefunc</span> <span class="o">=</span> <span class="n">tea6320_shift11</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputreg</span>   <span class="o">=</span> <span class="n">TEA6320_S</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inputmap</span>   <span class="o">=</span> <span class="p">{</span> <span class="n">TEA6320_S_SA</span><span class="p">,</span> <span class="n">TEA6420_S_SB</span><span class="p">,</span> <span class="n">TEA6300_S_SC</span><span class="p">,</span> <span class="n">TEA6320_S_SD</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">inputmute</span>  <span class="o">=</span> <span class="n">TEA6300_S_GMU</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tea6420&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tea6420</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TEA6420</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TEA6420</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputreg</span>   <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inputmap</span>   <span class="o">=</span> <span class="p">{</span> <span class="n">TEA6420_S_SA</span><span class="p">,</span> <span class="n">TEA6420_S_SB</span><span class="p">,</span> <span class="n">TEA6420_S_SC</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">inputmute</span>  <span class="o">=</span> <span class="n">TEA6300_S_GMU</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;tda8425&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">tda8425</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA8425</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA8425</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_HAS_VOLUME</span> <span class="o">|</span> <span class="n">CHIP_HAS_BASSTREBLE</span> <span class="o">|</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">,</span>

		<span class="p">.</span><span class="n">leftreg</span>    <span class="o">=</span> <span class="n">TDA8425_VL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">rightreg</span>   <span class="o">=</span> <span class="n">TDA8425_VR</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassreg</span>    <span class="o">=</span> <span class="n">TDA8425_BA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblereg</span>  <span class="o">=</span> <span class="n">TDA8425_TR</span><span class="p">,</span>

		<span class="cm">/* callbacks */</span>
		<span class="p">.</span><span class="n">volfunc</span>    <span class="o">=</span> <span class="n">tda8425_shift10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bassfunc</span>   <span class="o">=</span> <span class="n">tda8425_shift12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">treblefunc</span> <span class="o">=</span> <span class="n">tda8425_shift12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setmode</span>    <span class="o">=</span> <span class="n">tda8425_setmode</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputreg</span>   <span class="o">=</span> <span class="n">TDA8425_S1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inputmap</span>   <span class="o">=</span> <span class="p">{</span> <span class="n">TDA8425_S1_CH1</span><span class="p">,</span> <span class="n">TDA8425_S1_CH1</span><span class="p">,</span> <span class="n">TDA8425_S1_CH1</span> <span class="p">},</span>
		<span class="p">.</span><span class="n">inputmute</span>  <span class="o">=</span> <span class="n">TDA8425_S1_OFF</span><span class="p">,</span>

	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;pic16c54 (PV951)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">pic16c54</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_PIC16C54</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_PIC16C54</span><span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">,</span>

		<span class="p">.</span><span class="n">inputreg</span>   <span class="o">=</span> <span class="n">PIC16C54_REG_MISC</span><span class="p">,</span>
		<span class="p">.</span><span class="n">inputmap</span>   <span class="o">=</span> <span class="p">{</span><span class="n">PIC16C54_MISC_SND_NOTMUTE</span><span class="o">|</span><span class="n">PIC16C54_MISC_SWITCH_TUNER</span><span class="p">,</span>
			     <span class="n">PIC16C54_MISC_SND_NOTMUTE</span><span class="o">|</span><span class="n">PIC16C54_MISC_SWITCH_LINE</span><span class="p">,</span>
			     <span class="n">PIC16C54_MISC_SND_NOTMUTE</span><span class="o">|</span><span class="n">PIC16C54_MISC_SWITCH_LINE</span><span class="p">,</span>
			     <span class="n">PIC16C54_MISC_SND_MUTE</span><span class="p">},</span>
		<span class="p">.</span><span class="n">inputmute</span>  <span class="o">=</span> <span class="n">PIC16C54_MISC_SND_MUTE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;ta8874z&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">checkit</span>    <span class="o">=</span> <span class="n">ta8874z_checkit</span><span class="p">,</span>
		<span class="p">.</span><span class="n">insmodopt</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">ta8874z</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_lo</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA9840</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">addr_hi</span>    <span class="o">=</span> <span class="n">I2C_ADDR_TDA9840</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">registers</span>  <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>      <span class="o">=</span> <span class="n">CHIP_NEED_CHECKMODE</span><span class="p">,</span>

		<span class="cm">/* callbacks */</span>
		<span class="p">.</span><span class="n">getmode</span>    <span class="o">=</span> <span class="n">ta8874z_getmode</span><span class="p">,</span>
		<span class="p">.</span><span class="n">setmode</span>    <span class="o">=</span> <span class="n">ta8874z_setmode</span><span class="p">,</span>

		<span class="p">.</span><span class="n">init</span>       <span class="o">=</span> <span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="p">{</span> <span class="n">TA8874Z_MONO_SET</span><span class="p">,</span> <span class="n">TA8874Z_SEPARATION_DEFAULT</span><span class="p">}},</span>
	<span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span> <span class="p">}</span> <span class="cm">/* EOF */</span>
<span class="p">};</span>


<span class="cm">/* ---------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">=</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">muted</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_VOLUME</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">volume</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_VOLUME</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">volume</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volume</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">=</span><span class="p">(</span><span class="mi">32768</span><span class="o">*</span><span class="n">min</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">=</span><span class="mi">32768</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BASS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">bass</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">treble</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">muted</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">muted</span><span class="p">)</span>
			<span class="n">chip_write_masked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">inputreg</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">inputmute</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">inputmask</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">chip_write_masked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">inputreg</span><span class="p">,</span>
					<span class="n">desc</span><span class="o">-&gt;</span><span class="n">inputmap</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">],</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">inputmask</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">volume</span><span class="p">,</span><span class="n">balance</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_VOLUME</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">volume</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">volume</span><span class="p">)</span>
			<span class="n">balance</span><span class="o">=</span><span class="p">(</span><span class="mi">32768</span><span class="o">*</span><span class="n">min</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">))</span><span class="o">/</span><span class="n">volume</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">balance</span><span class="o">=</span><span class="mi">32768</span><span class="p">;</span>

		<span class="n">volume</span><span class="o">=</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="mi">65536</span> <span class="o">-</span> <span class="n">balance</span><span class="p">,</span><span class="mi">32768</span><span class="p">)</span> <span class="o">*</span> <span class="n">volume</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32768</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">balance</span><span class="p">,</span><span class="n">volume</span> <span class="o">*</span><span class="p">(</span><span class="n">__u16</span><span class="p">)</span><span class="mi">32768</span><span class="p">))</span> <span class="o">/</span> <span class="mi">32768</span><span class="p">;</span>

		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">leftreg</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">volfunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">));</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">rightreg</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">volfunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">));</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="n">volume</span><span class="p">,</span> <span class="n">balance</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_VOLUME</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">volume</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">);</span>
		<span class="n">balance</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="mi">65536</span> <span class="o">-</span> <span class="n">balance</span><span class="p">,</span> <span class="mi">32768</span><span class="p">)</span> <span class="o">*</span> <span class="n">volume</span><span class="p">)</span> <span class="o">/</span> <span class="mi">32768</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">balance</span><span class="p">,</span> <span class="n">volume</span> <span class="o">*</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span><span class="mi">32768</span><span class="p">))</span> <span class="o">/</span> <span class="mi">32768</span><span class="p">;</span>

		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">leftreg</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">volfunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">));</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">rightreg</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">volfunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">));</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BASS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bass</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bassreg</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bassfunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bass</span><span class="p">));</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">treble</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">treblereg</span><span class="p">,</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">treblefunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">treble</span><span class="p">));</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* ---------------------------------------------------------------------- */</span>
<span class="cm">/* video4linux interface                                                  */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_s_radio</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* del_timer(&amp;chip-&gt;wt); */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">qc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">qc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_MUTE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_VOLUME</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_VOLUME</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="mi">65535</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">58880</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BALANCE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_VOLUME</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="mi">65535</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">32768</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_BASS</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_AUDIO_TREBLE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">v4l2_ctrl_query_fill</span><span class="p">(</span><span class="n">qc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">65535</span><span class="p">,</span> <span class="mi">65535</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">32768</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_s_routing</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="n">u32</span> <span class="n">input</span><span class="p">,</span> <span class="n">u32</span> <span class="n">output</span><span class="p">,</span> <span class="n">u32</span> <span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* There are four inputs: tuner, radio, extern and intern. */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">muted</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip_write_masked</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">inputreg</span><span class="p">,</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">inputmap</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">],</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">inputmask</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">setmode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">vt</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">vt</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* del_timer(&amp;chip-&gt;wt); */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">setmode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">getmode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>
	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vt</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_TUNER_CAP_STEREO</span> <span class="o">|</span>
		<span class="n">V4L2_TUNER_CAP_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_CAP_LANG2</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">getmode</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">)</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">)</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="cm">/* Note: for SAP it should be mono/lang2 or stereo/lang2.</span>
<span class="cm">	   When this module is converted fully to v4l2, then this</span>
<span class="cm">	   should change for those chips that can detect SAP. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">)</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_LANG1</span> <span class="o">|</span>
			<span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* automatic */</span>

	<span class="cm">/* For chips that provide getmode and setmode, and doesn&#39;t</span>
<span class="cm">	   automatically follows the stereo carrier, a kthread is</span>
<span class="cm">	   created to set the audio standard. In this case, when then</span>
<span class="cm">	   the video channel is changed, tvaudio starts on MONO mode.</span>
<span class="cm">	   After waiting for 2 seconds, the kernel thread is called,</span>
<span class="cm">	   to follow whatever audio standard is pointed by the</span>
<span class="cm">	   audio carrier.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">setmode</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prevmode</span> <span class="o">!=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">)</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prevmode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* reset previous mode */</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">wt</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">v4l2_chip_ident_i2c_client</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">V4L2_IDENT_TVAUDIO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">tvaudio_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_chip_ident</span> <span class="o">=</span> <span class="n">tvaudio_g_chip_ident</span><span class="p">,</span>
	<span class="p">.</span><span class="n">queryctrl</span> <span class="o">=</span> <span class="n">tvaudio_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_ctrl</span> <span class="o">=</span> <span class="n">tvaudio_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">tvaudio_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_std</span> <span class="o">=</span> <span class="n">tvaudio_s_std</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_tuner_ops</span> <span class="n">tvaudio_tuner_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_radio</span> <span class="o">=</span> <span class="n">tvaudio_s_radio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_frequency</span> <span class="o">=</span> <span class="n">tvaudio_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_tuner</span> <span class="o">=</span> <span class="n">tvaudio_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_tuner</span> <span class="o">=</span> <span class="n">tvaudio_g_tuner</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_audio_ops</span> <span class="n">tvaudio_audio_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_routing</span> <span class="o">=</span> <span class="n">tvaudio_s_routing</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">tvaudio_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvaudio_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tuner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvaudio_tuner_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">audio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tvaudio_audio_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>


<span class="cm">/* i2c registration                                                       */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">CHIPDESC</span>  <span class="o">*</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tvaudio: TV audio decoder + audio/video mux driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;tvaudio: known chips: &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chiplist</span><span class="p">;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">desc</span><span class="o">++</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s%s&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">desc</span> <span class="o">==</span> <span class="n">chiplist</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;, &quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chip</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tvaudio_ops</span><span class="p">);</span>

	<span class="cm">/* find description for the chip */</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;chip found @ 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">desc</span> <span class="o">=</span> <span class="n">chiplist</span><span class="p">;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">desc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">insmodopt</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&lt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr_lo</span> <span class="o">||</span>
		    <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">&gt;</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">addr_hi</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">checkit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">checkit</span><span class="p">(</span><span class="n">chip</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;no matching chip description found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;%s found @ 0x%x (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="o">&lt;&lt;</span><span class="mi">1</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;matches:%s%s%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_VOLUME</span><span class="p">)</span>     <span class="o">?</span> <span class="s">&quot; volume&quot;</span>      <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; bass/treble&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_INPUTSEL</span><span class="p">)</span>   <span class="o">?</span> <span class="s">&quot; audiomux&quot;</span>    <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* fill required data structures */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">I2C_NAME_SIZE</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">desc</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">shadow</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">registers</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prevmode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">;</span>

	<span class="cm">/* initialization  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">initialize</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">desc</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chip_cmd</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="s">&quot;init&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_VOLUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">volfunc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This shouldn&#39;t be happen. Warn user, but keep working</span>
<span class="cm">			   without volume controls</span>
<span class="cm">			 */</span>
			<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;volume callback undefined!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CHIP_HAS_VOLUME</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span>  <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">leftinit</span>  <span class="o">?</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">leftinit</span>  <span class="o">:</span> <span class="mi">65535</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">rightinit</span> <span class="o">?</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">rightinit</span> <span class="o">:</span> <span class="mi">65535</span><span class="p">;</span>
			<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">leftreg</span><span class="p">,</span>
				   <span class="n">desc</span><span class="o">-&gt;</span><span class="n">volfunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">));</span>
			<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">rightreg</span><span class="p">,</span>
				   <span class="n">desc</span><span class="o">-&gt;</span><span class="n">volfunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">right</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">bassfunc</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">treblefunc</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This shouldn&#39;t be happen. Warn user, but keep working</span>
<span class="cm">			   without bass/treble controls</span>
<span class="cm">			 */</span>
			<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;bass/treble callbacks undefined!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CHIP_HAS_BASSTREBLE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">treble</span> <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">trebleinit</span> <span class="o">?</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">trebleinit</span> <span class="o">:</span> <span class="mi">32768</span><span class="p">;</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bass</span>   <span class="o">=</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bassinit</span>   <span class="o">?</span>
						<span class="n">desc</span><span class="o">-&gt;</span><span class="n">bassinit</span>   <span class="o">:</span> <span class="mi">32768</span><span class="p">;</span>
			<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bassreg</span><span class="p">,</span>
				   <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bassfunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bass</span><span class="p">));</span>
			<span class="n">chip_write</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">treblereg</span><span class="p">,</span>
				   <span class="n">desc</span><span class="o">-&gt;</span><span class="n">treblefunc</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">treble</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">wt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CHIP_NEED_CHECKMODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">getmode</span> <span class="o">||</span> <span class="o">!</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">setmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This shouldn&#39;t be happen. Warn user, but keep working</span>
<span class="cm">			   without kthread</span>
<span class="cm">			 */</span>
			<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;set/get mode callbacks undefined!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* start async thread */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">wt</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">chip_thread_wake</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">wt</span><span class="p">.</span><span class="n">data</span>     <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">chip</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">chip_thread</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">v4l2_warn</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;failed to create kthread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">tvaudio_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">CHIPSTATE</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">wt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* shutdown async thread */</span>
		<span class="n">kthread_stop</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="kr">thread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This driver supports many devices and the idea is to let the driver</span>
<span class="cm">   detect which device is present. So rather than listing all supported</span>
<span class="cm">   devices here, we pretend to support a single, fake device type. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">tvaudio_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;tvaudio&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">tvaudio_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">tvaudio_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;tvaudio&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">tvaudio_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">tvaudio_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">tvaudio_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">tvaudio_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
