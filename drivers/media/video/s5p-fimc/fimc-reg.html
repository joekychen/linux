<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › s5p-fimc › fimc-reg.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>fimc-reg.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Register interface file for Samsung Camera Interface (FIMC) driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 - 2012 Samsung Electronics Co., Ltd.</span>
<span class="cm"> * Sylwester Nawrocki, &lt;s.nawrocki@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm">*/</span>

<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;media/s5p_fimc.h&gt;</span>

<span class="cp">#include &quot;fimc-reg.h&quot;</span>
<span class="cp">#include &quot;fimc-core.h&quot;</span>


<span class="kt">void</span> <span class="nf">fimc_hw_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISRCFMT</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISRCFMT_ITU601_8BIT</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISRCFMT</span><span class="p">);</span>

	<span class="cm">/* Software reset. */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FIMC_REG_CIGCTRL_SWRST</span> <span class="o">|</span> <span class="n">FIMC_REG_CIGCTRL_IRQ_LEVEL</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CIGCTRL_SWRST</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">variant</span><span class="o">-&gt;</span><span class="n">out_buf_count</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">fimc_hw_set_dma_seq</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fimc_hw_get_in_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">flip</span> <span class="o">=</span> <span class="n">FIMC_REG_MSCTRL_FLIP_NORMAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hflip</span><span class="p">)</span>
		<span class="n">flip</span> <span class="o">=</span> <span class="n">FIMC_REG_MSCTRL_FLIP_X_MIRROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vflip</span><span class="p">)</span>
		<span class="n">flip</span> <span class="o">=</span> <span class="n">FIMC_REG_MSCTRL_FLIP_Y_MIRROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rotation</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flip</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">flip</span> <span class="o">^</span> <span class="n">FIMC_REG_MSCTRL_FLIP_180</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIMC_REG_MSCTRL_FLIP_180</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">fimc_hw_get_target_flip</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">flip</span> <span class="o">=</span> <span class="n">FIMC_REG_CITRGFMT_FLIP_NORMAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">hflip</span><span class="p">)</span>
		<span class="n">flip</span> <span class="o">|=</span> <span class="n">FIMC_REG_CITRGFMT_FLIP_X_MIRROR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">vflip</span><span class="p">)</span>
		<span class="n">flip</span> <span class="o">|=</span> <span class="n">FIMC_REG_CITRGFMT_FLIP_Y_MIRROR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rotation</span> <span class="o">&lt;=</span> <span class="mi">90</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">flip</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">flip</span> <span class="o">^</span> <span class="n">FIMC_REG_CITRGFMT_FLIP_180</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">FIMC_REG_CITRGFMT_FLIP_180</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_rotation</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">flip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CITRGFMT</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CITRGFMT_INROT90</span> <span class="o">|</span> <span class="n">FIMC_REG_CITRGFMT_OUTROT90</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CITRGFMT_FLIP_180</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The input and output rotator cannot work simultaneously.</span>
<span class="cm">	 * Use the output rotator in output DMA mode or the input rotator</span>
<span class="cm">	 * in direct fifo output mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">90</span> <span class="o">||</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">270</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_path</span> <span class="o">==</span> <span class="n">FIMC_IO_LCDFIFO</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CITRGFMT_INROT90</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CITRGFMT_OUTROT90</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_path</span> <span class="o">==</span> <span class="n">FIMC_IO_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">fimc_hw_get_target_flip</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CITRGFMT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* LCD FIFO path */</span>
		<span class="n">flip</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_MSCTRL</span><span class="p">);</span>
		<span class="n">flip</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_MSCTRL_FLIP_MASK</span><span class="p">;</span>
		<span class="n">flip</span> <span class="o">|=</span> <span class="n">fimc_hw_get_in_flip</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">flip</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_MSCTRL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_target_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">d_frame</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;w= %d, h= %d color: %d&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
	    <span class="n">frame</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CITRGFMT</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CITRGFMT_FMT_MASK</span> <span class="o">|</span> <span class="n">FIMC_REG_CITRGFMT_HSIZE_MASK</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CITRGFMT_VSIZE_MASK</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIMC_FMT_RGB444</span><span class="p">...</span><span class="n">FIMC_FMT_RGB888</span>:
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CITRGFMT_RGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIMC_FMT_YCBCR420</span>:
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CITRGFMT_YCBCR420</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIMC_FMT_YCBYCR422</span><span class="p">...</span><span class="n">FIMC_FMT_CRYCBY422</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colplanes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CITRGFMT_YCBCR422_1P</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CITRGFMT_YCBCR422</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">90</span> <span class="o">||</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">rotation</span> <span class="o">==</span> <span class="mi">270</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CITRGFMT</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CITAREA</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CITAREA_MASK</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CITAREA</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fimc_hw_set_out_dma_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">d_frame</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">f_height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">f_width</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_ORGOSIZE</span><span class="p">);</span>

	<span class="cm">/* Select color space conversion equation (HD/SD size).*/</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">f_width</span> <span class="o">&gt;=</span> <span class="mi">1280</span><span class="p">)</span> <span class="cm">/* HD */</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_CSC_ITU601_709</span><span class="p">;</span>
	<span class="k">else</span>	<span class="cm">/* SD */</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CIGCTRL_CSC_ITU601_709</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_out_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">d_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_dma_offset</span> <span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_fmt</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="cm">/* Set the input dma offsets. */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="o">-&gt;</span><span class="n">y_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span><span class="o">-&gt;</span><span class="n">y_h</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOYOFF</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="o">-&gt;</span><span class="n">cb_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span><span class="o">-&gt;</span><span class="n">cb_h</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCBOFF</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="o">-&gt;</span><span class="n">cr_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span><span class="o">-&gt;</span><span class="n">cr_h</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCROFF</span><span class="p">);</span>

	<span class="n">fimc_hw_set_out_dma_size</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="cm">/* Configure chroma components order. */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCTRL</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CIOCTRL_ORDER2P_MASK</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CIOCTRL_ORDER422_MASK</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CIOCTRL_YCBCR_PLANE_MASK</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CIOCTRL_RGB16FMT_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colplanes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_order_1p</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colplanes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_order_2p</span> <span class="o">|</span> <span class="n">FIMC_REG_CIOCTRL_YCBCR_2PLANE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colplanes</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIOCTRL_YCBCR_3PLANE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">==</span> <span class="n">FIMC_FMT_RGB565</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIOCTRL_RGB565</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">==</span> <span class="n">FIMC_FMT_RGB555</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIOCTRL_ARGB1555</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">color</span> <span class="o">==</span> <span class="n">FIMC_FMT_RGB444</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIOCTRL_ARGB4444</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fimc_hw_en_autoload</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_ORGISIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIREAL_ISIZE_AUTOLOAD_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CIREAL_ISIZE_AUTOLOAD_EN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_ORGISIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_en_lastirq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIOCTRL_LASTIRQ_ENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CIOCTRL_LASTIRQ_ENABLE</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_prescaler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span>  <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_scaler</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">shfactor</span><span class="p">;</span>

	<span class="n">shfactor</span> <span class="o">=</span> <span class="mi">10</span> <span class="o">-</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">hfactor</span> <span class="o">+</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">vfactor</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">shfactor</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pre_hratio</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">pre_vratio</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCPRERATIO</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">pre_dst_width</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">pre_dst_height</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCPREDST</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fimc_hw_set_scaler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_scaler</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">src_frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">s_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">dst_frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">d_frame</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCCTRL</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CISCCTRL_CSCR2Y_WIDE</span> <span class="o">|</span> <span class="n">FIMC_REG_CISCCTRL_CSCY2R_WIDE</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CISCCTRL_SCALEUP_H</span> <span class="o">|</span> <span class="n">FIMC_REG_CISCCTRL_SCALEUP_V</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CISCCTRL_SCALERBYPASS</span> <span class="o">|</span> <span class="n">FIMC_REG_CISCCTRL_ONE2ONE</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CISCCTRL_INRGB_FMT_MASK</span> <span class="o">|</span> <span class="n">FIMC_REG_CISCCTRL_OUTRGB_FMT_MASK</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CISCCTRL_INTERLACE</span> <span class="o">|</span> <span class="n">FIMC_REG_CISCCTRL_RGB_EXT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIMC_COLOR_RANGE_NARROW</span><span class="p">))</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FIMC_REG_CISCCTRL_CSCR2Y_WIDE</span> <span class="o">|</span>
			<span class="n">FIMC_REG_CISCCTRL_CSCY2R_WIDE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_SCALERBYPASS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">scaleup_h</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_SCALEUP_H</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">scaleup_v</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_SCALEUP_V</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">copy_mode</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_ONE2ONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_path</span> <span class="o">==</span> <span class="n">FIMC_IO_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">src_frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FIMC_FMT_RGB565</span>:
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_INRGB_FMT_RGB565</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIMC_FMT_RGB666</span>:
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_INRGB_FMT_RGB666</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIMC_FMT_RGB888</span>:
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_INRGB_FMT_RGB888</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_path</span> <span class="o">==</span> <span class="n">FIMC_IO_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">color</span> <span class="o">=</span> <span class="n">dst_frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">&gt;=</span> <span class="n">FIMC_FMT_RGB444</span> <span class="o">&amp;&amp;</span> <span class="n">color</span> <span class="o">&lt;=</span> <span class="n">FIMC_FMT_RGB565</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_OUTRGB_FMT_RGB565</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">==</span> <span class="n">FIMC_FMT_RGB666</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_OUTRGB_FMT_RGB666</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">color</span> <span class="o">==</span> <span class="n">FIMC_FMT_RGB888</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_OUTRGB_FMT_RGB888</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_OUTRGB_FMT_RGB888</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FIMC_SCAN_MODE_INTERLACED</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_INTERLACE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_mainscaler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_variant</span> <span class="o">*</span><span class="n">variant</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">variant</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_scaler</span> <span class="o">*</span><span class="n">sc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;main_hratio= 0x%X  main_vratio= 0x%X&quot;</span><span class="p">,</span>
	    <span class="n">sc</span><span class="o">-&gt;</span><span class="n">main_hratio</span><span class="p">,</span> <span class="n">sc</span><span class="o">-&gt;</span><span class="n">main_vratio</span><span class="p">);</span>

	<span class="n">fimc_hw_set_scaler</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCCTRL</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CISCCTRL_MHRATIO_MASK</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CISCCTRL_MVRATIO_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">variant</span><span class="o">-&gt;</span><span class="n">has_mainscaler_ext</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_MHRATIO_EXT</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">main_hratio</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_MVRATIO_EXT</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">main_vratio</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCCTRL</span><span class="p">);</span>

		<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIEXTEN</span><span class="p">);</span>

		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CIEXTEN_MVRATIO_EXT_MASK</span> <span class="o">|</span>
			 <span class="n">FIMC_REG_CIEXTEN_MHRATIO_EXT_MASK</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIEXTEN_MHRATIO_EXT</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">main_hratio</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIEXTEN_MVRATIO_EXT</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">main_vratio</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIEXTEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_MHRATIO</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">main_hratio</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_MVRATIO</span><span class="p">(</span><span class="n">sc</span><span class="o">-&gt;</span><span class="n">main_vratio</span><span class="p">);</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCCTRL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_en_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIIMGCPT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_path</span> <span class="o">==</span> <span class="n">FIMC_IO_DMA</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* one shot mode */</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIIMGCPT_CPT_FREN_ENABLE</span> <span class="o">|</span>
			<span class="n">FIMC_REG_CIIMGCPT_IMGCPTEN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Continuous frame capture mode (freerun). */</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CIIMGCPT_CPT_FREN_ENABLE</span> <span class="o">|</span>
			 <span class="n">FIMC_REG_CIIMGCPT_CPT_FRMOD_CNT</span><span class="p">);</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIIMGCPT_IMGCPTEN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIIMGCPT_IMGCPTEN_SC</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIIMGCPT_IMGCPTEN</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIIMGCPT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_effect</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_effect</span> <span class="o">*</span><span class="n">effect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">effect</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">FIMC_REG_CIIMGEFF_FIN_BYPASS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIIMGEFF_IE_SC_AFTER</span> <span class="o">|</span>
			<span class="n">FIMC_REG_CIIMGEFF_IE_ENABLE</span><span class="p">;</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FIMC_REG_CIIMGEFF_FIN_ARBITRARY</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">effect</span><span class="o">-&gt;</span><span class="n">pat_cb</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">|</span> <span class="n">effect</span><span class="o">-&gt;</span><span class="n">pat_cr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIIMGEFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_rgb_alpha</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">d_frame</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FMT_HAS_ALPHA</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCTRL</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CIOCTRL_ALPHA_OUT_MASK</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">alpha</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fimc_hw_set_in_dma_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">s_frame</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg_o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg_r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">FIMC_IO_LCDFIFO</span> <span class="o">==</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_path</span><span class="p">)</span>
		<span class="n">cfg_r</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIREAL_ISIZE_AUTOLOAD_EN</span><span class="p">;</span>

	<span class="n">cfg_o</span> <span class="o">|=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">f_height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">f_width</span><span class="p">;</span>
	<span class="n">cfg_r</span> <span class="o">|=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg_o</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_ORGISIZE</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg_r</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIREAL_ISIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_in_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">s_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_dma_offset</span> <span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="cm">/* Set the pixel offsets. */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="o">-&gt;</span><span class="n">y_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span><span class="o">-&gt;</span><span class="n">y_h</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIIYOFF</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="o">-&gt;</span><span class="n">cb_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span><span class="o">-&gt;</span><span class="n">cb_h</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIICBOFF</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset</span><span class="o">-&gt;</span><span class="n">cr_v</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">offset</span><span class="o">-&gt;</span><span class="n">cr_h</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIICROFF</span><span class="p">);</span>

	<span class="cm">/* Input original and real size. */</span>
	<span class="n">fimc_hw_set_in_dma_size</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="cm">/* Use DMA autoload only in FIFO mode. */</span>
	<span class="n">fimc_hw_en_autoload</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_path</span> <span class="o">==</span> <span class="n">FIMC_IO_LCDFIFO</span><span class="p">);</span>

	<span class="cm">/* Set the input DMA to process single frame only. */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_MSCTRL</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_MSCTRL_INFORMAT_MASK</span>
		 <span class="o">|</span> <span class="n">FIMC_REG_MSCTRL_IN_BURST_COUNT_MASK</span>
		 <span class="o">|</span> <span class="n">FIMC_REG_MSCTRL_INPUT_MASK</span>
		 <span class="o">|</span> <span class="n">FIMC_REG_MSCTRL_C_INT_IN_MASK</span>
		 <span class="o">|</span> <span class="n">FIMC_REG_MSCTRL_2P_IN_ORDER_MASK</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">FIMC_REG_MSCTRL_IN_BURST_COUNT</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
		<span class="o">|</span> <span class="n">FIMC_REG_MSCTRL_INPUT_MEMORY</span>
		<span class="o">|</span> <span class="n">FIMC_REG_MSCTRL_FIFO_CTRL_FULL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FIMC_FMT_RGB565</span><span class="p">...</span><span class="n">FIMC_FMT_RGB888</span>:
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_MSCTRL_INFORMAT_RGB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIMC_FMT_YCBCR420</span>:
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_MSCTRL_INFORMAT_YCBCR420</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colplanes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_order_2p</span> <span class="o">|</span> <span class="n">FIMC_REG_MSCTRL_C_INT_IN_2PLANE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_MSCTRL_C_INT_IN_3PLANE</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIMC_FMT_YCBYCR422</span><span class="p">...</span><span class="n">FIMC_FMT_CRYCBY422</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colplanes</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_order_1p</span>
				<span class="o">|</span> <span class="n">FIMC_REG_MSCTRL_INFORMAT_YCBCR422_1P</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_MSCTRL_INFORMAT_YCBCR422</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colplanes</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">cfg</span> <span class="o">|=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_order_2p</span>
					<span class="o">|</span> <span class="n">FIMC_REG_MSCTRL_C_INT_IN_2PLANE</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_MSCTRL_C_INT_IN_3PLANE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_MSCTRL</span><span class="p">);</span>

	<span class="cm">/* Input/output DMA linear/tiled mode. */</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIDMAPARAM</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CIDMAPARAM_TILE_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tiled_fmt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">s_frame</span><span class="p">.</span><span class="n">fmt</span><span class="p">))</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIDMAPARAM_R_64X32</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tiled_fmt</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">d_frame</span><span class="p">.</span><span class="n">fmt</span><span class="p">))</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIDMAPARAM_W_64X32</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIDMAPARAM</span><span class="p">);</span>
<span class="p">}</span>


<span class="kt">void</span> <span class="nf">fimc_hw_set_input_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_MSCTRL</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_MSCTRL_INPUT_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">in_path</span> <span class="o">==</span> <span class="n">FIMC_IO_DMA</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_MSCTRL_INPUT_MEMORY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_MSCTRL_INPUT_EXTCAM</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_MSCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_output_path</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCCTRL</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CISCCTRL_LCDPATHEN_FIFO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">out_path</span> <span class="o">==</span> <span class="n">FIMC_IO_LCDFIFO</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_LCDPATHEN_FIFO</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_input_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fimc_addr</span> <span class="o">*</span><span class="n">paddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIREAL_ISIZE</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIREAL_ISIZE_ADDR_CH_DIS</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIREAL_ISIZE</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">paddr</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIIYSA</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">paddr</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIICBSA</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">paddr</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIICRSA</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CIREAL_ISIZE_ADDR_CH_DIS</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIREAL_ISIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_output_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">fimc_addr</span> <span class="o">*</span><span class="n">paddr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">index</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">paddr</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOYSA</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">paddr</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCBSA</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">paddr</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIOCRSA</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;dst_buf[%d]: 0x%X, cb: 0x%X, cr: 0x%X&quot;</span><span class="p">,</span>
		    <span class="n">i</span><span class="p">,</span> <span class="n">paddr</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">,</span> <span class="n">paddr</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">,</span> <span class="n">paddr</span><span class="o">-&gt;</span><span class="n">cr</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">++</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIMC_MAX_OUT_BUFS</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fimc_hw_set_camera_polarity</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">fimc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">s5p_fimc_isp_info</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CIGCTRL_INVPOLPCLK</span> <span class="o">|</span> <span class="n">FIMC_REG_CIGCTRL_INVPOLVSYNC</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CIGCTRL_INVPOLHREF</span> <span class="o">|</span> <span class="n">FIMC_REG_CIGCTRL_INVPOLHSYNC</span> <span class="o">|</span>
		 <span class="n">FIMC_REG_CIGCTRL_INVPOLFIELD</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_PCLK_SAMPLE_FALLING</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_INVPOLPCLK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_VSYNC_ACTIVE_LOW</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_INVPOLVSYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_INVPOLHREF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_LOW</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_INVPOLHSYNC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_MBUS_FIELD_EVEN_LOW</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_INVPOLFIELD</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">mbus_pixfmt_desc</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">pixelcode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cisrcfmt</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">bus_width</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">mbus_pixfmt_desc</span> <span class="n">pix_desc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">,</span> <span class="n">FIMC_REG_CISRCFMT_ORDER422_YCBYCR</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_YVYU8_2X8</span><span class="p">,</span> <span class="n">FIMC_REG_CISRCFMT_ORDER422_YCRYCB</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_VYUY8_2X8</span><span class="p">,</span> <span class="n">FIMC_REG_CISRCFMT_ORDER422_CRYCBY</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">,</span> <span class="n">FIMC_REG_CISRCFMT_ORDER422_CBYCRY</span><span class="p">,</span> <span class="mi">8</span> <span class="p">},</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">fimc_hw_set_camera_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">fimc</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">s5p_fimc_isp_info</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">s_frame</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bus_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FIMC_ITU_601</span> <span class="o">||</span> <span class="n">cam</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FIMC_ITU_656</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pix_desc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">mf</span><span class="p">.</span><span class="n">code</span> <span class="o">==</span> <span class="n">pix_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pixelcode</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">cfg</span> <span class="o">=</span> <span class="n">pix_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cisrcfmt</span><span class="p">;</span>
				<span class="n">bus_width</span> <span class="o">=</span> <span class="n">pix_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_width</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pix_desc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">vfd</span><span class="p">,</span>
				 <span class="s">&quot;Camera color format not supported: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">mf</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FIMC_ITU_601</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bus_width</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
				<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISRCFMT_ITU601_8BIT</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus_width</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
				<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISRCFMT_ITU601_16BIT</span><span class="p">;</span>
		<span class="p">}</span> <span class="cm">/* else defaults to ITU-R BT.656 8-bit */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FIMC_MIPI_CSI2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fimc_fmt_is_jpeg</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">color</span><span class="p">))</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISRCFMT_ITU601_8BIT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cfg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">o_width</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">o_height</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISRCFMT</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_set_camera_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">fimc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fimc_frame</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">hoff2</span><span class="p">,</span> <span class="n">voff2</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIWDOFST</span><span class="p">);</span>

	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CIWDOFST_HOROFF_MASK</span> <span class="o">|</span> <span class="n">FIMC_REG_CIWDOFST_VEROFF_MASK</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span>  <span class="n">FIMC_REG_CIWDOFST_OFF_EN</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">offs_h</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">offs_v</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIWDOFST</span><span class="p">);</span>

	<span class="cm">/* See CIWDOFSTn register description in the datasheet for details. */</span>
	<span class="n">hoff2</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">o_width</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">offs_h</span><span class="p">;</span>
	<span class="n">voff2</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">o_height</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">offs_v</span><span class="p">;</span>
	<span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">hoff2</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">voff2</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIWDOFST2</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fimc_hw_set_camera_type</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">fimc</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">s5p_fimc_isp_info</span> <span class="o">*</span><span class="n">cam</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_vid_cap</span> <span class="o">*</span><span class="n">vid_cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">csis_data_alignment</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>

	<span class="cm">/* Select ITU B interface, disable Writeback path and test pattern. */</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CIGCTRL_TESTPAT_MASK</span> <span class="o">|</span> <span class="n">FIMC_REG_CIGCTRL_SELCAM_ITU_A</span> <span class="o">|</span>
		<span class="n">FIMC_REG_CIGCTRL_SELCAM_MIPI</span> <span class="o">|</span> <span class="n">FIMC_REG_CIGCTRL_CAMIF_SELWB</span> <span class="o">|</span>
		<span class="n">FIMC_REG_CIGCTRL_SELCAM_MIPI_A</span> <span class="o">|</span> <span class="n">FIMC_REG_CIGCTRL_CAM_JPEG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FIMC_MIPI_CSI2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_SELCAM_MIPI</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">mux_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_SELCAM_MIPI_A</span><span class="p">;</span>

		<span class="cm">/* TODO: add remaining supported formats. */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">vid_cap</span><span class="o">-&gt;</span><span class="n">mf</span><span class="p">.</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_VYUY8_2X8</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">FIMC_REG_CSIIMGFMT_YCBCR422_8BIT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_JPEG_1X8</span>:
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">FIMC_REG_CSIIMGFMT_USER</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_CAM_JPEG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">vfd</span><span class="p">,</span>
				 <span class="s">&quot;Not supported camera pixel format: %d&quot;</span><span class="p">,</span>
				 <span class="n">vid_cap</span><span class="o">-&gt;</span><span class="n">mf</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">csis_data_alignment</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">writel</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CSIIMGFMT</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FIMC_ITU_601</span> <span class="o">||</span>
		   <span class="n">cam</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FIMC_ITU_656</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">mux_id</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="cm">/* ITU-A, ITU-B: 0, 1 */</span>
			<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_SELCAM_ITU_A</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cam</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FIMC_LCD_WB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_CAMIF_SELWB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span><span class="p">(</span><span class="s">&quot;invalid camera bus type selected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_clear_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CIGCTRL_IRQ_CLR</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIGCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_enable_scaler</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCCTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_CISCCTRL_SCALERSTART</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_CISCCTRL_SCALERSTART</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISCCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_activate_input_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_MSCTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">|=</span> <span class="n">FIMC_REG_MSCTRL_ENVID</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FIMC_REG_MSCTRL_ENVID</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_MSCTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_hw_dis_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">cfg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIIMGCPT</span><span class="p">);</span>
	<span class="n">cfg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FIMC_REG_CIIMGCPT_IMGCPTEN</span> <span class="o">|</span> <span class="n">FIMC_REG_CIIMGCPT_IMGCPTEN_SC</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">cfg</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CIIMGCPT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Return an index to the buffer actually being written. */</span>
<span class="n">u32</span> <span class="nf">fimc_hw_get_frame_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">variant</span><span class="o">-&gt;</span><span class="n">has_cistatus2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISTATUS2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">reg</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">--</span><span class="n">reg</span> <span class="o">:</span> <span class="n">reg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">+</span> <span class="n">FIMC_REG_CISTATUS</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="n">FIMC_REG_CISTATUS_FRAMECNT_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		<span class="n">FIMC_REG_CISTATUS_FRAMECNT_SHIFT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Locking: the caller holds fimc-&gt;slock */</span>
<span class="kt">void</span> <span class="nf">fimc_activate_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_ctx</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fimc_hw_enable_scaler</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">fimc_dev</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="p">.</span><span class="n">enabled</span><span class="p">);</span>
	<span class="n">fimc_hw_en_capture</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fimc_deactivate_capture</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">fimc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fimc_hw_en_lastirq</span><span class="p">(</span><span class="n">fimc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">fimc_hw_dis_capture</span><span class="p">(</span><span class="n">fimc</span><span class="p">);</span>
	<span class="n">fimc_hw_enable_scaler</span><span class="p">(</span><span class="n">fimc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">fimc_hw_en_lastirq</span><span class="p">(</span><span class="n">fimc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
