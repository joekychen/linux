<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › s5p-fimc › fimc-mdevice.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>fimc-mdevice.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * S5P/EXYNOS4 SoC series camera host interface media device driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Samsung Electronics Co., Ltd.</span>
<span class="cm"> * Contact: Sylwester Nawrocki, &lt;s.nawrocki@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published</span>
<span class="cm"> * by the Free Software Foundation, either version 2 of the License,</span>
<span class="cm"> * or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/media-device.h&gt;</span>

<span class="cp">#include &quot;fimc-core.h&quot;</span>
<span class="cp">#include &quot;fimc-lite.h&quot;</span>
<span class="cp">#include &quot;fimc-mdevice.h&quot;</span>
<span class="cp">#include &quot;mipi-csis.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__fimc_md_set_camclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fimc_sensor_info</span> <span class="o">*</span><span class="n">s_info</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">on</span><span class="p">);</span>
<span class="cm">/**</span>
<span class="cm"> * fimc_pipeline_prepare - update pipeline information with subdevice pointers</span>
<span class="cm"> * @fimc: fimc device terminating the pipeline</span>
<span class="cm"> *</span>
<span class="cm"> * Caller holds the graph mutex.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">fimc_pipeline_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_pipeline</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IDX_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_PAD_FL_SINK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* source pad */</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="n">media_entity_remote_source</span><span class="p">(</span><span class="n">pad</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pad</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">media_entity_type</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">sd</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SENSOR_GROUP_ID</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_SENSOR</span><span class="p">]</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">CSIS_GROUP_ID</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_CSIS</span><span class="p">]</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FLITE_GROUP_ID</span>:
			<span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_FLITE</span><span class="p">]</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FIMC_GROUP_ID</span>:
			<span class="cm">/* No need to control FIMC subdev through subdev ops */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;%s: Unknown subdev grp_id: %#x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* sink pad */</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __subdev_set_power - change power state of a single subdev</span>
<span class="cm"> * @sd: subdevice to change power state for</span>
<span class="cm"> * @on: 1 to enable power or 0 to disable</span>
<span class="cm"> *</span>
<span class="cm"> * Return result of s_power subdev operation or -ENXIO if sd argument</span>
<span class="cm"> * is NULL. Return 0 if the subdevice does not implement s_power.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__subdev_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">use_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">use_count</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">use_count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">use_count</span><span class="p">)</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">--</span><span class="p">(</span><span class="o">*</span><span class="n">use_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_power</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fimc_pipeline_s_power - change power state of all pipeline subdevs</span>
<span class="cm"> * @fimc: fimc device terminating the pipeline</span>
<span class="cm"> * @state: true to power on, false to power off</span>
<span class="cm"> *</span>
<span class="cm"> * Needs to be called with the graph mutex held.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fimc_pipeline_s_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_pipeline</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">bool</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_SENSOR</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IDX_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">state</span> <span class="o">?</span> <span class="p">(</span><span class="n">IDX_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">:</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">__subdev_set_power</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __fimc_pipeline_initialize - update the pipeline information, enable power</span>
<span class="cm"> *                              of all pipeline subdevs and the sensor clock</span>
<span class="cm"> * @me: media entity to start graph walk with</span>
<span class="cm"> * @prep: true to acquire sensor (and csis) subdevs</span>
<span class="cm"> *</span>
<span class="cm"> * This function must be called with the graph mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__fimc_pipeline_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_pipeline</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span><span class="p">,</span> <span class="n">bool</span> <span class="n">prep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">prep</span><span class="p">)</span>
		<span class="n">fimc_pipeline_prepare</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">me</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_SENSOR</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fimc_md_set_camclk</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_SENSOR</span><span class="p">],</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fimc_pipeline_s_power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fimc_pipeline_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_pipeline</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span><span class="p">,</span>
			     <span class="n">bool</span> <span class="n">prep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">graph_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span>  <span class="n">__fimc_pipeline_initialize</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">me</span><span class="p">,</span> <span class="n">prep</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">graph_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">fimc_pipeline_initialize</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __fimc_pipeline_shutdown - disable the sensor clock and pipeline power</span>
<span class="cm"> * @fimc: fimc device terminating the pipeline</span>
<span class="cm"> *</span>
<span class="cm"> * Disable power of all subdevs in the pipeline and turn off the external</span>
<span class="cm"> * sensor clock.</span>
<span class="cm"> * Called with the graph mutex held.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__fimc_pipeline_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_pipeline</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_SENSOR</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fimc_pipeline_s_power</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">fimc_md_set_camclk</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_SENSOR</span><span class="p">],</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENXIO</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">fimc_pipeline_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_pipeline</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_SENSOR</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">graph_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__fimc_pipeline_shutdown</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">graph_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">fimc_pipeline_shutdown</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * fimc_pipeline_s_stream - invoke s_stream on pipeline subdevs</span>
<span class="cm"> * @pipeline: video pipeline structure</span>
<span class="cm"> * @on: passed as the s_stream call argument</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fimc_pipeline_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_pipeline</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_SENSOR</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IDX_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">on</span> <span class="o">?</span> <span class="p">(</span><span class="n">IDX_MAX</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">i</span> <span class="o">:</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">fimc_pipeline_s_stream</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Sensor subdevice helper functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">fimc_md_register_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">fimc_sensor_info</span> <span class="o">*</span><span class="n">s_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s_info</span> <span class="o">||</span> <span class="o">!</span><span class="n">fmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">adapter</span> <span class="o">=</span> <span class="n">i2c_get_adapter</span><span class="p">(</span><span class="n">s_info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">i2c_bus_num</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adapter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			  <span class="s">&quot;Failed to get I2C adapter %d, deferring probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">s_info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">i2c_bus_num</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sd</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev_board</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span>
				       <span class="n">s_info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">i2c_put_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			  <span class="s">&quot;Failed to acquire subdev %s, deferring probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">s_info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">v4l2_set_subdev_hostdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">s_info</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="n">SENSOR_GROUP_ID</span><span class="p">;</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Registered sensor subdevice %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">s_info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fimc_md_unregister_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">adapter</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="n">i2c_unregister_device</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span><span class="p">)</span>
		<span class="n">i2c_put_adapter</span><span class="p">(</span><span class="n">adapter</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fimc_md_register_sensor_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_platform_fimc</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">fmd</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">fd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_clients</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Runtime resume one of the FIMC entities to make sure</span>
<span class="cm">	 * the sclk_cam clocks are not globally disabled.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">!</span><span class="n">fd</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">fd</span> <span class="o">=</span> <span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_clients</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">));</span>
	<span class="n">num_clients</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_clients</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">));</span>

	<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">num_sensors</span> <span class="o">=</span> <span class="n">num_clients</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_clients</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>

		<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">isp_info</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__fimc_md_set_camclk</span><span class="p">(</span><span class="n">fmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sd</span> <span class="o">=</span> <span class="n">fimc_md_register_sensor</span><span class="p">(</span><span class="n">fmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__fimc_md_set_camclk</span><span class="p">(</span><span class="n">fmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="nb">false</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sd</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdev</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pm_runtime_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fd</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * MIPI CSIS and FIMC platform devices registration.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fimc_register_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">fimc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fimc</span> <span class="o">||</span> <span class="o">!</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">FIMC_MAX_DEVS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">fimc</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="n">FIMC_GROUP_ID</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Failed to register FIMC.%d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fimc_lite_register_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_lite</span> <span class="o">*</span><span class="n">fimc</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fimc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">FIMC_LITE_MAX_DEVS</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc_lite</span><span class="p">[</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">fimc</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="n">FLITE_GROUP_ID</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			 <span class="s">&quot;Failed to register FIMC-LITE.%d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">fimc</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">csis_register_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">CSIS_MAX_ENTITIES</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v4l2_info</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;csis%d sd: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">csis</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">sd</span> <span class="o">=</span> <span class="n">sd</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="n">CSIS_GROUP_ID</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			 <span class="s">&quot;Failed to register CSIS subdevice: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fimc_md_register_platform_entities - register FIMC and CSIS media entities</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fimc_md_register_platform_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_platform_fimc</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">fmd</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">driver</span> <span class="o">=</span> <span class="n">driver_find</span><span class="p">(</span><span class="n">FIMC_MODULE_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			 <span class="s">&quot;%s driver not found, deffering probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">FIMC_MODULE_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_for_each_device</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fmd</span><span class="p">,</span>
				     <span class="n">fimc_register_callback</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">driver</span> <span class="o">=</span> <span class="n">driver_find</span><span class="p">(</span><span class="n">FIMC_LITE_DRV_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">try_module_get</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">driver_for_each_device</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fmd</span><span class="p">,</span>
					     <span class="n">fimc_lite_register_callback</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Check if there is any sensor on the MIPI-CSI2 bus and</span>
<span class="cm">	 * if not skip the s5p-csis module loading.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">num_clients</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">isp_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">FIMC_MIPI_CSI2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">driver</span> <span class="o">=</span> <span class="n">driver_find</span><span class="p">(</span><span class="n">CSIS_DRIVER_NAME</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">v4l2_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span>
			 <span class="s">&quot;%s driver not found, deffering probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">CSIS_DRIVER_NAME</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPROBE_DEFER</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">driver_for_each_device</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fmd</span><span class="p">,</span>
				      <span class="n">csis_register_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fimc_md_unregister_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIMC_MAX_DEVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">subdev</span><span class="p">);</span>
		<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIMC_LITE_MAX_DEVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc_lite</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc_lite</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
		<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc_lite</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CSIS_MAX_ENTITIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">csis</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">csis</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sd</span><span class="p">);</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">csis</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
		<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">csis</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fmd</span><span class="o">-&gt;</span><span class="n">num_sensors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">fimc_md_unregister_sensor</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdev</span><span class="p">);</span>
		<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __fimc_md_create_fimc_links - create links to all FIMC entities</span>
<span class="cm"> * @fmd: fimc media device</span>
<span class="cm"> * @source: the source entity to create links to all fimc entities from</span>
<span class="cm"> * @sensor: sensor subdev linked to FIMC[fimc_id] entity, may be null</span>
<span class="cm"> * @pad: the source entity pad index</span>
<span class="cm"> * @fimc_id: index of the fimc device for which link should be enabled</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__fimc_md_create_fimc_sink_links</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span>
					    <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="kt">int</span> <span class="n">fimc_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_sensor_info</span> <span class="o">*</span><span class="n">s_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIMC_MAX_DEVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Some FIMC variants are not fitted with camera capture</span>
<span class="cm">		 * interface. Skip creating a link from sensor for those.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">variant</span><span class="o">-&gt;</span><span class="n">has_cam_if</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">fimc_id</span><span class="p">)</span> <span class="o">?</span> <span class="n">MEDIA_LNK_FL_ENABLED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">sink</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span>
					      <span class="n">FIMC_SD_PAD_SINK</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* Notify FIMC capture subdev entity */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_call</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">link_setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">pad</span><span class="p">],</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;created link [%s] %c&gt; [%s]&quot;</span><span class="p">,</span>
			  <span class="n">source</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">flags</span> <span class="o">?</span> <span class="sc">&#39;=&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sensor</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">s_info</span> <span class="o">=</span> <span class="n">v4l2_get_subdev_hostdata</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">s_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">s_info</span><span class="o">-&gt;</span><span class="n">host</span> <span class="o">=</span> <span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIMC_LITE_MAX_DEVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc_lite</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">fimc_id</span><span class="p">)</span> <span class="o">?</span> <span class="n">MEDIA_LNK_FL_ENABLED</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">sink</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc_lite</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">sink</span><span class="p">,</span>
					       <span class="n">FLITE_SD_PAD_SINK</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="cm">/* Notify FIMC-LITE subdev entity */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_call</span><span class="p">(</span><span class="n">sink</span><span class="p">,</span> <span class="n">link_setup</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="o">&amp;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">pad</span><span class="p">],</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;created link [%s] %c&gt; [%s]&quot;</span><span class="p">,</span>
			  <span class="n">source</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">flags</span> <span class="o">?</span> <span class="sc">&#39;=&#39;</span> <span class="o">:</span> <span class="sc">&#39;-&#39;</span><span class="p">,</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Create links from FIMC-LITE source pads to other entities */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__fimc_md_create_flite_source_links</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIMC_LITE_MAX_DEVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fimc_lite</span> <span class="o">*</span><span class="n">fimc</span> <span class="o">=</span> <span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc_lite</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fimc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">source</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
		<span class="n">sink</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
		<span class="cm">/* FIMC-LITE&#39;s subdev and video node */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">FIMC_SD_PAD_SOURCE</span><span class="p">,</span>
					       <span class="n">sink</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* TODO: create links to other entities */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fimc_md_create_links - create default links between registered entities</span>
<span class="cm"> *</span>
<span class="cm"> * Parallel interface sensor entities are connected directly to FIMC capture</span>
<span class="cm"> * entities. The sensors using MIPI CSIS bus are connected through immutable</span>
<span class="cm"> * link with CSI receiver entity specified by mux_id. Any registered CSIS</span>
<span class="cm"> * entity has a link to each registered FIMC capture entity. Enabled links</span>
<span class="cm"> * are created by default between each subsequent registered sensor and</span>
<span class="cm"> * subsequent FIMC capture entity. The number of default active links is</span>
<span class="cm"> * determined by the number of available sensors or FIMC entities,</span>
<span class="cm"> * whichever is less.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fimc_md_create_links</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span> <span class="o">*</span><span class="n">csis</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5p_fimc_isp_info</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_sensor_info</span> <span class="o">*</span><span class="n">s_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="n">sink</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">fimc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fmd</span><span class="o">-&gt;</span><span class="n">num_sensors</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">sensor</span> <span class="o">=</span> <span class="n">fmd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdev</span><span class="p">;</span>
		<span class="n">s_info</span> <span class="o">=</span> <span class="n">v4l2_get_subdev_hostdata</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s_info</span> <span class="o">||</span> <span class="o">!</span><span class="n">s_info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">source</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="n">s_info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FIMC_MIPI_CSI2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mux_id</span> <span class="o">&gt;=</span> <span class="n">CSIS_MAX_ENTITIES</span><span class="p">,</span>
				<span class="s">&quot;Wrong CSI channel id: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mux_id</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">csis</span> <span class="o">=</span> <span class="n">fmd</span><span class="o">-&gt;</span><span class="n">csis</span><span class="p">[</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mux_id</span><span class="p">].</span><span class="n">sd</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">csis</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">,</span>
				 <span class="s">&quot;MIPI-CSI interface specified &quot;</span>
				 <span class="s">&quot;but s5p-csis module is not loaded!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">csis</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">CSIS_PAD_SINK</span><span class="p">,</span>
					      <span class="n">MEDIA_LNK_FL_IMMUTABLE</span> <span class="o">|</span>
					      <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;created link [%s] =&gt; [%s]&quot;</span><span class="p">,</span>
				  <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">csis</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>

			<span class="n">source</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FIMC_ITU_601</span><span class="p">...</span><span class="n">FIMC_ITU_656</span>:
			<span class="n">source</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
			<span class="n">pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Wrong bus_type: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">__fimc_md_create_fimc_sink_links</span><span class="p">(</span><span class="n">fmd</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span>
						       <span class="n">pad</span><span class="p">,</span> <span class="n">fimc_id</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fimc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">csis</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">csis</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">source</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">csis</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="n">CSIS_PAD_SOURCE</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">__fimc_md_create_fimc_sink_links</span><span class="p">(</span><span class="n">fmd</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
						       <span class="n">pad</span><span class="p">,</span> <span class="n">fimc_id</span><span class="o">++</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Create immutable links between each FIMC&#39;s subdev and video node */</span>
	<span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_LNK_FL_IMMUTABLE</span> <span class="o">|</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIMC_MAX_DEVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">source</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
		<span class="n">sink</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">FIMC_SD_PAD_SOURCE</span><span class="p">,</span>
					      <span class="n">sink</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">__fimc_md_create_flite_source_links</span><span class="p">(</span><span class="n">fmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The peripheral sensor clock management.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">fimc_md_get_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">clk_name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clock</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIMC_MAX_CAMCLKS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">clk_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">clk_name</span><span class="p">),</span> <span class="s">&quot;sclk_cam%u&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">clock</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">clk_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">clock</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Failed to get clock: %s&quot;</span><span class="p">,</span>
				  <span class="n">clk_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">camclk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock</span> <span class="o">=</span> <span class="n">clock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fimc_md_put_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">FIMC_MAX_CAMCLKS</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_OR_NULL</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">camclk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">camclk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock</span><span class="p">);</span>
		<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">camclk</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">clock</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__fimc_md_set_camclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">fimc_sensor_info</span> <span class="o">*</span><span class="n">s_info</span><span class="p">,</span>
					 <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5p_fimc_isp_info</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">s_info</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_camclk_info</span> <span class="o">*</span><span class="n">camclk</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_id</span> <span class="o">&gt;=</span> <span class="n">FIMC_MAX_CAMCLKS</span><span class="p">)</span> <span class="o">||</span> <span class="n">fmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s_info</span><span class="o">-&gt;</span><span class="n">clk_on</span> <span class="o">==</span> <span class="n">on</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">camclk</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">camclk</span><span class="p">[</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_id</span><span class="p">];</span>

	<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;camclk %d, f: %lu, clk: %p, on: %d&quot;</span><span class="p">,</span>
	    <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_id</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_frequency</span><span class="p">,</span> <span class="n">camclk</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">camclk</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		    <span class="n">camclk</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">!=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_frequency</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">camclk</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="o">++</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clk_set_rate</span><span class="p">(</span><span class="n">camclk</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_frequency</span><span class="p">);</span>
			<span class="n">camclk</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_frequency</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">camclk</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">s_info</span><span class="o">-&gt;</span><span class="n">clk_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Enabled camclk %d: f: %lu&quot;</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_id</span><span class="p">,</span>
		    <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">camclk</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">));</span>

		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">camclk</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">camclk</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">camclk</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">);</span>
		<span class="n">s_info</span><span class="o">-&gt;</span><span class="n">clk_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="s">&quot;Disabled camclk %d&quot;</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * fimc_md_set_camclk - peripheral sensor clock setup</span>
<span class="cm"> * @sd: sensor subdev to configure sclk_cam clock for</span>
<span class="cm"> * @on: 1 to enable or 0 to disable the clock</span>
<span class="cm"> *</span>
<span class="cm"> * There are 2 separate clock outputs available in the SoC for external</span>
<span class="cm"> * image processors. These clocks are shared between all registered FIMC</span>
<span class="cm"> * devices to which sensors can be attached, either directly or through</span>
<span class="cm"> * the MIPI CSI receiver. The clock is allowed here to be used by</span>
<span class="cm"> * multiple sensors concurrently if they use same frequency.</span>
<span class="cm"> * The per sensor subdev clk_on attribute helps to synchronize accesses</span>
<span class="cm"> * to the sclk_cam clocks from the video and media device nodes.</span>
<span class="cm"> * This function should only be called when the graph mutex is held.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">fimc_md_set_camclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="n">bool</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_sensor_info</span> <span class="o">*</span><span class="n">s_info</span> <span class="o">=</span> <span class="n">v4l2_get_subdev_hostdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span> <span class="o">=</span> <span class="n">entity_to_fimc_mdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__fimc_md_set_camclk</span><span class="p">(</span><span class="n">fmd</span><span class="p">,</span> <span class="n">s_info</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fimc_md_link_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">sink</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_lite</span> <span class="o">*</span><span class="n">fimc_lite</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_dev</span> <span class="o">*</span><span class="n">fimc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_pipeline</span> <span class="o">*</span><span class="n">pipeline</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">media_entity_type</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FLITE_GROUP_ID</span>:
		<span class="n">fimc_lite</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
		<span class="n">pipeline</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fimc_lite</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FIMC_GROUP_ID</span>:
		<span class="n">fimc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
		<span class="n">pipeline</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">pipeline</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__fimc_pipeline_shutdown</span><span class="p">(</span><span class="n">pipeline</span><span class="p">);</span>
		<span class="n">pipeline</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_SENSOR</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">pipeline</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">[</span><span class="n">IDX_CSIS</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fimc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">fimc_ctrls_delete</span><span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">ctx</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Link activation. Enable power of pipeline elements only if the</span>
<span class="cm">	 * pipeline is already in use, i.e. its video node is opened.</span>
<span class="cm">	 * Recreate the controls destroyed during the link deactivation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fimc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">refcnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__fimc_pipeline_initialize</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span>
							 <span class="n">source</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">fimc_capture_ctrls_create</span><span class="p">(</span><span class="n">fimc</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fimc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fimc_lite</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fimc_lite</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__fimc_pipeline_initialize</span><span class="p">(</span><span class="n">pipeline</span><span class="p">,</span>
							 <span class="n">source</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fimc_lite</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="n">EPIPE</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fimc_md_sysfs_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">user_subdev_api</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">strlcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;Sub-device API (sub-dev)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">strlcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;V4L2 video node only API (vid-dev)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fimc_md_sysfs_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">to_platform_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">subdev_api</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;vid-dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="n">subdev_api</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;sub-dev</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">))</span>
		<span class="n">subdev_api</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">user_subdev_api</span> <span class="o">=</span> <span class="n">subdev_api</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FIMC_MAX_DEVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">fimc</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">vid_cap</span><span class="p">.</span><span class="n">user_subdev_api</span> <span class="o">=</span> <span class="n">subdev_api</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * This device attribute is to select video pipeline configuration method.</span>
<span class="cm"> * There are following valid values:</span>
<span class="cm"> *  vid-dev - for V4L2 video node API only, subdevice will be configured</span>
<span class="cm"> *  by the host driver.</span>
<span class="cm"> *  sub-dev - for media controller API, subdevs must be configured in user</span>
<span class="cm"> *  space before starting streaming.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">subdev_conf_mode</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">fimc_md_sysfs_show</span><span class="p">,</span> <span class="n">fimc_md_sysfs_store</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fimc_md_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">fmd</span> <span class="o">=</span> <span class="n">devm_kzalloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">slock</span><span class="p">);</span>
	<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;SAMSUNG S5P FIMC&quot;</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">model</span><span class="p">));</span>
	<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">link_notify</span> <span class="o">=</span> <span class="n">fimc_md_link_notify</span><span class="p">;</span>
	<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">mdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">;</span>
	<span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">notify</span> <span class="o">=</span> <span class="n">fimc_sensor_notify</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span>
		 <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Failed to register v4l2_device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="s">&quot;Failed to register media device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_md</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fimc_md_get_clocks</span><span class="p">(</span><span class="n">fmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_clk</span><span class="p">;</span>

	<span class="n">fmd</span><span class="o">-&gt;</span><span class="n">user_subdev_api</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Protect the media graph while we&#39;re registering entities */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">graph_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fimc_md_register_platform_entities</span><span class="p">(</span><span class="n">fmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fimc_md_register_sensor_entities</span><span class="p">(</span><span class="n">fmd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fimc_md_create_links</span><span class="p">(</span><span class="n">fmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev_nodes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_subdev_conf_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unlock</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">fmd</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">graph_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">graph_mutex</span><span class="p">);</span>
<span class="nl">err_clk:</span>
	<span class="n">media_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">);</span>
	<span class="n">fimc_md_put_clocks</span><span class="p">(</span><span class="n">fmd</span><span class="p">);</span>
	<span class="n">fimc_md_unregister_entities</span><span class="p">(</span><span class="n">fmd</span><span class="p">);</span>
<span class="nl">err_md:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">fimc_md_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fimc_md</span> <span class="o">*</span><span class="n">fmd</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmd</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_subdev_conf_mode</span><span class="p">);</span>
	<span class="n">fimc_md_unregister_entities</span><span class="p">(</span><span class="n">fmd</span><span class="p">);</span>
	<span class="n">media_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmd</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">);</span>
	<span class="n">fimc_md_put_clocks</span><span class="p">(</span><span class="n">fmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">fimc_md_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">fimc_md_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">fimc_md_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;s5p-fimc-md&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">}</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">fimc_md_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;s5p-csis&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">fimc_register_driver</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fimc_md_driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="n">__exit</span> <span class="nf">fimc_md_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fimc_md_driver</span><span class="p">);</span>
	<span class="n">fimc_unregister_driver</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fimc_md_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fimc_md_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sylwester Nawrocki &lt;s.nawrocki@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;S5P FIMC camera host interface/video postprocessor driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="s">&quot;2.0.1&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
