<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › s5k6aa.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>s5k6aa.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for Samsung S5K6AAFX SXGA 1/6&quot; 1.3M CMOS Image Sensor</span>
<span class="cm"> * with embedded SoC ISP.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011, Samsung Electronics Co., Ltd.</span>
<span class="cm"> * Sylwester Nawrocki &lt;s.nawrocki@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on a driver authored by Dongsoo Nathaniel Kim.</span>
<span class="cm"> * Copyright (C) 2009, Dongsoo Nathaniel Kim &lt;dongsoo45.kim@samsung.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/media.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;media/media-entity.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-subdev.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;media/s5k6aa.h&gt;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>

<span class="cp">#define DRIVER_NAME			&quot;S5K6AA&quot;</span>

<span class="cm">/* The token to indicate array termination */</span>
<span class="cp">#define S5K6AA_TERM			0xffff</span>
<span class="cp">#define S5K6AA_OUT_WIDTH_DEF		640</span>
<span class="cp">#define S5K6AA_OUT_HEIGHT_DEF		480</span>
<span class="cp">#define S5K6AA_WIN_WIDTH_MAX		1280</span>
<span class="cp">#define S5K6AA_WIN_HEIGHT_MAX		1024</span>
<span class="cp">#define S5K6AA_WIN_WIDTH_MIN		8</span>
<span class="cp">#define S5K6AA_WIN_HEIGHT_MIN		8</span>

<span class="cm">/*</span>
<span class="cm"> * H/W register Interface (0xD0000000 - 0xD0000FFF)</span>
<span class="cm"> */</span>
<span class="cp">#define AHB_MSB_ADDR_PTR		0xfcfc</span>
<span class="cp">#define GEN_REG_OFFSH			0xd000</span>
<span class="cp">#define REG_CMDWR_ADDRH			0x0028</span>
<span class="cp">#define REG_CMDWR_ADDRL			0x002a</span>
<span class="cp">#define REG_CMDRD_ADDRH			0x002c</span>
<span class="cp">#define REG_CMDRD_ADDRL			0x002e</span>
<span class="cp">#define REG_CMDBUF0_ADDR		0x0f12</span>
<span class="cp">#define REG_CMDBUF1_ADDR		0x0f10</span>

<span class="cm">/*</span>
<span class="cm"> * Host S/W Register interface (0x70000000 - 0x70002000)</span>
<span class="cm"> * The value of the two most significant address bytes is 0x7000,</span>
<span class="cm"> * (HOST_SWIF_OFFS_H). The register addresses below specify 2 LSBs.</span>
<span class="cm"> */</span>
<span class="cp">#define HOST_SWIF_OFFSH			0x7000</span>

<span class="cm">/* Initialization parameters */</span>
<span class="cm">/* Master clock frequency in KHz */</span>
<span class="cp">#define REG_I_INCLK_FREQ_L		0x01b8</span>
<span class="cp">#define REG_I_INCLK_FREQ_H		0x01ba</span>
<span class="cp">#define  MIN_MCLK_FREQ_KHZ		6000U</span>
<span class="cp">#define  MAX_MCLK_FREQ_KHZ		27000U</span>
<span class="cp">#define REG_I_USE_NPVI_CLOCKS		0x01c6</span>
<span class="cp">#define REG_I_USE_NMIPI_CLOCKS		0x01c8</span>

<span class="cm">/* Clock configurations, n = 0..2. REG_I_* frequency unit is 4 kHz. */</span>
<span class="cp">#define REG_I_OPCLK_4KHZ(n)		((n) * 6 + 0x01cc)</span>
<span class="cp">#define REG_I_MIN_OUTRATE_4KHZ(n)	((n) * 6 + 0x01ce)</span>
<span class="cp">#define REG_I_MAX_OUTRATE_4KHZ(n)	((n) * 6 + 0x01d0)</span>
<span class="cp">#define  SYS_PLL_OUT_FREQ		(48000000 / 4000)</span>
<span class="cp">#define  PCLK_FREQ_MIN			(24000000 / 4000)</span>
<span class="cp">#define  PCLK_FREQ_MAX			(48000000 / 4000)</span>
<span class="cp">#define REG_I_INIT_PARAMS_UPDATED	0x01e0</span>
<span class="cp">#define REG_I_ERROR_INFO		0x01e2</span>

<span class="cm">/* General purpose parameters */</span>
<span class="cp">#define REG_USER_BRIGHTNESS		0x01e4</span>
<span class="cp">#define REG_USER_CONTRAST		0x01e6</span>
<span class="cp">#define REG_USER_SATURATION		0x01e8</span>
<span class="cp">#define REG_USER_SHARPBLUR		0x01ea</span>

<span class="cp">#define REG_G_SPEC_EFFECTS		0x01ee</span>
<span class="cp">#define REG_G_ENABLE_PREV		0x01f0</span>
<span class="cp">#define REG_G_ENABLE_PREV_CHG		0x01f2</span>
<span class="cp">#define REG_G_NEW_CFG_SYNC		0x01f8</span>
<span class="cp">#define REG_G_PREVZOOM_IN_WIDTH		0x020a</span>
<span class="cp">#define REG_G_PREVZOOM_IN_HEIGHT	0x020c</span>
<span class="cp">#define REG_G_PREVZOOM_IN_XOFFS		0x020e</span>
<span class="cp">#define REG_G_PREVZOOM_IN_YOFFS		0x0210</span>
<span class="cp">#define REG_G_INPUTS_CHANGE_REQ		0x021a</span>
<span class="cp">#define REG_G_ACTIVE_PREV_CFG		0x021c</span>
<span class="cp">#define REG_G_PREV_CFG_CHG		0x021e</span>
<span class="cp">#define REG_G_PREV_OPEN_AFTER_CH	0x0220</span>
<span class="cp">#define REG_G_PREV_CFG_ERROR		0x0222</span>

<span class="cm">/* Preview control section. n = 0...4. */</span>
<span class="cp">#define PREG(n, x)			((n) * 0x26 + x)</span>
<span class="cp">#define REG_P_OUT_WIDTH(n)		PREG(n, 0x0242)</span>
<span class="cp">#define REG_P_OUT_HEIGHT(n)		PREG(n, 0x0244)</span>
<span class="cp">#define REG_P_FMT(n)			PREG(n, 0x0246)</span>
<span class="cp">#define REG_P_MAX_OUT_RATE(n)		PREG(n, 0x0248)</span>
<span class="cp">#define REG_P_MIN_OUT_RATE(n)		PREG(n, 0x024a)</span>
<span class="cp">#define REG_P_PVI_MASK(n)		PREG(n, 0x024c)</span>
<span class="cp">#define REG_P_CLK_INDEX(n)		PREG(n, 0x024e)</span>
<span class="cp">#define REG_P_FR_RATE_TYPE(n)		PREG(n, 0x0250)</span>
<span class="cp">#define  FR_RATE_DYNAMIC		0</span>
<span class="cp">#define  FR_RATE_FIXED			1</span>
<span class="cp">#define  FR_RATE_FIXED_ACCURATE		2</span>
<span class="cp">#define REG_P_FR_RATE_Q_TYPE(n)		PREG(n, 0x0252)</span>
<span class="cp">#define  FR_RATE_Q_BEST_FRRATE		1 </span><span class="cm">/* Binning enabled */</span><span class="cp"></span>
<span class="cp">#define  FR_RATE_Q_BEST_QUALITY		2 </span><span class="cm">/* Binning disabled */</span><span class="cp"></span>
<span class="cm">/* Frame period in 0.1 ms units */</span>
<span class="cp">#define REG_P_MAX_FR_TIME(n)		PREG(n, 0x0254)</span>
<span class="cp">#define REG_P_MIN_FR_TIME(n)		PREG(n, 0x0256)</span>
<span class="cm">/* Conversion to REG_P_[MAX/MIN]_FR_TIME value; __t: time in us */</span>
<span class="cp">#define  US_TO_FR_TIME(__t)		((__t) / 100)</span>
<span class="cp">#define  S5K6AA_MIN_FR_TIME		33300  </span><span class="cm">/* us */</span><span class="cp"></span>
<span class="cp">#define  S5K6AA_MAX_FR_TIME		650000 </span><span class="cm">/* us */</span><span class="cp"></span>
<span class="cp">#define  S5K6AA_MAX_HIGHRES_FR_TIME	666    </span><span class="cm">/* x100 us */</span><span class="cp"></span>
<span class="cm">/* The below 5 registers are for &quot;device correction&quot; values */</span>
<span class="cp">#define REG_P_COLORTEMP(n)		PREG(n, 0x025e)</span>
<span class="cp">#define REG_P_PREV_MIRROR(n)		PREG(n, 0x0262)</span>

<span class="cm">/* Extended image property controls */</span>
<span class="cm">/* Exposure time in 10 us units */</span>
<span class="cp">#define REG_SF_USR_EXPOSURE_L		0x03c6</span>
<span class="cp">#define REG_SF_USR_EXPOSURE_H		0x03c8</span>
<span class="cp">#define REG_SF_USR_EXPOSURE_CHG		0x03ca</span>
<span class="cp">#define REG_SF_USR_TOT_GAIN		0x03cc</span>
<span class="cp">#define REG_SF_USR_TOT_GAIN_CHG		0x03ce</span>
<span class="cp">#define REG_SF_RGAIN			0x03d0</span>
<span class="cp">#define REG_SF_RGAIN_CHG		0x03d2</span>
<span class="cp">#define REG_SF_GGAIN			0x03d4</span>
<span class="cp">#define REG_SF_GGAIN_CHG		0x03d6</span>
<span class="cp">#define REG_SF_BGAIN			0x03d8</span>
<span class="cp">#define REG_SF_BGAIN_CHG		0x03da</span>
<span class="cp">#define REG_SF_FLICKER_QUANT		0x03dc</span>
<span class="cp">#define REG_SF_FLICKER_QUANT_CHG	0x03de</span>

<span class="cm">/* Output interface (parallel/MIPI) setup */</span>
<span class="cp">#define REG_OIF_EN_MIPI_LANES		0x03fa</span>
<span class="cp">#define REG_OIF_EN_PACKETS		0x03fc</span>
<span class="cp">#define REG_OIF_CFG_CHG			0x03fe</span>

<span class="cm">/* Auto-algorithms enable mask */</span>
<span class="cp">#define REG_DBG_AUTOALG_EN		0x0400</span>
<span class="cp">#define  AALG_ALL_EN_MASK		(1 &lt;&lt; 0)</span>
<span class="cp">#define  AALG_AE_EN_MASK		(1 &lt;&lt; 1)</span>
<span class="cp">#define  AALG_DIVLEI_EN_MASK		(1 &lt;&lt; 2)</span>
<span class="cp">#define  AALG_WB_EN_MASK		(1 &lt;&lt; 3)</span>
<span class="cp">#define  AALG_FLICKER_EN_MASK		(1 &lt;&lt; 5)</span>
<span class="cp">#define  AALG_FIT_EN_MASK		(1 &lt;&lt; 6)</span>
<span class="cp">#define  AALG_WRHW_EN_MASK		(1 &lt;&lt; 7)</span>

<span class="cm">/* Firmware revision information */</span>
<span class="cp">#define REG_FW_APIVER			0x012e</span>
<span class="cp">#define  S5K6AAFX_FW_APIVER		0x0001</span>
<span class="cp">#define REG_FW_REVISION			0x0130</span>

<span class="cm">/* For now we use only one user configuration register set */</span>
<span class="cp">#define S5K6AA_MAX_PRESETS		1</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">s5k6aa_supply_names</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;vdd_core&quot;</span><span class="p">,</span>	<span class="cm">/* Digital core supply 1.5V (1.4V to 1.6V) */</span>
	<span class="s">&quot;vdda&quot;</span><span class="p">,</span>		<span class="cm">/* Analog power supply 2.8V (2.6V to 3.0V) */</span>
	<span class="s">&quot;vdd_reg&quot;</span><span class="p">,</span>	<span class="cm">/* Regulator input power 1.8V (1.7V to 1.9V)</span>
<span class="cm">			   or 2.8V (2.6V to 3.0) */</span>
	<span class="s">&quot;vddio&quot;</span><span class="p">,</span>	<span class="cm">/* I/O supply 1.8V (1.65V to 1.95V)</span>
<span class="cm">			   or 2.8V (2.5V to 3.1V) */</span>
<span class="p">};</span>
<span class="cp">#define S5K6AA_NUM_SUPPLIES ARRAY_SIZE(s5k6aa_supply_names)</span>

<span class="k">enum</span> <span class="n">s5k6aa_gpio_id</span> <span class="p">{</span>
	<span class="n">STBY</span><span class="p">,</span>
	<span class="n">RST</span><span class="p">,</span>
	<span class="n">GPIO_NUM</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s5k6aa_regval</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s5k6aa_pixfmt</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">colorspace</span><span class="p">;</span>
	<span class="cm">/* REG_P_FMT(x) register value */</span>
	<span class="n">u16</span> <span class="n">reg_p_fmt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s5k6aa_preset</span> <span class="p">{</span>
	<span class="cm">/* output pixel format and resolution */</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mbus_fmt</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">clk_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s5k6aa_ctrls</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="n">handler</span><span class="p">;</span>
	<span class="cm">/* Auto / manual white balance cluster */</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">awb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">gain_red</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">gain_blue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">gain_green</span><span class="p">;</span>
	<span class="cm">/* Mirror cluster */</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">hflip</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">vflip</span><span class="p">;</span>
	<span class="cm">/* Auto exposure / manual exposure and gain cluster */</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">auto_exp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">exposure</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">gain</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s5k6aa_interval</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg_fr_time</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_fract</span> <span class="n">interval</span><span class="p">;</span>
	<span class="cm">/* Maximum rectangle for the interval */</span>
	<span class="k">struct</span> <span class="n">v4l2_frmsize_discrete</span> <span class="n">size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="n">pad</span><span class="p">;</span>

	<span class="k">enum</span> <span class="n">v4l2_mbus_type</span> <span class="n">bus_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mipi_lanes</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">s_power</span><span class="p">)(</span><span class="kt">int</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">regulator_bulk_data</span> <span class="n">supplies</span><span class="p">[</span><span class="n">S5K6AA_NUM_SUPPLIES</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s5k6aa_gpio</span> <span class="n">gpio</span><span class="p">[</span><span class="n">GPIO_NUM</span><span class="p">];</span>

	<span class="cm">/* external master clock frequency */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mclk_frequency</span><span class="p">;</span>
	<span class="cm">/* ISP internal master clock frequency */</span>
	<span class="n">u16</span> <span class="n">clk_fop</span><span class="p">;</span>
	<span class="cm">/* output pixel clock frequency range */</span>
	<span class="n">u16</span> <span class="n">pclk_fmin</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pclk_fmax</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inv_hflip</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inv_vflip</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* protects the struct members below */</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">lock</span><span class="p">;</span>

	<span class="cm">/* sensor matrix scan window */</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">ccd_rect</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">s5k6aa_ctrls</span> <span class="n">ctrls</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5k6aa_preset</span> <span class="n">presets</span><span class="p">[</span><span class="n">S5K6AA_MAX_PRESETS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">s5k6aa_preset</span> <span class="o">*</span><span class="n">preset</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_interval</span> <span class="o">*</span><span class="n">fiv</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">streaming</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">apply_cfg</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">apply_crop</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">power</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">s5k6aa_regval</span> <span class="n">s5k6aa_analog_config</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Analog settings */</span>
	<span class="p">{</span> <span class="mh">0x112a</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x1132</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x113e</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x115c</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1164</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x1174</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x1178</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x077a</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x077c</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x077e</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0780</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x0782</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0784</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x0786</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0788</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x07a2</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07a4</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x07a6</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07a8</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x07b6</span><span class="p">,</span> <span class="mh">0x0000</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07b8</span><span class="p">,</span> <span class="mh">0x0002</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x07ba</span><span class="p">,</span> <span class="mh">0x0004</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07bc</span><span class="p">,</span> <span class="mh">0x0004</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x07be</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x07c0</span><span class="p">,</span> <span class="mh">0x0005</span> <span class="p">},</span> <span class="p">{</span> <span class="n">S5K6AA_TERM</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* TODO: Add RGB888 and Bayer format */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_pixfmt</span> <span class="n">s5k6aa_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">,</span>	<span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">,</span>	<span class="mi">5</span> <span class="p">},</span>
	<span class="cm">/* range 16-240 */</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">,</span>	<span class="n">V4L2_COLORSPACE_REC709</span><span class="p">,</span>	<span class="mi">6</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_RGB565_2X8_BE</span><span class="p">,</span>	<span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">,</span>	<span class="mi">0</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_interval</span> <span class="n">s5k6aa_intervals</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">1000</span><span class="p">,</span> <span class="p">{</span><span class="mi">10000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">},</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">}</span> <span class="p">},</span> <span class="cm">/* 10 fps */</span>
	<span class="p">{</span> <span class="mi">666</span><span class="p">,</span>  <span class="p">{</span><span class="mi">15000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">},</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">1024</span><span class="p">}</span> <span class="p">},</span> <span class="cm">/* 15 fps */</span>
	<span class="p">{</span> <span class="mi">500</span><span class="p">,</span>  <span class="p">{</span><span class="mi">20000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">},</span> <span class="p">{</span><span class="mi">1280</span><span class="p">,</span> <span class="mi">720</span><span class="p">}</span> <span class="p">},</span>  <span class="cm">/* 20 fps */</span>
	<span class="p">{</span> <span class="mi">400</span><span class="p">,</span>  <span class="p">{</span><span class="mi">25000</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">},</span> <span class="p">{</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">}</span> <span class="p">},</span>   <span class="cm">/* 25 fps */</span>
	<span class="p">{</span> <span class="mi">333</span><span class="p">,</span>  <span class="p">{</span><span class="mi">33300</span><span class="p">,</span> <span class="mi">1000000</span><span class="p">},</span> <span class="p">{</span><span class="mi">640</span><span class="p">,</span> <span class="mi">480</span><span class="p">}</span> <span class="p">},</span>   <span class="cm">/* 30 fps */</span>
<span class="p">};</span>

<span class="cp">#define S5K6AA_INTERVAL_DEF_INDEX 1 </span><span class="cm">/* 15 fps */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="nf">ctrl_to_sd</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5k6aa</span><span class="p">,</span> <span class="n">ctrls</span><span class="p">.</span><span class="n">handler</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="nf">to_s5k6aa</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">s5k6aa</span><span class="p">,</span> <span class="n">sd</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set initial values for all preview presets */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5k6aa_presets_data_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa_preset</span> <span class="o">*</span><span class="n">preset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">S5K6AA_MAX_PRESETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">S5K6AA_OUT_WIDTH_DEF</span><span class="p">;</span>
		<span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">S5K6AA_OUT_HEIGHT_DEF</span><span class="p">;</span>
		<span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">.</span><span class="n">code</span>	<span class="o">=</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
		<span class="n">preset</span><span class="o">-&gt;</span><span class="n">index</span>		<span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">preset</span><span class="o">-&gt;</span><span class="n">clk_id</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">preset</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">fiv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_intervals</span><span class="p">[</span><span class="n">S5K6AA_INTERVAL_DEF_INDEX</span><span class="p">];</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">preset</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">presets</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_i2c_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">wbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">};</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rbuf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">wbuf</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">buf</span> <span class="o">=</span> <span class="n">rbuf</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">val</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u16</span> <span class="o">*</span><span class="p">)</span><span class="n">rbuf</span><span class="p">));</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;i2c_read: 0x%04X : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">*</span><span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">};</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_master_send</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;i2c_write: 0x%04X : 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">4</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The command register write, assumes Command_Wr_addH = 0x7000. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_i2c_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_CMDWR_ADDRL</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s5k6aa_i2c_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_CMDBUF0_ADDR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* The command register read, assumes Command_Rd_addH = 0x7000. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_i2c_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_CMDRD_ADDRL</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s5k6aa_i2c_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_CMDBUF0_ADDR</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_write_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_regval</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">addr_incr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">S5K6AA_TERM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">addr_incr</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_i2c_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_CMDWR_ADDRL</span><span class="p">,</span>
					       <span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_i2c_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_CMDBUF0_ADDR</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Assume that msg-&gt;addr is always less than 0xfffc */</span>
		<span class="n">addr_incr</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">-</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
		<span class="n">msg</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Configure the AHB high address bytes for GTG registers access */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_ahb_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_i2c_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">AHB_MSB_ADDR_PTR</span><span class="p">,</span> <span class="n">GEN_REG_OFFSH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_i2c_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_CMDRD_ADDRH</span><span class="p">,</span> <span class="n">HOST_SWIF_OFFSH</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s5k6aa_i2c_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_CMDWR_ADDRH</span><span class="p">,</span> <span class="n">HOST_SWIF_OFFSH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s5k6aa_configure_pixel_clock - apply ISP main clock/PLL configuration</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the internal ISP PLL for the required output frequency.</span>
<span class="cm"> * Locking: called with s5k6aa.lock mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_configure_pixel_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fmclk</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">mclk_frequency</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN</span><span class="p">(</span><span class="n">fmclk</span> <span class="o">&lt;</span> <span class="n">MIN_MCLK_FREQ_KHZ</span> <span class="o">||</span> <span class="n">fmclk</span> <span class="o">&gt;</span> <span class="n">MAX_MCLK_FREQ_KHZ</span><span class="p">,</span>
		 <span class="s">&quot;Invalid clock frequency: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmclk</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">pclk_fmin</span> <span class="o">=</span> <span class="n">PCLK_FREQ_MIN</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">pclk_fmax</span> <span class="o">=</span> <span class="n">PCLK_FREQ_MAX</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">clk_fop</span> <span class="o">=</span> <span class="n">SYS_PLL_OUT_FREQ</span><span class="p">;</span>

	<span class="cm">/* External input clock frequency in kHz */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_I_INCLK_FREQ_H</span><span class="p">,</span> <span class="n">fmclk</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_I_INCLK_FREQ_L</span><span class="p">,</span> <span class="n">fmclk</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_I_USE_NPVI_CLOCKS</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* Internal PLL frequency */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_I_OPCLK_4KHZ</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">clk_fop</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_I_MIN_OUTRATE_4KHZ</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
				   <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">pclk_fmin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_I_MAX_OUTRATE_4KHZ</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
				   <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">pclk_fmax</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_I_INIT_PARAMS_UPDATED</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_read</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_I_ERROR_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="p">(</span><span class="n">status</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set horizontal and vertical image flipping */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_mirror</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">horiz_flip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vflip</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">.</span><span class="n">vflip</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">^</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">inv_vflip</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flip</span> <span class="o">=</span> <span class="p">(</span><span class="n">horiz_flip</span> <span class="o">^</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">inv_hflip</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">vflip</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_PREV_MIRROR</span><span class="p">(</span><span class="n">index</span><span class="p">),</span> <span class="n">flip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Configure auto/manual white balance and R/G/B gains */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_awb</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">awb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5k6aa_ctrls</span> <span class="o">*</span><span class="n">ctrls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_read</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_DBG_AUTOALG_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">awb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_SF_RGAIN</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain_red</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_SF_RGAIN_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_SF_GGAIN</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain_green</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_SF_GGAIN_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_SF_BGAIN</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain_blue</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_SF_BGAIN_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">awb</span> <span class="o">?</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">AALG_WB_EN_MASK</span> <span class="o">:</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">AALG_WB_EN_MASK</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_DBG_AUTOALG_EN</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Program FW with exposure time, &#39;exposure&#39; in us units */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_user_exposure</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exposure</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">time</span> <span class="o">=</span> <span class="n">exposure</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_SF_USR_EXPOSURE_L</span><span class="p">,</span> <span class="n">time</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_SF_USR_EXPOSURE_H</span><span class="p">,</span> <span class="n">time</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_SF_USR_EXPOSURE_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_user_gain</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">gain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_SF_USR_TOT_GAIN</span><span class="p">,</span> <span class="n">gain</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_SF_USR_TOT_GAIN_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set auto/manual exposure and total gain */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_auto_exposure</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">exp_time</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">.</span><span class="n">exposure</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">auto_alg</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_read</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_DBG_AUTOALG_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auto_alg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="s">&quot;man_exp: %d, auto_exp: %d, a_alg: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">exp_time</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">auto_alg</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">V4L2_EXPOSURE_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">auto_alg</span> <span class="o">|=</span> <span class="n">AALG_AE_EN_MASK</span> <span class="o">|</span> <span class="n">AALG_DIVLEI_EN_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_set_user_exposure</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">exp_time</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_set_user_gain</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">.</span><span class="n">gain</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">auto_alg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">AALG_AE_EN_MASK</span> <span class="o">|</span> <span class="n">AALG_DIVLEI_EN_MASK</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_DBG_AUTOALG_EN</span><span class="p">,</span> <span class="n">auto_alg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_anti_flicker</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">auto_alg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_DBG_AUTOALG_EN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">auto_alg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY_AUTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">auto_alg</span> <span class="o">|=</span> <span class="n">AALG_FLICKER_EN_MASK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">auto_alg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">AALG_FLICKER_EN_MASK</span><span class="p">;</span>
		<span class="cm">/* The V4L2_CID_LINE_FREQUENCY control values match</span>
<span class="cm">		 * the register values */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_SF_FLICKER_QUANT</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_SF_FLICKER_QUANT_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_DBG_AUTOALG_EN</span><span class="p">,</span> <span class="n">auto_alg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_colorfx</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_control</span> <span class="n">colorfx</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">V4L2_COLORFX_NONE</span><span class="p">,</span>	 <span class="mi">0</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_COLORFX_BW</span><span class="p">,</span>	 <span class="mi">1</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_COLORFX_NEGATIVE</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_COLORFX_SEPIA</span><span class="p">,</span>	 <span class="mi">3</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_COLORFX_SKY_BLUE</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">V4L2_COLORFX_SKETCH</span><span class="p">,</span>	 <span class="mi">5</span> <span class="p">},</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">colorfx</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">colorfx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_SPEC_EFFECTS</span><span class="p">,</span>
					    <span class="n">colorfx</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_preview_config_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_PREV_CFG_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">error</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;error: 0x%x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">error</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="p">(</span><span class="n">error</span> <span class="o">?</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_get_pixfmt_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s5k6aa_formats</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">==</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">colorspace</span> <span class="o">&amp;&amp;</span>
		    <span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_output_framefmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">s5k6aa_preset</span> <span class="o">*</span><span class="n">preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">fmt_index</span> <span class="o">=</span> <span class="n">s5k6aa_get_pixfmt_index</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_OUT_WIDTH</span><span class="p">(</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span>
			   <span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_OUT_HEIGHT</span><span class="p">(</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span>
				   <span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_FMT</span><span class="p">(</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">),</span>
				   <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="n">fmt_index</span><span class="p">].</span><span class="n">reg_p_fmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_input_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ccd_rect</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_G_PREVZOOM_IN_WIDTH</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_G_PREVZOOM_IN_HEIGHT</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_G_PREVZOOM_IN_XOFFS</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_G_PREVZOOM_IN_YOFFS</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">REG_G_INPUTS_CHANGE_REQ</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">apply_crop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s5k6aa_configure_video_bus - configure the video output interface</span>
<span class="cm"> * @bus_type: video bus type: parallel or MIPI-CSI</span>
<span class="cm"> * @nlanes: number of MIPI lanes to be used (MIPI-CSI only)</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Only parallel bus operation has been tested.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_configure_video_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span>
				      <span class="k">enum</span> <span class="n">v4l2_mbus_type</span> <span class="n">bus_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nlanes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TODO: The sensor is supposed to support BT.601 and BT.656</span>
<span class="cm">	 * but there is nothing indicating how to switch between both</span>
<span class="cm">	 * in the datasheet. For now default BT.601 interface is assumed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_type</span> <span class="o">==</span> <span class="n">V4L2_MBUS_CSI2</span><span class="p">)</span>
		<span class="n">cfg</span> <span class="o">=</span> <span class="n">nlanes</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bus_type</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_OIF_EN_MIPI_LANES</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_OIF_CFG_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This function should be called when switching to new user configuration set*/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_new_config_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">cid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">timeout</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_ACTIVE_PREV_CFG</span><span class="p">,</span> <span class="n">cid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_PREV_CFG_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_NEW_CFG_SYNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">time_is_after_jiffies</span><span class="p">(</span><span class="n">end</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_NEW_CFG_SYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reg</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s5k6aa_set_prev_config - write user preview register set</span>
<span class="cm"> *</span>
<span class="cm"> * Configure output resolution and color fromat, pixel clock</span>
<span class="cm"> * frequency range, device frame rate type and frame period range.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_prev_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">s5k6aa_preset</span> <span class="o">*</span><span class="n">preset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">preset</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">frame_rate_q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">fiv</span><span class="o">-&gt;</span><span class="n">reg_fr_time</span> <span class="o">&gt;=</span> <span class="n">S5K6AA_MAX_HIGHRES_FR_TIME</span><span class="p">)</span>
		<span class="n">frame_rate_q</span> <span class="o">=</span> <span class="n">FR_RATE_Q_BEST_FRRATE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">frame_rate_q</span> <span class="o">=</span> <span class="n">FR_RATE_Q_BEST_QUALITY</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_set_output_framefmt</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">preset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_MAX_OUT_RATE</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
				   <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">pclk_fmax</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_MIN_OUT_RATE</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
				   <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">pclk_fmin</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_CLK_INDEX</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
				   <span class="n">preset</span><span class="o">-&gt;</span><span class="n">clk_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_FR_RATE_TYPE</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
				   <span class="n">FR_RATE_DYNAMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_FR_RATE_Q_TYPE</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
				   <span class="n">frame_rate_q</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_MAX_FR_TIME</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
				   <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">fiv</span><span class="o">-&gt;</span><span class="n">reg_fr_time</span> <span class="o">+</span> <span class="mi">33</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_MIN_FR_TIME</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span>
				   <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">fiv</span><span class="o">-&gt;</span><span class="n">reg_fr_time</span> <span class="o">-</span> <span class="mi">33</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_new_config_sync</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_preview_config_status</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">apply_cfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;Frame interval: %d +/- 3.3ms. (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">fiv</span><span class="o">-&gt;</span><span class="n">reg_fr_time</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * s5k6aa_initialize_isp - basic ISP MCU initialization</span>
<span class="cm"> *</span>
<span class="cm"> * Configure AHB addresses for registers read/write; configure PLLs for</span>
<span class="cm"> * required output pixel clock. The ISP power supply needs to be already</span>
<span class="cm"> * enabled, with an optional H/W reset.</span>
<span class="cm"> * Locking: called with s5k6aa.lock mutex held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_initialize_isp</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">apply_crop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">apply_cfg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_set_ahb_address</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_configure_video_bus</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">,</span>
					 <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">mipi_lanes</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write_array</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">s5k6aa_analog_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">s5k6aa_configure_pixel_clocks</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_gpio_set_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">gpio</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">gpio</span><span class="p">,</span> <span class="o">!!</span><span class="n">val</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_gpio_assert</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">s5k6aa_gpio_set_value</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_gpio_deassert</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">s5k6aa_gpio_set_value</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">level</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__s5k6aa_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_enable</span><span class="p">(</span><span class="n">S5K6AA_NUM_SUPPLIES</span><span class="p">,</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa_gpio_deassert</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">STBY</span><span class="p">))</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">s_power</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">s_power</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">4000</span><span class="p">,</span> <span class="mi">4000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa_gpio_deassert</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">RST</span><span class="p">))</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__s5k6aa_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa_gpio_assert</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">RST</span><span class="p">))</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">s_power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">s_power</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa_gpio_assert</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">STBY</span><span class="p">))</span>
		<span class="n">usleep_range</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">S5K6AA_NUM_SUPPLIES</span><span class="p">,</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * V4L2 subdev core and video operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span> <span class="o">==</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__s5k6aa_power_on</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_initialize_isp</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__s5k6aa_power_off</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">+=</span> <span class="n">on</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">on</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">||</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__s5k6aa_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_ENABLE_PREV</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_ENABLE_PREV_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="o">!</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">apply_cfg</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_set_prev_config</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">preset</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">apply_crop</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_set_input_params</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__s5k6aa_stream</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="o">!!</span><span class="n">on</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_g_frame_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_subdev_frame_interval</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">fi</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">fiv</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__s5k6aa_set_frame_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">v4l2_subdev_frame_interval</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mbus_fmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_interval</span> <span class="o">*</span><span class="n">fiv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_intervals</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">min_err</span> <span class="o">=</span> <span class="n">UINT_MAX</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">fr_time</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fi</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">.</span><span class="n">denominator</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fr_time</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">.</span><span class="n">numerator</span> <span class="o">*</span> <span class="mi">10000</span> <span class="o">/</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">.</span><span class="n">denominator</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s5k6aa_intervals</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_interval</span> <span class="o">*</span><span class="n">iv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_intervals</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">mbus_fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">iv</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span>
		    <span class="n">mbus_fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">iv</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">reg_fr_time</span> <span class="o">-</span> <span class="n">fr_time</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="n">min_err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fiv</span> <span class="o">=</span> <span class="n">iv</span><span class="p">;</span>
			<span class="n">min_err</span> <span class="o">=</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">fiv</span> <span class="o">=</span> <span class="n">fiv</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Changed frame interval to %d us</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">fiv</span><span class="o">-&gt;</span><span class="n">reg_fr_time</span> <span class="o">*</span> <span class="mi">100</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_s_frame_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_subdev_frame_interval</span> <span class="o">*</span><span class="n">fi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Setting %d/%d frame interval</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">fi</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">.</span><span class="n">denominator</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__s5k6aa_set_frame_interval</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">fi</span><span class="p">);</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">apply_cfg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * V4L2 subdev pad level and video operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_enum_frame_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_frame_interval_enum</span> <span class="o">*</span><span class="n">fie</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_interval</span> <span class="o">*</span><span class="n">fi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fie</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s5k6aa_intervals</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fie</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">S5K6AA_WIN_WIDTH_MIN</span><span class="p">,</span>
			      <span class="n">S5K6AA_WIN_WIDTH_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">fie</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">S5K6AA_WIN_HEIGHT_MIN</span><span class="p">,</span>
			      <span class="n">S5K6AA_WIN_HEIGHT_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">fi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_intervals</span><span class="p">[</span><span class="n">fie</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fie</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span> <span class="n">fie</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fie</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="n">fi</span><span class="o">-&gt;</span><span class="n">interval</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_enum_mbus_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_mbus_code_enum</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s5k6aa_formats</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_enum_frame_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_subdev_frame_size_enum</span> <span class="o">*</span><span class="n">fse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s5k6aa_formats</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fse</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_width</span>  <span class="o">=</span> <span class="n">S5K6AA_WIN_WIDTH_MIN</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_width</span>  <span class="o">=</span> <span class="n">S5K6AA_WIN_WIDTH_MAX</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_height</span> <span class="o">=</span> <span class="n">S5K6AA_WIN_HEIGHT_MIN</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_height</span> <span class="o">=</span> <span class="n">S5K6AA_WIN_HEIGHT_MAX</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span>
<span class="nf">__s5k6aa_get_crop_rect</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ccd_rect</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v4l2_subdev_get_try_crop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5k6aa_try_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">S5K6AA_WIN_WIDTH_MIN</span><span class="p">,</span>
			      <span class="n">S5K6AA_WIN_WIDTH_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">S5K6AA_WIN_HEIGHT_MIN</span><span class="p">,</span>
			      <span class="n">S5K6AA_WIN_HEIGHT_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">!=</span> <span class="n">V4L2_COLORSPACE_JPEG</span> <span class="o">&amp;&amp;</span>
	    <span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">!=</span> <span class="n">V4L2_COLORSPACE_REC709</span><span class="p">)</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>

	<span class="n">index</span> <span class="o">=</span> <span class="n">s5k6aa_get_pixfmt_index</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_get_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5k6aa_preset</span> <span class="o">*</span><span class="n">preset</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">preset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">s5k6aa_try_format</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">);</span>
		<span class="n">crop</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_crop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">;</span>
			<span class="n">crop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ccd_rect</span><span class="p">;</span>
			<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">apply_cfg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_subdev_frame_interval</span> <span class="n">fiv</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>
		<span class="p">};</span>

		<span class="o">*</span><span class="n">mf</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Make sure the crop window is valid, i.e. its size is</span>
<span class="cm">		 * greater than the output window, as the ISP supports</span>
<span class="cm">		 * only down-scaling.</span>
<span class="cm">		 */</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
				      <span class="n">S5K6AA_WIN_WIDTH_MAX</span><span class="p">);</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
				       <span class="n">S5K6AA_WIN_HEIGHT_MAX</span><span class="p">);</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">S5K6AA_WIN_WIDTH_MAX</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span>  <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="n">S5K6AA_WIN_HEIGHT_MAX</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

		<span class="cm">/* Reset to minimum possible frame interval */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">__s5k6aa_set_frame_interval</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fiv</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_get_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_subdev_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">));</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">rect</span> <span class="o">=</span> <span class="n">__s5k6aa_get_crop_rect</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rect</span><span class="p">)</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span> <span class="o">=</span> <span class="o">*</span><span class="n">rect</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Current crop rectangle: (%d,%d)/%dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_set_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_subdev_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_x</span><span class="p">,</span> <span class="n">max_y</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop_r</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">crop_r</span> <span class="o">=</span> <span class="n">__s5k6aa_get_crop_rect</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">mbus_fmt</span><span class="p">;</span>
		<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">apply_crop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">mf</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">v4l_bound_align_image</span><span class="p">(</span><span class="o">&amp;</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
			      <span class="n">S5K6AA_WIN_WIDTH_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
			      <span class="n">S5K6AA_WIN_HEIGHT_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">max_x</span> <span class="o">=</span> <span class="p">(</span><span class="n">S5K6AA_WIN_WIDTH_MAX</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">max_y</span> <span class="o">=</span> <span class="p">(</span><span class="n">S5K6AA_WIN_HEIGHT_MAX</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_x</span><span class="p">);</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span>  <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_y</span><span class="p">);</span>

	<span class="o">*</span><span class="n">crop_r</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">rect</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;Set crop rectangle: (%d,%d)/%dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">crop_r</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">crop_r</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="n">crop_r</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">crop_r</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_pad_ops</span> <span class="n">s5k6aa_pad_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enum_mbus_code</span>		<span class="o">=</span> <span class="n">s5k6aa_enum_mbus_code</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_frame_size</span>	<span class="o">=</span> <span class="n">s5k6aa_enum_frame_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_frame_interval</span>	<span class="o">=</span> <span class="n">s5k6aa_enum_frame_interval</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fmt</span>		<span class="o">=</span> <span class="n">s5k6aa_get_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span>		<span class="o">=</span> <span class="n">s5k6aa_set_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_crop</span>		<span class="o">=</span> <span class="n">s5k6aa_get_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_crop</span>		<span class="o">=</span> <span class="n">s5k6aa_set_crop</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">s5k6aa_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_frame_interval</span>	<span class="o">=</span> <span class="n">s5k6aa_g_frame_interval</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_frame_interval</span>	<span class="o">=</span> <span class="n">s5k6aa_s_frame_interval</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_stream</span>		<span class="o">=</span> <span class="n">s5k6aa_s_stream</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * V4L2 subdev controls</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">ctrl_to_sd</span><span class="p">(</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">v4l2_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">debug</span><span class="p">,</span> <span class="n">sd</span><span class="p">,</span> <span class="s">&quot;ctrl: 0x%x, value: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * If the device is not powered up by the host driver do</span>
<span class="cm">	 * not apply any controls to H/W at this time. Instead</span>
<span class="cm">	 * the controls will be restored right after power-up.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">preset</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_set_awb</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_BRIGHTNESS</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_USER_BRIGHTNESS</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_COLORFX</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_set_colorfx</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_CONTRAST</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_USER_CONTRAST</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE_AUTO</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_set_auto_exposure</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_set_mirror</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_PREV_CFG_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_set_anti_flicker</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_SATURATION</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_USER_SATURATION</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_SHARPNESS</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_USER_SHARPBLUR</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_WHITE_BALANCE_TEMPERATURE</span>:
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_P_COLORTEMP</span><span class="p">(</span><span class="n">idx</span><span class="p">),</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">s5k6aa_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_G_PREV_CFG_CHG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">s5k6aa_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span>	<span class="o">=</span> <span class="n">s5k6aa_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_ctrl_handler_log_status</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define V4L2_CID_RED_GAIN	(V4L2_CTRL_CLASS_CAMERA | 0x1001)</span>
<span class="cp">#define V4L2_CID_GREEN_GAIN	(V4L2_CTRL_CLASS_CAMERA | 0x1002)</span>
<span class="cp">#define V4L2_CID_BLUE_GAIN	(V4L2_CTRL_CLASS_CAMERA | 0x1003)</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_config</span> <span class="n">s5k6aa_ctrls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_ctrl_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">V4L2_CID_RED_GAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Gain, Red&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">def</span>	<span class="o">=</span> <span class="mi">127</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_ctrl_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">V4L2_CID_GREEN_GAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Gain, Green&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">def</span>	<span class="o">=</span> <span class="mi">127</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_ctrl_ops</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id</span>	<span class="o">=</span> <span class="n">V4L2_CID_BLUE_GAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;Gain, Blue&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">min</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">max</span>	<span class="o">=</span> <span class="mi">256</span><span class="p">,</span>
		<span class="p">.</span><span class="n">def</span>	<span class="o">=</span> <span class="mi">127</span><span class="p">,</span>
		<span class="p">.</span><span class="n">step</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_initialize_ctrls</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_ctrl_ops</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5k6aa_ctrls</span> <span class="o">*</span><span class="n">ctrls</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ctrls</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span> <span class="o">*</span><span class="n">hdl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* Auto white balance cluster */</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">awb</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span><span class="p">,</span>
				       <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain_red</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_custom</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s5k6aa_ctrls</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain_green</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_custom</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s5k6aa_ctrls</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain_blue</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_custom</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s5k6aa_ctrls</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_auto_cluster</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">awb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">hflip</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_HFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">vflip</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_VFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_cluster</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">hflip</span><span class="p">);</span>

	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">auto_exp</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span>
				<span class="n">V4L2_CID_EXPOSURE_AUTO</span><span class="p">,</span>
				<span class="n">V4L2_EXPOSURE_MANUAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_EXPOSURE_AUTO</span><span class="p">);</span>
	<span class="cm">/* Exposure time: x 1 us */</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">exposure</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_EXPOSURE</span><span class="p">,</span>
					    <span class="mi">0</span><span class="p">,</span> <span class="mi">6000000U</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">100000U</span><span class="p">);</span>
	<span class="cm">/* Total gain: 256 &lt;=&gt; 1x */</span>
	<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">gain</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_GAIN</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">256</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_auto_cluster</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">auto_exp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY</span><span class="p">,</span>
			       <span class="n">V4L2_CID_POWER_LINE_FREQUENCY_AUTO</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">V4L2_CID_POWER_LINE_FREQUENCY_AUTO</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_new_std_menu</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_COLORFX</span><span class="p">,</span>
			       <span class="n">V4L2_COLORFX_SKY_BLUE</span><span class="p">,</span> <span class="o">~</span><span class="mh">0x6f</span><span class="p">,</span> <span class="n">V4L2_COLORFX_NONE</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_WHITE_BALANCE_TEMPERATURE</span><span class="p">,</span>
			  <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_SATURATION</span><span class="p">,</span> <span class="o">-</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span> <span class="o">-</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span> <span class="o">-</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="n">hdl</span><span class="p">,</span> <span class="n">ops</span><span class="p">,</span> <span class="n">V4L2_CID_SHARPNESS</span><span class="p">,</span> <span class="o">-</span><span class="mi">127</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hdl</span><span class="o">-&gt;</span><span class="n">error</span><span class="p">;</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="n">hdl</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="n">hdl</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * V4L2 subdev internal operations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_crop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">format</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">s5k6aa_formats</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">S5K6AA_OUT_WIDTH_DEF</span><span class="p">;</span>
	<span class="n">format</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">S5K6AA_OUT_HEIGHT_DEF</span><span class="p">;</span>
	<span class="n">format</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">S5K6AA_WIN_WIDTH_MAX</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">S5K6AA_WIN_HEIGHT_MAX</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">s5k6aa_check_fw_revision</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">api_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fw_rev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_set_ahb_address</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_FW_APIVER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">api_ver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">REG_FW_REVISION</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw_rev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;FW revision check failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="s">&quot;FW API ver.: 0x%X, FW rev.: 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">api_ver</span><span class="p">,</span> <span class="n">fw_rev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">api_ver</span> <span class="o">==</span> <span class="n">S5K6AAFX_FW_APIVER</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_registered</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__s5k6aa_power_on</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_check_fw_revision</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
		<span class="n">__s5k6aa_power_off</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_internal_ops</span> <span class="n">s5k6aa_subdev_internal_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">registered</span> <span class="o">=</span> <span class="n">s5k6aa_registered</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">s5k6aa_open</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">s5k6aa_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_power</span> <span class="o">=</span> <span class="n">s5k6aa_set_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">log_status</span> <span class="o">=</span> <span class="n">s5k6aa_log_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">s5k6aa_subdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_pad_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * GPIO setup</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_configure_gpio</span><span class="p">(</span><span class="kt">int</span> <span class="n">nr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">val</span> <span class="o">?</span> <span class="n">GPIOF_OUT_INIT_HIGH</span> <span class="o">:</span> <span class="n">GPIOF_OUT_INIT_LOW</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">nr</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gpio_request_one</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">gpio_export</span><span class="p">(</span><span class="n">nr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">s5k6aa_free_gpios</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">);</span>
		<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_configure_gpios</span><span class="p">(</span><span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_gpio</span> <span class="o">*</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_stby</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">STBY</span><span class="p">].</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">RST</span><span class="p">].</span><span class="n">gpio</span>  <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_configure_gpio</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">,</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;S5K6AA_STBY&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s5k6aa_free_gpios</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">STBY</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">gpio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">))</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">gpio</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">gpio_reset</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_configure_gpio</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">,</span> <span class="n">gpio</span><span class="o">-&gt;</span><span class="n">level</span><span class="p">,</span> <span class="s">&quot;S5K6AA_RST&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s5k6aa_free_gpios</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">[</span><span class="n">RST</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">gpio</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">))</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">gpio</span><span class="o">-&gt;</span><span class="n">gpio</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">s5k6aa_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Platform data not specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mclk_frequency</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;MCLK frequency not specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">s5k6aa</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s5k6aa</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">mclk_frequency</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">mclk_frequency</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">bus_type</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus_type</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">mipi_lanes</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nlanes</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">s_power</span>	<span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">set_power</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">inv_hflip</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">horiz_flip</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">inv_vflip</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vert_flip</span><span class="p">;</span>

	<span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">;</span>
	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s5k6aa_subdev_ops</span><span class="p">);</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">internal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s5k6aa_subdev_internal_ops</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_HAS_DEVNODE</span><span class="p">;</span>

	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV_SENSOR</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_configure_gpios</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">S5K6AA_NUM_SUPPLIES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">supply</span> <span class="o">=</span> <span class="n">s5k6aa_supply_names</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">S5K6AA_NUM_SUPPLIES</span><span class="p">,</span>
				 <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to get regulators</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_err3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">s5k6aa_initialize_ctrls</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err4</span><span class="p">;</span>

	<span class="n">s5k6aa_presets_data_init</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>

	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ccd_rect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">S5K6AA_WIN_WIDTH_MAX</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ccd_rect</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">S5K6AA_WIN_HEIGHT_MAX</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ccd_rect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">ccd_rect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_err4:</span>
	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">S5K6AA_NUM_SUPPLIES</span><span class="p">,</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
<span class="nl">out_err3:</span>
	<span class="n">s5k6aa_free_gpios</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
<span class="nl">out_err2:</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
<span class="nl">out_err1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">s5k6aa_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">s5k6aa</span> <span class="o">*</span><span class="n">s5k6aa</span> <span class="o">=</span> <span class="n">to_s5k6aa</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">S5K6AA_NUM_SUPPLIES</span><span class="p">,</span> <span class="n">s5k6aa</span><span class="o">-&gt;</span><span class="n">supplies</span><span class="p">);</span>
	<span class="n">s5k6aa_free_gpios</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">s5k6aa</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">s5k6aa_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">s5k6aa_id</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">s5k6aa_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRIVER_NAME</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">s5k6aa_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">s5k6aa_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">s5k6aa_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">s5k6aa_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Samsung S5K6AA(FX) SXGA camera driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sylwester Nawrocki &lt;s.nawrocki@samsung.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
