<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › uvc › uvc_v4l2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>uvc_v4l2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *      uvc_v4l2.c  --  USB Video Class driver - V4L2 API</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 2005-2010</span>
<span class="cm"> *          Laurent Pinchart (laurent.pinchart@ideasonboard.com)</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *      it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *      the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *      (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/version.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>

<span class="cp">#include &quot;uvcvideo.h&quot;</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * UVC ioctls</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_ioctl_ctrl_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_xu_control_mapping</span> <span class="o">*</span><span class="n">xmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">map</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">map</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">=</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">v4l2_type</span> <span class="o">=</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">v4l2_type</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">data_type</span> <span class="o">=</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">data_type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">xmap</span><span class="o">-&gt;</span><span class="n">v4l2_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span>:
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>:
		<span class="cm">/* Prevent excessive memory consumption, as well as integer</span>
<span class="cm">		 * overflows.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xmap</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">&gt;</span> <span class="n">UVC_MAX_CONTROL_MENU_ENTRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">size</span> <span class="o">=</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">);</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">menu_info</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">menu_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">,</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">map</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">=</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;Unsupported V4L2 control type &quot;</span>
			  <span class="s">&quot;%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">xmap</span><span class="o">-&gt;</span><span class="n">v4l2_type</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_add_mapping</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">map</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * V4L2 interface</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Find the frame interval closest to the requested frame interval for the</span>
<span class="cm"> * given frame format and size. This should be done by the device as part of</span>
<span class="cm"> * the Video Probe and Commit negotiation, but some hardware don&#39;t implement</span>
<span class="cm"> * that feature.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__u32</span> <span class="nf">uvc_try_frame_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">interval</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIntervalType</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u32</span> <span class="n">best</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">dist</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIntervalType</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dist</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">&gt;</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			     <span class="o">?</span> <span class="n">interval</span> <span class="o">-</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			     <span class="o">:</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">interval</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">dist</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">best</span> <span class="o">=</span> <span class="n">dist</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">interval</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">__u32</span> <span class="n">min</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">const</span> <span class="n">__u32</span> <span class="n">max</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">const</span> <span class="n">__u32</span> <span class="n">step</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

		<span class="n">interval</span> <span class="o">=</span> <span class="n">min</span> <span class="o">+</span> <span class="p">(</span><span class="n">interval</span> <span class="o">-</span> <span class="n">min</span> <span class="o">+</span> <span class="n">step</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span> <span class="o">*</span> <span class="n">step</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">interval</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
			<span class="n">interval</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">interval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_try_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_streaming_control</span> <span class="o">*</span><span class="n">probe</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_format</span> <span class="o">**</span><span class="n">uvc_format</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">**</span><span class="n">uvc_frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_format</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">rw</span><span class="p">,</span> <span class="n">rh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">d</span><span class="p">,</span> <span class="n">maxd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">interval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">fcc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fcc</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">;</span>
	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_FORMAT</span><span class="p">,</span> <span class="s">&quot;Trying format 0x%08x (%c%c%c%c): %ux%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">,</span>
			<span class="n">fcc</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">fcc</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">fcc</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">fcc</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* Check if the hardware supports the requested format. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">nformats</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">fcc</span> <span class="o">==</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">fcc</span> <span class="o">!=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_FORMAT</span><span class="p">,</span> <span class="s">&quot;Unsupported format 0x%08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find the closest image size. The distance between image sizes is</span>
<span class="cm">	 * the size in pixels of the non-overlapping regions between the</span>
<span class="cm">	 * requested size and the frame-specified size.</span>
<span class="cm">	 */</span>
	<span class="n">rw</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">rh</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">maxd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u16</span> <span class="n">w</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wWidth</span><span class="p">;</span>
		<span class="n">__u16</span> <span class="n">h</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wHeight</span><span class="p">;</span>

		<span class="n">d</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">rw</span><span class="p">)</span> <span class="o">*</span> <span class="n">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">rh</span><span class="p">);</span>
		<span class="n">d</span> <span class="o">=</span> <span class="n">w</span><span class="o">*</span><span class="n">h</span> <span class="o">+</span> <span class="n">rw</span><span class="o">*</span><span class="n">rh</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">d</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">&lt;</span> <span class="n">maxd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">maxd</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>
			<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">maxd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_FORMAT</span><span class="p">,</span> <span class="s">&quot;Unsupported size %ux%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Use the default frame interval. */</span>
	<span class="n">interval</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwDefaultFrameInterval</span><span class="p">;</span>
	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_FORMAT</span><span class="p">,</span> <span class="s">&quot;Using default frame interval %u.%u us &quot;</span>
		<span class="s">&quot;(%u.%u fps).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">interval</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">interval</span><span class="o">%</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10000000</span><span class="o">/</span><span class="n">interval</span><span class="p">,</span>
		<span class="p">(</span><span class="mi">100000000</span><span class="o">/</span><span class="n">interval</span><span class="p">)</span><span class="o">%</span><span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Set the format index, frame index and frame interval. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">probe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">probe</span><span class="p">);</span>
	<span class="n">probe</span><span class="o">-&gt;</span><span class="n">bmHint</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* dwFrameInterval */</span>
	<span class="n">probe</span><span class="o">-&gt;</span><span class="n">bFormatIndex</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">probe</span><span class="o">-&gt;</span><span class="n">bFrameIndex</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIndex</span><span class="p">;</span>
	<span class="n">probe</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span> <span class="o">=</span> <span class="n">uvc_try_frame_interval</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>
	<span class="cm">/* Some webcams stall the probe control set request when the</span>
<span class="cm">	 * dwMaxVideoFrameSize field is set to zero. The UVC specification</span>
<span class="cm">	 * clearly states that the field is read-only from the host, so this</span>
<span class="cm">	 * is a webcam bug. Set dwMaxVideoFrameSize to the value reported by</span>
<span class="cm">	 * the webcam to work around the problem.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The workaround could probably be enabled for all webcams, so the</span>
<span class="cm">	 * quirk can be removed if needed. It&#39;s currently useful to detect</span>
<span class="cm">	 * webcam bugs and fix them before they hit the market (providing</span>
<span class="cm">	 * developers test their webcams with the Linux driver as well as with</span>
<span class="cm">	 * the Windows driver).</span>
<span class="cm">	 */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">UVC_QUIRK_PROBE_EXTRAFIELDS</span><span class="p">)</span>
		<span class="n">probe</span><span class="o">-&gt;</span><span class="n">dwMaxVideoFrameSize</span> <span class="o">=</span>
			<span class="n">stream</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">dwMaxVideoFrameSize</span><span class="p">;</span>

	<span class="cm">/* Probe the device. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_probe_video</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">probe</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wWidth</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wHeight</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wWidth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">probe</span><span class="o">-&gt;</span><span class="n">dwMaxVideoFrameSize</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_format</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">uvc_format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_frame</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="o">*</span><span class="n">uvc_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_format</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">cur_format</span><span class="p">;</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">frame</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">fcc</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wWidth</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wHeight</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wWidth</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">dwMaxVideoFrameSize</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_streaming_control</span> <span class="n">probe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_format</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_v4l2_try_format</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">probe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_queue_allocated</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">probe</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">probe</span><span class="p">);</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">cur_format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_get_streamparm</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">numerator</span><span class="p">,</span> <span class="n">denominator</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">numerator</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">dwFrameInterval</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">denominator</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
	<span class="n">uvc_simplify_fraction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">numerator</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">denominator</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">333</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">parm</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">parm</span><span class="p">);</span>
	<span class="n">parm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_CAP_TIMEPERFRAME</span><span class="p">;</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">capturemode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">numerator</span><span class="p">;</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">denominator</span><span class="p">;</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">extendedmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">readbuffers</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_CAP_TIMEPERFRAME</span><span class="p">;</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">outputmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">numerator</span><span class="p">;</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">denominator</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_set_streamparm</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_streamparm</span> <span class="o">*</span><span class="n">parm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_streaming_control</span> <span class="n">probe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_fract</span> <span class="n">timeperframe</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">interval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="n">timeperframe</span> <span class="o">=</span> <span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">timeperframe</span> <span class="o">=</span> <span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">timeperframe</span><span class="p">;</span>

	<span class="n">interval</span> <span class="o">=</span> <span class="n">uvc_fraction_to_interval</span><span class="p">(</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span>
		<span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span><span class="p">);</span>
	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_FORMAT</span><span class="p">,</span> <span class="s">&quot;Setting frame interval to %u/%u (%u).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span> <span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_queue_streaming</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">probe</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">probe</span><span class="p">);</span>
	<span class="n">probe</span><span class="p">.</span><span class="n">dwFrameInterval</span> <span class="o">=</span>
		<span class="n">uvc_try_frame_interval</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>

	<span class="cm">/* Probe the device with the new settings. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_probe_video</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">probe</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">probe</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">probe</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Return the actual frame period. */</span>
	<span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">probe</span><span class="p">.</span><span class="n">dwFrameInterval</span><span class="p">;</span>
	<span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
	<span class="n">uvc_simplify_fraction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">timeperframe</span><span class="p">.</span><span class="n">denominator</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">333</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parm</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">capture</span><span class="p">.</span><span class="n">timeperframe</span> <span class="o">=</span> <span class="n">timeperframe</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">parm</span><span class="o">-&gt;</span><span class="n">parm</span><span class="p">.</span><span class="n">output</span><span class="p">.</span><span class="n">timeperframe</span> <span class="o">=</span> <span class="n">timeperframe</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Privilege management</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Privilege management is the multiple-open implementation basis. The current</span>
<span class="cm"> * implementation is completely transparent for the end-user and doesn&#39;t</span>
<span class="cm"> * require explicit use of the VIDIOC_G_PRIORITY and VIDIOC_S_PRIORITY ioctls.</span>
<span class="cm"> * Those ioctls enable finer control on the device (by making possible for a</span>
<span class="cm"> * user to request exclusive access to a device), but are not mature yet.</span>
<span class="cm"> * Switching to the V4L2 priority mechanism might be considered in the future</span>
<span class="cm"> * if this situation changes.</span>
<span class="cm"> *</span>
<span class="cm"> * Each open instance of a UVC device can either be in a privileged or</span>
<span class="cm"> * unprivileged state. Only a single instance can be in a privileged state at</span>
<span class="cm"> * a given time. Trying to perform an operation that requires privileges will</span>
<span class="cm"> * automatically acquire the required privileges if possible, or return -EBUSY</span>
<span class="cm"> * otherwise. Privileges are dismissed when closing the instance or when</span>
<span class="cm"> * freeing the video buffers using VIDIOC_REQBUFS.</span>
<span class="cm"> *</span>
<span class="cm"> * Operations that require privileges are:</span>
<span class="cm"> *</span>
<span class="cm"> * - VIDIOC_S_INPUT</span>
<span class="cm"> * - VIDIOC_S_PARM</span>
<span class="cm"> * - VIDIOC_S_FMT</span>
<span class="cm"> * - VIDIOC_REQBUFS</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_acquire_privileges</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Always succeed if the handle is already privileged. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">UVC_HANDLE_ACTIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check if the device already has a privileged handle. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UVC_HANDLE_ACTIVE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_dismiss_privileges</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">UVC_HANDLE_ACTIVE</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UVC_HANDLE_PASSIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_has_privileges</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">UVC_HANDLE_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * V4L2 file operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CALLS</span><span class="p">,</span> <span class="s">&quot;uvc_v4l2_open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">stream</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">UVC_DEV_DISCONNECTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_autopm_get_interface</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Create the device handle. */</span>
	<span class="n">handle</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handle</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_status_start</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">v4l2_fh_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vfh</span><span class="p">,</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">v4l2_fh_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vfh</span><span class="p">);</span>
	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">;</span>
	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">stream</span> <span class="o">=</span> <span class="n">stream</span><span class="p">;</span>
	<span class="n">handle</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">UVC_HANDLE_PASSIVE</span><span class="p">;</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">handle</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CALLS</span><span class="p">,</span> <span class="s">&quot;uvc_v4l2_release</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Only free resources if this is a privileged handle. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_has_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uvc_video_enable</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">uvc_free_buffers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Release the file handle. */</span>
	<span class="n">uvc_dismiss_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">v4l2_fh_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vfh</span><span class="p">);</span>
	<span class="n">v4l2_fh_exit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vfh</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uvc_status_stop</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">usb_autopm_put_interface</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">uvc_v4l2_do_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Query capabilities */</span>
	<span class="k">case</span> <span class="n">VIDIOC_QUERYCAP</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">cap</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">cap</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">cap</span><span class="p">);</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;uvcvideo&quot;</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
		<span class="n">usb_make_path</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">,</span>
			      <span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
		<span class="n">cap</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">LINUX_VERSION_CODE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span>
					  <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span>
					  <span class="o">|</span> <span class="n">V4L2_CAP_STREAMING</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get, Set &amp; Query control */</span>
	<span class="k">case</span> <span class="n">VIDIOC_QUERYCTRL</span>:
		<span class="k">return</span> <span class="n">uvc_query_v4l2_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_CTRL</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="n">xctrl</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">xctrl</span><span class="p">);</span>
		<span class="n">xctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_begin</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_get</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xctrl</span><span class="p">);</span>
		<span class="n">uvc_ctrl_rollback</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">xctrl</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_S_CTRL</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="n">xctrl</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">xctrl</span><span class="p">);</span>
		<span class="n">xctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="n">xctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_begin</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_set</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_ctrl_rollback</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_commit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xctrl</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">xctrl</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_QUERYMENU</span>:
		<span class="k">return</span> <span class="n">uvc_query_v4l2_menu</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_EXT_CTRLS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">ctrls</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_begin</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_get</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">uvc_ctrl_rollback</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
				<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_rollback</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_S_EXT_CTRLS</span>:
	<span class="k">case</span> <span class="n">VIDIOC_TRY_EXT_CTRLS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_controls</span> <span class="o">*</span><span class="n">ctrls</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_begin</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">ctrl</span><span class="p">,</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_set</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">uvc_ctrl_rollback</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
				<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">error_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">VIDIOC_S_EXT_CTRLS</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_commit</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span>
					      <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">,</span> <span class="n">ctrls</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_rollback</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get, Set &amp; Enum input */</span>
	<span class="k">case</span> <span class="n">VIDIOC_ENUMINPUT</span>:
	<span class="p">{</span>
		<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">selector</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">iterm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">index</span> <span class="o">=</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">pin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">selector</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">UVC_QUIRK_IGNORE_SELECTOR_UNIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iterm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_IS_ITERM</span><span class="p">(</span><span class="n">iterm</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">pin</span> <span class="o">=</span> <span class="n">iterm</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&lt;</span> <span class="n">selector</span><span class="o">-&gt;</span><span class="n">bNrInPins</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pin</span> <span class="o">=</span> <span class="n">selector</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">iterm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UVC_ENTITY_IS_ITERM</span><span class="p">(</span><span class="n">iterm</span><span class="p">))</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">iterm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">pin</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">iterm</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">iterm</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">pin</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">input</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">input</span><span class="p">);</span>
		<span class="n">input</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">iterm</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">iterm</span><span class="p">)</span> <span class="o">==</span> <span class="n">UVC_ITT_CAMERA</span><span class="p">)</span>
			<span class="n">input</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_INPUT</span>:
	<span class="p">{</span>
		<span class="n">u8</span> <span class="n">input</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">UVC_QUIRK_IGNORE_SELECTOR_UNIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_GET_CUR</span><span class="p">,</span>
			<span class="n">chain</span><span class="o">-&gt;</span><span class="n">selector</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span>
			<span class="n">UVC_SU_INPUT_SELECT_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span> <span class="o">=</span> <span class="n">input</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_S_INPUT</span>:
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">input</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_acquire_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">UVC_QUIRK_IGNORE_SELECTOR_UNIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">input</span> <span class="o">&gt;</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">selector</span><span class="o">-&gt;</span><span class="n">bNrInPins</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_SET_CUR</span><span class="p">,</span>
			<span class="n">chain</span><span class="o">-&gt;</span><span class="n">selector</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span>
			<span class="n">UVC_SU_INPUT_SELECT_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">input</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Try, Get, Set &amp; Enum format */</span>
	<span class="k">case</span> <span class="n">VIDIOC_ENUM_FMT</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">uvc_format</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
		<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="n">__u32</span> <span class="n">index</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">||</span>
		    <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">nformats</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memset</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">));</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

		<span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_FMT_FLAG_COMPRESSED</span><span class="p">)</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FMT_FLAG_COMPRESSED</span><span class="p">;</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="k">sizeof</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">[</span><span class="k">sizeof</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">description</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">fcc</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_TRY_FMT</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">uvc_streaming_control</span> <span class="n">probe</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">uvc_v4l2_try_format</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">probe</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_S_FMT</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_acquire_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">uvc_v4l2_set_format</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_FMT</span>:
		<span class="k">return</span> <span class="n">uvc_v4l2_get_format</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="cm">/* Frame size enumeration */</span>
	<span class="k">case</span> <span class="n">VIDIOC_ENUM_FRAMESIZES</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_frmsizeenum</span> <span class="o">*</span><span class="n">fsize</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">uvc_format</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Look for the given pixel format */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">nformats</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fcc</span> <span class="o">==</span>
					<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">fsize</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
		<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_FRMSIZE_TYPE_DISCRETE</span><span class="p">;</span>
		<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wWidth</span><span class="p">;</span>
		<span class="n">fsize</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wHeight</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Frame interval enumeration */</span>
	<span class="k">case</span> <span class="n">VIDIOC_ENUM_FRAMEINTERVALS</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_frmivalenum</span> <span class="o">*</span><span class="n">fival</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">uvc_format</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="cm">/* Look for the given pixel format and frame size */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">nformats</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">fcc</span> <span class="o">==</span>
					<span class="n">fival</span><span class="o">-&gt;</span><span class="n">pixel_format</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wWidth</span> <span class="o">==</span> <span class="n">fival</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&amp;&amp;</span>
			    <span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wHeight</span> <span class="o">==</span> <span class="n">fival</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIntervalType</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIntervalType</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_FRMIVAL_TYPE_DISCRETE</span><span class="p">;</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
			<span class="n">uvc_simplify_fraction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">discrete</span><span class="p">.</span><span class="n">denominator</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">333</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_FRMIVAL_TYPE_STEPWISE</span><span class="p">;</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">step</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">step</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
			<span class="n">uvc_simplify_fraction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">min</span><span class="p">.</span><span class="n">denominator</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">333</span><span class="p">);</span>
			<span class="n">uvc_simplify_fraction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">max</span><span class="p">.</span><span class="n">denominator</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">333</span><span class="p">);</span>
			<span class="n">uvc_simplify_fraction</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">step</span><span class="p">.</span><span class="n">numerator</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">fival</span><span class="o">-&gt;</span><span class="n">stepwise</span><span class="p">.</span><span class="n">step</span><span class="p">.</span><span class="n">denominator</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">333</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get &amp; Set streaming parameters */</span>
	<span class="k">case</span> <span class="n">VIDIOC_G_PARM</span>:
		<span class="k">return</span> <span class="n">uvc_v4l2_get_streamparm</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">VIDIOC_S_PARM</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_acquire_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">uvc_v4l2_set_streamparm</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="cm">/* Cropping and scaling */</span>
	<span class="k">case</span> <span class="n">VIDIOC_CROPCAP</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">ccap</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ccap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="o">-&gt;</span><span class="n">wWidth</span><span class="p">;</span>
		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="o">-&gt;</span><span class="n">wHeight</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">defrect</span> <span class="o">=</span> <span class="n">ccap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>

		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ccap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_G_CROP</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_CROP</span>:
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Buffers &amp; streaming */</span>
	<span class="k">case</span> <span class="n">VIDIOC_REQBUFS</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_acquire_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_alloc_buffers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">uvc_dismiss_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">VIDIOC_QUERYBUF</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uvc_has_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">uvc_query_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_QBUF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uvc_has_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">uvc_queue_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">VIDIOC_DQBUF</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uvc_has_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">uvc_dequeue_buffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span>
			<span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">VIDIOC_STREAMON</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">type</span> <span class="o">!=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uvc_has_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_video_enable</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_STREAMOFF</span>:
	<span class="p">{</span>
		<span class="kt">int</span> <span class="o">*</span><span class="n">type</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">type</span> <span class="o">!=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">uvc_has_privileges</span><span class="p">(</span><span class="n">handle</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">uvc_video_enable</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_SUBSCRIBE_EVENT</span>:
	<span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_event_subscription</span> <span class="o">*</span><span class="n">sub</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_EVENT_CTRL</span>:
			<span class="k">return</span> <span class="n">v4l2_event_subscribe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vfh</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						    <span class="o">&amp;</span><span class="n">uvc_ctrl_sub_ev_ops</span><span class="p">);</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDIOC_UNSUBSCRIBE_EVENT</span>:
		<span class="k">return</span> <span class="n">v4l2_event_unsubscribe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vfh</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">VIDIOC_DQEVENT</span>:
		<span class="k">return</span> <span class="n">v4l2_event_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vfh</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span>
					  <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">);</span>

	<span class="cm">/* Analog video standards make no sense for digital cameras. */</span>
	<span class="k">case</span> <span class="n">VIDIOC_ENUMSTD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_QUERYSTD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_G_STD</span>:
	<span class="k">case</span> <span class="n">VIDIOC_S_STD</span>:

	<span class="k">case</span> <span class="n">VIDIOC_OVERLAY</span>:

	<span class="k">case</span> <span class="n">VIDIOC_ENUMAUDIO</span>:
	<span class="k">case</span> <span class="n">VIDIOC_ENUMAUDOUT</span>:

	<span class="k">case</span> <span class="n">VIDIOC_ENUMOUTPUT</span>:
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_IOCTL</span><span class="p">,</span> <span class="s">&quot;Unsupported ioctl 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVCIOC_CTRL_MAP</span>:
		<span class="k">return</span> <span class="n">uvc_ioctl_ctrl_map</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">UVCIOC_CTRL_QUERY</span>:
		<span class="k">return</span> <span class="n">uvc_xu_ctrl_query</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_IOCTL</span><span class="p">,</span> <span class="s">&quot;Unknown ioctl 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">uvc_v4l2_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_IOCTL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="s">&quot;uvc_v4l2_ioctl(&quot;</span><span class="p">);</span>
		<span class="n">v4l_printk_ioctl</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">video_usercopy</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">uvc_v4l2_do_ioctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">struct</span> <span class="n">uvc_xu_control_mapping32</span> <span class="p">{</span>
	<span class="n">__u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">name</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">entity</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">__u8</span> <span class="n">selector</span><span class="p">;</span>

	<span class="n">__u8</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">v4l2_type</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">data_type</span><span class="p">;</span>

	<span class="n">compat_caddr_t</span> <span class="n">menu_info</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">menu_count</span><span class="p">;</span>

	<span class="n">__u32</span> <span class="n">reserved</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_get_xu_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_xu_control_mapping</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_xu_control_mapping32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_menu_info</span> <span class="n">__user</span> <span class="o">*</span><span class="n">umenus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_menu_info</span> <span class="n">__user</span> <span class="o">*</span><span class="n">kmenus</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">__copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">),</span> <span class="n">menu_info</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">__get_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">umenus</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">umenus</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">umenus</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">kmenus</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">kmenus</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kmenus</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_info</span> <span class="o">=</span> <span class="n">kmenus</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">kmenus</span><span class="p">,</span> <span class="n">umenus</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">umenus</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_put_xu_mapping</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_xu_control_mapping</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">uvc_xu_control_mapping32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_menu_info</span> <span class="n">__user</span> <span class="o">*</span><span class="n">umenus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_menu_info</span> <span class="n">__user</span> <span class="o">*</span><span class="n">kmenus</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">__copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">),</span> <span class="n">menu_info</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">__put_user</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__clear_user</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">umenus</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">umenus</span><span class="p">,</span> <span class="n">kmenus</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">umenus</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">uvc_xu_control_query32</span> <span class="p">{</span>
	<span class="n">__u8</span> <span class="n">unit</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">selector</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">query</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">data</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_get_xu_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_xu_control_query</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_xu_control_query32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">udata</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">kdata</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">__copy_from_user</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">),</span> <span class="n">data</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kp</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">udata</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">udata</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">kdata</span> <span class="o">=</span> <span class="n">compat_alloc_user_space</span><span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">kdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">kp</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">kdata</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">kdata</span><span class="p">,</span> <span class="n">udata</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_put_xu_query</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_xu_control_query</span> <span class="o">*</span><span class="n">kp</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">uvc_xu_control_query32</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">udata</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__user</span> <span class="o">*</span><span class="n">kdata</span> <span class="o">=</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">compat_caddr_t</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">))</span> <span class="o">||</span>
	    <span class="n">__copy_to_user</span><span class="p">(</span><span class="n">up</span><span class="p">,</span> <span class="n">kp</span><span class="p">,</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">up</span><span class="p">),</span> <span class="n">data</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="n">udata</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">udata</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_in_user</span><span class="p">(</span><span class="n">udata</span><span class="p">,</span> <span class="n">kdata</span><span class="p">,</span> <span class="n">kp</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define UVCIOC_CTRL_MAP32	_IOWR(&#39;u&#39;, 0x20, struct uvc_xu_control_mapping32)</span>
<span class="cp">#define UVCIOC_CTRL_QUERY32	_IOWR(&#39;u&#39;, 0x21, struct uvc_xu_control_query32)</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">uvc_v4l2_compat_ioctl32</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uvc_xu_control_mapping</span> <span class="n">xmap</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">uvc_xu_control_query</span> <span class="n">xqry</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">karg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">up</span> <span class="o">=</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="n">mm_segment_t</span> <span class="n">old_fs</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVCIOC_CTRL_MAP32</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">UVCIOC_CTRL_MAP</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_v4l2_get_xu_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">xmap</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVCIOC_CTRL_QUERY32</span>:
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">UVCIOC_CTRL_QUERY</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_v4l2_get_xu_query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">xqry</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">old_fs</span> <span class="o">=</span> <span class="n">get_fs</span><span class="p">();</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">KERNEL_DS</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_v4l2_ioctl</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">);</span>
	<span class="n">set_fs</span><span class="p">(</span><span class="n">old_fs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVCIOC_CTRL_MAP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_v4l2_put_xu_mapping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">xmap</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVCIOC_CTRL_QUERY</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_v4l2_put_xu_query</span><span class="p">(</span><span class="o">&amp;</span><span class="n">karg</span><span class="p">.</span><span class="n">xqry</span><span class="p">,</span> <span class="n">up</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">uvc_v4l2_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CALLS</span><span class="p">,</span> <span class="s">&quot;uvc_v4l2_read: not implemented.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CALLS</span><span class="p">,</span> <span class="s">&quot;uvc_v4l2_mmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uvc_queue_mmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">uvc_v4l2_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CALLS</span><span class="p">,</span> <span class="s">&quot;uvc_v4l2_poll</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uvc_queue_poll</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifndef CONFIG_MMU</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">uvc_v4l2_get_unmapped_area</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">len</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">pgoff</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CALLS</span><span class="p">,</span> <span class="s">&quot;uvc_v4l2_get_unmapped_area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">uvc_queue_get_unmapped_area</span><span class="p">(</span><span class="o">&amp;</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">,</span> <span class="n">pgoff</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">uvc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">uvc_v4l2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">uvc_v4l2_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">uvc_v4l2_ioctl</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl32</span>	<span class="o">=</span> <span class="n">uvc_v4l2_compat_ioctl32</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">uvc_v4l2_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">uvc_v4l2_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">uvc_v4l2_poll</span><span class="p">,</span>
<span class="cp">#ifndef CONFIG_MMU</span>
	<span class="p">.</span><span class="n">get_unmapped_area</span> <span class="o">=</span> <span class="n">uvc_v4l2_get_unmapped_area</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
