<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › uvc › uvc_ctrl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>uvc_ctrl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *      uvc_ctrl.c  --  USB Video Class driver - Controls</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 2005-2010</span>
<span class="cm"> *          Laurent Pinchart (laurent.pinchart@ideasonboard.com)</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *      it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *      the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *      (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>

<span class="cp">#include &quot;uvcvideo.h&quot;</span>

<span class="cp">#define UVC_CTRL_DATA_CURRENT	0</span>
<span class="cp">#define UVC_CTRL_DATA_BACKUP	1</span>
<span class="cp">#define UVC_CTRL_DATA_MIN	2</span>
<span class="cp">#define UVC_CTRL_DATA_MAX	3</span>
<span class="cp">#define UVC_CTRL_DATA_RES	4</span>
<span class="cp">#define UVC_CTRL_DATA_DEF	5</span>
<span class="cp">#define UVC_CTRL_DATA_LAST	6</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Controls</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_control_info</span> <span class="n">uvc_ctrls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_BRIGHTNESS_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_CONTRAST_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_HUE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_SATURATION_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_SHARPNESS_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_GAMMA_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_WHITE_BALANCE_TEMPERATURE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_WHITE_BALANCE_COMPONENT_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_BACKLIGHT_COMPENSATION_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_GAIN_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_POWER_LINE_FREQUENCY_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_HUE_AUTO_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_WHITE_BALANCE_TEMPERATURE_AUTO_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_WHITE_BALANCE_COMPONENT_AUTO_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_DIGITAL_MULTIPLIER_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_DIGITAL_MULTIPLIER_LIMIT_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">15</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_ANALOG_VIDEO_STANDARD_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_ANALOG_LOCK_STATUS_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_SCANNING_MODE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_AE_MODE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_AE_PRIORITY_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_EXPOSURE_TIME_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_EXPOSURE_TIME_RELATIVE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_FOCUS_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_FOCUS_RELATIVE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MIN</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_IRIS_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_IRIS_RELATIVE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_ZOOM_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_ZOOM_RELATIVE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MIN</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_PANTILT_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">11</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_PANTILT_RELATIVE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MIN</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_ROLL_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">13</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RANGE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_ROLL_RELATIVE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">14</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MIN</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_FOCUS_AUTO_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">17</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_PRIVACY_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">index</span>		<span class="o">=</span> <span class="mi">18</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span>		<span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span>
				<span class="o">|</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_menu_info</span> <span class="n">power_line_frequency_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;Disabled&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;50 Hz&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;60 Hz&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_menu_info</span> <span class="n">exposure_auto_controls</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;Auto Mode&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Manual Mode&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;Shutter Priority Mode&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">8</span><span class="p">,</span> <span class="s">&quot;Aperture Priority Mode&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">__s32</span> <span class="nf">uvc_ctrl_get_zoom</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
	<span class="n">__u8</span> <span class="n">query</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__s8</span> <span class="n">zoom</span> <span class="o">=</span> <span class="p">(</span><span class="n">__s8</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVC_GET_CUR</span>:
		<span class="k">return</span> <span class="p">(</span><span class="n">zoom</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">zoom</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="o">-</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">case</span> <span class="n">UVC_GET_MIN</span>:
	<span class="k">case</span> <span class="n">UVC_GET_MAX</span>:
	<span class="k">case</span> <span class="n">UVC_GET_RES</span>:
	<span class="k">case</span> <span class="n">UVC_GET_DEF</span>:
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_set_zoom</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
	<span class="n">__s32</span> <span class="n">value</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">abs</span><span class="p">(</span><span class="n">value</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="n">uvc_ctrl_mappings</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Brightness&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_BRIGHTNESS_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_SIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_CONTRAST</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Contrast&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_CONTRAST_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_HUE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Hue&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_HUE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_SIGNED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_id</span>	<span class="o">=</span> <span class="n">V4L2_CID_HUE_AUTO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_manual</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_SATURATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Saturation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_SATURATION_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_SHARPNESS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Sharpness&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_SHARPNESS_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_GAMMA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Gamma&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_GAMMA_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_BACKLIGHT_COMPENSATION</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Backlight Compensation&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_BACKLIGHT_COMPENSATION_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_GAIN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Gain&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_GAIN_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_POWER_LINE_FREQUENCY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Power Line Frequency&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_POWER_LINE_FREQUENCY_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_ENUM</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_info</span>	<span class="o">=</span> <span class="n">power_line_frequency_controls</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_count</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">power_line_frequency_controls</span><span class="p">),</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_HUE_AUTO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Hue, Auto&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_HUE_AUTO_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">slave_ids</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">V4L2_CID_HUE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_EXPOSURE_AUTO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Exposure, Auto&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_AE_MODE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_BITMASK</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_info</span>	<span class="o">=</span> <span class="n">exposure_auto_controls</span><span class="p">,</span>
		<span class="p">.</span><span class="n">menu_count</span>	<span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">exposure_auto_controls</span><span class="p">),</span>
		<span class="p">.</span><span class="n">slave_ids</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">V4L2_CID_EXPOSURE_ABSOLUTE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_EXPOSURE_AUTO_PRIORITY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Exposure, Auto Priority&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_AE_PRIORITY_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_EXPOSURE_ABSOLUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Exposure (Absolute)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_EXPOSURE_TIME_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_id</span>	<span class="o">=</span> <span class="n">V4L2_CID_EXPOSURE_AUTO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_manual</span>	<span class="o">=</span> <span class="n">V4L2_EXPOSURE_MANUAL</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;White Balance Temperature, Auto&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_WHITE_BALANCE_TEMPERATURE_AUTO_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">slave_ids</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">V4L2_CID_WHITE_BALANCE_TEMPERATURE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_WHITE_BALANCE_TEMPERATURE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;White Balance Temperature&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_WHITE_BALANCE_TEMPERATURE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_id</span>	<span class="o">=</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_manual</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;White Balance Component, Auto&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_WHITE_BALANCE_COMPONENT_AUTO_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">slave_ids</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">V4L2_CID_BLUE_BALANCE</span><span class="p">,</span>
				    <span class="n">V4L2_CID_RED_BALANCE</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_BLUE_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;White Balance Blue Component&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_WHITE_BALANCE_COMPONENT_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_SIGNED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_id</span>	<span class="o">=</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_manual</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_RED_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;White Balance Red Component&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_PU_WHITE_BALANCE_COMPONENT_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_SIGNED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_id</span>	<span class="o">=</span> <span class="n">V4L2_CID_AUTO_WHITE_BALANCE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_manual</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_FOCUS_ABSOLUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Focus (absolute)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_FOCUS_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_id</span>	<span class="o">=</span> <span class="n">V4L2_CID_FOCUS_AUTO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">master_manual</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_FOCUS_AUTO</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Focus, Auto&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_FOCUS_AUTO_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">slave_ids</span>	<span class="o">=</span> <span class="p">{</span> <span class="n">V4L2_CID_FOCUS_ABSOLUTE</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_IRIS_ABSOLUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Iris, Absolute&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_IRIS_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_IRIS_RELATIVE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Iris, Relative&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_IRIS_RELATIVE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_SIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_ZOOM_ABSOLUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Zoom, Absolute&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_ZOOM_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_ZOOM_CONTINUOUS</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Zoom, Continuous&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_ZOOM_RELATIVE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_SIGNED</span><span class="p">,</span>
		<span class="p">.</span><span class="n">get</span>		<span class="o">=</span> <span class="n">uvc_ctrl_get_zoom</span><span class="p">,</span>
		<span class="p">.</span><span class="n">set</span>		<span class="o">=</span> <span class="n">uvc_ctrl_set_zoom</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_PAN_ABSOLUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Pan (Absolute)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_PANTILT_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_TILT_ABSOLUTE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Tilt (Absolute)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_PANTILT_ABSOLUTE_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">32</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_UNSIGNED</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">id</span>		<span class="o">=</span> <span class="n">V4L2_CID_PRIVACY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Privacy&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">entity</span>		<span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">,</span>
		<span class="p">.</span><span class="n">selector</span>	<span class="o">=</span> <span class="n">UVC_CT_PRIVACY_CONTROL</span><span class="p">,</span>
		<span class="p">.</span><span class="n">size</span>		<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">v4l2_type</span>	<span class="o">=</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data_type</span>	<span class="o">=</span> <span class="n">UVC_CTRL_DATA_TYPE_BOOLEAN</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Utility functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">__u8</span> <span class="o">*</span><span class="nf">uvc_ctrl_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">uvc_data</span> <span class="o">+</span> <span class="n">id</span> <span class="o">*</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">uvc_test_bit</span><span class="p">(</span><span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">uvc_clear_bit</span><span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">data</span><span class="p">[</span><span class="n">bit</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bit</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Extract the bit string specified by mapping-&gt;offset and mapping-&gt;size</span>
<span class="cm"> * from the little-endian data stored at &#39;data&#39; and return the result as</span>
<span class="cm"> * a signed 32bit integer. Sign extension will be performed if the mapping</span>
<span class="cm"> * references a signed data type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__s32</span> <span class="nf">uvc_get_le_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
	<span class="n">__u8</span> <span class="n">query</span><span class="p">,</span> <span class="k">const</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">__s32</span> <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mask</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">+=</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">bits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">data</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__u8</span> <span class="n">byte</span> <span class="o">=</span> <span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="n">offset</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="o">-</span><span class="n">offset</span><span class="p">));</span>
		<span class="n">bits</span> <span class="o">-=</span> <span class="mi">8</span> <span class="o">-</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">offset</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">-=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sign-extend the value if needed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">data_type</span> <span class="o">==</span> <span class="n">UVC_CTRL_DATA_TYPE_SIGNED</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">|=</span> <span class="o">-</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Set the bit string specified by mapping-&gt;offset and mapping-&gt;size</span>
<span class="cm"> * in the little-endian data stored at &#39;data&#39; to the value &#39;value&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_set_le_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
	<span class="n">__s32</span> <span class="n">value</span><span class="p">,</span> <span class="n">__u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bits</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/* According to the v4l2 spec, writing any value to a button control</span>
<span class="cm">	 * should result in the action belonging to the button control being</span>
<span class="cm">	 * triggered. UVC devices however want to see a 1 written -&gt; override</span>
<span class="cm">	 * value.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">v4l2_type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">+=</span> <span class="n">offset</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">bits</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">data</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1LL</span> <span class="o">&lt;&lt;</span> <span class="n">bits</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">;</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">data</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">offset</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">&gt;&gt;=</span> <span class="n">offset</span> <span class="o">?</span> <span class="n">offset</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">-=</span> <span class="mi">8</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Terminal and unit management</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">uvc_processing_guid</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">UVC_GUID_UVC_PROCESSING</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">uvc_camera_guid</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">UVC_GUID_UVC_CAMERA</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">uvc_media_transport_input_guid</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span>
	<span class="n">UVC_GUID_UVC_MEDIA_TRANSPORT_INPUT</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_entity_match_guid</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span>
	<span class="k">const</span> <span class="n">__u8</span> <span class="n">guid</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVC_ITT_CAMERA</span>:
		<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">uvc_camera_guid</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_ITT_MEDIA_TRANSPORT_INPUT</span>:
		<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">uvc_media_transport_input_guid</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_PROCESSING_UNIT</span>:
		<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">uvc_processing_guid</span><span class="p">,</span> <span class="n">guid</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_EXTENSION_UNIT</span>:
		<span class="k">return</span> <span class="n">memcmp</span><span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">guidExtensionCode</span><span class="p">,</span>
			      <span class="n">guid</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * UVC Controls</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__uvc_find_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="n">__u32</span> <span class="n">v4l2_id</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">**</span><span class="n">mapping</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">**</span><span class="n">control</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">next</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entity</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mappings</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">v4l2_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
				<span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">mapping</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="n">mapping</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&gt;</span> <span class="n">v4l2_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="n">ctrl</span><span class="p">;</span>
				<span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">map</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="nf">uvc_find_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="n">__u32</span> <span class="n">v4l2_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">**</span><span class="n">mapping</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next</span> <span class="o">=</span> <span class="n">v4l2_id</span> <span class="o">&amp;</span> <span class="n">V4L2_CTRL_FLAG_NEXT_CTRL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Mask the query flags. */</span>
	<span class="n">v4l2_id</span> <span class="o">&amp;=</span> <span class="n">V4L2_CTRL_ID_MASK</span><span class="p">;</span>

	<span class="cm">/* Find the control. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__uvc_find_control</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">v4l2_id</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">next</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">next</span><span class="p">)</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;Control 0x%08x not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">v4l2_id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ctrl</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_ctrl_populate_cache</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_GET_DEF</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				     <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
				     <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_DEF</span><span class="p">),</span>
				     <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_MIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_GET_MIN</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				     <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
				     <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_MIN</span><span class="p">),</span>
				     <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_GET_MAX</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				     <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
				     <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_MAX</span><span class="p">),</span>
				     <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_GET_RES</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				     <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
				     <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_RES</span><span class="p">),</span>
				     <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="n">UVC_VC_EXTENSION_UNIT</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

			<span class="cm">/* GET_RES is mandatory for XU controls, but some</span>
<span class="cm">			 * cameras still choke on it. Ignore errors and set the</span>
<span class="cm">			 * resolution value to zero.</span>
<span class="cm">			 */</span>
			<span class="n">uvc_warn_once</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_WARN_XU_GET_RES</span><span class="p">,</span>
				      <span class="s">&quot;UVC non compliance - GET_RES failed on &quot;</span>
				      <span class="s">&quot;an XU control. Enabling workaround.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_RES</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span>
			       <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cached</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__uvc_ctrl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_menu_info</span> <span class="o">*</span><span class="n">menu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">loaded</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_GET_CUR</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				<span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
				<span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_CURRENT</span><span class="p">),</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_CUR</span><span class="p">,</span>
		<span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_CURRENT</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">v4l2_type</span> <span class="o">==</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">menu</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">menu</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__uvc_query_v4l2_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">v4l2_ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">master_map</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">master_ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_menu_info</span> <span class="o">*</span><span class="n">menu</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">v4l2_ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">v4l2_ctrl</span><span class="p">);</span>
	<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">v4l2_type</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span><span class="p">))</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_WRITE_ONLY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span><span class="p">))</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_READ_ONLY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">master_id</span><span class="p">)</span>
		<span class="n">__uvc_find_control</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">master_id</span><span class="p">,</span>
				   <span class="o">&amp;</span><span class="n">master_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">master_ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">master_ctrl</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">master_ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">val</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">__uvc_ctrl_get</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">master_ctrl</span><span class="p">,</span> <span class="n">master_map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">master_manual</span><span class="p">)</span>
				<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_INACTIVE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_populate_cache</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_DEF</span><span class="p">,</span>
				<span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_DEF</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">v4l2_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>:
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">menu</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">,</span> <span class="o">++</span><span class="n">menu</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">menu</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">==</span> <span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">default_value</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span>:
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BUTTON</span>:
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_MIN</span><span class="p">)</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_MIN</span><span class="p">,</span>
				     <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_MIN</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span><span class="p">)</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_MAX</span><span class="p">,</span>
				     <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_MAX</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span><span class="p">)</span>
		<span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">step</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_RES</span><span class="p">,</span>
				  <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_RES</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">uvc_query_v4l2_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">v4l2_ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">uvc_find_control</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">v4l2_ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__uvc_query_v4l2_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">v4l2_ctrl</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mapping V4L2 controls to UVC controls can be straighforward if done well.</span>
<span class="cm"> * Most of the UVC controls exist in V4L2, and can be mapped directly. Some</span>
<span class="cm"> * must be grouped (for instance the Red Balance, Blue Balance and Do White</span>
<span class="cm"> * Balance V4L2 controls use the White Balance Component UVC control) or</span>
<span class="cm"> * otherwise translated. The approach we take here is to use a translation</span>
<span class="cm"> * table for the controls that can be mapped directly, and handle the others</span>
<span class="cm"> * manually.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">uvc_query_v4l2_menu</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_querymenu</span> <span class="o">*</span><span class="n">query_menu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_menu_info</span> <span class="o">*</span><span class="n">menu_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span> <span class="o">=</span> <span class="n">query_menu</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span> <span class="o">=</span> <span class="n">query_menu</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">query_menu</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">query_menu</span><span class="p">));</span>
	<span class="n">query_menu</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">query_menu</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">uvc_find_control</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">query_menu</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">v4l2_type</span> <span class="o">!=</span> <span class="n">V4L2_CTRL_TYPE_MENU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">query_menu</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">menu_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">[</span><span class="n">query_menu</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">data_type</span> <span class="o">==</span> <span class="n">UVC_CTRL_DATA_TYPE_BITMASK</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s32</span> <span class="n">bitmap</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_populate_cache</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">bitmap</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_RES</span><span class="p">,</span>
				      <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_RES</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bitmap</span> <span class="o">&amp;</span> <span class="n">menu_info</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">query_menu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">menu_info</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">query_menu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm"> * Ctrl event handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_fill_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_event</span> <span class="o">*</span><span class="n">ev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
	<span class="n">s32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="n">v4l2_ctrl</span><span class="p">;</span>

	<span class="n">__uvc_query_v4l2_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4l2_ctrl</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">));</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_EVENT_CTRL</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">v4l2_ctrl</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">changes</span> <span class="o">=</span> <span class="n">changes</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">v4l2_ctrl</span><span class="p">.</span><span class="n">type</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">v4l2_ctrl</span><span class="p">.</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">minimum</span> <span class="o">=</span> <span class="n">v4l2_ctrl</span><span class="p">.</span><span class="n">minimum</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">v4l2_ctrl</span><span class="p">.</span><span class="n">maximum</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">step</span> <span class="o">=</span> <span class="n">v4l2_ctrl</span><span class="p">.</span><span class="n">step</span><span class="p">;</span>
	<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">ctrl</span><span class="p">.</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">v4l2_ctrl</span><span class="p">.</span><span class="n">default_value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_send_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span>
	<span class="n">s32</span> <span class="n">value</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subscribed_event</span> <span class="o">*</span><span class="n">sev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_event</span> <span class="n">ev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">ev_subs</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">uvc_ctrl_fill_event</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">changes</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">ev_subs</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">vfh</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_EVENT_SUB_FL_ALLOW_FEEDBACK</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">changes</span> <span class="o">&amp;</span> <span class="n">V4L2_EVENT_CTRL_CH_FLAGS</span><span class="p">)))</span>
			<span class="n">v4l2_event_queue_fh</span><span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_send_slave_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="n">u32</span> <span class="n">slave_id</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">xctrls</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xctrls_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changes</span> <span class="o">=</span> <span class="n">V4L2_EVENT_CTRL_CH_FLAGS</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We can skip sending an event for the slave if the slave</span>
<span class="cm">	 * is being modified in the same transaction.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xctrls_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xctrls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">slave_id</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__uvc_find_control</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">slave_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__uvc_ctrl_get</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">changes</span> <span class="o">|=</span> <span class="n">V4L2_EVENT_CTRL_CH_VALUE</span><span class="p">;</span>

	<span class="n">uvc_ctrl_send_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">changes</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_send_events</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">xctrls</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xctrls_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">changes</span> <span class="o">=</span> <span class="n">V4L2_EVENT_CTRL_CH_VALUE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xctrls_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">uvc_find_control</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="n">xctrls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">slave_ids</span><span class="p">);</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">slave_ids</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">uvc_ctrl_send_slave_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span>
						  <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">slave_ids</span><span class="p">[</span><span class="n">j</span><span class="p">],</span>
						  <span class="n">xctrls</span><span class="p">,</span> <span class="n">xctrls_count</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the master is being modified in the same transaction</span>
<span class="cm">		 * flags may change too.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">master_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">xctrls_count</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">xctrls</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">id</span> <span class="o">==</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">master_id</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">changes</span> <span class="o">|=</span> <span class="n">V4L2_EVENT_CTRL_CH_FLAGS</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">uvc_ctrl_send_event</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">xctrls</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">value</span><span class="p">,</span>
				    <span class="n">changes</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_ctrl_add_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subscribed_event</span> <span class="o">*</span><span class="n">sev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">elems</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_fh</span><span class="p">,</span> <span class="n">vfh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">uvc_find_control</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="n">sev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">ev_subs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_EVENT_SUB_FL_SEND_INITIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_event</span> <span class="n">ev</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">changes</span> <span class="o">=</span> <span class="n">V4L2_EVENT_CTRL_CH_FLAGS</span><span class="p">;</span>
		<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">__uvc_ctrl_get</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">changes</span> <span class="o">|=</span> <span class="n">V4L2_EVENT_CTRL_CH_VALUE</span><span class="p">;</span>

		<span class="n">uvc_ctrl_fill_event</span><span class="p">(</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
				    <span class="n">changes</span><span class="p">);</span>
		<span class="cm">/* Mark the queue as active, allowing this initial</span>
<span class="cm">		   event to be accepted. */</span>
		<span class="n">sev</span><span class="o">-&gt;</span><span class="n">elems</span> <span class="o">=</span> <span class="n">elems</span><span class="p">;</span>
		<span class="n">v4l2_event_queue_fh</span><span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ev</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_del_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subscribed_event</span> <span class="o">*</span><span class="n">sev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_fh</span><span class="p">,</span> <span class="n">vfh</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sev</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subscribed_event_ops</span> <span class="n">uvc_ctrl_sub_ev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">uvc_ctrl_add_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del</span> <span class="o">=</span> <span class="n">uvc_ctrl_del_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">replace</span> <span class="o">=</span> <span class="n">v4l2_ctrl_replace</span><span class="p">,</span>
	<span class="p">.</span><span class="n">merge</span> <span class="o">=</span> <span class="n">v4l2_ctrl_merge</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm"> * Control transactions</span>
<span class="cm"> *</span>
<span class="cm"> * To make extended set operations as atomic as the hardware allows, controls</span>
<span class="cm"> * are handled using begin/commit/rollback operations.</span>
<span class="cm"> *</span>
<span class="cm"> * At the beginning of a set request, uvc_ctrl_begin should be called to</span>
<span class="cm"> * initialize the request. This function acquires the control lock.</span>
<span class="cm"> *</span>
<span class="cm"> * When setting a control, the new value is stored in the control data field</span>
<span class="cm"> * at position UVC_CTRL_DATA_CURRENT. The control is then marked as dirty for</span>
<span class="cm"> * later processing. If the UVC and V4L2 control sizes differ, the current</span>
<span class="cm"> * value is loaded from the hardware before storing the new value in the data</span>
<span class="cm"> * field.</span>
<span class="cm"> *</span>
<span class="cm"> * After processing all controls in the transaction, uvc_ctrl_commit or</span>
<span class="cm"> * uvc_ctrl_rollback must be called to apply the pending changes to the</span>
<span class="cm"> * hardware or revert them. When applying changes, all controls marked as</span>
<span class="cm"> * dirty will be modified in the UVC device, and the dirty flag will be</span>
<span class="cm"> * cleared. When reverting controls, the control data field</span>
<span class="cm"> * UVC_CTRL_DATA_CURRENT is reverted to its previous value</span>
<span class="cm"> * (UVC_CTRL_DATA_BACKUP) for all dirty controls. Both functions release the</span>
<span class="cm"> * control lock.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">uvc_ctrl_begin</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="n">ERESTARTSYS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_ctrl_commit_entity</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rollback</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entity</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Reset the loaded flag for auto-update controls that were</span>
<span class="cm">		 * marked as loaded in uvc_ctrl_get/uvc_ctrl_set to prevent</span>
<span class="cm">		 * uvc_ctrl_get from using the cached value, and for write-only</span>
<span class="cm">		 * controls to prevent uvc_ctrl_set from setting bits not</span>
<span class="cm">		 * explicitly set by the user.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span><span class="p">))</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rollback</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_SET_CUR</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
				<span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_CURRENT</span><span class="p">),</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rollback</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_CURRENT</span><span class="p">),</span>
			       <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_BACKUP</span><span class="p">),</span>
			       <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">__uvc_ctrl_commit</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_fh</span> <span class="o">*</span><span class="n">handle</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rollback</span><span class="p">,</span>
		      <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">xctrls</span><span class="p">,</span>
		      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xctrls_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span> <span class="o">=</span> <span class="n">handle</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Find the control. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_commit_entity</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">rollback</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rollback</span><span class="p">)</span>
		<span class="n">uvc_ctrl_send_events</span><span class="p">(</span><span class="n">handle</span><span class="p">,</span> <span class="n">xctrls</span><span class="p">,</span> <span class="n">xctrls_count</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">uvc_ctrl_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">xctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">uvc_find_control</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__uvc_ctrl_get</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">uvc_ctrl_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_ext_control</span> <span class="o">*</span><span class="n">xctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">step</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ctrl</span> <span class="o">=</span> <span class="n">uvc_find_control</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Clamp out of range values. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">v4l2_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_INTEGER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_populate_cache</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">min</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_MIN</span><span class="p">,</span>
				   <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_MIN</span><span class="p">));</span>
		<span class="n">max</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_MAX</span><span class="p">,</span>
				   <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_MAX</span><span class="p">));</span>
		<span class="n">step</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_RES</span><span class="p">,</span>
				    <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_RES</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">step</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">min</span> <span class="o">+</span> <span class="p">(</span><span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">-</span> <span class="n">min</span> <span class="o">+</span> <span class="n">step</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">step</span> <span class="o">*</span> <span class="n">step</span><span class="p">;</span>
		<span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_BOOLEAN</span>:
		<span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CTRL_TYPE_MENU</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">&gt;=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">[</span><span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">].</span><span class="n">value</span><span class="p">;</span>

		<span class="cm">/* Valid menu indices are reported by the GET_RES request for</span>
<span class="cm">		 * UVC controls that support it.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">data_type</span> <span class="o">==</span> <span class="n">UVC_CTRL_DATA_TYPE_BITMASK</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cached</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_populate_cache</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">step</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">UVC_GET_RES</span><span class="p">,</span>
					<span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_RES</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">step</span> <span class="o">&amp;</span> <span class="n">value</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">xctrl</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the mapping doesn&#39;t span the whole UVC control, the current value</span>
<span class="cm">	 * needs to be loaded from the device to perform the read-modify-write</span>
<span class="cm">	 * operation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_CURRENT</span><span class="p">),</span>
				<span class="mi">0</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_GET_CUR</span><span class="p">,</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
				<span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_CURRENT</span><span class="p">),</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">loaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Backup the current value in case we need to rollback later. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">dirty</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_BACKUP</span><span class="p">),</span>
		       <span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_CURRENT</span><span class="p">),</span>
		       <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
		<span class="n">uvc_ctrl_data</span><span class="p">(</span><span class="n">ctrl</span><span class="p">,</span> <span class="n">UVC_CTRL_DATA_CURRENT</span><span class="p">));</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">modified</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm"> * Dynamic controls</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_fixup_xu_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_control_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_ctrl_fixup</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">entity</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">selector</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">flags</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_ctrl_fixup</span> <span class="n">fixups</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046d</span><span class="p">,</span> <span class="mh">0x08c2</span><span class="p">)</span> <span class="p">},</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">UVC_CTRL_FLAG_GET_MIN</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span> <span class="o">|</span>
			<span class="n">UVC_CTRL_FLAG_GET_DEF</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span>
			<span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046d</span><span class="p">,</span> <span class="mh">0x08cc</span><span class="p">)</span> <span class="p">},</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">UVC_CTRL_FLAG_GET_MIN</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span> <span class="o">|</span>
			<span class="n">UVC_CTRL_FLAG_GET_DEF</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span>
			<span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span> <span class="p">},</span>
		<span class="p">{</span> <span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x046d</span><span class="p">,</span> <span class="mh">0x0994</span><span class="p">)</span> <span class="p">},</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			<span class="n">UVC_CTRL_FLAG_GET_MIN</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span> <span class="o">|</span>
			<span class="n">UVC_CTRL_FLAG_GET_DEF</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">|</span>
			<span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span> <span class="p">},</span>
	<span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fixups</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_match_one_id</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fixups</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fixups</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">entity</span> <span class="o">==</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fixups</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">selector</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">fixups</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Query control information (size and flags) for XU controls.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_ctrl_fill_xu_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_control_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">guidExtensionCode</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Query and verify the control length (GET_LEN) */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_GET_LEN</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;GET_LEN failed on control %pUl/%u (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">info</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpup</span><span class="p">((</span><span class="n">__le16</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Query the control information (GET_INFO) */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">UVC_GET_INFO</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span>
			  <span class="s">&quot;GET_INFO failed on control %pUl/%u (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UVC_CTRL_FLAG_GET_MIN</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span>
		    <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span> <span class="o">|</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span>
		    <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">UVC_CONTROL_CAP_GET</span> <span class="o">?</span>
		       <span class="n">UVC_CTRL_FLAG_GET_CUR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">UVC_CONTROL_CAP_SET</span> <span class="o">?</span>
		       <span class="n">UVC_CTRL_FLAG_SET_CUR</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span>
		    <span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">UVC_CONTROL_CAP_AUTOUPDATE</span> <span class="o">?</span>
		       <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">uvc_ctrl_fixup_xu_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;XU control %pUl/%u queried: len %u, &quot;</span>
		  <span class="s">&quot;flags { get %u set %u auto %u }.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">info</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_AUTO_UPDATE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">uvc_ctrl_add_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control_info</span> <span class="o">*</span><span class="n">info</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_ctrl_init_xu_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_fill_xu_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_add_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;Failed to initialize control &quot;</span>
			  <span class="s">&quot;%pUl/%u on device %s entity %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span>
			  <span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">uvc_xu_ctrl_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_xu_control_query</span> <span class="o">*</span><span class="n">xqry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">reqflags</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Find the extension unit. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">==</span> <span class="n">UVC_VC_EXTENSION_UNIT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">xqry</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="n">xqry</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;Extension unit %u not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">xqry</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find the control and perform delayed initialization if needed. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">xqry</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;Control %pUl/%u not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">entity</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">guidExtensionCode</span><span class="p">,</span> <span class="n">xqry</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_init_xu_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Validate the required buffer size and flags for the request */</span>
	<span class="n">reqflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">xqry</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVC_GET_CUR</span>:
		<span class="n">reqflags</span> <span class="o">=</span> <span class="n">UVC_CTRL_FLAG_GET_CUR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UVC_GET_MIN</span>:
		<span class="n">reqflags</span> <span class="o">=</span> <span class="n">UVC_CTRL_FLAG_GET_MIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UVC_GET_MAX</span>:
		<span class="n">reqflags</span> <span class="o">=</span> <span class="n">UVC_CTRL_FLAG_GET_MAX</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UVC_GET_DEF</span>:
		<span class="n">reqflags</span> <span class="o">=</span> <span class="n">UVC_CTRL_FLAG_GET_DEF</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UVC_GET_RES</span>:
		<span class="n">reqflags</span> <span class="o">=</span> <span class="n">UVC_CTRL_FLAG_GET_RES</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UVC_SET_CUR</span>:
		<span class="n">reqflags</span> <span class="o">=</span> <span class="n">UVC_CTRL_FLAG_SET_CUR</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UVC_GET_LEN</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">UVC_GET_INFO</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="n">xqry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reqflags</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">reqflags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADRQC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xqry</span><span class="o">-&gt;</span><span class="n">query</span> <span class="o">==</span> <span class="n">UVC_SET_CUR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xqry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_query_ctrl</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">xqry</span><span class="o">-&gt;</span><span class="n">query</span><span class="p">,</span> <span class="n">xqry</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">,</span>
			     <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span><span class="p">,</span> <span class="n">xqry</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xqry</span><span class="o">-&gt;</span><span class="n">query</span> <span class="o">!=</span> <span class="n">UVC_SET_CUR</span> <span class="o">&amp;&amp;</span>
	    <span class="n">copy_to_user</span><span class="p">(</span><span class="n">xqry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm"> * Suspend/resume</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Restore control values after resume, skipping controls that haven&#39;t been</span>
<span class="cm"> * changed.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO</span>
<span class="cm"> * - Don&#39;t restore modified controls that are back to their default value.</span>
<span class="cm"> * - Handle restore order (Auto-Exposure Mode should be restored before</span>
<span class="cm"> *   Exposure Time).</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">uvc_ctrl_resume_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Walk the entities list and restore controls when possible. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">||</span> <span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">modified</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_CTRL_FLAG_RESTORE</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;restoring control %pUl/%u/%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">index</span><span class="p">,</span>
				<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">);</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">dirty</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_commit_entity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm"> * Control and mapping handling</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Add control information to a given control.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_ctrl_add_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">info</span><span class="p">));</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mappings</span><span class="p">);</span>

	<span class="cm">/* Allocate an array to save control values (cur, def, max, etc.) */</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">uvc_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">size</span> <span class="o">*</span> <span class="n">UVC_CTRL_DATA_LAST</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				 <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">uvc_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;Added control %pUl/%u to device %s &quot;</span>
		<span class="s">&quot;entity %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">uvc_data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add a control mapping to a given control.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__uvc_ctrl_add_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* Most mappings come from static kernel data and need to be duplicated.</span>
<span class="cm">	 * Mappings that come from userspace will be unnecessarily duplicated,</span>
<span class="cm">	 * this could be optimized.</span>
<span class="cm">	 */</span>
	<span class="n">map</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mapping</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">ev_subs</span><span class="p">);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">)</span> <span class="o">*</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_count</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">menu_info</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">menu_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="n">uvc_get_le_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="n">uvc_set_le_value</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mappings</span><span class="p">);</span>
	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span>
		<span class="s">&quot;Adding mapping &#39;%s&#39; to control %pUl/%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">uvc_ctrl_add_mapping</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">V4L2_CTRL_ID_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;Can&#39;t add mapping &#39;%s&#39;, control &quot;</span>
			<span class="s">&quot;id 0x%08x is invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Search for the matching (GUID/CS) control on the current chain */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UVC_VC_EXTENSION_UNIT</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">uvc_entity_match_guid</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="cm">/* Perform delayed initialization of XU controls */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_init_xu_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">map</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mappings</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;Can&#39;t add mapping &#39;%s&#39;, &quot;</span>
				<span class="s">&quot;control id 0x%08x already exists.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">mapping</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Prevent excess memory consumption */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_inc_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nmappings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">UVC_MAX_CONTROL_MAPPINGS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nmappings</span><span class="p">);</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;Can&#39;t add mapping &#39;%s&#39;, maximum &quot;</span>
			<span class="s">&quot;mappings count (%u) exceeded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">UVC_MAX_CONTROL_MAPPINGS</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__uvc_ctrl_add_mapping</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nmappings</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prune an entity of its bogus controls using a blacklist. Bogus controls</span>
<span class="cm"> * are currently the ones that crash the camera or unconditionally return an</span>
<span class="cm"> * error when queried.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_prune_entity</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_ctrl_blacklist</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">index</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_ctrl_blacklist</span> <span class="n">processing_blacklist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x13d3</span><span class="p">,</span> <span class="mh">0x509b</span><span class="p">)</span> <span class="p">},</span> <span class="mi">9</span> <span class="p">},</span> <span class="cm">/* Gain */</span>
		<span class="p">{</span> <span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x1c4f</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">)</span> <span class="p">},</span> <span class="mi">6</span> <span class="p">},</span> <span class="cm">/* WB Temperature */</span>
		<span class="p">{</span> <span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x5986</span><span class="p">,</span> <span class="mh">0x0241</span><span class="p">)</span> <span class="p">},</span> <span class="mi">2</span> <span class="p">},</span> <span class="cm">/* Hue */</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_ctrl_blacklist</span> <span class="n">camera_blacklist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="p">{</span> <span class="n">USB_DEVICE</span><span class="p">(</span><span class="mh">0x06f8</span><span class="p">,</span> <span class="mh">0x3005</span><span class="p">)</span> <span class="p">},</span> <span class="mi">9</span> <span class="p">},</span> <span class="cm">/* Zoom, Absolute */</span>
	<span class="p">};</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_ctrl_blacklist</span> <span class="o">*</span><span class="n">blacklist</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">controls</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVC_VC_PROCESSING_UNIT</span>:
		<span class="n">blacklist</span> <span class="o">=</span> <span class="n">processing_blacklist</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">processing_blacklist</span><span class="p">);</span>
		<span class="n">controls</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">processing</span><span class="p">.</span><span class="n">bmControls</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">processing</span><span class="p">.</span><span class="n">bControlSize</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_ITT_CAMERA</span>:
		<span class="n">blacklist</span> <span class="o">=</span> <span class="n">camera_blacklist</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">camera_blacklist</span><span class="p">);</span>
		<span class="n">controls</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">bmControls</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">bControlSize</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_match_one_id</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">size</span> <span class="o">||</span>
		    <span class="o">!</span><span class="n">uvc_test_bit</span><span class="p">(</span><span class="n">controls</span><span class="p">,</span> <span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_CONTROL</span><span class="p">,</span> <span class="s">&quot;%u/%u control is black listed, &quot;</span>
			<span class="s">&quot;removing it.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">);</span>

		<span class="n">uvc_clear_bit</span><span class="p">(</span><span class="n">controls</span><span class="p">,</span> <span class="n">blacklist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Add control information and hardcoded stock control mappings to the given</span>
<span class="cm"> * device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_init_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">uvc_ctrls</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control_info</span> <span class="o">*</span><span class="n">iend</span> <span class="o">=</span> <span class="n">info</span> <span class="o">+</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uvc_ctrls</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span> <span class="o">=</span> <span class="n">uvc_ctrl_mappings</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mend</span> <span class="o">=</span>
		<span class="n">mapping</span> <span class="o">+</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uvc_ctrl_mappings</span><span class="p">);</span>

	<span class="cm">/* XU controls initialization requires querying the device for control</span>
<span class="cm">	 * information. As some buggy UVC devices will crash when queried</span>
<span class="cm">	 * repeatedly in a tight loop, delay XU controls initialization until</span>
<span class="cm">	 * first use.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">)</span> <span class="o">==</span> <span class="n">UVC_VC_EXTENSION_UNIT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">info</span> <span class="o">&lt;</span> <span class="n">iend</span><span class="p">;</span> <span class="o">++</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_entity_match_guid</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_ctrl_add_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		 <span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">mapping</span> <span class="o">&lt;</span> <span class="n">mend</span><span class="p">;</span> <span class="o">++</span><span class="n">mapping</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_entity_match_guid</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">selector</span> <span class="o">==</span> <span class="n">mapping</span><span class="o">-&gt;</span><span class="n">selector</span><span class="p">)</span>
			<span class="n">__uvc_ctrl_add_mapping</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">,</span> <span class="n">mapping</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize device controls.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">uvc_ctrl_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Walk the entities list and instantiate controls */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bControlSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ncontrols</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">__u8</span> <span class="o">*</span><span class="n">bmControls</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">==</span> <span class="n">UVC_VC_EXTENSION_UNIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmControls</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bmControls</span><span class="p">;</span>
			<span class="n">bControlSize</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bControlSize</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">==</span> <span class="n">UVC_VC_PROCESSING_UNIT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmControls</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">processing</span><span class="p">.</span><span class="n">bmControls</span><span class="p">;</span>
			<span class="n">bControlSize</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">processing</span><span class="p">.</span><span class="n">bControlSize</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">==</span> <span class="n">UVC_ITT_CAMERA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">bmControls</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">bmControls</span><span class="p">;</span>
			<span class="n">bControlSize</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">bControlSize</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Remove bogus/blacklisted controls */</span>
		<span class="n">uvc_ctrl_prune_entity</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>

		<span class="cm">/* Count supported controls and allocate the controls array */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bControlSize</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">ncontrols</span> <span class="o">+=</span> <span class="n">hweight8</span><span class="p">(</span><span class="n">bmControls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ncontrols</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">ncontrols</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ctrl</span><span class="p">),</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">entity</span><span class="o">-&gt;</span><span class="n">ncontrols</span> <span class="o">=</span> <span class="n">ncontrols</span><span class="p">;</span>

		<span class="cm">/* Initialize all supported controls */</span>
		<span class="n">ctrl</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bControlSize</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uvc_test_bit</span><span class="p">(</span><span class="n">bmControls</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">entity</span> <span class="o">=</span> <span class="n">entity</span><span class="p">;</span>
			<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">uvc_ctrl_init_ctrl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="n">ctrl</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Cleanup device controls.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_ctrl_cleanup_mappings</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_control_mapping</span> <span class="o">*</span><span class="n">mapping</span><span class="p">,</span> <span class="o">*</span><span class="n">nm</span><span class="p">;</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">mapping</span><span class="p">,</span> <span class="n">nm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">.</span><span class="n">mappings</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mapping</span><span class="o">-&gt;</span><span class="n">menu_info</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mapping</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">uvc_ctrl_cleanup_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Free controls and control mappings for all entities. */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">ncontrols</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">uvc_control</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">uvc_ctrl_cleanup_mappings</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">uvc_data</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
