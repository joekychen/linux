<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › uvc › uvc_driver.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>uvc_driver.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *      uvc_driver.c  --  USB Video Class driver</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 2005-2010</span>
<span class="cm"> *          Laurent Pinchart (laurent.pinchart@ideasonboard.com)</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *      it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *      the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *      (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * This driver aims to support video input and ouput devices compliant with the</span>
<span class="cm"> * &#39;USB Video Class&#39; specification.</span>
<span class="cm"> *</span>
<span class="cm"> * The driver doesn&#39;t support the deprecated v4l1 interface. It implements the</span>
<span class="cm"> * mmap capture method only, and doesn&#39;t do any image format conversion in</span>
<span class="cm"> * software. If your user-space application doesn&#39;t support YUYV or MJPEG, fix</span>
<span class="cm"> * it :-). Please note that the MJPEG data have been stripped from their</span>
<span class="cm"> * Huffman tables (DHT marker), you will need to add it back if your JPEG</span>
<span class="cm"> * codec can&#39;t handle MJPEG data.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/version.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>

<span class="cp">#include &quot;uvcvideo.h&quot;</span>

<span class="cp">#define DRIVER_AUTHOR		&quot;Laurent Pinchart &quot; \</span>
<span class="cp">				&quot;&lt;laurent.pinchart@ideasonboard.com&gt;&quot;</span>
<span class="cp">#define DRIVER_DESC		&quot;USB Video Class driver&quot;</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uvc_clock_param</span> <span class="o">=</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uvc_no_drop_param</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uvc_quirks_param</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uvc_trace_param</span><span class="p">;</span>
<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">uvc_timeout_param</span> <span class="o">=</span> <span class="n">UVC_CTRL_STREAMING_TIMEOUT</span><span class="p">;</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Video formats</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_format_desc</span> <span class="n">uvc_fmts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;YUV 4:2:2 (YUYV)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_YUY2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;YUV 4:2:2 (YUYV)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_YUY2_ISIGHT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;YUV 4:2:0 (NV12)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_NV12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_NV12</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;MJPEG&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_MJPEG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;YVU 4:2:0 (YV12)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_YV12</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_YVU420</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;YUV 4:2:0 (I420)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_I420</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_YUV420</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;YUV 4:2:0 (M420)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_M420</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_M420</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;YUV 4:2:2 (UYVY)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_UYVY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_UYVY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Greyscale (8-bit)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_Y800</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_GREY</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;Greyscale (16-bit)&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_Y16</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_Y16</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;RGB Bayer&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_BY8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_SBGGR8</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;RGB565&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_RGBP</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;H.264&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">guid</span>		<span class="o">=</span> <span class="n">UVC_GUID_FORMAT_H264</span><span class="p">,</span>
		<span class="p">.</span><span class="n">fcc</span>		<span class="o">=</span> <span class="n">V4L2_PIX_FMT_H264</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Utility functions</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="nf">uvc_find_endpoint</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alts</span><span class="p">,</span>
		<span class="n">__u8</span> <span class="n">epaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alts</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">==</span> <span class="n">epaddr</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ep</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_format_desc</span> <span class="o">*</span><span class="nf">uvc_format_by_guid</span><span class="p">(</span><span class="k">const</span> <span class="n">__u8</span> <span class="n">guid</span><span class="p">[</span><span class="mi">16</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">uvc_fmts</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">guid</span><span class="p">,</span> <span class="n">uvc_fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">guid</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">uvc_fmts</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">__u32</span> <span class="nf">uvc_colorspace</span><span class="p">(</span><span class="k">const</span> <span class="n">__u8</span> <span class="n">primaries</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">__u8</span> <span class="n">colorprimaries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_470_SYSTEM_M</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_470_SYSTEM_BG</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">,</span>
		<span class="n">V4L2_COLORSPACE_SMPTE240M</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">primaries</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">colorprimaries</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">colorprimaries</span><span class="p">[</span><span class="n">primaries</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Simplify a fraction using a simple continued fraction decomposition. The</span>
<span class="cm"> * idea here is to convert fractions such as 333333/10000000 to 1/30 using</span>
<span class="cm"> * 32 bit arithmetic only. The algorithm is not perfect and relies upon two</span>
<span class="cm"> * arbitrary parameters to remove non-significative terms from the simple</span>
<span class="cm"> * continued fraction decomposition. Using 8 and 333 for n_terms and threshold</span>
<span class="cm"> * respectively seems to give nice results.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">uvc_simplify_fraction</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="n">numerator</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="o">*</span><span class="n">denominator</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n_terms</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="o">*</span><span class="n">an</span><span class="p">;</span>
	<span class="kt">uint32_t</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">an</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">n_terms</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">an</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">an</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Convert the fraction to a simple continued fraction. See</span>
<span class="cm">	 * http://mathforum.org/dr.math/faq/faq.fractions.html</span>
<span class="cm">	 * Stop if the current term is bigger than or equal to the given</span>
<span class="cm">	 * threshold.</span>
<span class="cm">	 */</span>
	<span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="n">numerator</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">=</span> <span class="o">*</span><span class="n">denominator</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="n">n_terms</span> <span class="o">&amp;&amp;</span> <span class="n">y</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">++</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">an</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">/</span> <span class="n">y</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">an</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">threshold</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">n</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">r</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">an</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Expand the simple continued fraction back to an integer fraction. */</span>
	<span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">y</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
		<span class="n">y</span> <span class="o">=</span> <span class="n">an</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">y</span> <span class="o">+</span> <span class="n">x</span><span class="p">;</span>
		<span class="n">x</span> <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">y</span><span class="p">;</span>
	<span class="o">*</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">x</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">an</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Convert a fraction to a frame interval in 100ns multiples. The idea here is</span>
<span class="cm"> * to compute numerator / denominator * 10000000 using 32 bit fixed point</span>
<span class="cm"> * arithmetic only.</span>
<span class="cm"> */</span>
<span class="kt">uint32_t</span> <span class="nf">uvc_fraction_to_interval</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">numerator</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">denominator</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">uint32_t</span> <span class="n">multiplier</span><span class="p">;</span>

	<span class="cm">/* Saturate the result if the operation would overflow. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">denominator</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">numerator</span><span class="o">/</span><span class="n">denominator</span> <span class="o">&gt;=</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">10000000</span><span class="p">)</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Divide both the denominator and the multiplier by two until</span>
<span class="cm">	 * numerator * multiplier doesn&#39;t overflow. If anyone knows a better</span>
<span class="cm">	 * algorithm please let me know.</span>
<span class="cm">	 */</span>
	<span class="n">multiplier</span> <span class="o">=</span> <span class="mi">10000000</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">numerator</span> <span class="o">&gt;</span> <span class="p">((</span><span class="kt">uint32_t</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">multiplier</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">multiplier</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">denominator</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">denominator</span> <span class="o">?</span> <span class="n">numerator</span> <span class="o">*</span> <span class="n">multiplier</span> <span class="o">/</span> <span class="n">denominator</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Terminal and unit management</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="nf">uvc_entity_by_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">entity</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="nf">uvc_entity_by_reference</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entity</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">entity</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_entity</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">list_for_each_entry_continue</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">bNrInPins</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">entity</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="nf">uvc_stream_by_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bTerminalLink</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">stream</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Descriptors parsing</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_parse_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">streaming</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_format</span> <span class="o">*</span><span class="n">format</span><span class="p">,</span>
	<span class="n">__u32</span> <span class="o">**</span><span class="n">intervals</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span> <span class="o">=</span> <span class="n">streaming</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alts</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_format_desc</span> <span class="o">*</span><span class="n">fmtdesc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">start</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">interval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">ftype</span><span class="p">;</span>

	<span class="n">format</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">format</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVC_VS_FORMAT_UNCOMPRESSED</span>:
	<span class="k">case</span> <span class="n">UVC_VS_FORMAT_FRAME_BASED</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">UVC_VS_FORMAT_UNCOMPRESSED</span> <span class="o">?</span> <span class="mi">27</span> <span class="o">:</span> <span class="mi">28</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming &quot;</span>
			       <span class="s">&quot;interface %d FORMAT error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
			       <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Find the format descriptor from its GUID. */</span>
		<span class="n">fmtdesc</span> <span class="o">=</span> <span class="n">uvc_format_by_guid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fmtdesc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="k">sizeof</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">format</span><span class="o">-&gt;</span><span class="n">fcc</span> <span class="o">=</span> <span class="n">fmtdesc</span><span class="o">-&gt;</span><span class="n">fcc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Unknown video format %pUl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">snprintf</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%pUl</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">format</span><span class="o">-&gt;</span><span class="n">fcc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">format</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">UVC_VS_FORMAT_UNCOMPRESSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ftype</span> <span class="o">=</span> <span class="n">UVC_VS_FRAME_UNCOMPRESSED</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ftype</span> <span class="o">=</span> <span class="n">UVC_VS_FRAME_FRAME_BASED</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">27</span><span class="p">])</span>
				<span class="n">format</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UVC_FMT_FLAG_COMPRESSED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VS_FORMAT_MJPEG</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">11</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming &quot;</span>
			       <span class="s">&quot;interface %d FORMAT error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
			       <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">strlcpy</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;MJPEG&quot;</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">format</span><span class="o">-&gt;</span><span class="n">fcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MJPEG</span><span class="p">;</span>
		<span class="n">format</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UVC_FMT_FLAG_COMPRESSED</span><span class="p">;</span>
		<span class="n">format</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ftype</span> <span class="o">=</span> <span class="n">UVC_VS_FRAME_MJPEG</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VS_FORMAT_DV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming &quot;</span>
			       <span class="s">&quot;interface %d FORMAT error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
			       <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;SD-DV&quot;</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;SDL-DV&quot;</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="n">strlcpy</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;HD-DV&quot;</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming &quot;</span>
			       <span class="s">&quot;interface %d: unknown DV format %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
			       <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">strlcat</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot; 60Hz&quot;</span> <span class="o">:</span> <span class="s">&quot; 50Hz&quot;</span><span class="p">,</span>
			<span class="k">sizeof</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">format</span><span class="o">-&gt;</span><span class="n">fcc</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_DV</span><span class="p">;</span>
		<span class="n">format</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">UVC_FMT_FLAG_COMPRESSED</span> <span class="o">|</span> <span class="n">UVC_FMT_FLAG_STREAM</span><span class="p">;</span>
		<span class="n">format</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ftype</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Create a dummy frame descriptor. */</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIntervalType</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwDefaultFrameInterval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span> <span class="o">=</span> <span class="o">*</span><span class="n">intervals</span><span class="p">;</span>
		<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">intervals</span><span class="p">)</span><span class="o">++</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">format</span><span class="o">-&gt;</span><span class="n">nframes</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VS_FORMAT_MPEG2TS</span>:
	<span class="k">case</span> <span class="n">UVC_VS_FORMAT_STREAM_BASED</span>:
		<span class="cm">/* Not supported yet. */</span>
	<span class="nl">default:</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming &quot;</span>
		       <span class="s">&quot;interface %d unsupported format %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
		       <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Found format %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">buflen</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">buffer</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* Parse the frame descriptors. Only uncompressed, MJPEG and frame</span>
<span class="cm">	 * based formats have frame descriptors.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">USB_DT_CS_INTERFACE</span> <span class="o">&amp;&amp;</span>
	       <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">ftype</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ftype</span> <span class="o">!=</span> <span class="n">UVC_VS_FRAME_FRAME_BASED</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">25</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">21</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">n</span> <span class="o">=</span> <span class="n">n</span> <span class="o">?</span> <span class="n">n</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">26</span> <span class="o">+</span> <span class="mi">4</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming &quot;</span>
			       <span class="s">&quot;interface %d FRAME error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
			       <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIndex</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">bmCapabilities</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">wWidth</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">wHeight</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwMinBitRate</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwMaxBitRate</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ftype</span> <span class="o">!=</span> <span class="n">UVC_VS_FRAME_FRAME_BASED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwMaxVideoFrameBufferSize</span> <span class="o">=</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwDefaultFrameInterval</span> <span class="o">=</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]);</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIntervalType</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwMaxVideoFrameBufferSize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwDefaultFrameInterval</span> <span class="o">=</span>
				<span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIntervalType</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">21</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span> <span class="o">=</span> <span class="o">*</span><span class="n">intervals</span><span class="p">;</span>

		<span class="cm">/* Several UVC chipsets screw up dwMaxVideoFrameBufferSize</span>
<span class="cm">		 * completely. Observed behaviours range from setting the</span>
<span class="cm">		 * value to 1.1x the actual frame size to hardwiring the</span>
<span class="cm">		 * 16 low bits to 0. This results in a higher than necessary</span>
<span class="cm">		 * memory usage as well as a wrong image size information. For</span>
<span class="cm">		 * uncompressed formats this can be fixed by computing the</span>
<span class="cm">		 * value from the frame size.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">UVC_FMT_FLAG_COMPRESSED</span><span class="p">))</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwMaxVideoFrameBufferSize</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">bpp</span>
				<span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wWidth</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wHeight</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

		<span class="cm">/* Some bogus devices report dwMinFrameInterval equal to</span>
<span class="cm">		 * dwMaxFrameInterval and have dwFrameIntervalStep set to</span>
<span class="cm">		 * zero. Setting all null intervals to 1 fixes the problem and</span>
<span class="cm">		 * some other divisions by zero that could happen.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">interval</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">26</span><span class="o">+</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">]);</span>
			<span class="o">*</span><span class="p">(</span><span class="o">*</span><span class="n">intervals</span><span class="p">)</span><span class="o">++</span> <span class="o">=</span> <span class="n">interval</span> <span class="o">?</span> <span class="n">interval</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Make sure that the default frame interval stays between</span>
<span class="cm">		 * the boundaries.</span>
<span class="cm">		 */</span>
		<span class="n">n</span> <span class="o">-=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIntervalType</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwDefaultFrameInterval</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="n">n</span><span class="p">],</span>
			    <span class="n">max</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwDefaultFrameInterval</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">UVC_QUIRK_RESTRICT_FRAME_RATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">bFrameIntervalType</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwFrameInterval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwDefaultFrameInterval</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;- %ux%u (%u.%u fps)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">wWidth</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">wHeight</span><span class="p">,</span>
			<span class="mi">10000000</span><span class="o">/</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwDefaultFrameInterval</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">100000000</span><span class="o">/</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">dwDefaultFrameInterval</span><span class="p">)</span><span class="o">%</span><span class="mi">10</span><span class="p">);</span>

		<span class="n">format</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="o">++</span><span class="p">;</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">USB_DT_CS_INTERFACE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">UVC_VS_STILL_IMAGE_FRAME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">USB_DT_CS_INTERFACE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">UVC_VS_COLORFORMAT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming &quot;</span>
			       <span class="s">&quot;interface %d COLORFORMAT error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
			       <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">format</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">uvc_colorspace</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buffer</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_parse_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">streaming</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_format</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">_buffer</span><span class="p">,</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">_buflen</span><span class="p">,</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">extralen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nformats</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nframes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">nintervals</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="o">*</span><span class="n">interval</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">psize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceSubClass</span>
		<span class="o">!=</span> <span class="n">UVC_SC_VIDEOSTREAMING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d interface %d isn&#39;t a &quot;</span>
			<span class="s">&quot;video streaming interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
			<span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_driver_claim_interface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvc_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d interface %d is already &quot;</span>
			<span class="s">&quot;claimed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
			<span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">streaming</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">streaming</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">streaming</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_driver_release_interface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvc_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">streaming</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">usb_get_intf</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">intfnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>

	<span class="cm">/* The Pico iMage webcam has its class-specific interface descriptors</span>
<span class="cm">	 * after the endpoint descriptors.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alts</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">extralen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">extralen</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span>
			    <span class="n">ep</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;trying extra data &quot;</span>
					<span class="s">&quot;from endpoint %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">buffer</span> <span class="o">=</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">extra</span><span class="p">;</span>
				<span class="n">buflen</span> <span class="o">=</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">extralen</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Skip the standard interface descriptors. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;no class-specific streaming &quot;</span>
			<span class="s">&quot;interface descriptors found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Parse the header descriptor. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVC_VS_OUTPUT_HEADER</span>:
		<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VS_INPUT_HEADER</span>:
		<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">=</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming interface &quot;</span>
			<span class="s">&quot;%d HEADER descriptor not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
			<span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">n</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="n">size</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="n">size</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="n">size</span> <span class="o">+</span> <span class="n">p</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming &quot;</span>
			<span class="s">&quot;interface %d HEADER descriptor is invalid.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bNumFormats</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bEndpointAddress</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">UVC_VS_INPUT_HEADER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bmInfo</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bTerminalLink</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
		<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bStillCaptureMethod</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
		<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bTriggerSupport</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
		<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bTriggerUsage</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bTerminalLink</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bControlSize</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>

	<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bmaControls</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="n">size</span><span class="p">],</span> <span class="n">p</span> <span class="o">*</span> <span class="n">n</span><span class="p">,</span>
						<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bmaControls</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buflen</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">buffer</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">_buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="n">_buflen</span> <span class="o">=</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="cm">/* Count the format and frame descriptors. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">_buflen</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_UNCOMPRESSED</span>:
		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_MJPEG</span>:
		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_FRAME_BASED</span>:
			<span class="n">nformats</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_DV</span>:
			<span class="cm">/* DV format has no frame descriptor. We will create a</span>
<span class="cm">			 * dummy frame descriptor with a dummy frame interval.</span>
<span class="cm">			 */</span>
			<span class="n">nformats</span><span class="o">++</span><span class="p">;</span>
			<span class="n">nframes</span><span class="o">++</span><span class="p">;</span>
			<span class="n">nintervals</span><span class="o">++</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_MPEG2TS</span>:
		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_STREAM_BASED</span>:
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming &quot;</span>
				<span class="s">&quot;interface %d FORMAT %u is not supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
				<span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">UVC_VS_FRAME_UNCOMPRESSED</span>:
		<span class="k">case</span> <span class="n">UVC_VS_FRAME_MJPEG</span>:
			<span class="n">nframes</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">_buflen</span> <span class="o">&gt;</span> <span class="mi">25</span><span class="p">)</span>
				<span class="n">nintervals</span> <span class="o">+=</span> <span class="n">_buffer</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">?</span> <span class="n">_buffer</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">UVC_VS_FRAME_FRAME_BASED</span>:
			<span class="n">nframes</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">_buflen</span> <span class="o">&gt;</span> <span class="mi">21</span><span class="p">)</span>
				<span class="n">nintervals</span> <span class="o">+=</span> <span class="n">_buffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">?</span> <span class="n">_buffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">:</span> <span class="mi">3</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">_buflen</span> <span class="o">-=</span> <span class="n">_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">_buffer</span> <span class="o">+=</span> <span class="n">_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nformats</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming interface &quot;</span>
			<span class="s">&quot;%d has no supported formats defined.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">nformats</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">format</span> <span class="o">+</span> <span class="n">nframes</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">frame</span>
	     <span class="o">+</span> <span class="n">nintervals</span> <span class="o">*</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">interval</span><span class="p">;</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uvc_frame</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">format</span><span class="p">[</span><span class="n">nformats</span><span class="p">];</span>
	<span class="n">interval</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">frame</span><span class="p">[</span><span class="n">nframes</span><span class="p">];</span>

	<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">nformats</span> <span class="o">=</span> <span class="n">nformats</span><span class="p">;</span>

	<span class="cm">/* Parse the format descriptors. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_UNCOMPRESSED</span>:
		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_MJPEG</span>:
		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_DV</span>:
		<span class="k">case</span> <span class="n">UVC_VS_FORMAT_FRAME_BASED</span>:
			<span class="n">format</span><span class="o">-&gt;</span><span class="n">frame</span> <span class="o">=</span> <span class="n">frame</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_parse_format</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">streaming</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">interval</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

			<span class="n">frame</span> <span class="o">+=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">nframes</span><span class="p">;</span>
			<span class="n">format</span><span class="o">++</span><span class="p">;</span>

			<span class="n">buflen</span> <span class="o">-=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="n">buffer</span> <span class="o">+=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span><span class="p">)</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videostreaming interface &quot;</span>
			<span class="s">&quot;%d has %u bytes of trailing descriptor garbage.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>

	<span class="cm">/* Parse the alternate settings to find the maximum bandwidth. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">num_altsetting</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span><span class="p">;</span>
		<span class="n">alts</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ep</span> <span class="o">=</span> <span class="n">uvc_find_endpoint</span><span class="p">(</span><span class="n">alts</span><span class="p">,</span>
				<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bEndpointAddress</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ep</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">psize</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">wMaxPacketSize</span><span class="p">);</span>
		<span class="n">psize</span> <span class="o">=</span> <span class="p">(</span><span class="n">psize</span> <span class="o">&amp;</span> <span class="mh">0x07ff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">psize</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">psize</span> <span class="o">&gt;</span> <span class="n">streaming</span><span class="o">-&gt;</span><span class="n">maxpsize</span><span class="p">)</span>
			<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">maxpsize</span> <span class="o">=</span> <span class="n">psize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">streaming</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">usb_driver_release_interface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvc_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
	<span class="n">usb_put_intf</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">streaming</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bmaControls</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">streaming</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="nf">uvc_alloc_entity</span><span class="p">(</span><span class="n">u16</span> <span class="n">type</span><span class="p">,</span> <span class="n">u8</span> <span class="n">id</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_pads</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">extra_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">num_inputs</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">extra_size</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">extra_size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">));</span>
	<span class="n">num_inputs</span> <span class="o">=</span> <span class="p">(</span><span class="n">type</span> <span class="o">&amp;</span> <span class="n">UVC_TERM_OUTPUT</span><span class="p">)</span> <span class="o">?</span> <span class="n">num_pads</span> <span class="o">:</span> <span class="n">num_pads</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entity</span><span class="p">)</span> <span class="o">+</span> <span class="n">extra_size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">)</span> <span class="o">*</span> <span class="n">num_pads</span>
	     <span class="o">+</span> <span class="n">num_inputs</span><span class="p">;</span>
	<span class="n">entity</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entity</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">entity</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="n">entity</span><span class="o">-&gt;</span><span class="n">num_links</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">entity</span><span class="o">-&gt;</span><span class="n">num_pads</span> <span class="o">=</span> <span class="n">num_pads</span><span class="p">;</span>
	<span class="n">entity</span><span class="o">-&gt;</span><span class="n">pads</span> <span class="o">=</span> <span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">entity</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">extra_size</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_inputs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">entity</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SINK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UVC_ENTITY_IS_OTERM</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span>
		<span class="n">entity</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">num_pads</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>

	<span class="n">entity</span><span class="o">-&gt;</span><span class="n">bNrInPins</span> <span class="o">=</span> <span class="n">num_inputs</span><span class="p">;</span>
	<span class="n">entity</span><span class="o">-&gt;</span><span class="n">baSourceID</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">num_pads</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">entity</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Parse vendor-specific extensions. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_parse_vendor_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alts</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">unit</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x046d</span>:		<span class="cm">/* Logitech */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x41</span> <span class="o">||</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Logitech implements several vendor specific functions</span>
<span class="cm">		 * through vendor specific extension units (LXU).</span>
<span class="cm">		 *</span>
<span class="cm">		 * The LXU descriptors are similar to XU descriptors</span>
<span class="cm">		 * (see &quot;USB Device Video Class for Video Devices&quot;, section</span>
<span class="cm">		 * 3.7.2.6 &quot;Extension Unit Descriptor&quot;) with the following</span>
<span class="cm">		 * differences:</span>
<span class="cm">		 *</span>
<span class="cm">		 * ----------------------------------------------------------</span>
<span class="cm">		 * 0		bLength		1	 Number</span>
<span class="cm">		 *	Size of this descriptor, in bytes: 24+p+n*2</span>
<span class="cm">		 * ----------------------------------------------------------</span>
<span class="cm">		 * 23+p+n	bmControlsType	N	Bitmap</span>
<span class="cm">		 * 	Individual bits in the set are defined:</span>
<span class="cm">		 * 	0: Absolute</span>
<span class="cm">		 * 	1: Relative</span>
<span class="cm">		 *</span>
<span class="cm">		 * 	This bitset is mapped exactly the same as bmControls.</span>
<span class="cm">		 * ----------------------------------------------------------</span>
<span class="cm">		 * 23+p+n*2	bReserved	1	Boolean</span>
<span class="cm">		 * ----------------------------------------------------------</span>
<span class="cm">		 * 24+p+n*2	iExtension	1	Index</span>
<span class="cm">		 *	Index of a string descriptor that describes this</span>
<span class="cm">		 *	extension unit.</span>
<span class="cm">		 * ----------------------------------------------------------</span>
<span class="cm">		 */</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">22</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">25</span> <span class="o">+</span> <span class="n">p</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">22</span><span class="o">+</span><span class="n">p</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">25</span> <span class="o">+</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d EXTENSION_UNIT error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">unit</span> <span class="o">=</span> <span class="n">uvc_alloc_entity</span><span class="p">(</span><span class="n">UVC_VC_EXTENSION_UNIT</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
					<span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">guidExtensionCode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bNumControls</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bControlSize</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">22</span><span class="o">+</span><span class="n">p</span><span class="p">];</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">unit</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">unit</span><span class="p">);</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bmControlsType</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">unit</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">unit</span><span class="p">)</span>
					       <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bmControls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">23</span><span class="o">+</span><span class="n">p</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">24</span><span class="o">+</span><span class="n">p</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">usb_string</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">24</span><span class="o">+</span><span class="n">p</span><span class="o">+</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="p">],</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				   <span class="k">sizeof</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Extension %u&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">handled</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_parse_standard_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">unit</span><span class="p">,</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alts</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__u16</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVC_VC_HEADER</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">12</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">||</span> <span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">12</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d HEADER error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
				<span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">uvc_version</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">clock_frequency</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

		<span class="cm">/* Parse all USB Video Streaming interfaces. */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">intf</span> <span class="o">=</span> <span class="n">usb_ifnum_to_if</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="o">+</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">intf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d &quot;</span>
					<span class="s">&quot;interface %d doesn&#39;t exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">uvc_parse_streaming</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_INPUT_TERMINAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d INPUT_TERMINAL error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Make sure the terminal type MSB is not null, otherwise it</span>
<span class="cm">		 * could be confused with a unit.</span>
<span class="cm">		 */</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d INPUT_TERMINAL %d has invalid &quot;</span>
				<span class="s">&quot;type 0x%04x, skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
				<span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">type</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">UVC_ITT_CAMERA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">15</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">UVC_ITT_MEDIA_TRANSPORT_INPUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">9</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">n</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="o">+</span><span class="n">n</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="n">len</span> <span class="o">+</span> <span class="n">n</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d INPUT_TERMINAL error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">term</span> <span class="o">=</span> <span class="n">uvc_alloc_entity</span><span class="p">(</span><span class="n">type</span> <span class="o">|</span> <span class="n">UVC_TERM_INPUT</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
					<span class="mi">1</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">term</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">==</span> <span class="n">UVC_ITT_CAMERA</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">term</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">bControlSize</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">term</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">term</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>
			<span class="n">term</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">wObjectiveFocalLengthMin</span> <span class="o">=</span>
				<span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
			<span class="n">term</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">wObjectiveFocalLengthMax</span> <span class="o">=</span>
				<span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
			<span class="n">term</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">wOcularFocalLength</span> <span class="o">=</span>
				<span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">camera</span><span class="p">.</span><span class="n">bmControls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">15</span><span class="p">],</span> <span class="n">n</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">==</span>
			   <span class="n">UVC_ITT_MEDIA_TRANSPORT_INPUT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">term</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">.</span><span class="n">bControlSize</span> <span class="o">=</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">term</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">term</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>
			<span class="n">term</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">.</span><span class="n">bTransportModeSize</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
			<span class="n">term</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">.</span><span class="n">bmTransportModes</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">term</span>
						     <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">term</span> <span class="o">+</span> <span class="n">n</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">.</span><span class="n">bmControls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="p">],</span> <span class="n">n</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">media</span><span class="p">.</span><span class="n">bmTransportModes</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">10</span><span class="o">+</span><span class="n">n</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">usb_string</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				   <span class="k">sizeof</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">==</span> <span class="n">UVC_ITT_CAMERA</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Camera %u&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">==</span> <span class="n">UVC_ITT_MEDIA_TRANSPORT_INPUT</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Media %u&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Input %u&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_OUTPUT_TERMINAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d OUTPUT_TERMINAL error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Make sure the terminal type MSB is not null, otherwise it</span>
<span class="cm">		 * could be confused with a unit.</span>
<span class="cm">		 */</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mh">0xff00</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d OUTPUT_TERMINAL %d has invalid &quot;</span>
				<span class="s">&quot;type 0x%04x, skipping</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span>
				<span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">type</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">term</span> <span class="o">=</span> <span class="n">uvc_alloc_entity</span><span class="p">(</span><span class="n">type</span> <span class="o">|</span> <span class="n">UVC_TERM_OUTPUT</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
					<span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">term</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">usb_string</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				   <span class="k">sizeof</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Output %u&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_SELECTOR_UNIT</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">5</span> <span class="o">||</span> <span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">p</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d SELECTOR_UNIT error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">unit</span> <span class="o">=</span> <span class="n">uvc_alloc_entity</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="o">+</span><span class="n">p</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">usb_string</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="o">+</span><span class="n">p</span><span class="p">],</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				   <span class="k">sizeof</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Selector %u&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_PROCESSING_UNIT</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">uvc_version</span> <span class="o">&gt;=</span> <span class="mh">0x0110</span> <span class="o">?</span> <span class="mi">10</span> <span class="o">:</span> <span class="mi">9</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="n">p</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d PROCESSING_UNIT error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">unit</span> <span class="o">=</span> <span class="n">uvc_alloc_entity</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">2</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">processing</span><span class="p">.</span><span class="n">wMaxMultiplier</span> <span class="o">=</span>
			<span class="n">get_unaligned_le16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">processing</span><span class="p">.</span><span class="n">bControlSize</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">processing</span><span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">unit</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">unit</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">processing</span><span class="p">.</span><span class="n">bmControls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">],</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">uvc_version</span> <span class="o">&gt;=</span> <span class="mh">0x0110</span><span class="p">)</span>
			<span class="n">unit</span><span class="o">-&gt;</span><span class="n">processing</span><span class="p">.</span><span class="n">bmVideoStandards</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">9</span><span class="o">+</span><span class="n">n</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="o">+</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">usb_string</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">8</span><span class="o">+</span><span class="n">n</span><span class="p">],</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				   <span class="k">sizeof</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Processing %u&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_EXTENSION_UNIT</span>:
		<span class="n">p</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">22</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">&gt;=</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">p</span> <span class="o">?</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">22</span><span class="o">+</span><span class="n">p</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">24</span> <span class="o">+</span> <span class="n">p</span> <span class="o">+</span> <span class="n">n</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;device %d videocontrol &quot;</span>
				<span class="s">&quot;interface %d EXTENSION_UNIT error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devnum</span><span class="p">,</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">unit</span> <span class="o">=</span> <span class="n">uvc_alloc_entity</span><span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">guidExtensionCode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bNumControls</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">22</span><span class="p">],</span> <span class="n">p</span><span class="p">);</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bControlSize</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">22</span><span class="o">+</span><span class="n">p</span><span class="p">];</span>
		<span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bmControls</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u8</span> <span class="o">*</span><span class="p">)</span><span class="n">unit</span> <span class="o">+</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">unit</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">extension</span><span class="p">.</span><span class="n">bmControls</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">[</span><span class="mi">23</span><span class="o">+</span><span class="n">p</span><span class="p">],</span> <span class="n">n</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">23</span><span class="o">+</span><span class="n">p</span><span class="o">+</span><span class="n">n</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">usb_string</span><span class="p">(</span><span class="n">udev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">23</span><span class="o">+</span><span class="n">p</span><span class="o">+</span><span class="n">n</span><span class="p">],</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				   <span class="k">sizeof</span> <span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Extension %u&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">unit</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Found an unknown CS_INTERFACE &quot;</span>
			<span class="s">&quot;descriptor (%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_parse_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">alts</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span> <span class="o">=</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">extra</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buflen</span> <span class="o">=</span> <span class="n">alts</span><span class="o">-&gt;</span><span class="n">extralen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Parse the default alternate setting only, as the UVC specification</span>
<span class="cm">	 * defines a single alternate setting, the default alternate setting</span>
<span class="cm">	 * zero.</span>
<span class="cm">	 */</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_parse_vendor_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buflen</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">USB_DT_CS_INTERFACE</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">next_descriptor</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_parse_standard_control</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">buflen</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">next_descriptor:</span>
		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">buffer</span> <span class="o">+=</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="cm">/* Check if the optional status endpoint is present. Built-in iSight</span>
<span class="cm">	 * webcams have an interrupt endpoint but spit proprietary data that</span>
<span class="cm">	 * don&#39;t conform to the UVC status endpoint messages. Don&#39;t try to</span>
<span class="cm">	 * handle the interrupt endpoint for those cameras.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">alts</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bNumEndpoints</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">&amp;</span> <span class="n">UVC_QUIRK_BUILTIN_ISIGHT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">usb_host_endpoint</span> <span class="o">*</span><span class="n">ep</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">alts</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">desc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ep</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_is_int_in</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">desc</span><span class="o">-&gt;</span><span class="n">wMaxPacketSize</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span>
		    <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bInterval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Found a Status endpoint &quot;</span>
				<span class="s">&quot;(addr %02x).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">desc</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_ep</span> <span class="o">=</span> <span class="n">ep</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * UVC device scan</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Scan the UVC descriptors to locate a chain starting at an Output Terminal</span>
<span class="cm"> * and containing the following units:</span>
<span class="cm"> *</span>
<span class="cm"> * - one or more Output Terminals (USB Streaming or Display)</span>
<span class="cm"> * - zero or one Processing Unit</span>
<span class="cm"> * - zero, one or more single-input Selector Units</span>
<span class="cm"> * - zero or one multiple-input Selector Units, provided all inputs are</span>
<span class="cm"> *   connected to input terminals</span>
<span class="cm"> * - zero, one or mode single-input Extension Units</span>
<span class="cm"> * - one or more Input Terminals (Camera, External or USB Streaming)</span>
<span class="cm"> *</span>
<span class="cm"> * The terminal and units must match on of the following structures:</span>
<span class="cm"> *</span>
<span class="cm"> * ITT_*(0) -&gt; +---------+    +---------+    +---------+ -&gt; TT_STREAMING(0)</span>
<span class="cm"> * ...         | SU{0,1} | -&gt; | PU{0,1} | -&gt; | XU{0,n} |    ...</span>
<span class="cm"> * ITT_*(n) -&gt; +---------+    +---------+    +---------+ -&gt; TT_STREAMING(n)</span>
<span class="cm"> *</span>
<span class="cm"> *                 +---------+    +---------+ -&gt; OTT_*(0)</span>
<span class="cm"> * TT_STREAMING -&gt; | PU{0,1} | -&gt; | XU{0,n} |    ...</span>
<span class="cm"> *                 +---------+    +---------+ -&gt; OTT_*(n)</span>
<span class="cm"> *</span>
<span class="cm"> * The Processing Unit and Extension Units can be in any order. Additional</span>
<span class="cm"> * Extension Units connected to the main chain as single-unit branches are</span>
<span class="cm"> * also supported. Single-input Selector Units are ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_scan_chain_entity</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVC_VC_EXTENSION_UNIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &lt;- XU %d&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">bNrInPins</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Extension unit %d has more &quot;</span>
				<span class="s">&quot;than 1 input pin.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_PROCESSING_UNIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &lt;- PU %d&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">processing</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Found multiple &quot;</span>
				<span class="s">&quot;Processing Units in chain.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chain</span><span class="o">-&gt;</span><span class="n">processing</span> <span class="o">=</span> <span class="n">entity</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_SELECTOR_UNIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &lt;- SU %d&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="cm">/* Single-input selector units are ignored. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">bNrInPins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Found multiple Selector &quot;</span>
				<span class="s">&quot;Units in chain.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">chain</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">=</span> <span class="n">entity</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_ITT_VENDOR_SPECIFIC</span>:
	<span class="k">case</span> <span class="n">UVC_ITT_CAMERA</span>:
	<span class="k">case</span> <span class="n">UVC_ITT_MEDIA_TRANSPORT_INPUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &lt;- IT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_OTT_VENDOR_SPECIFIC</span>:
	<span class="k">case</span> <span class="n">UVC_OTT_DISPLAY</span>:
	<span class="k">case</span> <span class="n">UVC_OTT_MEDIA_TRANSPORT_OUTPUT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; OT %d&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_TT_STREAMING</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_IS_ITERM</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &lt;- IT %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; OT %d&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Unsupported entity type &quot;</span>
			<span class="s">&quot;0x%04x found in chain.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_scan_chain_forward</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">prev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">forward</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span><span class="p">;</span>

	<span class="cm">/* Forward scan */</span>
	<span class="n">forward</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">forward</span> <span class="o">=</span> <span class="n">uvc_entity_by_reference</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span>
			<span class="n">forward</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">forward</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">forward</span> <span class="o">==</span> <span class="n">prev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">forward</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">UVC_VC_EXTENSION_UNIT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">forward</span><span class="o">-&gt;</span><span class="n">bNrInPins</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Extension unit %d &quot;</span>
					  <span class="s">&quot;has more than 1 input pin.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					  <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">forward</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (-&gt;&quot;</span><span class="p">);</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; XU %d&quot;</span><span class="p">,</span> <span class="n">forward</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">UVC_OTT_VENDOR_SPECIFIC</span>:
		<span class="k">case</span> <span class="n">UVC_OTT_DISPLAY</span>:
		<span class="k">case</span> <span class="n">UVC_OTT_MEDIA_TRANSPORT_OUTPUT</span>:
		<span class="k">case</span> <span class="n">UVC_TT_STREAMING</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_IS_ITERM</span><span class="p">(</span><span class="n">forward</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Unsupported input &quot;</span>
					<span class="s">&quot;terminal %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">forward</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">forward</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">found</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (-&gt;&quot;</span><span class="p">);</span>

				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; OT %d&quot;</span><span class="p">,</span> <span class="n">forward</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;)&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_scan_chain_backward</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">**</span><span class="n">_entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span> <span class="o">=</span> <span class="o">*</span><span class="n">_entity</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">entity</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">UVC_VC_EXTENSION_UNIT</span>:
	<span class="k">case</span> <span class="n">UVC_VC_PROCESSING_UNIT</span>:
		<span class="n">id</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_VC_SELECTOR_UNIT</span>:
		<span class="cm">/* Single-input selector units are ignored. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">bNrInPins</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; &lt;- IT&quot;</span><span class="p">);</span>

		<span class="n">chain</span><span class="o">-&gt;</span><span class="n">selector</span> <span class="o">=</span> <span class="n">entity</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">bNrInPins</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">term</span> <span class="o">=</span> <span class="n">uvc_entity_by_id</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">term</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">UVC_ENTITY_IS_ITERM</span><span class="p">(</span><span class="n">term</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Selector unit %d &quot;</span>
					<span class="s">&quot;input %d isn&#39;t connected to an &quot;</span>
					<span class="s">&quot;input terminal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %d&quot;</span><span class="p">,</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
			<span class="n">uvc_scan_chain_forward</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">term</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_trace_param</span> <span class="o">&amp;</span> <span class="n">UVC_TRACE_PROBE</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">UVC_ITT_VENDOR_SPECIFIC</span>:
	<span class="k">case</span> <span class="n">UVC_ITT_CAMERA</span>:
	<span class="k">case</span> <span class="n">UVC_ITT_MEDIA_TRANSPORT_INPUT</span>:
	<span class="k">case</span> <span class="n">UVC_OTT_VENDOR_SPECIFIC</span>:
	<span class="k">case</span> <span class="n">UVC_OTT_DISPLAY</span>:
	<span class="k">case</span> <span class="n">UVC_OTT_MEDIA_TRANSPORT_OUTPUT</span>:
	<span class="k">case</span> <span class="n">UVC_TT_STREAMING</span>:
		<span class="n">id</span> <span class="o">=</span> <span class="n">UVC_ENTITY_IS_OTERM</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">?</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">baSourceID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">_entity</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entity</span> <span class="o">=</span> <span class="n">uvc_entity_by_id</span><span class="p">(</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entity</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Found reference to &quot;</span>
			<span class="s">&quot;unknown entity %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">_entity</span> <span class="o">=</span> <span class="n">entity</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_scan_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">term</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="o">*</span><span class="n">prev</span><span class="p">;</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_PROBE</span><span class="p">,</span> <span class="s">&quot;Scanning UVC chain:&quot;</span><span class="p">);</span>

	<span class="n">entity</span> <span class="o">=</span> <span class="n">term</span><span class="p">;</span>
	<span class="n">prev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">entity</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Entity must not be part of an existing chain */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">.</span><span class="n">next</span> <span class="o">||</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">.</span><span class="n">prev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_DESCR</span><span class="p">,</span> <span class="s">&quot;Found reference to &quot;</span>
				<span class="s">&quot;entity %d already in chain.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Process entity */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_scan_chain_entity</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">entity</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* Forward scan */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_scan_chain_forward</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">entity</span><span class="p">,</span> <span class="n">prev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="cm">/* Backward scan */</span>
		<span class="n">prev</span> <span class="o">=</span> <span class="n">entity</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_scan_chain_backward</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entity</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">uvc_print_terms</span><span class="p">(</span><span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">terms</span><span class="p">,</span> <span class="n">u16</span> <span class="n">dir</span><span class="p">,</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nterms</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="n">terms</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UVC_ENTITY_IS_TERM</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">UVC_TERM_DIRECTION</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dir</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nterms</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;,&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">nterms</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;...&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;%u&quot;</span><span class="p">,</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">p</span> <span class="o">-</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">uvc_print_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">43</span><span class="p">];</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">uvc_print_terms</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">UVC_TERM_INPUT</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot; -&gt; &quot;</span><span class="p">);</span>
	<span class="n">uvc_print_terms</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">UVC_TERM_OUTPUT</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">buffer</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Scan the device for video chains and register video devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Chains are scanned starting at their output terminals and walked backwards.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_scan_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">UVC_ENTITY_IS_OTERM</span><span class="p">(</span><span class="n">term</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* If the terminal is already included in a chain, skip it.</span>
<span class="cm">		 * This can happen for chains that have multiple output</span>
<span class="cm">		 * terminals, where all output terminals beside the first one</span>
<span class="cm">		 * will be inserted in the chain in forward scans.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">term</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">.</span><span class="n">next</span> <span class="o">||</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">.</span><span class="n">prev</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">chain</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">chain</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chain</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

		<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">ctrl_mutex</span><span class="p">);</span>
		<span class="n">chain</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">uvc_scan_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="n">term</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_PROBE</span><span class="p">,</span> <span class="s">&quot;Found a valid video chain (%s).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">uvc_print_chain</span><span class="p">(</span><span class="n">chain</span><span class="p">));</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;No valid video chain found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Video device registration and unregistration</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Delete the UVC device.</span>
<span class="cm"> *</span>
<span class="cm"> * Called by the kernel when the last reference to the uvc_device structure</span>
<span class="cm"> * is released.</span>
<span class="cm"> *</span>
<span class="cm"> * As this function is called after or during disconnect(), all URBs have</span>
<span class="cm"> * already been canceled by the USB core. There is no need to kill the</span>
<span class="cm"> * interrupt URB manually.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_delete</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">usb_put_intf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="p">);</span>

	<span class="n">uvc_status_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">uvc_ctrl_cleanup_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">dev</span><span class="p">)</span>
		<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MEDIA_CONTROLLER</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">media_devnode_is_registered</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">.</span><span class="n">devnode</span><span class="p">))</span>
		<span class="n">media_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>
		<span class="n">chain</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_video_chain</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
		<span class="n">entity</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_entity</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_MEDIA_CONTROLLER</span>
		<span class="n">uvc_mc_cleanup_entity</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
			<span class="n">entity</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">streaming</span><span class="p">;</span>
		<span class="n">streaming</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">uvc_streaming</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">usb_driver_release_interface</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvc_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">,</span>
			<span class="n">streaming</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
		<span class="n">usb_put_intf</span><span class="p">(</span><span class="n">streaming</span><span class="o">-&gt;</span><span class="n">intf</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">streaming</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">streaming</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">.</span><span class="n">bmaControls</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">streaming</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Decrement the registered streams count and delete the device when it</span>
<span class="cm">	 * reaches zero.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nstreams</span><span class="p">))</span>
		<span class="n">uvc_delete</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Unregister the video devices.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_unregister_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>

	<span class="cm">/* Unregistering all video devices might result in uvc_delete() being</span>
<span class="cm">	 * called from inside the loop if there&#39;s no open file handle. To avoid</span>
<span class="cm">	 * that, increment the stream count before iterating over the streams</span>
<span class="cm">	 * and decrement it when done.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nstreams</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">uvc_debugfs_cleanup_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Decrement the stream count and call uvc_delete explicitly if there</span>
<span class="cm">	 * are no stream left.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nstreams</span><span class="p">))</span>
		<span class="n">uvc_delete</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_register_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Initialize the streaming interface with default streaming</span>
<span class="cm">	 * parameters.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_video_init</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to initialize the device &quot;</span>
			<span class="s">&quot;(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uvc_debugfs_init_stream</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>

	<span class="cm">/* Register the device with V4L. */</span>
	<span class="n">vdev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to allocate video device (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We already hold a reference to dev-&gt;udev. The video device will be</span>
<span class="cm">	 * unregistered before the reference is released, so we don&#39;t need to</span>
<span class="cm">	 * get another one.</span>
<span class="cm">	 */</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">uvc_fops</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">=</span> <span class="n">uvc_release</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* Set the driver data before calling video_register_device, otherwise</span>
<span class="cm">	 * uvc_v4l2_open might race us.</span>
<span class="cm">	 */</span>
	<span class="n">stream</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">vdev</span><span class="p">;</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_register_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="s">&quot;Failed to register video device (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">video_device_release</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nstreams</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Register all video devices in all chains.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_register_terms</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uvc_entity</span> <span class="o">*</span><span class="n">term</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">term</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chain</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">,</span> <span class="n">chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">UVC_ENTITY_TYPE</span><span class="p">(</span><span class="n">term</span><span class="p">)</span> <span class="o">!=</span> <span class="n">UVC_TT_STREAMING</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">stream</span> <span class="o">=</span> <span class="n">uvc_stream_by_id</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;No streaming interface found &quot;</span>
				   <span class="s">&quot;for terminal %u.&quot;</span><span class="p">,</span> <span class="n">term</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">stream</span><span class="o">-&gt;</span><span class="n">chain</span> <span class="o">=</span> <span class="n">chain</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_register_video</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">stream</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">term</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">stream</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_register_chains</span><span class="p">(</span><span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_video_chain</span> <span class="o">*</span><span class="n">chain</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">chain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_register_terms</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">chain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MEDIA_CONTROLLER</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_mc_register_entities</span><span class="p">(</span><span class="n">chain</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Failed to register entites &quot;</span>
				<span class="s">&quot;(%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * USB probe, disconnect, suspend and resume</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
		     <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">udev</span> <span class="o">=</span> <span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">idVendor</span> <span class="o">&amp;&amp;</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span><span class="p">)</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_PROBE</span><span class="p">,</span> <span class="s">&quot;Probing known UVC device %s &quot;</span>
				<span class="s">&quot;(%04x:%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">idVendor</span><span class="p">,</span>
				<span class="n">id</span><span class="o">-&gt;</span><span class="n">idProduct</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_PROBE</span><span class="p">,</span> <span class="s">&quot;Probing generic UVC device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">udev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">);</span>

	<span class="cm">/* Allocate memory for the device and initialize it. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">entities</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">chains</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nstreams</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">users</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nmappings</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">udev</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">=</span> <span class="n">usb_get_intf</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">=</span> <span class="p">(</span><span class="n">uvc_quirks_param</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		    <span class="o">?</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span> <span class="o">:</span> <span class="n">uvc_quirks_param</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="s">&quot;UVC Camera (%04x:%04x)&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>

	<span class="cm">/* Parse the Video Class control descriptor. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_parse_control</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_PROBE</span><span class="p">,</span> <span class="s">&quot;Unable to parse UVC &quot;</span>
			<span class="s">&quot;descriptors.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Found UVC %u.%02x device %s (%04x:%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">uvc_version</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">uvc_version</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
		<span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">?</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">product</span> <span class="o">:</span> <span class="s">&quot;&lt;unnamed&gt;&quot;</span><span class="p">,</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">),</span>
		<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span> <span class="o">!=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Forcing device quirks to 0x%x by module &quot;</span>
			<span class="s">&quot;parameter for testing purpose.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">quirks</span><span class="p">);</span>
		<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Please report required quirks to the &quot;</span>
			<span class="s">&quot;linux-uvc-devel mailing list.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Register the media and V4L2 devices. */</span>
<span class="cp">#ifdef CONFIG_MEDIA_CONTROLLER</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">.</span><span class="n">model</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">.</span><span class="n">serial</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">.</span><span class="n">serial</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">.</span><span class="n">bus_info</span><span class="p">,</span> <span class="n">udev</span><span class="o">-&gt;</span><span class="n">devpath</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">.</span><span class="n">hw_revision</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bcdDevice</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">.</span><span class="n">driver_version</span> <span class="o">=</span> <span class="n">LINUX_VERSION_CODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">media_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">.</span><span class="n">mdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mdev</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Initialize controls. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_ctrl_init_device</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Scan the device for video chains. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_scan_device</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Register video device nodes. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_register_chains</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Save our data pointer in the interface data. */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Initialize the interrupt URB. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_status_init</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="s">&quot;Unable to initialize the status &quot;</span>
			<span class="s">&quot;endpoint (%d), status interrupt will not be &quot;</span>
			<span class="s">&quot;supported.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_PROBE</span><span class="p">,</span> <span class="s">&quot;UVC device initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">usb_enable_autosuspend</span><span class="p">(</span><span class="n">udev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">uvc_unregister_video</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">uvc_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>

	<span class="cm">/* Set the USB interface data to NULL. This can be done outside the</span>
<span class="cm">	 * lock, as there&#39;s no other reader.</span>
<span class="cm">	 */</span>
	<span class="n">usb_set_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">==</span>
	    <span class="n">UVC_SC_VIDEOSTREAMING</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">UVC_DEV_DISCONNECTED</span><span class="p">;</span>

	<span class="n">uvc_unregister_video</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">message</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_SUSPEND</span><span class="p">,</span> <span class="s">&quot;Suspending interface %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>

	<span class="cm">/* Controls are cached on the fly so they don&#39;t need to be saved. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">==</span>
	    <span class="n">UVC_SC_VIDEOCONTROL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">uvc_status_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">==</span> <span class="n">intf</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">uvc_video_suspend</span><span class="p">(</span><span class="n">stream</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_SUSPEND</span><span class="p">,</span> <span class="s">&quot;Suspend: video streaming USB interface &quot;</span>
			<span class="s">&quot;mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__uvc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">uvc_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">uvc_streaming</span> <span class="o">*</span><span class="n">stream</span><span class="p">;</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_SUSPEND</span><span class="p">,</span> <span class="s">&quot;Resuming interface %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">cur_altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceSubClass</span> <span class="o">==</span>
	    <span class="n">UVC_SC_VIDEOCONTROL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">uvc_ctrl_resume_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">uvc_status_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">stream</span><span class="o">-&gt;</span><span class="n">intf</span> <span class="o">==</span> <span class="n">intf</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">uvc_video_resume</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">reset</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">uvc_trace</span><span class="p">(</span><span class="n">UVC_TRACE_SUSPEND</span><span class="p">,</span> <span class="s">&quot;Resume: video streaming USB interface &quot;</span>
			<span class="s">&quot;mismatch.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__uvc_resume</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_reset_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__uvc_resume</span><span class="p">(</span><span class="n">intf</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Module parameters</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_clock_param_get</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">uvc_clock_param</span> <span class="o">==</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;CLOCK_MONOTONIC&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;CLOCK_REALTIME&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">uvc_clock_param_set</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncasecmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;clock_&quot;</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;clock_&quot;</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="s">&quot;clock_&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;monotonic&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uvc_clock_param</span> <span class="o">=</span> <span class="n">CLOCK_MONOTONIC</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcasecmp</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s">&quot;realtime&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">uvc_clock_param</span> <span class="o">=</span> <span class="n">CLOCK_REALTIME</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">module_param_call</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">uvc_clock_param_set</span><span class="p">,</span> <span class="n">uvc_clock_param_get</span><span class="p">,</span>
		  <span class="o">&amp;</span><span class="n">uvc_clock_param</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="s">&quot;Video buffers timestamp clock&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">nodrop</span><span class="p">,</span> <span class="n">uvc_no_drop_param</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">nodrop</span><span class="p">,</span> <span class="s">&quot;Don&#39;t drop incomplete frames&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">quirks</span><span class="p">,</span> <span class="n">uvc_quirks_param</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">quirks</span><span class="p">,</span> <span class="s">&quot;Forced device quirks&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="n">uvc_trace_param</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">trace</span><span class="p">,</span> <span class="s">&quot;Trace level bitmask&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">uvc_timeout_param</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="o">|</span><span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="s">&quot;Streaming control requests timeout&quot;</span><span class="p">);</span>

<span class="cm">/* ------------------------------------------------------------------------</span>
<span class="cm"> * Driver initialization and cleanup</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * The Logitech cameras listed below have their interface class set to</span>
<span class="cm"> * VENDOR_SPEC because they don&#39;t announce themselves as UVC devices, even</span>
<span class="cm"> * though they are compliant.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">uvc_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* LogiLink Wireless Webcam */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0416</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0xa91a</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span> <span class="p">},</span>
	<span class="cm">/* Genius eFace 2025 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0458</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x706e</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span> <span class="p">},</span>
	<span class="cm">/* Microsoft Lifecam NX-6000 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x045e</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x00f8</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span> <span class="p">},</span>
	<span class="cm">/* Microsoft Lifecam VX-7000 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x045e</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0723</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span> <span class="p">},</span>
	<span class="cm">/* Logitech Quickcam Fusion */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x046d</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x08c1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VENDOR_SPEC</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Logitech Quickcam Orbit MP */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x046d</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x08c2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VENDOR_SPEC</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Logitech Quickcam Pro for Notebook */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x046d</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x08c3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VENDOR_SPEC</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Logitech Quickcam Pro 5000 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x046d</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x08c5</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VENDOR_SPEC</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Logitech Quickcam OEM Dell Notebook */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x046d</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x08c6</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VENDOR_SPEC</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Logitech Quickcam OEM Cisco VT Camera II */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x046d</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x08c7</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VENDOR_SPEC</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Chicony CNF7129 (Asus EEE 100HE) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x04f2</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0xb071</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_RESTRICT_FRAME_RATE</span> <span class="p">},</span>
	<span class="cm">/* Alcor Micro AU3820 (Future Boy PC USB Webcam) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x058f</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x3820</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span> <span class="p">},</span>
	<span class="cm">/* Dell XPS m1530 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x05a9</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x2640</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span> 		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_DEF</span> <span class="p">},</span>
	<span class="cm">/* Apple Built-In iSight */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x05ac</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x8501</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span> 		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span>
				<span class="o">|</span> <span class="n">UVC_QUIRK_BUILTIN_ISIGHT</span> <span class="p">},</span>
	<span class="cm">/* Foxlink (&quot;HP Webcam&quot; on HP Mini 5103) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x05c8</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0403</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_FIX_BANDWIDTH</span> <span class="p">},</span>
	<span class="cm">/* Genesys Logic USB 2.0 PC Camera */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x05e3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0505</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* Hercules Classic Silver */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x06f8</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x300c</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_FIX_BANDWIDTH</span> <span class="p">},</span>
	<span class="cm">/* ViMicro Vega */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0ac8</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x332d</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_FIX_BANDWIDTH</span> <span class="p">},</span>
	<span class="cm">/* ViMicro - Minoru3D */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0ac8</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x3410</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_FIX_BANDWIDTH</span> <span class="p">},</span>
	<span class="cm">/* ViMicro Venus - Minoru3D */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0ac8</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x3420</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_FIX_BANDWIDTH</span> <span class="p">},</span>
	<span class="cm">/* MT6227 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0e8d</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0004</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span>
				<span class="o">|</span> <span class="n">UVC_QUIRK_PROBE_DEF</span> <span class="p">},</span>
	<span class="cm">/* IMC Networks (Medion Akoya) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x13d3</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x5103</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* JMicron USB2.0 XGA WebCam */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x152d</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0310</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span> <span class="p">},</span>
	<span class="cm">/* Syntek (HP Spartan) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x174f</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x5212</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* Syntek (Samsung Q310) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x174f</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x5931</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* Syntek (Packard Bell EasyNote MX52 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x174f</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x8a12</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* Syntek (Asus F9SG) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x174f</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x8a31</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* Syntek (Asus U3S) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x174f</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x8a33</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* Syntek (JAOtech Smart Terminal) */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x174f</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x8a34</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* Miricle 307K */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x17dc</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0202</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* Lenovo Thinkpad SL400/SL500 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x17ef</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x480b</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STREAM_NO_FID</span> <span class="p">},</span>
	<span class="cm">/* Aveo Technology USB 2.0 Camera */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x1871</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0306</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span>
				<span class="o">|</span> <span class="n">UVC_QUIRK_PROBE_EXTRAFIELDS</span> <span class="p">},</span>
	<span class="cm">/* Ecamm Pico iMage */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x18cd</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0xcafe</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_EXTRAFIELDS</span> <span class="p">},</span>
	<span class="cm">/* Manta MM-353 Plako */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x18ec</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x3188</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span> <span class="p">},</span>
	<span class="cm">/* FSC WebCam V30S */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x18ec</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x3288</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span> <span class="p">},</span>
	<span class="cm">/* Arkmicro unbranded */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x18ec</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x3290</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_DEF</span> <span class="p">},</span>
	<span class="cm">/* The Imaging Source USB CCD cameras */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x199e</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x8102</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VENDOR_SPEC</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="cm">/* Bodelin ProScopeHR */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEV_HI</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x19ab</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bcdDevice_hi</span>		<span class="o">=</span> <span class="mh">0x0126</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_STATUS_INTERVAL</span> <span class="p">},</span>
	<span class="cm">/* MSI StarCam 370i */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x1b3b</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x2951</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span> <span class="p">},</span>
	<span class="cm">/* SiGma Micro USB Web Camera */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">match_flags</span>		<span class="o">=</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span>
				<span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x1c4f</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x3000</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceClass</span>	<span class="o">=</span> <span class="n">USB_CLASS_VIDEO</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceSubClass</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">bInterfaceProtocol</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="n">UVC_QUIRK_PROBE_MINMAX</span>
				<span class="o">|</span> <span class="n">UVC_QUIRK_IGNORE_SELECTOR_UNIT</span> <span class="p">},</span>
	<span class="cm">/* Generic USB Video Class */</span>
	<span class="p">{</span> <span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_VIDEO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">uvc_ids</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">uvc_driver</span> <span class="n">uvc_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;uvcvideo&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">uvc_probe</span><span class="p">,</span>
		<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">uvc_disconnect</span><span class="p">,</span>
		<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">uvc_suspend</span><span class="p">,</span>
		<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">uvc_resume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">reset_resume</span>	<span class="o">=</span> <span class="n">uvc_reset_resume</span><span class="p">,</span>
		<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">uvc_ids</span><span class="p">,</span>
		<span class="p">.</span><span class="n">supports_autosuspend</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">uvc_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">uvc_debugfs_init</span><span class="p">();</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvc_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">uvc_debugfs_cleanup</span><span class="p">();</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRIVER_DESC</span> <span class="s">&quot; (&quot;</span> <span class="n">DRIVER_VERSION</span> <span class="s">&quot;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">uvc_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">uvc_driver</span><span class="p">.</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">uvc_debugfs_cleanup</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">uvc_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">uvc_cleanup</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
