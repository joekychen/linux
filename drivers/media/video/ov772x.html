<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › ov772x.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ov772x.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ov772x Camera Driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2008 Renesas Solutions Corp.</span>
<span class="cm"> * Kuninori Morimoto &lt;morimoto.kuninori@renesas.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on ov7670 and soc_camera_platform driver,</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright 2006-7 Jonathan Corbet &lt;corbet@lwn.net&gt;</span>
<span class="cm"> * Copyright (C) 2008 Magnus Damm</span>
<span class="cm"> * Copyright (C) 2008, Guennadi Liakhovetski &lt;kernel@pengutronix.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>

<span class="cp">#include &lt;media/ov772x.h&gt;</span>
<span class="cp">#include &lt;media/soc_camera.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ctrls.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-subdev.h&gt;</span>

<span class="cm">/*</span>
<span class="cm"> * register offset</span>
<span class="cm"> */</span>
<span class="cp">#define GAIN        0x00 </span><span class="cm">/* AGC - Gain control gain setting */</span><span class="cp"></span>
<span class="cp">#define BLUE        0x01 </span><span class="cm">/* AWB - Blue channel gain setting */</span><span class="cp"></span>
<span class="cp">#define RED         0x02 </span><span class="cm">/* AWB - Red   channel gain setting */</span><span class="cp"></span>
<span class="cp">#define GREEN       0x03 </span><span class="cm">/* AWB - Green channel gain setting */</span><span class="cp"></span>
<span class="cp">#define COM1        0x04 </span><span class="cm">/* Common control 1 */</span><span class="cp"></span>
<span class="cp">#define BAVG        0x05 </span><span class="cm">/* U/B Average Level */</span><span class="cp"></span>
<span class="cp">#define GAVG        0x06 </span><span class="cm">/* Y/Gb Average Level */</span><span class="cp"></span>
<span class="cp">#define RAVG        0x07 </span><span class="cm">/* V/R Average Level */</span><span class="cp"></span>
<span class="cp">#define AECH        0x08 </span><span class="cm">/* Exposure Value - AEC MSBs */</span><span class="cp"></span>
<span class="cp">#define COM2        0x09 </span><span class="cm">/* Common control 2 */</span><span class="cp"></span>
<span class="cp">#define PID         0x0A </span><span class="cm">/* Product ID Number MSB */</span><span class="cp"></span>
<span class="cp">#define VER         0x0B </span><span class="cm">/* Product ID Number LSB */</span><span class="cp"></span>
<span class="cp">#define COM3        0x0C </span><span class="cm">/* Common control 3 */</span><span class="cp"></span>
<span class="cp">#define COM4        0x0D </span><span class="cm">/* Common control 4 */</span><span class="cp"></span>
<span class="cp">#define COM5        0x0E </span><span class="cm">/* Common control 5 */</span><span class="cp"></span>
<span class="cp">#define COM6        0x0F </span><span class="cm">/* Common control 6 */</span><span class="cp"></span>
<span class="cp">#define AEC         0x10 </span><span class="cm">/* Exposure Value */</span><span class="cp"></span>
<span class="cp">#define CLKRC       0x11 </span><span class="cm">/* Internal clock */</span><span class="cp"></span>
<span class="cp">#define COM7        0x12 </span><span class="cm">/* Common control 7 */</span><span class="cp"></span>
<span class="cp">#define COM8        0x13 </span><span class="cm">/* Common control 8 */</span><span class="cp"></span>
<span class="cp">#define COM9        0x14 </span><span class="cm">/* Common control 9 */</span><span class="cp"></span>
<span class="cp">#define COM10       0x15 </span><span class="cm">/* Common control 10 */</span><span class="cp"></span>
<span class="cp">#define REG16       0x16 </span><span class="cm">/* Register 16 */</span><span class="cp"></span>
<span class="cp">#define HSTART      0x17 </span><span class="cm">/* Horizontal sensor size */</span><span class="cp"></span>
<span class="cp">#define HSIZE       0x18 </span><span class="cm">/* Horizontal frame (HREF column) end high 8-bit */</span><span class="cp"></span>
<span class="cp">#define VSTART      0x19 </span><span class="cm">/* Vertical frame (row) start high 8-bit */</span><span class="cp"></span>
<span class="cp">#define VSIZE       0x1A </span><span class="cm">/* Vertical sensor size */</span><span class="cp"></span>
<span class="cp">#define PSHFT       0x1B </span><span class="cm">/* Data format - pixel delay select */</span><span class="cp"></span>
<span class="cp">#define MIDH        0x1C </span><span class="cm">/* Manufacturer ID byte - high */</span><span class="cp"></span>
<span class="cp">#define MIDL        0x1D </span><span class="cm">/* Manufacturer ID byte - low  */</span><span class="cp"></span>
<span class="cp">#define LAEC        0x1F </span><span class="cm">/* Fine AEC value */</span><span class="cp"></span>
<span class="cp">#define COM11       0x20 </span><span class="cm">/* Common control 11 */</span><span class="cp"></span>
<span class="cp">#define BDBASE      0x22 </span><span class="cm">/* Banding filter Minimum AEC value */</span><span class="cp"></span>
<span class="cp">#define DBSTEP      0x23 </span><span class="cm">/* Banding filter Maximum Setp */</span><span class="cp"></span>
<span class="cp">#define AEW         0x24 </span><span class="cm">/* AGC/AEC - Stable operating region (upper limit) */</span><span class="cp"></span>
<span class="cp">#define AEB         0x25 </span><span class="cm">/* AGC/AEC - Stable operating region (lower limit) */</span><span class="cp"></span>
<span class="cp">#define VPT         0x26 </span><span class="cm">/* AGC/AEC Fast mode operating region */</span><span class="cp"></span>
<span class="cp">#define REG28       0x28 </span><span class="cm">/* Register 28 */</span><span class="cp"></span>
<span class="cp">#define HOUTSIZE    0x29 </span><span class="cm">/* Horizontal data output size MSBs */</span><span class="cp"></span>
<span class="cp">#define EXHCH       0x2A </span><span class="cm">/* Dummy pixel insert MSB */</span><span class="cp"></span>
<span class="cp">#define EXHCL       0x2B </span><span class="cm">/* Dummy pixel insert LSB */</span><span class="cp"></span>
<span class="cp">#define VOUTSIZE    0x2C </span><span class="cm">/* Vertical data output size MSBs */</span><span class="cp"></span>
<span class="cp">#define ADVFL       0x2D </span><span class="cm">/* LSB of insert dummy lines in Vertical direction */</span><span class="cp"></span>
<span class="cp">#define ADVFH       0x2E </span><span class="cm">/* MSG of insert dummy lines in Vertical direction */</span><span class="cp"></span>
<span class="cp">#define YAVE        0x2F </span><span class="cm">/* Y/G Channel Average value */</span><span class="cp"></span>
<span class="cp">#define LUMHTH      0x30 </span><span class="cm">/* Histogram AEC/AGC Luminance high level threshold */</span><span class="cp"></span>
<span class="cp">#define LUMLTH      0x31 </span><span class="cm">/* Histogram AEC/AGC Luminance low  level threshold */</span><span class="cp"></span>
<span class="cp">#define HREF        0x32 </span><span class="cm">/* Image start and size control */</span><span class="cp"></span>
<span class="cp">#define DM_LNL      0x33 </span><span class="cm">/* Dummy line low  8 bits */</span><span class="cp"></span>
<span class="cp">#define DM_LNH      0x34 </span><span class="cm">/* Dummy line high 8 bits */</span><span class="cp"></span>
<span class="cp">#define ADOFF_B     0x35 </span><span class="cm">/* AD offset compensation value for B  channel */</span><span class="cp"></span>
<span class="cp">#define ADOFF_R     0x36 </span><span class="cm">/* AD offset compensation value for R  channel */</span><span class="cp"></span>
<span class="cp">#define ADOFF_GB    0x37 </span><span class="cm">/* AD offset compensation value for Gb channel */</span><span class="cp"></span>
<span class="cp">#define ADOFF_GR    0x38 </span><span class="cm">/* AD offset compensation value for Gr channel */</span><span class="cp"></span>
<span class="cp">#define OFF_B       0x39 </span><span class="cm">/* Analog process B  channel offset value */</span><span class="cp"></span>
<span class="cp">#define OFF_R       0x3A </span><span class="cm">/* Analog process R  channel offset value */</span><span class="cp"></span>
<span class="cp">#define OFF_GB      0x3B </span><span class="cm">/* Analog process Gb channel offset value */</span><span class="cp"></span>
<span class="cp">#define OFF_GR      0x3C </span><span class="cm">/* Analog process Gr channel offset value */</span><span class="cp"></span>
<span class="cp">#define COM12       0x3D </span><span class="cm">/* Common control 12 */</span><span class="cp"></span>
<span class="cp">#define COM13       0x3E </span><span class="cm">/* Common control 13 */</span><span class="cp"></span>
<span class="cp">#define COM14       0x3F </span><span class="cm">/* Common control 14 */</span><span class="cp"></span>
<span class="cp">#define COM15       0x40 </span><span class="cm">/* Common control 15*/</span><span class="cp"></span>
<span class="cp">#define COM16       0x41 </span><span class="cm">/* Common control 16 */</span><span class="cp"></span>
<span class="cp">#define TGT_B       0x42 </span><span class="cm">/* BLC blue channel target value */</span><span class="cp"></span>
<span class="cp">#define TGT_R       0x43 </span><span class="cm">/* BLC red  channel target value */</span><span class="cp"></span>
<span class="cp">#define TGT_GB      0x44 </span><span class="cm">/* BLC Gb   channel target value */</span><span class="cp"></span>
<span class="cp">#define TGT_GR      0x45 </span><span class="cm">/* BLC Gr   channel target value */</span><span class="cp"></span>
<span class="cm">/* for ov7720 */</span>
<span class="cp">#define LCC0        0x46 </span><span class="cm">/* Lens correction control 0 */</span><span class="cp"></span>
<span class="cp">#define LCC1        0x47 </span><span class="cm">/* Lens correction option 1 - X coordinate */</span><span class="cp"></span>
<span class="cp">#define LCC2        0x48 </span><span class="cm">/* Lens correction option 2 - Y coordinate */</span><span class="cp"></span>
<span class="cp">#define LCC3        0x49 </span><span class="cm">/* Lens correction option 3 */</span><span class="cp"></span>
<span class="cp">#define LCC4        0x4A </span><span class="cm">/* Lens correction option 4 - radius of the circular */</span><span class="cp"></span>
<span class="cp">#define LCC5        0x4B </span><span class="cm">/* Lens correction option 5 */</span><span class="cp"></span>
<span class="cp">#define LCC6        0x4C </span><span class="cm">/* Lens correction option 6 */</span><span class="cp"></span>
<span class="cm">/* for ov7725 */</span>
<span class="cp">#define LC_CTR      0x46 </span><span class="cm">/* Lens correction control */</span><span class="cp"></span>
<span class="cp">#define LC_XC       0x47 </span><span class="cm">/* X coordinate of lens correction center relative */</span><span class="cp"></span>
<span class="cp">#define LC_YC       0x48 </span><span class="cm">/* Y coordinate of lens correction center relative */</span><span class="cp"></span>
<span class="cp">#define LC_COEF     0x49 </span><span class="cm">/* Lens correction coefficient */</span><span class="cp"></span>
<span class="cp">#define LC_RADI     0x4A </span><span class="cm">/* Lens correction radius */</span><span class="cp"></span>
<span class="cp">#define LC_COEFB    0x4B </span><span class="cm">/* Lens B channel compensation coefficient */</span><span class="cp"></span>
<span class="cp">#define LC_COEFR    0x4C </span><span class="cm">/* Lens R channel compensation coefficient */</span><span class="cp"></span>

<span class="cp">#define FIXGAIN     0x4D </span><span class="cm">/* Analog fix gain amplifer */</span><span class="cp"></span>
<span class="cp">#define AREF0       0x4E </span><span class="cm">/* Sensor reference control */</span><span class="cp"></span>
<span class="cp">#define AREF1       0x4F </span><span class="cm">/* Sensor reference current control */</span><span class="cp"></span>
<span class="cp">#define AREF2       0x50 </span><span class="cm">/* Analog reference control */</span><span class="cp"></span>
<span class="cp">#define AREF3       0x51 </span><span class="cm">/* ADC    reference control */</span><span class="cp"></span>
<span class="cp">#define AREF4       0x52 </span><span class="cm">/* ADC    reference control */</span><span class="cp"></span>
<span class="cp">#define AREF5       0x53 </span><span class="cm">/* ADC    reference control */</span><span class="cp"></span>
<span class="cp">#define AREF6       0x54 </span><span class="cm">/* Analog reference control */</span><span class="cp"></span>
<span class="cp">#define AREF7       0x55 </span><span class="cm">/* Analog reference control */</span><span class="cp"></span>
<span class="cp">#define UFIX        0x60 </span><span class="cm">/* U channel fixed value output */</span><span class="cp"></span>
<span class="cp">#define VFIX        0x61 </span><span class="cm">/* V channel fixed value output */</span><span class="cp"></span>
<span class="cp">#define AWBB_BLK    0x62 </span><span class="cm">/* AWB option for advanced AWB */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL0   0x63 </span><span class="cm">/* AWB control byte 0 */</span><span class="cp"></span>
<span class="cp">#define DSP_CTRL1   0x64 </span><span class="cm">/* DSP control byte 1 */</span><span class="cp"></span>
<span class="cp">#define DSP_CTRL2   0x65 </span><span class="cm">/* DSP control byte 2 */</span><span class="cp"></span>
<span class="cp">#define DSP_CTRL3   0x66 </span><span class="cm">/* DSP control byte 3 */</span><span class="cp"></span>
<span class="cp">#define DSP_CTRL4   0x67 </span><span class="cm">/* DSP control byte 4 */</span><span class="cp"></span>
<span class="cp">#define AWB_BIAS    0x68 </span><span class="cm">/* AWB BLC level clip */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL1   0x69 </span><span class="cm">/* AWB control  1 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL2   0x6A </span><span class="cm">/* AWB control  2 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL3   0x6B </span><span class="cm">/* AWB control  3 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL4   0x6C </span><span class="cm">/* AWB control  4 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL5   0x6D </span><span class="cm">/* AWB control  5 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL6   0x6E </span><span class="cm">/* AWB control  6 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL7   0x6F </span><span class="cm">/* AWB control  7 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL8   0x70 </span><span class="cm">/* AWB control  8 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL9   0x71 </span><span class="cm">/* AWB control  9 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL10  0x72 </span><span class="cm">/* AWB control 10 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL11  0x73 </span><span class="cm">/* AWB control 11 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL12  0x74 </span><span class="cm">/* AWB control 12 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL13  0x75 </span><span class="cm">/* AWB control 13 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL14  0x76 </span><span class="cm">/* AWB control 14 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL15  0x77 </span><span class="cm">/* AWB control 15 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL16  0x78 </span><span class="cm">/* AWB control 16 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL17  0x79 </span><span class="cm">/* AWB control 17 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL18  0x7A </span><span class="cm">/* AWB control 18 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL19  0x7B </span><span class="cm">/* AWB control 19 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL20  0x7C </span><span class="cm">/* AWB control 20 */</span><span class="cp"></span>
<span class="cp">#define AWB_CTRL21  0x7D </span><span class="cm">/* AWB control 21 */</span><span class="cp"></span>
<span class="cp">#define GAM1        0x7E </span><span class="cm">/* Gamma Curve  1st segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM2        0x7F </span><span class="cm">/* Gamma Curve  2nd segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM3        0x80 </span><span class="cm">/* Gamma Curve  3rd segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM4        0x81 </span><span class="cm">/* Gamma Curve  4th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM5        0x82 </span><span class="cm">/* Gamma Curve  5th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM6        0x83 </span><span class="cm">/* Gamma Curve  6th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM7        0x84 </span><span class="cm">/* Gamma Curve  7th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM8        0x85 </span><span class="cm">/* Gamma Curve  8th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM9        0x86 </span><span class="cm">/* Gamma Curve  9th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM10       0x87 </span><span class="cm">/* Gamma Curve 10th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM11       0x88 </span><span class="cm">/* Gamma Curve 11th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM12       0x89 </span><span class="cm">/* Gamma Curve 12th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM13       0x8A </span><span class="cm">/* Gamma Curve 13th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM14       0x8B </span><span class="cm">/* Gamma Curve 14th segment input end point */</span><span class="cp"></span>
<span class="cp">#define GAM15       0x8C </span><span class="cm">/* Gamma Curve 15th segment input end point */</span><span class="cp"></span>
<span class="cp">#define SLOP        0x8D </span><span class="cm">/* Gamma curve highest segment slope */</span><span class="cp"></span>
<span class="cp">#define DNSTH       0x8E </span><span class="cm">/* De-noise threshold */</span><span class="cp"></span>
<span class="cp">#define EDGE_STRNGT 0x8F </span><span class="cm">/* Edge strength  control when manual mode */</span><span class="cp"></span>
<span class="cp">#define EDGE_TRSHLD 0x90 </span><span class="cm">/* Edge threshold control when manual mode */</span><span class="cp"></span>
<span class="cp">#define DNSOFF      0x91 </span><span class="cm">/* Auto De-noise threshold control */</span><span class="cp"></span>
<span class="cp">#define EDGE_UPPER  0x92 </span><span class="cm">/* Edge strength upper limit when Auto mode */</span><span class="cp"></span>
<span class="cp">#define EDGE_LOWER  0x93 </span><span class="cm">/* Edge strength lower limit when Auto mode */</span><span class="cp"></span>
<span class="cp">#define MTX1        0x94 </span><span class="cm">/* Matrix coefficient 1 */</span><span class="cp"></span>
<span class="cp">#define MTX2        0x95 </span><span class="cm">/* Matrix coefficient 2 */</span><span class="cp"></span>
<span class="cp">#define MTX3        0x96 </span><span class="cm">/* Matrix coefficient 3 */</span><span class="cp"></span>
<span class="cp">#define MTX4        0x97 </span><span class="cm">/* Matrix coefficient 4 */</span><span class="cp"></span>
<span class="cp">#define MTX5        0x98 </span><span class="cm">/* Matrix coefficient 5 */</span><span class="cp"></span>
<span class="cp">#define MTX6        0x99 </span><span class="cm">/* Matrix coefficient 6 */</span><span class="cp"></span>
<span class="cp">#define MTX_CTRL    0x9A </span><span class="cm">/* Matrix control */</span><span class="cp"></span>
<span class="cp">#define BRIGHT      0x9B </span><span class="cm">/* Brightness control */</span><span class="cp"></span>
<span class="cp">#define CNTRST      0x9C </span><span class="cm">/* Contrast contrast */</span><span class="cp"></span>
<span class="cp">#define CNTRST_CTRL 0x9D </span><span class="cm">/* Contrast contrast center */</span><span class="cp"></span>
<span class="cp">#define UVAD_J0     0x9E </span><span class="cm">/* Auto UV adjust contrast 0 */</span><span class="cp"></span>
<span class="cp">#define UVAD_J1     0x9F </span><span class="cm">/* Auto UV adjust contrast 1 */</span><span class="cp"></span>
<span class="cp">#define SCAL0       0xA0 </span><span class="cm">/* Scaling control 0 */</span><span class="cp"></span>
<span class="cp">#define SCAL1       0xA1 </span><span class="cm">/* Scaling control 1 */</span><span class="cp"></span>
<span class="cp">#define SCAL2       0xA2 </span><span class="cm">/* Scaling control 2 */</span><span class="cp"></span>
<span class="cp">#define FIFODLYM    0xA3 </span><span class="cm">/* FIFO manual mode delay control */</span><span class="cp"></span>
<span class="cp">#define FIFODLYA    0xA4 </span><span class="cm">/* FIFO auto   mode delay control */</span><span class="cp"></span>
<span class="cp">#define SDE         0xA6 </span><span class="cm">/* Special digital effect control */</span><span class="cp"></span>
<span class="cp">#define USAT        0xA7 </span><span class="cm">/* U component saturation control */</span><span class="cp"></span>
<span class="cp">#define VSAT        0xA8 </span><span class="cm">/* V component saturation control */</span><span class="cp"></span>
<span class="cm">/* for ov7720 */</span>
<span class="cp">#define HUE0        0xA9 </span><span class="cm">/* Hue control 0 */</span><span class="cp"></span>
<span class="cp">#define HUE1        0xAA </span><span class="cm">/* Hue control 1 */</span><span class="cp"></span>
<span class="cm">/* for ov7725 */</span>
<span class="cp">#define HUECOS      0xA9 </span><span class="cm">/* Cosine value */</span><span class="cp"></span>
<span class="cp">#define HUESIN      0xAA </span><span class="cm">/* Sine value */</span><span class="cp"></span>

<span class="cp">#define SIGN        0xAB </span><span class="cm">/* Sign bit for Hue and contrast */</span><span class="cp"></span>
<span class="cp">#define DSPAUTO     0xAC </span><span class="cm">/* DSP auto function ON/OFF control */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * register detail</span>
<span class="cm"> */</span>

<span class="cm">/* COM2 */</span>
<span class="cp">#define SOFT_SLEEP_MODE 0x10	</span><span class="cm">/* Soft sleep mode */</span><span class="cp"></span>
				<span class="cm">/* Output drive capability */</span>
<span class="cp">#define OCAP_1x         0x00	</span><span class="cm">/* 1x */</span><span class="cp"></span>
<span class="cp">#define OCAP_2x         0x01	</span><span class="cm">/* 2x */</span><span class="cp"></span>
<span class="cp">#define OCAP_3x         0x02	</span><span class="cm">/* 3x */</span><span class="cp"></span>
<span class="cp">#define OCAP_4x         0x03	</span><span class="cm">/* 4x */</span><span class="cp"></span>

<span class="cm">/* COM3 */</span>
<span class="cp">#define SWAP_MASK       (SWAP_RGB | SWAP_YUV | SWAP_ML)</span>
<span class="cp">#define IMG_MASK        (VFLIP_IMG | HFLIP_IMG)</span>

<span class="cp">#define VFLIP_IMG       0x80	</span><span class="cm">/* Vertical flip image ON/OFF selection */</span><span class="cp"></span>
<span class="cp">#define HFLIP_IMG       0x40	</span><span class="cm">/* Horizontal mirror image ON/OFF selection */</span><span class="cp"></span>
<span class="cp">#define SWAP_RGB        0x20	</span><span class="cm">/* Swap B/R  output sequence in RGB mode */</span><span class="cp"></span>
<span class="cp">#define SWAP_YUV        0x10	</span><span class="cm">/* Swap Y/UV output sequence in YUV mode */</span><span class="cp"></span>
<span class="cp">#define SWAP_ML         0x08	</span><span class="cm">/* Swap output MSB/LSB */</span><span class="cp"></span>
				<span class="cm">/* Tri-state option for output clock */</span>
<span class="cp">#define NOTRI_CLOCK     0x04	</span><span class="cm">/*   0: Tri-state    at this period */</span><span class="cp"></span>
				<span class="cm">/*   1: No tri-state at this period */</span>
				<span class="cm">/* Tri-state option for output data */</span>
<span class="cp">#define NOTRI_DATA      0x02	</span><span class="cm">/*   0: Tri-state    at this period */</span><span class="cp"></span>
				<span class="cm">/*   1: No tri-state at this period */</span>
<span class="cp">#define SCOLOR_TEST     0x01	</span><span class="cm">/* Sensor color bar test pattern */</span><span class="cp"></span>

<span class="cm">/* COM4 */</span>
				<span class="cm">/* PLL frequency control */</span>
<span class="cp">#define PLL_BYPASS      0x00	</span><span class="cm">/*  00: Bypass PLL */</span><span class="cp"></span>
<span class="cp">#define PLL_4x          0x40	</span><span class="cm">/*  01: PLL 4x */</span><span class="cp"></span>
<span class="cp">#define PLL_6x          0x80	</span><span class="cm">/*  10: PLL 6x */</span><span class="cp"></span>
<span class="cp">#define PLL_8x          0xc0	</span><span class="cm">/*  11: PLL 8x */</span><span class="cp"></span>
				<span class="cm">/* AEC evaluate window */</span>
<span class="cp">#define AEC_FULL        0x00	</span><span class="cm">/*  00: Full window */</span><span class="cp"></span>
<span class="cp">#define AEC_1p2         0x10	</span><span class="cm">/*  01: 1/2  window */</span><span class="cp"></span>
<span class="cp">#define AEC_1p4         0x20	</span><span class="cm">/*  10: 1/4  window */</span><span class="cp"></span>
<span class="cp">#define AEC_2p3         0x30	</span><span class="cm">/*  11: Low 2/3 window */</span><span class="cp"></span>

<span class="cm">/* COM5 */</span>
<span class="cp">#define AFR_ON_OFF      0x80	</span><span class="cm">/* Auto frame rate control ON/OFF selection */</span><span class="cp"></span>
<span class="cp">#define AFR_SPPED       0x40	</span><span class="cm">/* Auto frame rate control speed selection */</span><span class="cp"></span>
				<span class="cm">/* Auto frame rate max rate control */</span>
<span class="cp">#define AFR_NO_RATE     0x00	</span><span class="cm">/*     No  reduction of frame rate */</span><span class="cp"></span>
<span class="cp">#define AFR_1p2         0x10	</span><span class="cm">/*     Max reduction to 1/2 frame rate */</span><span class="cp"></span>
<span class="cp">#define AFR_1p4         0x20	</span><span class="cm">/*     Max reduction to 1/4 frame rate */</span><span class="cp"></span>
<span class="cp">#define AFR_1p8         0x30	</span><span class="cm">/* Max reduction to 1/8 frame rate */</span><span class="cp"></span>
				<span class="cm">/* Auto frame rate active point control */</span>
<span class="cp">#define AF_2x           0x00	</span><span class="cm">/*     Add frame when AGC reaches  2x gain */</span><span class="cp"></span>
<span class="cp">#define AF_4x           0x04	</span><span class="cm">/*     Add frame when AGC reaches  4x gain */</span><span class="cp"></span>
<span class="cp">#define AF_8x           0x08	</span><span class="cm">/*     Add frame when AGC reaches  8x gain */</span><span class="cp"></span>
<span class="cp">#define AF_16x          0x0c	</span><span class="cm">/* Add frame when AGC reaches 16x gain */</span><span class="cp"></span>
				<span class="cm">/* AEC max step control */</span>
<span class="cp">#define AEC_NO_LIMIT    0x01	</span><span class="cm">/*   0 : AEC incease step has limit */</span><span class="cp"></span>
				<span class="cm">/*   1 : No limit to AEC increase step */</span>

<span class="cm">/* COM7 */</span>
				<span class="cm">/* SCCB Register Reset */</span>
<span class="cp">#define SCCB_RESET      0x80	</span><span class="cm">/*   0 : No change */</span><span class="cp"></span>
				<span class="cm">/*   1 : Resets all registers to default */</span>
				<span class="cm">/* Resolution selection */</span>
<span class="cp">#define SLCT_MASK       0x40	</span><span class="cm">/*   Mask of VGA or QVGA */</span><span class="cp"></span>
<span class="cp">#define SLCT_VGA        0x00	</span><span class="cm">/*   0 : VGA */</span><span class="cp"></span>
<span class="cp">#define SLCT_QVGA       0x40	</span><span class="cm">/*   1 : QVGA */</span><span class="cp"></span>
<span class="cp">#define ITU656_ON_OFF   0x20	</span><span class="cm">/* ITU656 protocol ON/OFF selection */</span><span class="cp"></span>
				<span class="cm">/* RGB output format control */</span>
<span class="cp">#define FMT_MASK        0x0c	</span><span class="cm">/*      Mask of color format */</span><span class="cp"></span>
<span class="cp">#define FMT_GBR422      0x00	</span><span class="cm">/*      00 : GBR 4:2:2 */</span><span class="cp"></span>
<span class="cp">#define FMT_RGB565      0x04	</span><span class="cm">/*      01 : RGB 565 */</span><span class="cp"></span>
<span class="cp">#define FMT_RGB555      0x08	</span><span class="cm">/*      10 : RGB 555 */</span><span class="cp"></span>
<span class="cp">#define FMT_RGB444      0x0c	</span><span class="cm">/* 11 : RGB 444 */</span><span class="cp"></span>
				<span class="cm">/* Output format control */</span>
<span class="cp">#define OFMT_MASK       0x03    </span><span class="cm">/*      Mask of output format */</span><span class="cp"></span>
<span class="cp">#define OFMT_YUV        0x00	</span><span class="cm">/*      00 : YUV */</span><span class="cp"></span>
<span class="cp">#define OFMT_P_BRAW     0x01	</span><span class="cm">/*      01 : Processed Bayer RAW */</span><span class="cp"></span>
<span class="cp">#define OFMT_RGB        0x02	</span><span class="cm">/*      10 : RGB */</span><span class="cp"></span>
<span class="cp">#define OFMT_BRAW       0x03	</span><span class="cm">/* 11 : Bayer RAW */</span><span class="cp"></span>

<span class="cm">/* COM8 */</span>
<span class="cp">#define FAST_ALGO       0x80	</span><span class="cm">/* Enable fast AGC/AEC algorithm */</span><span class="cp"></span>
				<span class="cm">/* AEC Setp size limit */</span>
<span class="cp">#define UNLMT_STEP      0x40	</span><span class="cm">/*   0 : Step size is limited */</span><span class="cp"></span>
				<span class="cm">/*   1 : Unlimited step size */</span>
<span class="cp">#define BNDF_ON_OFF     0x20	</span><span class="cm">/* Banding filter ON/OFF */</span><span class="cp"></span>
<span class="cp">#define AEC_BND         0x10	</span><span class="cm">/* Enable AEC below banding value */</span><span class="cp"></span>
<span class="cp">#define AEC_ON_OFF      0x08	</span><span class="cm">/* Fine AEC ON/OFF control */</span><span class="cp"></span>
<span class="cp">#define AGC_ON          0x04	</span><span class="cm">/* AGC Enable */</span><span class="cp"></span>
<span class="cp">#define AWB_ON          0x02	</span><span class="cm">/* AWB Enable */</span><span class="cp"></span>
<span class="cp">#define AEC_ON          0x01	</span><span class="cm">/* AEC Enable */</span><span class="cp"></span>

<span class="cm">/* COM9 */</span>
<span class="cp">#define BASE_AECAGC     0x80	</span><span class="cm">/* Histogram or average based AEC/AGC */</span><span class="cp"></span>
				<span class="cm">/* Automatic gain ceiling - maximum AGC value */</span>
<span class="cp">#define GAIN_2x         0x00	</span><span class="cm">/*    000 :   2x */</span><span class="cp"></span>
<span class="cp">#define GAIN_4x         0x10	</span><span class="cm">/*    001 :   4x */</span><span class="cp"></span>
<span class="cp">#define GAIN_8x         0x20	</span><span class="cm">/*    010 :   8x */</span><span class="cp"></span>
<span class="cp">#define GAIN_16x        0x30	</span><span class="cm">/*    011 :  16x */</span><span class="cp"></span>
<span class="cp">#define GAIN_32x        0x40	</span><span class="cm">/*    100 :  32x */</span><span class="cp"></span>
<span class="cp">#define GAIN_64x        0x50	</span><span class="cm">/* 101 :  64x */</span><span class="cp"></span>
<span class="cp">#define GAIN_128x       0x60	</span><span class="cm">/* 110 : 128x */</span><span class="cp"></span>
<span class="cp">#define DROP_VSYNC      0x04	</span><span class="cm">/* Drop VSYNC output of corrupt frame */</span><span class="cp"></span>
<span class="cp">#define DROP_HREF       0x02	</span><span class="cm">/* Drop HREF  output of corrupt frame */</span><span class="cp"></span>

<span class="cm">/* COM11 */</span>
<span class="cp">#define SGLF_ON_OFF     0x02	</span><span class="cm">/* Single frame ON/OFF selection */</span><span class="cp"></span>
<span class="cp">#define SGLF_TRIG       0x01	</span><span class="cm">/* Single frame transfer trigger */</span><span class="cp"></span>

<span class="cm">/* EXHCH */</span>
<span class="cp">#define VSIZE_LSB       0x04	</span><span class="cm">/* Vertical data output size LSB */</span><span class="cp"></span>

<span class="cm">/* DSP_CTRL1 */</span>
<span class="cp">#define FIFO_ON         0x80	</span><span class="cm">/* FIFO enable/disable selection */</span><span class="cp"></span>
<span class="cp">#define UV_ON_OFF       0x40	</span><span class="cm">/* UV adjust function ON/OFF selection */</span><span class="cp"></span>
<span class="cp">#define YUV444_2_422    0x20	</span><span class="cm">/* YUV444 to 422 UV channel option selection */</span><span class="cp"></span>
<span class="cp">#define CLR_MTRX_ON_OFF 0x10	</span><span class="cm">/* Color matrix ON/OFF selection */</span><span class="cp"></span>
<span class="cp">#define INTPLT_ON_OFF   0x08	</span><span class="cm">/* Interpolation ON/OFF selection */</span><span class="cp"></span>
<span class="cp">#define GMM_ON_OFF      0x04	</span><span class="cm">/* Gamma function ON/OFF selection */</span><span class="cp"></span>
<span class="cp">#define AUTO_BLK_ON_OFF 0x02	</span><span class="cm">/* Black defect auto correction ON/OFF */</span><span class="cp"></span>
<span class="cp">#define AUTO_WHT_ON_OFF 0x01	</span><span class="cm">/* White define auto correction ON/OFF */</span><span class="cp"></span>

<span class="cm">/* DSP_CTRL3 */</span>
<span class="cp">#define UV_MASK         0x80	</span><span class="cm">/* UV output sequence option */</span><span class="cp"></span>
<span class="cp">#define UV_ON           0x80	</span><span class="cm">/*   ON */</span><span class="cp"></span>
<span class="cp">#define UV_OFF          0x00	</span><span class="cm">/*   OFF */</span><span class="cp"></span>
<span class="cp">#define CBAR_MASK       0x20	</span><span class="cm">/* DSP Color bar mask */</span><span class="cp"></span>
<span class="cp">#define CBAR_ON         0x20	</span><span class="cm">/*   ON */</span><span class="cp"></span>
<span class="cp">#define CBAR_OFF        0x00	</span><span class="cm">/*   OFF */</span><span class="cp"></span>

<span class="cm">/* HSTART */</span>
<span class="cp">#define HST_VGA         0x23</span>
<span class="cp">#define HST_QVGA        0x3F</span>

<span class="cm">/* HSIZE */</span>
<span class="cp">#define HSZ_VGA         0xA0</span>
<span class="cp">#define HSZ_QVGA        0x50</span>

<span class="cm">/* VSTART */</span>
<span class="cp">#define VST_VGA         0x07</span>
<span class="cp">#define VST_QVGA        0x03</span>

<span class="cm">/* VSIZE */</span>
<span class="cp">#define VSZ_VGA         0xF0</span>
<span class="cp">#define VSZ_QVGA        0x78</span>

<span class="cm">/* HOUTSIZE */</span>
<span class="cp">#define HOSZ_VGA        0xA0</span>
<span class="cp">#define HOSZ_QVGA       0x50</span>

<span class="cm">/* VOUTSIZE */</span>
<span class="cp">#define VOSZ_VGA        0xF0</span>
<span class="cp">#define VOSZ_QVGA       0x78</span>

<span class="cm">/* DSPAUTO (DSP Auto Function ON/OFF Control) */</span>
<span class="cp">#define AWB_ACTRL       0x80 </span><span class="cm">/* AWB auto threshold control */</span><span class="cp"></span>
<span class="cp">#define DENOISE_ACTRL   0x40 </span><span class="cm">/* De-noise auto threshold control */</span><span class="cp"></span>
<span class="cp">#define EDGE_ACTRL      0x20 </span><span class="cm">/* Edge enhancement auto strength control */</span><span class="cp"></span>
<span class="cp">#define UV_ACTRL        0x10 </span><span class="cm">/* UV adjust auto slope control */</span><span class="cp"></span>
<span class="cp">#define SCAL0_ACTRL     0x08 </span><span class="cm">/* Auto scaling factor control */</span><span class="cp"></span>
<span class="cp">#define SCAL1_2_ACTRL   0x04 </span><span class="cm">/* Auto scaling factor control */</span><span class="cp"></span>

<span class="cm">/*</span>
<span class="cm"> * ID</span>
<span class="cm"> */</span>
<span class="cp">#define OV7720  0x7720</span>
<span class="cp">#define OV7725  0x7721</span>
<span class="cp">#define VERSION(pid, ver) ((pid&lt;&lt;8)|(ver&amp;0xFF))</span>

<span class="cm">/*</span>
<span class="cm"> * struct</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">regval_list</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg_num</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ov772x_color_format</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_colorspace</span> <span class="n">colorspace</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">dsp3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">com3</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">com7</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ov772x_win_size</span> <span class="p">{</span>
	<span class="kt">char</span>                     <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">__u32</span>                     <span class="n">width</span><span class="p">;</span>
	<span class="n">__u32</span>                     <span class="n">height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>             <span class="n">com7_bit</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="o">*</span><span class="n">regs</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span>                <span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl_handler</span>	  <span class="n">hdl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ov772x_camera_info</span>        <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ov772x_color_format</span> <span class="o">*</span><span class="n">cfmt</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ov772x_win_size</span>     <span class="o">*</span><span class="n">win</span><span class="p">;</span>
	<span class="kt">int</span>                               <span class="n">model</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>                    <span class="n">flag_vflip</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>                    <span class="n">flag_hflip</span><span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* band_filter = COM8[5] ? 256 - BDBASE : 0 */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>                    <span class="n">band_filter</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define ENDMARKER { 0xff, 0xff }</span>

<span class="cm">/*</span>
<span class="cm"> * register setting for window size</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov772x_qvga_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">HSTART</span><span class="p">,</span>   <span class="n">HST_QVGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HSIZE</span><span class="p">,</span>    <span class="n">HSZ_QVGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VSTART</span><span class="p">,</span>   <span class="n">VST_QVGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VSIZE</span><span class="p">,</span>    <span class="n">VSZ_QVGA</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOUTSIZE</span><span class="p">,</span> <span class="n">HOSZ_QVGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VOUTSIZE</span><span class="p">,</span> <span class="n">VOSZ_QVGA</span> <span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="n">ov772x_vga_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">HSTART</span><span class="p">,</span>   <span class="n">HST_VGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HSIZE</span><span class="p">,</span>    <span class="n">HSZ_VGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VSTART</span><span class="p">,</span>   <span class="n">VST_VGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VSIZE</span><span class="p">,</span>    <span class="n">VSZ_VGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">HOUTSIZE</span><span class="p">,</span> <span class="n">HOSZ_VGA</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">VOUTSIZE</span><span class="p">,</span> <span class="n">VOSZ_VGA</span> <span class="p">},</span>
	<span class="n">ENDMARKER</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * supported color format list</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ov772x_color_format</span> <span class="n">ov772x_cfmts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dsp3</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com3</span>		<span class="o">=</span> <span class="n">SWAP_YUV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com7</span>		<span class="o">=</span> <span class="n">OFMT_YUV</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_YVYU8_2X8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dsp3</span>		<span class="o">=</span> <span class="n">UV_ON</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com3</span>		<span class="o">=</span> <span class="n">SWAP_YUV</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com7</span>		<span class="o">=</span> <span class="n">OFMT_YUV</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_2X8</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dsp3</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com3</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com7</span>		<span class="o">=</span> <span class="n">OFMT_YUV</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_RGB555_2X8_PADHI_LE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dsp3</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com3</span>		<span class="o">=</span> <span class="n">SWAP_RGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com7</span>		<span class="o">=</span> <span class="n">FMT_RGB555</span> <span class="o">|</span> <span class="n">OFMT_RGB</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_RGB555_2X8_PADHI_BE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dsp3</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com3</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com7</span>		<span class="o">=</span> <span class="n">FMT_RGB555</span> <span class="o">|</span> <span class="n">OFMT_RGB</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_RGB565_2X8_LE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dsp3</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com3</span>		<span class="o">=</span> <span class="n">SWAP_RGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com7</span>		<span class="o">=</span> <span class="n">FMT_RGB565</span> <span class="o">|</span> <span class="n">OFMT_RGB</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">code</span>		<span class="o">=</span> <span class="n">V4L2_MBUS_FMT_RGB565_2X8_BE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">,</span>
		<span class="p">.</span><span class="n">dsp3</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com3</span>		<span class="o">=</span> <span class="mh">0x0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">com7</span>		<span class="o">=</span> <span class="n">FMT_RGB565</span> <span class="o">|</span> <span class="n">OFMT_RGB</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * window size list</span>
<span class="cm"> */</span>
<span class="cp">#define VGA_WIDTH   640</span>
<span class="cp">#define VGA_HEIGHT  480</span>
<span class="cp">#define QVGA_WIDTH  320</span>
<span class="cp">#define QVGA_HEIGHT 240</span>
<span class="cp">#define MAX_WIDTH   VGA_WIDTH</span>
<span class="cp">#define MAX_HEIGHT  VGA_HEIGHT</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ov772x_win_size</span> <span class="n">ov772x_win_vga</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;VGA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span>    <span class="o">=</span> <span class="n">VGA_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span>   <span class="o">=</span> <span class="n">VGA_HEIGHT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">com7_bit</span> <span class="o">=</span> <span class="n">SLCT_VGA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">regs</span>     <span class="o">=</span> <span class="n">ov772x_vga_regs</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ov772x_win_size</span> <span class="n">ov772x_win_qvga</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;QVGA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">width</span>    <span class="o">=</span> <span class="n">QVGA_WIDTH</span><span class="p">,</span>
	<span class="p">.</span><span class="n">height</span>   <span class="o">=</span> <span class="n">QVGA_HEIGHT</span><span class="p">,</span>
	<span class="p">.</span><span class="n">com7_bit</span> <span class="o">=</span> <span class="n">SLCT_QVGA</span><span class="p">,</span>
	<span class="p">.</span><span class="n">regs</span>     <span class="o">=</span> <span class="n">ov772x_qvga_regs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * general function</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="nf">to_ov772x</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">),</span> <span class="k">struct</span> <span class="n">ov772x_priv</span><span class="p">,</span>
			    <span class="n">subdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_write_array</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span>        <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">regval_list</span> <span class="o">*</span><span class="n">vals</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">vals</span><span class="o">-&gt;</span><span class="n">reg_num</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
						    <span class="n">vals</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span>
						    <span class="n">vals</span><span class="o">-&gt;</span><span class="n">value</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="n">vals</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_mask_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					  <span class="n">u8</span>  <span class="n">command</span><span class="p">,</span>
					  <span class="n">u8</span>  <span class="n">mask</span><span class="p">,</span>
					  <span class="n">u8</span>  <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">val</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">set</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">COM7</span><span class="p">,</span> <span class="n">SCCB_RESET</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * soc_camera_ops function</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ov772x_priv</span><span class="p">,</span> <span class="n">subdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">COM2</span><span class="p">,</span> <span class="n">SOFT_SLEEP_MODE</span><span class="p">,</span> <span class="n">SOFT_SLEEP_MODE</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;norm or win select error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">COM2</span><span class="p">,</span> <span class="n">SOFT_SLEEP_MODE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;format %d, win %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ov772x_priv</span><span class="p">,</span> <span class="n">hdl</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">?</span> <span class="n">VFLIP_IMG</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">flag_vflip</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OV772X_FLAG_VFLIP</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">^=</span> <span class="n">VFLIP_IMG</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">COM3</span><span class="p">,</span> <span class="n">VFLIP_IMG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">?</span> <span class="n">HFLIP_IMG</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">flag_hflip</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OV772X_FLAG_HFLIP</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">^=</span> <span class="n">HFLIP_IMG</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">COM3</span><span class="p">,</span> <span class="n">HFLIP_IMG</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_CID_BAND_STOP_FILTER</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Switch the filter off, it is on now */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">BDBASE</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">COM8</span><span class="p">,</span>
						      <span class="n">BNDF_ON_OFF</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Switch the filter on, set AEC low limit */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">COM8</span><span class="p">,</span>
					      <span class="n">BNDF_ON_OFF</span><span class="p">,</span> <span class="n">BNDF_ON_OFF</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">BDBASE</span><span class="p">,</span>
						      <span class="mh">0xff</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_filter</span> <span class="o">=</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ov772x_priv</span><span class="p">,</span> <span class="n">subdev</span><span class="p">);</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span>    <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">model</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">__u64</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;</span> <span class="mh">0xff</span> <span class="o">||</span>
	    <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mh">0xff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ov772x_win_size</span> <span class="o">*</span><span class="nf">ov772x_select_win</span><span class="p">(</span><span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__u32</span> <span class="n">diff</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ov772x_win_size</span> <span class="o">*</span><span class="n">win</span><span class="p">;</span>

	<span class="cm">/* default is QVGA */</span>
	<span class="n">diff</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">width</span> <span class="o">-</span> <span class="n">ov772x_win_qvga</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">abs</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">ov772x_win_qvga</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
	<span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ov772x_win_qvga</span><span class="p">;</span>

	<span class="cm">/* VGA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">diff</span> <span class="o">&gt;</span>
	    <span class="n">abs</span><span class="p">(</span><span class="n">width</span>  <span class="o">-</span> <span class="n">ov772x_win_vga</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">abs</span><span class="p">(</span><span class="n">height</span> <span class="o">-</span> <span class="n">ov772x_win_vga</span><span class="p">.</span><span class="n">height</span><span class="p">))</span>
		<span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ov772x_win_vga</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">win</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_set_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">height</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov772x</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * select format</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ov772x_cfmts</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span> <span class="o">==</span> <span class="n">ov772x_cfmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span> <span class="o">=</span> <span class="n">ov772x_cfmts</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * select win</span>
<span class="cm">	 */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span> <span class="o">=</span> <span class="n">ov772x_select_win</span><span class="p">(</span><span class="o">*</span><span class="n">width</span><span class="p">,</span> <span class="o">*</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * reset hardware</span>
<span class="cm">	 */</span>
	<span class="n">ov772x_reset</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Edge Ctrl</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">edgectrl</span><span class="p">.</span><span class="n">strength</span> <span class="o">&amp;</span> <span class="n">OV772X_MANUAL_EDGE_CTRL</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * Manual Edge Control Mode</span>
<span class="cm">		 *</span>
<span class="cm">		 * Edge auto strength bit is set by default.</span>
<span class="cm">		 * Remove it when manual mode.</span>
<span class="cm">		 */</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">DSPAUTO</span><span class="p">,</span> <span class="n">EDGE_ACTRL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				      <span class="n">EDGE_TRSHLD</span><span class="p">,</span> <span class="n">OV772X_EDGE_THRESHOLD_MASK</span><span class="p">,</span>
				      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">edgectrl</span><span class="p">.</span><span class="n">threshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				      <span class="n">EDGE_STRNGT</span><span class="p">,</span> <span class="n">OV772X_EDGE_STRENGTH_MASK</span><span class="p">,</span>
				      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">edgectrl</span><span class="p">.</span><span class="n">strength</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">edgectrl</span><span class="p">.</span><span class="n">upper</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">edgectrl</span><span class="p">.</span><span class="n">lower</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Auto Edge Control Mode</span>
<span class="cm">		 *</span>
<span class="cm">		 * set upper and lower limit</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				      <span class="n">EDGE_UPPER</span><span class="p">,</span> <span class="n">OV772X_EDGE_UPPER_MASK</span><span class="p">,</span>
				      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">edgectrl</span><span class="p">.</span><span class="n">upper</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				      <span class="n">EDGE_LOWER</span><span class="p">,</span> <span class="n">OV772X_EDGE_LOWER_MASK</span><span class="p">,</span>
				      <span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">edgectrl</span><span class="p">.</span><span class="n">lower</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * set size format</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_write_array</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set DSP_CTRL3</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="o">-&gt;</span><span class="n">dsp3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
				      <span class="n">DSP_CTRL3</span><span class="p">,</span> <span class="n">UV_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * set COM3</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="o">-&gt;</span><span class="n">com3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OV772X_FLAG_VFLIP</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">VFLIP_IMG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">OV772X_FLAG_HFLIP</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">HFLIP_IMG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flag_vflip</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">^=</span> <span class="n">VFLIP_IMG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">flag_hflip</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">^=</span> <span class="n">HFLIP_IMG</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			      <span class="n">COM3</span><span class="p">,</span> <span class="n">SWAP_MASK</span> <span class="o">|</span> <span class="n">IMG_MASK</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set COM7</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">com7_bit</span> <span class="o">|</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="o">-&gt;</span><span class="n">com7</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			      <span class="n">COM7</span><span class="p">,</span> <span class="n">SLCT_MASK</span> <span class="o">|</span> <span class="n">FMT_MASK</span> <span class="o">|</span> <span class="n">OFMT_MASK</span><span class="p">,</span>
			      <span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set COM8</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_filter</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">COM8</span><span class="p">,</span> <span class="n">BNDF_ON_OFF</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_mask_set</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">BDBASE</span><span class="p">,</span>
					      <span class="mh">0xff</span><span class="p">,</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">band_filter</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">ov772x_set_fmt_error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">width</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="o">*</span><span class="n">height</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">ov772x_set_fmt_error:</span>

	<span class="n">ov772x_reset</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span>	<span class="o">=</span> <span class="n">VGA_WIDTH</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span>	<span class="o">=</span> <span class="n">VGA_HEIGHT</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span>			<span class="o">=</span> <span class="n">VGA_WIDTH</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">VGA_HEIGHT</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span>			<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>				<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_g_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ov772x_priv</span><span class="p">,</span> <span class="n">subdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span> <span class="o">||</span> <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">width</span> <span class="o">=</span> <span class="n">VGA_WIDTH</span><span class="p">,</span> <span class="n">height</span> <span class="o">=</span> <span class="n">VGA_HEIGHT</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_set_params</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">height</span><span class="p">,</span>
					    <span class="n">V4L2_MBUS_FMT_YUYV8_2X8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_s_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ov772x_priv</span><span class="p">,</span> <span class="n">subdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_set_params</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
				    <span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ov772x_priv</span><span class="p">,</span> <span class="n">subdev</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ov772x_win_size</span> <span class="o">*</span><span class="n">win</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * select suitable win</span>
<span class="cm">	 */</span>
	<span class="n">win</span> <span class="o">=</span> <span class="n">ov772x_select_win</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ov772x_cfmts</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">ov772x_cfmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ov772x_cfmts</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Unsupported format requested. Propose either */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the current one or */</span>
			<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
			<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* the default one */</span>
			<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">ov772x_cfmts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">colorspace</span><span class="p">;</span>
			<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">ov772x_cfmts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Also return the colorspace */</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">ov772x_cfmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_video_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov772x</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">u8</span>                  <span class="n">pid</span><span class="p">,</span> <span class="n">ver</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span>         <span class="o">*</span><span class="n">devname</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check and show product ID and manufacturer ID</span>
<span class="cm">	 */</span>
	<span class="n">pid</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">PID</span><span class="p">);</span>
	<span class="n">ver</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">VER</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">VERSION</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">ver</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OV7720</span>:
		<span class="n">devname</span>     <span class="o">=</span> <span class="s">&quot;ov7720&quot;</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">V4L2_IDENT_OV7720</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OV7725</span>:
		<span class="n">devname</span>     <span class="o">=</span> <span class="s">&quot;ov7725&quot;</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">model</span> <span class="o">=</span> <span class="n">V4L2_IDENT_OV7725</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Product ID error %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">ver</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		 <span class="s">&quot;%s Product ID %0x:%0x Manufacturer ID %x:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">devname</span><span class="p">,</span>
		 <span class="n">pid</span><span class="p">,</span>
		 <span class="n">ver</span><span class="p">,</span>
		 <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MIDH</span><span class="p">),</span>
		 <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MIDL</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">ov772x_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">ov772x_s_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">ov772x_subdev_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_chip_ident</span>	<span class="o">=</span> <span class="n">ov772x_g_chip_ident</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">g_register</span>	<span class="o">=</span> <span class="n">ov772x_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_register</span>	<span class="o">=</span> <span class="n">ov772x_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_enum_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ov772x_cfmts</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">ov772x_cfmts</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_g_mbus_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PCLK_SAMPLE_RISING</span> <span class="o">|</span> <span class="n">V4L2_MBUS_MASTER</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_VSYNC_ACTIVE_HIGH</span> <span class="o">|</span> <span class="n">V4L2_MBUS_HSYNC_ACTIVE_HIGH</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_DATA_ACTIVE_HIGH</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_PARALLEL</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">soc_camera_apply_board_flags</span><span class="p">(</span><span class="n">icl</span><span class="p">,</span> <span class="n">cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">ov772x_subdev_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span>	<span class="o">=</span> <span class="n">ov772x_s_stream</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov772x_g_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov772x_s_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov772x_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cropcap</span>	<span class="o">=</span> <span class="n">ov772x_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_crop</span>		<span class="o">=</span> <span class="n">ov772x_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_mbus_fmt</span>	<span class="o">=</span> <span class="n">ov772x_enum_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_config</span>	<span class="o">=</span> <span class="n">ov772x_g_mbus_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">ov772x_subdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ov772x_subdev_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">ov772x_subdev_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * i2c_driver function</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span>	<span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span>	<span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span>	<span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="kt">int</span>			<span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icl</span> <span class="o">||</span> <span class="o">!</span><span class="n">icl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OV772X: missing platform data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;I2C-Adapter doesn&#39;t support &quot;</span>
			<span class="s">&quot;I2C_FUNC_SMBUS_BYTE_DATA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">info</span> <span class="o">=</span> <span class="n">icl</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov772x_subdev_ops</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov772x_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_VFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov772x_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_HFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_new_std</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ov772x_ctrl_ops</span><span class="p">,</span>
			<span class="n">V4L2_CID_BAND_STOP_FILTER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ov772x_video_probe</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ov772x_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ov772x_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_ov772x</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">hdl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">ov772x_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ov772x&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">ov772x_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">ov772x_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ov772x&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">ov772x_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">ov772x_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">ov772x_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">ov772x_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;SoC Camera driver for ov772x&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kuninori Morimoto&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
