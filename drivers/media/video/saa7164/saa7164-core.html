<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › saa7164 › saa7164-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>saa7164-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for the NXP SAA7164 PCIe bridge</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2010 Steven Toth &lt;stoth@kernellabs.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="cp">#include &lt;linux/proc_fs.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &quot;saa7164.h&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for NXP SAA7164 based TV cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Steven Toth &lt;stoth@kernellabs.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *  1 Basic</span>
<span class="cm"> *  2</span>
<span class="cm"> *  4 i2c</span>
<span class="cm"> *  8 api</span>
<span class="cm"> * 16 cmd</span>
<span class="cm"> * 32 bus</span>
<span class="cm"> */</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">saa_debug</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">saa_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fw_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fw_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fw_debug</span><span class="p">,</span> <span class="s">&quot;Firware debug level def:2&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">encoder_buffers</span> <span class="o">=</span> <span class="n">SAA7164_MAX_ENCODER_BUFFERS</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">encoder_buffers</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">encoder_buffers</span><span class="p">,</span> <span class="s">&quot;Total buffers in read queue 16-512 def:64&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vbi_buffers</span> <span class="o">=</span> <span class="n">SAA7164_MAX_VBI_BUFFERS</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">vbi_buffers</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">vbi_buffers</span><span class="p">,</span> <span class="s">&quot;Total buffers in read queue 16-512 def:64&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">waitsecs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">waitsecs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">waitsecs</span><span class="p">,</span> <span class="s">&quot;timeout on firmware messages&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">card</span><span class="p">[]</span>  <span class="o">=</span> <span class="p">{[</span><span class="mi">0</span> <span class="p">...</span> <span class="p">(</span><span class="n">SAA7164_MAXBOARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">UNSET</span> <span class="p">};</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>  <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;card type&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">print_histogram</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">print_histogram</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">print_histogram</span><span class="p">,</span> <span class="s">&quot;print histogram values once&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">crc_checking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">crc_checking</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">crc_checking</span><span class="p">,</span> <span class="s">&quot;enable crc sanity checking on buffers&quot;</span><span class="p">);</span>

<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">guard_checking</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">guard_checking</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">guard_checking</span><span class="p">,</span>
	<span class="s">&quot;enable dma sanity checking for buffer overruns&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">saa7164_devcount</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">devlist</span><span class="p">);</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">saa7164_devlist</span><span class="p">);</span>

<span class="cp">#define INT_SIZE 16</span>

<span class="kt">void</span> <span class="nf">saa7164_dumphex16FF</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0xff</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;--------------------&gt; &quot;</span>
		<span class="s">&quot;00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;         [0x%08x] &quot;</span>
				<span class="s">&quot;%02x %02x %02x %02x %02x %02x %02x %02x &quot;</span>
				<span class="s">&quot;%02x %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span>
			<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">7</span><span class="p">),</span>
			<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">9</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">10</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">11</span><span class="p">),</span>
			<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">12</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">13</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">14</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">15</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_pack_verifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2048</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xBA</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;No pack at 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			saa7164_dumphex16FF(buf-&gt;port-&gt;dev, (p + i), 32);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define FIXED_VIDEO_PID 0xf1</span>
<span class="cp">#define FIXED_AUDIO_PID 0xf2</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_ts_verifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">cc</span><span class="p">,</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">bufcpu</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">sync_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">v_cc_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">a_cc_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">188</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">bufcpu</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x47</span><span class="p">)</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">sync_errors</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* TODO: Query pid lower 8 bits, ignoring upper bits intensionally */</span>
		<span class="n">pid</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">bufcpu</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">bufcpu</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">cc</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">bufcpu</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">FIXED_VIDEO_PID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">last_v_cc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">cc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;video cc last = %x current = %x i = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_v_cc</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">v_cc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_v_cc</span> <span class="o">=</span> <span class="n">cc</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pid</span> <span class="o">==</span> <span class="n">FIXED_AUDIO_PID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">a</span> <span class="o">=</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">last_a_cc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">cc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;audio cc last = %x current = %x i = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_a_cc</span><span class="p">,</span> <span class="n">cc</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">a_cc_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_a_cc</span> <span class="o">=</span> <span class="n">cc</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="cm">/* Only report errors if we&#39;ve been through this function atleast</span>
<span class="cm">	 * once already and the cached cc values are primed. First time through</span>
<span class="cm">	 * always generates errors.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">v_cc_errors</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">done_first_interrupt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;video pid cc, %d errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">v_cc_errors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">a_cc_errors</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">done_first_interrupt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;audio pid cc, %d errors</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">a_cc_errors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">sync_errors</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">done_first_interrupt</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;sync_errors = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">sync_errors</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">done_first_interrupt</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">done_first_interrupt</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_histogram_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_histogram</span> <span class="o">*</span><span class="n">hg</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_histogram</span><span class="p">));</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">hg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>

	<span class="cm">/* First 30ms x 1ms */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">0</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* 30 - 200ms x 10ms  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">18</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">30</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">30</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* 200 - 2000ms x 100ms  */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">15</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">48</span> <span class="o">+</span> <span class="n">i</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">200</span><span class="p">);</span>

	<span class="cm">/* Catch all massive value (2secs) */</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">55</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">;</span>

	<span class="cm">/* Catch all massive value (4secs) */</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">56</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">4000</span><span class="p">;</span>

	<span class="cm">/* Catch all massive value (8secs) */</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">57</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>

	<span class="cm">/* Catch all massive value (15secs) */</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">58</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">15000</span><span class="p">;</span>

	<span class="cm">/* Catch all massive value (30secs) */</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">59</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">30000</span><span class="p">;</span>

	<span class="cm">/* Catch all massive value (60secs) */</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">60</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">60000</span><span class="p">;</span>

	<span class="cm">/* Catch all massive value (5mins) */</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">61</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">300000</span><span class="p">;</span>

	<span class="cm">/* Catch all massive value (15mins) */</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">62</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">900000</span><span class="p">;</span>

	<span class="cm">/* Catch all massive values (1hr) */</span>
	<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="mi">63</span><span class="p">].</span><span class="n">val</span> <span class="o">=</span> <span class="mi">3600000</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7164_histogram_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_histogram</span> <span class="o">*</span><span class="n">hg</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;=</span> <span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">update_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_histogram_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">saa7164_histogram</span> <span class="o">*</span><span class="n">hg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Histogram named %s (ms, count, last_update_jiffy)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot; %4d %12d %Ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">val</span><span class="p">,</span>
			<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">count</span><span class="p">,</span>
			<span class="n">hg</span><span class="o">-&gt;</span><span class="n">counter1</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">update_time</span><span class="p">);</span>

		<span class="n">entries</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Total: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">entries</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_work_enchandler_helper</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7164_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7164_user_buffer</span> <span class="o">*</span><span class="n">ubuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dmaqueue_lock</span><span class="p">);</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dmaqueue</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7164_buffer</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() illegal i count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">==</span> <span class="n">bufnr</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* Found the buffer, deal with it */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_IRQ</span><span class="p">,</span> <span class="s">&quot;%s() bufnr: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">crc_checking</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Throw a new checksum on the dma buffer */</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">guard_checking</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">+</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">+</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">+</span> <span class="mh">0x11</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">+</span> <span class="mh">0x12</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">+</span> <span class="mh">0x13</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() buf %p guard buffer breach</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">						saa7164_dumphex16FF(dev, (p + buf-&gt;actual_size) - 32 , 64);</span>
<span class="cp">#endif</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">!=</span> <span class="n">SAA7164_PORT_VBI1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">!=</span> <span class="n">SAA7164_PORT_VBI2</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Validate the incoming buffer content */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">stream_type</span> <span class="o">==</span> <span class="n">V4L2_MPEG_STREAM_TYPE_MPEG2_TS</span><span class="p">)</span>
					<span class="n">saa7164_ts_verifier</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">stream_type</span> <span class="o">==</span> <span class="n">V4L2_MPEG_STREAM_TYPE_MPEG2_PS</span><span class="p">)</span>
					<span class="n">saa7164_pack_verifier</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* find a free user buffer and clone to it */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">list_buf_free</span><span class="p">.</span><span class="n">list</span><span class="p">))</span> <span class="p">{</span>

				<span class="cm">/* Pull the first buffer from the used list */</span>
				<span class="n">ubuf</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">list_buf_free</span><span class="p">.</span><span class="n">list</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">saa7164_user_buffer</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span> <span class="o">&lt;=</span> <span class="n">ubuf</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">ubuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
						<span class="n">ubuf</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">);</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">crc_checking</span><span class="p">)</span> <span class="p">{</span>
						<span class="cm">/* Throw a new checksum on the read buffer */</span>
						<span class="n">ubuf</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">ubuf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">ubuf</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">);</span>
					<span class="p">}</span>

					<span class="cm">/* Requeue the buffer on the free list */</span>
					<span class="n">ubuf</span><span class="o">-&gt;</span><span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

					<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ubuf</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">list_buf_used</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>

					<span class="cm">/* Flag any userland waiters */</span>
					<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">wait_read</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;buf %p bufsize fails match</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;encirq no free buffers, increase param encoder_buffers</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* Ensure offset into buffer remains 0, fill buffer</span>
<span class="cm">			 * with known bad data. We check for this data at a later point</span>
<span class="cm">			 * in time. */</span>
			<span class="n">saa7164_buffer_zero_offsets</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">bufnr</span><span class="p">);</span>
			<span class="n">memset_io</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">pci_size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">crc_checking</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Throw yet aanother new checksum on the dma buffer */</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">actual_size</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dmaqueue_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_work_enchandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7164_port</span><span class="p">,</span> <span class="n">workenc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">wp</span><span class="p">,</span> <span class="n">mcb</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs</span> <span class="o">-</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span><span class="p">;</span>

	<span class="n">saa7164_histogram_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">svc_interval</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_svc_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs</span> <span class="o">-</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs</span><span class="p">;</span>

	<span class="n">saa7164_histogram_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_svc_interval</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_svc_msecs_diff</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_IRQ</span><span class="p">,</span>
		<span class="s">&quot;%s() %Ldms elapsed irq-&gt;deferred %Ldms wp: %d rp: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_svc_msecs_diff</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_wp</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_rp</span>
		<span class="p">);</span>

	<span class="cm">/* Current write position */</span>
	<span class="n">wp</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bufcounter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() illegal buf count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Most current complete buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mcb</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mcb</span> <span class="o">=</span> <span class="n">wp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">done_first_interrupt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">done_first_interrupt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rp</span> <span class="o">=</span> <span class="n">mcb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_rp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() illegal rp count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">saa7164_work_enchandler_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_rp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span> <span class="o">==</span> <span class="n">mcb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: Convert this into a /proc/saa7164 style readable file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">print_histogram</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_interval</span><span class="p">);</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">svc_interval</span><span class="p">);</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_svc_interval</span><span class="p">);</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_interval</span><span class="p">);</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">poll_interval</span><span class="p">);</span>
		<span class="cm">/* TODO: fix this to preserve any previous state */</span>
		<span class="n">print_histogram</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">+</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_work_vbihandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7164_port</span><span class="p">,</span> <span class="n">workenc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">wp</span><span class="p">,</span> <span class="n">mcb</span><span class="p">,</span> <span class="n">rp</span><span class="p">,</span> <span class="n">cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs</span> <span class="o">-</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span><span class="p">;</span>

	<span class="n">saa7164_histogram_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">svc_interval</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_svc_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs</span> <span class="o">-</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs</span><span class="p">;</span>

	<span class="n">saa7164_histogram_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_svc_interval</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_svc_msecs_diff</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_IRQ</span><span class="p">,</span>
		<span class="s">&quot;%s() %Ldms elapsed irq-&gt;deferred %Ldms wp: %d rp: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_msecs_diff</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_svc_msecs_diff</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_wp</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_rp</span>
		<span class="p">);</span>

	<span class="cm">/* Current write position */</span>
	<span class="n">wp</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bufcounter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() illegal buf count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">wp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Most current complete buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mcb</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">mcb</span> <span class="o">=</span> <span class="n">wp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">done_first_interrupt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">done_first_interrupt</span><span class="o">++</span><span class="p">;</span>
			<span class="n">rp</span> <span class="o">=</span> <span class="n">mcb</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_rp</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">rp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() illegal rp count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">saa7164_work_enchandler_helper</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_svc_rp</span> <span class="o">=</span> <span class="n">rp</span><span class="p">;</span>
		<span class="n">cnt</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rp</span> <span class="o">==</span> <span class="n">mcb</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* TODO: Convert this into a /proc/saa7164 style readable file */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">print_histogram</span> <span class="o">==</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_interval</span><span class="p">);</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">svc_interval</span><span class="p">);</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_svc_interval</span><span class="p">);</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_interval</span><span class="p">);</span>
		<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">poll_interval</span><span class="p">);</span>
		<span class="cm">/* TODO: fix this to preserve any previous state */</span>
		<span class="n">print_histogram</span> <span class="o">=</span> <span class="mi">64</span> <span class="o">+</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_work_cmdhandler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">w</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7164_dev</span><span class="p">,</span> <span class="n">workcmd</span><span class="p">);</span>

	<span class="cm">/* Wake up any complete commands */</span>
	<span class="n">saa7164_irq_dequeue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_buffer_deliver</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>

	<span class="cm">/* Feed the transport payload into the kernel demux */</span>
	<span class="n">dvb_dmx_swfilter_packets</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="p">.</span><span class="n">demux</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">cpu</span><span class="p">,</span>
		<span class="n">SAA7164_TS_NUMBER_OF_LINES</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">saa7164_irq_vbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Store old time */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs</span><span class="p">;</span>

	<span class="cm">/* Collect new stats */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>

	<span class="cm">/* Calculate stats */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs</span> <span class="o">-</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span><span class="p">;</span>

	<span class="n">saa7164_histogram_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_interval</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_IRQ</span><span class="p">,</span> <span class="s">&quot;%s() %Ldms elapsed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span><span class="p">);</span>

	<span class="cm">/* Tis calls the vbi irq handler */</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">workenc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">saa7164_irq_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Store old time */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs</span><span class="p">;</span>

	<span class="cm">/* Collect new stats */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>

	<span class="cm">/* Calculate stats */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs</span> <span class="o">-</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span><span class="p">;</span>

	<span class="n">saa7164_histogram_update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_interval</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_IRQ</span><span class="p">,</span> <span class="s">&quot;%s() %Ldms elapsed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">last_irq_msecs_diff</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">workenc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">saa7164_irq_ts</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7164_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">c</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wp</span><span class="p">,</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rp</span><span class="p">;</span>

	<span class="cm">/* Find the current write point from the hardware */</span>
	<span class="n">wp</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">bufcounter</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* Find the previous buffer to the current write point */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rp</span> <span class="o">=</span> <span class="n">wp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Lookup the WP in the buffer list */</span>
	<span class="cm">/* TODO: turn this into a worker thread */</span>
	<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dmaqueue</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7164_buffer</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">)</span>
			<span class="n">BUG</span><span class="p">();</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">==</span> <span class="n">rp</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Found the buffer, deal with it */</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_IRQ</span><span class="p">,</span> <span class="s">&quot;%s() wp: %d processing: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">wp</span><span class="p">,</span> <span class="n">rp</span><span class="p">);</span>
			<span class="n">saa7164_buffer_deliver</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Primary IRQ handler and dispatch mechanism */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">saa7164_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">porta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_TS1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">portb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_TS2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">portc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">portd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">porte</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI1</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">portf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI2</span><span class="p">];</span>

	<span class="n">u32</span> <span class="n">intid</span><span class="p">,</span> <span class="n">intstat</span><span class="p">[</span><span class="n">INT_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bit</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() No device specified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check that the hardware is accessible. If the status bytes are</span>
<span class="cm">	 * 0xFF then the device is not accessible, the the IRQ belongs</span>
<span class="cm">	 * to another driver.</span>
<span class="cm">	 * 4 x u32 interrupt registers.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">INT_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* TODO: Convert into saa7164_readl() */</span>
		<span class="cm">/* Read the 4 hardware interrupt registers */</span>
		<span class="n">intstat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_status</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handled</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* For each of the HW interrupt registers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">INT_SIZE</span><span class="o">/</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intstat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="cm">/* Each function of the board has it&#39;s own interruptid.</span>
<span class="cm">			 * Find the function that triggered then call</span>
<span class="cm">			 * it&#39;s handler.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

				<span class="k">if</span> <span class="p">(((</span><span class="n">intstat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">bit</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>

				<span class="cm">/* Calculate the interrupt id (0x00 to 0x7f) */</span>

				<span class="n">intid</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">32</span><span class="p">)</span> <span class="o">+</span> <span class="n">bit</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">intid</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bInterruptId</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* A response to an cmd/api call */</span>
					<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">workcmd</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intid</span> <span class="o">==</span> <span class="n">porta</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">interruptid</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* Transport path 1 */</span>
					<span class="n">saa7164_irq_ts</span><span class="p">(</span><span class="n">porta</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intid</span> <span class="o">==</span> <span class="n">portb</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">interruptid</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* Transport path 2 */</span>
					<span class="n">saa7164_irq_ts</span><span class="p">(</span><span class="n">portb</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intid</span> <span class="o">==</span> <span class="n">portc</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">interruptid</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* Encoder path 1 */</span>
					<span class="n">saa7164_irq_encoder</span><span class="p">(</span><span class="n">portc</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intid</span> <span class="o">==</span> <span class="n">portd</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">interruptid</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* Encoder path 2 */</span>
					<span class="n">saa7164_irq_encoder</span><span class="p">(</span><span class="n">portd</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intid</span> <span class="o">==</span> <span class="n">porte</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">interruptid</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* VBI path 1 */</span>
					<span class="n">saa7164_irq_vbi</span><span class="p">(</span><span class="n">porte</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">intid</span> <span class="o">==</span> <span class="n">portf</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">interruptid</span><span class="p">)</span> <span class="p">{</span>

					<span class="cm">/* VBI path 2 */</span>
					<span class="n">saa7164_irq_vbi</span><span class="p">(</span><span class="n">portf</span><span class="p">);</span>

				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Find the function */</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_IRQ</span><span class="p">,</span>
						<span class="s">&quot;%s() unhandled interrupt &quot;</span>
						<span class="s">&quot;reg 0x%x bit 0x%x &quot;</span>
						<span class="s">&quot;intid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">bit</span><span class="p">,</span> <span class="n">intid</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="cm">/* Ack it */</span>
			<span class="n">saa7164_writel</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_ack</span> <span class="o">+</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">),</span> <span class="n">intstat</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">saa7164_getfirmwarestatus</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_fw_status</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DEVICE_SYSINIT_STATUS</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DEVICE_SYSINIT_MODE</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">.</span><span class="n">spec</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DEVICE_SYSINIT_SPEC</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DEVICE_SYSINIT_INST</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">.</span><span class="n">cpuload</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DEVICE_SYSINIT_CPULOAD</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw_status</span><span class="p">.</span><span class="n">remainheap</span> <span class="o">=</span>
		<span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DEVICE_SYSINIT_REMAINHEAP</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Firmware status:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .status     = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .mode       = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .spec       = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">spec</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .inst       = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">inst</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .cpuload    = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">cpuload</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .remainheap = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">remainheap</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">saa7164_getcurrentfirmwareversion</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DEVICE_VERSION</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Device running firmware version %d.%d.%d.%d (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0000fc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x000003e0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">),</span>
		<span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
		<span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO: Debugging func, remove */</span>
<span class="kt">void</span> <span class="nf">saa7164_dumphex16</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;--------------------&gt; &quot;</span>
		<span class="s">&quot;00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;         [0x%08x] &quot;</span>
			<span class="s">&quot;%02x %02x %02x %02x %02x %02x %02x %02x &quot;</span>
			<span class="s">&quot;%02x %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">0</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">3</span><span class="p">),</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">4</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">5</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">6</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">7</span><span class="p">),</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">8</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">9</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">10</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">11</span><span class="p">),</span>
		<span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">12</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">13</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">14</span><span class="p">),</span> <span class="o">*</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">i</span><span class="o">+</span><span class="mi">15</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* TODO: Debugging func, remove */</span>
<span class="kt">void</span> <span class="nf">saa7164_dumpregs</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;--------------------&gt; &quot;</span>
		<span class="s">&quot;00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x100</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;region0[0x%08x] = &quot;</span>
			<span class="s">&quot;%02x %02x %02x %02x %02x %02x %02x %02x&quot;</span>
			<span class="s">&quot; %02x %02x %02x %02x %02x %02x %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">7</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">9</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">10</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">11</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">12</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">13</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">14</span><span class="p">),</span>
			<span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">saa7164_readb</span><span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span>
			<span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_dump_hwdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;@0x%p hwdesc sizeof(struct tmComResHWDescr) = %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResHWDescr</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bLength = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">bLength</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bDescriptorType = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">bDescriptorType</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bDescriptorSubtype = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">bDescriptorSubtype</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bcdSpecVersion = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">bcdSpecVersion</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .dwClockFrequency = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">dwClockFrequency</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .dwClockUpdateRes = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">dwClockUpdateRes</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bCapabilities = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">bCapabilities</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .dwDeviceRegistersLocation = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">dwDeviceRegistersLocation</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .dwHostMemoryRegion = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">dwHostMemoryRegion</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .dwHostMemoryRegionSize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">dwHostMemoryRegionSize</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .dwHostHibernatMemRegion = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">dwHostHibernatMemRegion</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .dwHostHibernatMemRegionSize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">dwHostHibernatMemRegionSize</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_dump_intfdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;@0x%p intfdesc &quot;</span>
		<span class="s">&quot;sizeof(struct tmComResInterfaceDescr) = %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResInterfaceDescr</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bLength = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bLength</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bDescriptorType = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bDescriptorType</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bDescriptorSubtype = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bDescriptorSubtype</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bFlags = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bFlags</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bInterfaceType = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bInterfaceType</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bInterfaceId = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bInterfaceId</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bBaseInterface = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bBaseInterface</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bInterruptId = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bInterruptId</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .bDebugInterruptId = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bDebugInterruptId</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .BARLocation = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">BARLocation</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_dump_busdesc</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;@0x%p busdesc sizeof(struct tmComResBusDescr) = %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">busdesc</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResBusDescr</span><span class="p">));</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .CommandRing   = 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">busdesc</span><span class="p">.</span><span class="n">CommandRing</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .ResponseRing  = 0x%016Lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">busdesc</span><span class="p">.</span><span class="n">ResponseRing</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .CommandWrite  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">busdesc</span><span class="p">.</span><span class="n">CommandWrite</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .CommandRead   = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">busdesc</span><span class="p">.</span><span class="n">CommandRead</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .ResponseWrite = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">busdesc</span><span class="p">.</span><span class="n">ResponseWrite</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot; .ResponseRead  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">busdesc</span><span class="p">.</span><span class="n">ResponseRead</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Much of the hardware configuration and PCI registers are configured</span>
<span class="cm"> * dynamically depending on firmware. We have to cache some initial</span>
<span class="cm"> * structures then use these to locate other important structures</span>
<span class="cm"> * from PCI space.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_get_descriptors</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResHWDescr</span><span class="p">));</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResHWDescr</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResInterfaceDescr</span><span class="p">));</span>
	<span class="n">memcpy_fromio</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">busdesc</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio</span> <span class="o">+</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">BARLocation</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResBusDescr</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">bLength</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResHWDescr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Structure struct tmComResHWDescr is mangled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Need %x got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hwdesc</span><span class="p">.</span><span class="n">bLength</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResHWDescr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">saa7164_dump_hwdesc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bLength</span> <span class="o">!=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResInterfaceDescr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;struct struct tmComResInterfaceDescr is mangled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Need %x got %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">intfdesc</span><span class="p">.</span><span class="n">bLength</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResInterfaceDescr</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">saa7164_dump_intfdesc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">saa7164_dump_busdesc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7164_pci_quirks</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t get MMIO memory @ 0x%llx or 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7164_port_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">portnr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">portnr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">portnr</span> <span class="o">&gt;=</span> <span class="n">SAA7164_MAX_PORTS</span><span class="p">))</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">portnr</span><span class="p">];</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">portnr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">portnr</span> <span class="o">==</span> <span class="n">SAA7164_PORT_TS1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">portnr</span> <span class="o">==</span> <span class="n">SAA7164_PORT_TS2</span><span class="p">))</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SAA7164_MPEG_DVB</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">portnr</span> <span class="o">==</span> <span class="n">SAA7164_PORT_ENC1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">portnr</span> <span class="o">==</span> <span class="n">SAA7164_PORT_ENC2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SAA7164_MPEG_ENCODER</span><span class="p">;</span>

		<span class="cm">/* We need a deferred interrupt handler for cmd handling */</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">workenc</span><span class="p">,</span> <span class="n">saa7164_work_enchandler</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">portnr</span> <span class="o">==</span> <span class="n">SAA7164_PORT_VBI1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">portnr</span> <span class="o">==</span> <span class="n">SAA7164_PORT_VBI2</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SAA7164_MPEG_VBI</span><span class="p">;</span>

		<span class="cm">/* We need a deferred interrupt handler for cmd handling */</span>
		<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">workenc</span><span class="p">,</span> <span class="n">saa7164_work_vbihandler</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="cm">/* Init all the critical resources */</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dvb</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dmaqueue</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dmaqueue_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">list_buf_used</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">list_buf_free</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">wait_read</span><span class="p">);</span>


	<span class="n">saa7164_histogram_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_interval</span><span class="p">,</span> <span class="s">&quot;irq intervals&quot;</span><span class="p">);</span>
	<span class="n">saa7164_histogram_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">svc_interval</span><span class="p">,</span> <span class="s">&quot;deferred intervals&quot;</span><span class="p">);</span>
	<span class="n">saa7164_histogram_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">irq_svc_interval</span><span class="p">,</span>
		<span class="s">&quot;irq to deferred intervals&quot;</span><span class="p">);</span>
	<span class="n">saa7164_histogram_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">read_interval</span><span class="p">,</span>
		<span class="s">&quot;encoder/vbi read() intervals&quot;</span><span class="p">);</span>
	<span class="n">saa7164_histogram_reset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">poll_interval</span><span class="p">,</span>
		<span class="s">&quot;encoder/vbi poll() intervals&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7164_dev_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">saa7164_devcount</span><span class="o">++</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;saa7164[%d]&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa7164_devlist</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>

	<span class="cm">/* board config */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">UNSET</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">saa7164_bcount</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">UNSET</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span>  <span class="o">&amp;&amp;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">saa7164_idcount</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span> <span class="o">==</span> <span class="n">saa7164_subids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subvendor</span> <span class="o">&amp;&amp;</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">==</span>
				<span class="n">saa7164_subids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">subdevice</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">saa7164_subids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">UNSET</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">=</span> <span class="n">SAA7164_BOARD_UNKNOWN</span><span class="p">;</span>
		<span class="n">saa7164_card_list</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_bus</span>  <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_slot</span> <span class="o">=</span> <span class="n">PCI_SLOT</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">);</span>

	<span class="cm">/* I2C Defaults / setup */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">nr</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Transport + Encoder ports 1, 2, 3, 4 - Defaults / setup */</span>
	<span class="n">saa7164_port_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7164_PORT_TS1</span><span class="p">);</span>
	<span class="n">saa7164_port_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7164_PORT_TS2</span><span class="p">);</span>
	<span class="n">saa7164_port_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7164_PORT_ENC1</span><span class="p">);</span>
	<span class="n">saa7164_port_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7164_PORT_ENC2</span><span class="p">);</span>
	<span class="n">saa7164_port_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7164_PORT_VBI1</span><span class="p">);</span>
	<span class="n">saa7164_port_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SAA7164_PORT_VBI2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">get_resources</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CORE %s No more PCIe resources for &quot;</span>
		       <span class="s">&quot;subsystem: %04x:%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">);</span>

		<span class="n">saa7164_devcount</span><span class="o">--</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* PCI/e allocations */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
			     <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio2</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
			     <span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio2</span><span class="p">;</span>

	<span class="cm">/* Inerrupt and ack register locations offset of bmmio */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_status</span> <span class="o">=</span> <span class="mh">0x183000</span> <span class="o">+</span> <span class="mh">0xf80</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">int_ack</span> <span class="o">=</span> <span class="mh">0x183000</span> <span class="o">+</span> <span class="mh">0xf90</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
		<span class="s">&quot;CORE %s: subsystem: %04x:%04x, board: %s [card=%d,%s]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_vendor</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">subsystem_device</span><span class="p">,</span> <span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">,</span> <span class="n">card</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">]</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">?</span>
	       <span class="s">&quot;insmod option&quot;</span> <span class="o">:</span> <span class="s">&quot;autodetected&quot;</span><span class="p">);</span>

	<span class="n">saa7164_pci_quirks</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_dev_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">release_mem_region</span><span class="p">(</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
		<span class="n">pci_resource_len</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="p">,</span> <span class="mi">2</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">lmmio2</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7164_proc_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">m</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">v</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResBusInfo</span> <span class="o">*</span><span class="n">b</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_devcount</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">list_for_each</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa7164_devlist</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">saa7164_dev</span><span class="p">,</span> <span class="n">devlist</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;%s = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Lock the bus from any other access */</span>
		<span class="n">b</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; .m_pdwSetWritePos = 0x%x (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwSetReadPos</span><span class="p">,</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwSetReadPos</span><span class="p">));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; .m_pdwSetReadPos  = 0x%x (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwSetWritePos</span><span class="p">,</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwSetWritePos</span><span class="p">));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; .m_pdwGetWritePos = 0x%x (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwGetReadPos</span><span class="p">,</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwGetReadPos</span><span class="p">));</span>

		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; .m_pdwGetReadPos  = 0x%x (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwGetWritePos</span><span class="p">,</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwGetWritePos</span><span class="p">));</span>
		<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">  Set Ring:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> addr  00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwSizeSetRing</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %04x:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">m_pdwSetRing</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">c</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">  Get Ring:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s"> addr  00 01 02 03 04 05 06 07 08 09 0a 0b 0c 0d 0e 0f</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">m_dwSizeGetRing</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">c</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %04x:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

			<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">m_pdwGetRing</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">c</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">seq_printf</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">c</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7164_proc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">saa7164_proc_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">saa7164_proc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">saa7164_proc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7164_proc_create</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">proc_dir_entry</span> <span class="o">*</span><span class="n">pe</span><span class="p">;</span>

	<span class="n">pe</span> <span class="o">=</span> <span class="n">proc_create</span><span class="p">(</span><span class="s">&quot;saa7164&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">saa7164_proc_fops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pe</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">saa7164_thread_function</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmFwInfoStruct</span> <span class="n">fwinfo</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">last_poll_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_THR</span><span class="p">,</span> <span class="s">&quot;thread started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">set_freezable</span><span class="p">();</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">try_to_freeze</span><span class="p">();</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_THR</span><span class="p">,</span> <span class="s">&quot;thread running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Dump the firmware debug message to console */</span>
		<span class="cm">/* Polling this costs us 1-2% of the arm CPU */</span>
		<span class="cm">/* convert this into a respnde to interrupt 0x7a */</span>
		<span class="n">saa7164_api_collect_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Monitor CPU load every 1 second */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">last_poll_time</span> <span class="o">+</span> <span class="mi">1000</span> <span class="cm">/* ms */</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">saa7164_api_get_load_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fwinfo</span><span class="p">);</span>
			<span class="n">last_poll_time</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_THR</span><span class="p">,</span> <span class="s">&quot;thread exiting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">saa7164_initdev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">pci_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">version</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">dev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* pci init */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_dev_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* print pci info */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_rev</span> <span class="o">=</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">pci_read_config_byte</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span>  <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_lat</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s/0: found at %s, rev: %d, irq: %d, &quot;</span>
	       <span class="s">&quot;latency: %d, mmio: 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">pci_name</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_rev</span><span class="p">,</span> <span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci_lat</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="cm">/* TODO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pci_dma_supported</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s/0: Oops: no 32bit PCI DMA ???</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">saa7164_irq</span><span class="p">,</span>
		<span class="n">IRQF_SHARED</span> <span class="o">|</span> <span class="n">IRQF_DISABLED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: can&#39;t get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Init the internal command list */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SAA_CMD_MAX_MSG_UNITS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">seqno</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">inuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">cmds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We need a deferred interrupt handler for cmd handling */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">workcmd</span><span class="p">,</span> <span class="n">saa7164_work_cmdhandler</span><span class="p">);</span>

	<span class="cm">/* Only load the firmware if we know the board */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">!=</span> <span class="n">SAA7164_BOARD_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">saa7164_downloadfirmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;Failed to boot firmware, no features &quot;</span>
				<span class="s">&quot;registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">fail_fw</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">saa7164_get_descriptors</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">saa7164_dumpregs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">saa7164_getcurrentfirmwareversion</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">saa7164_getfirmwarestatus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">saa7164_bus_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;Failed to setup the bus, will continue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa7164_bus_dump</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Ping the running firmware via the command bus and get the</span>
<span class="cm">		 * firmware version, this checks the bus is running OK.</span>
<span class="cm">		 */</span>
		<span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_api_get_fw_version</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">version</span><span class="p">)</span> <span class="o">==</span> <span class="n">SAA_OK</span><span class="p">)</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;Bus is operating correctly using &quot;</span>
				<span class="s">&quot;version %d.%d.%d.%d (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x0000fc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
				<span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x000003e0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span>
				<span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">),</span>
				<span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">,</span>
				<span class="n">version</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				<span class="s">&quot;Failed to communicate with the firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Bring up the I2C buses */</span>
		<span class="n">saa7164_i2c_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">saa7164_i2c_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">saa7164_i2c_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">saa7164_gpio_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">saa7164_card_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Parse the dynamic device configuration, find various</span>
<span class="cm">		 * media endpoints (MPEG, WMV, PS, TS) and cache their</span>
<span class="cm">		 * configuration details into the driver, so we can</span>
<span class="cm">		 * reference them later during simething_register() func,</span>
<span class="cm">		 * interrupt handlers, deferred work handlers etc.</span>
<span class="cm">		 */</span>
		<span class="n">saa7164_api_enum_subdevs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* Begin to create the video sub-systems and register funcs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">porta</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_DVB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_dvb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_TS1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() Failed to register &quot;</span>
					<span class="s">&quot;dvb adapters on porta</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_DVB</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_dvb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_TS2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s() Failed to register &quot;</span>
					<span class="s">&quot;dvb adapters on portb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_ENCODER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_encoder_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s() Failed to register &quot;</span>
					<span class="s">&quot;mpeg encoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portd</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_ENCODER</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_encoder_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s() Failed to register &quot;</span>
					<span class="s">&quot;mpeg encoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">porte</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_VBI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_vbi_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI1</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s() Failed to register &quot;</span>
					<span class="s">&quot;vbi device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portf</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_VBI</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_vbi_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI2</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="s">&quot;%s() Failed to register &quot;</span>
					<span class="s">&quot;vbi device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">saa7164_api_set_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">fw_debug</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fw_debug</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread</span> <span class="o">=</span> <span class="n">kthread_run</span><span class="p">(</span><span class="n">saa7164_thread_function</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;saa7164 debug&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() Failed to create &quot;</span>
					<span class="s">&quot;debug kernel thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="cm">/* != BOARD_UNKNOWN */</span>
	<span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() Unsupported board detected, &quot;</span>
			<span class="s">&quot;registering without firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() parameter debug = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">saa_debug</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s() parameter waitsecs = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">waitsecs</span><span class="p">);</span>

<span class="nl">fail_fw:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail_irq:</span>
	<span class="n">saa7164_dev_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">fail_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">saa7164_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">saa7164_finidev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pci_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span> <span class="o">!=</span> <span class="n">SAA7164_BOARD_UNKNOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw_debug</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kthread_stop</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">kthread</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">firmwareloaded</span><span class="p">)</span>
			<span class="n">saa7164_api_set_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">],</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">].</span><span class="n">irq_interval</span><span class="p">);</span>
	<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">],</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">].</span><span class="n">svc_interval</span><span class="p">);</span>
	<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">],</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">].</span><span class="n">irq_svc_interval</span><span class="p">);</span>
	<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">],</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">].</span><span class="n">read_interval</span><span class="p">);</span>
	<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">],</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">].</span><span class="n">poll_interval</span><span class="p">);</span>
	<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI1</span><span class="p">],</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI1</span><span class="p">].</span><span class="n">read_interval</span><span class="p">);</span>
	<span class="n">saa7164_histogram_print</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI2</span><span class="p">],</span>
		<span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI2</span><span class="p">].</span><span class="n">poll_interval</span><span class="p">);</span>

	<span class="n">saa7164_shutdown</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">porta</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_DVB</span><span class="p">)</span>
		<span class="n">saa7164_dvb_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_TS1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portb</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_DVB</span><span class="p">)</span>
		<span class="n">saa7164_dvb_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_TS2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portc</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_ENCODER</span><span class="p">)</span>
		<span class="n">saa7164_encoder_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portd</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_ENCODER</span><span class="p">)</span>
		<span class="n">saa7164_encoder_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">porte</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_VBI</span><span class="p">)</span>
		<span class="n">saa7164_vbi_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI1</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">portf</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_VBI</span><span class="p">)</span>
		<span class="n">saa7164_vbi_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI2</span><span class="p">]);</span>

	<span class="n">saa7164_i2c_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">saa7164_i2c_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">saa7164_i2c_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="cm">/* unregister stuff */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pci_dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">devlist</span><span class="p">);</span>

	<span class="n">saa7164_dev_unregister</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">saa7164_pci_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="cm">/* SAA7164 */</span>
		<span class="p">.</span><span class="n">vendor</span>       <span class="o">=</span> <span class="mh">0x1131</span><span class="p">,</span>
		<span class="p">.</span><span class="n">device</span>       <span class="o">=</span> <span class="mh">0x7164</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subvendor</span>    <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="p">.</span><span class="n">subdevice</span>    <span class="o">=</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
	<span class="p">},</span> <span class="p">{</span>
		<span class="cm">/* --- end of list --- */</span>
	<span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">saa7164_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">saa7164_pci_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="s">&quot;saa7164&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">saa7164_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">saa7164_initdev</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">saa7164_finidev</span><span class="p">),</span>
	<span class="cm">/* TODO */</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">saa7164_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;saa7164 driver loaded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">saa7164_proc_create</span><span class="p">();</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7164_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">saa7164_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PROC_FS</span>
	<span class="n">remove_proc_entry</span><span class="p">(</span><span class="s">&quot;saa7164&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">saa7164_pci_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">saa7164_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">saa7164_fini</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
