<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › saa7164 › saa7164-api.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>saa7164-api.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for the NXP SAA7164 PCIe bridge</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2010 Steven Toth &lt;stoth@kernellabs.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;saa7164.h&quot;</span>

<span class="kt">int</span> <span class="nf">saa7164_api_get_load_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">tmFwInfoStruct</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">saa_debug</span> <span class="o">&amp;</span> <span class="n">DBGLVL_CPU</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">i</span><span class="o">-&gt;</span><span class="n">deviceinst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">devicespec</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">GET_FW_STATUS_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmFwInfoStruct</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;saa7164[%d]-CPU: %d percent&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">CPULoad</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_collect_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmComResDebugGetData</span> <span class="n">d</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">more</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">more</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
			<span class="n">GET_DEBUG_DATA_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="p">.</span><span class="n">dwResult</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;saa7164[%d]-FWMSG: %s&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span>
			<span class="n">d</span><span class="p">.</span><span class="n">ucDebugData</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmComResDebugSetLevel</span> <span class="n">lvl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(level=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="cm">/* Retrieve current state */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">SET_DEBUG_LEVEL_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lvl</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lvl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s() Was %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lvl</span><span class="p">.</span><span class="n">dwDebugLevel</span><span class="p">);</span>

	<span class="n">lvl</span><span class="p">.</span><span class="n">dwDebugLevel</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>

	<span class="cm">/* set new state */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">SET_DEBUG_LEVEL_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lvl</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">lvl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_vbi_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResProbeCommit</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">rsp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(nr=%d, unitid=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">unitid</span><span class="p">);</span>

	<span class="n">fmt</span><span class="p">.</span><span class="n">bmHint</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">bFormatIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fmt</span><span class="p">.</span><span class="n">bFrameIndex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Probe, see if it can support this format */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span>
		<span class="n">SET_CUR</span><span class="p">,</span> <span class="n">SAA_PROBE_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() set error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* See of the format change was successful */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span>
		<span class="n">GET_CUR</span><span class="p">,</span> <span class="n">SAA_PROBE_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() get error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Compare requested vs received, should be same */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;SET/PROBE Verified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* Ask the device to select the negotiated format */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span>
				<span class="n">SET_CUR</span><span class="p">,</span> <span class="n">SAA_COMMIT_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fmt</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() commit error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span>
				<span class="n">GET_CUR</span><span class="p">,</span> <span class="n">SAA_COMMIT_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() GET commit error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rsp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rsp</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() memcmp error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;SET/COMMIT Verified</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;rsp.bmHint = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rsp</span><span class="p">.</span><span class="n">bmHint</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;rsp.bFormatIndex = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rsp</span><span class="p">.</span><span class="n">bFormatIndex</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;rsp.bFrameIndex = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">rsp</span><span class="p">.</span><span class="n">bFrameIndex</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() compare failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(nr=%d) Success</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_gop_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResEncVideoGopStructure</span> <span class="n">gs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">gs</span><span class="p">.</span><span class="n">ucRefFrameDist</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">refdist</span><span class="p">;</span>
	<span class="n">gs</span><span class="p">.</span><span class="n">ucGOPSize</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">gop_size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">EU_VIDEO_GOP_STRUCTURE_CONTROL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">gs</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">gs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResEncVideoBitRate</span> <span class="n">vb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResEncAudioBitRate</span> <span class="n">ab</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;%s() unitid=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">stream_type</span> <span class="o">==</span> <span class="n">V4L2_MPEG_STREAM_TYPE_MPEG2_PS</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_profile</span> <span class="o">=</span> <span class="n">EU_PROFILE_PS_DVD</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_profile</span> <span class="o">=</span> <span class="n">EU_PROFILE_TS_HQ</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">EU_PROFILE_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_profile</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Resolution */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">EU_PROFILE_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_profile</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Establish video bitrates */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">bitrate_mode</span> <span class="o">==</span>
		<span class="n">V4L2_MPEG_VIDEO_BITRATE_MODE_CBR</span><span class="p">)</span>
		<span class="n">vb</span><span class="p">.</span><span class="n">ucVideoBitRateMode</span> <span class="o">=</span> <span class="n">EU_VIDEO_BIT_RATE_MODE_CONSTANT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">vb</span><span class="p">.</span><span class="n">ucVideoBitRateMode</span> <span class="o">=</span> <span class="n">EU_VIDEO_BIT_RATE_MODE_VARIABLE_PEAK</span><span class="p">;</span>
	<span class="n">vb</span><span class="p">.</span><span class="n">dwVideoBitRate</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">bitrate</span><span class="p">;</span>
	<span class="n">vb</span><span class="p">.</span><span class="n">dwVideoBitRatePeak</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">bitrate_peak</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">EU_VIDEO_BIT_RATE_CONTROL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResEncVideoBitRate</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">vb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Establish audio bitrates */</span>
	<span class="n">ab</span><span class="p">.</span><span class="n">ucAudioBitRateMode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ab</span><span class="p">.</span><span class="n">dwAudioBitRate</span> <span class="o">=</span> <span class="mi">384000</span><span class="p">;</span>
	<span class="n">ab</span><span class="p">.</span><span class="n">dwAudioBitRatePeak</span> <span class="o">=</span> <span class="n">ab</span><span class="p">.</span><span class="n">dwAudioBitRate</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">EU_AUDIO_BIT_RATE_CONTROL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResEncAudioBitRate</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">ab</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>

	<span class="n">saa7164_api_set_aspect_ratio</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">saa7164_api_set_gop_size</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_get_encoder</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResEncVideoBitRate</span> <span class="n">v</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResEncAudioBitRate</span> <span class="n">a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResEncVideoInputAspectRatio</span> <span class="n">ar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;%s() unitid=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">);</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_profile</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">video_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">video_resolution</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">audio_format</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">EU_PROFILE_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_profile</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">EU_VIDEO_RESOLUTION_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">video_resolution</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">EU_VIDEO_FORMAT_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">video_format</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">EU_VIDEO_BIT_RATE_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">v</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">EU_AUDIO_FORMAT_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">audio_format</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">EU_AUDIO_BIT_RATE_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Aspect Ratio */</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ar</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">EU_VIDEO_INPUT_ASPECT_CONTROL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResEncVideoInputAspectRatio</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;encoder_profile = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_profile</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;video_format    = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">video_format</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;audio_format    = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audio_format</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;video_resolution= %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">video_resolution</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;v.ucVideoBitRateMode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">v</span><span class="p">.</span><span class="n">ucVideoBitRateMode</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;v.dwVideoBitRate     = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">v</span><span class="p">.</span><span class="n">dwVideoBitRate</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;v.dwVideoBitRatePeak = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">v</span><span class="p">.</span><span class="n">dwVideoBitRatePeak</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;a.ucVideoBitRateMode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">a</span><span class="p">.</span><span class="n">ucAudioBitRateMode</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;a.dwVideoBitRate     = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">a</span><span class="p">.</span><span class="n">dwAudioBitRate</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;a.dwVideoBitRatePeak = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">a</span><span class="p">.</span><span class="n">dwAudioBitRatePeak</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;aspect.width / height = %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ar</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">ar</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_aspect_ratio</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResEncVideoInputAspectRatio</span> <span class="n">ar</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">ctl_aspect</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">ctl_aspect</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_1x1</span>:
		<span class="n">ar</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ar</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_4x3</span>:
		<span class="n">ar</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">ar</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_16x9</span>:
		<span class="n">ar</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">ar</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MPEG_VIDEO_ASPECT_221x100</span>:
		<span class="n">ar</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">221</span><span class="p">;</span>
		<span class="n">ar</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;%s(%d) now %d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">encoder_params</span><span class="p">.</span><span class="n">ctl_aspect</span><span class="p">,</span>
		<span class="n">ar</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">ar</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* Aspect Ratio */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">EU_VIDEO_INPUT_ASPECT_CONTROL</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResEncVideoInputAspectRatio</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">ar</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_usercontrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_BRIGHTNESS_CONTROL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_brightness</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_CONTRAST_CONTROL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_HUE_CONTROL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_hue</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_SATURATION_CONTROL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_SHARPNESS_CONTROL</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_sharpness</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;%s() unitid=0x%x ctl=%d, val=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">encunit</span><span class="p">.</span><span class="n">vsourceid</span><span class="p">,</span> <span class="n">ctl</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">encunit</span><span class="p">.</span><span class="n">vsourceid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">ctl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_get_usercontrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ctl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">encunit</span><span class="p">.</span><span class="n">vsourceid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">ctl</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;%s() ctl=%d, val=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">ctl</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_BRIGHTNESS_CONTROL</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_brightness</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_CONTRAST_CONTROL</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_contrast</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_HUE_CONTROL</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_hue</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_SATURATION_CONTROL</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_saturation</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctl</span> <span class="o">==</span> <span class="n">PU_SHARPNESS_CONTROL</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">ctl_sharpness</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_videomux</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">inputs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;%s() v_mux=%d a_mux=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mux_input</span><span class="p">,</span> <span class="n">inputs</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mux_input</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>

	<span class="cm">/* Audio Mute */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_api_audio_mute</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Video Mux */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">vidproc</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">SU_INPUT_SELECT_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mux_input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Audio Mux */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">SU_INPUT_SELECT_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">inputs</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mux_input</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Audio UnMute */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_api_audio_mute</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_audio_mute</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mute</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">v</span> <span class="o">=</span> <span class="n">mute</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mute</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">MUTE_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* 0 = silence, 0xff = full */</span>
<span class="kt">int</span> <span class="nf">saa7164_api_set_audio_volume</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">s8</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">v</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">level</span><span class="p">);</span>

	<span class="cm">/* Obtain the min/max ranges */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">GET_MIN</span><span class="p">,</span>
		<span class="n">VOLUME_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">min</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">GET_MAX</span><span class="p">,</span>
		<span class="n">VOLUME_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">max</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">VOLUME_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(%d) min=%d max=%d cur=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">level</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="n">v</span> <span class="o">=</span> <span class="n">level</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="n">min</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>

	<span class="cm">/* Left */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">VOLUME_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Right */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="p">(</span><span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">VOLUME_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="p">(</span><span class="mh">0x01</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">VOLUME_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(%d) min=%d max=%d cur=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">level</span><span class="p">,</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">v</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_audio_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResAudioDefaults</span> <span class="n">lvl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResTunerStandard</span> <span class="n">tvaudio</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Establish default levels */</span>
	<span class="n">lvl</span><span class="p">.</span><span class="n">ucDecoderLevel</span> <span class="o">=</span> <span class="n">TMHW_LEV_ADJ_DECLEV_DEFAULT</span><span class="p">;</span>
	<span class="n">lvl</span><span class="p">.</span><span class="n">ucDecoderFM_Level</span> <span class="o">=</span> <span class="n">TMHW_LEV_ADJ_DECLEV_DEFAULT</span><span class="p">;</span>
	<span class="n">lvl</span><span class="p">.</span><span class="n">ucMonoLevel</span> <span class="o">=</span> <span class="n">TMHW_LEV_ADJ_MONOLEV_DEFAULT</span><span class="p">;</span>
	<span class="n">lvl</span><span class="p">.</span><span class="n">ucNICAM_Level</span> <span class="o">=</span> <span class="n">TMHW_LEV_ADJ_NICLEV_DEFAULT</span><span class="p">;</span>
	<span class="n">lvl</span><span class="p">.</span><span class="n">ucSAP_Level</span> <span class="o">=</span> <span class="n">TMHW_LEV_ADJ_SAPLEV_DEFAULT</span><span class="p">;</span>
	<span class="n">lvl</span><span class="p">.</span><span class="n">ucADC_Level</span> <span class="o">=</span> <span class="n">TMHW_LEV_ADJ_ADCLEV_DEFAULT</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">AUDIO_DEFAULT_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResAudioDefaults</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">lvl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Manually select the appropriate TV audio standard */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">encodernorm</span><span class="p">.</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tvaudio</span><span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">TU_STANDARD_NTSC_M</span><span class="p">;</span>
		<span class="n">tvaudio</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tvaudio</span><span class="p">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">TU_STANDARD_PAL_I</span><span class="p">;</span>
		<span class="n">tvaudio</span><span class="p">.</span><span class="n">country</span> <span class="o">=</span> <span class="mi">44</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tunerunit</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">TU_STANDARD_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tvaudio</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">tvaudio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() TU_STANDARD_CONTROL error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_audio_detection</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autodetect</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResTunerStandardAuto</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">autodetect</span><span class="p">);</span>

	<span class="cm">/* Disable TV Audio autodetect if not already set (buggy) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autodetect</span><span class="p">)</span>
		<span class="n">p</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">TU_STANDARD_AUTO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">p</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">TU_STANDARD_MANUAL</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">tunerunit</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">TU_STANDARD_AUTO_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s() TU_STANDARD_AUTO_CONTROL error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_get_videomux</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">vidproc</span><span class="p">.</span><span class="n">sourceid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">SU_INPUT_SELECT_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u8</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mux_input</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_ENC</span><span class="p">,</span> <span class="s">&quot;%s() v_mux=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">mux_input</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_dif</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mas</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(nr=%d type=%d val=%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mas</span> <span class="o">=</span> <span class="mh">0xd0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">mas</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

	<span class="n">buf</span><span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x04</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x26</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="n">mas</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xb0</span><span class="p">;</span>

	<span class="n">buf</span><span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
	<span class="n">buf</span><span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ifunit</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">GET_LEN</span><span class="p">,</span>
		<span class="n">EXU_REGISTER_ACCESS_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret(1) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ifunit</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">EXU_REGISTER_ACCESS_CONTROL</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret(2) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	saa7164_dumphex16(dev, buf, 16);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">SAA_OK</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Disable the IF block AGC controls */</span>
<span class="kt">int</span> <span class="nf">saa7164_api_configure_dif</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u32</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">agc_disable</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(nr=%d, 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; NTSC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="cm">/* Video Standard */</span>
		<span class="n">agc_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; PAL-I</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span> <span class="cm">/* Video Standard */</span>
		<span class="n">agc_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_M</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; PAL-M</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="cm">/* Video Standard */</span>
		<span class="n">agc_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_N</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; PAL-N</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="cm">/* Video Standard */</span>
		<span class="n">agc_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_Nc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; PAL-Nc</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="cm">/* Video Standard */</span>
		<span class="n">agc_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; PAL-B</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span> <span class="cm">/* Video Standard */</span>
		<span class="n">agc_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL_DK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; PAL-DK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span> <span class="cm">/* Video Standard */</span>
		<span class="n">agc_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; SECAM-L</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span> <span class="cm">/* Video Standard */</span>
		<span class="n">agc_disable</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Unknown standard, assume DTV */</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; Unknown (assuming DTV)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Undefinded Video Standard */</span>
		<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">agc_disable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">,</span> <span class="mh">0xa0</span><span class="p">);</span> <span class="cm">/* AGC Functions 1 */</span>
	<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0xc0</span><span class="p">,</span> <span class="n">agc_disable</span><span class="p">);</span> <span class="cm">/* AGC Output Disable */</span>
	<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x7c</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span> <span class="cm">/* CVBS EQ */</span>
	<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span> <span class="cm">/* Active */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="n">saa7164_api_set_dif</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span> <span class="cm">/* Active (again) */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Ensure the dif is in the correct state for the operating mode</span>
<span class="cm"> * (analog / dtv). We only configure the diff through the analog encoder</span>
<span class="cm"> * so when we&#39;re in digital mode we need to find the appropriate encoder</span>
<span class="cm"> * and use it to configure the DIF.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">saa7164_api_initialize_dif</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">std</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(nr=%d type=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_ENCODER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Pick any analog standard to init the diff.</span>
<span class="cm">		 * we&#39;ll come back during encoder_init&#39;</span>
<span class="cm">		 * and set the correct standard if requried.</span>
<span class="cm">		 */</span>
		<span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_DVB</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">==</span> <span class="n">SAA7164_PORT_TS1</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SAA7164_MPEG_VBI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_NTSC</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">==</span> <span class="n">SAA7164_PORT_VBI1</span><span class="p">)</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">BUG</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_api_configure_dif</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_transition_port</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="n">u8</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(nr=%d unitid=0x%x,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">SAA_STATE_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mode</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s(portnr %d unitid 0x%x) error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">unitid</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_get_fw_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">GET_FW_VERSION_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_read_eeprom</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Assumption: Hauppauge eeprom is at 0xa0 on on bus 0 */</span>
	<span class="cm">/* TODO: Pull the details from the boards struct */</span>
	<span class="k">return</span> <span class="n">saa7164_api_i2c_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">i2c_bus</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mh">0xa0</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">reg</span><span class="p">),</span>
		<span class="o">&amp;</span><span class="n">reg</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">128</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_configure_port_vbi</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">tmComResVBIFormatDescrHeader</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">vbi_fmt_ntsc</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    bFormatIndex  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bFormatIndex</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    VideoStandard = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">VideoStandard</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    StartLine     = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">StartLine</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    EndLine       = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">EndLine</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    FieldRate     = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">FieldRate</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    bNumLines     = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bNumLines</span><span class="p">);</span>

	<span class="cm">/* Cache the hardware configuration in the port */</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufcounter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufoffset</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufptr32l</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufptr32h</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufptr64</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = port-&gt;hwcfg.BARLocation = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = VS_FORMAT_VBI (becomes dev-&gt;en[%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_configure_port_mpeg2ts</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">tmComResTSFormatDescrHeader</span> <span class="o">*</span><span class="n">tsfmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    bFormatIndex = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsfmt</span><span class="o">-&gt;</span><span class="n">bFormatIndex</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    bDataOffset  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsfmt</span><span class="o">-&gt;</span><span class="n">bDataOffset</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    bPacketLength= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsfmt</span><span class="o">-&gt;</span><span class="n">bPacketLength</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    bStrideLength= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tsfmt</span><span class="o">-&gt;</span><span class="n">bStrideLength</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    bguid        = (....)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Cache the hardware configuration in the port */</span>

	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufcounter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufoffset</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufptr32l</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufptr32h</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufptr64</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = port-&gt;hwcfg.BARLocation = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = VS_FORMAT_MPEGTS (becomes dev-&gt;ts[%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_configure_port_mpeg2ps</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">tmComResPSFormatDescrHeader</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    bFormatIndex = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bFormatIndex</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    wPacketLength= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">wPacketLength</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    wPackLength=   0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">wPackLength</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;    bPackDataType= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">bPackDataType</span><span class="p">);</span>

	<span class="cm">/* Cache the hardware configuration in the port */</span>
	<span class="cm">/* TODO: CHECK THIS in the port config */</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufcounter</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">pitch</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufsize</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span> <span class="p">(</span><span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufoffset</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufptr32l</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufptr32h</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">bufptr64</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span> <span class="o">+</span>
		<span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="o">+</span>
		<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">buffercount</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = port-&gt;hwcfg.BARLocation = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">.</span><span class="n">BARLocation</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = VS_FORMAT_MPEGPS (becomes dev-&gt;enc[%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_dump_subdevs</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">tsport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">encport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">saa7164_port</span> <span class="o">*</span><span class="n">vbiport</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">idx</span><span class="p">,</span> <span class="n">next_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResDescrHeader</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResExtDevDescrHeader</span> <span class="o">*</span><span class="n">exthdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResPathDescrHeader</span> <span class="o">*</span><span class="n">pathhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResAntTermDescrHeader</span> <span class="o">*</span><span class="n">anttermhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResTunerDescrHeader</span> <span class="o">*</span><span class="n">tunerunithdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResDMATermDescrHeader</span> <span class="o">*</span><span class="n">vcoutputtermhdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResTSFormatDescrHeader</span> <span class="o">*</span><span class="n">tsfmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResPSFormatDescrHeader</span> <span class="o">*</span><span class="n">psfmt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResSelDescrHeader</span> <span class="o">*</span><span class="n">psel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResProcDescrHeader</span> <span class="o">*</span><span class="n">pdh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResAFeatureDescrHeader</span> <span class="o">*</span><span class="n">afd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResEncoderDescrHeader</span> <span class="o">*</span><span class="n">edh</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResVBIFormatDescrHeader</span> <span class="o">*</span><span class="n">vbifmt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">currpath</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
		<span class="s">&quot;%s(?,?,%d) sizeof(struct tmComResDescrHeader) = %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResDescrHeader</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResDescrHeader</span><span class="p">));)</span> <span class="p">{</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tmComResDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">CS_INTERFACE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">SAA_ERR_NOT_SUPPORTED</span><span class="p">;</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;@ 0x%x =</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">GENERAL_REQUEST</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; GENERAL_REQUEST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VC_TUNER_PATH</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; VC_TUNER_PATH</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">pathhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tmComResPathDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  pathid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pathhdr</span><span class="o">-&gt;</span><span class="n">pathid</span><span class="p">);</span>
			<span class="n">currpath</span> <span class="o">=</span> <span class="n">pathhdr</span><span class="o">-&gt;</span><span class="n">pathid</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VC_INPUT_TERMINAL</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; VC_INPUT_TERMINAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">anttermhdr</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">tmComResAntTermDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  terminalid   = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">anttermhdr</span><span class="o">-&gt;</span><span class="n">terminalid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  terminaltype = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">anttermhdr</span><span class="o">-&gt;</span><span class="n">terminaltype</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">anttermhdr</span><span class="o">-&gt;</span><span class="n">terminaltype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ITT_ANTENNA</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = ITT_ANTENNA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LINE_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = LINE_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPDIF_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = SPDIF_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">COMPOSITE_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = COMPOSITE_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SVIDEO_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = SVIDEO_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">COMPONENT_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = COMPONENT_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STANDARD_DMA</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = STANDARD_DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = undefined (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">anttermhdr</span><span class="o">-&gt;</span><span class="n">terminaltype</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  assocterminal= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">anttermhdr</span><span class="o">-&gt;</span><span class="n">assocterminal</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  iterminal    = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">anttermhdr</span><span class="o">-&gt;</span><span class="n">iterminal</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  controlsize  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">anttermhdr</span><span class="o">-&gt;</span><span class="n">controlsize</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VC_OUTPUT_TERMINAL</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; VC_OUTPUT_TERMINAL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">vcoutputtermhdr</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">tmComResDMATermDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  unitid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">unitid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  terminaltype = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">terminaltype</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">terminaltype</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">ITT_ANTENNA</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = ITT_ANTENNA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LINE_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = LINE_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SPDIF_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = SPDIF_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">COMPOSITE_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = COMPOSITE_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">SVIDEO_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = SVIDEO_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">COMPONENT_CONNECTOR</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = COMPONENT_CONNECTOR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STANDARD_DMA</span>:
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = STANDARD_DMA</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = undefined (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">terminaltype</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  assocterminal= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">assocterminal</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  sourceid     = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">sourceid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  iterminal    = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">iterminal</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  BARLocation  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">BARLocation</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  flags        = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  interruptid  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">interruptid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  buffercount  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">buffercount</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  metadatasize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">metadatasize</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  controlsize  = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">controlsize</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  numformats   = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">numformats</span><span class="p">);</span>

			<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tmComResDescrHeader</span> <span class="o">*</span><span class="p">)</span>
				<span class="p">((</span><span class="k">struct</span> <span class="n">tmComResDMATermDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">));</span>
			<span class="n">next_offset</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="p">(</span><span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">vcoutputtermhdr</span><span class="o">-&gt;</span><span class="n">numformats</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tmComResDescrHeader</span> <span class="o">*</span><span class="p">)</span>
					<span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">next_offset</span><span class="p">);</span>
				<span class="k">switch</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">VS_FORMAT_MPEG2TS</span>:
					<span class="n">tsfmt</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">tmComResTSFormatDescrHeader</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">currpath</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">tsport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_TS1</span><span class="p">];</span>
					<span class="k">else</span>
						<span class="n">tsport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_TS2</span><span class="p">];</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tsport</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">,</span> <span class="n">vcoutputtermhdr</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vcoutputtermhdr</span><span class="p">));</span>
					<span class="n">saa7164_api_configure_port_mpeg2ts</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">tsport</span><span class="p">,</span> <span class="n">tsfmt</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">VS_FORMAT_MPEG2PS</span>:
					<span class="n">psfmt</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">tmComResPSFormatDescrHeader</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">currpath</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">];</span>
					<span class="k">else</span>
						<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">];</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encport</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">,</span> <span class="n">vcoutputtermhdr</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vcoutputtermhdr</span><span class="p">));</span>
					<span class="n">saa7164_api_configure_port_mpeg2ps</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">encport</span><span class="p">,</span> <span class="n">psfmt</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">VS_FORMAT_VBI</span>:
					<span class="n">vbifmt</span> <span class="o">=</span>
					<span class="p">(</span><span class="k">struct</span> <span class="n">tmComResVBIFormatDescrHeader</span> <span class="o">*</span><span class="p">)</span><span class="n">t</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">currpath</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
						<span class="n">vbiport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI1</span><span class="p">];</span>
					<span class="k">else</span>
						<span class="n">vbiport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_VBI2</span><span class="p">];</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vbiport</span><span class="o">-&gt;</span><span class="n">hwcfg</span><span class="p">,</span> <span class="n">vcoutputtermhdr</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vcoutputtermhdr</span><span class="p">));</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vbiport</span><span class="o">-&gt;</span><span class="n">vbi_fmt_ntsc</span><span class="p">,</span> <span class="n">vbifmt</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vbifmt</span><span class="p">));</span>
					<span class="n">saa7164_api_configure_port_vbi</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">vbiport</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">VS_FORMAT_RDS</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
						<span class="s">&quot;   = VS_FORMAT_RDS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">VS_FORMAT_UNCOMPRESSED</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = VS_FORMAT_UNCOMPRESSED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">VS_FORMAT_TYPE</span>:
					<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
						<span class="s">&quot;   = VS_FORMAT_TYPE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
						<span class="s">&quot;   = undefined (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">t</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="n">next_offset</span> <span class="o">+=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">TUNER_UNIT</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; TUNER_UNIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tunerunithdr</span> <span class="o">=</span>
				<span class="p">(</span><span class="k">struct</span> <span class="n">tmComResTunerDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  unitid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tunerunithdr</span><span class="o">-&gt;</span><span class="n">unitid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  sourceid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tunerunithdr</span><span class="o">-&gt;</span><span class="n">sourceid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  iunit = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tunerunithdr</span><span class="o">-&gt;</span><span class="n">iunit</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  tuningstandards = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tunerunithdr</span><span class="o">-&gt;</span><span class="n">tuningstandards</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  controlsize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tunerunithdr</span><span class="o">-&gt;</span><span class="n">controlsize</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  controls = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">tunerunithdr</span><span class="o">-&gt;</span><span class="n">controls</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tunerunithdr</span><span class="o">-&gt;</span><span class="n">unitid</span> <span class="o">==</span> <span class="n">tunerunithdr</span><span class="o">-&gt;</span><span class="n">iunit</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currpath</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">];</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encport</span><span class="o">-&gt;</span><span class="n">tunerunit</span><span class="p">,</span> <span class="n">tunerunithdr</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResTunerDescrHeader</span><span class="p">));</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;  (becomes dev-&gt;enc[%d] tuner)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">encport</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VC_SELECTOR_UNIT</span>:
			<span class="n">psel</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tmComResSelDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; VC_SELECTOR_UNIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  unitid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">psel</span><span class="o">-&gt;</span><span class="n">unitid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  nrinpins = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">psel</span><span class="o">-&gt;</span><span class="n">nrinpins</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  sourceid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">psel</span><span class="o">-&gt;</span><span class="n">sourceid</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">VC_PROCESSING_UNIT</span>:
			<span class="n">pdh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tmComResProcDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; VC_PROCESSING_UNIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  unitid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pdh</span><span class="o">-&gt;</span><span class="n">unitid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  sourceid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pdh</span><span class="o">-&gt;</span><span class="n">sourceid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  controlsize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pdh</span><span class="o">-&gt;</span><span class="n">controlsize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdh</span><span class="o">-&gt;</span><span class="n">controlsize</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currpath</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">];</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encport</span><span class="o">-&gt;</span><span class="n">vidproc</span><span class="p">,</span> <span class="n">pdh</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResProcDescrHeader</span><span class="p">));</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  (becomes dev-&gt;enc[%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">encport</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FEATURE_UNIT</span>:
			<span class="n">afd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tmComResAFeatureDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; FEATURE_UNIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  unitid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">afd</span><span class="o">-&gt;</span><span class="n">unitid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  sourceid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">afd</span><span class="o">-&gt;</span><span class="n">sourceid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  controlsize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">afd</span><span class="o">-&gt;</span><span class="n">controlsize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">currpath</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">];</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encport</span><span class="o">-&gt;</span><span class="n">audfeat</span><span class="p">,</span> <span class="n">afd</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResAFeatureDescrHeader</span><span class="p">));</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  (becomes dev-&gt;enc[%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">encport</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ENCODER_UNIT</span>:
			<span class="n">edh</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tmComResEncoderDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; ENCODER_UNIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  subtype = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">edh</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  unitid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">edh</span><span class="o">-&gt;</span><span class="n">unitid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  vsourceid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">edh</span><span class="o">-&gt;</span><span class="n">vsourceid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  asourceid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">edh</span><span class="o">-&gt;</span><span class="n">asourceid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  iunit = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">edh</span><span class="o">-&gt;</span><span class="n">iunit</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">edh</span><span class="o">-&gt;</span><span class="n">iunit</span> <span class="o">==</span> <span class="n">edh</span><span class="o">-&gt;</span><span class="n">unitid</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currpath</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">];</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encport</span><span class="o">-&gt;</span><span class="n">encunit</span><span class="p">,</span> <span class="n">edh</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResEncoderDescrHeader</span><span class="p">));</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;  (becomes dev-&gt;enc[%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">encport</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">EXTENSION_UNIT</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; EXTENSION_UNIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">exthdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">tmComResExtDevDescrHeader</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  unitid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">unitid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  deviceid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">deviceid</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  devicetype = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = Decoder Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = GPIO Source</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = Video Decoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = Audio Decoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = Crossbar</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = Tuner</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = IF PLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = Demodulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x200</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = RDS Decoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x400</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = Encoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = IR Decoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x1000</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;   = EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = VBI Decoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x10000</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = Streaming Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x20000</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = DRM Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x40000000</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = Generic Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">)</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;   = Config Space Device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  numgpiopins = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">numgpiopins</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  numgpiogroups = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">numgpiogroups</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;  controlsize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">controlsize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">exthdr</span><span class="o">-&gt;</span><span class="n">devicetype</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">currpath</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC1</span><span class="p">];</span>
				<span class="k">else</span>
					<span class="n">encport</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">SAA7164_PORT_ENC2</span><span class="p">];</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">encport</span><span class="o">-&gt;</span><span class="n">ifunit</span><span class="p">,</span> <span class="n">exthdr</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">tmComResExtDevDescrHeader</span><span class="p">));</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span>
					<span class="s">&quot;  (becomes dev-&gt;enc[%d])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">encport</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">PVC_INFRARED_UNIT</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; PVC_INFRARED_UNIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">DRM_UNIT</span>:
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; DRM_UNIT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;default %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; 1.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; 2.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; 3.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">subtype</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot; 4.%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">unitid</span><span class="p">);</span>

		<span class="n">idx</span> <span class="o">+=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_enum_subdevs</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buflen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Get the total descriptor length */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_LEN</span><span class="p">,</span>
		<span class="n">GET_DESCRIPTORS_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buflen</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">buflen</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s() total descriptor size = %d bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>

	<span class="cm">/* Allocate enough storage for all of the descs */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">buflen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">SAA_ERR_NO_RESOURCES</span><span class="p">;</span>

	<span class="cm">/* Retrieve them */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">GET_DESCRIPTORS_CONTROL</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa_debug</span> <span class="o">&amp;</span> <span class="n">DBGLVL_API</span><span class="p">)</span>
		<span class="n">saa7164_dumphex16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">buflen</span><span class="o">/</span><span class="mi">16</span><span class="p">)</span><span class="o">*</span><span class="mi">16</span><span class="p">);</span>

	<span class="n">saa7164_api_dump_subdevs</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_i2c_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_i2c</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reglen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">reg</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">datalen</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unitid</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">regval</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reglen</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reglen</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reglen</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span> <span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="mi">1</span><span class="p">));</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reglen</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="mi">2</span><span class="p">));</span>
	<span class="k">else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reglen</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="o">*</span><span class="p">(</span><span class="n">reg</span><span class="o">+</span><span class="mi">3</span><span class="p">));</span>

	<span class="cm">/* Prepare the send buffer */</span>
	<span class="cm">/* Bytes 00-03 source register length</span>
<span class="cm">	 *       04-07 source bytes to read</span>
<span class="cm">	 *       08... register address</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span> <span class="mi">0</span><span class="p">),</span> <span class="n">reg</span><span class="p">,</span> <span class="n">reglen</span><span class="p">);</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="o">=</span> <span class="n">reglen</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="o">=</span> <span class="n">datalen</span><span class="p">;</span>

	<span class="n">unitid</span> <span class="o">=</span> <span class="n">saa7164_i2caddr_to_unitid</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unitid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s() error, cannot translate regaddr 0x%x to unitid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">unitid</span><span class="p">,</span> <span class="n">GET_LEN</span><span class="p">,</span>
		<span class="n">EXU_REGISTER_ACCESS_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret(1) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s() len = %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa_debug</span> <span class="o">&amp;</span> <span class="n">DBGLVL_I2C</span><span class="p">)</span>
		<span class="n">saa7164_dumphex16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">unitid</span><span class="p">,</span> <span class="n">GET_CUR</span><span class="p">,</span>
		<span class="n">EXU_REGISTER_ACCESS_CONTROL</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret(2) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saa_debug</span> <span class="o">&amp;</span> <span class="n">DBGLVL_I2C</span><span class="p">)</span>
			<span class="n">saa7164_dumphex16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">+</span> <span class="n">reglen</span><span class="p">),</span> <span class="n">datalen</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">SAA_OK</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* For a given 8 bit i2c address device, write the buffer */</span>
<span class="kt">int</span> <span class="nf">saa7164_api_i2c_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_i2c</span> <span class="o">*</span><span class="n">bus</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u32</span> <span class="n">datalen</span><span class="p">,</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unitid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reglen</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">datalen</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">datalen</span> <span class="o">&gt;</span> <span class="mi">232</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

	<span class="n">unitid</span> <span class="o">=</span> <span class="n">saa7164_i2caddr_to_unitid</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unitid</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s() error, cannot translate regaddr 0x%x to unitid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reglen</span> <span class="o">=</span> <span class="n">saa7164_i2caddr_to_reglen</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reglen</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s() error, cannot translate regaddr to reglen</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">unitid</span><span class="p">,</span> <span class="n">GET_LEN</span><span class="p">,</span>
		<span class="n">EXU_REGISTER_ACCESS_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">len</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret(1) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s() len = %d bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Prepare the send buffer */</span>
	<span class="cm">/* Bytes 00-03 dest register length</span>
<span class="cm">	 *       04-07 dest bytes to write</span>
<span class="cm">	 *       08... register address</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">0</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="o">=</span> <span class="n">reglen</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)))</span> <span class="o">=</span> <span class="n">datalen</span> <span class="o">-</span> <span class="n">reglen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">((</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)),</span> <span class="n">data</span><span class="p">,</span> <span class="n">datalen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa_debug</span> <span class="o">&amp;</span> <span class="n">DBGLVL_I2C</span><span class="p">)</span>
		<span class="n">saa7164_dumphex16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">EXU_REGISTER_ACCESS_CONTROL</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret(2) = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">SAA_OK</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_modify_gpio</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">unitid</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">pin</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tmComResGPIO</span> <span class="n">t</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_API</span><span class="p">,</span> <span class="s">&quot;%s(0x%x, %d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">unitid</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pin</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">state</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">SAA_ERR_BAD_PARAMETER</span><span class="p">;</span>

	<span class="n">t</span><span class="p">.</span><span class="n">pin</span> <span class="o">=</span> <span class="n">pin</span><span class="p">;</span>
	<span class="n">t</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_cmd_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">unitid</span><span class="p">,</span> <span class="n">SET_CUR</span><span class="p">,</span>
		<span class="n">EXU_GPIO_CONTROL</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">t</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SAA_OK</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() error, ret = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_set_gpiobit</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">unitid</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">saa7164_api_modify_gpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">unitid</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_api_clear_gpiobit</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">unitid</span><span class="p">,</span>
	<span class="n">u8</span> <span class="n">pin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">saa7164_api_modify_gpio</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">unitid</span><span class="p">,</span> <span class="n">pin</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
