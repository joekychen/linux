<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › saa7164 › saa7164-fw.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>saa7164-fw.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Driver for the NXP SAA7164 PCIe bridge</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2010 Steven Toth &lt;stoth@kernellabs.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;saa7164.h&quot;</span>

<span class="cp">#define SAA7164_REV2_FIRMWARE		&quot;NXP7164-2010-03-10.1.fw&quot;</span>
<span class="cp">#define SAA7164_REV2_FIRMWARE_SIZE	4019072</span>

<span class="cp">#define SAA7164_REV3_FIRMWARE		&quot;NXP7164-2010-03-10.1.fw&quot;</span>
<span class="cp">#define SAA7164_REV3_FIRMWARE_SIZE	4019072</span>

<span class="k">struct</span> <span class="n">fw_header</span> <span class="p">{</span>
	<span class="n">u32</span>	<span class="n">firmwaresize</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">bslsize</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">reserved</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">version</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">saa7164_dl_wait_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">SAA_DEVICE_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() timeout (no d/l ack)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">saa7164_dl_wait_clr</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">SAA_DEVICE_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">timeout</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() timeout (no d/l clr)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO: move dlflags into dev-&gt; and change to write/readl/b */</span>
<span class="cm">/* TODO: Excessive levels of debug */</span>
<span class="kt">int</span> <span class="nf">saa7164_downloadimage</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="n">u32</span> <span class="n">srcsize</span><span class="p">,</span>
	<span class="n">u32</span> <span class="n">dlflags</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span> <span class="n">u32</span> <span class="n">dstsize</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">srcbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">dlflag</span> <span class="o">=</span> <span class="n">dlflags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dlflag_ack</span> <span class="o">=</span> <span class="n">dlflag</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">drflag</span> <span class="o">=</span> <span class="n">dlflag_ack</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">drflag_ack</span> <span class="o">=</span> <span class="n">drflag</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bleflag</span> <span class="o">=</span> <span class="n">drflag_ack</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span>
		<span class="s">&quot;%s(image=%p, size=%d, flags=0x%x, dst=%p, dstsize=0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">__func__</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">srcsize</span><span class="p">,</span> <span class="n">dlflags</span><span class="p">,</span> <span class="n">dst</span><span class="p">,</span> <span class="n">dstsize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">src</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dst</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">srcbuf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="mi">1048576</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">srcbuf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">srcsize</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="mi">1048576</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">srcbuf</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">srcsize</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() dlflag = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dlflag</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() dlflag_ack = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dlflag_ack</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() drflag = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">drflag</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() drflag_ack = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">drflag_ack</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() bleflag = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">bleflag</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">dlflag</span><span class="p">);</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() dlflag (0x%x)= 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dlflag</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span>
			<span class="s">&quot;%s() Download flag already set, please reboot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Indicate download start */</span>
	<span class="n">saa7164_writel</span><span class="p">(</span><span class="n">dlflag</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_dl_wait_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dlflag_ack</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Ack download start, then wait for wait */</span>
	<span class="n">saa7164_writel</span><span class="p">(</span><span class="n">dlflag</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_dl_wait_clr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dlflag_ack</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Deal with the raw firmware, in the appropriate chunk size */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">srcsize</span> <span class="o">&gt;</span> <span class="n">dstsize</span><span class="p">;</span>
		<span class="n">srcsize</span> <span class="o">-=</span> <span class="n">dstsize</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+=</span> <span class="n">dstsize</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() memcpy %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dstsize</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">srcbuf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">dstsize</span><span class="p">);</span>

		<span class="cm">/* Flag the data as ready */</span>
		<span class="n">saa7164_writel</span><span class="p">(</span><span class="n">drflag</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_dl_wait_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drflag_ack</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="cm">/* Wait for indication data was received */</span>
		<span class="n">saa7164_writel</span><span class="p">(</span><span class="n">drflag</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_dl_wait_clr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drflag_ack</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() memcpy(l) %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dstsize</span><span class="p">);</span>
	<span class="cm">/* Write last block to the device */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">srcbuf</span><span class="o">+</span><span class="n">offset</span><span class="p">,</span> <span class="n">srcsize</span><span class="p">);</span>

	<span class="cm">/* Flag the data as ready */</span>
	<span class="n">saa7164_writel</span><span class="p">(</span><span class="n">drflag</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_dl_wait_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drflag_ack</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">saa7164_writel</span><span class="p">(</span><span class="n">drflag</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">bleflag</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SAA_DEVICE_IMAGE_BOOTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">bleflag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_IMAGE_CORRUPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() image corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">bleflag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_MEMORY_CORRUPT</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() device memory corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Checkpatch throws a &lt; 20ms warning */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() Image downloaded, booting...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_dl_wait_clr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">drflag_ack</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() Image booted successfully.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">srcbuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* TODO: Excessive debug */</span>
<span class="cm">/* Load the firmware. Optionally it can be in ROM or newer versions</span>
<span class="cm"> * can be on disk, saving the expense of the ROM hardware. */</span>
<span class="kt">int</span> <span class="nf">saa7164_downloadfirmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">saa7164_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* u32 second_timeout = 60 * SAA_DEVICE_TIMEOUT; */</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">filesize</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">err_flags</span><span class="p">,</span> <span class="n">first_timeout</span><span class="p">,</span> <span class="n">fwlength</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">second_timeout</span><span class="p">,</span> <span class="n">updatebootloader</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">bootloadersize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="o">*</span><span class="n">boothdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">fwhdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bootloaderversion</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">fwloadersize</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">bootloaderoffset</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">fwloaderoffset</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">fwname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">saa7164_boards</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">board</span><span class="p">].</span><span class="n">chiprev</span> <span class="o">==</span> <span class="n">SAA7164_CHIP_REV2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fwname</span> <span class="o">=</span> <span class="n">SAA7164_REV2_FIRMWARE</span><span class="p">;</span>
		<span class="n">fwlength</span> <span class="o">=</span> <span class="n">SAA7164_REV2_FIRMWARE_SIZE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fwname</span> <span class="o">=</span> <span class="n">SAA7164_REV3_FIRMWARE</span><span class="p">;</span>
		<span class="n">fwlength</span> <span class="o">=</span> <span class="n">SAA7164_REV3_FIRMWARE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">version</span> <span class="o">=</span> <span class="n">saa7164_getcurrentfirmwareversion</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">second_timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">first_timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">err_flags</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_BOOTLOADERERROR_FLAGS</span><span class="p">);</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() err_flags = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">err_flags</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">!=</span> <span class="n">SAA_DEVICE_IMAGE_BOOTING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() err_flags = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err_flags</span><span class="p">);</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Checkpatch throws a &lt; 20ms warning */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_IMAGE_CORRUPT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() firmware corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_MEMORY_CORRUPT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() device memory corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_NO_IMAGE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() no first image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_IMAGE_SEARCHING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">first_timeout</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">first_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						<span class="s">&quot;%s() no first image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_IMAGE_LOADING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">second_timeout</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">second_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					<span class="s">&quot;%s() FW load time exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">second_timeout</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">second_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					<span class="s">&quot;%s() Unknown bootloader flags 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span> <span class="n">err_flags</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">err_flags</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_BOOTLOADERERROR_FLAGS</span><span class="p">);</span>
		<span class="p">}</span> <span class="cm">/* While != Booting */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">==</span> <span class="n">SAA_DEVICE_IMAGE_BOOTING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() Loader 1 has loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
			<span class="n">first_timeout</span> <span class="o">=</span> <span class="n">SAA_DEVICE_TIMEOUT</span><span class="p">;</span>
			<span class="n">second_timeout</span> <span class="o">=</span> <span class="mi">60</span> <span class="o">*</span> <span class="n">SAA_DEVICE_TIMEOUT</span><span class="p">;</span>
			<span class="n">second_timeout</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

			<span class="n">err_flags</span> <span class="o">=</span> <span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_SECONDSTAGEERROR_FLAGS</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() err_flags2 = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err_flags</span><span class="p">);</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">!=</span> <span class="n">SAA_DEVICE_IMAGE_BOOTING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() err_flags2 = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">err_flags</span><span class="p">);</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Checkpatch throws a &lt; 20ms warning */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_IMAGE_CORRUPT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						<span class="s">&quot;%s() firmware corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_MEMORY_CORRUPT</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						<span class="s">&quot;%s() device memory corrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_NO_IMAGE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() no first image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span> <span class="n">SAA_DEVICE_IMAGE_SEARCHING</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">first_timeout</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">first_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						<span class="s">&quot;%s() no second image</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">err_flags</span> <span class="o">&amp;</span>
					<span class="n">SAA_DEVICE_IMAGE_LOADING</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">second_timeout</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">second_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						<span class="s">&quot;%s() FW load time exceeded</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">second_timeout</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">second_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
					<span class="s">&quot;%s() Unknown bootloader flags 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">,</span> <span class="n">err_flags</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="n">err_flags</span> <span class="o">=</span>
				<span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_SECONDSTAGEERROR_FLAGS</span><span class="p">);</span>
			<span class="p">}</span> <span class="cm">/* err_flags != SAA_DEVICE_IMAGE_BOOTING */</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() Loader flags 1:0x%x 2:0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span>
				<span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_BOOTLOADERERROR_FLAGS</span><span class="p">),</span>
				<span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_SECONDSTAGEERROR_FLAGS</span><span class="p">));</span>

		<span class="p">}</span> <span class="cm">/* err_flags == SAA_DEVICE_IMAGE_BOOTING */</span>

		<span class="cm">/* It&#39;s possible for both firmwares to have booted,</span>
<span class="cm">		 * but that doesn&#39;t mean they&#39;ve finished booting yet.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_BOOTLOADERERROR_FLAGS</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">SAA_DEVICE_IMAGE_BOOTING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="p">(</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_SECONDSTAGEERROR_FLAGS</span><span class="p">)</span> <span class="o">==</span>
			<span class="n">SAA_DEVICE_IMAGE_BOOTING</span><span class="p">))</span> <span class="p">{</span>


			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;%s() Loader 2 has loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>

			<span class="n">first_timeout</span> <span class="o">=</span> <span class="n">SAA_DEVICE_TIMEOUT</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">first_timeout</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span> <span class="cm">/* Checkpatch throws a &lt; 20ms warning */</span>

				<span class="n">version</span> <span class="o">=</span>
					<span class="n">saa7164_getcurrentfirmwareversion</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span>
					<span class="s">&quot;%s() All f/w loaded successfully</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">first_timeout</span> <span class="o">-=</span> <span class="mi">10</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">first_timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						<span class="s">&quot;%s() FW did not boot</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">__func__</span><span class="p">);</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">version</span> <span class="o">=</span> <span class="n">saa7164_getcurrentfirmwareversion</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="cm">/* version == 0 */</span>

	<span class="cm">/* Has the firmware really booted? */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_BOOTLOADERERROR_FLAGS</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">SAA_DEVICE_IMAGE_BOOTING</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_SECONDSTAGEERROR_FLAGS</span><span class="p">)</span> <span class="o">==</span>
		<span class="n">SAA_DEVICE_IMAGE_BOOTING</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;%s() The firmware hung, probably bad firmware</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">);</span>

		<span class="cm">/* Tell the second stage loader we have a deadlock */</span>
		<span class="n">saa7164_writel</span><span class="p">(</span><span class="n">SAA_DEVICE_DEADLOCK_DETECTED_OFFSET</span><span class="p">,</span>
			<span class="n">SAA_DEVICE_DEADLOCK_DETECTED</span><span class="p">);</span>

		<span class="n">saa7164_getfirmwarestatus</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;Device has Firmware Version %d.%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x0000fc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
		<span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x000003e0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">),</span>
		<span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>

	<span class="cm">/* Load the firmwware from the disk if required */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() Waiting for firmware upload (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">fwname</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">fwname</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pci</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s() Upload failed. &quot;</span>
				<span class="s">&quot;(file not found?)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() firmware read %Zu bytes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span> <span class="n">fwlength</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;xc5000: firmware incorrect size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() firmware loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Firmware file header part 1:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; .FirmwareSize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; .BSLSize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bslsize</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; .Reserved = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot; .Version = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>

		<span class="cm">/* Retrieve bootloader if reqd */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bslsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
			<span class="cm">/* Second bootloader in the firmware file */</span>
			<span class="n">filesize</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">reserved</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">filesize</span> <span class="o">=</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span> <span class="o">+</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bslsize</span><span class="p">)</span> <span class="o">*</span>
				<span class="mi">16</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span><span class="p">);</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() SecBootLoader.FileSize = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">filesize</span><span class="p">);</span>

		<span class="cm">/* Get bootloader (if reqd) and firmware header */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bslsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Second boot loader is required */</span>

			<span class="cm">/* Get the loader header */</span>
			<span class="n">boothdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span><span class="p">));</span>

			<span class="n">bootloaderversion</span> <span class="o">=</span>
				<span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DEVICE_2ND_VERSION</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;Onboard BootLoader:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;-&gt;Flag 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_BOOTLOADERERROR_FLAGS</span><span class="p">));</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;-&gt;Ack 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DATAREADY_FLAG_ACK</span><span class="p">));</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;-&gt;FW Version 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
			<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;-&gt;Loader Version 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bootloaderversion</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_BOOTLOADERERROR_FLAGS</span><span class="p">)</span> <span class="o">==</span>
				<span class="mh">0x03</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">saa7164_readl</span><span class="p">(</span><span class="n">SAA_DATAREADY_FLAG_ACK</span><span class="p">)</span>
				<span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">))</span> <span class="p">{</span>

				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;BootLoader version in  &quot;</span>
					<span class="s">&quot;rom %d.%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">bootloaderversion</span> <span class="o">&amp;</span> <span class="mh">0x0000fc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
					<span class="p">(</span><span class="n">bootloaderversion</span> <span class="o">&amp;</span> <span class="mh">0x000003e0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span>
					<span class="p">(</span><span class="n">bootloaderversion</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">),</span>
					<span class="p">(</span><span class="n">bootloaderversion</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
					<span class="p">);</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;BootLoader version &quot;</span>
					<span class="s">&quot;in file %d.%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x0000fc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
					<span class="p">(</span><span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x000003e0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span>
					<span class="p">(</span><span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">),</span>
					<span class="p">(</span><span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
					<span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">bootloaderversion</span> <span class="o">==</span> <span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span>
					<span class="n">updatebootloader</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Calculate offset to firmware header */</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span> <span class="o">+</span> <span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">bslsize</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span>
				<span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span><span class="p">));</span>

			<span class="n">fwhdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="o">+</span><span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* No second boot loader */</span>
			<span class="n">fwhdr</span> <span class="o">=</span> <span class="n">hdr</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;Firmware version in file %d.%d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fwhdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x0000fc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fwhdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x000003e0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">,</span>
			<span class="p">(</span><span class="n">fwhdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x0000001f</span><span class="p">),</span>
			<span class="p">(</span><span class="n">fwhdr</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0xffff0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span>
			<span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="n">fwhdr</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No download, firmware already on board */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">bslsize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">updatebootloader</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Get ready to upload the bootloader */</span>
				<span class="n">bootloadersize</span> <span class="o">=</span> <span class="p">(</span><span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span> <span class="o">+</span>
					<span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">bslsize</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span><span class="p">);</span>

				<span class="n">bootloaderoffset</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span><span class="p">));</span>

				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span> <span class="s">&quot;bootloader d/l starts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() FirmwareSize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() BSLSize = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">bslsize</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() Reserved = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">);</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s() Version = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_downloadimage</span><span class="p">(</span>
					<span class="n">dev</span><span class="p">,</span>
					<span class="n">bootloaderoffset</span><span class="p">,</span>
					<span class="n">bootloadersize</span><span class="p">,</span>
					<span class="n">SAA_DOWNLOAD_FLAGS</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio</span> <span class="o">+</span> <span class="n">SAA_DEVICE_DOWNLOAD_OFFSET</span><span class="p">,</span>
					<span class="n">SAA_DEVICE_BUFFERBLOCKSIZE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
						<span class="s">&quot;bootloader d/l has failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dprintk</span><span class="p">(</span><span class="n">DBGLVL_FW</span><span class="p">,</span>
					<span class="s">&quot;bootloader download complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="p">}</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;starting firmware download(2)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">bootloadersize</span> <span class="o">=</span> <span class="p">(</span><span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span> <span class="o">+</span>
				<span class="n">boothdr</span><span class="o">-&gt;</span><span class="n">bslsize</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span><span class="p">);</span>

			<span class="n">bootloaderoffset</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span><span class="p">));</span>

			<span class="n">fwloaderoffset</span> <span class="o">=</span> <span class="n">bootloaderoffset</span> <span class="o">+</span> <span class="n">bootloadersize</span><span class="p">;</span>

			<span class="cm">/* TODO: fix this bounds overrun here with old f/ws */</span>
			<span class="n">fwloadersize</span> <span class="o">=</span> <span class="p">(</span><span class="n">fwhdr</span><span class="o">-&gt;</span><span class="n">firmwaresize</span> <span class="o">+</span> <span class="n">fwhdr</span><span class="o">-&gt;</span><span class="n">bslsize</span><span class="p">)</span> <span class="o">*</span>
				<span class="mi">16</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_header</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_downloadimage</span><span class="p">(</span>
				<span class="n">dev</span><span class="p">,</span>
				<span class="n">fwloaderoffset</span><span class="p">,</span>
				<span class="n">fwloadersize</span><span class="p">,</span>
				<span class="n">SAA_DEVICE_2ND_DOWNLOADFLAG_OFFSET</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio</span> <span class="o">+</span> <span class="n">SAA_DEVICE_2ND_DOWNLOAD_OFFSET</span><span class="p">,</span>
				<span class="n">SAA_DEVICE_2ND_BUFFERBLOCKSIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware download failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware download complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="cm">/* No bootloader update reqd, download firmware only */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;starting firmware download(3)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="n">saa7164_downloadimage</span><span class="p">(</span>
				<span class="n">dev</span><span class="p">,</span>
				<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
				<span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				<span class="n">SAA_DOWNLOAD_FLAGS</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bmmio</span> <span class="o">+</span> <span class="n">SAA_DEVICE_DOWNLOAD_OFFSET</span><span class="p">,</span>
				<span class="n">SAA_DEVICE_BUFFERBLOCKSIZE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware download failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;firmware download complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">firmwareloaded</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
