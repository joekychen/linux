<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › omap3isp › ispcsi2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ispcsi2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ispcsi2.c</span>
<span class="cm"> *</span>
<span class="cm"> * TI OMAP3 ISP - CSI2 module</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Nokia Corporation</span>
<span class="cm"> * Copyright (C) 2009 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Contacts: Laurent Pinchart &lt;laurent.pinchart@ideasonboard.com&gt;</span>
<span class="cm"> *	     Sakari Ailus &lt;sakari.ailus@iki.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;linux/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>

<span class="cp">#include &quot;isp.h&quot;</span>
<span class="cp">#include &quot;ispreg.h&quot;</span>
<span class="cp">#include &quot;ispcsi2.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_if_enable - Enable CSI2 Receiver interface.</span>
<span class="cm"> * @enable: enable flag</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_if_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_csi2_ctrl_cfg</span> <span class="o">*</span><span class="n">currctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTRL</span><span class="p">,</span> <span class="n">ISPCSI2_CTRL_IF_EN</span><span class="p">,</span>
			<span class="n">enable</span> <span class="o">?</span> <span class="n">ISPCSI2_CTRL_IF_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">currctrl</span><span class="o">-&gt;</span><span class="n">if_enable</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_recv_config - CSI2 receiver module configuration.</span>
<span class="cm"> * @currctrl: isp_csi2_ctrl_cfg structure</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_recv_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">isp_csi2_ctrl_cfg</span> <span class="o">*</span><span class="n">currctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTRL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currctrl</span><span class="o">-&gt;</span><span class="n">frame_mode</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_CTRL_FRAME</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTRL_FRAME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currctrl</span><span class="o">-&gt;</span><span class="n">vp_clk_enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_CTRL_VP_CLK_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTRL_VP_CLK_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currctrl</span><span class="o">-&gt;</span><span class="n">vp_only_enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_CTRL_VP_ONLY_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTRL_VP_ONLY_EN</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTRL_VP_OUT_CTRL_MASK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">currctrl</span><span class="o">-&gt;</span><span class="n">vp_out_ctrl</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCSI2_CTRL_VP_OUT_CTRL_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">currctrl</span><span class="o">-&gt;</span><span class="n">ecc_enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_CTRL_ECC_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTRL_ECC_EN</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">csi2_input_fmts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGRBG10_DPCM8_1X8</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SRGGB10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SRGGB10_DPCM8_1X8</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SBGGR10_DPCM8_1X8</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGBRG10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGBRG10_DPCM8_1X8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* To set the format on the CSI2 requires a mapping function that takes</span>
<span class="cm"> * the following inputs:</span>
<span class="cm"> * - 2 different formats (at this time)</span>
<span class="cm"> * - 2 destinations (mem, vp+mem) (vp only handled separately)</span>
<span class="cm"> * - 2 decompression options (on, off)</span>
<span class="cm"> * - 2 isp revisions (certain format must be handled differently on OMAP3630)</span>
<span class="cm"> * Output should be CSI2 frame format code</span>
<span class="cm"> * Array indices as follows: [format][dest][decompr][is_3630]</span>
<span class="cm"> * Not all combinations are valid. 0 means invalid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">__csi2_fmt_map</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* RAW10 formats */</span>
	<span class="p">{</span>
		<span class="cm">/* Output to memory */</span>
		<span class="p">{</span>
			<span class="cm">/* No DPCM decompression */</span>
			<span class="p">{</span> <span class="n">CSI2_PIX_FMT_RAW10_EXP16</span><span class="p">,</span> <span class="n">CSI2_PIX_FMT_RAW10_EXP16</span> <span class="p">},</span>
			<span class="cm">/* DPCM decompression */</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">},</span>
		<span class="cm">/* Output to both */</span>
		<span class="p">{</span>
			<span class="cm">/* No DPCM decompression */</span>
			<span class="p">{</span> <span class="n">CSI2_PIX_FMT_RAW10_EXP16_VP</span><span class="p">,</span>
			  <span class="n">CSI2_PIX_FMT_RAW10_EXP16_VP</span> <span class="p">},</span>
			<span class="cm">/* DPCM decompression */</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="cm">/* RAW10 DPCM8 formats */</span>
	<span class="p">{</span>
		<span class="cm">/* Output to memory */</span>
		<span class="p">{</span>
			<span class="cm">/* No DPCM decompression */</span>
			<span class="p">{</span> <span class="n">CSI2_PIX_FMT_RAW8</span><span class="p">,</span> <span class="n">CSI2_USERDEF_8BIT_DATA1</span> <span class="p">},</span>
			<span class="cm">/* DPCM decompression */</span>
			<span class="p">{</span> <span class="n">CSI2_PIX_FMT_RAW8_DPCM10_EXP16</span><span class="p">,</span>
			  <span class="n">CSI2_USERDEF_8BIT_DATA1_DPCM10</span> <span class="p">},</span>
		<span class="p">},</span>
		<span class="cm">/* Output to both */</span>
		<span class="p">{</span>
			<span class="cm">/* No DPCM decompression */</span>
			<span class="p">{</span> <span class="n">CSI2_PIX_FMT_RAW8_VP</span><span class="p">,</span>
			  <span class="n">CSI2_PIX_FMT_RAW8_VP</span> <span class="p">},</span>
			<span class="cm">/* DPCM decompression */</span>
			<span class="p">{</span> <span class="n">CSI2_PIX_FMT_RAW8_DPCM10_VP</span><span class="p">,</span>
			  <span class="n">CSI2_USERDEF_8BIT_DATA1_DPCM10_VP</span> <span class="p">},</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_ctx_map_format - Map CSI2 sink media bus format to CSI2 format ID</span>
<span class="cm"> * @csi2: ISP CSI2 device</span>
<span class="cm"> *</span>
<span class="cm"> * Returns CSI2 physical format id</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">csi2_ctx_map_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CSI2_PAD_SINK</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">fmtidx</span><span class="p">,</span> <span class="n">destidx</span><span class="p">,</span> <span class="n">is_3630</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SRGGB10_1X10</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SGBRG10_1X10</span>:
		<span class="n">fmtidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_DPCM8_1X8</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SRGGB10_DPCM8_1X8</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_DPCM8_1X8</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SGBRG10_DPCM8_1X8</span>:
		<span class="n">fmtidx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_ERR</span> <span class="s">&quot;CSI2: pixel format %08x unsupported!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CSI2_OUTPUT_CCDC</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CSI2_OUTPUT_MEMORY</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Neither output enabled is a valid combination */</span>
		<span class="k">return</span> <span class="n">CSI2_PIX_FMT_OTHERS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If we need to skip frames at the beginning of the stream disable the</span>
<span class="cm">	 * video port to avoid sending the skipped frames to the CCDC.</span>
<span class="cm">	 */</span>
	<span class="n">destidx</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">frame_skip</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">!!</span><span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CSI2_OUTPUT_CCDC</span><span class="p">);</span>
	<span class="n">is_3630</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">__csi2_fmt_map</span><span class="p">[</span><span class="n">fmtidx</span><span class="p">][</span><span class="n">destidx</span><span class="p">][</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">dpcm_decompress</span><span class="p">][</span><span class="n">is_3630</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_set_outaddr - Set memory address to save output image</span>
<span class="cm"> * @csi2: Pointer to ISP CSI2a device.</span>
<span class="cm"> * @addr: ISP MMU Mapped 32-bit memory address aligned on 32 byte boundary.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the memory address where the output will be saved.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if successful, or -EINVAL if the address is not in the 32 byte</span>
<span class="cm"> * boundary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_set_outaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_csi2_ctx_cfg</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ping_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pong_addr</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ping_addr</span><span class="p">,</span>
		       <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_DAT_PING_ADDR</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pong_addr</span><span class="p">,</span>
		       <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_DAT_PONG_ADDR</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * is_usr_def_mapping - Checks whether USER_DEF_MAPPING should</span>
<span class="cm"> *			be enabled by CSI2.</span>
<span class="cm"> * @format_id: mapped format id</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">is_usr_def_mapping</span><span class="p">(</span><span class="n">u32</span> <span class="n">format_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">format_id</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_ctx_enable - Enable specified CSI2 context</span>
<span class="cm"> * @ctxnum: Context number, valid between 0 and 7 values.</span>
<span class="cm"> * @enable: enable</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_ctx_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ctxnum</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_csi2_ctx_cfg</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="n">ctxnum</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_CTRL1</span><span class="p">(</span><span class="n">ctxnum</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">frame_skip</span><span class="p">)</span>
			<span class="n">skip</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">frame_skip</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CSI2_OUTPUT_MEMORY</span><span class="p">)</span>
			<span class="n">skip</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTX_CTRL1_COUNT_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_CTX_CTRL1_COUNT_UNLOCK</span>
		    <span class="o">|</span>  <span class="p">(</span><span class="n">skip</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCSI2_CTX_CTRL1_COUNT_SHIFT</span><span class="p">)</span>
		    <span class="o">|</span>  <span class="n">ISPCSI2_CTX_CTRL1_CTX_EN</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTX_CTRL1_CTX_EN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_CTRL1</span><span class="p">(</span><span class="n">ctxnum</span><span class="p">));</span>
	<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_ctx_config - CSI2 context configuration.</span>
<span class="cm"> * @ctx: context configuration</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_ctx_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">isp_csi2_ctx_cfg</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="cm">/* Set up CSI2_CTx_CTRL1 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_CTRL1</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">eof_enabled</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_CTX_CTRL1_EOF_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTX_CTRL1_EOF_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">eol_enabled</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_CTX_CTRL1_EOL_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTX_CTRL1_EOL_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">checksum_enabled</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_CTX_CTRL1_CS_EN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTX_CTRL1_CS_EN</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_CTRL1</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>

	<span class="cm">/* Set up CSI2_CTx_CTRL2 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_CTRL2</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISPCSI2_CTX_CTRL2_VIRTUAL_ID_MASK</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">virtual_id</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCSI2_CTX_CTRL2_VIRTUAL_ID_SHIFT</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISPCSI2_CTX_CTRL2_FORMAT_MASK</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">format_id</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCSI2_CTX_CTRL2_FORMAT_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dpcm_decompress</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">dpcm_predictor</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_CTX_CTRL2_DPCM_PRED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTX_CTRL2_DPCM_PRED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_usr_def_mapping</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">format_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTX_CTRL2_USER_DEF_MAP_MASK</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mi">2</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCSI2_CTX_CTRL2_USER_DEF_MAP_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_CTRL2</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>

	<span class="cm">/* Set up CSI2_CTx_CTRL3 */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_CTRL3</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISPCSI2_CTX_CTRL3_ALPHA_MASK</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">alpha</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCSI2_CTX_CTRL3_ALPHA_SHIFT</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_CTRL3</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>

	<span class="cm">/* Set up CSI2_CTx_DAT_OFST */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span>
			    <span class="n">ISPCSI2_CTX_DAT_OFST</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_CTX_DAT_OFST_OFST_MASK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">data_offset</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCSI2_CTX_DAT_OFST_OFST_SHIFT</span><span class="p">;</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span>
		       <span class="n">ISPCSI2_CTX_DAT_OFST</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ping_addr</span><span class="p">,</span>
		       <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_DAT_PING_ADDR</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">pong_addr</span><span class="p">,</span>
		       <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_DAT_PONG_ADDR</span><span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_timing_config - CSI2 timing configuration.</span>
<span class="cm"> * @timing: csi2_timing_cfg structure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_timing_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">isp_csi2_timing_cfg</span> <span class="o">*</span><span class="n">timing</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_TIMING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">force_rx_mode</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_TIMING_FORCE_RX_MODE_IO</span><span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">ionum</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_TIMING_FORCE_RX_MODE_IO</span><span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">ionum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">stop_state_16x</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_TIMING_STOP_STATE_X16_IO</span><span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">ionum</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_TIMING_STOP_STATE_X16_IO</span><span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">ionum</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">stop_state_4x</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">ISPCSI2_TIMING_STOP_STATE_X4_IO</span><span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">ionum</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_TIMING_STOP_STATE_X4_IO</span><span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">ionum</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCSI2_TIMING_STOP_STATE_COUNTER_IO_MASK</span><span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">ionum</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">timing</span><span class="o">-&gt;</span><span class="n">stop_state_counter</span> <span class="o">&lt;&lt;</span>
	       <span class="n">ISPCSI2_TIMING_STOP_STATE_COUNTER_IO_SHIFT</span><span class="p">(</span><span class="n">timing</span><span class="o">-&gt;</span><span class="n">ionum</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_TIMING</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_irq_ctx_set - Enables CSI2 Context IRQs.</span>
<span class="cm"> * @enable: Enable/disable CSI2 Context interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_irq_ctx_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_IRQSTATUS_FE_IRQ</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span>
			       <span class="n">ISPCSI2_CTX_IRQSTATUS</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
			<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_IRQENABLE</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
				    <span class="n">ISPCSI2_CTX_IRQSTATUS_FE_IRQ</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_IRQENABLE</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
				    <span class="n">ISPCSI2_CTX_IRQSTATUS_FE_IRQ</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_irq_complexio1_set - Enables CSI2 ComplexIO IRQs.</span>
<span class="cm"> * @enable: Enable/disable CSI2 ComplexIO #1 interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_irq_complexio1_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ISPCSI2_PHY_IRQENABLE_STATEALLULPMEXIT</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_STATEALLULPMENTER</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_STATEULPM5</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRCONTROL5</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRESC5</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTSYNCHS5</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTHS5</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_STATEULPM4</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRCONTROL4</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRESC4</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTSYNCHS4</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTHS4</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_STATEULPM3</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRCONTROL3</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRESC3</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTSYNCHS3</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTHS3</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_STATEULPM2</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRCONTROL2</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRESC2</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTSYNCHS2</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTHS2</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_STATEULPM1</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRCONTROL1</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRESC1</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTSYNCHS1</span> <span class="o">|</span>
		<span class="n">ISPCSI2_PHY_IRQENABLE_ERRSOTHS1</span><span class="p">;</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_PHY_IRQSTATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_PHY_IRQENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_PHY_IRQENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_irq_status_set - Enables CSI2 Status IRQs.</span>
<span class="cm"> * @enable: Enable/disable CSI2 Status interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_irq_status_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">ISPCSI2_IRQSTATUS_OCP_ERR_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCSI2_IRQSTATUS_SHORT_PACKET_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCSI2_IRQSTATUS_ECC_CORRECTION_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCSI2_IRQSTATUS_ECC_NO_CORRECTION_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCSI2_IRQSTATUS_COMPLEXIO2_ERR_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCSI2_IRQSTATUS_COMPLEXIO1_ERR_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCSI2_IRQSTATUS_FIFO_OVF_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCSI2_IRQSTATUS_CONTEXT</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_IRQSTATUS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_IRQENABLE</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_IRQENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_csi2_reset - Resets the CSI2 module.</span>
<span class="cm"> *</span>
<span class="cm"> * Must be called with the phy lock held.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if successful, or -EBUSY if power command didn&#39;t respond.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_csi2_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">soft_reset_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_in_use</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_SYSCONFIG</span><span class="p">,</span>
		    <span class="n">ISPCSI2_SYSCONFIG_SOFT_RESET</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_SYSSTATUS</span><span class="p">)</span> <span class="o">&amp;</span>
				    <span class="n">ISPCSI2_SYSSTATUS_RESET_DONE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">ISPCSI2_SYSSTATUS_RESET_DONE</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">soft_reset_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">soft_reset_retries</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">soft_reset_retries</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">soft_reset_retries</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;CSI2: Soft reset try count exceeded!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span><span class="p">)</span>
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_PHY_CFG</span><span class="p">,</span>
			    <span class="n">ISPCSI2_PHY_CFG_RESET_CTRL</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">reg</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">phy_regs</span><span class="p">,</span> <span class="n">ISPCSIPHY_REG1</span><span class="p">)</span>
		    <span class="o">&amp;</span> <span class="n">ISPCSIPHY_REG1_RESET_DONE_CTRLCLK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="n">ISPCSIPHY_REG1_RESET_DONE_CTRLCLK</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
		       <span class="s">&quot;CSI2: Reset for CSI2_96M_FCLK domain Failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">autoidle</span><span class="p">)</span>
		<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_SYSCONFIG</span><span class="p">,</span>
				<span class="n">ISPCSI2_SYSCONFIG_MSTANDBY_MODE_MASK</span> <span class="o">|</span>
				<span class="n">ISPCSI2_SYSCONFIG_AUTO_IDLE</span><span class="p">,</span>
				<span class="n">ISPCSI2_SYSCONFIG_MSTANDBY_MODE_SMART</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span><span class="p">)</span> <span class="o">?</span>
				 <span class="n">ISPCSI2_SYSCONFIG_AUTO_IDLE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_SYSCONFIG</span><span class="p">,</span>
				<span class="n">ISPCSI2_SYSCONFIG_MSTANDBY_MODE_MASK</span> <span class="o">|</span>
				<span class="n">ISPCSI2_SYSCONFIG_AUTO_IDLE</span><span class="p">,</span>
				<span class="n">ISPCSI2_SYSCONFIG_MSTANDBY_MODE_NO</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">isp_v4l2_subdevs_group</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_csi2_timing_cfg</span> <span class="o">*</span><span class="n">timing</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sensor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * CSI2 fields that can be updated while the context has</span>
<span class="cm">	 * been enabled or the interface has been enabled are not</span>
<span class="cm">	 * updated dynamically currently. So we do not allow to</span>
<span class="cm">	 * reconfigure if either has been enabled</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">enabled</span> <span class="o">||</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">if_enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">pad</span> <span class="o">=</span> <span class="n">media_entity_remote_source</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">CSI2_PAD_SINK</span><span class="p">]);</span>
	<span class="n">sensor</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>

	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">frame_skip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">g_skip_frames</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">frame_skip</span><span class="p">);</span>

	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">vp_out_ctrl</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">csi2</span><span class="p">.</span><span class="n">vpclk_div</span><span class="p">;</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">frame_mode</span> <span class="o">=</span> <span class="n">ISP_CSI2_FRAME_IMMEDIATE</span><span class="p">;</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">.</span><span class="n">ecc_enable</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">csi2</span><span class="p">.</span><span class="n">crc</span><span class="p">;</span>

	<span class="n">timing</span><span class="o">-&gt;</span><span class="n">ionum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">timing</span><span class="o">-&gt;</span><span class="n">force_rx_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">timing</span><span class="o">-&gt;</span><span class="n">stop_state_16x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">timing</span><span class="o">-&gt;</span><span class="n">stop_state_4x</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">timing</span><span class="o">-&gt;</span><span class="n">stop_state_counter</span> <span class="o">=</span> <span class="mh">0x1FF</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The CSI2 receiver can&#39;t do any format conversion except DPCM</span>
<span class="cm">	 * decompression, so every set_format call configures both pads</span>
<span class="cm">	 * and enables DPCM decompression as a special case:</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CSI2_PAD_SINK</span><span class="p">].</span><span class="n">code</span> <span class="o">!=</span>
	    <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CSI2_PAD_SOURCE</span><span class="p">].</span><span class="n">code</span><span class="p">)</span>
		<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">dpcm_decompress</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">dpcm_decompress</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">format_id</span> <span class="o">=</span> <span class="n">csi2_ctx_map_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">bpl_padding</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data_offset</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">bpl_value</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable end of frame and end of line signals generation for</span>
<span class="cm">	 * context 0. These signals are generated from CSI2 receiver to</span>
<span class="cm">	 * qualify the last pixel of a frame and the last pixel of a line.</span>
<span class="cm">	 * Without enabling the signals CSI2 receiver writes data to memory</span>
<span class="cm">	 * beyond buffer size and/or data line offset is not handled correctly.</span>
<span class="cm">	 */</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">eof_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">eol_enabled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">csi2_irq_complexio1_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">csi2_irq_ctx_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">csi2_irq_status_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Set configuration (timings, format and links) */</span>
	<span class="n">csi2_timing_config</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="n">timing</span><span class="p">);</span>
	<span class="n">csi2_recv_config</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">csi2_ctx_config</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_print_status - Prints CSI2 debug information.</span>
<span class="cm"> */</span>
<span class="cp">#define CSI2_PRINT_REGISTER(isp, regs, name)\</span>
<span class="cp">	dev_dbg(isp-&gt;dev, &quot;###CSI2 &quot; #name &quot;=0x%08x\n&quot;, \</span>
<span class="cp">		isp_reg_readl(isp, regs, ISPCSI2_##name))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_print_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-------------CSI2 Register dump-------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">SYSCONFIG</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">SYSSTATUS</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">IRQENABLE</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">IRQSTATUS</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">CTRL</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">DBG_H</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">GNQ</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">PHY_CFG</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">PHY_IRQSTATUS</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">SHORT_PACKET</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">PHY_IRQENABLE</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">DBG_P</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">TIMING</span><span class="p">);</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">CTX_CTRL1</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">CTX_CTRL2</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">CTX_DAT_OFST</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">CTX_DAT_PING_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">CTX_DAT_PONG_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">CTX_IRQENABLE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">CTX_IRQSTATUS</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CSI2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">CTX_CTRL3</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;--------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Interrupt handling</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_isr_buffer - Does buffer handling at end-of-frame</span>
<span class="cm"> * when writing to memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_isr_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">csi2_ctx_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">omap3isp_video_buffer_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Let video queue operation restart engine if there is an underrun</span>
<span class="cm">	 * condition.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">csi2_set_outaddr</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>
	<span class="n">csi2_ctx_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">csi2_isr_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">isp_csi2_ctx_cfg</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ctxnum</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_IRQSTATUS</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_CTX_IRQSTATUS</span><span class="p">(</span><span class="n">n</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">ISPCSI2_CTX_IRQSTATUS_FE_IRQ</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Skip interrupts until we reach the frame skip count. The CSI2 will be</span>
<span class="cm">	 * automatically disabled, as the frame skip count has been programmed</span>
<span class="cm">	 * in the CSI2_CTx_CTRL1::COUNT field, so reenable it.</span>
<span class="cm">	 *</span>
<span class="cm">	 * It would have been nice to rely on the FRAME_NUMBER interrupt instead</span>
<span class="cm">	 * but it turned out that the interrupt is only generated when the CSI2</span>
<span class="cm">	 * writes to memory (the CSI2_CTx_CTRL1::COUNT field is decreased</span>
<span class="cm">	 * correctly and reaches 0 when data is forwarded to the video port only</span>
<span class="cm">	 * but no interrupt arrives). Maybe a CSI2 hardware bug.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">frame_skip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">frame_skip</span><span class="o">--</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">frame_skip</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ctx</span><span class="o">-&gt;</span><span class="n">format_id</span> <span class="o">=</span> <span class="n">csi2_ctx_map_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">);</span>
			<span class="n">csi2_ctx_config</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="n">ctx</span><span class="p">);</span>
			<span class="n">csi2_ctx_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CSI2_OUTPUT_MEMORY</span><span class="p">)</span>
		<span class="n">csi2_isr_buffer</span><span class="p">(</span><span class="n">csi2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_csi2_isr - CSI2 interrupt handling.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_csi2_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">csi2_irqstatus</span><span class="p">,</span> <span class="n">cpxio1_irqstatus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">available</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">csi2_irqstatus</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_IRQSTATUS</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2_irqstatus</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_IRQSTATUS</span><span class="p">);</span>

	<span class="cm">/* Failure Cases */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2_irqstatus</span> <span class="o">&amp;</span> <span class="n">ISPCSI2_IRQSTATUS_COMPLEXIO1_ERR_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cpxio1_irqstatus</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span>
						 <span class="n">ISPCSI2_PHY_IRQSTATUS</span><span class="p">);</span>
		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">cpxio1_irqstatus</span><span class="p">,</span>
			       <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">regs1</span><span class="p">,</span> <span class="n">ISPCSI2_PHY_IRQSTATUS</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CSI2: ComplexIO Error IRQ &quot;</span>
			<span class="s">&quot;%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cpxio1_irqstatus</span><span class="p">);</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csi2_irqstatus</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISPCSI2_IRQSTATUS_OCP_ERR_IRQ</span> <span class="o">|</span>
			      <span class="n">ISPCSI2_IRQSTATUS_SHORT_PACKET_IRQ</span> <span class="o">|</span>
			      <span class="n">ISPCSI2_IRQSTATUS_ECC_NO_CORRECTION_IRQ</span> <span class="o">|</span>
			      <span class="n">ISPCSI2_IRQSTATUS_COMPLEXIO2_ERR_IRQ</span> <span class="o">|</span>
			      <span class="n">ISPCSI2_IRQSTATUS_FIFO_OVF_IRQ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CSI2 Err:&quot;</span>
			<span class="s">&quot; OCP:%d,&quot;</span>
			<span class="s">&quot; Short_pack:%d,&quot;</span>
			<span class="s">&quot; ECC:%d,&quot;</span>
			<span class="s">&quot; CPXIO2:%d,&quot;</span>
			<span class="s">&quot; FIFO_OVF:%d,&quot;</span>
			<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">csi2_irqstatus</span> <span class="o">&amp;</span>
			 <span class="n">ISPCSI2_IRQSTATUS_OCP_ERR_IRQ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">csi2_irqstatus</span> <span class="o">&amp;</span>
			 <span class="n">ISPCSI2_IRQSTATUS_SHORT_PACKET_IRQ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">csi2_irqstatus</span> <span class="o">&amp;</span>
			 <span class="n">ISPCSI2_IRQSTATUS_ECC_NO_CORRECTION_IRQ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">csi2_irqstatus</span> <span class="o">&amp;</span>
			 <span class="n">ISPCSI2_IRQSTATUS_COMPLEXIO2_ERR_IRQ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">(</span><span class="n">csi2_irqstatus</span> <span class="o">&amp;</span>
			 <span class="n">ISPCSI2_IRQSTATUS_FIFO_OVF_IRQ</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_module_sync_is_stopping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Successful cases */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2_irqstatus</span> <span class="o">&amp;</span> <span class="n">ISPCSI2_IRQSTATUS_CONTEXT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
		<span class="n">csi2_isr_ctx</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">contexts</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">csi2_irqstatus</span> <span class="o">&amp;</span> <span class="n">ISPCSI2_IRQSTATUS_ECC_CORRECTION_IRQ</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CSI2: ECC correction done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * ISP video operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_queue - Queues the first buffer when using memory output</span>
<span class="cm"> * @video: The video node</span>
<span class="cm"> * @buffer: buffer to queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_video</span> <span class="o">*</span><span class="n">video</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">video</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">;</span>

	<span class="n">csi2_set_outaddr</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If streaming was enabled before there was a buffer queued</span>
<span class="cm">	 * or underrun happened in the ISR, the hardware was not enabled</span>
<span class="cm">	 * and DMA queue flag ISP_VIDEO_DMAQUEUE_UNDERRUN is still set.</span>
<span class="cm">	 * Enable it now.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">dmaqueue_flags</span> <span class="o">&amp;</span> <span class="n">ISP_VIDEO_DMAQUEUE_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Enable / disable context 0 and IRQs */</span>
		<span class="n">csi2_if_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">csi2_ctx_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">isp_video_dmaqueue_flags_clr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">isp_video_operations</span> <span class="n">csi2_ispvideo_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">csi2_queue</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * V4L2 subdev operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span>
<span class="nf">__csi2_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">pad</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">csi2_try_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">pixelcode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">isp_format_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CSI2_PAD_SINK</span>:
		<span class="cm">/* Clamp the width and height to valid range (1-8191). */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">csi2_input_fmts</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">csi2_input_fmts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If not found, use SGRBG10 as default */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">csi2_input_fmts</span><span class="p">))</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">;</span>

		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8191</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">8191</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSI2_PAD_SOURCE</span>:
		<span class="cm">/* Source format same as sink format, except for DPCM</span>
<span class="cm">		 * compression.</span>
<span class="cm">		 */</span>
		<span class="n">pixelcode</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">__csi2_get_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CSI2_PAD_SINK</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Only Allow DPCM decompression, and check that the</span>
<span class="cm">		 * pattern is preserved</span>
<span class="cm">		 */</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">omap3isp_video_format_info</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uncompressed</span> <span class="o">==</span> <span class="n">pixelcode</span><span class="p">)</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">pixelcode</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* RGB, non-interlaced */</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_enum_mbus_code - Handle pixel format enumeration</span>
<span class="cm"> * @sd     : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh     : V4L2 subdev file handle</span>
<span class="cm"> * @code   : pointer to v4l2_subdev_mbus_code_enum structure</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_enum_mbus_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_subdev_mbus_code_enum</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">isp_format_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">CSI2_PAD_SINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">csi2_input_fmts</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">csi2_input_fmts</span><span class="p">[</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">__csi2_get_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CSI2_PAD_SINK</span><span class="p">,</span>
					   <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="cm">/* Passthrough sink pad code */</span>
			<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="cm">/* Uncompressed code */</span>
			<span class="n">info</span> <span class="o">=</span> <span class="n">omap3isp_video_format_info</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">uncompressed</span> <span class="o">==</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

			<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">uncompressed</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_enum_frame_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_frame_size_enum</span> <span class="o">*</span><span class="n">fse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fse</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">csi2_try_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_width</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_height</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">csi2_try_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_width</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_height</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_get_format - Handle get format by pads subdev method</span>
<span class="cm"> * @sd : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh : V4L2 subdev file handle</span>
<span class="cm"> * @fmt: pointer to v4l2 subdev format structure</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__csi2_get_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_set_format - Handle set format by pads subdev method</span>
<span class="cm"> * @sd : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh : V4L2 subdev file handle</span>
<span class="cm"> * @fmt: pointer to v4l2 subdev format structure</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__csi2_get_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">csi2_try_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>

	<span class="cm">/* Propagate the format from sink to source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">CSI2_PAD_SINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">__csi2_get_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CSI2_PAD_SOURCE</span><span class="p">,</span>
					   <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
		<span class="n">csi2_try_format</span><span class="p">(</span><span class="n">csi2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CSI2_PAD_SOURCE</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_init_formats - Initialize formats on all pads</span>
<span class="cm"> * @sd: ISP CSI2 V4L2 subdevice</span>
<span class="cm"> * @fh: V4L2 subdev file handle</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize all pad formats with default values. If fh is not NULL, try</span>
<span class="cm"> * formats are initialized on the file handle. Otherwise active formats are</span>
<span class="cm"> * initialized on the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_init_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="n">format</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">));</span>
	<span class="n">format</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">CSI2_PAD_SINK</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">which</span> <span class="o">=</span> <span class="n">fh</span> <span class="o">?</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span> <span class="o">:</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">csi2_set_format</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_set_stream - Enable/Disable streaming on the CSI2 module</span>
<span class="cm"> * @sd: ISP CSI2 V4L2 subdevice</span>
<span class="cm"> * @enable: ISP pipeline stream state</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_set_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_video</span> <span class="o">*</span><span class="n">video_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_CONTINUOUS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_csiphy_acquire</span><span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CSI2_OUTPUT_MEMORY</span><span class="p">)</span>
			<span class="n">omap3isp_sbl_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_CSI2A_WRITE</span><span class="p">);</span>
		<span class="n">csi2_configure</span><span class="p">(</span><span class="n">csi2</span><span class="p">);</span>
		<span class="n">csi2_print_status</span><span class="p">(</span><span class="n">csi2</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * When outputting to memory with no buffer available, let the</span>
<span class="cm">		 * buffer queue handler start the hardware. A DMA queue flag</span>
<span class="cm">		 * ISP_VIDEO_DMAQUEUE_QUEUED will be set as soon as there is</span>
<span class="cm">		 * a buffer available.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CSI2_OUTPUT_MEMORY</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">video_out</span><span class="o">-&gt;</span><span class="n">dmaqueue_flags</span> <span class="o">&amp;</span> <span class="n">ISP_VIDEO_DMAQUEUE_QUEUED</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* Enable context 0 and IRQs */</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">csi2_ctx_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">csi2_if_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">isp_video_dmaqueue_flags_clr</span><span class="p">(</span><span class="n">video_out</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_module_sync_idle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: module stop timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">csi2_ctx_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">csi2_if_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">csi2_irq_ctx_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">csi2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">omap3isp_csiphy_release</span><span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="n">isp_video_dmaqueue_flags_clr</span><span class="p">(</span><span class="n">video_out</span><span class="p">);</span>
		<span class="n">omap3isp_sbl_disable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_CSI2A_WRITE</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* subdev video operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">csi2_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span> <span class="o">=</span> <span class="n">csi2_set_stream</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* subdev pad operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_pad_ops</span> <span class="n">csi2_pad_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enum_mbus_code</span> <span class="o">=</span> <span class="n">csi2_enum_mbus_code</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_frame_size</span> <span class="o">=</span> <span class="n">csi2_enum_frame_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fmt</span> <span class="o">=</span> <span class="n">csi2_get_format</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span> <span class="o">=</span> <span class="n">csi2_set_format</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* subdev operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">csi2_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2_video_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2_pad_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* subdev internal operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_internal_ops</span> <span class="n">csi2_internal_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">csi2_init_formats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Media entity operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_link_setup - Setup CSI2 connections.</span>
<span class="cm"> * @entity : Pointer to media entity structure</span>
<span class="cm"> * @local  : Pointer to local pad array</span>
<span class="cm"> * @remote : Pointer to remote pad array</span>
<span class="cm"> * @flags  : Link flags</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_link_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">remote</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_csi2_ctrl_cfg</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">ctrl</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ISP core doesn&#39;t support pipelines with multiple video outputs.</span>
<span class="cm">	 * Revisit this when it will be implemented, and return -EBUSY for now.</span>
<span class="cm">	 */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">|</span> <span class="n">media_entity_type</span><span class="p">(</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CSI2_PAD_SOURCE</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_DEVNODE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CSI2_OUTPUT_MEMORY</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">|=</span> <span class="n">CSI2_OUTPUT_MEMORY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSI2_OUTPUT_MEMORY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CSI2_PAD_SOURCE</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CSI2_OUTPUT_CCDC</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">|=</span> <span class="n">CSI2_OUTPUT_CCDC</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CSI2_OUTPUT_CCDC</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Link from camera to CSI2 is fixed... */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">vp_only_enable</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CSI2_OUTPUT_MEMORY</span><span class="p">)</span> <span class="o">?</span> <span class="nb">false</span> <span class="o">:</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">vp_clk_enable</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CSI2_OUTPUT_CCDC</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* media operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">media_entity_operations</span> <span class="n">csi2_media_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">link_setup</span> <span class="o">=</span> <span class="n">csi2_link_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_validate</span> <span class="o">=</span> <span class="n">v4l2_subdev_link_validate</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">omap3isp_csi2_unregister_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="n">omap3isp_video_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap3isp_csi2_register_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Register the subdev and video nodes. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">,</span> <span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">omap3isp_csi2_unregister_entities</span><span class="p">(</span><span class="n">csi2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * ISP CSI2 initialisation and cleanup</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * csi2_init_entities - Initialize subdev and media entity.</span>
<span class="cm"> * @csi2: Pointer to csi2 structure.</span>
<span class="cm"> * return -ENOMEM or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">csi2_init_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pads</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">csi2_ops</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">internal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2_internal_ops</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;OMAP3 ISP CSI2a&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* group ID for isp subdevs */</span>
	<span class="n">v4l2_set_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">csi2</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_HAS_DEVNODE</span><span class="p">;</span>

	<span class="n">pads</span><span class="p">[</span><span class="n">CSI2_PAD_SOURCE</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>
	<span class="n">pads</span><span class="p">[</span><span class="n">CSI2_PAD_SINK</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SINK</span><span class="p">;</span>

	<span class="n">me</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2_media_ops</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_init</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">CSI2_PADS_NUM</span><span class="p">,</span> <span class="n">pads</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">csi2_init_formats</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* Video device node */</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">csi2_ispvideo_ops</span><span class="p">;</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">bpl_alignment</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">bpl_zero_padding</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">bpl_max</span> <span class="o">=</span> <span class="mh">0x1ffe0</span><span class="p">;</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">isp</span> <span class="o">=</span> <span class="n">csi2</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">capture_mem</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="mi">4096</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">,</span> <span class="s">&quot;CSI2a&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_video</span><span class="p">;</span>

	<span class="cm">/* Connect the CSI2 subdev to the video node. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CSI2_PAD_SOURCE</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">video</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_link:</span>
	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
<span class="nl">error_video:</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_csi2_init - Routine for module driver init</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_csi2_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2c</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">csi2a</span><span class="o">-&gt;</span><span class="n">isp</span> <span class="o">=</span> <span class="n">isp</span><span class="p">;</span>
	<span class="n">csi2a</span><span class="o">-&gt;</span><span class="n">available</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">csi2a</span><span class="o">-&gt;</span><span class="n">regs1</span> <span class="o">=</span> <span class="n">OMAP3_ISP_IOMEM_CSI2A_REGS1</span><span class="p">;</span>
	<span class="n">csi2a</span><span class="o">-&gt;</span><span class="n">regs2</span> <span class="o">=</span> <span class="n">OMAP3_ISP_IOMEM_CSI2A_REGS2</span><span class="p">;</span>
	<span class="n">csi2a</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csiphy2</span><span class="p">;</span>
	<span class="n">csi2a</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2a</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">csi2_init_entities</span><span class="p">(</span><span class="n">csi2a</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">csi2c</span><span class="o">-&gt;</span><span class="n">isp</span> <span class="o">=</span> <span class="n">isp</span><span class="p">;</span>
		<span class="n">csi2c</span><span class="o">-&gt;</span><span class="n">available</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">csi2c</span><span class="o">-&gt;</span><span class="n">regs1</span> <span class="o">=</span> <span class="n">OMAP3_ISP_IOMEM_CSI2C_REGS1</span><span class="p">;</span>
		<span class="n">csi2c</span><span class="o">-&gt;</span><span class="n">regs2</span> <span class="o">=</span> <span class="n">OMAP3_ISP_IOMEM_CSI2C_REGS2</span><span class="p">;</span>
		<span class="n">csi2c</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csiphy1</span><span class="p">;</span>
		<span class="n">csi2c</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">;</span>
		<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2c</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_csi2_cleanup - Routine for module driver cleanup</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_csi2_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_csi2_device</span> <span class="o">*</span><span class="n">csi2a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">;</span>

	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2a</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">csi2a</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
