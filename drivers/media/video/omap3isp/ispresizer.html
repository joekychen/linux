<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › omap3isp › ispresizer.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ispresizer.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ispresizer.c</span>
<span class="cm"> *</span>
<span class="cm"> * TI OMAP3 ISP - Resizer module</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Nokia Corporation</span>
<span class="cm"> * Copyright (C) 2009 Texas Instruments, Inc</span>
<span class="cm"> *</span>
<span class="cm"> * Contacts: Laurent Pinchart &lt;laurent.pinchart@ideasonboard.com&gt;</span>
<span class="cm"> *	     Sakari Ailus &lt;sakari.ailus@iki.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;isp.h&quot;</span>
<span class="cp">#include &quot;ispreg.h&quot;</span>
<span class="cp">#include &quot;ispresizer.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Resizer Constants</span>
<span class="cm"> */</span>
<span class="cp">#define MIN_RESIZE_VALUE		64</span>
<span class="cp">#define MID_RESIZE_VALUE		512</span>
<span class="cp">#define MAX_RESIZE_VALUE		1024</span>

<span class="cp">#define MIN_IN_WIDTH			32</span>
<span class="cp">#define MIN_IN_HEIGHT			32</span>
<span class="cp">#define MAX_IN_WIDTH_MEMORY_MODE	4095</span>
<span class="cp">#define MAX_IN_WIDTH_ONTHEFLY_MODE_ES1	1280</span>
<span class="cp">#define MAX_IN_WIDTH_ONTHEFLY_MODE_ES2	4095</span>
<span class="cp">#define MAX_IN_HEIGHT			4095</span>

<span class="cp">#define MIN_OUT_WIDTH			16</span>
<span class="cp">#define MIN_OUT_HEIGHT			2</span>
<span class="cp">#define MAX_OUT_HEIGHT			4095</span>

<span class="cm">/*</span>
<span class="cm"> * Resizer Use Constraints</span>
<span class="cm"> * &quot;TRM ES3.1, table 12-46&quot;</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_4TAP_OUT_WIDTH_ES1		1280</span>
<span class="cp">#define MAX_7TAP_OUT_WIDTH_ES1		640</span>
<span class="cp">#define MAX_4TAP_OUT_WIDTH_ES2		3312</span>
<span class="cp">#define MAX_7TAP_OUT_WIDTH_ES2		1650</span>
<span class="cp">#define MAX_4TAP_OUT_WIDTH_3630		4096</span>
<span class="cp">#define MAX_7TAP_OUT_WIDTH_3630		2048</span>

<span class="cm">/*</span>
<span class="cm"> * Constants for ratio calculation</span>
<span class="cm"> */</span>
<span class="cp">#define RESIZE_DIVISOR			256</span>
<span class="cp">#define DEFAULT_PHASE			1</span>

<span class="cm">/*</span>
<span class="cm"> * Default (and only) configuration of filter coefficients.</span>
<span class="cm"> * 7-tap mode is for scale factors 0.25x to 0.5x.</span>
<span class="cm"> * 4-tap mode is for scale factors 0.5x to 4.0x.</span>
<span class="cm"> * There shouldn&#39;t be any reason to recalculate these, EVER.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">isprsz_coef</span> <span class="n">filter_coefs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* For 8-phase 4-tap horizontal filter: */</span>
	<span class="p">{</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x03FA</span><span class="p">,</span> <span class="mh">0x00F6</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x03F9</span><span class="p">,</span> <span class="mh">0x00DB</span><span class="p">,</span> <span class="mh">0x002C</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x03FB</span><span class="p">,</span> <span class="mh">0x00B3</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">,</span> <span class="mh">0x03FF</span><span class="p">,</span>
		<span class="mh">0x03FD</span><span class="p">,</span> <span class="mh">0x0082</span><span class="p">,</span> <span class="mh">0x0084</span><span class="p">,</span> <span class="mh">0x03FD</span><span class="p">,</span>
		<span class="mh">0x03FF</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">,</span> <span class="mh">0x00B3</span><span class="p">,</span> <span class="mh">0x03FB</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x002C</span><span class="p">,</span> <span class="mh">0x00DB</span><span class="p">,</span> <span class="mh">0x03F9</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x00F6</span><span class="p">,</span> <span class="mh">0x03FA</span>
	<span class="p">},</span>
	<span class="cm">/* For 8-phase 4-tap vertical filter: */</span>
	<span class="p">{</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x03FA</span><span class="p">,</span> <span class="mh">0x00F6</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x03F9</span><span class="p">,</span> <span class="mh">0x00DB</span><span class="p">,</span> <span class="mh">0x002C</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span>
		<span class="mh">0x03FB</span><span class="p">,</span> <span class="mh">0x00B3</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">,</span> <span class="mh">0x03FF</span><span class="p">,</span>
		<span class="mh">0x03FD</span><span class="p">,</span> <span class="mh">0x0082</span><span class="p">,</span> <span class="mh">0x0084</span><span class="p">,</span> <span class="mh">0x03FD</span><span class="p">,</span>
		<span class="mh">0x03FF</span><span class="p">,</span> <span class="mh">0x0053</span><span class="p">,</span> <span class="mh">0x00B3</span><span class="p">,</span> <span class="mh">0x03FB</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x002C</span><span class="p">,</span> <span class="mh">0x00DB</span><span class="p">,</span> <span class="mh">0x03F9</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x00F6</span><span class="p">,</span> <span class="mh">0x03FA</span>
	<span class="p">},</span>
	<span class="cm">/* For 4-phase 7-tap horizontal filter: */</span>
	<span class="cp">#define DUMMY 0</span>
	<span class="p">{</span>
		<span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">DUMMY</span><span class="p">,</span>
		<span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">DUMMY</span><span class="p">,</span>
		<span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">,</span> <span class="mh">0x003f</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">,</span> <span class="mh">0x003f</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">DUMMY</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">DUMMY</span>
	<span class="p">},</span>
	<span class="cm">/* For 4-phase 7-tap vertical filter: */</span>
	<span class="p">{</span>
		<span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0023</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">DUMMY</span><span class="p">,</span>
		<span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="n">DUMMY</span><span class="p">,</span>
		<span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">,</span> <span class="mh">0x003f</span><span class="p">,</span> <span class="mh">0x0062</span><span class="p">,</span> <span class="mh">0x003f</span><span class="p">,</span> <span class="mh">0x000f</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">DUMMY</span><span class="p">,</span>
		<span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0031</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="mh">0x004d</span><span class="p">,</span> <span class="mh">0x0018</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">DUMMY</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * The dummy padding is required in 7-tap mode because of how the</span>
<span class="cm">	 * registers are arranged physically.</span>
<span class="cm">	 */</span>
	<span class="cp">#undef DUMMY</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * __resizer_get_format - helper function for getting resizer format</span>
<span class="cm"> * @res   : pointer to resizer private structure</span>
<span class="cm"> * @pad   : pad number</span>
<span class="cm"> * @fh    : V4L2 subdev file handle</span>
<span class="cm"> * @which : wanted subdev format</span>
<span class="cm"> * return zero</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span>
<span class="nf">__resizer_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">pad</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * __resizer_get_crop - helper function for getting resizer crop rectangle</span>
<span class="cm"> * @res   : pointer to resizer private structure</span>
<span class="cm"> * @fh    : V4L2 subdev file handle</span>
<span class="cm"> * @which : wanted subdev crop rectangle</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span>
<span class="nf">__resizer_get_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		   <span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v4l2_subdev_get_try_crop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">RESZ_PAD_SINK</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_filters - Set resizer filters</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @h_coeff: horizontal coefficient</span>
<span class="cm"> * @v_coeff: vertical coefficient</span>
<span class="cm"> * Return none</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_filters</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">h_coeff</span><span class="p">,</span>
				<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">v_coeff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">startaddr_h</span><span class="p">,</span> <span class="n">startaddr_v</span><span class="p">,</span> <span class="n">tmp_h</span><span class="p">,</span> <span class="n">tmp_v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">startaddr_h</span> <span class="o">=</span> <span class="n">ISPRSZ_HFILT10</span><span class="p">;</span>
	<span class="n">startaddr_v</span> <span class="o">=</span> <span class="n">ISPRSZ_VFILT10</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">COEFF_CNT</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp_h</span> <span class="o">=</span> <span class="n">h_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">h_coeff</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_HFILT_COEF1_SHIFT</span><span class="p">);</span>
		<span class="n">tmp_v</span> <span class="o">=</span> <span class="n">v_coeff</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">v_coeff</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_VFILT_COEF1_SHIFT</span><span class="p">);</span>
		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">tmp_h</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">startaddr_h</span><span class="p">);</span>
		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">tmp_v</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">startaddr_v</span><span class="p">);</span>
		<span class="n">startaddr_h</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">startaddr_v</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_bilinear - Chrominance horizontal algorithm select</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @type: Filtering interpolation type.</span>
<span class="cm"> *</span>
<span class="cm"> * Filtering that is same as luminance processing is</span>
<span class="cm"> * intended only for downsampling, and bilinear interpolation</span>
<span class="cm"> * is intended only for upsampling.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_bilinear</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">resizer_chroma_algo</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RSZ_BILINEAR</span><span class="p">)</span>
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">,</span>
			    <span class="n">ISPRSZ_CNT_CBILIN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">,</span>
			    <span class="n">ISPRSZ_CNT_CBILIN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_ycpos - Luminance and chrominance order</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @order: order type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_ycpos</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">pixelcode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pixelcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_YUYV8_1X16</span>:
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">,</span>
			    <span class="n">ISPRSZ_CNT_YCPOS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_UYVY8_1X16</span>:
		<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">,</span>
			    <span class="n">ISPRSZ_CNT_YCPOS</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_phase - Setup horizontal and vertical starting phase</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @h_phase: horizontal phase parameters.</span>
<span class="cm"> * @v_phase: vertical phase parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * Horizontal and vertical phase range is 0 to 7</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_phase</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="n">h_phase</span><span class="p">,</span>
			      <span class="n">u32</span> <span class="n">v_phase</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rgval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rgval</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">)</span> <span class="o">&amp;</span>
	      <span class="o">~</span><span class="p">(</span><span class="n">ISPRSZ_CNT_HSTPH_MASK</span> <span class="o">|</span> <span class="n">ISPRSZ_CNT_VSTPH_MASK</span><span class="p">);</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">h_phase</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_CNT_HSTPH_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ISPRSZ_CNT_HSTPH_MASK</span><span class="p">;</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">v_phase</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_CNT_VSTPH_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ISPRSZ_CNT_VSTPH_MASK</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">rgval</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_luma - Setup luminance enhancer parameters</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @luma: Structure for luminance enhancer parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * Algorithm select:</span>
<span class="cm"> *  0x0: Disable</span>
<span class="cm"> *  0x1: [-1  2 -1]/2 high-pass filter</span>
<span class="cm"> *  0x2: [-1 -2  6 -2 -1]/4 high-pass filter</span>
<span class="cm"> *</span>
<span class="cm"> * Maximum gain:</span>
<span class="cm"> *  The data is coded in U4Q4 representation.</span>
<span class="cm"> *</span>
<span class="cm"> * Slope:</span>
<span class="cm"> *  The data is coded in U4Q4 representation.</span>
<span class="cm"> *</span>
<span class="cm"> * Coring offset:</span>
<span class="cm"> *  The data is coded in U8Q0 representation.</span>
<span class="cm"> *</span>
<span class="cm"> * The new luminance value is computed as:</span>
<span class="cm"> *  Y += HPF(Y) x max(GAIN, (HPF(Y) - CORE) x SLOP + 8) &gt;&gt; 4.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_luma</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">resizer_luma_yenh</span> <span class="o">*</span><span class="n">luma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rgval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rgval</span>  <span class="o">=</span> <span class="p">(</span><span class="n">luma</span><span class="o">-&gt;</span><span class="n">algo</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_YENH_ALGO_SHIFT</span><span class="p">)</span>
		  <span class="o">&amp;</span> <span class="n">ISPRSZ_YENH_ALGO_MASK</span><span class="p">;</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">luma</span><span class="o">-&gt;</span><span class="n">gain</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_YENH_GAIN_SHIFT</span><span class="p">)</span>
		  <span class="o">&amp;</span> <span class="n">ISPRSZ_YENH_GAIN_MASK</span><span class="p">;</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">luma</span><span class="o">-&gt;</span><span class="n">slope</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_YENH_SLOP_SHIFT</span><span class="p">)</span>
		  <span class="o">&amp;</span> <span class="n">ISPRSZ_YENH_SLOP_MASK</span><span class="p">;</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">luma</span><span class="o">-&gt;</span><span class="n">core</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_YENH_CORE_SHIFT</span><span class="p">)</span>
		  <span class="o">&amp;</span> <span class="n">ISPRSZ_YENH_CORE_MASK</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">rgval</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_YENH</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_source - Input source select</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @source: Input source type</span>
<span class="cm"> *</span>
<span class="cm"> * If this field is set to RESIZER_INPUT_VP, the resizer input is fed from</span>
<span class="cm"> * Preview/CCDC engine, otherwise from memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">resizer_input_entity</span> <span class="n">source</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">source</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_MEMORY</span><span class="p">)</span>
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">,</span>
			    <span class="n">ISPRSZ_CNT_INPSRC</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">,</span>
			    <span class="n">ISPRSZ_CNT_INPSRC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_ratio - Setup horizontal and vertical resizing value</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @ratio: Structure for ratio parameters.</span>
<span class="cm"> *</span>
<span class="cm"> * Resizing range from 64 to 1024</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_ratio</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">resizer_ratio</span> <span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">u16</span> <span class="o">*</span><span class="n">h_filter</span><span class="p">,</span> <span class="o">*</span><span class="n">v_filter</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rgval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rgval</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">)</span> <span class="o">&amp;</span>
			      <span class="o">~</span><span class="p">(</span><span class="n">ISPRSZ_CNT_HRSZ_MASK</span> <span class="o">|</span> <span class="n">ISPRSZ_CNT_VRSZ_MASK</span><span class="p">);</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_CNT_HRSZ_SHIFT</span><span class="p">)</span>
		  <span class="o">&amp;</span> <span class="n">ISPRSZ_CNT_HRSZ_MASK</span><span class="p">;</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">((</span><span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_CNT_VRSZ_SHIFT</span><span class="p">)</span>
		  <span class="o">&amp;</span> <span class="n">ISPRSZ_CNT_VRSZ_MASK</span><span class="p">;</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">rgval</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">);</span>

	<span class="cm">/* prepare horizontal filter coefficients */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span> <span class="o">&gt;</span> <span class="n">MID_RESIZE_VALUE</span><span class="p">)</span>
		<span class="n">h_filter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">filter_coefs</span><span class="p">.</span><span class="n">h_filter_coef_7tap</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">h_filter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">filter_coefs</span><span class="p">.</span><span class="n">h_filter_coef_4tap</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* prepare vertical filter coefficients */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span> <span class="o">&gt;</span> <span class="n">MID_RESIZE_VALUE</span><span class="p">)</span>
		<span class="n">v_filter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">filter_coefs</span><span class="p">.</span><span class="n">v_filter_coef_7tap</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">v_filter</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">filter_coefs</span><span class="p">.</span><span class="n">v_filter_coef_4tap</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">resizer_set_filters</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">h_filter</span><span class="p">,</span> <span class="n">v_filter</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_dst_size - Setup the output height and width</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @width: Output width.</span>
<span class="cm"> * @height: Output height.</span>
<span class="cm"> *</span>
<span class="cm"> * Width :</span>
<span class="cm"> *  The value must be EVEN.</span>
<span class="cm"> *</span>
<span class="cm"> * Height:</span>
<span class="cm"> *  The number of bytes written to SDRAM must be</span>
<span class="cm"> *  a multiple of 16-bytes if the vertical resizing factor</span>
<span class="cm"> *  is greater than 1x (upsizing)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_output_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rgval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Output size[w/h]: %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>
	<span class="n">rgval</span>  <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_OUT_SIZE_HORZ_SHIFT</span><span class="p">)</span>
		 <span class="o">&amp;</span> <span class="n">ISPRSZ_OUT_SIZE_HORZ_MASK</span><span class="p">;</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_OUT_SIZE_VERT_SHIFT</span><span class="p">)</span>
		 <span class="o">&amp;</span> <span class="n">ISPRSZ_OUT_SIZE_VERT_MASK</span><span class="p">;</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">rgval</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_OUT_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_output_offset - Setup memory offset for the output lines.</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @offset: Memory offset.</span>
<span class="cm"> *</span>
<span class="cm"> * The 5 LSBs are forced to be zeros by the hardware to align on a 32-byte</span>
<span class="cm"> * boundary; the 5 LSBs are read-only. For optimal use of SDRAM bandwidth,</span>
<span class="cm"> * the SDRAM line offset must be set on a 256-byte boundary</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_output_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_SDR_OUTOFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_start - Setup vertical and horizontal start position</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @left: Horizontal start position.</span>
<span class="cm"> * @top: Vertical start position.</span>
<span class="cm"> *</span>
<span class="cm"> * Vertical start line:</span>
<span class="cm"> *  This field makes sense only when the resizer obtains its input</span>
<span class="cm"> *  from the preview engine/CCDC</span>
<span class="cm"> *</span>
<span class="cm"> * Horizontal start pixel:</span>
<span class="cm"> *  Pixels are coded on 16 bits for YUV and 8 bits for color separate data.</span>
<span class="cm"> *  When the resizer gets its input from SDRAM, this field must be set</span>
<span class="cm"> *  to &lt;= 15 for YUV 16-bit data and &lt;= 31 for 8-bit color separate data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="n">left</span><span class="p">,</span> <span class="n">u32</span> <span class="n">top</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rgval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rgval</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_IN_START_HORZ_ST_SHIFT</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">ISPRSZ_IN_START_HORZ_ST_MASK</span><span class="p">;</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">top</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_IN_START_VERT_ST_SHIFT</span><span class="p">)</span>
		 <span class="o">&amp;</span> <span class="n">ISPRSZ_IN_START_VERT_ST_MASK</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">rgval</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_IN_START</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_input_size - Setup the input size</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @width: The range is 0 to 4095 pixels</span>
<span class="cm"> * @height: The range is 0 to 4095 lines</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_input_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">width</span><span class="p">,</span> <span class="n">u32</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">rgval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Input size[w/h]: %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">);</span>

	<span class="n">rgval</span> <span class="o">=</span> <span class="p">(</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_IN_SIZE_HORZ_SHIFT</span><span class="p">)</span>
		<span class="o">&amp;</span> <span class="n">ISPRSZ_IN_SIZE_HORZ_MASK</span><span class="p">;</span>
	<span class="n">rgval</span> <span class="o">|=</span> <span class="p">(</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_IN_SIZE_VERT_SHIFT</span><span class="p">)</span>
		 <span class="o">&amp;</span> <span class="n">ISPRSZ_IN_SIZE_VERT_MASK</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">rgval</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_IN_SIZE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_src_offs - Setup the memory offset for the input lines</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @offset: Memory offset.</span>
<span class="cm"> *</span>
<span class="cm"> * The 5 LSBs are forced to be zeros by the hardware to align on a 32-byte</span>
<span class="cm"> * boundary; the 5 LSBs are read-only. This field must be programmed to be</span>
<span class="cm"> * 0x0 if the resizer input is from preview engine/CCDC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_input_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_SDR_INOFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_intype - Input type select</span>
<span class="cm"> * @res: Device context.</span>
<span class="cm"> * @type: Pixel format type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_intype</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">resizer_colors_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">RSZ_COLOR8</span><span class="p">)</span>
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">,</span>
			    <span class="n">ISPRSZ_CNT_INPTYP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_CNT</span><span class="p">,</span>
			    <span class="n">ISPRSZ_CNT_INPTYP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * __resizer_set_inaddr - Helper function for set input address</span>
<span class="cm"> * @res : pointer to resizer private data structure</span>
<span class="cm"> * @addr: input address</span>
<span class="cm"> * return none</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__resizer_set_inaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_SDR_INADD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The data rate at the horizontal resizer output must not exceed half the</span>
<span class="cm"> * functional clock or 100 MP/s, whichever is lower. According to the TRM</span>
<span class="cm"> * there&#39;s no similar requirement for the vertical resizer output. However</span>
<span class="cm"> * experience showed that vertical upscaling by 4 leads to SBL overflows (with</span>
<span class="cm"> * data rates at the resizer output exceeding 300 MP/s). Limiting the resizer</span>
<span class="cm"> * output data rate to the functional clock or 200 MP/s, whichever is lower,</span>
<span class="cm"> * seems to get rid of SBL overflows.</span>
<span class="cm"> *</span>
<span class="cm"> * The maximum data rate at the output of the horizontal resizer can thus be</span>
<span class="cm"> * computed with</span>
<span class="cm"> *</span>
<span class="cm"> * max intermediate rate &lt;= L3 clock * input height / output height</span>
<span class="cm"> * max intermediate rate &lt;= L3 clock / 2</span>
<span class="cm"> *</span>
<span class="cm"> * The maximum data rate at the resizer input is then</span>
<span class="cm"> *</span>
<span class="cm"> * max input rate &lt;= max intermediate rate * input width / output width</span>
<span class="cm"> *</span>
<span class="cm"> * where the input width and height are the resizer input crop rectangle size.</span>
<span class="cm"> * The TRM doesn&#39;t clearly explain if that&#39;s a maximum instant data rate or a</span>
<span class="cm"> * maximum average data rate.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_resizer_max_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">max_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">ofmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">RESZ_PAD_SOURCE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">l3_ick</span><span class="p">,</span> <span class="mi">200000000UL</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">clock</span><span class="p">;</span>

	<span class="n">clock</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">limit</span> <span class="o">*</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">ofmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
	<span class="n">clock</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">clock</span><span class="p">,</span> <span class="n">limit</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="o">*</span><span class="n">max_rate</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">clock</span> <span class="o">*</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">ofmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When the resizer processes images from memory, the driver must slow down read</span>
<span class="cm"> * requests on the input to at least comply with the internal data rate</span>
<span class="cm"> * requirements. If the application real-time requirements can cope with slower</span>
<span class="cm"> * processing, the resizer can be slowed down even more to put less pressure on</span>
<span class="cm"> * the overall system.</span>
<span class="cm"> *</span>
<span class="cm"> * When the resizer processes images on the fly (either from the CCDC or the</span>
<span class="cm"> * preview module), the same data rate requirements apply but they can&#39;t be</span>
<span class="cm"> * enforced at the resizer level. The image input module (sensor, CCP2 or</span>
<span class="cm"> * preview module) must not provide image data faster than the resizer can</span>
<span class="cm"> * process.</span>
<span class="cm"> *</span>
<span class="cm"> * For live image pipelines, the data rate is set by the frame format, size and</span>
<span class="cm"> * rate. The sensor output frame rate must not exceed the maximum resizer data</span>
<span class="cm"> * rate.</span>
<span class="cm"> *</span>
<span class="cm"> * The resizer slows down read requests by inserting wait cycles in the SBL</span>
<span class="cm"> * requests. The maximum number of 256-byte requests per second can be computed</span>
<span class="cm"> * as (the data rate is multiplied by 2 to convert from pixels per second to</span>
<span class="cm"> * bytes per second)</span>
<span class="cm"> *</span>
<span class="cm"> * request per second = data rate * 2 / 256</span>
<span class="cm"> * cycles per request = cycles per second / requests per second</span>
<span class="cm"> *</span>
<span class="cm"> * The number of cycles per second is controlled by the L3 clock, leading to</span>
<span class="cm"> *</span>
<span class="cm"> * cycles per request = L3 frequency / 2 * 256 / data rate</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_adjust_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">l3_ick</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">l3_ick</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_fract</span> <span class="o">*</span><span class="n">timeperframe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cycles_per_frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">requests_per_frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cycles_per_request</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">granularity</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">minimum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">maximum</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">!=</span> <span class="n">RESIZER_INPUT_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span><span class="p">,</span> <span class="n">ISPSBL_SDR_REQ_EXP</span><span class="p">,</span>
			    <span class="n">ISPSBL_SDR_REQ_RSZ_EXP_MASK</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP_REVISION_1_0</span>:
	<span class="k">case</span> <span class="n">ISP_REVISION_2_0</span>:
	<span class="nl">default:</span>
		<span class="n">granularity</span> <span class="o">=</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_REVISION_15_0</span>:
		<span class="n">granularity</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Compute the minimum number of cycles per request, based on the</span>
<span class="cm">	 * pipeline maximum data rate. This is an absolute lower bound if we</span>
<span class="cm">	 * don&#39;t want SBL overflows, so round the value up.</span>
<span class="cm">	 */</span>
	<span class="n">cycles_per_request</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">l3_ick</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_rate</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
				     <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_rate</span><span class="p">);</span>
	<span class="n">minimum</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">cycles_per_request</span><span class="p">,</span> <span class="n">granularity</span><span class="p">);</span>

	<span class="cm">/* Compute the maximum number of cycles per request, based on the</span>
<span class="cm">	 * requested frame rate. This is a soft upper bound to achieve a frame</span>
<span class="cm">	 * rate equal or higher than the requested value, so round the value</span>
<span class="cm">	 * down.</span>
<span class="cm">	 */</span>
	<span class="n">timeperframe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_timeperframe</span><span class="p">;</span>

	<span class="n">requests_per_frame</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span>
			   <span class="o">*</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">cycles_per_frame</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">l3_ick</span> <span class="o">*</span> <span class="n">timeperframe</span><span class="o">-&gt;</span><span class="n">numerator</span><span class="p">,</span>
				   <span class="n">timeperframe</span><span class="o">-&gt;</span><span class="n">denominator</span><span class="p">);</span>
	<span class="n">cycles_per_request</span> <span class="o">=</span> <span class="n">cycles_per_frame</span> <span class="o">/</span> <span class="n">requests_per_frame</span><span class="p">;</span>

	<span class="n">maximum</span> <span class="o">=</span> <span class="n">cycles_per_request</span> <span class="o">/</span> <span class="n">granularity</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">minimum</span><span class="p">,</span> <span class="n">maximum</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: cycles per request = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span><span class="p">,</span> <span class="n">ISPSBL_SDR_REQ_EXP</span><span class="p">,</span>
			<span class="n">ISPSBL_SDR_REQ_RSZ_EXP_MASK</span><span class="p">,</span>
			<span class="n">value</span> <span class="o">&lt;&lt;</span> <span class="n">ISPSBL_SDR_REQ_RSZ_EXP_SHIFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_resizer_busy - Checks if ISP resizer is busy.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns busy field from ISPRSZ_PCR register.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_resizer_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_PCR</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">ISPRSZ_PCR_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_inaddr - Sets the memory address of the input frame.</span>
<span class="cm"> * @addr: 32bit memory address aligned on 32byte boundary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_inaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">addr_base</span> <span class="o">=</span> <span class="n">addr</span><span class="p">;</span>

	<span class="cm">/* This will handle crop settings in stream off state */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">crop_offset</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">+=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop_offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1f</span><span class="p">;</span>

	<span class="n">__resizer_set_inaddr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configures the memory address to which the output frame is written.</span>
<span class="cm"> * @addr: 32bit memory address aligned on 32byte boundary.</span>
<span class="cm"> * Note: For SBL efficiency reasons the address should be on a 256-byte</span>
<span class="cm"> * boundary.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_outaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set output address. This needs to be in its own function</span>
<span class="cm">	 * because it changes often.</span>
<span class="cm">	 */</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&lt;&lt;</span> <span class="n">ISPRSZ_SDR_OUTADD_ADDR_SHIFT</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_SDR_OUTADD</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_print_status - Prints the values of the resizer module registers.</span>
<span class="cm"> */</span>
<span class="cp">#define RSZ_PRINT_REGISTER(isp, name)\</span>
<span class="cp">	dev_dbg(isp-&gt;dev, &quot;###RSZ &quot; #name &quot;=0x%08x\n&quot;, \</span>
<span class="cp">		isp_reg_readl(isp, OMAP3_ISP_IOMEM_RESZ, ISPRSZ_##name))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_print_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-------------Resizer Register dump----------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">PCR</span><span class="p">);</span>
	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">CNT</span><span class="p">);</span>
	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OUT_SIZE</span><span class="p">);</span>
	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">IN_START</span><span class="p">);</span>
	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">IN_SIZE</span><span class="p">);</span>
	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SDR_INADD</span><span class="p">);</span>
	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SDR_INOFF</span><span class="p">);</span>
	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SDR_OUTADD</span><span class="p">);</span>
	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SDR_OUTOFF</span><span class="p">);</span>
	<span class="n">RSZ_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">YENH</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;--------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_calc_ratios - Helper function for calculate resizer ratios</span>
<span class="cm"> * @res: pointer to resizer private data structure</span>
<span class="cm"> * @input: input frame size</span>
<span class="cm"> * @output: output frame size</span>
<span class="cm"> * @ratio : return calculated ratios</span>
<span class="cm"> * return none</span>
<span class="cm"> *</span>
<span class="cm"> * The resizer uses a polyphase sample rate converter. The upsampling filter</span>
<span class="cm"> * has a fixed number of phases that depend on the resizing ratio. As the ratio</span>
<span class="cm"> * computation depends on the number of phases, we need to compute a first</span>
<span class="cm"> * approximation and then refine it.</span>
<span class="cm"> *</span>
<span class="cm"> * The input/output/ratio relationship is given by the OMAP34xx TRM:</span>
<span class="cm"> *</span>
<span class="cm"> * - 8-phase, 4-tap mode (RSZ = 64 ~ 512)</span>
<span class="cm"> *	iw = (32 * sph + (ow - 1) * hrsz + 16) &gt;&gt; 8 + 7</span>
<span class="cm"> *	ih = (32 * spv + (oh - 1) * vrsz + 16) &gt;&gt; 8 + 4</span>
<span class="cm"> * - 4-phase, 7-tap mode (RSZ = 513 ~ 1024)</span>
<span class="cm"> *	iw = (64 * sph + (ow - 1) * hrsz + 32) &gt;&gt; 8 + 7</span>
<span class="cm"> *	ih = (64 * spv + (oh - 1) * vrsz + 32) &gt;&gt; 8 + 7</span>
<span class="cm"> *</span>
<span class="cm"> * iw and ih are the input width and height after cropping. Those equations need</span>
<span class="cm"> * to be satisfied exactly for the resizer to work correctly.</span>
<span class="cm"> *</span>
<span class="cm"> * The equations can&#39;t be easily reverted, as the &gt;&gt; 8 operation is not linear.</span>
<span class="cm"> * In addition, not all input sizes can be achieved for a given output size. To</span>
<span class="cm"> * get the highest input size lower than or equal to the requested input size,</span>
<span class="cm"> * we need to compute the highest resizing ratio that satisfies the following</span>
<span class="cm"> * inequality (taking the 4-tap mode width equation as an example)</span>
<span class="cm"> *</span>
<span class="cm"> *	iw &gt;= (32 * sph + (ow - 1) * hrsz + 16) &gt;&gt; 8 - 7</span>
<span class="cm"> *</span>
<span class="cm"> * (where iw is the requested input width) which can be rewritten as</span>
<span class="cm"> *</span>
<span class="cm"> *	  iw - 7            &gt;= (32 * sph + (ow - 1) * hrsz + 16) &gt;&gt; 8</span>
<span class="cm"> *	 (iw - 7) &lt;&lt; 8      &gt;=  32 * sph + (ow - 1) * hrsz + 16 - b</span>
<span class="cm"> *	((iw - 7) &lt;&lt; 8) + b &gt;=  32 * sph + (ow - 1) * hrsz + 16</span>
<span class="cm"> *</span>
<span class="cm"> * where b is the value of the 8 least significant bits of the right hand side</span>
<span class="cm"> * expression of the last inequality. The highest resizing ratio value will be</span>
<span class="cm"> * achieved when b is equal to its maximum value of 255. That resizing ratio</span>
<span class="cm"> * value will still satisfy the original inequality, as b will disappear when</span>
<span class="cm"> * the expression will be shifted right by 8.</span>
<span class="cm"> *</span>
<span class="cm"> * The reverted the equations thus become</span>
<span class="cm"> *</span>
<span class="cm"> * - 8-phase, 4-tap mode</span>
<span class="cm"> *	hrsz = ((iw - 7) * 256 + 255 - 16 - 32 * sph) / (ow - 1)</span>
<span class="cm"> *	vrsz = ((ih - 4) * 256 + 255 - 16 - 32 * spv) / (oh - 1)</span>
<span class="cm"> * - 4-phase, 7-tap mode</span>
<span class="cm"> *	hrsz = ((iw - 7) * 256 + 255 - 32 - 64 * sph) / (ow - 1)</span>
<span class="cm"> *	vrsz = ((ih - 7) * 256 + 255 - 32 - 64 * spv) / (oh - 1)</span>
<span class="cm"> *</span>
<span class="cm"> * The ratios are integer values, and are rounded down to ensure that the</span>
<span class="cm"> * cropped input size is not bigger than the uncropped input size.</span>
<span class="cm"> *</span>
<span class="cm"> * As the number of phases/taps, used to select the correct equations to compute</span>
<span class="cm"> * the ratio, depends on the ratio, we start with the 4-tap mode equations to</span>
<span class="cm"> * compute an approximation of the ratio, and switch to the 7-tap mode equations</span>
<span class="cm"> * if the approximation is higher than the ratio threshold.</span>
<span class="cm"> *</span>
<span class="cm"> * As the 7-tap mode equations will return a ratio smaller than or equal to the</span>
<span class="cm"> * 4-tap mode equations, the resulting ratio could become lower than or equal to</span>
<span class="cm"> * the ratio threshold. This &#39;equations loop&#39; isn&#39;t an issue as long as the</span>
<span class="cm"> * correct equations are used to compute the final input size. Starting with the</span>
<span class="cm"> * 4-tap mode equations ensure that, in case of values resulting in a &#39;ratio</span>
<span class="cm"> * loop&#39;, the smallest of the ratio values will be used, never exceeding the</span>
<span class="cm"> * requested input size.</span>
<span class="cm"> *</span>
<span class="cm"> * We first clamp the output size according to the hardware capabilitie to avoid</span>
<span class="cm"> * auto-cropping the input more than required to satisfy the TRM equations. The</span>
<span class="cm"> * minimum output size is achieved with a scaling factor of 1024. It is thus</span>
<span class="cm"> * computed using the 7-tap equations.</span>
<span class="cm"> *</span>
<span class="cm"> *	min ow = ((iw - 7) * 256 - 32 - 64 * sph) / 1024 + 1</span>
<span class="cm"> *	min oh = ((ih - 7) * 256 - 32 - 64 * spv) / 1024 + 1</span>
<span class="cm"> *</span>
<span class="cm"> * Similarly, the maximum output size is achieved with a scaling factor of 64</span>
<span class="cm"> * and computed using the 4-tap equations.</span>
<span class="cm"> *</span>
<span class="cm"> *	max ow = ((iw - 7) * 256 + 255 - 16 - 32 * sph) / 64 + 1</span>
<span class="cm"> *	max oh = ((ih - 4) * 256 + 255 - 16 - 32 * spv) / 64 + 1</span>
<span class="cm"> *</span>
<span class="cm"> * The additional +255 term compensates for the round down operation performed</span>
<span class="cm"> * by the TRM equations when shifting the value right by 8 bits.</span>
<span class="cm"> *</span>
<span class="cm"> * We then compute and clamp the ratios (x1/4 ~ x4). Clamping the output size to</span>
<span class="cm"> * the maximum value guarantees that the ratio value will never be smaller than</span>
<span class="cm"> * the minimum, but it could still slightly exceed the maximum. Clamping the</span>
<span class="cm"> * ratio will thus result in a resizing factor slightly larger than the</span>
<span class="cm"> * requested value.</span>
<span class="cm"> *</span>
<span class="cm"> * To accommodate that, and make sure the TRM equations are satisfied exactly, we</span>
<span class="cm"> * compute the input crop rectangle as the last step.</span>
<span class="cm"> *</span>
<span class="cm"> * As if the situation wasn&#39;t complex enough, the maximum output width depends</span>
<span class="cm"> * on the vertical resizing ratio.  Fortunately, the output height doesn&#39;t</span>
<span class="cm"> * depend on the horizontal resizing ratio. We can then start by computing the</span>
<span class="cm"> * output height and the vertical ratio, and then move to computing the output</span>
<span class="cm"> * width and the horizontal ratio.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_calc_ratios</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">output</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">resizer_ratio</span> <span class="o">*</span><span class="n">ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spv</span> <span class="o">=</span> <span class="n">DEFAULT_PHASE</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sph</span> <span class="o">=</span> <span class="n">DEFAULT_PHASE</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">upscaled_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">upscaled_height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width_alignment</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clamp the output height based on the hardware capabilities and</span>
<span class="cm">	 * compute the vertical resizing ratio.</span>
<span class="cm">	 */</span>
	<span class="n">min_height</span> <span class="o">=</span> <span class="p">((</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">spv</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">min_height</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">min_height</span><span class="p">,</span> <span class="n">MIN_OUT_HEIGHT</span><span class="p">);</span>
	<span class="n">max_height</span> <span class="o">=</span> <span class="p">((</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">spv</span><span class="p">)</span> <span class="o">/</span> <span class="mi">64</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">max_height</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">max_height</span><span class="p">,</span> <span class="n">MAX_OUT_HEIGHT</span><span class="p">);</span>
	<span class="n">output</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">min_height</span><span class="p">,</span> <span class="n">max_height</span><span class="p">);</span>

	<span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span> <span class="o">=</span> <span class="p">((</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">spv</span><span class="p">)</span>
		    <span class="o">/</span> <span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span> <span class="o">&gt;</span> <span class="n">MID_RESIZE_VALUE</span><span class="p">)</span>
		<span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span> <span class="o">=</span> <span class="p">((</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">spv</span><span class="p">)</span>
			    <span class="o">/</span> <span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span><span class="p">,</span>
			      <span class="n">MIN_RESIZE_VALUE</span><span class="p">,</span> <span class="n">MAX_RESIZE_VALUE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span> <span class="o">&lt;=</span> <span class="n">MID_RESIZE_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">upscaled_height</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span>
				<span class="o">+</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">spv</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">upscaled_height</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">upscaled_height</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span>
				<span class="o">+</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">spv</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">upscaled_height</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compute the minimum and maximum output widths based on the hardware</span>
<span class="cm">	 * capabilities. The maximum depends on the vertical resizing ratio.</span>
<span class="cm">	 */</span>
	<span class="n">min_width</span> <span class="o">=</span> <span class="p">((</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">sph</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">min_width</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">min_width</span><span class="p">,</span> <span class="n">MIN_OUT_WIDTH</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span> <span class="o">&lt;=</span> <span class="n">MID_RESIZE_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISP_REVISION_1_0</span>:
			<span class="n">max_width</span> <span class="o">=</span> <span class="n">MAX_4TAP_OUT_WIDTH_ES1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISP_REVISION_2_0</span>:
		<span class="nl">default:</span>
			<span class="n">max_width</span> <span class="o">=</span> <span class="n">MAX_4TAP_OUT_WIDTH_ES2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISP_REVISION_15_0</span>:
			<span class="n">max_width</span> <span class="o">=</span> <span class="n">MAX_4TAP_OUT_WIDTH_3630</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISP_REVISION_1_0</span>:
			<span class="n">max_width</span> <span class="o">=</span> <span class="n">MAX_7TAP_OUT_WIDTH_ES1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISP_REVISION_2_0</span>:
		<span class="nl">default:</span>
			<span class="n">max_width</span> <span class="o">=</span> <span class="n">MAX_7TAP_OUT_WIDTH_ES2</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISP_REVISION_15_0</span>:
			<span class="n">max_width</span> <span class="o">=</span> <span class="n">MAX_7TAP_OUT_WIDTH_3630</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">max_width</span> <span class="o">=</span> <span class="n">min</span><span class="p">(((</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">sph</span><span class="p">)</span> <span class="o">/</span> <span class="mi">64</span>
			<span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_width</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The output width must be even, and must be a multiple of 16 bytes</span>
<span class="cm">	 * when upscaling vertically. Clamp the output width to the valid range.</span>
<span class="cm">	 * Take the alignment into account (the maximum width in 7-tap mode on</span>
<span class="cm">	 * ES2 isn&#39;t a multiple of 8) and align the result up to make sure it</span>
<span class="cm">	 * won&#39;t be smaller than the minimum.</span>
<span class="cm">	 */</span>
	<span class="n">width_alignment</span> <span class="o">=</span> <span class="n">ratio</span><span class="o">-&gt;</span><span class="n">vert</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">output</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">min_width</span><span class="p">,</span>
			      <span class="n">max_width</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">width_alignment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">output</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">width_alignment</span><span class="p">);</span>

	<span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span> <span class="o">=</span> <span class="p">((</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">16</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">sph</span><span class="p">)</span>
		    <span class="o">/</span> <span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span> <span class="o">&gt;</span> <span class="n">MID_RESIZE_VALUE</span><span class="p">)</span>
		<span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span> <span class="o">=</span> <span class="p">((</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span> <span class="o">*</span> <span class="mi">256</span> <span class="o">+</span> <span class="mi">255</span> <span class="o">-</span> <span class="mi">32</span> <span class="o">-</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">sph</span><span class="p">)</span>
			    <span class="o">/</span> <span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span><span class="p">,</span>
			      <span class="n">MIN_RESIZE_VALUE</span><span class="p">,</span> <span class="n">MAX_RESIZE_VALUE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span> <span class="o">&lt;=</span> <span class="n">MID_RESIZE_VALUE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">upscaled_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span>
			       <span class="o">+</span> <span class="mi">32</span> <span class="o">*</span> <span class="n">sph</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">upscaled_width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">upscaled_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">ratio</span><span class="o">-&gt;</span><span class="n">horz</span>
			       <span class="o">+</span> <span class="mi">64</span> <span class="o">*</span> <span class="n">sph</span> <span class="o">+</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">upscaled_width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Center the new crop rectangle. */</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+=</span> <span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+=</span> <span class="p">(</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
	<span class="n">input</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_crop_params - Setup hardware with cropping parameters</span>
<span class="cm"> * @res : resizer private structure</span>
<span class="cm"> * @crop_rect : current crop rectangle</span>
<span class="cm"> * @ratio : resizer ratios</span>
<span class="cm"> * return none</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_set_crop_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">input</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">output</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">resizer_set_ratio</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ratio</span><span class="p">);</span>

	<span class="cm">/* Set chrominance horizontal algorithm */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ratio</span><span class="p">.</span><span class="n">horz</span> <span class="o">&gt;=</span> <span class="n">RESIZE_DIVISOR</span><span class="p">)</span>
		<span class="n">resizer_set_bilinear</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">RSZ_THE_SAME</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">resizer_set_bilinear</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">RSZ_BILINEAR</span><span class="p">);</span>

	<span class="n">resizer_adjust_bandwidth</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Calculate additional offset for crop */</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">crop_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">top</span> <span class="o">*</span> <span class="n">input</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">+</span>
				    <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">left</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Write lowest 4 bits of horizontal pixel offset (in pixels),</span>
<span class="cm">		 * vertical start must be 0.</span>
<span class="cm">		 */</span>
		<span class="n">resizer_set_start</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">crop_offset</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Set start (read) address for cropping, in bytes.</span>
<span class="cm">		 * Lowest 5 bits must be zero.</span>
<span class="cm">		 */</span>
		<span class="n">__resizer_set_inaddr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">addr_base</span> <span class="o">+</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">crop_offset</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1f</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set vertical start line and horizontal starting pixel.</span>
<span class="cm">		 * If the input is from CCDC/PREV, horizontal start field is</span>
<span class="cm">		 * in bytes (twice number of pixels).</span>
<span class="cm">		 */</span>
		<span class="n">resizer_set_start</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">left</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span>
				  <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">top</span><span class="p">);</span>
		<span class="cm">/* Input address and offset must be 0 for preview/ccdc input */</span>
		<span class="n">__resizer_set_inaddr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">resizer_set_input_offset</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set the input size */</span>
	<span class="n">resizer_set_input_size</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			       <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">informat</span><span class="p">,</span> <span class="o">*</span><span class="n">outformat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resizer_luma_yenh</span> <span class="n">luma</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="n">resizer_set_source</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>

	<span class="n">informat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">RESZ_PAD_SINK</span><span class="p">];</span>
	<span class="n">outformat</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">RESZ_PAD_SOURCE</span><span class="p">];</span>

	<span class="cm">/* RESZ_PAD_SINK */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_VP</span><span class="p">)</span>
		<span class="n">resizer_set_input_offset</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">resizer_set_input_offset</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">informat</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* YUV422 interleaved, default phase, no luma enhancement */</span>
	<span class="n">resizer_set_intype</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">RSZ_YUV422</span><span class="p">);</span>
	<span class="n">resizer_set_ycpos</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">informat</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
	<span class="n">resizer_set_phase</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">DEFAULT_PHASE</span><span class="p">,</span> <span class="n">DEFAULT_PHASE</span><span class="p">);</span>
	<span class="n">resizer_set_luma</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">luma</span><span class="p">);</span>

	<span class="cm">/* RESZ_PAD_SOURCE */</span>
	<span class="n">resizer_set_output_offset</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">ALIGN</span><span class="p">(</span><span class="n">outformat</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">32</span><span class="p">));</span>
	<span class="n">resizer_set_output_size</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">outformat</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">outformat</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">resizer_set_crop_params</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">informat</span><span class="p">,</span> <span class="n">outformat</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Interrupt handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_enable_oneshot</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span><span class="p">,</span> <span class="n">ISPRSZ_PCR</span><span class="p">,</span>
		    <span class="n">ISPRSZ_PCR_ENABLE</span> <span class="o">|</span> <span class="n">ISPRSZ_PCR_ONESHOT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3isp_resizer_isr_frame_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * If ISP_VIDEO_DMAQUEUE_QUEUED is set, DMA queue had an underrun</span>
<span class="cm">	 * condition, the module was paused and now we have a buffer queued</span>
<span class="cm">	 * on the output again. Restart the pipeline if running in continuous</span>
<span class="cm">	 * mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_CONTINUOUS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">dmaqueue_flags</span> <span class="o">&amp;</span> <span class="n">ISP_VIDEO_DMAQUEUE_QUEUED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resizer_enable_oneshot</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="n">isp_video_dmaqueue_flags_clr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_isr_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Complete the output buffer and, if reading from memory, the input</span>
<span class="cm">	 * buffer.</span>
<span class="cm">	 */</span>
	<span class="n">buffer</span> <span class="o">=</span> <span class="n">omap3isp_video_buffer_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resizer_set_outaddr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>
		<span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">ISP_PIPELINE_IDLE_OUTPUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buffer</span> <span class="o">=</span> <span class="n">omap3isp_video_buffer_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">resizer_set_inaddr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">ISP_PIPELINE_IDLE_INPUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp_pipeline_ready</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">omap3isp_pipeline_set_stream</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span>
						<span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* If an underrun occurs, the video queue operation handler will</span>
<span class="cm">		 * restart the resizer. Otherwise restart it immediately.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span>
			<span class="n">resizer_enable_oneshot</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_resizer_isr - ISP resizer interrupt handler</span>
<span class="cm"> *</span>
<span class="cm"> * Manage the resizer video buffers and configure shadowed and busy-locked</span>
<span class="cm"> * registers.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_resizer_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">informat</span><span class="p">,</span> <span class="o">*</span><span class="n">outformat</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_module_sync_is_stopping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">applycrop</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outformat</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">RESZ_PAD_SOURCE</span><span class="p">,</span>
					      <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">);</span>
		<span class="n">informat</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">RESZ_PAD_SINK</span><span class="p">,</span>
					      <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">);</span>
		<span class="n">resizer_set_crop_params</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">informat</span><span class="p">,</span> <span class="n">outformat</span><span class="p">);</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">applycrop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">resizer_isr_buffer</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * ISP video operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_video_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_video</span> <span class="o">*</span><span class="n">video</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">isp_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span>
		<span class="n">resizer_set_inaddr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We now have a buffer queued on the output. Despite what the</span>
<span class="cm">	 * TRM says, the resizer can&#39;t be restarted immediately.</span>
<span class="cm">	 * Enabling it in one shot mode in the middle of a frame (or at</span>
<span class="cm">	 * least asynchronously to the frame) results in the output</span>
<span class="cm">	 * being shifted randomly left/right and up/down, as if the</span>
<span class="cm">	 * hardware didn&#39;t synchronize itself to the beginning of the</span>
<span class="cm">	 * frame correctly.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Restart the resizer on the next sync interrupt if running in</span>
<span class="cm">	 * continuous mode or when starting the stream.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="n">resizer_set_outaddr</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">isp_video_operations</span> <span class="n">resizer_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">resizer_video_queue</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * V4L2 subdev operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_stream - Enable/Disable streaming on resizer subdev</span>
<span class="cm"> * @sd: ISP resizer V4L2 subdev</span>
<span class="cm"> * @enable: 1 == Enable, 0 == Disable</span>
<span class="cm"> *</span>
<span class="cm"> * The resizer hardware can&#39;t be enabled without a memory buffer to write to.</span>
<span class="cm"> * As the s_stream operation is called in response to a STREAMON call without</span>
<span class="cm"> * any buffer queued yet, just update the state field and return immediately.</span>
<span class="cm"> * The resizer will be enabled in resizer_video_queue().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_set_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_video</span> <span class="o">*</span><span class="n">video_out</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">omap3isp_subclk_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SUBCLK_RESIZER</span><span class="p">);</span>
		<span class="n">resizer_configure</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="n">resizer_print_status</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_CONTINUOUS</span>:
		<span class="n">omap3isp_sbl_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_RESIZER_WRITE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_out</span><span class="o">-&gt;</span><span class="n">dmaqueue_flags</span> <span class="o">&amp;</span> <span class="n">ISP_VIDEO_DMAQUEUE_QUEUED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">resizer_enable_oneshot</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
			<span class="n">isp_video_dmaqueue_flags_clr</span><span class="p">(</span><span class="n">video_out</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_MEMORY</span><span class="p">)</span>
			<span class="n">omap3isp_sbl_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_RESIZER_READ</span><span class="p">);</span>
		<span class="n">omap3isp_sbl_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_RESIZER_WRITE</span><span class="p">);</span>

		<span class="n">resizer_enable_oneshot</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_module_sync_idle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: module stop timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">omap3isp_sbl_disable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_RESIZER_READ</span> <span class="o">|</span>
				<span class="n">OMAP3_ISP_SBL_RESIZER_WRITE</span><span class="p">);</span>
		<span class="n">omap3isp_subclk_disable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SUBCLK_RESIZER</span><span class="p">);</span>
		<span class="n">isp_video_dmaqueue_flags_clr</span><span class="p">(</span><span class="n">video_out</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_try_crop - mangles crop parameters.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_try_crop</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">sink</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">spv</span> <span class="o">=</span> <span class="n">DEFAULT_PHASE</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sph</span> <span class="o">=</span> <span class="n">DEFAULT_PHASE</span><span class="p">;</span>

	<span class="cm">/* Crop rectangle is constrained by the output size so that zoom ratio</span>
<span class="cm">	 * cannot exceed +/-4.0.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_width</span> <span class="o">=</span>
		<span class="p">((</span><span class="mi">32</span> <span class="o">*</span> <span class="n">sph</span> <span class="o">+</span> <span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_height</span> <span class="o">=</span>
		<span class="p">((</span><span class="mi">32</span> <span class="o">*</span> <span class="n">spv</span> <span class="o">+</span> <span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">64</span> <span class="o">+</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_width</span> <span class="o">=</span>
		<span class="p">((</span><span class="mi">64</span> <span class="o">*</span> <span class="n">sph</span> <span class="o">+</span> <span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_height</span> <span class="o">=</span>
		<span class="p">((</span><span class="mi">64</span> <span class="o">*</span> <span class="n">spv</span> <span class="o">+</span> <span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span> <span class="o">+</span> <span class="mi">32</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="mi">7</span><span class="p">;</span>

	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">min_width</span><span class="p">,</span> <span class="n">max_width</span><span class="p">);</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">min_height</span><span class="p">,</span> <span class="n">max_height</span><span class="p">);</span>

	<span class="cm">/* Crop can not go beyond of the input rectangle */</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">MIN_IN_WIDTH</span><span class="p">);</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">MIN_IN_WIDTH</span><span class="p">,</span>
			      <span class="n">sink</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">);</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">MIN_IN_HEIGHT</span><span class="p">);</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">MIN_IN_HEIGHT</span><span class="p">,</span>
			       <span class="n">sink</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_get_selection - Retrieve a selection rectangle on a pad</span>
<span class="cm"> * @sd: ISP resizer V4L2 subdevice</span>
<span class="cm"> * @fh: V4L2 subdev file handle</span>
<span class="cm"> * @sel: Selection rectangle</span>
<span class="cm"> *</span>
<span class="cm"> * The only supported rectangles are the crop rectangles on the sink pad.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_get_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format_source</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format_sink</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resizer_ratio</span> <span class="n">ratio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">!=</span> <span class="n">RESZ_PAD_SINK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format_sink</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESZ_PAD_SINK</span><span class="p">,</span>
					   <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="n">format_source</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESZ_PAD_SOURCE</span><span class="p">,</span>
					     <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_BOUNDS</span>:
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>

		<span class="n">resizer_try_crop</span><span class="p">(</span><span class="n">format_sink</span><span class="p">,</span> <span class="n">format_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">);</span>
		<span class="n">resizer_calc_ratios</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">,</span> <span class="n">format_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ratio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span>:
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">__resizer_get_crop</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="n">resizer_calc_ratios</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">,</span> <span class="n">format_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ratio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_selection - Set a selection rectangle on a pad</span>
<span class="cm"> * @sd: ISP resizer V4L2 subdevice</span>
<span class="cm"> * @fh: V4L2 subdev file handle</span>
<span class="cm"> * @sel: Selection rectangle</span>
<span class="cm"> *</span>
<span class="cm"> * The only supported rectangle is the actual crop rectangle on the sink pad.</span>
<span class="cm"> *</span>
<span class="cm"> * FIXME: This function currently behaves as if the KEEP_CONFIG selection flag</span>
<span class="cm"> * was always set.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_set_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format_sink</span><span class="p">,</span> <span class="o">*</span><span class="n">format_source</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resizer_ratio</span> <span class="n">ratio</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">!=</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span> <span class="o">||</span>
	    <span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">!=</span> <span class="n">RESZ_PAD_SINK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format_sink</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESZ_PAD_SINK</span><span class="p">,</span>
					   <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="n">format_source</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESZ_PAD_SOURCE</span><span class="p">,</span>
					     <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: L=%d,T=%d,W=%d,H=%d,which=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: input=%dx%d, output=%dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">format_sink</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">format_sink</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
		<span class="n">format_source</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">format_source</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="cm">/* Clamp the crop rectangle to the bounds, and then mangle it further to</span>
<span class="cm">	 * fulfill the TRM equations. Store the clamped but otherwise unmangled</span>
<span class="cm">	 * rectangle to avoid cropping the input multiple times: when an</span>
<span class="cm">	 * application sets the output format, the current crop rectangle is</span>
<span class="cm">	 * mangled during crop rectangle computation, which would lead to a new,</span>
<span class="cm">	 * smaller input crop rectangle every time the output size is set if we</span>
<span class="cm">	 * stored the mangled rectangle.</span>
<span class="cm">	 */</span>
	<span class="n">resizer_try_crop</span><span class="p">(</span><span class="n">format_sink</span><span class="p">,</span> <span class="n">format_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">);</span>
	<span class="o">*</span><span class="n">__resizer_get_crop</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">)</span> <span class="o">=</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">;</span>
	<span class="n">resizer_calc_ratios</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">,</span> <span class="n">format_source</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ratio</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">ratio</span> <span class="o">=</span> <span class="n">ratio</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * set_selection can be called while streaming is on. In this case the</span>
<span class="cm">	 * crop values will be set in the next IRQ.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">applycrop</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* resizer pixel formats */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resizer_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">V4L2_MBUS_FMT_UYVY8_1X16</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_YUYV8_1X16</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">resizer_max_in_width</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_MEMORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">MAX_IN_WIDTH_MEMORY_MODE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_1_0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">MAX_IN_WIDTH_ONTHEFLY_MODE_ES1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">MAX_IN_WIDTH_ONTHEFLY_MODE_ES2</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_try_format - Handle try format by pad subdev method</span>
<span class="cm"> * @res   : ISP resizer device</span>
<span class="cm"> * @fh    : V4L2 subdev file handle</span>
<span class="cm"> * @pad   : pad num</span>
<span class="cm"> * @fmt   : pointer to v4l2 format structure</span>
<span class="cm"> * @which : wanted subdev format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">resizer_try_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resizer_ratio</span> <span class="n">ratio</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">crop</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RESZ_PAD_SINK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_YUYV8_1X16</span> <span class="o">&amp;&amp;</span>
		    <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_UYVY8_1X16</span><span class="p">)</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_YUYV8_1X16</span><span class="p">;</span>

		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">MIN_IN_WIDTH</span><span class="p">,</span>
				     <span class="n">resizer_max_in_width</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">MIN_IN_HEIGHT</span><span class="p">,</span>
				      <span class="n">MAX_IN_HEIGHT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RESZ_PAD_SOURCE</span>:
		<span class="n">format</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESZ_PAD_SINK</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>

		<span class="n">crop</span> <span class="o">=</span> <span class="o">*</span><span class="n">__resizer_get_crop</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>
		<span class="n">resizer_calc_ratios</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crop</span><span class="p">,</span> <span class="n">fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ratio</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_JPEG</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_enum_mbus_code - Handle pixel format enumeration</span>
<span class="cm"> * @sd     : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh     : V4L2 subdev file handle</span>
<span class="cm"> * @code   : pointer to v4l2_subdev_mbus_code_enum structure</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_enum_mbus_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_subdev_mbus_code_enum</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">RESZ_PAD_SINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">resizer_formats</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">resizer_formats</span><span class="p">[</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">format</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESZ_PAD_SINK</span><span class="p">,</span>
					      <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
		<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_enum_frame_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_subdev_frame_size_enum</span> <span class="o">*</span><span class="n">fse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fse</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">resizer_try_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_width</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_height</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">resizer_try_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_width</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_height</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_get_format - Handle get format by pads subdev method</span>
<span class="cm"> * @sd    : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh    : V4L2 subdev file handle</span>
<span class="cm"> * @fmt   : pointer to v4l2 subdev format structure</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_set_format - Handle set format by pads subdev method</span>
<span class="cm"> * @sd    : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh    : V4L2 subdev file handle</span>
<span class="cm"> * @fmt   : pointer to v4l2 subdev format structure</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">resizer_try_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">RESZ_PAD_SINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* reset crop rectangle */</span>
		<span class="n">crop</span> <span class="o">=</span> <span class="n">__resizer_get_crop</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

		<span class="cm">/* Propagate the format from sink to source */</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">__resizer_get_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESZ_PAD_SOURCE</span><span class="p">,</span>
					      <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
		<span class="n">resizer_try_format</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">RESZ_PAD_SOURCE</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span>
				   <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Compute and store the active crop rectangle and resizer</span>
<span class="cm">		 * ratios. format already points to the source pad active</span>
<span class="cm">		 * format.</span>
<span class="cm">		 */</span>
		<span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>
		<span class="n">resizer_calc_ratios</span><span class="p">(</span><span class="n">res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">.</span><span class="n">active</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">ratio</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_init_formats - Initialize formats on all pads</span>
<span class="cm"> * @sd: ISP resizer V4L2 subdevice</span>
<span class="cm"> * @fh: V4L2 subdev file handle</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize all pad formats with default values. If fh is not NULL, try</span>
<span class="cm"> * formats are initialized on the file handle. Otherwise active formats are</span>
<span class="cm"> * initialized on the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_init_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="n">format</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">));</span>
	<span class="n">format</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">RESZ_PAD_SINK</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">which</span> <span class="o">=</span> <span class="n">fh</span> <span class="o">?</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span> <span class="o">:</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_YUYV8_1X16</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">resizer_set_format</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* subdev video operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">resizer_v4l2_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span> <span class="o">=</span> <span class="n">resizer_set_stream</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* subdev pad operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_pad_ops</span> <span class="n">resizer_v4l2_pad_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enum_mbus_code</span> <span class="o">=</span> <span class="n">resizer_enum_mbus_code</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_frame_size</span> <span class="o">=</span> <span class="n">resizer_enum_frame_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fmt</span> <span class="o">=</span> <span class="n">resizer_get_format</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span> <span class="o">=</span> <span class="n">resizer_set_format</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_selection</span> <span class="o">=</span> <span class="n">resizer_get_selection</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_selection</span> <span class="o">=</span> <span class="n">resizer_set_selection</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* subdev operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">resizer_v4l2_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resizer_v4l2_video_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resizer_v4l2_pad_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* subdev internal operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_internal_ops</span> <span class="n">resizer_v4l2_internal_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">resizer_init_formats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Media entity operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_link_setup - Setup resizer connections.</span>
<span class="cm"> * @entity : Pointer to media entity structure</span>
<span class="cm"> * @local  : Pointer to local pad array</span>
<span class="cm"> * @remote : Pointer to remote pad array</span>
<span class="cm"> * @flags  : Link flags</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_link_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">remote</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">|</span> <span class="n">media_entity_type</span><span class="p">(</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RESZ_PAD_SINK</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_DEVNODE</span>:
		<span class="cm">/* read from memory */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_VP</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">RESIZER_INPUT_MEMORY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_MEMORY</span><span class="p">)</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">RESIZER_INPUT_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RESZ_PAD_SINK</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span>:
		<span class="cm">/* read from ccdc or previewer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_MEMORY</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">RESIZER_INPUT_VP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">RESIZER_INPUT_VP</span><span class="p">)</span>
				<span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">RESIZER_INPUT_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RESZ_PAD_SOURCE</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_DEVNODE</span>:
		<span class="cm">/* resizer always write to memory */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* media operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">media_entity_operations</span> <span class="n">resizer_media_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">link_setup</span> <span class="o">=</span> <span class="n">resizer_link_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_validate</span> <span class="o">=</span> <span class="n">v4l2_subdev_link_validate</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">omap3isp_resizer_unregister_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="n">omap3isp_video_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">);</span>
	<span class="n">omap3isp_video_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap3isp_resizer_register_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Register the subdev and video nodes. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">,</span> <span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">,</span> <span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">omap3isp_resizer_unregister_entities</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * ISP resizer initialization and cleanup</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * resizer_init_entities - Initialize resizer subdev and media entity.</span>
<span class="cm"> * @res : Pointer to resizer device structure</span>
<span class="cm"> * return -ENOMEM or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">resizer_init_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pads</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">RESIZER_INPUT_NONE</span><span class="p">;</span>

	<span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resizer_v4l2_ops</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">internal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resizer_v4l2_internal_ops</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;OMAP3 ISP resizer&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* group ID for isp subdevs */</span>
	<span class="n">v4l2_set_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_HAS_DEVNODE</span><span class="p">;</span>

	<span class="n">pads</span><span class="p">[</span><span class="n">RESZ_PAD_SINK</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SINK</span><span class="p">;</span>
	<span class="n">pads</span><span class="p">[</span><span class="n">RESZ_PAD_SOURCE</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>

	<span class="n">me</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resizer_media_ops</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_init</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">RESZ_PADS_NUM</span><span class="p">,</span> <span class="n">pads</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">resizer_init_formats</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resizer_video_ops</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">capture_mem</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="mi">4096</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">bpl_alignment</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">resizer_video_ops</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">capture_mem</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="mi">4096</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">bpl_alignment</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">,</span> <span class="s">&quot;resizer&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_video_in</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">,</span> <span class="s">&quot;resizer&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_video_out</span><span class="p">;</span>

	<span class="cm">/* Connect the video nodes to the resizer subdev. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">video</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">RESZ_PAD_SINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">RESZ_PAD_SOURCE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">video</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_link:</span>
	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
<span class="nl">error_video_out:</span>
	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">);</span>
<span class="nl">error_video_in:</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_resizer_init - Resizer initialization.</span>
<span class="cm"> * @isp : Pointer to ISP device</span>
<span class="cm"> * return -ENOMEM or zero on success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_resizer_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">resizer_init_entities</span><span class="p">(</span><span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3isp_resizer_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_res_device</span> <span class="o">*</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">;</span>

	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">);</span>
	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
