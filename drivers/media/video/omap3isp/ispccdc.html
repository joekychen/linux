<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › omap3isp › ispccdc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ispccdc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ispccdc.c</span>
<span class="cm"> *</span>
<span class="cm"> * TI OMAP3 ISP - CCDC module</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009-2010 Nokia Corporation</span>
<span class="cm"> * Copyright (C) 2009 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Contacts: Laurent Pinchart &lt;laurent.pinchart@ideasonboard.com&gt;</span>
<span class="cm"> *	     Sakari Ailus &lt;sakari.ailus@iki.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>

<span class="cp">#include &quot;isp.h&quot;</span>
<span class="cp">#include &quot;ispreg.h&quot;</span>
<span class="cp">#include &quot;ispccdc.h&quot;</span>

<span class="cp">#define CCDC_MIN_WIDTH		32</span>
<span class="cp">#define CCDC_MIN_HEIGHT		32</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span>
<span class="n">__ccdc_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccdc_fmts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">V4L2_MBUS_FMT_Y8_1X8</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_Y10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_Y12_1X12</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGRBG8_1X8</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SRGGB8_1X8</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SBGGR8_1X8</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGBRG8_1X8</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SRGGB10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGBRG10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGRBG12_1X12</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SRGGB12_1X12</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SBGGR12_1X12</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGBRG12_1X12</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_print_status - Print current CCDC Module register values.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> *</span>
<span class="cm"> * Also prints other debug information stored in the CCDC module.</span>
<span class="cm"> */</span>
<span class="cp">#define CCDC_PRINT_REGISTER(isp, name)\</span>
<span class="cp">	dev_dbg(isp-&gt;dev, &quot;###CCDC &quot; #name &quot;=0x%08x\n&quot;, \</span>
<span class="cp">		isp_reg_readl(isp, OMAP3_ISP_IOMEM_CCDC, ISPCCDC_##name))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_print_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-------------CCDC Register dump-------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">PCR</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SYN_MODE</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">HD_VD_WID</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">PIX_LINES</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">HORZ_INFO</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">VERT_START</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">VERT_LINES</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">CULLING</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">HSIZE_OFF</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SDOFST</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SDR_ADDR</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">CLAMP</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">DCSUB</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">COLPTN</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">BLKCMP</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">FPC</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">FPC_ADDR</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">VDINT</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ALAW</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">REC656IF</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">CFG</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">FMTCFG</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">FMT_HORZ</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">FMT_VERT</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">PRGEVEN0</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">PRGEVEN1</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">PRGODD0</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">PRGODD1</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">VP_OUT</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LSC_CONFIG</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LSC_INITIAL</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LSC_TABLE_BASE</span><span class="p">);</span>
	<span class="n">CCDC_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LSC_TABLE_OFFSET</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;--------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccdc_busy - Get busy state of the CCDC.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_ccdc_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_PCR</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">ISPCCDC_PCR_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Lens Shading Compensation</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_lsc_validate_config - Check that LSC configuration is valid.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @lsc_cfg: the LSC configuration to check.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if the LSC configuration is valid, or -EINVAL if invalid.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_lsc_validate_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">omap3isp_ccdc_lsc_config</span> <span class="o">*</span><span class="n">lsc_cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">paxel_width</span><span class="p">,</span> <span class="n">paxel_height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">paxel_shift_x</span><span class="p">,</span> <span class="n">paxel_shift_y</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">min_width</span><span class="p">,</span> <span class="n">min_height</span><span class="p">,</span> <span class="n">min_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input_width</span><span class="p">,</span> <span class="n">input_height</span><span class="p">;</span>

	<span class="n">paxel_shift_x</span> <span class="o">=</span> <span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">gain_mode_m</span><span class="p">;</span>
	<span class="n">paxel_shift_y</span> <span class="o">=</span> <span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">gain_mode_n</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">paxel_shift_x</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">paxel_shift_x</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">paxel_shift_y</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">paxel_shift_y</span> <span class="o">&gt;</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCDC: LSC: Invalid paxel size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCDC: LSC: Offset must be a multiple of &quot;</span>
			<span class="s">&quot;4</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">initial_x</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">initial_y</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCDC: LSC: initial_x and y must be even</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CCDC_PAD_SINK</span><span class="p">,</span>
				   <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">);</span>
	<span class="n">input_width</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">input_height</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/* Calculate minimum bytesize for validation */</span>
	<span class="n">paxel_width</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">paxel_shift_x</span><span class="p">;</span>
	<span class="n">min_width</span> <span class="o">=</span> <span class="p">((</span><span class="n">input_width</span> <span class="o">+</span> <span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">initial_x</span> <span class="o">+</span> <span class="n">paxel_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		     <span class="o">&gt;&gt;</span> <span class="n">paxel_shift_x</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">paxel_height</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">paxel_shift_y</span><span class="p">;</span>
	<span class="n">min_height</span> <span class="o">=</span> <span class="p">((</span><span class="n">input_height</span> <span class="o">+</span> <span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">initial_y</span> <span class="o">+</span> <span class="n">paxel_height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		     <span class="o">&gt;&gt;</span> <span class="n">paxel_shift_y</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">min_size</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">min_width</span> <span class="o">*</span> <span class="n">min_height</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min_size</span> <span class="o">&gt;</span> <span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCDC: LSC: too small table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">min_width</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCDC: LSC: Offset is too small</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="n">lsc_cfg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">min_height</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCDC: LSC: Wrong size/offset combination</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_lsc_program_table - Program Lens Shading Compensation table address.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_lsc_program_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">),</span> <span class="n">addr</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_LSC_TABLE_BASE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_lsc_setup_regs - Configures the lens shading compensation module</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_lsc_setup_regs</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">omap3isp_ccdc_lsc_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span>
		       <span class="n">ISPCCDC_LSC_TABLE_OFFSET</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">gain_mode_n</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_LSC_GAIN_MODE_N_SHIFT</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">gain_mode_m</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_LSC_GAIN_MODE_M_SHIFT</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">gain_format</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_LSC_GAIN_FORMAT_SHIFT</span><span class="p">;</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_LSC_CONFIG</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_LSC_INITIAL_X_MASK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">initial_x</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_LSC_INITIAL_X_SHIFT</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_LSC_INITIAL_Y_MASK</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">cfg</span><span class="o">-&gt;</span><span class="n">initial_y</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_LSC_INITIAL_Y_SHIFT</span><span class="p">;</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span>
		       <span class="n">ISPCCDC_LSC_INITIAL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_lsc_wait_prefetch</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wait</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">IRQ0STATUS_CCDC_LSC_PREF_COMP_IRQ</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_IRQ0STATUS</span><span class="p">);</span>

	<span class="cm">/* timeout 1 ms */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">wait</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">wait</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_IRQ0STATUS</span><span class="p">)</span> <span class="o">&amp;</span>
				  <span class="n">IRQ0STATUS_CCDC_LSC_PREF_COMP_IRQ</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">IRQ0STATUS_CCDC_LSC_PREF_COMP_IRQ</span><span class="p">,</span>
				       <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_IRQ0STATUS</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * __ccdc_lsc_enable - Enables/Disables the Lens Shading Compensation module.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @enable: 0 Disables LSC, 1 Enables LSC.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ccdc_lsc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span> <span class="o">=</span>
		<span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">CCDC_PAD_SINK</span><span class="p">,</span>
				  <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_SRGGB10_1X10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_SGBRG10_1X10</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">omap3isp_sbl_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_CCDC_LSC_READ</span><span class="p">);</span>

	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_LSC_CONFIG</span><span class="p">,</span>
			<span class="n">ISPCCDC_LSC_ENABLE</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">ISPCCDC_LSC_ENABLE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc_lsc_wait_prefetch</span><span class="p">(</span><span class="n">ccdc</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span>
				    <span class="n">ISPCCDC_LSC_CONFIG</span><span class="p">,</span> <span class="n">ISPCCDC_LSC_ENABLE</span><span class="p">);</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">;</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">to_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">),</span> <span class="s">&quot;LSC prefecth timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LSC_STATE_RUNNING</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LSC_STATE_STOPPING</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_lsc_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_LSC_CONFIG</span><span class="p">)</span> <span class="o">&amp;</span>
			     <span class="n">ISPCCDC_LSC_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* __ccdc_lsc_configure - Apply a new configuration to the LSC engine</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device</span>
<span class="cm"> * @req: New configuration request</span>
<span class="cm"> *</span>
<span class="cm"> * context: in_interrupt()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ccdc_lsc_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ispccdc_lsc_config_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc_lsc_validate_config</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">),</span> <span class="s">&quot;Discard LSC configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc_lsc_busy</span><span class="p">(</span><span class="n">ccdc</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">ccdc_lsc_setup_regs</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">);</span>
	<span class="n">ccdc_lsc_program_table</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_lsc_error_handler - Handle LSC prefetch error scenario.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> *</span>
<span class="cm"> * Disables LSC, and defers enablement to shadow registers update time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_lsc_error_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * From OMAP3 TRM: When this event is pending, the module</span>
<span class="cm">	 * goes into transparent mode (output =input). Normal</span>
<span class="cm">	 * operation can be resumed at the start of the next frame</span>
<span class="cm">	 * after:</span>
<span class="cm">	 *  1) Clearing this event</span>
<span class="cm">	 *  2) Disabling the LSC module</span>
<span class="cm">	 *  3) Enabling it</span>
<span class="cm">	 */</span>
	<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_LSC_CONFIG</span><span class="p">,</span>
		    <span class="n">ISPCCDC_LSC_ENABLE</span><span class="p">);</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_lsc_free_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ispccdc_lsc_config_req</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span><span class="p">)</span>
		<span class="n">dma_unmap_sg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span><span class="o">-&gt;</span><span class="n">sgt</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">,</span>
			     <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span><span class="o">-&gt;</span><span class="n">sgt</span><span class="o">-&gt;</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">)</span>
		<span class="n">omap_iommu_vfree</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_lsc_free_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">queue</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ispccdc_lsc_config_req</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">ccdc_lsc_free_request</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_lsc_free_table_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ispccdc_lsc</span> <span class="o">*</span><span class="n">lsc</span><span class="p">;</span>

	<span class="n">lsc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ispccdc_lsc</span><span class="p">,</span> <span class="n">table_work</span><span class="p">);</span>
	<span class="n">ccdc</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">lsc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp_ccdc_device</span><span class="p">,</span> <span class="n">lsc</span><span class="p">);</span>

	<span class="n">ccdc_lsc_free_queue</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lsc</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_lsc_config - Configure the LSC module from a userspace request</span>
<span class="cm"> *</span>
<span class="cm"> * Store the request LSC configuration in the LSC engine request pointer. The</span>
<span class="cm"> * configuration will be applied to the hardware when the CCDC will be enabled,</span>
<span class="cm"> * or at the next LSC interrupt if the CCDC is already running.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_lsc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">omap3isp_ccdc_update_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ispccdc_lsc_config_req</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">update</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">update</span> <span class="o">=</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">&amp;</span>
		 <span class="p">(</span><span class="n">OMAP3ISP_CCDC_CONFIG_LSC</span> <span class="o">|</span> <span class="n">OMAP3ISP_CCDC_TBL_LSC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">update</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">update</span> <span class="o">!=</span> <span class="p">(</span><span class="n">OMAP3ISP_CCDC_CONFIG_LSC</span> <span class="o">|</span> <span class="n">OMAP3ISP_CCDC_TBL_LSC</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">),</span> <span class="s">&quot;%s: Both LSC configuration and table &quot;</span>
			<span class="s">&quot;need to be supplied</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">OMAP3ISP_CCDC_CONFIG_LSC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">lsc_cfg</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">enable</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">table</span> <span class="o">=</span> <span class="n">omap_iommu_vmalloc</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">IOMMU_FLAG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">table</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span> <span class="o">=</span> <span class="n">omap_find_iovm_area</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dma_map_sg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span><span class="o">-&gt;</span><span class="n">sgt</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">,</span>
				<span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span><span class="o">-&gt;</span><span class="n">sgt</span><span class="o">-&gt;</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_sync_sg_for_cpu</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span><span class="o">-&gt;</span><span class="n">sgt</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">,</span>
				    <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span><span class="o">-&gt;</span><span class="n">sgt</span><span class="o">-&gt;</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>

		<span class="n">table</span> <span class="o">=</span> <span class="n">omap_da_to_va</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">table</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">table</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dma_sync_sg_for_device</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span><span class="o">-&gt;</span><span class="n">sgt</span><span class="o">-&gt;</span><span class="n">sgl</span><span class="p">,</span>
				       <span class="n">req</span><span class="o">-&gt;</span><span class="n">iovm</span><span class="o">-&gt;</span><span class="n">sgt</span><span class="o">-&gt;</span><span class="n">nents</span><span class="p">,</span> <span class="n">DMA_TO_DEVICE</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">free_queue</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">table_work</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ccdc_lsc_free_request</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">req</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ccdc_lsc_is_configured</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_lsc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ispccdc_lsc</span> <span class="o">*</span><span class="n">lsc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lsc</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsc</span><span class="o">-&gt;</span><span class="n">active</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lsc</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">);</span>
		<span class="n">lsc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__ccdc_lsc_configure</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">lsc</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">omap3isp_sbl_disable</span><span class="p">(</span><span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">),</span>
				<span class="n">OMAP3_ISP_SBL_CCDC_LSC_READ</span><span class="p">);</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsc</span><span class="o">-&gt;</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lsc</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">);</span>
		<span class="n">lsc</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lsc</span><span class="o">-&gt;</span><span class="n">active</span> <span class="o">=</span> <span class="n">lsc</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">;</span>
	<span class="n">lsc</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">__ccdc_lsc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsc</span><span class="o">-&gt;</span><span class="n">free_queue</span><span class="p">))</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lsc</span><span class="o">-&gt;</span><span class="n">table_work</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Parameters configuration</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_configure_clamp - Configure optical-black or digital clamping</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> *</span>
<span class="cm"> * The CCDC performs either optical-black or digital clamp. Configure and enable</span>
<span class="cm"> * the selected clamp method.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_configure_clamp</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">clamp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">obclamp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clamp</span>  <span class="o">=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">.</span><span class="n">obgain</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_CLAMP_OBGAIN_SHIFT</span><span class="p">;</span>
		<span class="n">clamp</span> <span class="o">|=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">.</span><span class="n">oblen</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_CLAMP_OBSLEN_SHIFT</span><span class="p">;</span>
		<span class="n">clamp</span> <span class="o">|=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">.</span><span class="n">oblines</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_CLAMP_OBSLN_SHIFT</span><span class="p">;</span>
		<span class="n">clamp</span> <span class="o">|=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">.</span><span class="n">obstpixel</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_CLAMP_OBST_SHIFT</span><span class="p">;</span>
		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">clamp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_CLAMP</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">.</span><span class="n">dcsubval</span><span class="p">,</span>
			       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_DCSUB</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_CLAMP</span><span class="p">,</span>
			<span class="n">ISPCCDC_CLAMP_CLAMPEN</span><span class="p">,</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">obclamp</span> <span class="o">?</span> <span class="n">ISPCCDC_CLAMP_CLAMPEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_configure_fpc - Configure Faulty Pixel Correction</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_configure_fpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_FPC</span><span class="p">,</span> <span class="n">ISPCCDC_FPC_FPCEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc_en</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">.</span><span class="n">fpcaddr</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span>
		       <span class="n">ISPCCDC_FPC_ADDR</span><span class="p">);</span>
	<span class="cm">/* The FPNUM field must be set before enabling FPC. */</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">.</span><span class="n">fpnum</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_FPC_FPNUM_SHIFT</span><span class="p">),</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_FPC</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">.</span><span class="n">fpnum</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_FPC_FPNUM_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		       <span class="n">ISPCCDC_FPC_FPCEN</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_FPC</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_configure_black_comp - Configure Black Level Compensation.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_configure_black_comp</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">blcomp</span><span class="p">;</span>

	<span class="n">blcomp</span>  <span class="o">=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">blcomp</span><span class="p">.</span><span class="n">b_mg</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_BLKCMP_B_MG_SHIFT</span><span class="p">;</span>
	<span class="n">blcomp</span> <span class="o">|=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">blcomp</span><span class="p">.</span><span class="n">gb_g</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_BLKCMP_GB_G_SHIFT</span><span class="p">;</span>
	<span class="n">blcomp</span> <span class="o">|=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">blcomp</span><span class="p">.</span><span class="n">gr_cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_BLKCMP_GR_CY_SHIFT</span><span class="p">;</span>
	<span class="n">blcomp</span> <span class="o">|=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">blcomp</span><span class="p">.</span><span class="n">r_ye</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_BLKCMP_R_YE_SHIFT</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">blcomp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_BLKCMP</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_configure_lpf - Configure Low-Pass Filter (LPF).</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_configure_lpf</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SYN_MODE</span><span class="p">,</span>
			<span class="n">ISPCCDC_SYN_MODE_LPF</span><span class="p">,</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lpf</span> <span class="o">?</span> <span class="n">ISPCCDC_SYN_MODE_LPF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_configure_alaw - Configure A-law compression.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_configure_alaw</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">alaw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">datsz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">alaw</span> <span class="o">=</span> <span class="n">ISPCCDC_ALAW_GWDI_9_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">alaw</span> <span class="o">=</span> <span class="n">ISPCCDC_ALAW_GWDI_10_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">alaw</span> <span class="o">=</span> <span class="n">ISPCCDC_ALAW_GWDI_11_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">alaw</span> <span class="o">=</span> <span class="n">ISPCCDC_ALAW_GWDI_12_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">alaw</span><span class="p">)</span>
		<span class="n">alaw</span> <span class="o">|=</span> <span class="n">ISPCCDC_ALAW_CCDTBL</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">alaw</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_ALAW</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_config_imgattr - Configure sensor image specific attributes.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @colptn: Color pattern of the sensor.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_config_imgattr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">colptn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">colptn</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_COLPTN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_config - Set CCDC configuration from userspace</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @userspace_add: Structure containing CCDC configuration sent from userspace.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if successful, -EINVAL if the pointer to the configuration</span>
<span class="cm"> * structure is null, or the copy_from_user function fails to copy user space</span>
<span class="cm"> * memory to kernel space memory.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">omap3isp_ccdc_update_config</span> <span class="o">*</span><span class="n">ccdc_struct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">shadow_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP3ISP_CCDC_ALAW</span> <span class="o">&amp;</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">alaw</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">OMAP3ISP_CCDC_ALAW</span> <span class="o">&amp;</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">|=</span> <span class="n">OMAP3ISP_CCDC_ALAW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP3ISP_CCDC_LPF</span> <span class="o">&amp;</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lpf</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">OMAP3ISP_CCDC_LPF</span> <span class="o">&amp;</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">|=</span> <span class="n">OMAP3ISP_CCDC_LPF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP3ISP_CCDC_BLCLAMP</span> <span class="o">&amp;</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">,</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">bclamp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">shadow_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">obclamp</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">OMAP3ISP_CCDC_BLCLAMP</span> <span class="o">&amp;</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">|=</span> <span class="n">OMAP3ISP_CCDC_BLCLAMP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP3ISP_CCDC_BCOMP</span> <span class="o">&amp;</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">blcomp</span><span class="p">,</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">blcomp</span><span class="p">,</span>
				   <span class="k">sizeof</span><span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">blcomp</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">shadow_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">|=</span> <span class="n">OMAP3ISP_CCDC_BCOMP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">shadow_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">OMAP3ISP_CCDC_FPC</span> <span class="o">&amp;</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">table_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">table_new</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc_en</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">OMAP3ISP_CCDC_FPC</span> <span class="o">&amp;</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">flag</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc_en</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">,</span> <span class="n">ccdc_struct</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">,</span>
					   <span class="k">sizeof</span><span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * table_new must be 64-bytes aligned, but it&#39;s</span>
<span class="cm">			 * already done by omap_iommu_vmalloc().</span>
<span class="cm">			 */</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">.</span><span class="n">fpnum</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
			<span class="n">table_new</span> <span class="o">=</span> <span class="n">omap_iommu_vmalloc</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">IOMMU_FLAG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR_VALUE</span><span class="p">(</span><span class="n">table_new</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">omap_da_to_va</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">table_new</span><span class="p">),</span>
					   <span class="p">(</span><span class="n">__force</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
					   <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">.</span><span class="n">fpcaddr</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">omap_iommu_vfree</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">table_new</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">table_old</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">.</span><span class="n">fpcaddr</span><span class="p">;</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">.</span><span class="n">fpcaddr</span> <span class="o">=</span> <span class="n">table_new</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ccdc_configure_fpc</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">table_old</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">omap_iommu_vfree</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">table_old</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ccdc_lsc_config</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">ccdc_struct</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_apply_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">&amp;</span> <span class="n">OMAP3ISP_CCDC_ALAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccdc_configure_alaw</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3ISP_CCDC_ALAW</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">&amp;</span> <span class="n">OMAP3ISP_CCDC_LPF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccdc_configure_lpf</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3ISP_CCDC_LPF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">&amp;</span> <span class="n">OMAP3ISP_CCDC_BLCLAMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccdc_configure_clamp</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3ISP_CCDC_BLCLAMP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">&amp;</span> <span class="n">OMAP3ISP_CCDC_BCOMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccdc_configure_black_comp</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">OMAP3ISP_CCDC_BCOMP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccdc_restore_context - Restore values of the CCDC module registers</span>
<span class="cm"> * @dev: Pointer to ISP device</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_ccdc_restore_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">;</span>

	<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_CFG</span><span class="p">,</span> <span class="n">ISPCCDC_CFG_VDLC</span><span class="p">);</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="n">OMAP3ISP_CCDC_ALAW</span> <span class="o">|</span> <span class="n">OMAP3ISP_CCDC_LPF</span>
		     <span class="o">|</span> <span class="n">OMAP3ISP_CCDC_BLCLAMP</span> <span class="o">|</span> <span class="n">OMAP3ISP_CCDC_BCOMP</span><span class="p">;</span>
	<span class="n">ccdc_apply_controls</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="n">ccdc_configure_fpc</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Format- and pipeline-related configuration helpers</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_config_vp - Configure the Video Port.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_config_vp</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">l3_ick</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">l3_ick</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_div</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">div</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fmtcfg_vp</span><span class="p">;</span>

	<span class="n">fmtcfg_vp</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_FMTCFG</span><span class="p">)</span>
		  <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">ISPCCDC_FMTCFG_VPIN_MASK</span> <span class="o">|</span> <span class="n">ISPCCDC_FMTCFG_VPIF_FRQ_MASK</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">datsz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">fmtcfg_vp</span> <span class="o">|=</span> <span class="n">ISPCCDC_FMTCFG_VPIN_9_0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">fmtcfg_vp</span> <span class="o">|=</span> <span class="n">ISPCCDC_FMTCFG_VPIN_10_1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">fmtcfg_vp</span> <span class="o">|=</span> <span class="n">ISPCCDC_FMTCFG_VPIN_11_2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">13</span>:
		<span class="n">fmtcfg_vp</span> <span class="o">|=</span> <span class="n">ISPCCDC_FMTCFG_VPIN_12_3</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">l3_ick</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_rate</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">external_rate</span><span class="p">)</span>
		<span class="n">div</span> <span class="o">=</span> <span class="n">l3_ick</span> <span class="o">/</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">external_rate</span><span class="p">;</span>

	<span class="n">div</span> <span class="o">=</span> <span class="n">clamp</span><span class="p">(</span><span class="n">div</span><span class="p">,</span> <span class="mi">2U</span><span class="p">,</span> <span class="n">max_div</span><span class="p">);</span>
	<span class="n">fmtcfg_vp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">div</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_FMTCFG_VPIF_FRQ_SHIFT</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">fmtcfg_vp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_FMTCFG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_enable_vp - Enable Video Port.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @enable: 0 Disables VP, 1 Enables VP</span>
<span class="cm"> *</span>
<span class="cm"> * This is needed for outputting image to Preview, H3A and HIST ISP submodules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_enable_vp</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_FMTCFG</span><span class="p">,</span>
			<span class="n">ISPCCDC_FMTCFG_VPEN</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">ISPCCDC_FMTCFG_VPEN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_config_outlineoffset - Configure memory saving output line offset</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @offset: Address offset to start a new line. Must be twice the</span>
<span class="cm"> *          Output width and aligned on 32 byte boundary</span>
<span class="cm"> * @oddeven: Specifies the odd/even line pattern to be chosen to store the</span>
<span class="cm"> *           output.</span>
<span class="cm"> * @numlines: Set the value 0-3 for +1-4lines, 4-7 for -1-4lines.</span>
<span class="cm"> *</span>
<span class="cm"> * - Configures the output line offset when stored in memory</span>
<span class="cm"> * - Sets the odd/even line pattern to store the output</span>
<span class="cm"> *    (EVENEVEN (1), ODDEVEN (2), EVENODD (3), ODDODD (4))</span>
<span class="cm"> * - Configures the number of even and odd line fields in case of rearranging</span>
<span class="cm"> * the lines.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_config_outlineoffset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
					<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">oddeven</span><span class="p">,</span> <span class="n">u8</span> <span class="n">numlines</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_HSIZE_OFF</span><span class="p">);</span>

	<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SDOFST</span><span class="p">,</span>
		    <span class="n">ISPCCDC_SDOFST_FINV</span><span class="p">);</span>

	<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SDOFST</span><span class="p">,</span>
		    <span class="n">ISPCCDC_SDOFST_FOFST_4L</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">oddeven</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EVENEVEN</span>:
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SDOFST</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">numlines</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_SDOFST_LOFST0_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ODDEVEN</span>:
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SDOFST</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">numlines</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_SDOFST_LOFST1_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">EVENODD</span>:
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SDOFST</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">numlines</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_SDOFST_LOFST2_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ODDODD</span>:
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SDOFST</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">numlines</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_SDOFST_LOFST3_SHIFT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_set_outaddr - Set memory address to save output image</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @addr: ISP MMU Mapped 32-bit memory address aligned on 32 byte boundary.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the memory address where the output will be saved.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_set_outaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SDR_ADDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccdc_max_rate - Calculate maximum input data rate based on the input</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @max_rate: Maximum calculated data rate.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns in *max_rate less value between calculated and passed</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_ccdc_max_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">max_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * TRM says that for parallel sensors the maximum data rate</span>
<span class="cm">	 * should be 90% form L3/2 clock, otherwise just L3/2.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCDC_INPUT_PARALLEL</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">l3_ick</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">*</span> <span class="mi">9</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">l3_ick</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="o">*</span><span class="n">max_rate</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="o">*</span><span class="n">max_rate</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_config_sync_if - Set CCDC sync interface configuration</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @syncif: Structure containing the sync parameters like field state, CCDC in</span>
<span class="cm"> *          master/slave mode, raw/yuv data, polarity of data, field, hs, vs</span>
<span class="cm"> *          signals.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_config_sync_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ispccdc_syncif</span> <span class="o">*</span><span class="n">syncif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">syn_mode</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span>
				     <span class="n">ISPCCDC_SYN_MODE</span><span class="p">);</span>

	<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_VDHDEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncif</span><span class="o">-&gt;</span><span class="n">fldstat</span><span class="p">)</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_FLDSTAT</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_FLDSTAT</span><span class="p">;</span>

	<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_DATSIZ_MASK</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">syncif</span><span class="o">-&gt;</span><span class="n">datsz</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">8</span>:
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_DATSIZ_8</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">10</span>:
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_DATSIZ_10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">11</span>:
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_DATSIZ_11</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_DATSIZ_12</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncif</span><span class="o">-&gt;</span><span class="n">fldmode</span><span class="p">)</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_FLDMODE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_FLDMODE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncif</span><span class="o">-&gt;</span><span class="n">datapol</span><span class="p">)</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_DATAPOL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_DATAPOL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncif</span><span class="o">-&gt;</span><span class="n">fldpol</span><span class="p">)</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_FLDPOL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_FLDPOL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncif</span><span class="o">-&gt;</span><span class="n">hdpol</span><span class="p">)</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_HDPOL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_HDPOL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncif</span><span class="o">-&gt;</span><span class="n">vdpol</span><span class="p">)</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_VDPOL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_VDPOL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">syncif</span><span class="o">-&gt;</span><span class="n">ccdc_mastermode</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_FLDOUT</span> <span class="o">|</span> <span class="n">ISPCCDC_SYN_MODE_VDHDOUT</span><span class="p">;</span>
		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span>
			       <span class="n">syncif</span><span class="o">-&gt;</span><span class="n">hs_width</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_HD_VD_WID_HDW_SHIFT</span>
			     <span class="o">|</span> <span class="n">syncif</span><span class="o">-&gt;</span><span class="n">vs_width</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_HD_VD_WID_VDW_SHIFT</span><span class="p">,</span>
			       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span>
			       <span class="n">ISPCCDC_HD_VD_WID</span><span class="p">);</span>

		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span>
			       <span class="n">syncif</span><span class="o">-&gt;</span><span class="n">ppln</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_PIX_LINES_PPLN_SHIFT</span>
			     <span class="o">|</span> <span class="n">syncif</span><span class="o">-&gt;</span><span class="n">hlprf</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_PIX_LINES_HLPRF_SHIFT</span><span class="p">,</span>
			       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span>
			       <span class="n">ISPCCDC_PIX_LINES</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISPCCDC_SYN_MODE_FLDOUT</span> <span class="o">|</span>
			      <span class="n">ISPCCDC_SYN_MODE_VDHDOUT</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">syn_mode</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SYN_MODE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">syncif</span><span class="o">-&gt;</span><span class="n">bt_r656_en</span><span class="p">)</span>
		<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_REC656IF</span><span class="p">,</span>
			    <span class="n">ISPCCDC_REC656IF_R656ON</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* CCDC formats descriptions */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ccdc_sgrbg_pattern</span> <span class="o">=</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC3_SHIFT</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ccdc_srggb_pattern</span> <span class="o">=</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC3_SHIFT</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ccdc_sbggr_pattern</span> <span class="o">=</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC3_SHIFT</span><span class="p">;</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ccdc_sgbrg_pattern</span> <span class="o">=</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP0PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP1PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gb_G</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_B_Mg</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP2PLC3_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC0_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC1_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_R_Ye</span>  <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC2_SHIFT</span> <span class="o">|</span>
	<span class="n">ISPCCDC_COLPTN_Gr_Cy</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_COLPTN_CP3PLC3_SHIFT</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_parallel_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sensor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">isp_format_info</span> <span class="o">*</span><span class="n">fmt_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="n">fmt_src</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth_out</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">depth_in</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">syn_mode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ccdc_pattern</span><span class="p">;</span>

	<span class="n">pad</span> <span class="o">=</span> <span class="n">media_entity_remote_source</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">CCDC_PAD_SINK</span><span class="p">]);</span>
	<span class="n">sensor</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCDC_INPUT_PARALLEL</span><span class="p">)</span>
		<span class="n">pdata</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">isp_v4l2_subdevs_group</span> <span class="o">*</span><span class="p">)</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">)</span>
			<span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">parallel</span><span class="p">;</span>

	<span class="cm">/* Compute shift value for lane shifter to configure the bridge. */</span>
	<span class="n">fmt_src</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">fmt_src</span><span class="p">.</span><span class="n">which</span> <span class="o">=</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">get_fmt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt_src</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fmt_info</span> <span class="o">=</span> <span class="n">omap3isp_video_format_info</span><span class="p">(</span><span class="n">fmt_src</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">code</span><span class="p">);</span>
		<span class="n">depth_in</span> <span class="o">=</span> <span class="n">fmt_info</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fmt_info</span> <span class="o">=</span> <span class="n">omap3isp_video_format_info</span>
		<span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">formats</span><span class="p">[</span><span class="n">CCDC_PAD_SINK</span><span class="p">].</span><span class="n">code</span><span class="p">);</span>
	<span class="n">depth_out</span> <span class="o">=</span> <span class="n">fmt_info</span><span class="o">-&gt;</span><span class="n">bpp</span><span class="p">;</span>

	<span class="n">shift</span> <span class="o">=</span> <span class="n">depth_in</span> <span class="o">-</span> <span class="n">depth_out</span><span class="p">;</span>
	<span class="n">omap3isp_configure_bridge</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">pdata</span><span class="p">,</span> <span class="n">shift</span><span class="p">);</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">datsz</span> <span class="o">=</span> <span class="n">depth_out</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">hdpol</span> <span class="o">=</span> <span class="n">pdata</span> <span class="o">?</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">hs_pol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">vdpol</span> <span class="o">=</span> <span class="n">pdata</span> <span class="o">?</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">vs_pol</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccdc_config_sync_if</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">);</span>

	<span class="cm">/* CCDC_PAD_SINK */</span>
	<span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CCDC_PAD_SINK</span><span class="p">];</span>

	<span class="n">syn_mode</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SYN_MODE</span><span class="p">);</span>

	<span class="cm">/* Use the raw, unprocessed data when writing to memory. The H3A and</span>
<span class="cm">	 * histogram modules are still fed with lens shading corrected data.</span>
<span class="cm">	 */</span>
	<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_VP2SDR</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">)</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_WEN</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_WEN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_RESIZER</span><span class="p">)</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_SDR2RSZ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_SDR2RSZ</span><span class="p">;</span>

	<span class="cm">/* Use PACK8 mode for 1byte per pixel formats. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_video_format_info</span><span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">syn_mode</span> <span class="o">|=</span> <span class="n">ISPCCDC_SYN_MODE_PACK8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">syn_mode</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCCDC_SYN_MODE_PACK8</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">syn_mode</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_SYN_MODE</span><span class="p">);</span>

	<span class="cm">/* Mosaic filter */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SRGGB10_1X10</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SRGGB12_1X12</span>:
		<span class="n">ccdc_pattern</span> <span class="o">=</span> <span class="n">ccdc_srggb_pattern</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SBGGR12_1X12</span>:
		<span class="n">ccdc_pattern</span> <span class="o">=</span> <span class="n">ccdc_sbggr_pattern</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SGBRG10_1X10</span>:
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SGBRG12_1X12</span>:
		<span class="n">ccdc_pattern</span> <span class="o">=</span> <span class="n">ccdc_sgbrg_pattern</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="cm">/* Use GRBG */</span>
		<span class="n">ccdc_pattern</span> <span class="o">=</span> <span class="n">ccdc_sgrbg_pattern</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ccdc_config_imgattr</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">ccdc_pattern</span><span class="p">);</span>

	<span class="cm">/* Generate VD0 on the last line of the image and VD1 on the</span>
<span class="cm">	 * 2/3 height line.</span>
<span class="cm">	 */</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="p">((</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_VDINT_0_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">((</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_VDINT_1_SHIFT</span><span class="p">),</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_VDINT</span><span class="p">);</span>

	<span class="cm">/* CCDC_PAD_SOURCE_OF */</span>
	<span class="n">crop</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_HORZ_INFO_SPH_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">((</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_HORZ_INFO_NPH_SHIFT</span><span class="p">),</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_HORZ_INFO</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_VERT_START_SLV0_SHIFT</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_VERT_START</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
			<span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_VERT_LINES_NLV_SHIFT</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_VERT_LINES</span><span class="p">);</span>

	<span class="n">ccdc_config_outlineoffset</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">bpl_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* CCDC_PAD_SOURCE_VP */</span>
	<span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CCDC_PAD_SOURCE_VP</span><span class="p">];</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_FMT_HORZ_FMTSPH_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_FMT_HORZ_FMTLNH_SHIFT</span><span class="p">),</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_FMT_HORZ</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_FMT_VERT_FMTSLV_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">((</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_FMT_VERT_FMTLNV_SHIFT</span><span class="p">),</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_FMT_VERT</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_VP_OUT_HORZ_NUM_SHIFT</span><span class="p">)</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">format</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCDC_VP_OUT_VERT_NUM_SHIFT</span><span class="p">),</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_VP_OUT</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">unlock</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">active</span><span class="p">);</span>

	<span class="cm">/* Get last good LSC configuration. If it is not supported for</span>
<span class="cm">	 * the current active resolution discard it.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">active</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">__ccdc_lsc_configure</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">free_queue</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">table_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ccdc_apply_controls</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__ccdc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_PCR</span><span class="p">,</span>
			<span class="n">ISPCCDC_PCR_EN</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">ISPCCDC_PCR_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_CONTINUOUS</span><span class="p">)</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">=</span> <span class="n">CCDC_STOP_REQUEST</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
				 <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">==</span> <span class="n">CCDC_STOP_FINISHED</span><span class="p">,</span>
				 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">2000</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">to_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">),</span> <span class="s">&quot;CCDC stop timeout!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">omap3isp_sbl_disable</span><span class="p">(</span><span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">),</span> <span class="n">OMAP3_ISP_SBL_CCDC_LSC_READ</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
	<span class="n">ccdc_lsc_free_request</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span><span class="p">);</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">active</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">table_work</span><span class="p">);</span>
	<span class="n">ccdc_lsc_free_queue</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">free_queue</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">=</span> <span class="n">CCDC_STOP_NOT_REQUESTED</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc_lsc_is_configured</span><span class="p">(</span><span class="n">ccdc</span><span class="p">))</span>
		<span class="n">__ccdc_lsc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">__ccdc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Interrupt handling</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_sbl_busy - Poll idle state of CCDC and related SBL memory write bits</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns zero if the CCDC is idle and the image has been written to</span>
<span class="cm"> * memory, too.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_sbl_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">omap3isp_ccdc_busy</span><span class="p">(</span><span class="n">ccdc</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span><span class="p">,</span> <span class="n">ISPSBL_CCDC_WR_0</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="n">ISPSBL_CCDC_WR_0_DATA_READY</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span><span class="p">,</span> <span class="n">ISPSBL_CCDC_WR_1</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="n">ISPSBL_CCDC_WR_0_DATA_READY</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span><span class="p">,</span> <span class="n">ISPSBL_CCDC_WR_2</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="n">ISPSBL_CCDC_WR_0_DATA_READY</span><span class="p">)</span>
		<span class="o">|</span> <span class="p">(</span><span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span><span class="p">,</span> <span class="n">ISPSBL_CCDC_WR_3</span><span class="p">)</span> <span class="o">&amp;</span>
		   <span class="n">ISPSBL_CCDC_WR_0_DATA_READY</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_sbl_wait_idle - Wait until the CCDC and related SBL are idle</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @max_wait: Max retry count in us for wait for idle/busy transition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_sbl_wait_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">max_wait</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">max_wait</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="cm">/* 10 ms */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">wait</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">wait</span> <span class="o">&lt;=</span> <span class="n">max_wait</span><span class="p">;</span> <span class="n">wait</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccdc_sbl_busy</span><span class="p">(</span><span class="n">ccdc</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">rmb</span><span class="p">();</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* __ccdc_handle_stopping - Handle CCDC and/or LSC stopping sequence</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @event: Pointing which event trigger handler</span>
<span class="cm"> *</span>
<span class="cm"> * Return 1 when the event and stopping request combination is satisfied,</span>
<span class="cm"> * zero otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__ccdc_handle_stopping</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">((</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCDC_STOP_REQUEST</span> <span class="o">|</span> <span class="n">CCDC_EVENT_VD1</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">)</span>
			<span class="n">__ccdc_lsc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">__ccdc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">=</span> <span class="n">CCDC_STOP_EXECUTED</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_STOP_EXECUTED</span> <span class="o">|</span> <span class="n">CCDC_EVENT_VD0</span>:
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">|=</span> <span class="n">CCDC_STOP_CCDC_FINISHED</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">)</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">|=</span> <span class="n">CCDC_STOP_LSC_FINISHED</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_STOP_EXECUTED</span> <span class="o">|</span> <span class="n">CCDC_EVENT_LSC_DONE</span>:
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">|=</span> <span class="n">CCDC_STOP_LSC_FINISHED</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_STOP_EXECUTED</span> <span class="o">|</span> <span class="n">CCDC_EVENT_VD1</span>:
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">==</span> <span class="n">CCDC_STOP_FINISHED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_hs_vs_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">devnode</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_event</span> <span class="n">event</span><span class="p">;</span>

	<span class="cm">/* Frame number propagation */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">frame_number</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">event</span><span class="p">));</span>
	<span class="n">event</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_EVENT_FRAME_SYNC</span><span class="p">;</span>
	<span class="n">event</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">frame_sync</span><span class="p">.</span><span class="n">frame_sequence</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">frame_number</span><span class="p">);</span>

	<span class="n">v4l2_event_queue</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">event</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_lsc_isr - Handle LSC events</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @events: LSC events</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_lsc_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_CCDC_LSC_PREF_ERR_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span>
			<span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>

		<span class="n">ccdc_lsc_error_handler</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">to_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">),</span> <span class="s">&quot;lsc prefetch error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_CCDC_LSC_DONE_IRQ</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* LSC_DONE interrupt occur, there are two cases</span>
<span class="cm">	 * 1. stopping for reconfiguration</span>
<span class="cm">	 * 2. stopping because of STREAM OFF command</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LSC_STATE_STOPPING</span><span class="p">)</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__ccdc_handle_stopping</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">CCDC_EVENT_LSC_DONE</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LSC_STATE_RECONFIG</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* LSC is in STOPPING state, change to the new state */</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">;</span>

	<span class="cm">/* This is an exception. Start of frame and LSC_DONE interrupt</span>
<span class="cm">	 * have been received on the same time. Skip this event and wait</span>
<span class="cm">	 * for better times.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_HS_VS_IRQ</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* The LSC engine is stopped at this point. Enable it if there&#39;s a</span>
<span class="cm">	 * pending request.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ccdc_lsc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_isr_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The CCDC generates VD0 interrupts even when disabled (the datasheet</span>
<span class="cm">	 * doesn&#39;t explicitly state if that&#39;s supposed to happen or not, so it</span>
<span class="cm">	 * can be considered as a hardware bug or as a feature, but we have to</span>
<span class="cm">	 * deal with it anyway). Disabling the CCDC when no buffer is available</span>
<span class="cm">	 * would thus not be enough, we need to handle the situation explicitly.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">dmaqueue</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* We&#39;re in continuous mode, and memory writes were disabled due to a</span>
<span class="cm">	 * buffer underrun. Reenable them now that we have a buffer. The buffer</span>
<span class="cm">	 * address has been set in ccdc_video_queue.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_CONTINUOUS</span> <span class="o">&amp;&amp;</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">underrun</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">underrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc_sbl_wait_idle</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">1000</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCDC won&#39;t become idle!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">omap3isp_video_buffer_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccdc_set_outaddr</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>
		<span class="n">restart</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">ISP_PIPELINE_IDLE_OUTPUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">isp_pipeline_ready</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
		<span class="n">omap3isp_pipeline_set_stream</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span>
					<span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">restart</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_vd0_isr - Handle VD0 event</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> *</span>
<span class="cm"> * Executes LSC deferred enablement before next frame starts.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_vd0_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">)</span>
		<span class="n">restart</span> <span class="o">=</span> <span class="n">ccdc_isr_buffer</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__ccdc_handle_stopping</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">CCDC_EVENT_VD0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">shadow_update</span><span class="p">)</span>
		<span class="n">ccdc_apply_controls</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restart</span><span class="p">)</span>
		<span class="n">ccdc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_vd1_isr - Handle VD1 event</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_vd1_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Depending on the CCDC pipeline state, CCDC stopping should be</span>
<span class="cm">	 * handled differently. In SINGLESHOT we emulate an internal CCDC</span>
<span class="cm">	 * stopping because the CCDC hw works only in continuous mode.</span>
<span class="cm">	 * When CONTINUOUS pipeline state is used and the CCDC writes it&#39;s</span>
<span class="cm">	 * data to memory the CCDC and LSC are stopped immediately but</span>
<span class="cm">	 * without change the CCDC stopping state machine. The CCDC</span>
<span class="cm">	 * stopping state machine should be used only when user request</span>
<span class="cm">	 * for stopping is received (SINGLESHOT is an exeption).</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span>:
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">=</span> <span class="n">CCDC_STOP_REQUEST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_CONTINUOUS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">)</span>
				<span class="n">__ccdc_lsc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">__ccdc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__ccdc_handle_stopping</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">CCDC_EVENT_VD1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * LSC need to be reconfigured. Stop it here and on next LSC_DONE IRQ</span>
<span class="cm">	 * do the appropriate changes in registers</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LSC_STATE_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__ccdc_lsc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LSC_STATE_RECONFIG</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* LSC has been in STOPPED state, enable it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">)</span>
		<span class="n">ccdc_lsc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccdc_isr - Configure CCDC during interframe time.</span>
<span class="cm"> * @ccdc: Pointer to ISP CCDC device.</span>
<span class="cm"> * @events: CCDC events</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_ccdc_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">u32</span> <span class="n">events</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_CCDC_VD1_IRQ</span><span class="p">)</span>
		<span class="n">ccdc_vd1_isr</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">ccdc_lsc_isr</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_CCDC_VD0_IRQ</span><span class="p">)</span>
		<span class="n">ccdc_vd0_isr</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_HS_VS_IRQ</span><span class="p">)</span>
		<span class="n">ccdc_hs_vs_isr</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * ISP video operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_video_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_video</span> <span class="o">*</span><span class="n">video</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ccdc_set_outaddr</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>

	<span class="cm">/* We now have a buffer queued on the output, restart the pipeline</span>
<span class="cm">	 * on the next CCDC interrupt if running in continuous mode (or when</span>
<span class="cm">	 * starting the stream).</span>
<span class="cm">	 */</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">underrun</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">isp_video_operations</span> <span class="n">ccdc_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">ccdc_video_queue</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * V4L2 subdev operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_ioctl - CCDC module private ioctl&#39;s</span>
<span class="cm"> * @sd: ISP CCDC V4L2 subdevice</span>
<span class="cm"> * @cmd: ioctl command</span>
<span class="cm"> * @arg: ioctl argument</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">ccdc_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIDIOC_OMAP3ISP_CCDC_CFG</span>:
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ccdc_config</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_subscribe_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_event_subscription</span> <span class="o">*</span><span class="n">sub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_EVENT_FRAME_SYNC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* line number is zero at frame start */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">v4l2_event_subscribe</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="n">OMAP3ISP_CCDC_NEVENTS</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_unsubscribe_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_event_subscription</span> <span class="o">*</span><span class="n">sub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">v4l2_event_unsubscribe</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">sub</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_set_stream - Enable/Disable streaming on the CCDC module</span>
<span class="cm"> * @sd: ISP CCDC V4L2 subdevice</span>
<span class="cm"> * @enable: Enable/disable stream</span>
<span class="cm"> *</span>
<span class="cm"> * When writing to memory, the CCDC hardware can&#39;t be enabled without a memory</span>
<span class="cm"> * buffer to write to. As the s_stream operation is called in response to a</span>
<span class="cm"> * STREAMON call without any buffer queued yet, just update the enabled field</span>
<span class="cm"> * and return immediately. The CCDC will be enabled in ccdc_isr_buffer().</span>
<span class="cm"> *</span>
<span class="cm"> * When not writing to memory enable the CCDC immediately.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_set_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">omap3isp_subclk_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SUBCLK_CCDC</span><span class="p">);</span>
		<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span><span class="p">,</span> <span class="n">ISPCCDC_CFG</span><span class="p">,</span>
			    <span class="n">ISPCCDC_CFG_VDLC</span><span class="p">);</span>

		<span class="n">ccdc_configure</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

		<span class="cm">/* TODO: Don&#39;t configure the video port if all of its output</span>
<span class="cm">		 * links are inactive.</span>
<span class="cm">		 */</span>
		<span class="n">ccdc_config_vp</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
		<span class="n">ccdc_enable_vp</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ccdc_print_status</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_CONTINUOUS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">)</span>
			<span class="n">omap3isp_sbl_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_CCDC_WRITE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">underrun</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">))</span>
			<span class="n">ccdc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">underrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_MEMORY</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span><span class="p">)</span>
			<span class="n">omap3isp_sbl_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_CCDC_WRITE</span><span class="p">);</span>

		<span class="n">ccdc_enable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ccdc_disable</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">)</span>
			<span class="n">omap3isp_sbl_disable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_CCDC_WRITE</span><span class="p">);</span>
		<span class="n">omap3isp_subclk_disable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SUBCLK_CCDC</span><span class="p">);</span>
		<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">underrun</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span>
<span class="nf">__ccdc_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">pad</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span>
<span class="nf">__ccdc_get_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v4l2_subdev_get_try_crop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_try_format - Try video format on a pad</span>
<span class="cm"> * @ccdc: ISP CCDC device</span>
<span class="cm"> * @fh : V4L2 subdev file handle</span>
<span class="cm"> * @pad: Pad number</span>
<span class="cm"> * @fmt: Format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">ccdc_try_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
		<span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">isp_format_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">width</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">height</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCDC_PAD_SINK</span>:
		<span class="cm">/* TODO: If the CCDC output formatter pad is connected directly</span>
<span class="cm">		 * to the resizer, only YUV formats can be used.</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ccdc_fmts</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">==</span> <span class="n">ccdc_fmts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If not found, use SGRBG10 as default */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ccdc_fmts</span><span class="p">))</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">;</span>

		<span class="cm">/* Clamp the input size. */</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">4096</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_PAD_SOURCE_OF</span>:
		<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SINK</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">));</span>

		<span class="cm">/* Hardcode the output size to the crop rectangle size. */</span>
		<span class="n">crop</span> <span class="o">=</span> <span class="n">__ccdc_get_crop</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_PAD_SOURCE_VP</span>:
		<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SINK</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">));</span>

		<span class="cm">/* The video port interface truncates the data to 10 bits. */</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">omap3isp_video_format_info</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">truncated</span><span class="p">;</span>

		<span class="cm">/* The number of lines that can be clocked out from the video</span>
<span class="cm">		 * port output must be at least one line less than the number</span>
<span class="cm">		 * of input lines.</span>
<span class="cm">		 */</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Data is written to memory unpacked, each 10-bit or 12-bit pixel is</span>
<span class="cm">	 * stored on 2 bytes.</span>
<span class="cm">	 */</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_try_crop - Validate a crop rectangle</span>
<span class="cm"> * @ccdc: ISP CCDC device</span>
<span class="cm"> * @sink: format on the sink pad</span>
<span class="cm"> * @crop: crop rectangle to be validated</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccdc_try_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">sink</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">isp_format_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_width</span><span class="p">;</span>

	<span class="cm">/* For Bayer formats, restrict left/top and width/height to even values</span>
<span class="cm">	 * to keep the Bayer pattern.</span>
<span class="cm">	 */</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">omap3isp_video_format_info</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flavor</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_Y8_1X8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">CCDC_MIN_WIDTH</span><span class="p">);</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sink</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">CCDC_MIN_HEIGHT</span><span class="p">);</span>

	<span class="cm">/* The data formatter truncates the number of horizontal output pixels</span>
<span class="cm">	 * to a multiple of 16. To avoid clipping data, allow callers to request</span>
<span class="cm">	 * an output size bigger than the input size up to the nearest multiple</span>
<span class="cm">	 * of 16.</span>
<span class="cm">	 */</span>
	<span class="n">max_width</span> <span class="o">=</span> <span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="mi">15</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">CCDC_MIN_WIDTH</span><span class="p">,</span> <span class="n">max_width</span><span class="p">)</span>
		    <span class="o">&amp;</span> <span class="o">~</span><span class="mi">15</span><span class="p">;</span>
	<span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">CCDC_MIN_HEIGHT</span><span class="p">,</span>
			       <span class="n">sink</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">);</span>

	<span class="cm">/* Odd width/height values don&#39;t make sense for Bayer formats. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flavor</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_Y8_1X8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_enum_mbus_code - Handle pixel format enumeration</span>
<span class="cm"> * @sd     : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh : V4L2 subdev file handle</span>
<span class="cm"> * @code   : pointer to v4l2_subdev_mbus_code_enum structure</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_enum_mbus_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_subdev_mbus_code_enum</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCDC_PAD_SINK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ccdc_fmts</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">ccdc_fmts</span><span class="p">[</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_PAD_SOURCE_OF</span>:
	<span class="k">case</span> <span class="n">CCDC_PAD_SOURCE_VP</span>:
		<span class="cm">/* No format conversion inside CCDC */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SINK</span><span class="p">,</span>
					   <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>

		<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_enum_frame_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_frame_size_enum</span> <span class="o">*</span><span class="n">fse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fse</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ccdc_try_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_width</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_height</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ccdc_try_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_width</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_height</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_get_selection - Retrieve a selection rectangle on a pad</span>
<span class="cm"> * @sd: ISP CCDC V4L2 subdevice</span>
<span class="cm"> * @fh: V4L2 subdev file handle</span>
<span class="cm"> * @sel: Selection rectangle</span>
<span class="cm"> *</span>
<span class="cm"> * The only supported rectangles are the crop rectangles on the output formatter</span>
<span class="cm"> * source pad.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_get_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">!=</span> <span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_BOUNDS</span>:
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">INT_MAX</span><span class="p">;</span>

		<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SINK</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="n">ccdc_try_crop</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span>:
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">__ccdc_get_crop</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_set_selection - Set a selection rectangle on a pad</span>
<span class="cm"> * @sd: ISP CCDC V4L2 subdevice</span>
<span class="cm"> * @fh: V4L2 subdev file handle</span>
<span class="cm"> * @sel: Selection rectangle</span>
<span class="cm"> *</span>
<span class="cm"> * The only supported rectangle is the actual crop rectangle on the output</span>
<span class="cm"> * formatter source pad.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_set_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">target</span> <span class="o">!=</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span> <span class="o">||</span>
	    <span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">!=</span> <span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* The crop rectangle can&#39;t be changed while streaming. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Modifying the crop rectangle always changes the format on the source</span>
<span class="cm">	 * pad. If the KEEP_CONFIG flag is set, just return the current crop</span>
<span class="cm">	 * rectangle.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_SUBDEV_SEL_FLAG_KEEP_CONFIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">__ccdc_get_crop</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SINK</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="n">ccdc_try_crop</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">);</span>
	<span class="o">*</span><span class="n">__ccdc_get_crop</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">)</span> <span class="o">=</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">;</span>

	<span class="cm">/* Update the source format. */</span>
	<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="n">ccdc_try_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_get_format - Retrieve the video format on a pad</span>
<span class="cm"> * @sd : ISP CCDC V4L2 subdevice</span>
<span class="cm"> * @fh : V4L2 subdev file handle</span>
<span class="cm"> * @fmt: Format</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or -EINVAL if the pad is invalid or doesn&#39;t correspond</span>
<span class="cm"> * to the format type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_set_format - Set the video format on a pad</span>
<span class="cm"> * @sd : ISP CCDC V4L2 subdevice</span>
<span class="cm"> * @fh : V4L2 subdev file handle</span>
<span class="cm"> * @fmt: Format</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or -EINVAL if the pad is invalid or doesn&#39;t correspond</span>
<span class="cm"> * to the format type.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crop</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ccdc_try_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>

	<span class="cm">/* Propagate the format from sink to source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">CCDC_PAD_SINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Reset the crop rectangle. */</span>
		<span class="n">crop</span> <span class="o">=</span> <span class="n">__ccdc_get_crop</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

		<span class="n">ccdc_try_crop</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">crop</span><span class="p">);</span>

		<span class="cm">/* Update the source formats. */</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">,</span>
					   <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
		<span class="n">ccdc_try_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span>
				<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

		<span class="n">format</span> <span class="o">=</span> <span class="n">__ccdc_get_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_VP</span><span class="p">,</span>
					   <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
		<span class="n">ccdc_try_format</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_VP</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span>
				<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Decide whether desired output pixel code can be obtained with</span>
<span class="cm"> * the lane shifter by shifting the input pixel code.</span>
<span class="cm"> * @in: input pixelcode to shifter</span>
<span class="cm"> * @out: output pixelcode from shifter</span>
<span class="cm"> * @additional_shift: # of bits the sensor&#39;s LSB is offset from CAMEXT[0]</span>
<span class="cm"> *</span>
<span class="cm"> * return true if the combination is possible</span>
<span class="cm"> * return false otherwise</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span> <span class="nf">ccdc_is_shiftable</span><span class="p">(</span><span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">in</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">out</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">additional_shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">isp_format_info</span> <span class="o">*</span><span class="n">in_info</span><span class="p">,</span> <span class="o">*</span><span class="n">out_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in</span> <span class="o">==</span> <span class="n">out</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">in_info</span> <span class="o">=</span> <span class="n">omap3isp_video_format_info</span><span class="p">(</span><span class="n">in</span><span class="p">);</span>
	<span class="n">out_info</span> <span class="o">=</span> <span class="n">omap3isp_video_format_info</span><span class="p">(</span><span class="n">out</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">in_info</span><span class="o">-&gt;</span><span class="n">flavor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">out_info</span><span class="o">-&gt;</span><span class="n">flavor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in_info</span><span class="o">-&gt;</span><span class="n">flavor</span> <span class="o">!=</span> <span class="n">out_info</span><span class="o">-&gt;</span><span class="n">flavor</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">in_info</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">-</span> <span class="n">out_info</span><span class="o">-&gt;</span><span class="n">bpp</span> <span class="o">+</span> <span class="n">additional_shift</span> <span class="o">&lt;=</span> <span class="mi">6</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_link_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">media_link</span> <span class="o">*</span><span class="n">link</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">source_fmt</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">sink_fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">parallel_shift</span><span class="p">;</span>

	<span class="cm">/* Check if the two ends match */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">source_fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">!=</span> <span class="n">sink_fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">||</span>
	    <span class="n">source_fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">!=</span> <span class="n">sink_fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>

	<span class="cm">/* We&#39;ve got a parallel sensor here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCDC_INPUT_PARALLEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">isp_parallel_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="p">((</span><span class="k">struct</span> <span class="n">isp_v4l2_subdevs_group</span> <span class="o">*</span><span class="p">)</span>
			  <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">link</span><span class="o">-&gt;</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">)</span>
			  <span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">parallel</span><span class="p">;</span>
		<span class="n">parallel_shift</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">data_lane_shift</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">parallel_shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Lane shifter may be used to drop bits on CCDC sink pad */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ccdc_is_shiftable</span><span class="p">(</span><span class="n">source_fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">code</span><span class="p">,</span>
			       <span class="n">sink_fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">parallel_shift</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPIPE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_init_formats - Initialize formats on all pads</span>
<span class="cm"> * @sd: ISP CCDC V4L2 subdevice</span>
<span class="cm"> * @fh: V4L2 subdev file handle</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize all pad formats with default values. If fh is not NULL, try</span>
<span class="cm"> * formats are initialized on the file handle. Otherwise active formats are</span>
<span class="cm"> * initialized on the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_init_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="n">format</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">));</span>
	<span class="n">format</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">CCDC_PAD_SINK</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">which</span> <span class="o">=</span> <span class="n">fh</span> <span class="o">?</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span> <span class="o">:</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">ccdc_set_format</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* V4L2 subdev core operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">ccdc_v4l2_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ioctl</span> <span class="o">=</span> <span class="n">ccdc_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">subscribe_event</span> <span class="o">=</span> <span class="n">ccdc_subscribe_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unsubscribe_event</span> <span class="o">=</span> <span class="n">ccdc_unsubscribe_event</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* V4L2 subdev video operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">ccdc_v4l2_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span> <span class="o">=</span> <span class="n">ccdc_set_stream</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* V4L2 subdev pad operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_pad_ops</span> <span class="n">ccdc_v4l2_pad_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enum_mbus_code</span> <span class="o">=</span> <span class="n">ccdc_enum_mbus_code</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_frame_size</span> <span class="o">=</span> <span class="n">ccdc_enum_frame_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fmt</span> <span class="o">=</span> <span class="n">ccdc_get_format</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span> <span class="o">=</span> <span class="n">ccdc_set_format</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_selection</span> <span class="o">=</span> <span class="n">ccdc_get_selection</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_selection</span> <span class="o">=</span> <span class="n">ccdc_set_selection</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_validate</span> <span class="o">=</span> <span class="n">ccdc_link_validate</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* V4L2 subdev operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">ccdc_v4l2_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc_v4l2_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc_v4l2_video_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc_v4l2_pad_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* V4L2 subdev internal operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_internal_ops</span> <span class="n">ccdc_v4l2_internal_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ccdc_init_formats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Media entity operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_link_setup - Setup CCDC connections</span>
<span class="cm"> * @entity: CCDC media entity</span>
<span class="cm"> * @local: Pad at the local end of the link</span>
<span class="cm"> * @remote: Pad at the remote end of the link</span>
<span class="cm"> * @flags: Link flags</span>
<span class="cm"> *</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_link_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">remote</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">|</span> <span class="n">media_entity_type</span><span class="p">(</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCDC_PAD_SINK</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span>:
		<span class="cm">/* Read from the sensor (parallel interface), CCP2, CSI2a or</span>
<span class="cm">		 * CSI2c.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCDC_INPUT_NONE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">!=</span> <span class="n">CCDC_INPUT_NONE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">entity</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">)</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCDC_INPUT_CCP2B</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">entity</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">)</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCDC_INPUT_CSI2A</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">entity</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2c</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">)</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCDC_INPUT_CSI2C</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCDC_INPUT_PARALLEL</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The ISP core doesn&#39;t support pipelines with multiple video outputs.</span>
<span class="cm">	 * Revisit this when it will be implemented, and return -EBUSY for now.</span>
<span class="cm">	 */</span>

	<span class="k">case</span> <span class="n">CCDC_PAD_SOURCE_VP</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span>:
		<span class="cm">/* Write to preview engine, histogram and H3A. When none of</span>
<span class="cm">		 * those links are active, the video port can be disabled.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CCDC_OUTPUT_PREVIEW</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">|=</span> <span class="n">CCDC_OUTPUT_PREVIEW</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCDC_OUTPUT_PREVIEW</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_PAD_SOURCE_OF</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_DEVNODE</span>:
		<span class="cm">/* Write to memory */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">|=</span> <span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCDC_OUTPUT_MEMORY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_PAD_SOURCE_OF</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span>:
		<span class="cm">/* Write to resizer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">CCDC_OUTPUT_RESIZER</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">|=</span> <span class="n">CCDC_OUTPUT_RESIZER</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CCDC_OUTPUT_RESIZER</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* media operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">media_entity_operations</span> <span class="n">ccdc_media_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">link_setup</span> <span class="o">=</span> <span class="n">ccdc_link_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_validate</span> <span class="o">=</span> <span class="n">v4l2_subdev_link_validate</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">omap3isp_ccdc_unregister_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="n">omap3isp_video_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">omap3isp_ccdc_register_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Register the subdev and video node. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">,</span> <span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">omap3isp_ccdc_unregister_entities</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * ISP CCDC initialisation and cleanup</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccdc_init_entities - Initialize V4L2 subdev and media entity</span>
<span class="cm"> * @ccdc: ISP CCDC module</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success and a negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccdc_init_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pads</span> <span class="o">=</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCDC_INPUT_NONE</span><span class="p">;</span>

	<span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccdc_v4l2_ops</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">internal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc_v4l2_internal_ops</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;OMAP3 ISP CCDC&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>	<span class="cm">/* group ID for isp subdevs */</span>
	<span class="n">v4l2_set_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">ccdc</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_HAS_EVENTS</span> <span class="o">|</span> <span class="n">V4L2_SUBDEV_FL_HAS_DEVNODE</span><span class="p">;</span>

	<span class="n">pads</span><span class="p">[</span><span class="n">CCDC_PAD_SINK</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SINK</span><span class="p">;</span>
	<span class="n">pads</span><span class="p">[</span><span class="n">CCDC_PAD_SOURCE_VP</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>
	<span class="n">pads</span><span class="p">[</span><span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>

	<span class="n">me</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc_media_ops</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_init</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">CCDC_PADS_NUM</span><span class="p">,</span> <span class="n">pads</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ccdc_init_formats</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccdc_video_ops</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">capture_mem</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="mi">4096</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">bpl_alignment</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">,</span> <span class="s">&quot;CCDC&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_video</span><span class="p">;</span>

	<span class="cm">/* Connect the CCDC subdev to the video node. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">.</span><span class="n">video</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_link:</span>
	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
<span class="nl">error_video:</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="n">me</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccdc_init - CCDC module initialization.</span>
<span class="cm"> * @dev: Device pointer specific to the OMAP3 ISP.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: Get the initialisation values from platform data.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_ccdc_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">stopping</span> <span class="o">=</span> <span class="n">CCDC_STOP_NOT_REQUESTED</span><span class="p">;</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">table_work</span><span class="p">,</span> <span class="n">ccdc_lsc_free_table_work</span><span class="p">);</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">LSC_STATE_STOPPED</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">free_queue</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">req_lock</span><span class="p">);</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">ccdc_mastermode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">datapol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">datsz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">fldmode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">fldout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">fldpol</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">syncif</span><span class="p">.</span><span class="n">fldstat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">.</span><span class="n">oblen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">clamp</span><span class="p">.</span><span class="n">dcsubval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="n">OMAP3ISP_CCDC_BLCLAMP</span><span class="p">;</span>
	<span class="n">ccdc_apply_controls</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccdc_init_entities</span><span class="p">(</span><span class="n">ccdc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccdc_cleanup - CCDC module cleanup.</span>
<span class="cm"> * @dev: Device pointer specific to the OMAP3 ISP.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_ccdc_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccdc_device</span> <span class="o">*</span><span class="n">ccdc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">;</span>

	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">video_out</span><span class="p">);</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>

	<span class="cm">/* Free LSC requests. As the CCDC is stopped there&#39;s no active request,</span>
<span class="cm">	 * so only the pending request and the free queue need to be handled.</span>
<span class="cm">	 */</span>
	<span class="n">ccdc_lsc_free_request</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">request</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">table_work</span><span class="p">);</span>
	<span class="n">ccdc_lsc_free_queue</span><span class="p">(</span><span class="n">ccdc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">lsc</span><span class="p">.</span><span class="n">free_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">.</span><span class="n">fpcaddr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">omap_iommu_vfree</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">fpc</span><span class="p">.</span><span class="n">fpcaddr</span><span class="p">);</span>

	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccdc</span><span class="o">-&gt;</span><span class="n">ioctl_lock</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
