<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › omap3isp › ispccp2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ispccp2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ispccp2.c</span>
<span class="cm"> *</span>
<span class="cm"> * TI OMAP3 ISP - CCP2 module</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Nokia Corporation</span>
<span class="cm"> * Copyright (C) 2010 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Contacts: Laurent Pinchart &lt;laurent.pinchart@ideasonboard.com&gt;</span>
<span class="cm"> *	     Sakari Ailus &lt;sakari.ailus@iki.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>

<span class="cp">#include &quot;isp.h&quot;</span>
<span class="cp">#include &quot;ispreg.h&quot;</span>
<span class="cp">#include &quot;ispccp2.h&quot;</span>

<span class="cm">/* Number of LCX channels */</span>
<span class="cp">#define CCP2_LCx_CHANS_NUM			3</span>
<span class="cm">/* Max/Min size for CCP2 video port */</span>
<span class="cp">#define ISPCCP2_DAT_START_MIN			0</span>
<span class="cp">#define ISPCCP2_DAT_START_MAX			4095</span>
<span class="cp">#define ISPCCP2_DAT_SIZE_MIN			0</span>
<span class="cp">#define ISPCCP2_DAT_SIZE_MAX			4095</span>
<span class="cp">#define ISPCCP2_VPCLK_FRACDIV			65536</span>
<span class="cp">#define ISPCCP2_LCx_CTRL_FORMAT_RAW8_DPCM10_VP	0x12</span>
<span class="cp">#define ISPCCP2_LCx_CTRL_FORMAT_RAW10_VP	0x16</span>
<span class="cm">/* Max/Min size for CCP2 memory channel */</span>
<span class="cp">#define ISPCCP2_LCM_HSIZE_COUNT_MIN		16</span>
<span class="cp">#define ISPCCP2_LCM_HSIZE_COUNT_MAX		8191</span>
<span class="cp">#define ISPCCP2_LCM_HSIZE_SKIP_MIN		0</span>
<span class="cp">#define ISPCCP2_LCM_HSIZE_SKIP_MAX		8191</span>
<span class="cp">#define ISPCCP2_LCM_VSIZE_MIN			1</span>
<span class="cp">#define ISPCCP2_LCM_VSIZE_MAX			8191</span>
<span class="cp">#define ISPCCP2_LCM_HWORDS_MIN			1</span>
<span class="cp">#define ISPCCP2_LCM_HWORDS_MAX			4095</span>
<span class="cp">#define ISPCCP2_LCM_CTRL_BURST_SIZE_32X		5</span>
<span class="cp">#define ISPCCP2_LCM_CTRL_READ_THROTTLE_FULL	0</span>
<span class="cp">#define ISPCCP2_LCM_CTRL_SRC_DECOMPR_DPCM10	2</span>
<span class="cp">#define ISPCCP2_LCM_CTRL_SRC_FORMAT_RAW8	2</span>
<span class="cp">#define ISPCCP2_LCM_CTRL_SRC_FORMAT_RAW10	3</span>
<span class="cp">#define ISPCCP2_LCM_CTRL_DST_FORMAT_RAW10	3</span>
<span class="cp">#define ISPCCP2_LCM_CTRL_DST_PORT_VP		0</span>
<span class="cp">#define ISPCCP2_LCM_CTRL_DST_PORT_MEM		1</span>

<span class="cm">/* Set only the required bits */</span>
<span class="cp">#define BIT_SET(var, shift, mask, val)			\</span>
<span class="cp">	do {						\</span>
<span class="cp">		var = ((var) &amp; ~((mask) &lt;&lt; (shift)))	\</span>
<span class="cp">			| ((val) &lt;&lt; (shift));		\</span>
<span class="cp">	} while (0)</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_print_status - Print current CCP2 module register values.</span>
<span class="cm"> */</span>
<span class="cp">#define CCP2_PRINT_REGISTER(isp, name)\</span>
<span class="cp">	dev_dbg(isp-&gt;dev, &quot;###CCP2 &quot; #name &quot;=0x%08x\n&quot;, \</span>
<span class="cp">		isp_reg_readl(isp, OMAP3_ISP_IOMEM_CCP2, ISPCCP2_##name))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_print_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-------------CCP2 Register dump-------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SYSCONFIG</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SYSSTATUS</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LC01_IRQENABLE</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LC01_IRQSTATUS</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LC23_IRQENABLE</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LC23_IRQSTATUS</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_IRQENABLE</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_IRQSTATUS</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">CTRL</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_CTRL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_CODE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_STAT_START</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_STAT_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_SOF_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_EOF_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_DAT_START</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_DAT_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_DAT_PING_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_DAT_PONG_ADDR</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCx_DAT_OFST</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_CTRL</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_VSIZE</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_HSIZE</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_PREFETCH</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_SRC_ADDR</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_SRC_OFST</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_DST_ADDR</span><span class="p">);</span>
	<span class="n">CCP2_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">LCM_DST_OFST</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;--------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_reset - Reset the CCP2</span>
<span class="cm"> * @ccp2: pointer to ISP CCP2 device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Reset the CSI1/CCP2B and wait for reset to complete */</span>
	<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_SYSCONFIG</span><span class="p">,</span>
		    <span class="n">ISPCCP2_SYSCONFIG_SOFT_RESET</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_SYSSTATUS</span><span class="p">)</span> <span class="o">&amp;</span>
		 <span class="n">ISPCCP2_SYSSTATUS_RESET_DONE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>  <span class="cm">/* try read 10 times */</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;omap3_isp: timeout waiting for ccp2 reset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_pwr_cfg - Configure the power mode settings</span>
<span class="cm"> * @ccp2: pointer to ISP CCP2 device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_pwr_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISPCCP2_SYSCONFIG_MSTANDBY_MODE_SMART</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span> <span class="o">&amp;&amp;</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">autoidle</span><span class="p">)</span> <span class="o">?</span>
			  <span class="n">ISPCCP2_SYSCONFIG_AUTO_IDLE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_SYSCONFIG</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_if_enable - Enable CCP2 interface.</span>
<span class="cm"> * @ccp2: pointer to ISP CCP2 device</span>
<span class="cm"> * @enable: enable/disable flag</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_if_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">vdds_csib</span><span class="p">)</span>
		<span class="n">regulator_enable</span><span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">vdds_csib</span><span class="p">);</span>

	<span class="cm">/* Enable/Disable all the LCx channels */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">CCP2_LCx_CHANS_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCx_CTRL</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
				<span class="n">ISPCCP2_LCx_CTRL_CHAN_EN</span><span class="p">,</span>
				<span class="n">enable</span> <span class="o">?</span> <span class="n">ISPCCP2_LCx_CTRL_CHAN_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Enable/Disable ccp2 interface in ccp2 mode */</span>
	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL</span><span class="p">,</span>
			<span class="n">ISPCCP2_CTRL_MODE</span> <span class="o">|</span> <span class="n">ISPCCP2_CTRL_IF_EN</span><span class="p">,</span>
			<span class="n">enable</span> <span class="o">?</span> <span class="p">(</span><span class="n">ISPCCP2_CTRL_MODE</span> <span class="o">|</span> <span class="n">ISPCCP2_CTRL_IF_EN</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable</span> <span class="o">&amp;&amp;</span> <span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">vdds_csib</span><span class="p">)</span>
		<span class="n">regulator_disable</span><span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">vdds_csib</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_mem_enable - Enable CCP2 memory interface.</span>
<span class="cm"> * @ccp2: pointer to ISP CCP2 device</span>
<span class="cm"> * @enable: enable/disable flag</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_mem_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">u8</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">ccp2_if_enable</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Enable/Disable ccp2 interface in ccp2 mode */</span>
	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL</span><span class="p">,</span>
			<span class="n">ISPCCP2_CTRL_MODE</span><span class="p">,</span> <span class="n">enable</span> <span class="o">?</span> <span class="n">ISPCCP2_CTRL_MODE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_CTRL</span><span class="p">,</span>
			<span class="n">ISPCCP2_LCM_CTRL_CHAN_EN</span><span class="p">,</span>
			<span class="n">enable</span> <span class="o">?</span> <span class="n">ISPCCP2_LCM_CTRL_CHAN_EN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_phyif_config - Initialize CCP2 phy interface config</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> * @config: CCP2 platform data</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the CCP2 physical interface module from platform data.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns -EIO if strobe is chosen in CSI1 mode, or 0 on success.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_phyif_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span>
			     <span class="k">const</span> <span class="k">struct</span> <span class="n">isp_ccp2_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* CCP2B mode */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">ISPCCP2_CTRL_IO_OUT_SEL</span> <span class="o">|</span> <span class="n">ISPCCP2_CTRL_MODE</span><span class="p">;</span>
	<span class="cm">/* Data/strobe physical layer */</span>
	<span class="n">BIT_SET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL_PHY_SEL_SHIFT</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL_PHY_SEL_MASK</span><span class="p">,</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">phy_layer</span><span class="p">);</span>
	<span class="n">BIT_SET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL_INV_SHIFT</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL_INV_MASK</span><span class="p">,</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">strobe_clk_pol</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL</span><span class="p">);</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">ISPCCP2_CTRL_MODE</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">ccp2_mode</span> <span class="o">==</span> <span class="n">ISP_CCP2_MODE_CCP2</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;OMAP3 CCP2 bus not available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">phy_layer</span> <span class="o">==</span> <span class="n">ISP_CCP2_PHY_DATA_STROBE</span><span class="p">)</span>
			<span class="cm">/* Strobe mode requires CCP2 */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_vp_config - Initialize CCP2 video port interface.</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> * @vpclk_div: Video port divisor</span>
<span class="cm"> *</span>
<span class="cm"> * Configure the CCP2 video port with the given clock divisor. The valid divisor</span>
<span class="cm"> * values depend on the ISP revision:</span>
<span class="cm"> *</span>
<span class="cm"> * - revision 1.0 and 2.0	1 to 4</span>
<span class="cm"> * - revision 15.0		1 to 65536</span>
<span class="cm"> *</span>
<span class="cm"> * The exact divisor value used might differ from the requested value, as ISP</span>
<span class="cm"> * revision 15.0 represent the divisor by 65536 divided by an integer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_vp_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vpclk_div</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="cm">/* ISPCCP2_CTRL Video port */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ISPCCP2_CTRL_VP_ONLY_EN</span><span class="p">;</span>	<span class="cm">/* Disable the memory write port */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vpclk_div</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">vpclk_div</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">65536</span><span class="p">);</span>
		<span class="n">vpclk_div</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">ISPCCP2_VPCLK_FRACDIV</span> <span class="o">/</span> <span class="n">vpclk_div</span><span class="p">,</span> <span class="mi">65535U</span><span class="p">);</span>
		<span class="n">BIT_SET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL_VPCLK_DIV_SHIFT</span><span class="p">,</span>
			<span class="n">ISPCCP2_CTRL_VPCLK_DIV_MASK</span><span class="p">,</span> <span class="n">vpclk_div</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vpclk_div</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">vpclk_div</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">BIT_SET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL_VP_OUT_CTRL_SHIFT</span><span class="p">,</span>
			<span class="n">ISPCCP2_CTRL_VP_OUT_CTRL_MASK</span><span class="p">,</span> <span class="n">vpclk_div</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_lcx_config - Initialize CCP2 logical channel interface.</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> * @config: Pointer to ISP LCx config structure.</span>
<span class="cm"> *</span>
<span class="cm"> * This will analyze the parameters passed by the interface config</span>
<span class="cm"> * and configure CSI1/CCP2 logical channel</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_lcx_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">isp_interface_lcx_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">format</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_DPCM8_1X8</span>:
		<span class="n">format</span> <span class="o">=</span> <span class="n">ISPCCP2_LCx_CTRL_FORMAT_RAW8_DPCM10_VP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span>:
	<span class="nl">default:</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">ISPCCP2_LCx_CTRL_FORMAT_RAW10_VP</span><span class="p">;</span>	<span class="cm">/* RAW10+VP */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* ISPCCP2_LCx_CTRL logical channel #0 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCx_CTRL</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
			    <span class="o">|</span> <span class="p">(</span><span class="n">ISPCCP2_LCx_CTRL_REGION_EN</span><span class="p">);</span> <span class="cm">/* Region */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* CRC */</span>
		<span class="n">BIT_SET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ISPCCP2_LCx_CTRL_CRC_SHIFT_15_0</span><span class="p">,</span>
			<span class="n">ISPCCP2_LCx_CTRL_CRC_MASK</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">crc</span><span class="p">);</span>
		<span class="cm">/* Format = RAW10+VP or RAW8+DPCM10+VP*/</span>
		<span class="n">BIT_SET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ISPCCP2_LCx_CTRL_FORMAT_SHIFT_15_0</span><span class="p">,</span>
			<span class="n">ISPCCP2_LCx_CTRL_FORMAT_MASK_15_0</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BIT_SET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ISPCCP2_LCx_CTRL_CRC_SHIFT</span><span class="p">,</span>
			<span class="n">ISPCCP2_LCx_CTRL_CRC_MASK</span><span class="p">,</span>
			<span class="n">config</span><span class="o">-&gt;</span><span class="n">crc</span><span class="p">);</span>

		<span class="n">BIT_SET</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ISPCCP2_LCx_CTRL_FORMAT_SHIFT</span><span class="p">,</span>
			<span class="n">ISPCCP2_LCx_CTRL_FORMAT_MASK</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCx_CTRL</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* ISPCCP2_DAT_START for logical channel #0 */</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">data_start</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCP2_LCx_DAT_SHIFT</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCx_DAT_START</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* ISPCCP2_DAT_SIZE for logical channel #0 */</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCP2_LCx_DAT_SHIFT</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCx_DAT_SIZE</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>

	<span class="cm">/* Enable error IRQs for logical channel #0 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_FIFO_OVF_IRQ</span> <span class="o">|</span>
	      <span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_CRC_IRQ</span> <span class="o">|</span>
	      <span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_FSP_IRQ</span> <span class="o">|</span>
	      <span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_FW_IRQ</span> <span class="o">|</span>
	      <span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_FSC_IRQ</span> <span class="o">|</span>
	      <span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_SSC_IRQ</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LC01_IRQSTATUS</span><span class="p">);</span>
	<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LC01_IRQENABLE</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_if_configure - Configure ccp2 with data from sensor</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_if_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">isp_v4l2_subdevs_group</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sensor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ccp2_pwr_cfg</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>

	<span class="n">pad</span> <span class="o">=</span> <span class="n">media_entity_remote_source</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">CCP2_PAD_SINK</span><span class="p">]);</span>
	<span class="n">sensor</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">host_priv</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccp2_phyif_config</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ccp2_vp_config</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">ccp2</span><span class="p">.</span><span class="n">vpclk_div</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">sensor</span><span class="p">,</span> <span class="n">g_skip_top_lines</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lines</span><span class="p">);</span>

	<span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CCP2_PAD_SINK</span><span class="p">];</span>

	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">if_cfg</span><span class="p">.</span><span class="n">data_start</span> <span class="o">=</span> <span class="n">lines</span><span class="p">;</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">if_cfg</span><span class="p">.</span><span class="n">crc</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">.</span><span class="n">ccp2</span><span class="p">.</span><span class="n">crc</span><span class="p">;</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">if_cfg</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">if_cfg</span><span class="p">.</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="n">ccp2_lcx_config</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">if_cfg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_adjust_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">ofmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CCP2_PAD_SOURCE</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">l3_ick</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">l3_ick</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_fract</span> <span class="o">*</span><span class="n">timeperframe</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">vpclk_div</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bound</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">area</span><span class="p">;</span>

	<span class="cm">/* Compute the minimum clock divisor, based on the pipeline maximum</span>
<span class="cm">	 * data rate. This is an absolute lower bound if we don&#39;t want SBL</span>
<span class="cm">	 * overflows, so round the value up.</span>
<span class="cm">	 */</span>
	<span class="n">vpclk_div</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">l3_ick</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_rate</span><span class="p">),</span>
			  <span class="n">vpclk_div</span><span class="p">);</span>

	<span class="cm">/* Compute the maximum clock divisor, based on the requested frame rate.</span>
<span class="cm">	 * This is a soft lower bound to achieve a frame rate equal or higher</span>
<span class="cm">	 * than the requested value, so round the value down.</span>
<span class="cm">	 */</span>
	<span class="n">timeperframe</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">max_timeperframe</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">timeperframe</span><span class="o">-&gt;</span><span class="n">numerator</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">area</span> <span class="o">=</span> <span class="n">ofmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">ofmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="n">bound</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="n">area</span> <span class="o">*</span> <span class="n">timeperframe</span><span class="o">-&gt;</span><span class="n">denominator</span><span class="p">,</span>
				<span class="n">timeperframe</span><span class="o">-&gt;</span><span class="n">numerator</span><span class="p">);</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u64</span><span class="p">,</span> <span class="n">bound</span><span class="p">,</span> <span class="n">l3_ick</span><span class="p">);</span>
		<span class="n">vpclk_div</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">l3_ick</span> <span class="o">/</span> <span class="n">value</span><span class="p">,</span> <span class="n">vpclk_div</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: minimum clock divisor = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">vpclk_div</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">vpclk_div</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_mem_configure - Initialize CCP2 memory input/output interface</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> * @config: Pointer to ISP mem interface config structure</span>
<span class="cm"> *</span>
<span class="cm"> * This will analyze the parameters passed by the interface config</span>
<span class="cm"> * structure, and configure the respective registers for proper</span>
<span class="cm"> * CSI1/CCP2 memory input.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_mem_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">isp_interface_mem_config</span> <span class="o">*</span><span class="n">config</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">sink_pixcode</span> <span class="o">=</span> <span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CCP2_PAD_SINK</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">source_pixcode</span> <span class="o">=</span> <span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CCP2_PAD_SOURCE</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dpcm_decompress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">hwords</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sink_pixcode</span> <span class="o">!=</span> <span class="n">source_pixcode</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sink_pixcode</span> <span class="o">==</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_DPCM8_1X8</span><span class="p">)</span>
		<span class="n">dpcm_decompress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ccp2_pwr_cfg</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>

	<span class="cm">/* Hsize, Skip */</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_HSIZE_SKIP_MIN</span> <span class="o">|</span>
		       <span class="p">(</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">hsize_count</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCP2_LCM_HSIZE_SHIFT</span><span class="p">),</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_HSIZE</span><span class="p">);</span>

	<span class="cm">/* Vsize, no. of lines */</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">vsize_count</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCP2_LCM_VSIZE_SHIFT</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_VSIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">bpl_padding</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">src_ofst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">config</span><span class="o">-&gt;</span><span class="n">src_ofst</span> <span class="o">=</span> <span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">bpl_value</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">config</span><span class="o">-&gt;</span><span class="n">src_ofst</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span>
		       <span class="n">ISPCCP2_LCM_SRC_OFST</span><span class="p">);</span>

	<span class="cm">/* Source and Destination formats */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">ISPCCP2_LCM_CTRL_DST_FORMAT_RAW10</span> <span class="o">&lt;&lt;</span>
	      <span class="n">ISPCCP2_LCM_CTRL_DST_FORMAT_SHIFT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dpcm_decompress</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* source format is RAW8 */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ISPCCP2_LCM_CTRL_SRC_FORMAT_RAW8</span> <span class="o">&lt;&lt;</span>
		       <span class="n">ISPCCP2_LCM_CTRL_SRC_FORMAT_SHIFT</span><span class="p">;</span>

		<span class="cm">/* RAW8 + DPCM10 - simple predictor */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ISPCCP2_LCM_CTRL_SRC_DPCM_PRED</span><span class="p">;</span>

		<span class="cm">/* enable source DPCM decompression */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ISPCCP2_LCM_CTRL_SRC_DECOMPR_DPCM10</span> <span class="o">&lt;&lt;</span>
		       <span class="n">ISPCCP2_LCM_CTRL_SRC_DECOMPR_SHIFT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* source format is RAW10 */</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">ISPCCP2_LCM_CTRL_SRC_FORMAT_RAW10</span> <span class="o">&lt;&lt;</span>
		       <span class="n">ISPCCP2_LCM_CTRL_SRC_FORMAT_SHIFT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Burst size to 32x64 */</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">ISPCCP2_LCM_CTRL_BURST_SIZE_32X</span> <span class="o">&lt;&lt;</span>
	       <span class="n">ISPCCP2_LCM_CTRL_BURST_SIZE_SHIFT</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_CTRL</span><span class="p">);</span>

	<span class="cm">/* Prefetch setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dpcm_decompress</span><span class="p">)</span>
		<span class="n">hwords</span> <span class="o">=</span> <span class="p">(</span><span class="n">ISPCCP2_LCM_HSIZE_SKIP_MIN</span> <span class="o">+</span>
			  <span class="n">config</span><span class="o">-&gt;</span><span class="n">hsize_count</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">hwords</span> <span class="o">=</span> <span class="p">(</span><span class="n">ISPCCP2_LCM_HSIZE_SKIP_MIN</span> <span class="o">+</span>
			  <span class="n">config</span><span class="o">-&gt;</span><span class="n">hsize_count</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">hwords</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCCP2_LCM_PREFETCH_SHIFT</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_PREFETCH</span><span class="p">);</span>

	<span class="cm">/* Video port */</span>
	<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_CTRL</span><span class="p">,</span>
		    <span class="n">ISPCCP2_CTRL_IO_OUT_SEL</span> <span class="o">|</span> <span class="n">ISPCCP2_CTRL_MODE</span><span class="p">);</span>
	<span class="n">ccp2_vp_config</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">ccp2_adjust_bandwidth</span><span class="p">(</span><span class="n">ccp2</span><span class="p">));</span>

	<span class="cm">/* Clear LCM interrupts */</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_IRQSTATUS_OCPERROR_IRQ</span> <span class="o">|</span>
		       <span class="n">ISPCCP2_LCM_IRQSTATUS_EOF_IRQ</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_IRQSTATUS</span><span class="p">);</span>

	<span class="cm">/* Enable LCM interupts */</span>
	<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_IRQENABLE</span><span class="p">,</span>
		    <span class="n">ISPCCP2_LCM_IRQSTATUS_EOF_IRQ</span> <span class="o">|</span>
		    <span class="n">ISPCCP2_LCM_IRQSTATUS_OCPERROR_IRQ</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_set_inaddr - Sets memory address of input frame.</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> * @addr: 32bit memory address aligned on 32byte boundary.</span>
<span class="cm"> *</span>
<span class="cm"> * Configures the memory address from which the input frame is to be read.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_set_inaddr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">u32</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span> <span class="n">ISPCCP2_LCM_SRC_ADDR</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Interrupt handling</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_isr_buffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">;</span>

	<span class="n">buffer</span> <span class="o">=</span> <span class="n">omap3isp_video_buffer_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">ccp2_set_inaddr</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>

	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">ISP_PIPELINE_IDLE_INPUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp_pipeline_ready</span><span class="p">(</span><span class="n">pipe</span><span class="p">))</span>
			<span class="n">omap3isp_pipeline_set_stream</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span>
						<span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccp2_isr - Handle ISP CCP2 interrupts</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> *</span>
<span class="cm"> * This will handle the CCP2 interrupts</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_ccp2_isr</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ISPCCP2_LC01_ERROR</span> <span class="o">=</span>
		<span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_FIFO_OVF_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_CRC_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_FSP_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_FW_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_FSC_IRQ</span> <span class="o">|</span>
		<span class="n">ISPCCP2_LC01_IRQSTATUS_LC0_SSC_IRQ</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lcx_irqstatus</span><span class="p">,</span> <span class="n">lcm_irqstatus</span><span class="p">;</span>

	<span class="cm">/* First clear the interrupts */</span>
	<span class="n">lcx_irqstatus</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span>
				      <span class="n">ISPCCP2_LC01_IRQSTATUS</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">lcx_irqstatus</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span>
		       <span class="n">ISPCCP2_LC01_IRQSTATUS</span><span class="p">);</span>

	<span class="n">lcm_irqstatus</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span>
				      <span class="n">ISPCCP2_LCM_IRQSTATUS</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">lcm_irqstatus</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span><span class="p">,</span>
		       <span class="n">ISPCCP2_LCM_IRQSTATUS</span><span class="p">);</span>
	<span class="cm">/* Errors */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcx_irqstatus</span> <span class="o">&amp;</span> <span class="n">ISPCCP2_LC01_ERROR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCP2 err:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lcx_irqstatus</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lcm_irqstatus</span> <span class="o">&amp;</span> <span class="n">ISPCCP2_LCM_IRQSTATUS_OCPERROR_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCP2 OCP err:%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lcm_irqstatus</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_module_sync_is_stopping</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Handle queued buffers on frame end interrupts */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lcm_irqstatus</span> <span class="o">&amp;</span> <span class="n">ISPCCP2_LCM_IRQSTATUS_EOF_IRQ</span><span class="p">)</span>
		<span class="n">ccp2_isr_buffer</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * V4L2 subdev operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ccp2_fmts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">,</span>
	<span class="n">V4L2_MBUS_FMT_SGRBG10_DPCM8_1X8</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * __ccp2_get_format - helper function for getting ccp2 format</span>
<span class="cm"> * @ccp2  : Pointer to ISP CCP2 device</span>
<span class="cm"> * @fh    : V4L2 subdev file handle</span>
<span class="cm"> * @pad   : pad number</span>
<span class="cm"> * @which : wanted subdev format</span>
<span class="cm"> * return format structure or NULL on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span>
<span class="nf">__ccp2_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">pad</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">pad</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_try_format - Handle try format by pad subdev method</span>
<span class="cm"> * @ccp2  : Pointer to ISP CCP2 device</span>
<span class="cm"> * @fh    : V4L2 subdev file handle</span>
<span class="cm"> * @pad   : pad num</span>
<span class="cm"> * @fmt   : pointer to v4l2 mbus format structure</span>
<span class="cm"> * @which : wanted subdev format</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ccp2_try_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">v4l2_subdev_format_whence</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">pad</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCP2_PAD_SINK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">!=</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_DPCM8_1X8</span><span class="p">)</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCP2_INPUT_SENSOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
					     <span class="n">ISPCCP2_DAT_START_MIN</span><span class="p">,</span>
					     <span class="n">ISPCCP2_DAT_START_MAX</span><span class="p">);</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
					      <span class="n">ISPCCP2_DAT_SIZE_MIN</span><span class="p">,</span>
					      <span class="n">ISPCCP2_DAT_SIZE_MAX</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCP2_INPUT_MEMORY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span>
					     <span class="n">ISPCCP2_LCM_HSIZE_COUNT_MIN</span><span class="p">,</span>
					     <span class="n">ISPCCP2_LCM_HSIZE_COUNT_MAX</span><span class="p">);</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
					      <span class="n">ISPCCP2_LCM_VSIZE_MIN</span><span class="p">,</span>
					      <span class="n">ISPCCP2_LCM_VSIZE_MAX</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCP2_PAD_SOURCE</span>:
		<span class="cm">/* Source format - copy sink format and change pixel code</span>
<span class="cm">		 * to SGRBG10_1X10 as we don&#39;t support CCP2 write to memory.</span>
<span class="cm">		 * When CCP2 write to memory feature will be added this</span>
<span class="cm">		 * should be changed properly.</span>
<span class="cm">		 */</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">__ccp2_get_format</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCP2_PAD_SINK</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">fmt</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">fmt</span><span class="p">));</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_enum_mbus_code - Handle pixel format enumeration</span>
<span class="cm"> * @sd     : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh     : V4L2 subdev file handle</span>
<span class="cm"> * @code   : pointer to v4l2_subdev_mbus_code_enum structure</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_enum_mbus_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_subdev_mbus_code_enum</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">CCP2_PAD_SINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ccp2_fmts</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">ccp2_fmts</span><span class="p">[</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">format</span> <span class="o">=</span> <span class="n">__ccp2_get_format</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCP2_PAD_SINK</span><span class="p">,</span>
					      <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
		<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_enum_frame_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">v4l2_subdev_frame_size_enum</span> <span class="o">*</span><span class="n">fse</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">format</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fse</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ccp2_try_format</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_width</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">min_height</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">!=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ccp2_try_format</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fse</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">);</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_width</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fse</span><span class="o">-&gt;</span><span class="n">max_height</span> <span class="o">=</span> <span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_get_format - Handle get format by pads subdev method</span>
<span class="cm"> * @sd    : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh    : V4L2 subdev file handle</span>
<span class="cm"> * @fmt   : pointer to v4l2 subdev format structure</span>
<span class="cm"> * return -EINVAL or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__ccp2_get_format</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_set_format - Handle set format by pads subdev method</span>
<span class="cm"> * @sd    : pointer to v4l2 subdev structure</span>
<span class="cm"> * @fh    : V4L2 subdev file handle</span>
<span class="cm"> * @fmt   : pointer to v4l2 subdev format structure</span>
<span class="cm"> * returns zero</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

	<span class="n">format</span> <span class="o">=</span> <span class="n">__ccp2_get_format</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ccp2_try_format</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>

	<span class="cm">/* Propagate the format from sink to source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">CCP2_PAD_SINK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">__ccp2_get_format</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCP2_PAD_SOURCE</span><span class="p">,</span>
					   <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
		<span class="o">*</span><span class="n">format</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">;</span>
		<span class="n">ccp2_try_format</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">CCP2_PAD_SOURCE</span><span class="p">,</span> <span class="n">format</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_init_formats - Initialize formats on all pads</span>
<span class="cm"> * @sd: ISP CCP2 V4L2 subdevice</span>
<span class="cm"> * @fh: V4L2 subdev file handle</span>
<span class="cm"> *</span>
<span class="cm"> * Initialize all pad formats with default values. If fh is not NULL, try</span>
<span class="cm"> * formats are initialized on the file handle. Otherwise active formats are</span>
<span class="cm"> * initialized on the device.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_init_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="n">format</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">format</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">format</span><span class="p">));</span>
	<span class="n">format</span><span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="n">CCP2_PAD_SINK</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">which</span> <span class="o">=</span> <span class="n">fh</span> <span class="o">?</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span> <span class="o">:</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">format</span><span class="p">.</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="mi">4096</span><span class="p">;</span>
	<span class="n">ccp2_set_format</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_s_stream - Enable/Disable streaming on ccp2 subdev</span>
<span class="cm"> * @sd    : pointer to v4l2 subdev structure</span>
<span class="cm"> * @enable: 1 == Enable, 0 == Disable</span>
<span class="cm"> * return zero</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">to_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">enable</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_CONTINUOUS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_csiphy_acquire</span><span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ccp2_if_configure</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
		<span class="n">ccp2_print_status</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>

		<span class="cm">/* Enable CSI1/CCP2 interface */</span>
		<span class="n">ccp2_if_enable</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">format</span><span class="p">;</span>

			<span class="n">format</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">formats</span><span class="p">[</span><span class="n">CCP2_PAD_SINK</span><span class="p">];</span>

			<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">mem_cfg</span><span class="p">.</span><span class="n">hsize_count</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
			<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">mem_cfg</span><span class="p">.</span><span class="n">vsize_count</span> <span class="o">=</span> <span class="n">format</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
			<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">mem_cfg</span><span class="p">.</span><span class="n">src_ofst</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">ccp2_mem_configure</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">mem_cfg</span><span class="p">);</span>
			<span class="n">omap3isp_sbl_enable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_CSI1_READ</span><span class="p">);</span>
			<span class="n">ccp2_print_status</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ccp2_mem_enable</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_module_sync_idle</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">stopping</span><span class="p">))</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: module stop timeout.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCP2_INPUT_MEMORY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ccp2_mem_enable</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">omap3isp_sbl_disable</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_SBL_CSI1_READ</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCP2_INPUT_SENSOR</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Disable CSI1/CCP2 interface */</span>
			<span class="n">ccp2_if_enable</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">)</span>
				<span class="n">omap3isp_csiphy_release</span><span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">enable</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* subdev video operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">ccp2_sd_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span> <span class="o">=</span> <span class="n">ccp2_s_stream</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* subdev pad operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_pad_ops</span> <span class="n">ccp2_sd_pad_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enum_mbus_code</span> <span class="o">=</span> <span class="n">ccp2_enum_mbus_code</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_frame_size</span> <span class="o">=</span> <span class="n">ccp2_enum_frame_size</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fmt</span> <span class="o">=</span> <span class="n">ccp2_get_format</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span> <span class="o">=</span> <span class="n">ccp2_set_format</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* subdev operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">ccp2_sd_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccp2_sd_video_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccp2_sd_pad_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* subdev internal operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_internal_ops</span> <span class="n">ccp2_sd_internal_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">ccp2_init_formats</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm"> * ISP ccp2 video device node</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_video_queue - Queue video buffer.</span>
<span class="cm"> * @video : Pointer to isp video structure</span>
<span class="cm"> * @buffer: Pointer to isp_buffer structure</span>
<span class="cm"> * return -EIO or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_video_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_video</span> <span class="o">*</span><span class="n">video</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp_buffer</span> <span class="o">*</span><span class="n">buffer</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">;</span>

	<span class="n">ccp2_set_inaddr</span><span class="p">(</span><span class="n">ccp2</span><span class="p">,</span> <span class="n">buffer</span><span class="o">-&gt;</span><span class="n">isp_addr</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">isp_video_operations</span> <span class="n">ccp2_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">queue</span> <span class="o">=</span> <span class="n">ccp2_video_queue</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Media entity operations</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_link_setup - Setup ccp2 connections.</span>
<span class="cm"> * @entity : Pointer to media entity structure</span>
<span class="cm"> * @local  : Pointer to local pad array</span>
<span class="cm"> * @remote : Pointer to remote pad array</span>
<span class="cm"> * @flags  : Link flags</span>
<span class="cm"> * return -EINVAL on error or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_link_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">local</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">remote</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">local</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">|</span> <span class="n">media_entity_type</span><span class="p">(</span><span class="n">remote</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCP2_PAD_SINK</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_DEVNODE</span>:
		<span class="cm">/* read from memory */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCP2_INPUT_SENSOR</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCP2_INPUT_MEMORY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCP2_INPUT_MEMORY</span><span class="p">)</span>
				<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCP2_INPUT_NONE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCP2_PAD_SINK</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span>:
		<span class="cm">/* read from sensor/phy */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCP2_INPUT_MEMORY</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCP2_INPUT_SENSOR</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">==</span> <span class="n">CCP2_INPUT_SENSOR</span><span class="p">)</span>
				<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCP2_INPUT_NONE</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCP2_PAD_SOURCE</span> <span class="o">|</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span>:
		<span class="cm">/* write to video port/ccdc */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">)</span>
			<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">CCP2_OUTPUT_CCDC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">CCP2_OUTPUT_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* media operations */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">media_entity_operations</span> <span class="n">ccp2_media_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">link_setup</span> <span class="o">=</span> <span class="n">ccp2_link_setup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">link_validate</span> <span class="o">=</span> <span class="n">v4l2_subdev_link_validate</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccp2_unregister_entities - Unregister media entities: subdev</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_ccp2_unregister_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="n">omap3isp_video_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccp2_register_entities - Register the subdev media entity</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> * @vdev: Pointer to v4l device</span>
<span class="cm"> * return negative error code or zero on success</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">omap3isp_ccp2_register_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Register the subdev and video nodes. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">,</span> <span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">omap3isp_ccp2_unregister_entities</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * ISP ccp2 initialisation and cleanup</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * ccp2_init_entities - Initialize ccp2 subdev and media entity.</span>
<span class="cm"> * @ccp2: Pointer to ISP CCP2 device</span>
<span class="cm"> * return negative error code or zero on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ccp2_init_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pads</span> <span class="o">=</span> <span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">CCP2_INPUT_NONE</span><span class="p">;</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">output</span> <span class="o">=</span> <span class="n">CCP2_OUTPUT_NONE</span><span class="p">;</span>

	<span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ccp2_sd_ops</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">internal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccp2_sd_internal_ops</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;OMAP3 ISP CCP2&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">grp_id</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>   <span class="cm">/* group ID for isp subdevs */</span>
	<span class="n">v4l2_set_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">ccp2</span><span class="p">);</span>
	<span class="n">sd</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_HAS_DEVNODE</span><span class="p">;</span>

	<span class="n">pads</span><span class="p">[</span><span class="n">CCP2_PAD_SINK</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SINK</span><span class="p">;</span>
	<span class="n">pads</span><span class="p">[</span><span class="n">CCP2_PAD_SOURCE</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>

	<span class="n">me</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccp2_media_ops</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_init</span><span class="p">(</span><span class="n">me</span><span class="p">,</span> <span class="n">CCP2_PADS_NUM</span><span class="p">,</span> <span class="n">pads</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ccp2_init_formats</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The CCP2 has weird line alignment requirements, possibly caused by</span>
<span class="cm">	 * DPCM8 decompression. Line length for data read from memory must be a</span>
<span class="cm">	 * multiple of 128 bits (16 bytes) in continuous mode (when no padding</span>
<span class="cm">	 * is present at end of lines). Additionally, if padding is used, the</span>
<span class="cm">	 * padded line length must be a multiple of 32 bytes. To simplify the</span>
<span class="cm">	 * implementation we use a fixed 32 bytes alignment regardless of the</span>
<span class="cm">	 * input format and width. If strict 128 bits alignment support is</span>
<span class="cm">	 * required ispvideo will need to be made aware of this special dual</span>
<span class="cm">	 * alignement requirements.</span>
<span class="cm">	 */</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">bpl_alignment</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">bpl_max</span> <span class="o">=</span> <span class="mh">0xffffffe0</span><span class="p">;</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">isp</span> <span class="o">=</span> <span class="n">to_isp_device</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ccp2_video_ops</span><span class="p">;</span>
	<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">capture_mem</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="mi">4096</span> <span class="o">*</span> <span class="mi">4096</span><span class="p">)</span> <span class="o">*</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_video_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">,</span> <span class="s">&quot;CCP2&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_video</span><span class="p">;</span>

	<span class="cm">/* Connect the video node to the ccp2 subdev. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">.</span><span class="n">video</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCP2_PAD_SINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_link:</span>
	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">);</span>
<span class="nl">error_video:</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccp2_init - CCP2 initialization.</span>
<span class="cm"> * @isp : Pointer to ISP device</span>
<span class="cm"> * return negative error code or zero on success</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_ccp2_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * On the OMAP34xx the CSI1 receiver is operated in the CSIb IO</span>
<span class="cm">	 * complex, which is powered by vdds_csib power rail. Hence the</span>
<span class="cm">	 * request for the regulator.</span>
<span class="cm">	 *</span>
<span class="cm">	 * On the OMAP36xx, the CCP2 uses the CSI PHY1 or PHY2, shared with</span>
<span class="cm">	 * the CSI2c or CSI2a receivers. The PHY then needs to be explicitly</span>
<span class="cm">	 * configured.</span>
<span class="cm">	 *</span>
<span class="cm">	 * TODO: Don&#39;t hardcode the usage of PHY1 (shared with CSI2c).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_2_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">vdds_csib</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vdds_csib&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">vdds_csib</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;Could not get regulator vdds_csib</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">vdds_csib</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csiphy1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ccp2_init_entities</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">vdds_csib</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ccp2_reset</span><span class="p">(</span><span class="n">ccp2</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_ccp2_cleanup - CCP2 un-initialization</span>
<span class="cm"> * @isp : Pointer to ISP device</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_ccp2_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_ccp2_device</span> <span class="o">*</span><span class="n">ccp2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">;</span>

	<span class="n">omap3isp_video_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">video_in</span><span class="p">);</span>
	<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>

	<span class="n">regulator_put</span><span class="p">(</span><span class="n">ccp2</span><span class="o">-&gt;</span><span class="n">vdds_csib</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
