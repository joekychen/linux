<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › omap3isp › isp.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>isp.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * isp.c</span>
<span class="cm"> *</span>
<span class="cm"> * TI OMAP3 ISP - Core</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2006-2010 Nokia Corporation</span>
<span class="cm"> * Copyright (C) 2007-2009 Texas Instruments, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Contacts: Laurent Pinchart &lt;laurent.pinchart@ideasonboard.com&gt;</span>
<span class="cm"> *	     Sakari Ailus &lt;sakari.ailus@iki.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Contributors:</span>
<span class="cm"> *	Laurent Pinchart &lt;laurent.pinchart@ideasonboard.com&gt;</span>
<span class="cm"> *	Sakari Ailus &lt;sakari.ailus@iki.fi&gt;</span>
<span class="cm"> *	David Cohen &lt;dacohen@gmail.com&gt;</span>
<span class="cm"> *	Stanimir Varbanov &lt;svarbanov@mm-sol.com&gt;</span>
<span class="cm"> *	Vimarsh Zutshi &lt;vimarsh.zutshi@gmail.com&gt;</span>
<span class="cm"> *	Tuukka Toivonen &lt;tuukkat76@gmail.com&gt;</span>
<span class="cm"> *	Sergio Aguirre &lt;saaguirre@ti.com&gt;</span>
<span class="cm"> *	Antti Koskipaa &lt;akoskipa@gmail.com&gt;</span>
<span class="cm"> *	Ivan T. Ivanov &lt;iivanov@mm-sol.com&gt;</span>
<span class="cm"> *	RaniSuneela &lt;r-m@ti.com&gt;</span>
<span class="cm"> *	Atanas Filipov &lt;afilipov@mm-sol.com&gt;</span>
<span class="cm"> *	Gjorgji Rosikopulos &lt;grosikopulos@mm-sol.com&gt;</span>
<span class="cm"> *	Hiroshi DOYU &lt;hiroshi.doyu@nokia.com&gt;</span>
<span class="cm"> *	Nayden Kanchev &lt;nkanchev@mm-sol.com&gt;</span>
<span class="cm"> *	Phil Carmody &lt;ext-phil.2.carmody@nokia.com&gt;</span>
<span class="cm"> *	Artem Bityutskiy &lt;artem.bityutskiy@nokia.com&gt;</span>
<span class="cm"> *	Dominic Curran &lt;dcurran@ti.com&gt;</span>
<span class="cm"> *	Ilkka Myllyperkio &lt;ilkka.myllyperkio@sofica.fi&gt;</span>
<span class="cm"> *	Pallavi Kulkarni &lt;p-kulkarni@ti.com&gt;</span>
<span class="cm"> *	Vaibhav Hiremath &lt;hvaibhav@ti.com&gt;</span>
<span class="cm"> *	Mohit Jalori &lt;mjalori@ti.com&gt;</span>
<span class="cm"> *	Sameer Venkatraman &lt;sameerv@ti.com&gt;</span>
<span class="cm"> *	Senthilvadivu Guruswamy &lt;svadivu@ti.com&gt;</span>
<span class="cm"> *	Thara Gopinath &lt;thara@ti.com&gt;</span>
<span class="cm"> *	Toni Leinonen &lt;toni.leinonen@nokia.com&gt;</span>
<span class="cm"> *	Troy Laramy &lt;t-laramy@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>

<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>

<span class="cp">#include &quot;isp.h&quot;</span>
<span class="cp">#include &quot;ispreg.h&quot;</span>
<span class="cp">#include &quot;ispccdc.h&quot;</span>
<span class="cp">#include &quot;isppreview.h&quot;</span>
<span class="cp">#include &quot;ispresizer.h&quot;</span>
<span class="cp">#include &quot;ispcsi2.h&quot;</span>
<span class="cp">#include &quot;ispccp2.h&quot;</span>
<span class="cp">#include &quot;isph3a.h&quot;</span>
<span class="cp">#include &quot;isphist.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">autoidle</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">autoidle</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">autoidle</span><span class="p">,</span> <span class="s">&quot;Enable OMAP3ISP AUTOIDLE support&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">isp_save_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">isp_restore_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">isp_res_mapping</span> <span class="n">isp_res_maps</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">isp_rev</span> <span class="o">=</span> <span class="n">ISP_REVISION_2_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_HIST</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_H3A</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_PREV</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CSI2A_REGS1</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CSIPHY2</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">isp_rev</span> <span class="o">=</span> <span class="n">ISP_REVISION_15_0</span><span class="p">,</span>
		<span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CCP2</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CCDC</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_HIST</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_H3A</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_PREV</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_RESZ</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CSI2A_REGS1</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CSIPHY2</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CSI2A_REGS2</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CSI2C_REGS1</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CSIPHY1</span> <span class="o">|</span>
		       <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">OMAP3_ISP_IOMEM_CSI2C_REGS2</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Structure for saving/restoring ISP module registers */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">isp_reg</span> <span class="n">isp_reg_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_SYSCONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_TCTRL_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="n">ISP_TOK_TERM</span><span class="p">,</span> <span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_flush - Post pending L3 bus writes by doing a register readback</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> *</span>
<span class="cm"> * In order to force posting of pending writes, we need to write and</span>
<span class="cm"> * readback the same register, in this case the revision register.</span>
<span class="cm"> *</span>
<span class="cm"> * See this link for reference:</span>
<span class="cm"> *   http://www.mail-archive.com/linux-omap@vger.kernel.org/msg08149.html</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_REVISION</span><span class="p">);</span>
	<span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_REVISION</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_enable_interrupts - Enable ISP interrupts.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_enable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">irq</span> <span class="o">=</span> <span class="n">IRQ0ENABLE_CSIA_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_CSIB_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_CCDC_LSC_PREF_ERR_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_CCDC_LSC_DONE_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_CCDC_VD0_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_CCDC_VD1_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_HS_VS_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_HIST_DONE_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_H3A_AWB_DONE_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_H3A_AF_DONE_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_PRV_DONE_IRQ</span>
			     <span class="o">|</span> <span class="n">IRQ0ENABLE_RSZ_DONE_IRQ</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_IRQ0STATUS</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">irq</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_IRQ0ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_disable_interrupts - Disable ISP interrupts.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_disable_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_IRQ0ENABLE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * isp_set_xclk - Configures the specified cam_xclk to the desired frequency.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> * @xclk: Desired frequency of the clock in Hz. 0 = stable low, 1 is stable high</span>
<span class="cm"> * @xclksel: XCLK to configure (0 = A, 1 = B).</span>
<span class="cm"> *</span>
<span class="cm"> * Configures the specified MCLK divisor in the ISP timing control register</span>
<span class="cm"> * (TCTRL_CTRL) to generate the desired xclk clock value.</span>
<span class="cm"> *</span>
<span class="cm"> * Divisor = cam_mclk_hz / xclk</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the final frequency that is actually being generated</span>
<span class="cm"> **/</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">isp_set_xclk</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">xclk</span><span class="p">,</span> <span class="n">u8</span> <span class="n">xclksel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">divisor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">currentxclk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mclk_hz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">omap3isp_get</span><span class="p">(</span><span class="n">isp</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mclk_hz</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CAM_MCLK</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xclk</span> <span class="o">&gt;=</span> <span class="n">mclk_hz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="n">ISPTCTRL_CTRL_DIV_BYPASS</span><span class="p">;</span>
		<span class="n">currentxclk</span> <span class="o">=</span> <span class="n">mclk_hz</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">xclk</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="n">mclk_hz</span> <span class="o">/</span> <span class="n">xclk</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">&gt;=</span> <span class="n">ISPTCTRL_CTRL_DIV_BYPASS</span><span class="p">)</span>
			<span class="n">divisor</span> <span class="o">=</span> <span class="n">ISPTCTRL_CTRL_DIV_BYPASS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">currentxclk</span> <span class="o">=</span> <span class="n">mclk_hz</span> <span class="o">/</span> <span class="n">divisor</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="n">xclk</span><span class="p">;</span>
		<span class="n">currentxclk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">xclksel</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ISP_XCLK_A</span>:
		<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_TCTRL_CTRL</span><span class="p">,</span>
				<span class="n">ISPTCTRL_CTRL_DIVA_MASK</span><span class="p">,</span>
				<span class="n">divisor</span> <span class="o">&lt;&lt;</span> <span class="n">ISPTCTRL_CTRL_DIVA_SHIFT</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isp_set_xclk(): cam_xclka set to %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">currentxclk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP_XCLK_B</span>:
		<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_TCTRL_CTRL</span><span class="p">,</span>
				<span class="n">ISPTCTRL_CTRL_DIVB_MASK</span><span class="p">,</span>
				<span class="n">divisor</span> <span class="o">&lt;&lt;</span> <span class="n">ISPTCTRL_CTRL_DIVB_SHIFT</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;isp_set_xclk(): cam_xclkb set to %d Hz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">currentxclk</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ISP_XCLK_NONE</span>:
	<span class="nl">default:</span>
		<span class="n">omap3isp_put</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ISP_ERR: isp_set_xclk(): Invalid requested &quot;</span>
			<span class="s">&quot;xclk. Must be 0 (A) or 1 (B).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Do we go from stable whatever to clock? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">xclk_divisor</span><span class="p">[</span><span class="n">xclksel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">omap3isp_get</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="cm">/* Stopping the clock. */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">xclk_divisor</span><span class="p">[</span><span class="n">xclksel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">omap3isp_put</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">xclk_divisor</span><span class="p">[</span><span class="n">xclksel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="n">omap3isp_put</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">currentxclk</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_power_settings - Sysconfig settings, for Power Management.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> * @idle: Consider idle state.</span>
<span class="cm"> *</span>
<span class="cm"> * Sets the power settings for the ISP, and SBL bus.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_power_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idle</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span>
		       <span class="p">((</span><span class="n">idle</span> <span class="o">?</span> <span class="n">ISP_SYSCONFIG_MIDLEMODE_SMARTSTANDBY</span> <span class="o">:</span>
				<span class="n">ISP_SYSCONFIG_MIDLEMODE_FORCESTANDBY</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
			<span class="n">ISP_SYSCONFIG_MIDLEMODE_SHIFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">ISP_REVISION_15_0</span><span class="p">)</span> <span class="o">?</span>
			  <span class="n">ISP_SYSCONFIG_AUTOIDLE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_SYSCONFIG</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">autoidle</span><span class="p">)</span>
		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ISPCTRL_SBL_AUTOIDLE</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span>
			       <span class="n">ISP_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Configure the bridge and lane shifter. Valid inputs are</span>
<span class="cm"> *</span>
<span class="cm"> * CCDC_INPUT_PARALLEL: Parallel interface</span>
<span class="cm"> * CCDC_INPUT_CSI2A: CSI2a receiver</span>
<span class="cm"> * CCDC_INPUT_CCP2B: CCP2b receiver</span>
<span class="cm"> * CCDC_INPUT_CSI2C: CSI2c receiver</span>
<span class="cm"> *</span>
<span class="cm"> * The bridge and lane shifter are configured according to the selected input</span>
<span class="cm"> * and the ISP platform data.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_configure_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">ccdc_input_entity</span> <span class="n">input</span><span class="p">,</span>
			       <span class="k">const</span> <span class="k">struct</span> <span class="n">isp_parallel_platform_data</span> <span class="o">*</span><span class="n">pdata</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">shift</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ispctrl_val</span><span class="p">;</span>

	<span class="n">ispctrl_val</span>  <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_CTRL</span><span class="p">);</span>
	<span class="n">ispctrl_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCTRL_SHIFT_MASK</span><span class="p">;</span>
	<span class="n">ispctrl_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCTRL_PAR_CLK_POL_INV</span><span class="p">;</span>
	<span class="n">ispctrl_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCTRL_PAR_SER_CLK_SEL_MASK</span><span class="p">;</span>
	<span class="n">ispctrl_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCTRL_PAR_BRIDGE_MASK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">input</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CCDC_INPUT_PARALLEL</span>:
		<span class="n">ispctrl_val</span> <span class="o">|=</span> <span class="n">ISPCTRL_PAR_SER_CLK_SEL_PARALLEL</span><span class="p">;</span>
		<span class="n">ispctrl_val</span> <span class="o">|=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">clk_pol</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCTRL_PAR_CLK_POL_SHIFT</span><span class="p">;</span>
		<span class="n">ispctrl_val</span> <span class="o">|=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">bridge</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCTRL_PAR_BRIDGE_SHIFT</span><span class="p">;</span>
		<span class="n">shift</span> <span class="o">+=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">data_lane_shift</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_INPUT_CSI2A</span>:
		<span class="n">ispctrl_val</span> <span class="o">|=</span> <span class="n">ISPCTRL_PAR_SER_CLK_SEL_CSIA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_INPUT_CCP2B</span>:
		<span class="n">ispctrl_val</span> <span class="o">|=</span> <span class="n">ISPCTRL_PAR_SER_CLK_SEL_CSIB</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CCDC_INPUT_CSI2C</span>:
		<span class="n">ispctrl_val</span> <span class="o">|=</span> <span class="n">ISPCTRL_PAR_SER_CLK_SEL_CSIC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ispctrl_val</span> <span class="o">|=</span> <span class="p">((</span><span class="n">shift</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">ISPCTRL_SHIFT_SHIFT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">ISPCTRL_SHIFT_MASK</span><span class="p">;</span>

	<span class="n">ispctrl_val</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPCTRL_SYNC_DETECT_MASK</span><span class="p">;</span>
	<span class="n">ispctrl_val</span> <span class="o">|=</span> <span class="n">ISPCTRL_SYNC_DETECT_VSRISE</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">ispctrl_val</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_CTRL</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3isp_hist_dma_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_ccdc_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">omap3isp_stat_pcr_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Histogram cannot be enabled in this frame anymore */</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">.</span><span class="n">buf_err</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hist: Out of synchronization with &quot;</span>
				  <span class="s">&quot;CCDC. Ignoring next buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">isp_isr_dbg</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="n">u32</span> <span class="n">irqstatus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;CSIA_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;res1&quot;</span><span class="p">,</span>
		<span class="s">&quot;res2&quot;</span><span class="p">,</span>
		<span class="s">&quot;CSIB_LCM_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;CSIB_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;res5&quot;</span><span class="p">,</span>
		<span class="s">&quot;res6&quot;</span><span class="p">,</span>
		<span class="s">&quot;res7&quot;</span><span class="p">,</span>
		<span class="s">&quot;CCDC_VD0_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;CCDC_VD1_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;CCDC_VD2_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;CCDC_ERR_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;H3A_AF_DONE_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;H3A_AWB_DONE_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;res14&quot;</span><span class="p">,</span>
		<span class="s">&quot;res15&quot;</span><span class="p">,</span>
		<span class="s">&quot;HIST_DONE_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;CCDC_LSC_DONE&quot;</span><span class="p">,</span>
		<span class="s">&quot;CCDC_LSC_PREFETCH_COMPLETED&quot;</span><span class="p">,</span>
		<span class="s">&quot;CCDC_LSC_PREFETCH_ERROR&quot;</span><span class="p">,</span>
		<span class="s">&quot;PRV_DONE_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;CBUFF_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;res22&quot;</span><span class="p">,</span>
		<span class="s">&quot;res23&quot;</span><span class="p">,</span>
		<span class="s">&quot;RSZ_DONE_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;OVF_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;res26&quot;</span><span class="p">,</span>
		<span class="s">&quot;res27&quot;</span><span class="p">,</span>
		<span class="s">&quot;MMU_ERR_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;OCP_ERR_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;SEC_ERR_IRQ&quot;</span><span class="p">,</span>
		<span class="s">&quot;HS_VS_IRQ&quot;</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ISP IRQ: &quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">name</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">irqstatus</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_isr_sbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sbl_pcr</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle shared buffer logic overflows for video buffers.</span>
<span class="cm">	 * ISPSBL_PCR_CCDCPRV_2_RSZ_OVF can be safely ignored.</span>
<span class="cm">	 */</span>
	<span class="n">sbl_pcr</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span><span class="p">,</span> <span class="n">ISPSBL_PCR</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">sbl_pcr</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_SBL</span><span class="p">,</span> <span class="n">ISPSBL_PCR</span><span class="p">);</span>
	<span class="n">sbl_pcr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ISPSBL_PCR_CCDCPRV_2_RSZ_OVF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbl_pcr</span><span class="p">)</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;SBL overflow (PCR = 0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sbl_pcr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbl_pcr</span> <span class="o">&amp;</span> <span class="n">ISPSBL_PCR_CSIB_WBL_OVF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbl_pcr</span> <span class="o">&amp;</span> <span class="n">ISPSBL_PCR_CSIA_WBL_OVF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbl_pcr</span> <span class="o">&amp;</span> <span class="n">ISPSBL_PCR_CCDC_WBL_OVF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbl_pcr</span> <span class="o">&amp;</span> <span class="n">ISPSBL_PCR_PRV_WBL_OVF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbl_pcr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ISPSBL_PCR_RSZ1_WBL_OVF</span>
		       <span class="o">|</span> <span class="n">ISPSBL_PCR_RSZ2_WBL_OVF</span>
		       <span class="o">|</span> <span class="n">ISPSBL_PCR_RSZ3_WBL_OVF</span>
		       <span class="o">|</span> <span class="n">ISPSBL_PCR_RSZ4_WBL_OVF</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbl_pcr</span> <span class="o">&amp;</span> <span class="n">ISPSBL_PCR_H3A_AF_WBL_OVF</span><span class="p">)</span>
		<span class="n">omap3isp_stat_sbl_overflow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sbl_pcr</span> <span class="o">&amp;</span> <span class="n">ISPSBL_PCR_H3A_AEAWB_WBL_OVF</span><span class="p">)</span>
		<span class="n">omap3isp_stat_sbl_overflow</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_isr - Interrupt Service Routine for Camera ISP module.</span>
<span class="cm"> * @irq: Not used currently.</span>
<span class="cm"> * @_isp: Pointer to the OMAP3 ISP device</span>
<span class="cm"> *</span>
<span class="cm"> * Handles the corresponding callback if plugged in.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ_HANDLED when IRQ was correctly handled, or IRQ_NONE when the</span>
<span class="cm"> * IRQ wasn&#39;t handled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">isp_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">_isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">ccdc_events</span> <span class="o">=</span> <span class="n">IRQ0STATUS_CCDC_LSC_PREF_ERR_IRQ</span> <span class="o">|</span>
				       <span class="n">IRQ0STATUS_CCDC_LSC_DONE_IRQ</span> <span class="o">|</span>
				       <span class="n">IRQ0STATUS_CCDC_VD0_IRQ</span> <span class="o">|</span>
				       <span class="n">IRQ0STATUS_CCDC_VD1_IRQ</span> <span class="o">|</span>
				       <span class="n">IRQ0STATUS_HS_VS_IRQ</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">_isp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">irqstatus</span><span class="p">;</span>

	<span class="n">irqstatus</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_IRQ0STATUS</span><span class="p">);</span>
	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_IRQ0STATUS</span><span class="p">);</span>

	<span class="n">isp_isr_sbl</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_CSIA_IRQ</span><span class="p">)</span>
		<span class="n">omap3isp_csi2_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_CSIB_IRQ</span><span class="p">)</span>
		<span class="n">omap3isp_ccp2_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_CCDC_VD0_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_PREVIEW</span><span class="p">)</span>
			<span class="n">omap3isp_preview_isr_frame_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">CCDC_OUTPUT_RESIZER</span><span class="p">)</span>
			<span class="n">omap3isp_resizer_isr_frame_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">);</span>
		<span class="n">omap3isp_stat_isr_frame_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">);</span>
		<span class="n">omap3isp_stat_isr_frame_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">);</span>
		<span class="n">omap3isp_stat_isr_frame_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">ccdc_events</span><span class="p">)</span>
		<span class="n">omap3isp_ccdc_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">,</span> <span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">ccdc_events</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_PRV_DONE_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">.</span><span class="n">output</span> <span class="o">&amp;</span> <span class="n">PREVIEW_OUTPUT_RESIZER</span><span class="p">)</span>
			<span class="n">omap3isp_resizer_isr_frame_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">);</span>
		<span class="n">omap3isp_preview_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_RSZ_DONE_IRQ</span><span class="p">)</span>
		<span class="n">omap3isp_resizer_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_H3A_AWB_DONE_IRQ</span><span class="p">)</span>
		<span class="n">omap3isp_stat_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_H3A_AF_DONE_IRQ</span><span class="p">)</span>
		<span class="n">omap3isp_stat_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqstatus</span> <span class="o">&amp;</span> <span class="n">IRQ0STATUS_HIST_DONE_IRQ</span><span class="p">)</span>
		<span class="n">omap3isp_stat_isr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">);</span>

	<span class="n">omap3isp_flush</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

<span class="cp">#if defined(DEBUG) &amp;&amp; defined(ISP_ISR_DEBUG)</span>
	<span class="n">isp_isr_dbg</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">irqstatus</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Pipeline power management</span>
<span class="cm"> *</span>
<span class="cm"> * Entities must be powered up when part of a pipeline that contains at least</span>
<span class="cm"> * one open video device node.</span>
<span class="cm"> *</span>
<span class="cm"> * To achieve this use the entity use_count field to track the number of users.</span>
<span class="cm"> * For entities corresponding to video device nodes the use_count field stores</span>
<span class="cm"> * the users count of the node. For entities corresponding to subdevs the</span>
<span class="cm"> * use_count field stores the total number of users of all video device nodes</span>
<span class="cm"> * in the pipeline.</span>
<span class="cm"> *</span>
<span class="cm"> * The omap3isp_pipeline_pm_use() function must be called in the open() and</span>
<span class="cm"> * close() handlers of video device nodes. It increments or decrements the use</span>
<span class="cm"> * count of all subdev entities in the pipeline.</span>
<span class="cm"> *</span>
<span class="cm"> * To react to link management on powered pipelines, the link setup notification</span>
<span class="cm"> * callback updates the use count of all entities in the source and sink sides</span>
<span class="cm"> * of the link.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * isp_pipeline_pm_use_count - Count the number of users of a pipeline</span>
<span class="cm"> * @entity: The entity</span>
<span class="cm"> *</span>
<span class="cm"> * Return the total number of users of all video device nodes in the pipeline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_pm_use_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">media_entity_graph</span> <span class="n">graph</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">use</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">media_entity_graph_walk_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">entity</span> <span class="o">=</span> <span class="n">media_entity_graph_walk_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">media_entity_type</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">==</span> <span class="n">MEDIA_ENT_T_DEVNODE</span><span class="p">)</span>
			<span class="n">use</span> <span class="o">+=</span> <span class="n">entity</span><span class="o">-&gt;</span><span class="n">use_count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">use</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_pipeline_pm_power_one - Apply power change to an entity</span>
<span class="cm"> * @entity: The entity</span>
<span class="cm"> * @change: Use count change</span>
<span class="cm"> *</span>
<span class="cm"> * Change the entity use count by @change. If the entity is a subdev update its</span>
<span class="cm"> * power state by calling the core::s_power operation when the use count goes</span>
<span class="cm"> * from 0 to != 0 or from != 0 to 0.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_pm_power_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">change</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">subdev</span> <span class="o">=</span> <span class="n">media_entity_type</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">==</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span>
	       <span class="o">?</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">change</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">subdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_power</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">entity</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">+=</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">change</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">subdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_power</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_pipeline_pm_power - Apply power change to all entities in a pipeline</span>
<span class="cm"> * @entity: The entity</span>
<span class="cm"> * @change: Use count change</span>
<span class="cm"> *</span>
<span class="cm"> * Walk the pipeline to update the use count and the power state of all non-node</span>
<span class="cm"> * entities.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code on failure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_pm_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">change</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">media_entity_graph</span> <span class="n">graph</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">first</span> <span class="o">=</span> <span class="n">entity</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">change</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">media_entity_graph_walk_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph</span><span class="p">,</span> <span class="n">entity</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">entity</span> <span class="o">=</span> <span class="n">media_entity_graph_walk_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph</span><span class="p">)))</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">media_entity_type</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MEDIA_ENT_T_DEVNODE</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_pipeline_pm_power_one</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">change</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">media_entity_graph_walk_start</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">first</span> <span class="o">=</span> <span class="n">media_entity_graph_walk_next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">graph</span><span class="p">))</span>
	       <span class="o">&amp;&amp;</span> <span class="n">first</span> <span class="o">!=</span> <span class="n">entity</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">media_entity_type</span><span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MEDIA_ENT_T_DEVNODE</span><span class="p">)</span>
			<span class="n">isp_pipeline_pm_power_one</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="o">-</span><span class="n">change</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_pipeline_pm_use - Update the use count of an entity</span>
<span class="cm"> * @entity: The entity</span>
<span class="cm"> * @use: Use (1) or stop using (0) the entity</span>
<span class="cm"> *</span>
<span class="cm"> * Update the use count of all entities in the pipeline and power entities on or</span>
<span class="cm"> * off accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code on failure. Powering entities</span>
<span class="cm"> * off is assumed to never fail. No failure can occur when the use parameter is</span>
<span class="cm"> * set to 0.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_pipeline_pm_use</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">,</span> <span class="kt">int</span> <span class="n">use</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">change</span> <span class="o">=</span> <span class="n">use</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">graph_mutex</span><span class="p">);</span>

	<span class="cm">/* Apply use count to node. */</span>
	<span class="n">entity</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">+=</span> <span class="n">change</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Apply power change to connected non-nodes. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_pipeline_pm_power</span><span class="p">(</span><span class="n">entity</span><span class="p">,</span> <span class="n">change</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">entity</span><span class="o">-&gt;</span><span class="n">use_count</span> <span class="o">-=</span> <span class="n">change</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">graph_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_pipeline_link_notify - Link management notification callback</span>
<span class="cm"> * @source: Pad at the start of the link</span>
<span class="cm"> * @sink: Pad at the end of the link</span>
<span class="cm"> * @flags: New link flags that will be applied</span>
<span class="cm"> *</span>
<span class="cm"> * React to link management on powered pipelines by updating the use count of</span>
<span class="cm"> * all entities in the source and sink sides of the link. Entities are powered</span>
<span class="cm"> * on or off accordingly.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 on success or a negative error code on failure. Powering entities</span>
<span class="cm"> * off is assumed to never fail. This function will not fail for disconnection</span>
<span class="cm"> * events.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_link_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">sink</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">source_use</span> <span class="o">=</span> <span class="n">isp_pipeline_pm_use_count</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sink_use</span> <span class="o">=</span> <span class="n">isp_pipeline_pm_use_count</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Powering off entities is assumed to never fail. */</span>
		<span class="n">isp_pipeline_pm_power</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="o">-</span><span class="n">sink_use</span><span class="p">);</span>
		<span class="n">isp_pipeline_pm_power</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="o">-</span><span class="n">source_use</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_pipeline_pm_power</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">sink_use</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_pipeline_pm_power</span><span class="p">(</span><span class="n">sink</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="n">source_use</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">isp_pipeline_pm_power</span><span class="p">(</span><span class="n">source</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="o">-</span><span class="n">sink_use</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Pipeline stream management</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * isp_pipeline_enable - Enable streaming on a pipeline</span>
<span class="cm"> * @pipe: ISP pipeline</span>
<span class="cm"> * @mode: Stream mode (single shot or continuous)</span>
<span class="cm"> *</span>
<span class="cm"> * Walk the entities chain starting at the pipeline output video node and start</span>
<span class="cm"> * all modules in the chain in the given mode.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 if successful, or the return value of the failed video::s_stream</span>
<span class="cm"> * operation otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
			       <span class="k">enum</span> <span class="n">isp_pipeline_stream_state</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* If the preview engine crashed it might not respond to read/write</span>
<span class="cm">	 * operations on the L4 bus. This would result in a bus fault and a</span>
<span class="cm">	 * kernel oops. Refuse to start streaming in that case. This check must</span>
<span class="cm">	 * be performed before the loop below to avoid starting entities if the</span>
<span class="cm">	 * pipeline won&#39;t start anyway (those entities would then likely fail to</span>
<span class="cm">	 * stop, making the problem worse).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">entities</span> <span class="o">&amp;</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">crashed</span><span class="p">)</span> <span class="o">&amp;</span>
	    <span class="p">(</span><span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">.</span><span class="n">id</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ISP_PIPELINE_IDLE_INPUT</span> <span class="o">|</span> <span class="n">ISP_PIPELINE_IDLE_OUTPUT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">do_propagation</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">entity</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_PAD_FL_SINK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pad</span> <span class="o">=</span> <span class="n">media_entity_remote_source</span><span class="p">(</span><span class="n">pad</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pad</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">media_entity_type</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">entity</span> <span class="o">=</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
		<span class="n">subdev</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ENOIOCTLCMD</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">subdev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">.</span><span class="n">subdev</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span>
					<span class="n">s_stream</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">.</span><span class="n">subdev</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span>
					<span class="n">s_stream</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">.</span><span class="n">subdev</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span>
					<span class="n">s_stream</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
			<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">do_propagation</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_wait_resizer</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap3isp_resizer_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_wait_preview</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap3isp_preview_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_wait_ccdc</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">omap3isp_stat_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">omap3isp_stat_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">omap3isp_stat_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">omap3isp_ccdc_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define ISP_STOP_TIMEOUT	msecs_to_jiffies(1000)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			     <span class="kt">int</span><span class="p">(</span><span class="o">*</span><span class="n">busy</span><span class="p">)(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ISP_STOP_TIMEOUT</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">busy</span><span class="p">(</span><span class="n">isp</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_pipeline_disable - Disable streaming on a pipeline</span>
<span class="cm"> * @pipe: ISP pipeline</span>
<span class="cm"> *</span>
<span class="cm"> * Walk the entities chain starting at the pipeline output video node and stop</span>
<span class="cm"> * all modules in the chain. Wait synchronously for the modules to be stopped if</span>
<span class="cm"> * necessary.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 if all modules have been properly stopped, or -ETIMEDOUT if a module</span>
<span class="cm"> * can&#39;t be stopped (in which case a software reset of the ISP is probably</span>
<span class="cm"> * necessary).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">isp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">entity</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">failure</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We need to stop all the modules after CCDC first or they&#39;ll</span>
<span class="cm">	 * never stop since they may not get a full frame from CCDC.</span>
<span class="cm">	 */</span>
	<span class="n">entity</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">video</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">entity</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MEDIA_PAD_FL_SINK</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">pad</span> <span class="o">=</span> <span class="n">media_entity_remote_source</span><span class="p">(</span><span class="n">pad</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pad</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
		    <span class="n">media_entity_type</span><span class="p">(</span><span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">)</span> <span class="o">!=</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">entity</span> <span class="o">=</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">;</span>
		<span class="n">subdev</span> <span class="o">=</span> <span class="n">media_entity_to_v4l2_subdev</span><span class="p">(</span><span class="n">entity</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">subdev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">.</span><span class="n">subdev</span><span class="p">,</span>
					 <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">.</span><span class="n">subdev</span><span class="p">,</span>
					 <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">.</span><span class="n">subdev</span><span class="p">,</span>
					 <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">subdev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">.</span><span class="n">subdev</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_pipeline_wait</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp_pipeline_wait_resizer</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">subdev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">.</span><span class="n">subdev</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_pipeline_wait</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp_pipeline_wait_preview</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">subdev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_pipeline_wait</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp_pipeline_wait_ccdc</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to stop %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">subdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="cm">/* If the entity failed to stopped, assume it has</span>
<span class="cm">			 * crashed. Mark it as such, the ISP will be reset when</span>
<span class="cm">			 * applications will release it.</span>
<span class="cm">			 */</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">crashed</span> <span class="o">|=</span> <span class="mi">1U</span> <span class="o">&lt;&lt;</span> <span class="n">subdev</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>
			<span class="n">failure</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">failure</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_pipeline_set_stream - Enable/disable streaming on a pipeline</span>
<span class="cm"> * @pipe: ISP pipeline</span>
<span class="cm"> * @state: Stream state (stopped, single shot or continuous)</span>
<span class="cm"> *</span>
<span class="cm"> * Set the pipeline to the given stream state. Pipelines can be started in</span>
<span class="cm"> * single-shot or continuous mode.</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 if successful, or the return value of the failed video::s_stream</span>
<span class="cm"> * operation otherwise. The pipeline state is not updated when the operation</span>
<span class="cm"> * fails, except when stopping the pipeline.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_pipeline_set_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span><span class="p">,</span>
				 <span class="k">enum</span> <span class="n">isp_pipeline_stream_state</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_pipeline_disable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_pipeline_enable</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
		<span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_pipeline_resume - Resume streaming on a pipeline</span>
<span class="cm"> * @pipe: ISP pipeline</span>
<span class="cm"> *</span>
<span class="cm"> * Resume video output and input and re-enable pipeline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_pipeline_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">singleshot</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span><span class="p">;</span>

	<span class="n">omap3isp_video_resume</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">,</span> <span class="o">!</span><span class="n">singleshot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">singleshot</span><span class="p">)</span>
		<span class="n">omap3isp_video_resume</span><span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">isp_pipeline_enable</span><span class="p">(</span><span class="n">pipe</span><span class="p">,</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_state</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_pipeline_suspend - Suspend streaming on a pipeline</span>
<span class="cm"> * @pipe: ISP pipeline</span>
<span class="cm"> *</span>
<span class="cm"> * Suspend pipeline.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_pipeline_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp_pipeline_disable</span><span class="p">(</span><span class="n">pipe</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_pipeline_is_last - Verify if entity has an enabled link to the output</span>
<span class="cm"> * 			  video node</span>
<span class="cm"> * @me: ISP module&#39;s media entity</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 1 if the entity has an enabled link to the output video node or 0</span>
<span class="cm"> * otherwise. It&#39;s true only while pipeline can have no more than one output</span>
<span class="cm"> * node.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pipeline_is_last</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">media_pad</span> <span class="o">*</span><span class="n">pad</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">me</span><span class="o">-&gt;</span><span class="n">pipe</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="n">me</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pad</span> <span class="o">=</span> <span class="n">media_entity_remote_source</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">output</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pad</span><span class="o">-&gt;</span><span class="n">entity</span> <span class="o">==</span> <span class="n">me</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_suspend_module_pipeline - Suspend pipeline to which belongs the module</span>
<span class="cm"> * @me: ISP module&#39;s media entity</span>
<span class="cm"> *</span>
<span class="cm"> * Suspend the whole pipeline if module&#39;s entity has an enabled link to the</span>
<span class="cm"> * output video node. It works only while pipeline can have no more than one</span>
<span class="cm"> * output node.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_suspend_module_pipeline</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp_pipeline_is_last</span><span class="p">(</span><span class="n">me</span><span class="p">))</span>
		<span class="n">isp_pipeline_suspend</span><span class="p">(</span><span class="n">to_isp_pipeline</span><span class="p">(</span><span class="n">me</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_resume_module_pipeline - Resume pipeline to which belongs the module</span>
<span class="cm"> * @me: ISP module&#39;s media entity</span>
<span class="cm"> *</span>
<span class="cm"> * Resume the whole pipeline if module&#39;s entity has an enabled link to the</span>
<span class="cm"> * output video node. It works only while pipeline can have no more than one</span>
<span class="cm"> * output node.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_resume_module_pipeline</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp_pipeline_is_last</span><span class="p">(</span><span class="n">me</span><span class="p">))</span>
		<span class="n">isp_pipeline_resume</span><span class="p">(</span><span class="n">to_isp_pipeline</span><span class="p">(</span><span class="n">me</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_suspend_modules - Suspend ISP submodules.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if suspend left in idle state all the submodules properly,</span>
<span class="cm"> * or returns 1 if a general Reset is required to suspend the submodules.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_suspend_modules</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">omap3isp_stat_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">);</span>
	<span class="n">omap3isp_stat_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">);</span>
	<span class="n">omap3isp_stat_suspend</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">);</span>
	<span class="n">isp_suspend_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">isp_suspend_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">isp_suspend_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">isp_suspend_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">isp_suspend_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">ISP_STOP_TIMEOUT</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">omap3isp_stat_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">omap3isp_stat_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">omap3isp_stat_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">omap3isp_preview_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">omap3isp_resizer_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">)</span>
	    <span class="o">||</span> <span class="n">omap3isp_ccdc_busy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_info</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t stop modules.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_resume_modules - Resume ISP submodules.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_resume_modules</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap3isp_stat_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">);</span>
	<span class="n">omap3isp_stat_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">);</span>
	<span class="n">omap3isp_stat_resume</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">);</span>
	<span class="n">isp_resume_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">isp_resume_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">isp_resume_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">isp_resume_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
	<span class="n">isp_resume_module_pipeline</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_reset - Reset ISP with a timeout wait for idle.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span>
		       <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_SYSCONFIG</span><span class="p">)</span>
		       <span class="o">|</span> <span class="n">ISP_SYSCONFIG_SOFTRESET</span><span class="p">,</span>
		       <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_SYSCONFIG</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span>
			       <span class="n">ISP_SYSSTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">10000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_alert</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot reset ISP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">crashed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_save_context - Saves the values of the ISP module registers.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> * @reg_list: Structure containing pairs of register address and value to</span>
<span class="cm"> *            modify on OMAP.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isp_save_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp_reg</span> <span class="o">*</span><span class="n">reg_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_reg</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">reg_list</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">ISP_TOK_TERM</span><span class="p">;</span> <span class="n">next</span><span class="o">++</span><span class="p">)</span>
		<span class="n">next</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">mmio_range</span><span class="p">,</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_restore_context - Restores the values of the ISP module registers.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> * @reg_list: Structure containing pairs of register address and value to</span>
<span class="cm"> *            modify on OMAP.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">isp_restore_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">isp_reg</span> <span class="o">*</span><span class="n">reg_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_reg</span> <span class="o">*</span><span class="n">next</span> <span class="o">=</span> <span class="n">reg_list</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">ISP_TOK_TERM</span><span class="p">;</span> <span class="n">next</span><span class="o">++</span><span class="p">)</span>
		<span class="n">isp_reg_writel</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">mmio_range</span><span class="p">,</span> <span class="n">next</span><span class="o">-&gt;</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_save_ctx - Saves ISP, CCDC, HIST, H3A, PREV, RESZ &amp; MMU context.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> *</span>
<span class="cm"> * Routine for saving the context of each module in the ISP.</span>
<span class="cm"> * CCDC, HIST, H3A, PREV, RESZ and MMU.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_save_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp_save_context</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp_reg_list</span><span class="p">);</span>
	<span class="n">omap_iommu_save_ctx</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_restore_ctx - Restores ISP, CCDC, HIST, H3A, PREV, RESZ &amp; MMU context.</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> *</span>
<span class="cm"> * Routine for restoring the context of each module in the ISP.</span>
<span class="cm"> * CCDC, HIST, H3A, PREV, RESZ and MMU.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_restore_ctx</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp_restore_context</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">isp_reg_list</span><span class="p">);</span>
	<span class="n">omap_iommu_restore_ctx</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">omap3isp_ccdc_restore_context</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">omap3isp_preview_restore_context</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * SBL resources management</span>
<span class="cm"> */</span>
<span class="cp">#define OMAP3_ISP_SBL_READ	(OMAP3_ISP_SBL_CSI1_READ | \</span>
<span class="cp">				 OMAP3_ISP_SBL_CCDC_LSC_READ | \</span>
<span class="cp">				 OMAP3_ISP_SBL_PREVIEW_READ | \</span>
<span class="cp">				 OMAP3_ISP_SBL_RESIZER_READ)</span>
<span class="cp">#define OMAP3_ISP_SBL_WRITE	(OMAP3_ISP_SBL_CSI1_WRITE | \</span>
<span class="cp">				 OMAP3_ISP_SBL_CSI2A_WRITE | \</span>
<span class="cp">				 OMAP3_ISP_SBL_CSI2C_WRITE | \</span>
<span class="cp">				 OMAP3_ISP_SBL_CCDC_WRITE | \</span>
<span class="cp">				 OMAP3_ISP_SBL_PREVIEW_WRITE)</span>

<span class="kt">void</span> <span class="nf">omap3isp_sbl_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">isp_sbl_resource</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">|=</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_CSI1_READ</span><span class="p">)</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_SHARED_RPORTA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_CCDC_LSC_READ</span><span class="p">)</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_SHARED_RPORTB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_CSI2C_WRITE</span><span class="p">)</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_SHARED_WPORTC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_RESIZER_WRITE</span><span class="p">)</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_WR0_RAM_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_WRITE</span><span class="p">)</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_WR1_RAM_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_READ</span><span class="p">)</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_RD_RAM_EN</span><span class="p">;</span>

	<span class="n">isp_reg_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_CTRL</span><span class="p">,</span> <span class="n">sbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3isp_sbl_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span> <span class="k">enum</span> <span class="n">isp_sbl_resource</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_CSI1_READ</span><span class="p">))</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_SHARED_RPORTA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_CCDC_LSC_READ</span><span class="p">))</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_SHARED_RPORTB</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_CSI2C_WRITE</span><span class="p">))</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_SHARED_WPORTC</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_RESIZER_WRITE</span><span class="p">))</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_WR0_RAM_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_WRITE</span><span class="p">))</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_WR1_RAM_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">sbl_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SBL_READ</span><span class="p">))</span>
		<span class="n">sbl</span> <span class="o">|=</span> <span class="n">ISPCTRL_SBL_RD_RAM_EN</span><span class="p">;</span>

	<span class="n">isp_reg_clr</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_CTRL</span><span class="p">,</span> <span class="n">sbl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_module_sync_idle - Helper to sync module with its idle state</span>
<span class="cm"> * @me: ISP submodule&#39;s media entity</span>
<span class="cm"> * @wait: ISP submodule&#39;s wait queue for streamoff/interrupt synchronization</span>
<span class="cm"> * @stopping: flag which tells module wants to stop</span>
<span class="cm"> *</span>
<span class="cm"> * This function checks if ISP submodule needs to wait for next interrupt. If</span>
<span class="cm"> * yes, makes the caller to sleep while waiting for such event.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_module_sync_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">me</span><span class="p">,</span> <span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">wait</span><span class="p">,</span>
			      <span class="n">atomic_t</span> <span class="o">*</span><span class="n">stopping</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_pipeline</span> <span class="o">*</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">to_isp_pipeline</span><span class="p">(</span><span class="n">me</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_STOPPED</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pipe</span><span class="o">-&gt;</span><span class="n">stream_state</span> <span class="o">==</span> <span class="n">ISP_PIPELINE_STREAM_SINGLESHOT</span> <span class="o">&amp;&amp;</span>
	     <span class="o">!</span><span class="n">isp_pipeline_ready</span><span class="p">(</span><span class="n">pipe</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * atomic_set() doesn&#39;t include memory barrier on ARM platform for SMP</span>
<span class="cm">	 * scenario. We&#39;ll call it here to avoid race conditions.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="n">stopping</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * If module is the last one, it&#39;s writing to memory. In this case,</span>
<span class="cm">	 * it&#39;s necessary to check if the module is already paused due to</span>
<span class="cm">	 * DMA queue underrun or if it has to wait for next interrupt to be</span>
<span class="cm">	 * idle.</span>
<span class="cm">	 * If it isn&#39;t the last one, the function won&#39;t sleep but *stopping</span>
<span class="cm">	 * will still be set to warn next submodule caller&#39;s interrupt the</span>
<span class="cm">	 * module wants to be idle.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp_pipeline_is_last</span><span class="p">(</span><span class="n">me</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">isp_video</span> <span class="o">*</span><span class="n">video</span> <span class="o">=</span> <span class="n">pipe</span><span class="o">-&gt;</span><span class="n">output</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">dmaqueue_flags</span> <span class="o">&amp;</span> <span class="n">ISP_VIDEO_DMAQUEUE_UNDERRUN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="n">stopping</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">smp_mb</span><span class="p">();</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">video</span><span class="o">-&gt;</span><span class="n">queue</span><span class="o">-&gt;</span><span class="n">irqlock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_event_timeout</span><span class="p">(</span><span class="o">*</span><span class="n">wait</span><span class="p">,</span> <span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="n">stopping</span><span class="p">),</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">1000</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="n">stopping</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">smp_mb</span><span class="p">();</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_module_sync_is_stopped - Helper to verify if module was stopping</span>
<span class="cm"> * @wait: ISP submodule&#39;s wait queue for streamoff/interrupt synchronization</span>
<span class="cm"> * @stopping: flag which tells module wants to stop</span>
<span class="cm"> *</span>
<span class="cm"> * This function checks if ISP submodule was stopping. In case of yes, it</span>
<span class="cm"> * notices the caller by setting stopping to 0 and waking up the wait queue.</span>
<span class="cm"> * Returns 1 if it was stopping or 0 otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">omap3isp_module_sync_is_stopping</span><span class="p">(</span><span class="n">wait_queue_head_t</span> <span class="o">*</span><span class="n">wait</span><span class="p">,</span>
				     <span class="n">atomic_t</span> <span class="o">*</span><span class="n">stopping</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_cmpxchg</span><span class="p">(</span><span class="n">stopping</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm"> * Clock management</span>
<span class="cm"> */</span>

<span class="cp">#define ISPCTRL_CLKS_MASK	(ISPCTRL_H3A_CLK_EN | \</span>
<span class="cp">				 ISPCTRL_HIST_CLK_EN | \</span>
<span class="cp">				 ISPCTRL_RSZ_CLK_EN | \</span>
<span class="cp">				 (ISPCTRL_CCDC_CLK_EN | ISPCTRL_CCDC_RAM_EN) | \</span>
<span class="cp">				 (ISPCTRL_PREV_CLK_EN | ISPCTRL_PREV_RAM_EN))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__isp_subclk_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">clk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">subclk_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SUBCLK_H3A</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">|=</span> <span class="n">ISPCTRL_H3A_CLK_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">subclk_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SUBCLK_HIST</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">|=</span> <span class="n">ISPCTRL_HIST_CLK_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">subclk_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SUBCLK_RESIZER</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">|=</span> <span class="n">ISPCTRL_RSZ_CLK_EN</span><span class="p">;</span>

	<span class="cm">/* NOTE: For CCDC &amp; Preview submodules, we need to affect internal</span>
<span class="cm">	 *       RAM as well.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">subclk_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SUBCLK_CCDC</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">|=</span> <span class="n">ISPCTRL_CCDC_CLK_EN</span> <span class="o">|</span> <span class="n">ISPCTRL_CCDC_RAM_EN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">subclk_resources</span> <span class="o">&amp;</span> <span class="n">OMAP3_ISP_SUBCLK_PREVIEW</span><span class="p">)</span>
		<span class="n">clk</span> <span class="o">|=</span> <span class="n">ISPCTRL_PREV_CLK_EN</span> <span class="o">|</span> <span class="n">ISPCTRL_PREV_RAM_EN</span><span class="p">;</span>

	<span class="n">isp_reg_clr_set</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_CTRL</span><span class="p">,</span>
			<span class="n">ISPCTRL_CLKS_MASK</span><span class="p">,</span> <span class="n">clk</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3isp_subclk_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			    <span class="k">enum</span> <span class="n">isp_subclk_resource</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">subclk_resources</span> <span class="o">|=</span> <span class="n">res</span><span class="p">;</span>

	<span class="n">__isp_subclk_update</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">omap3isp_subclk_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">isp_subclk_resource</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">subclk_resources</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">res</span><span class="p">;</span>

	<span class="n">__isp_subclk_update</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_enable_clocks - Enable ISP clocks</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 if successful, or clk_enable return value if any of tthem fails.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_enable_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">r</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * cam_mclk clock chain:</span>
<span class="cm">	 *   dpll4 -&gt; dpll4_m5 -&gt; dpll4_m5x2 -&gt; cam_mclk</span>
<span class="cm">	 *</span>
<span class="cm">	 * In OMAP3630 dpll4_m5x2 != 2 x dpll4_m5 but both are</span>
<span class="cm">	 * set to the same value. Hence the rate set for dpll4_m5</span>
<span class="cm">	 * has to be twice of what is set on OMAP3430 to get</span>
<span class="cm">	 * the required value for cam_mclk</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpu_is_omap3630</span><span class="p">())</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">divisor</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CAM_ICK</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clk_enable cam_ick failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_clk_enable_ick</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_DPLL4_M5_CK</span><span class="p">],</span>
			 <span class="n">CM_CAM_MCLK_HZ</span><span class="o">/</span><span class="n">divisor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clk_set_rate for dpll4_m5_ck failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_clk_enable_mclk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CAM_MCLK</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clk_enable cam_mclk failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_clk_enable_mclk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">clk_get_rate</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CAM_MCLK</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="n">CM_CAM_MCLK_HZ</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unexpected cam_mclk rate:</span><span class="se">\n</span><span class="s">&quot;</span>
				   <span class="s">&quot; expected : %d</span><span class="se">\n</span><span class="s">&quot;</span>
				   <span class="s">&quot; actual   : %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">CM_CAM_MCLK_HZ</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CSI2_FCK</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clk_enable csi2_fck failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_clk_enable_csi2_fclk</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_clk_enable_csi2_fclk:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CAM_MCLK</span><span class="p">]);</span>
<span class="nl">out_clk_enable_mclk:</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CAM_ICK</span><span class="p">]);</span>
<span class="nl">out_clk_enable_ick:</span>
	<span class="k">return</span> <span class="n">r</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_disable_clocks - Disable ISP clocks</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_disable_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CAM_ICK</span><span class="p">]);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CAM_MCLK</span><span class="p">]);</span>
	<span class="n">clk_disable</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">ISP_CLK_CSI2_FCK</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">isp_clocks</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;cam_ick&quot;</span><span class="p">,</span>
	<span class="s">&quot;cam_mclk&quot;</span><span class="p">,</span>
	<span class="s">&quot;dpll4_m5_ck&quot;</span><span class="p">,</span>
	<span class="s">&quot;csi2_96m_fck&quot;</span><span class="p">,</span>
	<span class="s">&quot;l3_ick&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_put_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isp_clocks</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">clk_put</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_get_clocks</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isp_clocks</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">isp_clocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;clk_get %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">isp_clocks</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">isp_put_clocks</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">clk</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">clock</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">clk</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_get - Acquire the ISP resource.</span>
<span class="cm"> *</span>
<span class="cm"> * Initializes the clocks for the first acquire.</span>
<span class="cm"> *</span>
<span class="cm"> * Increment the reference count on the ISP. If the first reference is taken,</span>
<span class="cm"> * enable clocks and power-up all submodules.</span>
<span class="cm"> *</span>
<span class="cm"> * Return a pointer to the ISP device structure, or NULL if an error occurred.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="nf">omap3isp_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">__isp</span> <span class="o">=</span> <span class="n">isp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp_enable_clocks</span><span class="p">(</span><span class="n">isp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__isp</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We don&#39;t want to restore context before saving it! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">has_context</span><span class="p">)</span>
		<span class="n">isp_restore_ctx</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">has_context</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">isp_enable_interrupts</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__isp</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">isp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">__isp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_put - Release the ISP</span>
<span class="cm"> *</span>
<span class="cm"> * Decrement the reference count on the ISP. If the last reference is released,</span>
<span class="cm"> * power-down all submodules, disable clocks and free temporary buffers.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">omap3isp_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_mutex</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">isp_disable_interrupts</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">)</span>
			<span class="n">isp_save_ctx</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
		<span class="cm">/* Reset the ISP if an entity has failed to stop. This is the</span>
<span class="cm">		 * only way to recover from such conditions.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">crashed</span><span class="p">)</span>
			<span class="n">isp_reset</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
		<span class="n">isp_disable_clocks</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------------</span>
<span class="cm"> * Platform device driver</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * omap3isp_print_status - Prints the values of the ISP Control Module registers</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> */</span>
<span class="cp">#define ISP_PRINT_REGISTER(isp, name)\</span>
<span class="cp">	dev_dbg(isp-&gt;dev, &quot;###ISP &quot; #name &quot;=0x%08x\n&quot;, \</span>
<span class="cp">		isp_reg_readl(isp, OMAP3_ISP_IOMEM_MAIN, ISP_##name))</span>
<span class="cp">#define SBL_PRINT_REGISTER(isp, name)\</span>
<span class="cp">	dev_dbg(isp-&gt;dev, &quot;###SBL &quot; #name &quot;=0x%08x\n&quot;, \</span>
<span class="cp">		isp_reg_readl(isp, OMAP3_ISP_IOMEM_SBL, ISPSBL_##name))</span>

<span class="kt">void</span> <span class="nf">omap3isp_print_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;-------------ISP Register dump--------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SYSCONFIG</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SYSSTATUS</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">IRQ0ENABLE</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">IRQ0STATUS</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_GRESET_LENGTH</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_PSTRB_REPLAY</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">CTRL</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_CTRL</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_FRAME</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_PSTRB_DELAY</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_STRB_DELAY</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_SHUT_DELAY</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_PSTRB_LENGTH</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_STRB_LENGTH</span><span class="p">);</span>
	<span class="n">ISP_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">TCTRL_SHUT_LENGTH</span><span class="p">);</span>

	<span class="n">SBL_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">PCR</span><span class="p">);</span>
	<span class="n">SBL_PRINT_REGISTER</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">SDR_REQ_EXP</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;--------------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="cm">/*</span>
<span class="cm"> * Power management support.</span>
<span class="cm"> *</span>
<span class="cm"> * As the ISP can&#39;t properly handle an input video stream interruption on a non</span>
<span class="cm"> * frame boundary, the ISP pipelines need to be stopped before sensors get</span>
<span class="cm"> * suspended. However, as suspending the sensors can require a running clock,</span>
<span class="cm"> * which can be provided by the ISP, the ISP can&#39;t be completely suspended</span>
<span class="cm"> * before the sensor.</span>
<span class="cm"> *</span>
<span class="cm"> * To solve this problem power management support is split into prepare/complete</span>
<span class="cm"> * and suspend/resume operations. The pipelines are stopped in prepare() and the</span>
<span class="cm"> * ISP clocks get disabled in suspend(). Similarly, the clocks are reenabled in</span>
<span class="cm"> * resume(), and the the pipelines are restarted in complete().</span>
<span class="cm"> *</span>
<span class="cm"> * TODO: PM dependencies between the ISP and sensors are not modeled explicitly</span>
<span class="cm"> * yet.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pm_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">reset</span><span class="p">;</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_mutex</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">reset</span> <span class="o">=</span> <span class="n">isp_suspend_modules</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">isp_disable_interrupts</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">isp_save_ctx</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">isp_reset</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_mutex</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">ref_count</span><span class="p">)</span>
		<span class="n">isp_disable_clocks</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_pm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">isp_enable_clocks</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_pm_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">isp_restore_ctx</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">isp_enable_interrupts</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">isp_resume_modules</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define isp_pm_prepare	NULL</span>
<span class="cp">#define isp_pm_suspend	NULL</span>
<span class="cp">#define isp_pm_resume	NULL</span>
<span class="cp">#define isp_pm_complete	NULL</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_unregister_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap3isp_csi2_unregister_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">);</span>
	<span class="n">omap3isp_ccp2_unregister_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">);</span>
	<span class="n">omap3isp_ccdc_unregister_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">);</span>
	<span class="n">omap3isp_preview_unregister_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">);</span>
	<span class="n">omap3isp_resizer_unregister_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">);</span>
	<span class="n">omap3isp_stat_unregister_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">);</span>
	<span class="n">omap3isp_stat_unregister_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">);</span>
	<span class="n">omap3isp_stat_unregister_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">media_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_register_subdev_group - Register a group of subdevices</span>
<span class="cm"> * @isp: OMAP3 ISP device</span>
<span class="cm"> * @board_info: I2C subdevs board information array</span>
<span class="cm"> *</span>
<span class="cm"> * Register all I2C subdevices in the board_info array. The array must be</span>
<span class="cm"> * terminated by a NULL entry, and the first entry must be the sensor.</span>
<span class="cm"> *</span>
<span class="cm"> * Return a pointer to the sensor media entity if it has been successfully</span>
<span class="cm"> * registered, or NULL otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span>
<span class="nf">isp_register_subdev_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">isp_subdev_i2c_board_info</span> <span class="o">*</span><span class="n">board_info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">first</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">board_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">board_info</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="p">;</span> <span class="o">++</span><span class="n">board_info</span><span class="p">,</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span><span class="p">;</span>

		<span class="n">adapter</span> <span class="o">=</span> <span class="n">i2c_get_adapter</span><span class="p">(</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">i2c_adapter_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adapter</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to get I2C adapter %d for &quot;</span>
				<span class="s">&quot;device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">board_info</span><span class="o">-&gt;</span><span class="n">i2c_adapter_id</span><span class="p">,</span>
				<span class="n">board_info</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">subdev</span> <span class="o">=</span> <span class="n">v4l2_i2c_new_subdev_board</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="n">adapter</span><span class="p">,</span>
				<span class="n">board_info</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">subdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Unable to register subdev %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">board_info</span><span class="o">-&gt;</span><span class="n">board_info</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
			<span class="n">sensor</span> <span class="o">=</span> <span class="n">subdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">sensor</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_register_entities</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_v4l2_subdevs_group</span> <span class="o">*</span><span class="n">subdevs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">model</span><span class="p">,</span> <span class="s">&quot;TI OMAP3 ISP&quot;</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">model</span><span class="p">));</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">hw_revision</span> <span class="o">=</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">.</span><span class="n">link_notify</span> <span class="o">=</span> <span class="n">isp_pipeline_link_notify</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Media device registration failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">mdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">media_dev</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: V4L2 device registration failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register internal entities */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_ccp2_register_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_csi2_register_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_ccdc_register_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_preview_register_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">,</span>
						 <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_resizer_register_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_stat_register_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_stat_register_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_stat_register_entities</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* Register external entities */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">subdevs</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">;</span> <span class="n">subdevs</span> <span class="o">&amp;&amp;</span> <span class="n">subdevs</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">;</span> <span class="o">++</span><span class="n">subdevs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sensor</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">media_entity</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">;</span>

		<span class="n">sensor</span> <span class="o">=</span> <span class="n">isp_register_subdev_group</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">subdevs</span><span class="o">-&gt;</span><span class="n">subdevs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">host_priv</span> <span class="o">=</span> <span class="n">subdevs</span><span class="p">;</span>

		<span class="cm">/* Connect the sensor to the correct interface module. Parallel</span>
<span class="cm">		 * sensors are connected directly to the CCDC, while serial</span>
<span class="cm">		 * sensors are connected to the CSI2a, CCP2b or CSI2c receiver</span>
<span class="cm">		 * through CSIPHY1 or CSIPHY2.</span>
<span class="cm">		 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">subdevs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ISP_INTERFACE_PARALLEL</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
			<span class="n">pad</span> <span class="o">=</span> <span class="n">CCDC_PAD_SINK</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISP_INTERFACE_CSI2A_PHY2</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
			<span class="n">pad</span> <span class="o">=</span> <span class="n">CSI2_PAD_SINK</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_LNK_FL_IMMUTABLE</span>
			      <span class="o">|</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISP_INTERFACE_CCP2B_PHY1</span>:
		<span class="k">case</span> <span class="n">ISP_INTERFACE_CCP2B_PHY2</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
			<span class="n">pad</span> <span class="o">=</span> <span class="n">CCP2_PAD_SINK</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ISP_INTERFACE_CSI2C_PHY1</span>:
			<span class="n">input</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2c</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">;</span>
			<span class="n">pad</span> <span class="o">=</span> <span class="n">CSI2_PAD_SINK</span><span class="p">;</span>
			<span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_LNK_FL_IMMUTABLE</span>
			      <span class="o">|</span> <span class="n">MEDIA_LNK_FL_ENABLED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: invalid interface type %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">__func__</span><span class="p">,</span> <span class="n">subdevs</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">input</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span>
					       <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev_nodes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">isp_unregister_entities</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">isp_cleanup_modules</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">omap3isp_h3a_aewb_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">omap3isp_h3a_af_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">omap3isp_hist_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">omap3isp_resizer_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">omap3isp_preview_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">omap3isp_ccdc_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">omap3isp_ccp2_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">omap3isp_csi2_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_initialize_modules</span><span class="p">(</span><span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_csiphy_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CSI PHY initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_csiphy</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_csi2_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CSI2 initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_csi2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_ccp2_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCP2 initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_ccp2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_ccdc_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CCDC initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_ccdc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_preview_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Preview initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_preview</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_resizer_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Resizer initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_resizer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_hist_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Histogram initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_hist</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_h3a_aewb_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;H3A AEWB initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_h3a_aewb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">omap3isp_h3a_af_init</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;H3A AF initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_h3a_af</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Connect the submodules. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csi2a</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CSI2_PAD_SOURCE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCDC_PAD_SINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccp2</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCP2_PAD_SOURCE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCDC_PAD_SINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_VP</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">PREV_PAD_SINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_OF</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">RESZ_PAD_SINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_prev</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">PREV_PAD_SOURCE</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_res</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">RESZ_PAD_SINK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_VP</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_aewb</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">MEDIA_LNK_FL_ENABLED</span> <span class="o">|</span> <span class="n">MEDIA_LNK_FL_IMMUTABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_VP</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_af</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">MEDIA_LNK_FL_ENABLED</span> <span class="o">|</span> <span class="n">MEDIA_LNK_FL_IMMUTABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_ccdc</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="n">CCDC_PAD_SOURCE_VP</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_hist</span><span class="p">.</span><span class="n">subdev</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">MEDIA_LNK_FL_ENABLED</span> <span class="o">|</span> <span class="n">MEDIA_LNK_FL_IMMUTABLE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_link</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_link:</span>
	<span class="n">omap3isp_h3a_af_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error_h3a_af:</span>
	<span class="n">omap3isp_h3a_aewb_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error_h3a_aewb:</span>
	<span class="n">omap3isp_hist_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error_hist:</span>
	<span class="n">omap3isp_resizer_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error_resizer:</span>
	<span class="n">omap3isp_preview_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error_preview:</span>
	<span class="n">omap3isp_ccdc_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error_ccdc:</span>
	<span class="n">omap3isp_ccp2_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error_ccp2:</span>
	<span class="n">omap3isp_csi2_cleanup</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error_csi2:</span>
<span class="nl">error_csiphy:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_remove - Remove ISP platform device</span>
<span class="cm"> * @pdev: Pointer to ISP platform device</span>
<span class="cm"> *</span>
<span class="cm"> * Always returns 0.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">isp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">isp_unregister_entities</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">isp_cleanup_modules</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="n">omap3isp_get</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="n">iommu_detach_device</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">iommu_domain_free</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">omap3isp_put</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">irq_num</span><span class="p">,</span> <span class="n">isp</span><span class="p">);</span>
	<span class="n">isp_put_clocks</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OMAP3_ISP_IOMEM_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					   <span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">regulator_put</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csiphy1</span><span class="p">.</span><span class="n">vdd</span><span class="p">);</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csiphy2</span><span class="p">.</span><span class="n">vdd</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">isp_map_mem_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">isp_mem_resources</span> <span class="n">res</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>

	<span class="cm">/* request the mem region for the camera registers */</span>

	<span class="n">mem</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no mem resource?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_mem_region</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">mem</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;cannot reserve camera register I/O region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">[</span><span class="n">res</span><span class="p">]</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">[</span><span class="n">res</span><span class="p">]</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>

	<span class="cm">/* map the region */</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">[</span><span class="n">res</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioremap_nocache</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">[</span><span class="n">res</span><span class="p">],</span>
					      <span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">[</span><span class="n">res</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">[</span><span class="n">res</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot map camera register I/O region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * isp_probe - Probe ISP platform device</span>
<span class="cm"> * @pdev: Pointer to ISP platform device</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 if successful,</span>
<span class="cm"> *   -ENOMEM if no memory available,</span>
<span class="cm"> *   -ENODEV if no platform device resources found</span>
<span class="cm"> *     or no space for remapping registers,</span>
<span class="cm"> *   -EINVAL if couldn&#39;t install ISR,</span>
<span class="cm"> *   or clk_get return error value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">isp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">isp_platform_data</span> <span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">isp_device</span> <span class="o">*</span><span class="n">isp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">isp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">isp</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not allocate memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">autoidle</span> <span class="o">=</span> <span class="n">autoidle</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">platform_cb</span><span class="p">.</span><span class="n">set_xclk</span> <span class="o">=</span> <span class="n">isp_set_xclk</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">stat_lock</span><span class="p">);</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdata</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">ref_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">raw_dmamask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">raw_dmamask</span><span class="p">;</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">coherent_dma_mask</span> <span class="o">=</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">isp</span><span class="p">);</span>

	<span class="cm">/* Regulators */</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csiphy1</span><span class="p">.</span><span class="n">vdd</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VDD_CSIPHY1&quot;</span><span class="p">);</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csiphy2</span><span class="p">.</span><span class="n">vdd</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VDD_CSIPHY2&quot;</span><span class="p">);</span>

	<span class="cm">/* Clocks */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_map_mem_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_get_clocks</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">omap3isp_get</span><span class="p">(</span><span class="n">isp</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_reset</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_isp</span><span class="p">;</span>

	<span class="cm">/* Memory resources */</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="n">isp_reg_readl</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="n">OMAP3_ISP_IOMEM_MAIN</span><span class="p">,</span> <span class="n">ISP_REVISION</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Revision %d.%d found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isp_res_maps</span><span class="p">);</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">==</span> <span class="n">isp_res_maps</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">isp_rev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">m</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">isp_res_maps</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No resource map found for ISP rev %d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="n">isp</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_isp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OMAP3_ISP_IOMEM_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp_res_maps</span><span class="p">[</span><span class="n">m</span><span class="p">].</span><span class="n">map</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_map_mem_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">isp</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">error_isp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span> <span class="o">=</span> <span class="n">iommu_domain_alloc</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t alloc iommu domain</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_isp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">iommu_attach_device</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t attach iommu device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">free_domain</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Interrupt */</span>
	<span class="n">isp</span><span class="o">-&gt;</span><span class="n">irq_num</span> <span class="o">=</span> <span class="n">platform_get_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">irq_num</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No IRQ resource</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">detach_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">irq_num</span><span class="p">,</span> <span class="n">isp_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;OMAP3 ISP&quot;</span><span class="p">,</span> <span class="n">isp</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unable to request IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">detach_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Entities */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_initialize_modules</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_irq</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">isp_register_entities</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_modules</span><span class="p">;</span>

	<span class="n">isp_power_settings</span><span class="p">(</span><span class="n">isp</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">omap3isp_put</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error_modules:</span>
	<span class="n">isp_cleanup_modules</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">irq_num</span><span class="p">,</span> <span class="n">isp</span><span class="p">);</span>
<span class="nl">detach_dev:</span>
	<span class="n">iommu_detach_device</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">free_domain:</span>
	<span class="n">iommu_domain_free</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">domain</span><span class="p">);</span>
<span class="nl">error_isp:</span>
	<span class="n">omap3isp_put</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="n">isp_put_clocks</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">OMAP3_ISP_IOMEM_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">release_mem_region</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
					   <span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_size</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="n">isp</span><span class="o">-&gt;</span><span class="n">mmio_base_phys</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csiphy2</span><span class="p">.</span><span class="n">vdd</span><span class="p">);</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_csiphy1</span><span class="p">.</span><span class="n">vdd</span><span class="p">);</span>
	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mutex_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">isp</span><span class="o">-&gt;</span><span class="n">isp_mutex</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">isp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">omap3isp_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">prepare</span> <span class="o">=</span> <span class="n">isp_pm_prepare</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">isp_pm_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">isp_pm_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">complete</span> <span class="o">=</span> <span class="n">isp_pm_complete</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device_id</span> <span class="n">omap3isp_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;omap3isp&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">platform</span><span class="p">,</span> <span class="n">omap3isp_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">omap3isp_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">isp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">isp_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">omap3isp_id_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;omap3isp&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">omap3isp_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">omap3isp_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Nokia Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;TI OMAP3 ISP driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">ISP_VIDEO_DRIVER_VERSION</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
