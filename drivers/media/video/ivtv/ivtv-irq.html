<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › ivtv › ivtv-irq.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ivtv-irq.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* interrupt handling</span>
<span class="cm">    Copyright (C) 2003-2004  Kevin Thayer &lt;nufan_wfk at yahoo.com&gt;</span>
<span class="cm">    Copyright (C) 2004  Chris Kennedy &lt;c@groovy.org&gt;</span>
<span class="cm">    Copyright (C) 2005-2007  Hans Verkuil &lt;hverkuil@xs4all.nl&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ivtv-driver.h&quot;</span>
<span class="cp">#include &quot;ivtv-queue.h&quot;</span>
<span class="cp">#include &quot;ivtv-udma.h&quot;</span>
<span class="cp">#include &quot;ivtv-irq.h&quot;</span>
<span class="cp">#include &quot;ivtv-mailbox.h&quot;</span>
<span class="cp">#include &quot;ivtv-vbi.h&quot;</span>
<span class="cp">#include &quot;ivtv-yuv.h&quot;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>

<span class="cp">#define DMA_MAGIC_COOKIE 0x000001fe</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">ivtv_dma_dec_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">ivtv_stream_map</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IVTV_ENC_STREAM_TYPE_MPG</span><span class="p">,</span>
	<span class="n">IVTV_ENC_STREAM_TYPE_YUV</span><span class="p">,</span>
	<span class="n">IVTV_ENC_STREAM_TYPE_PCM</span><span class="p">,</span>
	<span class="n">IVTV_ENC_STREAM_TYPE_VBI</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_pio_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ivtv_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IVTV_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;ivtv_pio_work_handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span> <span class="o">&gt;=</span> <span class="n">IVTV_MAX_STREAMS</span> <span class="o">||</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="o">!</span><span class="n">ivtv_use_pio</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* trigger PIO complete user interrupt */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">IVTV_IRQ_ENC_PIO_COMPLETE</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IVTV_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;Process PIO %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span> <span class="o">&amp;</span> <span class="mh">0x3ffff</span><span class="p">;</span>

		<span class="cm">/* Copy the data from the card to the buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_VBI</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dec_mem</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span> <span class="o">-</span> <span class="n">IVTV_DECODER_OFFSET</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">enc_mem</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">src</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">IVTV_IRQ_ENC_PIO_COMPLETE</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ivtv_irq_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">kthread_work</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ivtv</span><span class="p">,</span> <span class="n">irq_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_WORK_HANDLER_PIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
		<span class="n">ivtv_pio_work_handler</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_WORK_HANDLER_VBI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
		<span class="n">ivtv_vbi_work_handler</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_WORK_HANDLER_YUV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
		<span class="n">ivtv_yuv_work_handler</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Determine the required DMA size, setup enough buffers in the predma queue and</span>
<span class="cm">   actually copy the data from the card to the buffers in case a PIO transfer is</span>
<span class="cm">   required for this stream.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">stream_enc_dma_append</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bytes_needed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">UVoffset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">UVsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">skip_bufs</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">buffers</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* sanity checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Stream %s not started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_S_CLAIMED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Stream %s not open</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* determine offset, size and PTS for the various streams */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IVTV_ENC_STREAM_TYPE_MPG</span>:
			<span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_pts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IVTV_ENC_STREAM_TYPE_YUV</span>:
			<span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
			<span class="n">UVoffset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">UVsize</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_pts</span> <span class="o">=</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">)</span> <span class="o">|</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IVTV_ENC_STREAM_TYPE_PCM</span>:
			<span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="mi">12</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_pts</span> <span class="o">=</span> <span class="n">read_dec</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
				<span class="p">((</span><span class="n">u64</span><span class="p">)(</span><span class="n">read_dec</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">12</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">has_cx23415</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="n">IVTV_DECODER_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IVTV_ENC_STREAM_TYPE_VBI</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">enc_size</span> <span class="o">*</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">fpi</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">read_enc</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">enc_start</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">12</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;VBI offset == 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_pts</span> <span class="o">=</span> <span class="n">read_enc</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">read_enc</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IVTV_DEC_STREAM_TYPE_VBI</span>:
			<span class="n">size</span> <span class="o">=</span> <span class="n">read_dec</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">dec_start</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">read_dec</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">dec_start</span><span class="p">)</span> <span class="o">+</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">dec_start</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_pts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">IVTV_DECODER_OFFSET</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="cm">/* shouldn&#39;t happen */</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if this is the start of the DMA then fill in the magic cookie */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ivtv_use_dma</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">has_cx23415</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_PCM</span> <span class="o">||</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_VBI</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_backup</span> <span class="o">=</span> <span class="n">read_dec</span><span class="p">(</span><span class="n">offset</span> <span class="o">-</span> <span class="n">IVTV_DECODER_OFFSET</span><span class="p">);</span>
			<span class="n">write_dec_sync</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DMA_MAGIC_COOKIE</span><span class="p">),</span> <span class="n">offset</span> <span class="o">-</span> <span class="n">IVTV_DECODER_OFFSET</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_backup</span> <span class="o">=</span> <span class="n">read_enc</span><span class="p">(</span><span class="n">offset</span><span class="p">);</span>
			<span class="n">write_enc_sync</span><span class="p">(</span><span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">DMA_MAGIC_COOKIE</span><span class="p">),</span> <span class="n">offset</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bytes_needed</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_YUV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The size for the Y samples needs to be rounded upwards to a</span>
<span class="cm">		   multiple of the buf_size. The UV samples then start in the</span>
<span class="cm">		   next buffer. */</span>
		<span class="n">bytes_needed</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">*</span> <span class="p">((</span><span class="n">bytes_needed</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
		<span class="n">bytes_needed</span> <span class="o">+=</span> <span class="n">UVsize</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IVTV_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;%s %s: 0x%08x bytes at 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ivtv_use_pio</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PIO&quot;</span> <span class="o">:</span> <span class="s">&quot;DMA&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bytes_needed</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ivtv_queue_move</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_free</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_full</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">,</span> <span class="n">bytes_needed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Insufficient buffers */</span>
		<span class="n">IVTV_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Cannot obtain %d bytes for %s data transfer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bytes_needed</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffers_stolen</span> <span class="o">&amp;&amp;</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_S_APPL_IO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IVTV_WARN</span><span class="p">(</span><span class="s">&quot;All %s stream buffers are full. Dropping data.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">IVTV_WARN</span><span class="p">(</span><span class="s">&quot;Cause: the application is not reading fast enough.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">buffers_stolen</span> <span class="o">=</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* got the buffers, now fill in sg_pending */</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ivtv_buffer</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">128</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skip_bufs</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">dst</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">);</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">dma_xfer_cnt</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_xfer_cnt</span><span class="p">;</span>

		<span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">bytesused</span> <span class="o">+=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">;</span>

		<span class="cm">/* Sync SG buffers */</span>
		<span class="n">ivtv_buf_sync_for_device</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* YUV */</span>
			<span class="cm">/* process the UV section */</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">UVoffset</span><span class="p">;</span>
			<span class="n">size</span> <span class="o">=</span> <span class="n">UVsize</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dma_post</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_buffer</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">u32buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IVTV_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;%s %s completed (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ivtv_use_pio</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PIO&quot;</span> <span class="o">:</span> <span class="s">&quot;DMA&quot;</span><span class="p">,</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">);</span>
	<span class="n">list_for_each</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">.</span><span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ivtv_buffer</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">u32buf</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">;</span>

		<span class="cm">/* Sync Buffer */</span>
		<span class="n">ivtv_buf_sync_for_cpu</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">x</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ivtv_use_dma</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_last_offset</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">u32buf</span><span class="p">[</span><span class="n">offset</span> <span class="o">/</span> <span class="mi">4</span><span class="p">]</span> <span class="o">!=</span> <span class="n">DMA_MAGIC_COOKIE</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">u32buf</span><span class="p">[</span><span class="n">offset</span><span class="p">]</span> <span class="o">==</span> <span class="n">DMA_MAGIC_COOKIE</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">break</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">offset</span> <span class="o">*=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="mi">256</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">IVTV_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;%s: Couldn&#39;t find start of buffer within the first 256 bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_last_offset</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_last_offset</span> <span class="o">!=</span> <span class="n">offset</span><span class="p">)</span>
					<span class="n">IVTV_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;%s: offset %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_last_offset</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_last_offset</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">has_cx23415</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_PCM</span> <span class="o">||</span>
						<span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_VBI</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">write_dec_sync</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_offset</span> <span class="o">-</span> <span class="n">IVTV_DECODER_OFFSET</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">write_enc_sync</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">-=</span> <span class="n">offset</span><span class="p">;</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="o">*</span><span class="n">u32buf</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_backup</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">x</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/* flag byteswap ABCD -&gt; DCBA for MPG &amp; VBI data outside irq */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_MPG</span> <span class="o">||</span>
		    <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_VBI</span><span class="p">)</span>
			<span class="n">buf</span><span class="o">-&gt;</span><span class="n">b_flags</span> <span class="o">|=</span> <span class="n">IVTV_F_B_NEED_BUF_SWAP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">)</span>
		<span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_last_offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_VBI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Parse and Groom VBI Data */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">.</span><span class="n">bytesused</span> <span class="o">-=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>
			<span class="n">ivtv_process_vbi_data</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">.</span><span class="n">bytesused</span> <span class="o">+=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fh</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivtv_queue_move</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_free</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ivtv_queue_move</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_full</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">.</span><span class="n">bytesused</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fh</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ivtv_dma_stream_dec_prepare</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u32</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yuv_playback_info</span> <span class="o">*</span><span class="n">yi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">yi</span><span class="o">-&gt;</span><span class="n">draw_frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yuv_frame_info</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">new_frame_info</span><span class="p">[</span><span class="n">frame</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ivtv_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">y_size</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="p">((</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">src_h</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">uv_offset</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">IVTV_YUV_BUFFER_UV_OFFSET</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y_done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_written</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IVTV_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;DEC PREPARE DMA %s: %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">bytesused</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="cm">/* Insert buffer block for YUV if needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_YUV</span> <span class="o">&amp;&amp;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">offset_y</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">blanking_dmaptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">yi</span><span class="o">-&gt;</span><span class="n">blanking_dmaptr</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">dst</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* YUV UV Offset from Y Buffer */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_YUV</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">y_done</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="n">bytes_written</span> <span class="o">+</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">y_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">dst</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">y_size</span> <span class="o">-</span> <span class="n">bytes_written</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">uv_offset</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">!=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span>
				  <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dma_handle</span> <span class="o">+</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">dst</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span>
				   <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">y_done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">src</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">dma_handle</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">dst</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">+=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">bytes_written</span> <span class="o">+=</span> <span class="n">buf</span><span class="o">-&gt;</span><span class="n">bytesused</span><span class="p">;</span>

		<span class="cm">/* Sync SG buffers */</span>
		<span class="n">ivtv_buf_sync_for_device</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/* Sync Hardware SG List of buffers */</span>
	<span class="n">ivtv_stream_sync_for_device</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ivtv_dma_dec_start</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_S_DMA_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lock</span><span class="p">)</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_dma_enc_start_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_dma</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="p">].</span><span class="n">src</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_dma</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="p">].</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_dma</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="p">].</span><span class="n">size</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Sync Hardware SG List of buffers */</span>
	<span class="n">ivtv_stream_sync_for_device</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_handle</span><span class="p">,</span> <span class="n">IVTV_REG_ENCDMAADDR</span><span class="p">);</span>
	<span class="n">write_reg_sync</span><span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DMAXFER</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x02</span><span class="p">,</span> <span class="n">IVTV_REG_DMAXFER</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_dma_dec_start_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_dma</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="p">].</span><span class="n">src</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_dma</span><span class="o">-&gt;</span><span class="n">dst</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="p">].</span><span class="n">dst</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_dma</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="p">].</span><span class="n">size</span> <span class="o">|</span> <span class="mh">0x80000000</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="o">++</span><span class="p">;</span>
	<span class="cm">/* Sync Hardware SG List of buffers */</span>
	<span class="n">ivtv_stream_sync_for_device</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_handle</span><span class="p">,</span> <span class="n">IVTV_REG_DECDMAADDR</span><span class="p">);</span>
	<span class="n">write_reg_sync</span><span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DMAXFER</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">,</span> <span class="n">IVTV_REG_DMAXFER</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* start the encoder DMA */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_dma_enc_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s_vbi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">IVTV_ENC_STREAM_TYPE_VBI</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IVTV_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;start %s for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ivtv_use_dma</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;DMA&quot;</span> <span class="o">:</span> <span class="s">&quot;PIO&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">bytesused</span><span class="p">)</span>
		<span class="n">ivtv_queue_move</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">bytesused</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_use_dma</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">+=</span> <span class="mi">256</span><span class="p">;</span>

	<span class="cm">/* If this is an MPEG stream, and VBI data is also pending, then append the</span>
<span class="cm">	   VBI DMA to the MPEG DMA and transfer both sets of data at once.</span>

<span class="cm">	   VBI DMA is a second class citizen compared to MPEG and mixing them together</span>
<span class="cm">	   will confuse the firmware (the end of a VBI DMA is seen as the end of a</span>
<span class="cm">	   MPEG DMA, thus effectively dropping an MPEG frame). So instead we make</span>
<span class="cm">	   sure we only use the MPEG DMA to transfer the VBI DMA if both are in</span>
<span class="cm">	   use. This way no conflicts occur. */</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_S_DMA_HAS_VBI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_MPG</span> <span class="o">&amp;&amp;</span> <span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">&amp;&amp;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">+</span> <span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">&lt;=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_queue_move</span><span class="p">(</span><span class="n">s_vbi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">,</span> <span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">bytesused</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_use_dma</span><span class="p">(</span><span class="n">s_vbi</span><span class="p">))</span>
			<span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">+=</span> <span class="mi">256</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">dma_offset</span> <span class="o">=</span> <span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">pending_offset</span><span class="p">;</span>
		<span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">dma_xfer_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_S_DMA_HAS_VBI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
		<span class="n">IVTV_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;include DMA for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s_vbi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_xfer_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_sg_host_element</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_offset</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_offset</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_backup</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_backup</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_pts</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pending_pts</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_use_pio</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_WORK_HANDLER_PIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_HAVE_WORK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_PIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ivtv_dma_enc_start_xfer</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_dma_dec_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">bytesused</span><span class="p">)</span>
		<span class="n">ivtv_queue_move</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">.</span><span class="n">bytesused</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_xfer_cnt</span><span class="o">++</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv_sg_host_element</span><span class="p">)</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_pending_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IVTV_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;start DMA for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ivtv_dma_dec_start_xfer</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_irq_dma_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_buffer</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hw_stream_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">IVTV_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;DEC DMA READ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span><span class="p">];</span>
		<span class="n">ivtv_stream_sync_for_cpu</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DMASTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x14</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IVTV_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;DEC DMA ERROR %x (xfer %d of %d, retry %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DMASTATUS</span><span class="p">),</span>
					<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span><span class="p">);</span>
			<span class="n">write_reg</span><span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DMASTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">IVTV_REG_DMASTATUS</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Too many retries, give up on this frame */</span>
				<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* Retry, starting with the first xfer segment.</span>
<span class="cm">				   Just retrying the current segment is not sufficient. */</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* DMA next buffer */</span>
			<span class="n">ivtv_dma_dec_start_xfer</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_YUV</span><span class="p">)</span>
			<span class="n">hw_stream_type</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">IVTV_DEBUG_HI_DMA</span><span class="p">(</span><span class="s">&quot;DEC DATA READ %s: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">.</span><span class="n">bytesused</span><span class="p">);</span>

		<span class="cm">/* For some reason must kick the firmware, like PIO mode,</span>
<span class="cm">		   I think this tells the firmware we are done and the size</span>
<span class="cm">		   of the xfer so it can calculate what we need next.</span>
<span class="cm">		   I think we can do this part ourselves but would have to</span>
<span class="cm">		   fully calculate xfer info ourselves and not use interrupts</span>
<span class="cm">		 */</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_DEC_SCHED_DMA_FROM_HOST</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">.</span><span class="n">bytesused</span><span class="p">,</span>
				<span class="n">hw_stream_type</span><span class="p">);</span>

		<span class="cm">/* Free last DMA call */</span>
		<span class="k">while</span> <span class="p">((</span><span class="n">buf</span> <span class="o">=</span> <span class="n">ivtv_dequeue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_dma</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivtv_buf_sync_for_cpu</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
			<span class="n">ivtv_enqueue</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_free</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_irq_enc_dma_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">ivtv_api_get_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">enc_mbox</span><span class="p">,</span> <span class="n">IVTV_MBOX_DMA_END</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">IVTV_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;ENC DMA COMPLETE %x %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span><span class="p">);</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span><span class="p">];</span>
	<span class="n">ivtv_stream_sync_for_cpu</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;ENC DMA ERROR %x (offset %08x, xfer %d of %d, retry %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_offset</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DMASTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">IVTV_REG_DMASTATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Too many retries, give up on this frame */</span>
			<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Retry, starting with the first xfer segment.</span>
<span class="cm">			   Just retrying the current segment is not sufficient. */</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* DMA next buffer */</span>
		<span class="n">ivtv_dma_enc_start_xfer</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_S_DMA_HAS_VBI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">IVTV_ENC_STREAM_TYPE_VBI</span><span class="p">];</span>
		<span class="n">dma_post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processing_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_irq_enc_pio_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span> <span class="o">&gt;=</span> <span class="n">IVTV_MAX_STREAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span><span class="p">];</span>
	<span class="n">IVTV_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;ENC PIO COMPLETE %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_PIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_pio_stream</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">dma_post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_MPG</span><span class="p">)</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_ENC_SCHED_DMA_TO_HOST</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_YUV</span><span class="p">)</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_ENC_SCHED_DMA_TO_HOST</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_PCM</span><span class="p">)</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_ENC_SCHED_DMA_TO_HOST</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_PIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_S_DMA_HAS_VBI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">IVTV_ENC_STREAM_TYPE_VBI</span><span class="p">];</span>
		<span class="n">dma_post</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_irq_dma_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">);</span>

	<span class="n">ivtv_api_get_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">enc_mbox</span><span class="p">,</span> <span class="n">IVTV_MBOX_DMA_END</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DMASTATUS</span><span class="p">);</span>
	<span class="n">IVTV_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;DMA ERROR %08x %08x %08x %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
				<span class="n">status</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We do *not* write back to the IVTV_REG_DMASTATUS register to</span>
<span class="cm">	 * clear the error status, if either the encoder write (0x02) or</span>
<span class="cm">	 * decoder read (0x01) bus master DMA operation do not indicate</span>
<span class="cm">	 * completed.  We can race with the DMA engine, which may have</span>
<span class="cm">	 * transitioned to completed status *after* we read the register.</span>
<span class="cm">	 * Setting a IVTV_REG_DMASTATUS flag back to &quot;busy&quot; status, after the</span>
<span class="cm">	 * DMA engine has completed, will cause the DMA engine to stop working.</span>
<span class="cm">	 */</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="mh">0x3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mh">0x3</span><span class="p">)</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">IVTV_REG_DMASTATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">&lt;</span> <span class="n">IVTV_MAX_STREAMS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">IVTV_DEC_STREAM_TYPE_MPG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* retry */</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME - handle cases of DMA error similar to</span>
<span class="cm">			 * encoder below, except conditioned on status &amp; 0x1</span>
<span class="cm">			 */</span>
			<span class="n">ivtv_dma_dec_start</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * CX2341x Bus Master DMA write is ongoing.</span>
<span class="cm">				 * Reset the timer and let it complete.</span>
<span class="cm">				 */</span>
				<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span>
						<span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">600</span><span class="p">);</span>
				<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_timer</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * CX2341x Bus Master DMA write has ended.</span>
<span class="cm">				 * Retry the write, starting with the first</span>
<span class="cm">				 * xfer segment. Just retrying the current</span>
<span class="cm">				 * segment is not sufficient.</span>
<span class="cm">				 */</span>
				<span class="n">s</span><span class="o">-&gt;</span><span class="n">sg_processed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_retries</span><span class="o">++</span><span class="p">;</span>
				<span class="n">ivtv_dma_enc_start_xfer</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* Too many retries, give up on this one */</span>
		<span class="p">}</span>

	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ivtv_udma_start</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_irq_enc_start_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="cm">/* Get DMA destination and size arguments from card */</span>
	<span class="n">ivtv_api_get_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">enc_mbox</span><span class="p">,</span> <span class="n">IVTV_MBOX_DMA</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">IVTV_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;ENC START CAP %d: %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Unknown input: %08x %08x %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">ivtv_stream_map</span><span class="p">[</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]]];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stream_enc_dma_append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ivtv_use_pio</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">?</span> <span class="n">IVTV_F_S_PIO_PENDING</span> <span class="o">:</span> <span class="n">IVTV_F_S_DMA_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_irq_enc_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="n">IVTV_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;ENC START VBI CAP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">IVTV_ENC_STREAM_TYPE_VBI</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stream_enc_dma_append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">ivtv_use_pio</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">?</span> <span class="n">IVTV_F_S_PIO_PENDING</span> <span class="o">:</span> <span class="n">IVTV_F_S_DMA_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_irq_dec_vbi_reinsert</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">IVTV_DEC_STREAM_TYPE_VBI</span><span class="p">];</span>

	<span class="n">IVTV_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;DEC VBI REINSERT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_S_CLAIMED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="o">!</span><span class="n">stream_enc_dma_append</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_S_PIO_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_irq_dec_data_req</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>

	<span class="cm">/* YUV or MPG */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DEC_YUV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ivtv_api_get_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dec_mbox</span><span class="p">,</span> <span class="n">IVTV_MBOX_DMA</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_size</span> <span class="o">=</span>
				 <span class="mi">1080</span> <span class="o">*</span> <span class="p">((</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">v4l2_src_h</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">next_dma_frame</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ivtv_yuv_frame_complete</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">IVTV_DEC_STREAM_TYPE_YUV</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ivtv_api_get_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dec_mbox</span><span class="p">,</span> <span class="n">IVTV_MBOX_DMA</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_size</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mh">0x10000</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">IVTV_DEC_STREAM_TYPE_MPG</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="n">IVTV_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;DEC DATA REQ %s: %d %08x %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_full</span><span class="p">.</span><span class="n">bytesused</span><span class="p">,</span>
		       <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_offset</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_full</span><span class="p">.</span><span class="n">bytesused</span> <span class="o">&lt;</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_S_NEEDS_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DEC_YUV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
			<span class="n">ivtv_yuv_setup_stream_frame</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_S_NEEDS_DATA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">);</span>
		<span class="n">ivtv_queue_move</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_full</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">q_predma</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_size</span><span class="p">);</span>
		<span class="n">ivtv_dma_stream_dec_prepare</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_offset</span> <span class="o">+</span> <span class="n">IVTV_DECODER_OFFSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtv_irq_vsync</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The vsync interrupt is unusual in that it won&#39;t clear until</span>
<span class="cm">	 * the end of the first line for the current field, at which</span>
<span class="cm">	 * point it clears itself. This can result in repeated vsync</span>
<span class="cm">	 * interrupts, or a missed vsync. Read some of the registers</span>
<span class="cm">	 * to determine the line being displayed and ensure we handle</span>
<span class="cm">	 * one vsync per frame.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DEC_LINE_FIELD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yuv_playback_info</span> <span class="o">*</span><span class="n">yi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_dma_frame</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">next_dma_frame</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">yuv_frame_info</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">new_frame_info</span><span class="p">[</span><span class="n">last_dma_frame</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="n">IVTV_DEBUG_IRQ</span><span class="p">(</span><span class="s">&quot;DEC VSYNC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">frame</span> <span class="o">^</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">sync_field</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">last_vsync_field</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">sync_field</span><span class="p">))</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">frame</span> <span class="o">!=</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">last_vsync_field</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">interlaced</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">next_dma_frame</span> <span class="o">=</span> <span class="n">last_dma_frame</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">interlaced</span> <span class="o">&amp;&amp;</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">delay</span> <span class="o">&amp;&amp;</span> <span class="n">yi</span><span class="o">-&gt;</span><span class="n">fields_lapsed</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">next_dma_frame</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">next_dma_frame</span> <span class="o">!=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">next_fill_frame</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">write_reg</span><span class="p">(</span><span class="n">yuv_offset</span><span class="p">[</span><span class="n">next_dma_frame</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x82c</span><span class="p">);</span>
				<span class="n">write_reg</span><span class="p">((</span><span class="n">yuv_offset</span><span class="p">[</span><span class="n">next_dma_frame</span><span class="p">]</span> <span class="o">+</span> <span class="n">IVTV_YUV_BUFFER_UV_OFFSET</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x830</span><span class="p">);</span>
				<span class="n">write_reg</span><span class="p">(</span><span class="n">yuv_offset</span><span class="p">[</span><span class="n">next_dma_frame</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x834</span><span class="p">);</span>
				<span class="n">write_reg</span><span class="p">((</span><span class="n">yuv_offset</span><span class="p">[</span><span class="n">next_dma_frame</span><span class="p">]</span> <span class="o">+</span> <span class="n">IVTV_YUV_BUFFER_UV_OFFSET</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">,</span> <span class="mh">0x838</span><span class="p">);</span>
				<span class="n">next_dma_frame</span> <span class="o">=</span> <span class="p">(</span><span class="n">next_dma_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">IVTV_YUV_BUFFERS</span><span class="p">;</span>
				<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">next_dma_frame</span><span class="p">,</span> <span class="n">next_dma_frame</span><span class="p">);</span>
				<span class="n">yi</span><span class="o">-&gt;</span><span class="n">fields_lapsed</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
				<span class="n">yi</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">!=</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">last_vsync_field</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_event</span> <span class="n">evtop</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_EVENT_VSYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">vsync</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_TOP</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_event</span> <span class="n">evbottom</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_EVENT_VSYNC</span><span class="p">,</span>
			<span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">vsync</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_BOTTOM</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">ivtv_get_output_stream</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>

		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">last_vsync_field</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_VALID_DEC_TIMINGS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_VSYNC_FIELD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_VSYNC_FIELD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_VSYNC_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_VSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">event_waitq</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="p">)</span>
				<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">waitq</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;&amp;</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span>
			<span class="n">v4l2_event_queue</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">frame</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">evtop</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">evbottom</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vsync_waitq</span><span class="p">);</span>

		<span class="cm">/* Send VBI to saa7127 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">output_mode</span> <span class="o">==</span> <span class="n">OUT_PASSTHROUGH</span> <span class="o">||</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UPDATE_WSS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UPDATE_VPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UPDATE_CC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_WORK_HANDLER_VBI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_HAVE_WORK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Check if we need to update the yuv registers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">running</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">yuv_forced_update</span> <span class="o">||</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">update</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">last_dma_frame</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">u8</span><span class="p">)(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">next_dma_frame</span><span class="p">)</span> <span class="o">-</span>
						 <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">IVTV_YUV_BUFFERS</span><span class="p">;</span>
				<span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">new_frame_info</span><span class="p">[</span><span class="n">last_dma_frame</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">src_w</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">yi</span><span class="o">-&gt;</span><span class="n">update_frame</span> <span class="o">=</span> <span class="n">last_dma_frame</span><span class="p">;</span>
				<span class="n">f</span><span class="o">-&gt;</span><span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">yi</span><span class="o">-&gt;</span><span class="n">yuv_forced_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_WORK_HANDLER_YUV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_HAVE_WORK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">yi</span><span class="o">-&gt;</span><span class="n">fields_lapsed</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define IVTV_IRQ_DMA (IVTV_IRQ_DMA_READ | IVTV_IRQ_ENC_DMA_COMPLETE | IVTV_IRQ_DMA_ERR | IVTV_IRQ_ENC_START_CAP | IVTV_IRQ_ENC_VBI_CAP | IVTV_IRQ_DEC_DATA_REQ | IVTV_IRQ_DEC_VBI_RE_INSERT)</span>

<span class="n">irqreturn_t</span> <span class="nf">ivtv_irq_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">combo</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">stat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">vsync_force</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_reg_lock</span><span class="p">);</span>
	<span class="cm">/* get contents of irq status register */</span>
	<span class="n">stat</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_IRQSTATUS</span><span class="p">);</span>

	<span class="n">combo</span> <span class="o">=</span> <span class="o">~</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">&amp;</span> <span class="n">stat</span><span class="p">;</span>

	<span class="cm">/* Clear out IRQ */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span><span class="p">)</span> <span class="n">write_reg</span><span class="p">(</span><span class="n">combo</span><span class="p">,</span> <span class="n">IVTV_REG_IRQSTATUS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">combo</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The vsync interrupt is unusual and clears itself. If we</span>
<span class="cm">		 * took too long, we may have missed it. Do some checks</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DEC_VSYNC</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* vsync is enabled, see if we&#39;re in a new field */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">last_vsync_field</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span>
			    <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DEC_LINE_FIELD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* New field, looks like we missed it */</span>
				<span class="n">IVTV_DEBUG_YUV</span><span class="p">(</span><span class="s">&quot;VSync interrupt missed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DEC_LINE_FIELD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
				<span class="n">vsync_force</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vsync_force</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No Vsync expected, wasn&#39;t for us */</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_reg_lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Exclude interrupts noted below from the output, otherwise the log is flooded with</span>
<span class="cm">	   these messages */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0xff6d0400</span><span class="p">)</span>
		<span class="n">IVTV_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;======= valid IRQ bits: 0x%08x ======</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">combo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DEC_DMA_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_HI_IRQ</span><span class="p">(</span><span class="s">&quot;DEC DMA COMPLETE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DMA_READ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_irq_dma_read</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_ENC_DMA_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_irq_enc_dma_complete</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_ENC_PIO_COMPLETE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_irq_enc_pio_complete</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DMA_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_irq_dma_err</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_ENC_START_CAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_irq_enc_start_cap</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_ENC_VBI_CAP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_irq_enc_vbi_cap</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DEC_VBI_RE_INSERT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_irq_dec_vbi_reinsert</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_ENC_EOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_IRQ</span><span class="p">(</span><span class="s">&quot;ENC EOS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EOS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">eos_waitq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DEC_DATA_REQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_irq_dec_data_req</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Decoder Vertical Sync - We can&#39;t rely on &#39;combo&#39;, so check if vsync enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">~</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">irqmask</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DEC_VSYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_irq_vsync</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_ENC_VIM_RST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_IRQ</span><span class="p">(</span><span class="s">&quot;VIM RST</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/*ivtv_vapi(itv, CX2341X_ENC_REFRESH_INPUT, 0); */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DEC_AUD_MODE_CHG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Stereo mode changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">irq_rr_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IVTV_MAX_STREAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">irq_rr_idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">IVTV_MAX_STREAMS</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_S_DMA_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&gt;=</span> <span class="n">IVTV_DEC_STREAM_TYPE_MPG</span><span class="p">)</span>
				<span class="n">ivtv_dma_dec_start</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">ivtv_dma_enc_start</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">IVTV_MAX_STREAMS</span> <span class="o">&amp;&amp;</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
			<span class="n">ivtv_udma_start</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">combo</span> <span class="o">&amp;</span> <span class="n">IVTV_IRQ_DMA</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_PIO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">irq_rr_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IVTV_MAX_STREAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">irq_rr_idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">IVTV_MAX_STREAMS</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_S_PIO_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_VBI</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">IVTV_DEC_STREAM_TYPE_MPG</span><span class="p">)</span>
				<span class="n">ivtv_dma_enc_start</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_HAVE_WORK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">queue_kthread_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">irq_worker</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">irq_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_reg_lock</span><span class="p">);</span>

	<span class="cm">/* If we&#39;ve just handled a &#39;forced&#39; vsync, it&#39;s safest to say it</span>
<span class="cm">	 * wasn&#39;t ours. Another device may have triggered it at just</span>
<span class="cm">	 * the right time.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">vsync_force</span> <span class="o">?</span> <span class="n">IRQ_NONE</span> <span class="o">:</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ivtv_unfinished_dma</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">IVTV_ERR</span><span class="p">(</span><span class="s">&quot;DMA TIMEOUT %08x %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DMASTATUS</span><span class="p">),</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span><span class="p">);</span>

	<span class="n">write_reg</span><span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DMASTATUS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">,</span> <span class="n">IVTV_REG_DMASTATUS</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cur_dma_stream</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
