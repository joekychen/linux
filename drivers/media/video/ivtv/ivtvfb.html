<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › ivtv › ivtvfb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ivtvfb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    On Screen Display cx23415 Framebuffer driver</span>

<span class="cm">    This module presents the cx23415 OSD (onscreen display) framebuffer memory</span>
<span class="cm">    as a standard Linux /dev/fb style framebuffer device. The framebuffer has</span>
<span class="cm">    support for 8, 16 &amp; 32 bpp packed pixel formats with alpha channel. In 16bpp</span>
<span class="cm">    mode, there is a choice of a three color depths (12, 15 or 16 bits), but no</span>
<span class="cm">    local alpha. The colorspace is selectable between rgb &amp; yuv.</span>
<span class="cm">    Depending on the TV standard configured in the ivtv module at load time,</span>
<span class="cm">    the initial resolution is either 640x400 (NTSC) or 640x480 (PAL) at 8bpp.</span>
<span class="cm">    Video timings are locked to ensure a vertical refresh rate of 50Hz (PAL)</span>
<span class="cm">    or 59.94 (NTSC)</span>

<span class="cm">    Copyright (c) 2003 Matt T. Yourst &lt;yourst@yourst.com&gt;</span>

<span class="cm">    Derived from drivers/video/vesafb.c</span>
<span class="cm">    Portions (c) 1998 Gerd Knorr &lt;kraxel@goldbach.in-berlin.de&gt;</span>

<span class="cm">    2.6 kernel port:</span>
<span class="cm">    Copyright (C) 2004 Matthias Badaire</span>

<span class="cm">    Copyright (C) 2004  Chris Kennedy &lt;c@groovy.org&gt;</span>

<span class="cm">    Copyright (C) 2006  Ian Armstrong &lt;ian@iarmst.demon.co.uk&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/fb.h&gt;</span>
<span class="cp">#include &lt;linux/ivtvfb.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
<span class="cp">#include &lt;asm/mtrr.h&gt;</span>
<span class="cp">#endif</span>

<span class="cp">#include &quot;ivtv-driver.h&quot;</span>
<span class="cp">#include &quot;ivtv-cards.h&quot;</span>
<span class="cp">#include &quot;ivtv-i2c.h&quot;</span>
<span class="cp">#include &quot;ivtv-udma.h&quot;</span>
<span class="cp">#include &quot;ivtv-mailbox.h&quot;</span>
<span class="cp">#include &quot;ivtv-firmware.h&quot;</span>

<span class="cm">/* card parameters */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ivtvfb_card_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ivtvfb_debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="n">bool</span> <span class="n">osd_laced</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osd_depth</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osd_upper</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osd_left</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osd_yres</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">osd_xres</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">ivtvfb_card_id</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span><span class="n">ivtvfb_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">osd_laced</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">osd_depth</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">osd_upper</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">osd_left</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">osd_yres</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">osd_xres</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">ivtvfb_card_id</span><span class="p">,</span>
		 <span class="s">&quot;Only use framebuffer of the specified ivtv card (0-31)</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">default -1: initialize all available framebuffers&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span>
		 <span class="s">&quot;Debug level (bitmask). Default: errors only</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">(debug = 3 gives full debugging)&quot;</span><span class="p">);</span>

<span class="cm">/* Why upper, left, xres, yres, depth, laced ? To match terminology used</span>
<span class="cm">   by fbset.</span>
<span class="cm">   Why start at 1 for left &amp; upper coordinate ? Because X doesn&#39;t allow 0 */</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">osd_laced</span><span class="p">,</span>
		 <span class="s">&quot;Interlaced mode</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">0=off</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">1=on</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">default off&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">osd_depth</span><span class="p">,</span>
		 <span class="s">&quot;Bits per pixel - 8, 16, 32</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">default 8&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">osd_upper</span><span class="p">,</span>
		 <span class="s">&quot;Vertical start position</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">default 0 (Centered)&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">osd_left</span><span class="p">,</span>
		 <span class="s">&quot;Horizontal start position</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">default 0 (Centered)&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">osd_yres</span><span class="p">,</span>
		 <span class="s">&quot;Display height</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">default 480 (PAL)</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">        400 (NTSC)&quot;</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">osd_xres</span><span class="p">,</span>
		 <span class="s">&quot;Display width</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;</span><span class="se">\t\t\t</span><span class="s">default 640&quot;</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Kevin Thayer, Chris Kennedy, Hans Verkuil, John Harvey, Ian Armstrong&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define IVTVFB_DBGFLG_WARN  (1 &lt;&lt; 0)</span>
<span class="cp">#define IVTVFB_DBGFLG_INFO  (1 &lt;&lt; 1)</span>

<span class="cp">#define IVTVFB_DEBUG(x, type, fmt, args...) \</span>
<span class="cp">	do { \</span>
<span class="cp">		if ((x) &amp; ivtvfb_debug) \</span>
<span class="cp">			printk(KERN_INFO &quot;ivtvfb%d &quot; type &quot;: &quot; fmt, itv-&gt;instance , ## args); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define IVTVFB_DEBUG_WARN(fmt, args...)  IVTVFB_DEBUG(IVTVFB_DBGFLG_WARN, &quot;warning&quot;, fmt , ## args)</span>
<span class="cp">#define IVTVFB_DEBUG_INFO(fmt, args...)  IVTVFB_DEBUG(IVTVFB_DBGFLG_INFO, &quot;info&quot;, fmt , ## args)</span>

<span class="cm">/* Standard kernel messages */</span>
<span class="cp">#define IVTVFB_ERR(fmt, args...)   printk(KERN_ERR  &quot;ivtvfb%d: &quot; fmt, itv-&gt;instance , ## args)</span>
<span class="cp">#define IVTVFB_WARN(fmt, args...)  printk(KERN_WARNING  &quot;ivtvfb%d: &quot; fmt, itv-&gt;instance , ## args)</span>
<span class="cp">#define IVTVFB_INFO(fmt, args...)  printk(KERN_INFO &quot;ivtvfb%d: &quot; fmt, itv-&gt;instance , ## args)</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cp">#define IVTV_OSD_MAX_WIDTH  720</span>
<span class="cp">#define IVTV_OSD_MAX_HEIGHT 576</span>

<span class="cp">#define IVTV_OSD_BPP_8      0x00</span>
<span class="cp">#define IVTV_OSD_BPP_16_444 0x03</span>
<span class="cp">#define IVTV_OSD_BPP_16_555 0x02</span>
<span class="cp">#define IVTV_OSD_BPP_16_565 0x01</span>
<span class="cp">#define IVTV_OSD_BPP_32     0x04</span>

<span class="k">struct</span> <span class="n">osd_info</span> <span class="p">{</span>
	<span class="cm">/* Physical base address */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">video_pbase</span><span class="p">;</span>
	<span class="cm">/* Relative base address (relative to start of decoder memory) */</span>
	<span class="n">u32</span> <span class="n">video_rbase</span><span class="p">;</span>
	<span class="cm">/* Mapped base address */</span>
	<span class="k">volatile</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">video_vbase</span><span class="p">;</span>
	<span class="cm">/* Buffer size */</span>
	<span class="n">u32</span> <span class="n">video_buffer_size</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="cm">/* video_base rounded down as required by hardware MTRRs */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fb_start_aligned_physaddr</span><span class="p">;</span>
	<span class="cm">/* video_base rounded up as required by hardware MTRRs */</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">fb_end_aligned_physaddr</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Store the buffer offset */</span>
	<span class="kt">int</span> <span class="n">set_osd_coords_x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">set_osd_coords_y</span><span class="p">;</span>

	<span class="cm">/* Current dimensions (NOT VISIBLE SIZE!) */</span>
	<span class="kt">int</span> <span class="n">display_width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">display_height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">display_byte_stride</span><span class="p">;</span>

	<span class="cm">/* Current bits per pixel */</span>
	<span class="kt">int</span> <span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bytes_per_pixel</span><span class="p">;</span>

	<span class="cm">/* Frame buffer stuff */</span>
	<span class="k">struct</span> <span class="n">fb_info</span> <span class="n">ivtvfb_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">ivtvfb_defined</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="n">ivtvfb_fix</span><span class="p">;</span>

	<span class="cm">/* Used for a warm start */</span>
	<span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="n">fbvar_cur</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">blank_cur</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">palette_cur</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">pan_cur</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ivtv_osd_coords</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">max_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pixel_stride</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">lines</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="cm">/* ivtv API calls for framebuffer related support */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_get_framebuffer</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">fbbase</span><span class="p">,</span>
				       <span class="n">u32</span> <span class="o">*</span><span class="n">fblength</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">ivtv_firmware_check</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="s">&quot;ivtvfb_get_framebuffer&quot;</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ivtv_vapi_result</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">CX2341X_OSD_GET_FRAMEBUFFER</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="o">*</span><span class="n">fbbase</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="o">*</span><span class="n">fblength</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_get_osd_coords</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ivtv_osd_coords</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>

	<span class="n">ivtv_vapi_result</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">CX2341X_OSD_GET_OSD_COORDS</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_rbase</span><span class="p">;</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">max_offset</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_width</span> <span class="o">*</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_height</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">pixel_stride</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">lines</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">x</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">osd</span><span class="o">-&gt;</span><span class="n">y</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_set_osd_coords</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ivtv_osd_coords</span> <span class="o">*</span><span class="n">osd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>

	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_width</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">pixel_stride</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_byte_stride</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">pixel_stride</span> <span class="o">*</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">set_osd_coords_x</span> <span class="o">+=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">set_osd_coords_y</span> <span class="o">=</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_OSD_COORDS</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
			<span class="n">osd</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_rbase</span><span class="p">,</span>
			<span class="n">osd</span><span class="o">-&gt;</span><span class="n">pixel_stride</span><span class="p">,</span>
			<span class="n">osd</span><span class="o">-&gt;</span><span class="n">lines</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">x</span><span class="p">,</span> <span class="n">osd</span><span class="o">-&gt;</span><span class="n">y</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_set_display_window</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">ivtv_window</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">osd_height_limit</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>

	<span class="cm">/* Only fail if resolution too high, otherwise fudge the start coords. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">osd_height_limit</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">IVTV_OSD_MAX_WIDTH</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Ensure we don&#39;t exceed display limits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">+</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">osd_height_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;ivtv_ioctl_fb_set_display_window - Invalid height setting (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">,</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>
		<span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="n">osd_height_limit</span> <span class="o">-</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">+</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">IVTV_OSD_MAX_WIDTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;ivtv_ioctl_fb_set_display_window - Invalid width setting (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
		<span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="n">IVTV_OSD_MAX_WIDTH</span> <span class="o">-</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the OSD origin */</span>
	<span class="n">write_reg</span><span class="p">((</span><span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">,</span> <span class="mh">0x02a04</span><span class="p">);</span>

	<span class="cm">/* How much to display */</span>
	<span class="n">write_reg</span><span class="p">(((</span><span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">top</span><span class="o">+</span><span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">left</span><span class="o">+</span><span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">),</span> <span class="mh">0x02a08</span><span class="p">);</span>

	<span class="cm">/* Pass this info back the yuv handler */</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">osd_vis_w</span> <span class="o">=</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">osd_vis_h</span> <span class="o">=</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">osd_x_offset</span> <span class="o">=</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">left</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">osd_y_offset</span> <span class="o">=</span> <span class="n">ivtv_window</span><span class="o">-&gt;</span><span class="n">top</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_prep_dec_dma_to_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ivtv_dest_addr</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">userbuf</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">size_in_bytes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">got_sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">udma</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* Map User DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_udma_setup</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">ivtv_dest_addr</span><span class="p">,</span> <span class="n">userbuf</span><span class="p">,</span> <span class="n">size_in_bytes</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">udma</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">IVTVFB_WARN</span><span class="p">(</span><span class="s">&quot;ivtvfb_prep_dec_dma_to_device, &quot;</span>
			       <span class="s">&quot;Error with get_user_pages: %d bytes, %d pages returned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">size_in_bytes</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">udma</span><span class="p">.</span><span class="n">page_count</span><span class="p">);</span>

		<span class="cm">/* get_user_pages must have failed completely */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;ivtvfb_prep_dec_dma_to_device, %d bytes, %d pages</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">size_in_bytes</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">udma</span><span class="p">.</span><span class="n">page_count</span><span class="p">);</span>

	<span class="n">ivtv_udma_prepare</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
	<span class="cm">/* if no UDMA is pending and no UDMA is in progress, then the DMA</span>
<span class="cm">	   is finished */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">||</span>
	       <span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* don&#39;t interrupt if the DMA is in progress but break off</span>
<span class="cm">		   a still pending DMA. */</span>
		<span class="n">got_sig</span> <span class="o">=</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">got_sig</span> <span class="o">&amp;&amp;</span> <span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_UDMA_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">got_sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="cm">/* Unmap Last DMA Xfer */</span>
	<span class="n">ivtv_udma_unmap</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">udma</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">got_sig</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;User stopped OSD</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_prep_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">source</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dest_offset</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>

	<span class="cm">/* Nothing to do */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;ivtvfb_prep_frame: Nothing to do. count = 0</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check Total FB Size */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dest_offset</span> <span class="o">+</span> <span class="n">count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_WARN</span><span class="p">(</span><span class="s">&quot;ivtvfb_prep_frame: Overflowing the framebuffer %ld, only %d available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dest_offset</span> <span class="o">+</span> <span class="n">count</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Not fatal, but will have undesirable results */</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">source</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">IVTVFB_WARN</span><span class="p">(</span><span class="s">&quot;ivtvfb_prep_frame: Source address not 32 bit aligned (0x%08lx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">source</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dest_offset</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">IVTVFB_WARN</span><span class="p">(</span><span class="s">&quot;ivtvfb_prep_frame: Dest offset not 32 bit aligned (%ld)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dest_offset</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">IVTVFB_WARN</span><span class="p">(</span><span class="s">&quot;ivtvfb_prep_frame: Count not a multiple of 4 (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

	<span class="cm">/* Check Source */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">source</span> <span class="o">+</span> <span class="n">dest_offset</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IVTVFB_WARN</span><span class="p">(</span><span class="s">&quot;Invalid userspace pointer 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">source</span><span class="p">);</span>

		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;access_ok() failed for offset 0x%08lx source 0x%08lx count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dest_offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">source</span><span class="p">,</span>
			<span class="n">count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* OSD Address to send DMA to */</span>
	<span class="n">dest_offset</span> <span class="o">+=</span> <span class="n">IVTV_DECODER_OFFSET</span> <span class="o">+</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_rbase</span><span class="p">;</span>

	<span class="cm">/* Fill Buffers */</span>
	<span class="k">return</span> <span class="n">ivtvfb_prep_dec_dma_to_device</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">dest_offset</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">ivtvfb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
						<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">p</span> <span class="o">=</span> <span class="o">*</span><span class="n">ppos</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_offset</span> <span class="o">=</span>
			<span class="n">IVTV_DECODER_OFFSET</span> <span class="o">+</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="o">-&gt;</span><span class="n">video_rbase</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dma_size</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">lead</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FBINFO_STATE_RUNNING</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total_size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">total_size</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">smem_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFBIG</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="n">p</span> <span class="o">&gt;</span> <span class="n">total_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">total_size</span> <span class="o">-</span> <span class="n">p</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dst</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__force</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">screen_base</span> <span class="o">+</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">)</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">fbops</span><span class="o">-&gt;</span><span class="n">fb_sync</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="cm">/* If transfer size &gt; threshold and both src/dst</span>
<span class="cm">	addresses are aligned, use DMA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">4096</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">buf</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Odd address = can&#39;t DMA. Align */</span>
		<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lead</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">-</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dst</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">lead</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="n">buf</span> <span class="o">+=</span> <span class="n">lead</span><span class="p">;</span>
			<span class="n">dst</span> <span class="o">+=</span> <span class="n">lead</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* DMA resolution is 32 bits */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">-</span> <span class="n">lead</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">tail</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">lead</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="cm">/* DMA the data */</span>
		<span class="n">dma_size</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="n">lead</span> <span class="o">-</span> <span class="n">tail</span><span class="p">;</span>
		<span class="n">dma_err</span> <span class="o">=</span> <span class="n">ivtvfb_prep_dec_dma_to_device</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span>
		       <span class="n">p</span> <span class="o">+</span> <span class="n">lead</span> <span class="o">+</span> <span class="n">dma_offset</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">dma_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_err</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">dma_err</span><span class="p">;</span>
		<span class="n">dst</span> <span class="o">+=</span> <span class="n">dma_size</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">dma_size</span><span class="p">;</span>
		<span class="cm">/* Copy any leftover data */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tail</span> <span class="o">&amp;&amp;</span> <span class="n">copy_from_user</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">tail</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">dst</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span>  <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="o">*</span><span class="n">ppos</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FBIOGET_VBLANK</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">fb_vblank</span> <span class="n">vblank</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">trace</span><span class="p">;</span>

			<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vblank</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_vblank</span><span class="p">));</span>

			<span class="n">vblank</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FB_VBLANK_HAVE_COUNT</span> <span class="o">|</span><span class="n">FB_VBLANK_HAVE_VCOUNT</span> <span class="o">|</span>
					<span class="n">FB_VBLANK_HAVE_VSYNC</span><span class="p">;</span>
			<span class="n">trace</span> <span class="o">=</span> <span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DEC_LINE_FIELD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">&amp;&amp;</span> <span class="n">trace</span> <span class="o">&gt;</span> <span class="mi">312</span><span class="p">)</span>
				<span class="n">trace</span> <span class="o">-=</span> <span class="mi">312</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_60hz</span> <span class="o">&amp;&amp;</span> <span class="n">trace</span> <span class="o">&gt;</span> <span class="mi">262</span><span class="p">)</span>
				<span class="n">trace</span> <span class="o">-=</span> <span class="mi">262</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">trace</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">vblank</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FB_VBLANK_VSYNCING</span><span class="p">;</span>
			<span class="n">vblank</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">last_vsync_field</span><span class="p">;</span>
			<span class="n">vblank</span><span class="p">.</span><span class="n">vcount</span> <span class="o">=</span> <span class="n">trace</span><span class="p">;</span>
			<span class="n">vblank</span><span class="p">.</span><span class="n">hcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">((</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vblank</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vblank</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">case</span> <span class="n">FBIO_WAITFORVSYNC</span>:
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vsync_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schedule_timeout</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">)))</span>
				<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vsync_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IVTVFB_IOC_DMA_FRAME</span>: <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ivtvfb_dma_frame</span> <span class="n">args</span><span class="p">;</span>

			<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;IVTVFB_IOC_DMA_FRAME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">args</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">args</span><span class="p">)))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

			<span class="k">return</span> <span class="n">ivtvfb_prep_frame</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">dest_offset</span><span class="p">,</span> <span class="n">args</span><span class="p">.</span><span class="n">count</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="nl">default:</span>
			<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Unknown ioctl %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Framebuffer device handling */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_set_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_osd_coords</span> <span class="n">ivtv_osd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">ivtv_window</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">osd_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;ivtvfb_set_var</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Select color space */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">)</span> <span class="cm">/* YUV */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="mh">0x02a00</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0002000</span><span class="p">,</span> <span class="mh">0x02a00</span><span class="p">);</span>
	<span class="k">else</span> <span class="cm">/* RGB  */</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="mh">0x02a00</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0002000</span><span class="p">,</span> <span class="mh">0x02a00</span><span class="p">);</span>

	<span class="cm">/* Set the color mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">osd_mode</span> <span class="o">=</span> <span class="n">IVTV_OSD_BPP_8</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">32</span>:
			<span class="n">osd_mode</span> <span class="o">=</span> <span class="n">IVTV_OSD_BPP_32</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">16</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">osd_mode</span> <span class="o">=</span> <span class="n">IVTV_OSD_BPP_16_444</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">osd_mode</span> <span class="o">=</span> <span class="n">IVTV_OSD_BPP_16_555</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">osd_mode</span> <span class="o">=</span> <span class="n">IVTV_OSD_BPP_16_565</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;ivtvfb_set_var - Invalid bpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;ivtvfb_set_var - Invalid bpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set video mode. Although rare, the display can become scrambled even</span>
<span class="cm">	   if we don&#39;t change mode. Always &#39;bounce&#39; to osd_mode via mode 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd_mode</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_PIXEL_FORMAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_PIXEL_FORMAT</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">osd_mode</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">bytes_per_pixel</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Set the flicker filter */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FB_VMODE_NONINTERLACED</span>: <span class="cm">/* Filter on */</span>
			<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_FLICKER_STATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">FB_VMODE_INTERLACED</span>: <span class="cm">/* Filter off */</span>
			<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_FLICKER_STATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;ivtvfb_set_var - Invalid video mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Read the current osd info */</span>
	<span class="n">ivtvfb_get_osd_coords</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivtv_osd</span><span class="p">);</span>

	<span class="cm">/* Now set the OSD to the size we want */</span>
	<span class="n">ivtv_osd</span><span class="p">.</span><span class="n">pixel_stride</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">;</span>
	<span class="n">ivtv_osd</span><span class="p">.</span><span class="n">lines</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">;</span>
	<span class="n">ivtv_osd</span><span class="p">.</span><span class="n">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ivtv_osd</span><span class="p">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ivtvfb_set_osd_coords</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivtv_osd</span><span class="p">);</span>

	<span class="cm">/* Can&#39;t seem to find the right API combo for this.</span>
<span class="cm">	   Use another function which does what we need through direct register access. */</span>
	<span class="n">ivtv_window</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">ivtv_window</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="cm">/* Minimum margin cannot be 0, as X won&#39;t allow such a mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ivtv_window</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ivtv_window</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">ivtvfb_set_display_window</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ivtv_window</span><span class="p">);</span>

	<span class="cm">/* Pass screen size back to yuv handler */</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">osd_full_w</span> <span class="o">=</span> <span class="n">ivtv_osd</span><span class="p">.</span><span class="n">pixel_stride</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">osd_full_h</span> <span class="o">=</span> <span class="n">ivtv_osd</span><span class="p">.</span><span class="n">lines</span><span class="p">;</span>

	<span class="cm">/* Force update of yuv registers */</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">yuv_forced_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Keep a copy of these settings */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">fbvar_cur</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">fbvar_cur</span><span class="p">));</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Display size: %dx%d (virtual %dx%d) @ %dbpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
		      <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span>
		      <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Display position: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">);</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Display filter: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Color space: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">?</span> <span class="s">&quot;YUV&quot;</span> <span class="o">:</span> <span class="s">&quot;RGB&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_get_fix</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_fix_screeninfo</span> <span class="o">*</span><span class="n">fix</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;ivtvfb_get_fix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">fix</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_fix_screeninfo</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="s">&quot;cx23415 TV out&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">fix</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">));</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_start</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_pbase</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">smem_len</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FB_TYPE_PACKED_PIXELS</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">visual</span> <span class="o">=</span> <span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="o">?</span> <span class="n">FB_VISUAL_PSEUDOCOLOR</span> <span class="o">:</span> <span class="n">FB_VISUAL_TRUECOLOR</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">xpanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ypanstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">ywrapstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">line_length</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_byte_stride</span><span class="p">;</span>
	<span class="n">fix</span><span class="o">-&gt;</span><span class="n">accel</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Check the requested display mode, returning -EINVAL if we can&#39;t</span>
<span class="cm">   handle it. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">_ivtvfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">osd_height_limit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pixclock</span><span class="p">,</span> <span class="n">hlimit</span><span class="p">,</span> <span class="n">vlimit</span><span class="p">;</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;ivtvfb_check_var</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Set base references for mode calcs. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pixclock</span> <span class="o">=</span> <span class="mi">84316</span><span class="p">;</span>
		<span class="n">hlimit</span> <span class="o">=</span> <span class="mi">776</span><span class="p">;</span>
		<span class="n">vlimit</span> <span class="o">=</span> <span class="mi">591</span><span class="p">;</span>
		<span class="n">osd_height_limit</span> <span class="o">=</span> <span class="mi">576</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pixclock</span> <span class="o">=</span> <span class="mi">83926</span><span class="p">;</span>
		<span class="n">hlimit</span> <span class="o">=</span> <span class="mi">776</span><span class="p">;</span>
		<span class="n">vlimit</span> <span class="o">=</span> <span class="mi">495</span><span class="p">;</span>
		<span class="n">osd_height_limit</span> <span class="o">=</span> <span class="mi">480</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* To find out the true mode, check green length */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">11</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">red</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">green</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">blue</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">transp</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid colour mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the resolution */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">IVTV_OSD_MAX_WIDTH</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">osd_height_limit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid resolution: %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Max horizontal size is 1023 @ 32bpp, 2046 &amp; 16bpp, 4092 @ 8bpp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&gt;</span> <span class="mi">4095</span> <span class="o">/</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">*</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">*</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span> <span class="o">&lt;</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid virtual resolution: %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Some extra checks if in 8 bit mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Width must be a multiple of 4 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid resolution for 8bpp: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid virtual resolution for 8bpp: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Width must be a multiple of 2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid resolution for 16bpp: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid virtual resolution for 16bpp: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Now check the offsets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span> <span class="o">||</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">&gt;=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid offset: %d (%d) %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check pixel format */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid nonstd % d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check video mode */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">FB_VMODE_INTERLACED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IVTVFB_DEBUG_WARN</span><span class="p">(</span><span class="s">&quot;Invalid video mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check the left &amp; upper margins</span>
<span class="cm">	   If the margins are too large, just center the screen</span>
<span class="cm">	   (enforcing margins causes too many problems) */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">IVTV_OSD_MAX_WIDTH</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">((</span><span class="n">IVTV_OSD_MAX_WIDTH</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">577</span> <span class="o">:</span> <span class="mi">481</span><span class="p">))</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(((</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Maintain overall &#39;size&#39; for a constant refresh rate */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">right_margin</span> <span class="o">=</span> <span class="n">hlimit</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">lower_margin</span> <span class="o">=</span> <span class="n">vlimit</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span> <span class="o">-</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="cm">/* Fixed sync times */</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">hsync_len</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">var</span><span class="o">-&gt;</span><span class="n">vsync_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Non-interlaced / interlaced mode is used to switch the OSD filter</span>
<span class="cm">	   on or off. Adjust the clock timings to maintain a constant</span>
<span class="cm">	   vertical refresh rate. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">)</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">pixclock</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">var</span><span class="o">-&gt;</span><span class="n">pixclock</span> <span class="o">=</span> <span class="n">pixclock</span><span class="p">;</span>

	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_rect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">;</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Display size: %dx%d (virtual %dx%d) @ %dbpp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres</span><span class="p">,</span>
		      <span class="n">var</span><span class="o">-&gt;</span><span class="n">xres_virtual</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yres_virtual</span><span class="p">,</span>
		      <span class="n">var</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">);</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Display position: %d, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">var</span><span class="o">-&gt;</span><span class="n">left_margin</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">upper_margin</span><span class="p">);</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Display filter: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">vmode</span> <span class="o">&amp;</span> <span class="n">FB_VMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">FB_VMODE_NONINTERLACED</span> <span class="o">?</span> <span class="s">&quot;on&quot;</span> <span class="o">:</span> <span class="s">&quot;off&quot;</span><span class="p">);</span>
	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Color space: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">nonstd</span> <span class="o">?</span> <span class="s">&quot;YUV&quot;</span> <span class="o">:</span> <span class="s">&quot;RGB&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_check_var</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>
	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;ivtvfb_check_var</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">_ivtvfb_check_var</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">itv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_pan_display</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_var_screeninfo</span> <span class="o">*</span><span class="n">var</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">osd_pan_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">||</span>
	    <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">+</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres</span> <span class="o">&gt;</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">xres_virtual</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">osd_pan_index</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">.</span><span class="n">line_length</span>
		      <span class="o">+</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span> <span class="o">*</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">osd_pan_index</span><span class="p">,</span> <span class="mh">0x02A0C</span><span class="p">);</span>

	<span class="cm">/* Pass this info back the yuv handler */</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">osd_x_pan</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">xoffset</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">osd_y_pan</span> <span class="o">=</span> <span class="n">var</span><span class="o">-&gt;</span><span class="n">yoffset</span><span class="p">;</span>
	<span class="cm">/* Force update of yuv registers */</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">yuv_forced_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Remember this value */</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="o">-&gt;</span><span class="n">pan_cur</span> <span class="o">=</span> <span class="n">osd_pan_index</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_set_par</span><span class="p">(</span><span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="p">)</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;ivtvfb_set_par</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">ivtvfb_set_var</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">);</span>
	<span class="n">ivtvfb_pan_display</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="n">ivtvfb_get_fix</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fix</span><span class="p">);</span>
	<span class="n">ivtv_firmware_check</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="s">&quot;ivtvfb_set_par&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_setcolreg</span><span class="p">(</span><span class="kt">unsigned</span> <span class="n">regno</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">red</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">green</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="n">blue</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">transp</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">color</span><span class="p">,</span> <span class="o">*</span><span class="n">palette</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">color</span> <span class="o">=</span> <span class="p">((</span><span class="n">transp</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span><span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">&lt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">regno</span><span class="p">,</span> <span class="mh">0x02a30</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">color</span><span class="p">,</span> <span class="mh">0x02a34</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="o">-&gt;</span><span class="n">palette_cur</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regno</span> <span class="o">&gt;=</span> <span class="mi">16</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">palette</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">pseudo_palette</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">var</span><span class="p">.</span><span class="n">green</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">color</span> <span class="o">=</span> <span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xf000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">color</span> <span class="o">=</span> <span class="p">((</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">6</span>:
				<span class="n">color</span> <span class="o">=</span> <span class="p">(</span><span class="n">red</span> <span class="o">&amp;</span> <span class="mh">0xf800</span> <span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">green</span> <span class="o">&amp;</span> <span class="mh">0xfc00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">((</span><span class="n">blue</span> <span class="o">&amp;</span> <span class="mh">0xf800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">palette</span><span class="p">[</span><span class="n">regno</span><span class="p">]</span> <span class="o">=</span> <span class="n">color</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We don&#39;t really support blanking. All this does is enable or</span>
<span class="cm">   disable the OSD. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_blank</span><span class="p">(</span><span class="kt">int</span> <span class="n">blank_mode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fb_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">par</span><span class="p">;</span>

	<span class="n">IVTVFB_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Set blanking mode : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blank_mode</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">blank_mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FB_BLANK_UNBLANK</span>:
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_STATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ivtv_call_hw</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">IVTV_HW_SAA7127</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_NORMAL</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_HSYNC_SUSPEND</span>:
	<span class="k">case</span> <span class="n">FB_BLANK_VSYNC_SUSPEND</span>:
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_STATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ivtv_call_hw</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">IVTV_HW_SAA7127</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">FB_BLANK_POWERDOWN</span>:
		<span class="n">ivtv_call_hw</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">IVTV_HW_SAA7127</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_STATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="o">-&gt;</span><span class="n">blank_cur</span> <span class="o">=</span> <span class="n">blank_mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fb_ops</span> <span class="n">ivtvfb_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_write</span>       <span class="o">=</span> <span class="n">ivtvfb_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_check_var</span>   <span class="o">=</span> <span class="n">ivtvfb_check_var</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_set_par</span>     <span class="o">=</span> <span class="n">ivtvfb_set_par</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_setcolreg</span>   <span class="o">=</span> <span class="n">ivtvfb_setcolreg</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_fillrect</span>    <span class="o">=</span> <span class="n">cfb_fillrect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_copyarea</span>    <span class="o">=</span> <span class="n">cfb_copyarea</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_imageblit</span>   <span class="o">=</span> <span class="n">cfb_imageblit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_cursor</span>      <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_ioctl</span>       <span class="o">=</span> <span class="n">ivtvfb_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_pan_display</span> <span class="o">=</span> <span class="n">ivtvfb_pan_display</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fb_blank</span>       <span class="o">=</span> <span class="n">ivtvfb_blank</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Restore hardware after firmware restart */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtvfb_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ivtvfb_set_var</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">fbvar_cur</span><span class="p">);</span>
	<span class="n">ivtvfb_blank</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">blank_cur</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mh">0x02a30</span><span class="p">);</span>
		<span class="n">write_reg</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">palette_cur</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mh">0x02a34</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">pan_cur</span><span class="p">,</span> <span class="mh">0x02a0c</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Initialization */</span>


<span class="cm">/* Setup our initial video mode */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_init_vidmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">start_window</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_height</span><span class="p">;</span>

	<span class="cm">/* Color mode */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osd_depth</span> <span class="o">!=</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">osd_depth</span> <span class="o">!=</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">osd_depth</span> <span class="o">!=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">osd_depth</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">osd_depth</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">bytes_per_pixel</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Horizontal size &amp; position */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osd_xres</span> <span class="o">&gt;</span> <span class="mi">720</span><span class="p">)</span>
		<span class="n">osd_xres</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>

	<span class="cm">/* Must be a multiple of 4 for 8bpp &amp; 2 for 16bpp */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd_depth</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">osd_xres</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">osd_depth</span> <span class="o">==</span> <span class="mi">16</span><span class="p">)</span>
		<span class="n">osd_xres</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">start_window</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">osd_xres</span> <span class="o">?</span> <span class="n">osd_xres</span> <span class="o">:</span> <span class="mi">640</span><span class="p">;</span>

	<span class="cm">/* Check horizontal start (osd_left). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd_left</span> <span class="o">&amp;&amp;</span> <span class="n">osd_left</span> <span class="o">+</span> <span class="n">start_window</span><span class="p">.</span><span class="n">width</span> <span class="o">&gt;</span> <span class="mi">721</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_ERR</span><span class="p">(</span><span class="s">&quot;Invalid osd_left - assuming default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">osd_left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hardware coords start at 0, user coords start at 1. */</span>
	<span class="n">osd_left</span><span class="o">--</span><span class="p">;</span>

	<span class="n">start_window</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">osd_left</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span>
		 <span class="n">osd_left</span> <span class="o">:</span> <span class="p">((</span><span class="n">IVTV_OSD_MAX_WIDTH</span> <span class="o">-</span> <span class="n">start_window</span><span class="p">.</span><span class="n">width</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_byte_stride</span> <span class="o">=</span>
			<span class="n">start_window</span><span class="p">.</span><span class="n">width</span> <span class="o">*</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">bytes_per_pixel</span><span class="p">;</span>

	<span class="cm">/* Vertical size &amp; position */</span>

	<span class="n">max_height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">osd_yres</span> <span class="o">&gt;</span> <span class="n">max_height</span><span class="p">)</span>
		<span class="n">osd_yres</span> <span class="o">=</span> <span class="n">max_height</span><span class="p">;</span>

	<span class="n">start_window</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">osd_yres</span> <span class="o">?</span>
		<span class="n">osd_yres</span> <span class="o">:</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">480</span> <span class="o">:</span> <span class="mi">400</span><span class="p">;</span>

	<span class="cm">/* Check vertical start (osd_upper). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">osd_upper</span> <span class="o">+</span> <span class="n">start_window</span><span class="p">.</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">max_height</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_ERR</span><span class="p">(</span><span class="s">&quot;Invalid osd_upper - assuming default</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">osd_upper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Hardware coords start at 0, user coords start at 1. */</span>
	<span class="n">osd_upper</span><span class="o">--</span><span class="p">;</span>

	<span class="n">start_window</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">osd_upper</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">osd_upper</span> <span class="o">:</span> <span class="p">((</span><span class="n">max_height</span> <span class="o">-</span> <span class="n">start_window</span><span class="p">.</span><span class="n">height</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_width</span> <span class="o">=</span> <span class="n">start_window</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_height</span> <span class="o">=</span> <span class="n">start_window</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="cm">/* Generate a valid fb_var_screeninfo */</span>

	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">xres</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_width</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">yres</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_height</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">xres_virtual</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_width</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">yres_virtual</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">display_height</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">vmode</span> <span class="o">=</span> <span class="p">(</span><span class="n">osd_laced</span> <span class="o">?</span> <span class="n">FB_VMODE_INTERLACED</span> <span class="o">:</span> <span class="n">FB_VMODE_NONINTERLACED</span><span class="p">);</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">left_margin</span> <span class="o">=</span> <span class="n">start_window</span><span class="p">.</span><span class="n">left</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">upper_margin</span> <span class="o">=</span> <span class="n">start_window</span><span class="p">.</span><span class="n">top</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">accel_flags</span> <span class="o">=</span> <span class="n">FB_ACCEL_NONE</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">.</span><span class="n">nonstd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* We&#39;ve filled in the most data, let the usual mode check</span>
<span class="cm">	   routine fill in the rest. */</span>
	<span class="n">_ivtvfb_check_var</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">,</span> <span class="n">itv</span><span class="p">);</span>

	<span class="cm">/* Generate valid fb_fix_screeninfo */</span>

	<span class="n">ivtvfb_get_fix</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_fix</span><span class="p">);</span>

	<span class="cm">/* Generate valid fb_info */</span>

	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">node</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">FBINFO_FLAG_DEFAULT</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ivtvfb_ops</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">par</span> <span class="o">=</span> <span class="n">itv</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">var</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_defined</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">fix</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_fix</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">screen_base</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="p">)</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">fbops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ivtvfb_ops</span><span class="p">;</span>

	<span class="cm">/* Supply some monitor specs. Bogus values will do for now */</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmin</span> <span class="o">=</span> <span class="mi">8000</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">hfmax</span> <span class="o">=</span> <span class="mi">70000</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmin</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">monspecs</span><span class="p">.</span><span class="n">vfmax</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

	<span class="cm">/* Allocate color map */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb_alloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">cmap</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IVTVFB_ERR</span><span class="p">(</span><span class="s">&quot;abort, unable to alloc cmap</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate the pseudo palette */</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">pseudo_palette</span> <span class="o">=</span>
		<span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="o">|</span><span class="n">__GFP_NOWARN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_ERR</span><span class="p">(</span><span class="s">&quot;abort, unable to alloc pseudo palette</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find OSD buffer base &amp; size. Add to mtrr. Zero osd buffer. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_init_io</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">serialize_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_init_on_first_open</span><span class="p">(</span><span class="n">itv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">serialize_lock</span><span class="p">);</span>
		<span class="n">IVTVFB_ERR</span><span class="p">(</span><span class="s">&quot;Failed to initialize ivtv</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">serialize_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ivtvfb_get_framebuffer</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_rbase</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_ERR</span><span class="p">(</span><span class="s">&quot;Firmware failed to respond</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* The osd buffer size depends on the number of video buffers allocated</span>
<span class="cm">	   on the PVR350 itself. For now we&#39;ll hardcode the smallest osd buffer</span>
<span class="cm">	   size to prevent any overlap. */</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span> <span class="o">=</span> <span class="mi">1704960</span><span class="p">;</span>

	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_pbase</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">IVTV_DECODER_OFFSET</span> <span class="o">+</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_rbase</span><span class="p">;</span>
	<span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_vbase</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dec_mem</span> <span class="o">+</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_rbase</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_ERR</span><span class="p">(</span><span class="s">&quot;abort, video memory 0x%x @ 0x%lx isn&#39;t mapped!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_pbase</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IVTVFB_INFO</span><span class="p">(</span><span class="s">&quot;Framebuffer at 0x%lx, mapped to 0x%p, size %dk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_pbase</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">,</span>
			<span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="p">{</span>
		<span class="cm">/* Find the largest power of two that maps the whole buffer */</span>
		<span class="kt">int</span> <span class="n">size_shift</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">size_shift</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">size_shift</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">size_shift</span><span class="o">++</span><span class="p">;</span>
		<span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_start_aligned_physaddr</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_pbase</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">size_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_end_aligned_physaddr</span> <span class="o">=</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_pbase</span> <span class="o">+</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span><span class="p">;</span>
		<span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_end_aligned_physaddr</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">size_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_end_aligned_physaddr</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">size_shift</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mtrr_add</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_start_aligned_physaddr</span><span class="p">,</span>
			<span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_end_aligned_physaddr</span> <span class="o">-</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_start_aligned_physaddr</span><span class="p">,</span>
			     <span class="n">MTRR_TYPE_WRCOMB</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IVTVFB_INFO</span><span class="p">(</span><span class="s">&quot;disabled mttr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_start_aligned_physaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_end_aligned_physaddr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* Blank the entire osd. */</span>
	<span class="n">memset_io</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_vbase</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">video_buffer_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Release any memory we&#39;ve grabbed &amp; remove mtrr entry */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtvfb_release_buffers</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>

	<span class="cm">/* Release cmap */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">cmap</span><span class="p">.</span><span class="n">len</span><span class="p">)</span>
		<span class="n">fb_dealloc_cmap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">cmap</span><span class="p">);</span>

	<span class="cm">/* Release pseudo palette */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">.</span><span class="n">pseudo_palette</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MTRR</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_end_aligned_physaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mtrr_del</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_start_aligned_physaddr</span><span class="p">,</span>
			<span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_end_aligned_physaddr</span> <span class="o">-</span> <span class="n">oi</span><span class="o">-&gt;</span><span class="n">fb_start_aligned_physaddr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">oi</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the specified card */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_ERR</span><span class="p">(</span><span class="s">&quot;Card %d already initialised</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ivtvfb_card_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">osd_info</span><span class="p">),</span>
					<span class="n">GFP_ATOMIC</span><span class="o">|</span><span class="n">__GFP_NOWARN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTVFB_ERR</span><span class="p">(</span><span class="s">&quot;Failed to allocate memory for osd_info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find &amp; setup the OSD buffer */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">ivtvfb_init_io</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtvfb_release_buffers</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set the startup video mode information */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rc</span> <span class="o">=</span> <span class="n">ivtvfb_init_vidmode</span><span class="p">(</span><span class="n">itv</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ivtvfb_release_buffers</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Register the framebuffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ivtvfb_release_buffers</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_video_pbase</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="o">-&gt;</span><span class="n">video_pbase</span><span class="p">;</span>

	<span class="cm">/* Set the card to the requested mode */</span>
	<span class="n">ivtvfb_set_par</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">);</span>

	<span class="cm">/* Set color 0 to black */</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x02a30</span><span class="p">);</span>
	<span class="n">write_reg</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x02a34</span><span class="p">);</span>

	<span class="cm">/* Enable the osd */</span>
	<span class="n">ivtvfb_blank</span><span class="p">(</span><span class="n">FB_BLANK_UNBLANK</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">);</span>

	<span class="cm">/* Enable restart */</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">ivtvfb_restore</span> <span class="o">=</span> <span class="n">ivtvfb_restore</span><span class="p">;</span>

	<span class="cm">/* Allocate DMA */</span>
	<span class="n">ivtv_udma_alloc</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ivtvfb_callback_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ivtv</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ivtvfb_init_card</span><span class="p">(</span><span class="n">itv</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IVTVFB_INFO</span><span class="p">(</span><span class="s">&quot;Framebuffer registered on %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtvfb_callback_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_device</span> <span class="o">*</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">v4l2_dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ivtv</span><span class="p">,</span> <span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">osd_info</span> <span class="o">*</span><span class="n">oi</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unregister_framebuffer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IVTVFB_WARN</span><span class="p">(</span><span class="s">&quot;Framebuffer %d is in use, cannot unload</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">itv</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">IVTVFB_INFO</span><span class="p">(</span><span class="s">&quot;Unregister framebuffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">instance</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">ivtvfb_restore</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">ivtvfb_blank</span><span class="p">(</span><span class="n">FB_BLANK_VSYNC_SUSPEND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">oi</span><span class="o">-&gt;</span><span class="n">ivtvfb_info</span><span class="p">);</span>
		<span class="n">ivtvfb_release_buffers</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_video_pbase</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ivtvfb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ivtvfb_card_id</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">ivtvfb_card_id</span> <span class="o">&gt;=</span> <span class="n">IVTV_MAX_CARDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ivtvfb:  ivtvfb_card_id parameter is out of range (valid range: -1 - %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">IVTV_MAX_CARDS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">drv</span> <span class="o">=</span> <span class="n">driver_find</span><span class="p">(</span><span class="s">&quot;ivtv&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_bus_type</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">driver_for_each_device</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">registered</span><span class="p">,</span> <span class="n">ivtvfb_callback_init</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">err</span><span class="p">;</span>	<span class="cm">/* suppress compiler warning */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ivtvfb:  no cards found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ivtvfb_cleanup</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;ivtvfb:  Unloading framebuffer module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">drv</span> <span class="o">=</span> <span class="n">driver_find</span><span class="p">(</span><span class="s">&quot;ivtv&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_bus_type</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">driver_for_each_device</span><span class="p">(</span><span class="n">drv</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ivtvfb_callback_cleanup</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">err</span><span class="p">;</span>	<span class="cm">/* suppress compiler warning */</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ivtvfb_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ivtvfb_cleanup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
