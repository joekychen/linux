<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › ivtv › ivtv-ioctl.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>ivtv-ioctl.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">    ioctl system call</span>
<span class="cm">    Copyright (C) 2003-2004  Kevin Thayer &lt;nufan_wfk at yahoo.com&gt;</span>
<span class="cm">    Copyright (C) 2005-2007  Hans Verkuil &lt;hverkuil@xs4all.nl&gt;</span>

<span class="cm">    This program is free software; you can redistribute it and/or modify</span>
<span class="cm">    it under the terms of the GNU General Public License as published by</span>
<span class="cm">    the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">    (at your option) any later version.</span>

<span class="cm">    This program is distributed in the hope that it will be useful,</span>
<span class="cm">    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">    GNU General Public License for more details.</span>

<span class="cm">    You should have received a copy of the GNU General Public License</span>
<span class="cm">    along with this program; if not, write to the Free Software</span>
<span class="cm">    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#include &quot;ivtv-driver.h&quot;</span>
<span class="cp">#include &quot;ivtv-version.h&quot;</span>
<span class="cp">#include &quot;ivtv-mailbox.h&quot;</span>
<span class="cp">#include &quot;ivtv-i2c.h&quot;</span>
<span class="cp">#include &quot;ivtv-queue.h&quot;</span>
<span class="cp">#include &quot;ivtv-fileops.h&quot;</span>
<span class="cp">#include &quot;ivtv-vbi.h&quot;</span>
<span class="cp">#include &quot;ivtv-routing.h&quot;</span>
<span class="cp">#include &quot;ivtv-streams.h&quot;</span>
<span class="cp">#include &quot;ivtv-yuv.h&quot;</span>
<span class="cp">#include &quot;ivtv-ioctl.h&quot;</span>
<span class="cp">#include &quot;ivtv-gpio.h&quot;</span>
<span class="cp">#include &quot;ivtv-controls.h&quot;</span>
<span class="cp">#include &quot;ivtv-cards.h&quot;</span>
<span class="cp">#include &lt;media/saa7127.h&gt;</span>
<span class="cp">#include &lt;media/tveeprom.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-event.h&gt;</span>
<span class="cp">#include &lt;linux/dvb/audio.h&gt;</span>

<span class="n">u16</span> <span class="nf">ivtv_service2vbi</span><span class="p">(</span><span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_SLICED_TELETEXT_B</span>:
			<span class="k">return</span> <span class="n">IVTV_SLICED_TYPE_TELETEXT_B</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_SLICED_CAPTION_525</span>:
			<span class="k">return</span> <span class="n">IVTV_SLICED_TYPE_CAPTION_525</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_SLICED_WSS_625</span>:
			<span class="k">return</span> <span class="n">IVTV_SLICED_TYPE_WSS_625</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_SLICED_VPS</span>:
			<span class="k">return</span> <span class="n">IVTV_SLICED_TYPE_VPS</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">valid_service_line</span><span class="p">(</span><span class="kt">int</span> <span class="n">field</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">is_pal</span> <span class="o">&amp;&amp;</span> <span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">line</span> <span class="o">!=</span> <span class="mi">23</span> <span class="o">||</span> <span class="n">field</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="o">||</span>
	       <span class="p">(</span><span class="o">!</span><span class="n">is_pal</span> <span class="o">&amp;&amp;</span> <span class="n">line</span> <span class="o">&gt;=</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="mi">22</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">select_service_from_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">field</span><span class="p">,</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="n">u16</span> <span class="n">set</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">valid_set</span> <span class="o">=</span> <span class="p">(</span><span class="n">is_pal</span> <span class="o">?</span> <span class="n">V4L2_SLICED_VBI_625</span> <span class="o">:</span> <span class="n">V4L2_SLICED_VBI_525</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">set</span> <span class="o">=</span> <span class="n">set</span> <span class="o">&amp;</span> <span class="n">valid_set</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">set</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">!</span><span class="n">valid_service_line</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">is_pal</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_pal</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">21</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">16</span> <span class="o">&amp;&amp;</span> <span class="n">field</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">V4L2_SLICED_VPS</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">V4L2_SLICED_VPS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">23</span> <span class="o">&amp;&amp;</span> <span class="n">field</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">set</span> <span class="o">&amp;</span> <span class="n">V4L2_SLICED_WSS_625</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">V4L2_SLICED_WSS_625</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">==</span> <span class="mi">23</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">set</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ivtv_expand_service_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">set</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_set</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_service_from_set</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">set</span><span class="p">,</span> <span class="n">is_pal</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">check_service_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="kt">int</span> <span class="n">is_pal</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">select_service_from_set</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">l</span><span class="p">],</span> <span class="n">is_pal</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">ivtv_get_service_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set</span> <span class="o">|=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">l</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">set</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ivtv_set_osd_alpha</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_GLOBAL_ALPHA</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_global_alpha_state</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_global_alpha</span><span class="p">,</span> <span class="o">!</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_local_alpha_state</span><span class="p">);</span>
	<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_CHROMA_KEY</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_chroma_key_state</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_chroma_key</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ivtv_set_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">single_step</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="cm">/* No change? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">single_step</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">single_step</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Single step video and no need to change direction */</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_DEC_STEP_VIDEO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">single_step</span><span class="p">)</span>
		<span class="cm">/* Need to change direction */</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1000</span> <span class="o">:</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1000</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80000000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">1000</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">1500</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x40000000</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">3</span> <span class="o">:</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">v4l2_ctrl_g_ctrl</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">video_b_frames</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1500</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">==</span> <span class="mi">500</span><span class="p">)</span> <span class="o">?</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed_mute_audio</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1500</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1500</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">2000</span> <span class="o">||</span> <span class="n">speed</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2000</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">speed</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">1000</span> <span class="o">&amp;&amp;</span> <span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">speed</span><span class="p">);</span>

	<span class="cm">/* If not decoding, just change speed setting */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">decoding</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">got_sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Stop all DMA and decoding activity */</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_DEC_PAUSE_PLAYBACK</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* Wait for any DMA to finish */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">serialize_lock</span><span class="p">);</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DMA</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">got_sig</span> <span class="o">=</span> <span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">got_sig</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">got_sig</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">schedule</span><span class="p">();</span>
		<span class="p">}</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">serialize_lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">got_sig</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

		<span class="cm">/* Change Speed safely */</span>
		<span class="n">ivtv_api</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_DEC_SET_PLAYBACK_SPEED</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
		<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Setting Speed to 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">single_step</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_DEC_STEP_VIDEO</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_validate_speed</span><span class="p">(</span><span class="kt">int</span> <span class="n">cur_speed</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">fact</span> <span class="o">=</span> <span class="n">new_speed</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">s</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cur_speed</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">new_speed</span> <span class="o">=</span> <span class="o">-</span><span class="n">new_speed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cur_speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">cur_speed</span> <span class="o">=</span> <span class="o">-</span><span class="n">cur_speed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cur_speed</span> <span class="o">&lt;=</span> <span class="n">new_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_speed</span> <span class="o">&gt;</span> <span class="mi">1500</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fact</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_speed</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fact</span> <span class="o">*</span> <span class="mi">1500</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_speed</span> <span class="o">&gt;=</span> <span class="mi">2000</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fact</span> <span class="o">*</span> <span class="mi">2000</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_speed</span> <span class="o">&gt;=</span> <span class="mi">1500</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fact</span> <span class="o">*</span> <span class="mi">1500</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_speed</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">fact</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_speed</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">new_speed</span> <span class="o">==</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">fact</span> <span class="o">*</span> <span class="n">new_speed</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">new_speed</span><span class="p">;</span>
	<span class="n">new_speed</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">new_speed</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">1000</span> <span class="o">/</span> <span class="n">cur_speed</span> <span class="o">==</span> <span class="n">new_speed</span><span class="p">)</span>
		<span class="n">new_speed</span> <span class="o">+=</span> <span class="p">(</span><span class="n">cur_speed</span> <span class="o">&lt;</span> <span class="n">s</span><span class="p">)</span> <span class="o">?</span> <span class="o">-</span><span class="mi">1</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_speed</span> <span class="o">&gt;</span> <span class="mi">60</span><span class="p">)</span> <span class="k">return</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="n">fact</span> <span class="o">*</span> <span class="mi">60</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1000</span> <span class="o">/</span> <span class="p">(</span><span class="n">fact</span> <span class="o">*</span> <span class="n">new_speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_video_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">v4l2_decoder_cmd</span> <span class="o">*</span><span class="n">dc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">try</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">IVTV_DEC_STREAM_TYPE_MPG</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_DEC_CMD_START</span>: <span class="p">{</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">V4L2_DEC_CMD_START_MUTE_AUDIO</span><span class="p">;</span>
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">ivtv_validate_speed</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">speed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">V4L2_DEC_START_FMT_GOP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">dc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="n">V4L2_DEC_START_FMT_NONE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="mi">500</span> <span class="o">&amp;&amp;</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">speed</span> <span class="o">!=</span> <span class="mi">1500</span><span class="p">)</span>
			<span class="n">dc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">1000</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span>
					<span class="n">V4L2_DEC_CMD_START_MUTE_AUDIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>

		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed_mute_audio</span> <span class="o">=</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_DEC_CMD_START_MUTE_AUDIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_set_output_mode</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">OUT_MPG</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OUT_MPG</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DEC_PAUSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* forces ivtv_set_speed to be called */</span>
			<span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">ivtv_start_decoding</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">.</span><span class="n">speed</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">V4L2_DEC_CMD_STOP</span>:
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">V4L2_DEC_CMD_STOP_IMMEDIATELY</span> <span class="o">|</span> <span class="n">V4L2_DEC_CMD_STOP_TO_BLACK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_DEC_CMD_STOP_IMMEDIATELY</span><span class="p">)</span>
			<span class="n">dc</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">pts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">decoding</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">output_mode</span> <span class="o">!=</span> <span class="n">OUT_MPG</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">output_mode</span> <span class="o">=</span> <span class="n">OUT_NONE</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_stop_v4l2_decode_stream</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">.</span><span class="n">pts</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">V4L2_DEC_CMD_PAUSE</span>:
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">V4L2_DEC_CMD_PAUSE_TO_BLACK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">output_mode</span> <span class="o">!=</span> <span class="n">OUT_MPG</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">decoding</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_DEC_PAUSE_PLAYBACK</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_DEC_CMD_PAUSE_TO_BLACK</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DEC_PAUSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_DEC_CMD_RESUME</span>:
		<span class="n">dc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">output_mode</span> <span class="o">!=</span> <span class="n">OUT_MPG</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DEC_PAUSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>
			<span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">ivtv_start_decoding</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">speed</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_fmt_sliced_vbi_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">vbifmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">;</span>

	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_SLICED_VBI_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">io_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">36</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_60hz</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">;</span>
		<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_WSS_625</span><span class="p">;</span>
		<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_VPS</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">=</span> <span class="n">ivtv_get_service_set</span><span class="p">(</span><span class="n">vbifmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_YUV</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_HM12</span><span class="p">;</span>
		<span class="cm">/* YUV size is (Y=(h*720) + UV=(h*(720/2))) */</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">*</span> <span class="mi">720</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MPEG</span><span class="p">;</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_fmt_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_vbi_format</span> <span class="o">*</span><span class="n">vbifmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">;</span>

	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">sampling_rate</span> <span class="o">=</span> <span class="mi">27000000</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="mi">248</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">samples_per_line</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">raw_decoder_line_size</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">sample_format</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_GREY</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">count</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_fmt_sliced_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">vbifmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">io_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">36</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_VBI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="n">V4L2_SLICED_VBI_625</span> <span class="o">:</span>
			<span class="n">V4L2_SLICED_VBI_525</span><span class="p">;</span>
		<span class="n">ivtv_expand_service_set</span><span class="p">(</span><span class="n">vbifmt</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">sd_video</span><span class="p">,</span> <span class="n">vbi</span><span class="p">,</span> <span class="n">g_sliced_fmt</span><span class="p">,</span> <span class="n">vbifmt</span><span class="p">);</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">=</span> <span class="n">ivtv_get_service_set</span><span class="p">(</span><span class="n">vbifmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_pix_format</span> <span class="o">*</span><span class="n">pixfmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_YUV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">lace_mode</span> <span class="o">&amp;</span> <span class="n">IVTV_YUV_MODE_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IVTV_YUV_MODE_INTERLACED</span>:
			<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">lace_mode</span> <span class="o">&amp;</span> <span class="n">IVTV_YUV_SYNC_MASK</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">V4L2_FIELD_INTERLACED_BT</span> <span class="o">:</span> <span class="n">V4L2_FIELD_INTERLACED_TB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IVTV_YUV_MODE_PROGRESSIVE</span>:
			<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_ANY</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_HM12</span><span class="p">;</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">v4l2_src_w</span><span class="p">;</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">v4l2_src_h</span><span class="p">;</span>
		<span class="cm">/* YUV size is (Y=(h*w) + UV=(h*(w/2))) */</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span>
			<span class="mi">1080</span> <span class="o">*</span> <span class="p">((</span><span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">V4L2_PIX_FMT_MPEG</span><span class="p">;</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="mi">128</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">;</span>
		<span class="n">pixfmt</span><span class="o">-&gt;</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_fmt_vid_out_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_window</span> <span class="o">*</span><span class="n">winfmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">chromakey</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_chroma_key</span><span class="p">;</span>
	<span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_global_alpha</span><span class="p">;</span>
	<span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">clips</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">clipcount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_rect</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">winfmt</span><span class="o">-&gt;</span><span class="n">w</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_rect</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_try_fmt_sliced_vbi_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ivtv_g_fmt_sliced_vbi_out</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">min_h</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">720</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_ENC_STREAM_TYPE_YUV</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* YUV height must be a multiple of 32 */</span>
		<span class="n">h</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1f</span><span class="p">;</span>
		<span class="n">min_h</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">min_h</span><span class="p">);</span>
	<span class="n">ivtv_g_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_try_fmt_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ivtv_g_fmt_vbi_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_try_fmt_sliced_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">vbifmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_VBI</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ivtv_g_fmt_sliced_vbi_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="cm">/* set sliced VBI capture format */</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">io_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_sliced_vbi_data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">36</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">reserved</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">service_set</span><span class="p">)</span>
		<span class="n">ivtv_expand_service_set</span><span class="p">(</span><span class="n">vbifmt</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span><span class="p">);</span>
	<span class="n">check_service_set</span><span class="p">(</span><span class="n">vbifmt</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span><span class="p">);</span>
	<span class="n">vbifmt</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">=</span> <span class="n">ivtv_get_service_set</span><span class="p">(</span><span class="n">vbifmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_try_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="n">s32</span> <span class="n">w</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">h</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">field</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ivtv_g_fmt_vid_out</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">w</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">720</span><span class="p">);</span>
	<span class="n">w</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="cm">/* Why can the height be 576 even when the output is NTSC?</span>

<span class="cm">	   Internally the buffers of the PVR350 are always set to 720x576. The</span>
<span class="cm">	   decoded video frame will always be placed in the top left corner of</span>
<span class="cm">	   this buffer. For any video which is not 720x576, the buffer will</span>
<span class="cm">	   then be cropped to remove the unused right and lower areas, with</span>
<span class="cm">	   the remaining image being scaled by the hardware to fit the display</span>
<span class="cm">	   area. The video can be scaled both up and down, so a 720x480 video</span>
<span class="cm">	   can be displayed full-screen on PAL and a 720x576 video can be</span>
<span class="cm">	   displayed without cropping on NTSC.</span>

<span class="cm">	   Note that the scaling only occurs on the video stream, the osd</span>
<span class="cm">	   resolution is locked to the broadcast standard and not scaled.</span>

<span class="cm">	   Thanks to Ian Armstrong for this explanation. */</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">576</span><span class="p">);</span>
	<span class="n">h</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_YUV</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_try_fmt_vid_out_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">chromakey</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">chromakey</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">global_alpha</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">ivtv_g_fmt_vid_out_overlay</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">chromakey</span> <span class="o">=</span> <span class="n">chromakey</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span> <span class="o">=</span> <span class="n">global_alpha</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_fmt_sliced_vbi_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ivtv_g_fmt_sliced_vbi_out</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="n">mbus_fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ivtv_try_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">w</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">h</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">width</span> <span class="o">==</span> <span class="n">w</span> <span class="o">&amp;&amp;</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">height</span> <span class="o">==</span> <span class="n">h</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">w</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_ctrl_g_ctrl</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">video_encoding</span><span class="p">)</span> <span class="o">==</span> <span class="n">V4L2_MPEG_VIDEO_ENCODING_MPEG_1</span><span class="p">)</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">/=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">mbus_fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">mbus_fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">h</span><span class="p">;</span>
	<span class="n">mbus_fmt</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">V4L2_MBUS_FMT_FIXED</span><span class="p">;</span>
	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">sd_video</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_mbus_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mbus_fmt</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ivtv_g_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_fmt_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ivtv_raw_vbi</span><span class="p">(</span><span class="n">itv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">sliced_in</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VBI_CAPTURE</span><span class="p">;</span>
	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">sd_video</span><span class="p">,</span> <span class="n">vbi</span><span class="p">,</span> <span class="n">s_raw_fmt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">vbi</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ivtv_g_fmt_vbi_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_fmt_sliced_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_sliced_vbi_format</span> <span class="o">*</span><span class="n">vbifmt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">sliced</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ivtv_try_fmt_sliced_vbi_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_VBI</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">check_service_set</span><span class="p">(</span><span class="n">vbifmt</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_raw_vbi</span><span class="p">(</span><span class="n">itv</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">in</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_BUF_TYPE_SLICED_VBI_CAPTURE</span><span class="p">;</span>
	<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">sd_video</span><span class="p">,</span> <span class="n">vbi</span><span class="p">,</span> <span class="n">s_sliced_fmt</span><span class="p">,</span> <span class="n">vbifmt</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">sliced_in</span><span class="p">,</span> <span class="n">vbifmt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">sliced_in</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yuv_playback_info</span> <span class="o">*</span><span class="n">yi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ivtv_try_fmt_vid_out</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">IVTV_DEC_STREAM_TYPE_YUV</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Return now if we already have some frame data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">stream_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">yi</span><span class="o">-&gt;</span><span class="n">v4l2_src_w</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">yi</span><span class="o">-&gt;</span><span class="n">v4l2_src_h</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_NONE</span>:
		<span class="n">yi</span><span class="o">-&gt;</span><span class="n">lace_mode</span> <span class="o">=</span> <span class="n">IVTV_YUV_MODE_PROGRESSIVE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_ANY</span>:
		<span class="n">yi</span><span class="o">-&gt;</span><span class="n">lace_mode</span> <span class="o">=</span> <span class="n">IVTV_YUV_MODE_AUTO</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED_BT</span>:
		<span class="n">yi</span><span class="o">-&gt;</span><span class="n">lace_mode</span> <span class="o">=</span>
			<span class="n">IVTV_YUV_MODE_INTERLACED</span><span class="o">|</span><span class="n">IVTV_YUV_SYNC_ODD</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_FIELD_INTERLACED_TB</span>:
	<span class="nl">default:</span>
		<span class="n">yi</span><span class="o">-&gt;</span><span class="n">lace_mode</span> <span class="o">=</span> <span class="n">IVTV_YUV_MODE_INTERLACED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">yi</span><span class="o">-&gt;</span><span class="n">lace_sync_field</span> <span class="o">=</span> <span class="p">(</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">lace_mode</span> <span class="o">&amp;</span> <span class="n">IVTV_YUV_SYNC_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">IVTV_YUV_SYNC_EVEN</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_DEC_YUV</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">dma_data_req_size</span> <span class="o">=</span>
			<span class="mi">1080</span> <span class="o">*</span> <span class="p">((</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">v4l2_src_h</span> <span class="o">+</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">31</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_fmt_vid_out_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">ivtv_try_fmt_vid_out_overlay</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_chroma_key</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">chromakey</span><span class="p">;</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_global_alpha</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">win</span><span class="p">.</span><span class="n">global_alpha</span><span class="p">;</span>
		<span class="n">ivtv_set_osd_alpha</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">V4L2_IDENT_NONE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_CHIP_MATCH_HOST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_chip_match_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ident</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">has_cx23415</span> <span class="o">?</span> <span class="n">V4L2_IDENT_CX23415</span> <span class="o">:</span> <span class="n">V4L2_IDENT_CX23416</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CHIP_MATCH_I2C_DRIVER</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CHIP_MATCH_I2C_ADDR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* TODO: is this correct? */</span>
	<span class="k">return</span> <span class="n">ivtv_call_all_err</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_chip_ident</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_itvc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">regs</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u8</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_start</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">IVTV_REG_OFFSET</span> <span class="o">&amp;&amp;</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="n">IVTV_REG_OFFSET</span> <span class="o">+</span> <span class="n">IVTV_REG_SIZE</span><span class="p">)</span>
		<span class="n">reg_start</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">reg_mem</span> <span class="o">-</span> <span class="n">IVTV_REG_OFFSET</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">has_cx23415</span> <span class="o">&amp;&amp;</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&gt;=</span> <span class="n">IVTV_DECODER_OFFSET</span> <span class="o">&amp;&amp;</span>
			<span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="n">IVTV_DECODER_OFFSET</span> <span class="o">+</span> <span class="n">IVTV_DECODER_SIZE</span><span class="p">)</span>
		<span class="n">reg_start</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">dec_mem</span> <span class="o">-</span> <span class="n">IVTV_DECODER_OFFSET</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&lt;</span> <span class="n">IVTV_ENCODER_SIZE</span><span class="p">)</span>
		<span class="n">reg_start</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">enc_mem</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">regs</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">VIDIOC_DBG_G_REGISTER</span><span class="p">)</span>
		<span class="n">regs</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">reg_start</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">regs</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span> <span class="n">regs</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">+</span> <span class="n">reg_start</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_chip_match_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ivtv_itvc</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">VIDIOC_DBG_G_REGISTER</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="cm">/* TODO: subdev errors should not be ignored, this should become a</span>
<span class="cm">	   subdev helper function. */</span>
	<span class="n">ivtv_call_all</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_register</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_chip_match_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ivtv_itvc</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">VIDIOC_DBG_S_REGISTER</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="cm">/* TODO: subdev errors should not be ignored, this should become a</span>
<span class="cm">	   subdev helper function. */</span>
	<span class="n">ivtv_call_all</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_register</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">vcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">];</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="n">IVTV_DRIVER_NAME</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vcap</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">),</span> <span class="s">&quot;PCI:%s&quot;</span><span class="p">,</span> <span class="n">pci_name</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">));</span>
	<span class="n">vcap</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">|</span> <span class="n">V4L2_CAP_DEVICE_CAPS</span><span class="p">;</span>
	<span class="n">vcap</span><span class="o">-&gt;</span><span class="n">device_caps</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">caps</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_enumaudio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">vin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ivtv_get_audio_input</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">vin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">audio_input</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ivtv_get_audio_input</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vout</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">nof_audio_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">audio_input</span> <span class="o">=</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">ivtv_audio_set_io</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_enumaudout</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audioout</span> <span class="o">*</span><span class="n">vin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="cm">/* set it to defaults from our table */</span>
	<span class="k">return</span> <span class="n">ivtv_get_audio_output</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_audout</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audioout</span> <span class="o">*</span><span class="n">vin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ivtv_get_audio_output</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_audout</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audioout</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ivtv_get_audio_output</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">vin</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="cm">/* set it to defaults from our table */</span>
	<span class="k">return</span> <span class="n">ivtv_get_input</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">vin</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vin</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_enum_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_output</span> <span class="o">*</span><span class="n">vout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ivtv_get_output</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">vout</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">vout</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">cropcap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yuv_playback_info</span> <span class="o">*</span><span class="n">yi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">streamtype</span><span class="p">;</span>

	<span class="n">streamtype</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="mi">59</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="mi">54</span> <span class="o">:</span> <span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">streamtype</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_YUV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">track_osd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">yi</span><span class="o">-&gt;</span><span class="n">osd_full_w</span><span class="p">;</span>
			<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">yi</span><span class="o">-&gt;</span><span class="n">osd_full_h</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
			<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span>
					<span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">59</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">54</span> <span class="o">:</span> <span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">59</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>
		<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">54</span> <span class="o">:</span> <span class="mi">11</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">defrect</span> <span class="o">=</span> <span class="n">cropcap</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yuv_playback_info</span> <span class="o">*</span><span class="n">yi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">streamtype</span><span class="p">;</span>

	<span class="n">streamtype</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">streamtype</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_YUV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">yi</span><span class="o">-&gt;</span><span class="n">main_rect</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_FRAMEBUFFER_WINDOW</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
				<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">.</span><span class="n">top</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span> <span class="o">=</span> <span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">crop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yuv_playback_info</span> <span class="o">*</span><span class="n">yi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">streamtype</span><span class="p">;</span>

	<span class="n">streamtype</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crop</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">streamtype</span> <span class="o">==</span> <span class="n">IVTV_DEC_STREAM_TYPE_YUV</span><span class="p">)</span>
			<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">=</span> <span class="n">yi</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">crop</span><span class="o">-&gt;</span><span class="n">c</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="n">formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="s">&quot;HM12 (YUV 4:2:0)&quot;</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_HM12</span><span class="p">,</span>
		  <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_FMT_FLAG_COMPRESSED</span><span class="p">,</span>
		  <span class="s">&quot;MPEG&quot;</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_MPEG</span><span class="p">,</span>
		  <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_enum_fmt_vid_out</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="n">formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		  <span class="s">&quot;HM12 (YUV 4:2:0)&quot;</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_HM12</span><span class="p">,</span>
		  <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">V4L2_FMT_FLAG_COMPRESSED</span><span class="p">,</span>
		  <span class="s">&quot;MPEG&quot;</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_MPEG</span><span class="p">,</span>
		  <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
		<span class="p">}</span>
	<span class="p">};</span>
	<span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">formats</span><span class="p">[</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_input</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ivtv_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">inp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inp</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">inp</span> <span class="o">&gt;=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">nof_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inp</span> <span class="o">==</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Input unchanged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Changing input from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_input</span><span class="p">,</span> <span class="n">inp</span><span class="p">);</span>

	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_input</span> <span class="o">=</span> <span class="n">inp</span><span class="p">;</span>
	<span class="cm">/* Set the audio input to whatever is appropriate for the</span>
<span class="cm">	   input type. */</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">audio_input</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">video_inputs</span><span class="p">[</span><span class="n">inp</span><span class="p">].</span><span class="n">audio_index</span><span class="p">;</span>

	<span class="cm">/* prevent others from messing with the streams until</span>
<span class="cm">	   we&#39;re finished changing inputs. */</span>
	<span class="n">ivtv_mute</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="n">ivtv_video_set_io</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="n">ivtv_audio_set_io</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="n">ivtv_unmute</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_output</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">outp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">outp</span> <span class="o">&gt;=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">nof_outputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">outp</span> <span class="o">==</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Output unchanged</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Changing output from %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_output</span><span class="p">,</span> <span class="n">outp</span><span class="p">);</span>

	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_output</span> <span class="o">=</span> <span class="n">outp</span><span class="p">;</span>
	<span class="n">ivtv_call_hw</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">IVTV_HW_SAA7127</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span>
			<span class="n">SAA7127_INPUT_TYPE_NORMAL</span><span class="p">,</span>
			<span class="n">itv</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">video_outputs</span><span class="p">[</span><span class="n">outp</span><span class="p">].</span><span class="n">video_output</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">vf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vf</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ivtv_call_all</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">g_frequency</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ivtv_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">vf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vf</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ivtv_mute</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;v4l2 ioctl: set frequency %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vf</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">);</span>
	<span class="n">ivtv_call_all</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_frequency</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
	<span class="n">ivtv_unmute</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="o">*</span><span class="n">std</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ivtv_s_std_enc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="o">*</span><span class="n">std</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_60hz</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">=</span> <span class="o">!</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_60hz</span><span class="p">;</span>
	<span class="n">cx2341x_handler_set_50hz</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">count</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="mi">18</span> <span class="o">:</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">start</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="mi">6</span> <span class="o">:</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">start</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="mi">318</span> <span class="o">:</span> <span class="mi">273</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">hw_flags</span> <span class="o">&amp;</span> <span class="n">IVTV_HW_CX25840</span><span class="p">)</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi</span><span class="p">.</span><span class="n">sliced_decoder_line_size</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_60hz</span> <span class="o">?</span> <span class="mi">272</span> <span class="o">:</span> <span class="mi">284</span><span class="p">;</span>

	<span class="cm">/* Tuner */</span>
	<span class="n">ivtv_call_all</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">ivtv_s_std_dec</span><span class="p">(</span><span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yuv_playback_info</span> <span class="o">*</span><span class="n">yi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">;</span>
	<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">;</span>

	<span class="cm">/* set display standard */</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">std_out</span> <span class="o">=</span> <span class="o">*</span><span class="n">std</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_60hz</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">=</span> <span class="o">!</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_60hz</span><span class="p">;</span>
	<span class="n">ivtv_call_all</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_std_output</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">std_out</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The next firmware call is time sensitive. Time it to</span>
<span class="cm">	 * avoid risk of a hard lock, by trying to ensure the call</span>
<span class="cm">	 * happens within the first 100 lines of the top field.</span>
<span class="cm">	 * Make 4 attempts to sync to the decoder before giving up.</span>
<span class="cm">	 */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">serialize_lock</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vsync_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
				<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">read_reg</span><span class="p">(</span><span class="n">IVTV_REG_DEC_LINE_FIELD</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">25</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vsync_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">serialize_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">f</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">IVTV_WARN</span><span class="p">(</span><span class="s">&quot;Mode change failed to sync to decoder</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_DEC_SET_STANDARD</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span><span class="p">);</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>
	<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_FRAMEBUFFER_WINDOW</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span>
		<span class="mi">720</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">yi</span><span class="o">-&gt;</span><span class="n">main_rect</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">main_rect</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">yi</span><span class="o">-&gt;</span><span class="n">osd_full_w</span> <span class="o">=</span> <span class="mi">720</span><span class="p">;</span>
		<span class="n">yi</span><span class="o">-&gt;</span><span class="n">osd_full_h</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_out_50hz</span> <span class="o">?</span> <span class="mi">576</span> <span class="o">:</span> <span class="mi">480</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">ivtv_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_ALL</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">std</span> <span class="o">==</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_RADIO_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">decoding</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Switching standard would mess with already running</span>
<span class="cm">		   streams, prevent that by returning EBUSY. */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;Switching standard to %llx.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>

	<span class="n">ivtv_s_std_enc</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">)</span>
		<span class="n">ivtv_s_std_dec</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ivtv_call_all</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_tuner</span><span class="p">,</span> <span class="n">vt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ivtv_call_all</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">g_tuner</span><span class="p">,</span> <span class="n">vt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">)</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ivtv Radio Tuner&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">strlcpy</span><span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ivtv TV Tuner&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_sliced_vbi_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_sliced_vbi_cap</span> <span class="o">*</span><span class="n">cap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">set</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span> <span class="o">?</span> <span class="n">V4L2_SLICED_VBI_625</span> <span class="o">:</span> <span class="n">V4L2_SLICED_VBI_525</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_SLICED_VBI_CAPTURE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">valid_service_line</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_50hz</span><span class="p">))</span>
					<span class="n">cap</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">set</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">cap</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">V4L2_BUF_TYPE_SLICED_VBI_OUTPUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_SLICED_VBI_OUTPUT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">is_60hz</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">;</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_CAPTION_525</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">23</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_WSS_625</span><span class="p">;</span>
			<span class="n">cap</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">V4L2_SLICED_VPS</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">f</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">f</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">f</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="mi">24</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span>
			<span class="n">set</span> <span class="o">|=</span> <span class="n">cap</span><span class="o">-&gt;</span><span class="n">service_lines</span><span class="p">[</span><span class="n">f</span><span class="p">][</span><span class="n">l</span><span class="p">];</span>
	<span class="n">cap</span><span class="o">-&gt;</span><span class="n">service_set</span> <span class="o">=</span> <span class="n">set</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_enc_index</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_enc_idx</span> <span class="o">*</span><span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_enc_idx_entry</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">idx</span><span class="o">-&gt;</span><span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">entries</span> <span class="o">=</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">pgm_info_write_idx</span> <span class="o">+</span> <span class="n">IVTV_MAX_PGM_INDEX</span> <span class="o">-</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">pgm_info_read_idx</span><span class="p">)</span> <span class="o">%</span>
				<span class="n">IVTV_MAX_PGM_INDEX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">entries</span> <span class="o">&gt;</span> <span class="n">V4L2_ENC_IDX_ENTRIES</span><span class="p">)</span>
		<span class="n">entries</span> <span class="o">=</span> <span class="n">V4L2_ENC_IDX_ENTRIES</span><span class="p">;</span>
	<span class="n">idx</span><span class="o">-&gt;</span><span class="n">entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">entries</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">pgm_info</span><span class="p">[(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">pgm_info_read_idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">%</span> <span class="n">IVTV_MAX_PGM_INDEX</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_ENC_IDX_FRAME_MASK</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">V4L2_ENC_IDX_FRAME_B</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">idx</span><span class="o">-&gt;</span><span class="n">entries</span><span class="o">++</span><span class="p">;</span>
			<span class="n">e</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">pgm_info_read_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">pgm_info_read_idx</span> <span class="o">+</span> <span class="n">idx</span><span class="o">-&gt;</span><span class="n">entries</span><span class="p">)</span> <span class="o">%</span> <span class="n">IVTV_MAX_PGM_INDEX</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_encoder_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_encoder_cmd</span> <span class="o">*</span><span class="n">enc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>


	<span class="k">switch</span> <span class="p">(</span><span class="n">enc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_ENC_CMD_START</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;V4L2_ENC_CMD_START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_start_capture</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">V4L2_ENC_CMD_STOP</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;V4L2_ENC_CMD_STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">V4L2_ENC_CMD_STOP_AT_GOP_END</span><span class="p">;</span>
		<span class="n">ivtv_stop_capture</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_ENC_CMD_STOP_AT_GOP_END</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_ENC_CMD_PAUSE</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;V4L2_ENC_CMD_PAUSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_ENC_PAUSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ivtv_mute</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_ENC_PAUSE_ENCODER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_ENC_CMD_RESUME</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;V4L2_ENC_CMD_RESUME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">capturing</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_ENC_PAUSED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_ENC_PAUSE_ENCODER</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ivtv_unmute</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;Unknown cmd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_try_encoder_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_encoder_cmd</span> <span class="o">*</span><span class="n">enc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">enc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_ENC_CMD_START</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;V4L2_ENC_CMD_START</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_ENC_CMD_STOP</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;V4L2_ENC_CMD_STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">V4L2_ENC_CMD_STOP_AT_GOP_END</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_ENC_CMD_PAUSE</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;V4L2_ENC_CMD_PAUSE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_ENC_CMD_RESUME</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;V4L2_ENC_CMD_RESUME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">enc</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;Unknown cmd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">enc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_g_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">yuv_playback_info</span> <span class="o">*</span><span class="n">yi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">pixfmt</span><span class="p">;</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="n">pixel_format</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">V4L2_PIX_FMT_PAL8</span><span class="p">,</span> <span class="cm">/* Uses a 256-entry RGB colormap */</span>
		<span class="n">V4L2_PIX_FMT_RGB565</span><span class="p">,</span>
		<span class="n">V4L2_PIX_FMT_RGB555</span><span class="p">,</span>
		<span class="n">V4L2_PIX_FMT_RGB444</span><span class="p">,</span>
		<span class="n">V4L2_PIX_FMT_RGB32</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="n">V4L2_PIX_FMT_PAL8</span><span class="p">,</span> <span class="cm">/* Uses a 256-entry YUV colormap */</span>
		<span class="n">V4L2_PIX_FMT_YUV565</span><span class="p">,</span>
		<span class="n">V4L2_PIX_FMT_YUV555</span><span class="p">,</span>
		<span class="n">V4L2_PIX_FMT_YUV444</span><span class="p">,</span>
		<span class="n">V4L2_PIX_FMT_YUV32</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
		<span class="mi">0</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT_OVERLAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_video_pbase</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">=</span> <span class="n">V4L2_FBUF_CAP_EXTERNOVERLAY</span> <span class="o">|</span> <span class="n">V4L2_FBUF_CAP_CHROMAKEY</span> <span class="o">|</span>
		<span class="n">V4L2_FBUF_CAP_GLOBAL_ALPHA</span><span class="p">;</span>

	<span class="n">ivtv_vapi_result</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">CX2341X_OSD_GET_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="mh">0x2a00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="n">pixfmt</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>

	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">pixel_format</span><span class="p">[</span><span class="n">pixfmt</span><span class="p">];</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_rect</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_rect</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_INTERLACED</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_PAL8</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_RGB32</span> <span class="o">||</span>
	    <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUV32</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">fb</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_video_pbase</span><span class="p">;</span>
	<span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_chroma_key_state</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_CHROMAKEY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_global_alpha_state</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_GLOBAL_ALPHA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">yi</span><span class="o">-&gt;</span><span class="n">track_osd</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_OVERLAY</span><span class="p">;</span>

	<span class="n">pixfmt</span> <span class="o">&amp;=</span> <span class="mi">7</span><span class="p">;</span>

	<span class="cm">/* no local alpha for RGB565 or unknown formats */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">pixfmt</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* 16-bit formats have inverted local alpha */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">pixfmt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_CAP_LOCAL_INV_ALPHA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">fb</span><span class="o">-&gt;</span><span class="n">capability</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_CAP_LOCAL_ALPHA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_local_alpha_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 16-bit formats have inverted local alpha */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixfmt</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">pixfmt</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_LOCAL_INV_ALPHA</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_FBUF_FLAG_LOCAL_ALPHA</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_s_fbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_framebuffer</span> <span class="o">*</span><span class="n">fb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yuv_playback_info</span> <span class="o">*</span><span class="n">yi</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT_OVERLAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_video_pbase</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_global_alpha_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_GLOBAL_ALPHA</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_local_alpha_state</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">V4L2_FBUF_FLAG_LOCAL_ALPHA</span><span class="o">|</span><span class="n">V4L2_FBUF_FLAG_LOCAL_INV_ALPHA</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">itv</span><span class="o">-&gt;</span><span class="n">osd_chroma_key_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_CHROMAKEY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ivtv_set_osd_alpha</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
	<span class="n">yi</span><span class="o">-&gt;</span><span class="n">track_osd</span> <span class="o">=</span> <span class="p">(</span><span class="n">fb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_FBUF_FLAG_OVERLAY</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ivtv_g_fbuf</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fb</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_overlay</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT_OVERLAY</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ivtv_vapi</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">CX2341X_OSD_SET_STATE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">on</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_subscribe_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_event_subscription</span> <span class="o">*</span><span class="n">sub</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sub</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_EVENT_VSYNC</span>:
	<span class="k">case</span> <span class="n">V4L2_EVENT_EOS</span>:
		<span class="k">return</span> <span class="n">v4l2_event_subscribe</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">V4L2_EVENT_CTRL</span>:
		<span class="k">return</span> <span class="n">v4l2_event_subscribe</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">sub</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v4l2_ctrl_sub_ev_ops</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_log_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="n">CX2341X_MBOX_MAX_DATA</span><span class="p">];</span>

	<span class="kt">int</span> <span class="n">has_output</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="n">vidin</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="n">audin</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Version: %s Card: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IVTV_VERSION</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">card_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">hw_flags</span> <span class="o">&amp;</span> <span class="n">IVTV_HW_TVEEPROM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">tveeprom</span> <span class="n">tv</span><span class="p">;</span>

		<span class="n">ivtv_read_eeprom</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tv</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ivtv_call_all</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">log_status</span><span class="p">);</span>
	<span class="n">ivtv_get_input</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vidin</span><span class="p">);</span>
	<span class="n">ivtv_get_audio_input</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">audio_input</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audin</span><span class="p">);</span>
	<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Video Input:  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidin</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Audio Input:  %s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">audin</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
		<span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">dualwatch_stereo_mode</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x300</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x200</span> <span class="o">?</span> <span class="s">&quot; (Bilingual)&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_output</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_output</span> <span class="n">vidout</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">v4l2_audioout</span> <span class="n">audout</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">output_mode</span><span class="p">;</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">output_modes</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;None&quot;</span><span class="p">,</span>
			<span class="s">&quot;MPEG Streaming&quot;</span><span class="p">,</span>
			<span class="s">&quot;YUV Streaming&quot;</span><span class="p">,</span>
			<span class="s">&quot;YUV Frames&quot;</span><span class="p">,</span>
			<span class="s">&quot;Passthrough&quot;</span><span class="p">,</span>
		<span class="p">};</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">alpha_mode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;None&quot;</span><span class="p">,</span>
			<span class="s">&quot;Global&quot;</span><span class="p">,</span>
			<span class="s">&quot;Local&quot;</span><span class="p">,</span>
			<span class="s">&quot;Global and Local&quot;</span>
		<span class="p">};</span>
		<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">pixel_format</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="s">&quot;ARGB Indexed&quot;</span><span class="p">,</span>
			<span class="s">&quot;RGB 5:6:5&quot;</span><span class="p">,</span>
			<span class="s">&quot;ARGB 1:5:5:5&quot;</span><span class="p">,</span>
			<span class="s">&quot;ARGB 1:4:4:4&quot;</span><span class="p">,</span>
			<span class="s">&quot;ARGB 8:8:8:8&quot;</span><span class="p">,</span>
			<span class="s">&quot;5&quot;</span><span class="p">,</span>
			<span class="s">&quot;6&quot;</span><span class="p">,</span>
			<span class="s">&quot;7&quot;</span><span class="p">,</span>
			<span class="s">&quot;AYUV Indexed&quot;</span><span class="p">,</span>
			<span class="s">&quot;YUV 5:6:5&quot;</span><span class="p">,</span>
			<span class="s">&quot;AYUV 1:5:5:5&quot;</span><span class="p">,</span>
			<span class="s">&quot;AYUV 1:4:4:4&quot;</span><span class="p">,</span>
			<span class="s">&quot;AYUV 8:8:8:8&quot;</span><span class="p">,</span>
			<span class="s">&quot;13&quot;</span><span class="p">,</span>
			<span class="s">&quot;14&quot;</span><span class="p">,</span>
			<span class="s">&quot;15&quot;</span><span class="p">,</span>
		<span class="p">};</span>

		<span class="n">ivtv_get_output</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">active_output</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vidout</span><span class="p">);</span>
		<span class="n">ivtv_get_audio_output</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">audout</span><span class="p">);</span>
		<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Video Output: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vidout</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">mode</span> <span class="o">&gt;</span> <span class="n">OUT_PASSTHROUGH</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">OUT_NONE</span><span class="p">;</span>
		<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Output Mode:  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">output_modes</span><span class="p">[</span><span class="n">mode</span><span class="p">]);</span>
		<span class="n">ivtv_vapi_result</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">CX2341X_OSD_GET_STATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|=</span> <span class="p">(</span><span class="n">read_reg</span><span class="p">(</span><span class="mh">0x2a00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Overlay:      %s, Alpha: %s, Pixel Format: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">&quot;On&quot;</span> <span class="o">:</span> <span class="s">&quot;Off&quot;</span><span class="p">,</span>
			<span class="n">alpha_mode</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">],</span>
			<span class="n">pixel_format</span><span class="p">[(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Tuner:  %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_RADIO_USER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Radio&quot;</span> <span class="o">:</span> <span class="s">&quot;TV&quot;</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_log_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">cxhdl</span><span class="p">.</span><span class="n">hdl</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Status flags:    0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IVTV_MAX_STREAMS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Stream %s: status 0x%04lx, %d%% of %d KiB (%d buffers) in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">s_flags</span><span class="p">,</span>
				<span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">-</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">q_free</span><span class="p">.</span><span class="n">buffers</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">,</span>
				<span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">buffers</span> <span class="o">*</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buf_size</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1024</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">buffers</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IVTV_INFO</span><span class="p">(</span><span class="s">&quot;Read MPG/VBI: %lld/%lld bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">mpg_data_received</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">vbi_data_inserted</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_decoder_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_decoder_cmd</span> <span class="o">*</span><span class="n">dec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDIOC_DECODER_CMD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ivtv_video_command</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_try_decoder_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_decoder_cmd</span> <span class="o">*</span><span class="n">dec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDIOC_TRY_DECODER_CMD %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dec</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ivtv_video_command</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ivtv_decoder_ioctls</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv_open_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">filp</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nonblocking</span> <span class="o">=</span> <span class="n">filp</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ivtv_stream</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">streams</span><span class="p">[</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">iarg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IVTV_IOC_DMA_FRAME</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ivtv_dma_frame</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>

		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;IVTV_IOC_DMA_FRAME</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_OUTPUT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">output_mode</span> <span class="o">==</span> <span class="n">OUT_UDMA_YUV</span> <span class="o">&amp;&amp;</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">y_source</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_start_decoding</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_set_output_mode</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">OUT_UDMA_YUV</span><span class="p">)</span> <span class="o">!=</span> <span class="n">OUT_UDMA_YUV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ivtv_release_stream</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Mark that this file handle started the UDMA_YUV mode */</span>
		<span class="n">id</span><span class="o">-&gt;</span><span class="n">yuv_frames</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">y_source</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_yuv_prep_frame</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IVTV_IOC_PASSTHROUGH_MODE</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;IVTV_IOC_PASSTHROUGH_MODE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_passthrough_mode</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">VIDEO_GET_PTS</span>: <span class="p">{</span>
		<span class="n">s64</span> <span class="o">*</span><span class="n">pts</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">s64</span> <span class="n">frame</span><span class="p">;</span>

		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_GET_PTS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">IVTV_DEC_STREAM_TYPE_MPG</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">pts</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dma_pts</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_g_pts_frame</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">pts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_GET_FRAME_COUNT</span>: <span class="p">{</span>
		<span class="n">s64</span> <span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">s64</span> <span class="n">pts</span><span class="p">;</span>

		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_GET_FRAME_COUNT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&lt;</span> <span class="n">IVTV_DEC_STREAM_TYPE_MPG</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">frame</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_g_pts_frame</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pts</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_PLAY</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_decoder_cmd</span> <span class="n">dc</span><span class="p">;</span>

		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_PLAY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dc</span><span class="p">));</span>
		<span class="n">dc</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">V4L2_DEC_CMD_START</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_video_command</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_STOP</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_decoder_cmd</span> <span class="n">dc</span><span class="p">;</span>

		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_STOP</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dc</span><span class="p">));</span>
		<span class="n">dc</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">V4L2_DEC_CMD_STOP</span><span class="p">;</span>
		<span class="n">dc</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_DEC_CMD_STOP_TO_BLACK</span> <span class="o">|</span> <span class="n">V4L2_DEC_CMD_STOP_IMMEDIATELY</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_video_command</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_FREEZE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_decoder_cmd</span> <span class="n">dc</span><span class="p">;</span>

		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_FREEZE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dc</span><span class="p">));</span>
		<span class="n">dc</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">V4L2_DEC_CMD_PAUSE</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_video_command</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_CONTINUE</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_decoder_cmd</span> <span class="n">dc</span><span class="p">;</span>

		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_CONTINUE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dc</span><span class="p">));</span>
		<span class="n">dc</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">V4L2_DEC_CMD_RESUME</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_video_command</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_COMMAND</span>:
	<span class="k">case</span> <span class="n">VIDEO_TRY_COMMAND</span>: <span class="p">{</span>
		<span class="cm">/* Note: struct v4l2_decoder_cmd has the same layout as</span>
<span class="cm">		   struct video_command */</span>
		<span class="k">struct</span> <span class="n">v4l2_decoder_cmd</span> <span class="o">*</span><span class="n">dc</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">try</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">VIDEO_TRY_COMMAND</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">try</span><span class="p">)</span>
			<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_TRY_COMMAND %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_COMMAND %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dc</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ivtv_video_command</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">dc</span><span class="p">,</span> <span class="n">try</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_GET_EVENT</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">video_event</span> <span class="o">*</span><span class="n">ev</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_GET_EVENT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">ev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ev</span><span class="p">));</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_VSYNC_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">);</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_DEC_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
				<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIDEO_EVENT_DECODER_STOPPED</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_VSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">VIDEO_EVENT_VSYNC</span><span class="p">;</span>
				<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vsync_field</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_VSYNC_FIELD</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">?</span>
					<span class="n">VIDEO_VSYNC_FIELD_ODD</span> <span class="o">:</span> <span class="n">VIDEO_VSYNC_FIELD_EVEN</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">output_mode</span> <span class="o">==</span> <span class="n">OUT_UDMA_YUV</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">yuv_info</span><span class="p">.</span><span class="n">lace_mode</span> <span class="o">&amp;</span> <span class="n">IVTV_YUV_MODE_MASK</span><span class="p">)</span> <span class="o">==</span>
								<span class="n">IVTV_YUV_MODE_PROGRESSIVE</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">ev</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">vsync_field</span> <span class="o">=</span> <span class="n">VIDEO_VSYNC_FIELD_PROGRESSIVE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">nonblocking</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="cm">/* Wait for event. Note that serialize_lock is locked,</span>
<span class="cm">			   so to allow other processes to access the driver while</span>
<span class="cm">			   we are waiting unlock first and later lock again. */</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">serialize_lock</span><span class="p">);</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">event_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span> <span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_DEC_STOPPED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">IVTV_F_I_EV_VSYNC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">i_flags</span><span class="p">))</span>
				<span class="n">schedule</span><span class="p">();</span>
			<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">event_waitq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">serialize_lock</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* return if a signal was received */</span>
				<span class="n">IVTV_DEBUG_INFO</span><span class="p">(</span><span class="s">&quot;User stopped wait for event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">VIDEO_SELECT_SOURCE</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;VIDEO_SELECT_SOURCE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">v4l2_cap</span> <span class="o">&amp;</span> <span class="n">V4L2_CAP_VIDEO_OUTPUT</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ivtv_passthrough_mode</span><span class="p">(</span><span class="n">itv</span><span class="p">,</span> <span class="n">iarg</span> <span class="o">==</span> <span class="n">VIDEO_SOURCE_DEMUX</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">AUDIO_SET_MUTE</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;AUDIO_SET_MUTE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">itv</span><span class="o">-&gt;</span><span class="n">speed_mute_audio</span> <span class="o">=</span> <span class="n">iarg</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">AUDIO_CHANNEL_SELECT</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;AUDIO_CHANNEL_SELECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iarg</span> <span class="o">&gt;</span> <span class="n">AUDIO_STEREO_SWAPPED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">v4l2_ctrl_s_ctrl</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">ctrl_audio_playback</span><span class="p">,</span> <span class="n">iarg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">AUDIO_BILINGUAL_CHANNEL_SELECT</span>:
		<span class="n">IVTV_DEBUG_IOCTL</span><span class="p">(</span><span class="s">&quot;AUDIO_BILINGUAL_CHANNEL_SELECT</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">iarg</span> <span class="o">&gt;</span> <span class="n">AUDIO_STEREO_SWAPPED</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">v4l2_ctrl_s_ctrl</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">ctrl_audio_multilingual_playback</span><span class="p">,</span> <span class="n">iarg</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">ivtv_default</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="n">bool</span> <span class="n">valid_prio</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ivtv</span> <span class="o">*</span><span class="n">itv</span> <span class="o">=</span> <span class="n">fh2id</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">itv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">valid_prio</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IVTV_IOC_PASSTHROUGH_MODE</span>:
		<span class="k">case</span> <span class="n">VIDEO_PLAY</span>:
		<span class="k">case</span> <span class="n">VIDEO_STOP</span>:
		<span class="k">case</span> <span class="n">VIDEO_FREEZE</span>:
		<span class="k">case</span> <span class="n">VIDEO_CONTINUE</span>:
		<span class="k">case</span> <span class="n">VIDEO_COMMAND</span>:
		<span class="k">case</span> <span class="n">VIDEO_SELECT_SOURCE</span>:
		<span class="k">case</span> <span class="n">AUDIO_SET_MUTE</span>:
		<span class="k">case</span> <span class="n">AUDIO_CHANNEL_SELECT</span>:
		<span class="k">case</span> <span class="n">AUDIO_BILINGUAL_CHANNEL_SELECT</span>:
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">VIDIOC_INT_RESET</span>: <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">itv</span><span class="o">-&gt;</span><span class="n">options</span><span class="p">.</span><span class="n">newi2c</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">))</span>
			<span class="n">ivtv_reset_ir_gpio</span><span class="p">(</span><span class="n">itv</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span>
			<span class="n">v4l2_subdev_call</span><span class="p">(</span><span class="n">itv</span><span class="o">-&gt;</span><span class="n">sd_video</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">case</span> <span class="n">IVTV_IOC_DMA_FRAME</span>:
	<span class="k">case</span> <span class="n">IVTV_IOC_PASSTHROUGH_MODE</span>:
	<span class="k">case</span> <span class="n">VIDEO_GET_PTS</span>:
	<span class="k">case</span> <span class="n">VIDEO_GET_FRAME_COUNT</span>:
	<span class="k">case</span> <span class="n">VIDEO_GET_EVENT</span>:
	<span class="k">case</span> <span class="n">VIDEO_PLAY</span>:
	<span class="k">case</span> <span class="n">VIDEO_STOP</span>:
	<span class="k">case</span> <span class="n">VIDEO_FREEZE</span>:
	<span class="k">case</span> <span class="n">VIDEO_CONTINUE</span>:
	<span class="k">case</span> <span class="n">VIDEO_COMMAND</span>:
	<span class="k">case</span> <span class="n">VIDEO_TRY_COMMAND</span>:
	<span class="k">case</span> <span class="n">VIDEO_SELECT_SOURCE</span>:
	<span class="k">case</span> <span class="n">AUDIO_SET_MUTE</span>:
	<span class="k">case</span> <span class="n">AUDIO_CHANNEL_SELECT</span>:
	<span class="k">case</span> <span class="n">AUDIO_BILINGUAL_CHANNEL_SELECT</span>:
		<span class="k">return</span> <span class="n">ivtv_decoder_ioctls</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">long</span> <span class="nf">ivtv_v4l2_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vfd</span> <span class="o">=</span> <span class="n">video_devdata</span><span class="p">(</span><span class="n">filp</span><span class="p">);</span>
	<span class="kt">long</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ivtv_debug</span> <span class="o">&amp;</span> <span class="n">IVTV_DBGFLG_IOCTL</span><span class="p">)</span>
		<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">V4L2_DEBUG_IOCTL</span> <span class="o">|</span> <span class="n">V4L2_DEBUG_IOCTL_ARG</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">(</span><span class="n">filp</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">arg</span><span class="p">);</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">ivtv_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>    		    <span class="o">=</span> <span class="n">ivtv_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audio</span>     		    <span class="o">=</span> <span class="n">ivtv_s_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audio</span>     		    <span class="o">=</span> <span class="n">ivtv_g_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enumaudio</span>   		    <span class="o">=</span> <span class="n">ivtv_enumaudio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audout</span>     		    <span class="o">=</span> <span class="n">ivtv_s_audout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audout</span>     		    <span class="o">=</span> <span class="n">ivtv_g_audout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>   		    <span class="o">=</span> <span class="n">ivtv_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_output</span>   		    <span class="o">=</span> <span class="n">ivtv_enum_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enumaudout</span>   		    <span class="o">=</span> <span class="n">ivtv_enumaudout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_cropcap</span>       		    <span class="o">=</span> <span class="n">ivtv_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_crop</span>       		    <span class="o">=</span> <span class="n">ivtv_s_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_crop</span>       		    <span class="o">=</span> <span class="n">ivtv_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>      		    <span class="o">=</span> <span class="n">ivtv_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>      		    <span class="o">=</span> <span class="n">ivtv_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_output</span>     		    <span class="o">=</span> <span class="n">ivtv_g_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_output</span>     		    <span class="o">=</span> <span class="n">ivtv_s_output</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span> 		    <span class="o">=</span> <span class="n">ivtv_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>  		    <span class="o">=</span> <span class="n">ivtv_s_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>      		    <span class="o">=</span> <span class="n">ivtv_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>      		    <span class="o">=</span> <span class="n">ivtv_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_enc_index</span> 		    <span class="o">=</span> <span class="n">ivtv_g_enc_index</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fbuf</span>			    <span class="o">=</span> <span class="n">ivtv_g_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fbuf</span>			    <span class="o">=</span> <span class="n">ivtv_s_fbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_std</span> 			    <span class="o">=</span> <span class="n">ivtv_g_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span> 			    <span class="o">=</span> <span class="n">ivtv_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_overlay</span>			    <span class="o">=</span> <span class="n">ivtv_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_log_status</span>		    <span class="o">=</span> <span class="n">ivtv_log_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span> 	    <span class="o">=</span> <span class="n">ivtv_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_encoder_cmd</span>  		    <span class="o">=</span> <span class="n">ivtv_encoder_cmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_encoder_cmd</span> 	    <span class="o">=</span> <span class="n">ivtv_try_encoder_cmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_decoder_cmd</span>		    <span class="o">=</span> <span class="n">ivtv_decoder_cmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_decoder_cmd</span>		    <span class="o">=</span> <span class="n">ivtv_try_decoder_cmd</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_out</span> 	    <span class="o">=</span> <span class="n">ivtv_enum_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span> 		    <span class="o">=</span> <span class="n">ivtv_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vbi_cap</span>		    <span class="o">=</span> <span class="n">ivtv_g_fmt_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_sliced_vbi_cap</span>        <span class="o">=</span> <span class="n">ivtv_g_fmt_sliced_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_out</span>               <span class="o">=</span> <span class="n">ivtv_g_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_out_overlay</span>       <span class="o">=</span> <span class="n">ivtv_g_fmt_vid_out_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_sliced_vbi_out</span>        <span class="o">=</span> <span class="n">ivtv_g_fmt_sliced_vbi_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>  		    <span class="o">=</span> <span class="n">ivtv_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vbi_cap</span> 		    <span class="o">=</span> <span class="n">ivtv_s_fmt_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_sliced_vbi_cap</span>        <span class="o">=</span> <span class="n">ivtv_s_fmt_sliced_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_out</span>               <span class="o">=</span> <span class="n">ivtv_s_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_out_overlay</span>       <span class="o">=</span> <span class="n">ivtv_s_fmt_vid_out_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_sliced_vbi_out</span>        <span class="o">=</span> <span class="n">ivtv_s_fmt_sliced_vbi_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>  	    <span class="o">=</span> <span class="n">ivtv_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vbi_cap</span>		    <span class="o">=</span> <span class="n">ivtv_try_fmt_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_sliced_vbi_cap</span>      <span class="o">=</span> <span class="n">ivtv_try_fmt_sliced_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_out</span> 	    <span class="o">=</span> <span class="n">ivtv_try_fmt_vid_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_out_overlay</span>     <span class="o">=</span> <span class="n">ivtv_try_fmt_vid_out_overlay</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_sliced_vbi_out</span> 	    <span class="o">=</span> <span class="n">ivtv_try_fmt_sliced_vbi_out</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_sliced_vbi_cap</span> 	    <span class="o">=</span> <span class="n">ivtv_g_sliced_vbi_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_chip_ident</span> 		    <span class="o">=</span> <span class="n">ivtv_g_chip_ident</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">vidioc_g_register</span> 		    <span class="o">=</span> <span class="n">ivtv_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_register</span> 		    <span class="o">=</span> <span class="n">ivtv_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="p">.</span><span class="n">vidioc_default</span> 		    <span class="o">=</span> <span class="n">ivtv_default</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_subscribe_event</span> 	    <span class="o">=</span> <span class="n">ivtv_subscribe_event</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_unsubscribe_event</span> 	    <span class="o">=</span> <span class="n">v4l2_event_unsubscribe</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">void</span> <span class="nf">ivtv_set_funcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">ioctl_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ivtv_ioctl_ops</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
