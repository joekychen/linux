<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › usbvision › usbvision-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>usbvision-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * usbvision-core.c - driver for NT100x USB video capture devices</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1999-2005 Joerg Heckenbach &lt;joerg@heckenbach-aw.de&gt;</span>
<span class="cm"> *                         Dwaine Garden &lt;dwainegarden@rogers.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This module is part of usbvision driver project.</span>
<span class="cm"> * Updates to driver completed by Dwaine P. Garden</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>

<span class="cp">#include &lt;media/saa7115.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>

<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &quot;usbvision.h&quot;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">core_debug</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">core_debug</span><span class="p">,</span> <span class="s">&quot;enable debug messages [core]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">adjust_compression</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Set the compression to be adaptive */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">adjust_compression</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adjust_compression</span><span class="p">,</span> <span class="s">&quot; Set the ADPCM compression for the device.  Default: 1 (On)&quot;</span><span class="p">);</span>

<span class="cm">/* To help people with Black and White output with using s-video input.</span>
<span class="cm"> * Some cables and input device are wired differently. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">switch_svideo_input</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">switch_svideo_input</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">switch_svideo_input</span><span class="p">,</span> <span class="s">&quot; Set the S-Video input.  Some cables and input device are wired differently. Default: 0 (Off)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adjust_x_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">adjust_x_offset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adjust_x_offset</span><span class="p">,</span> <span class="s">&quot;adjust X offset display [core]&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">adjust_y_offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">adjust_y_offset</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">adjust_y_offset</span><span class="p">,</span> <span class="s">&quot;adjust Y offset display [core]&quot;</span><span class="p">);</span>


<span class="cp">#define	ENABLE_HEXDUMP	0	</span><span class="cm">/* Enable if you need it */</span><span class="cp"></span>


<span class="cp">#ifdef USBVISION_DEBUG</span>
	<span class="cp">#define PDEBUG(level, fmt, args...) { \</span>
<span class="cp">		if (core_debug &amp; (level)) \</span>
<span class="cp">			printk(KERN_INFO KBUILD_MODNAME &quot;:[%s:%d] &quot; fmt, \</span>
<span class="cp">				__func__, __LINE__ , ## args); \</span>
<span class="cp">	}</span>
<span class="cp">#else</span>
	<span class="cp">#define PDEBUG(level, fmt, args...) do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#define DBG_HEADER	(1 &lt;&lt; 0)</span>
<span class="cp">#define DBG_IRQ		(1 &lt;&lt; 1)</span>
<span class="cp">#define DBG_ISOC	(1 &lt;&lt; 2)</span>
<span class="cp">#define DBG_PARSE	(1 &lt;&lt; 3)</span>
<span class="cp">#define DBG_SCRATCH	(1 &lt;&lt; 4)</span>
<span class="cp">#define DBG_FUNC	(1 &lt;&lt; 5)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">max_imgwidth</span> <span class="o">=</span> <span class="n">MAX_FRAME_WIDTH</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">max_imgheight</span> <span class="o">=</span> <span class="n">MAX_FRAME_HEIGHT</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">min_imgwidth</span> <span class="o">=</span> <span class="n">MIN_FRAME_WIDTH</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">min_imgheight</span> <span class="o">=</span> <span class="n">MIN_FRAME_HEIGHT</span><span class="p">;</span>

<span class="cm">/* The value of &#39;scratch_buf_size&#39; affects quality of the picture</span>
<span class="cm"> * in many ways. Shorter buffers may cause loss of data when client</span>
<span class="cm"> * is too slow. Larger buffers are memory-consuming and take longer</span>
<span class="cm"> * to work with. This setting can be adjusted, but the default value</span>
<span class="cm"> * should be OK for most desktop users.</span>
<span class="cm"> */</span>
<span class="cp">#define DEFAULT_SCRATCH_BUF_SIZE	(0x20000)		</span><span class="cm">/* 128kB memory scratch buffer */</span><span class="cp"></span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">scratch_buf_size</span> <span class="o">=</span> <span class="n">DEFAULT_SCRATCH_BUF_SIZE</span><span class="p">;</span>

<span class="cm">/* Function prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">usbvision_request_intra</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">usbvision_unrequest_intra</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">usbvision_adjust_compression</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">usbvision_measure_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">);</span>

<span class="cm">/*******************************/</span>
<span class="cm">/* Memory management functions */</span>
<span class="cm">/*******************************/</span>

<span class="cm">/*</span>
<span class="cm"> * Here we want the physical address of the memory.</span>
<span class="cm"> * This is used when initializing the contents of the area.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">usbvision_rvmalloc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="n">mem</span> <span class="o">=</span> <span class="n">vmalloc_32</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span> <span class="cm">/* Clear the ram out, no junk to the user */</span>
	<span class="n">adr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">SetPageReserved</span><span class="p">(</span><span class="n">vmalloc_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">adr</span><span class="p">));</span>
		<span class="n">adr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mem</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_rvfree</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">adr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mem</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>

	<span class="n">adr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mem</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="kt">long</span><span class="p">)</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ClearPageReserved</span><span class="p">(</span><span class="n">vmalloc_to_page</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">adr</span><span class="p">));</span>
		<span class="n">adr</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vfree</span><span class="p">(</span><span class="n">mem</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#if ENABLE_HEXDUMP</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_hexdump</span><span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">80</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">len</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">16</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
			<span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">k</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="s">&quot;%02x &quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CONT</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/********************************</span>
<span class="cm"> * scratch ring buffer handling</span>
<span class="cm"> ********************************/</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scratch_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>    <span class="cm">/* This returns the amount of data actually in the buffer */</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span> <span class="o">-</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">scratch_buf_size</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;scratch_len() = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This returns the free space left in the buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scratch_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">free</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">-</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free</span> <span class="o">+=</span> <span class="n">scratch_buf_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>							<span class="cm">/* at least one byte in the buffer must */</span>
										<span class="cm">/* left blank, otherwise there is no chance to differ between full and empty */</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;return %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">free</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">free</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This puts data into the buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scratch_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len_part</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">scratch_buf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">+</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len_part</span> <span class="o">=</span> <span class="n">scratch_buf_size</span> <span class="o">-</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">+</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len_part</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">len_part</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>			<span class="cm">/* just set write_ptr to zero */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">,</span> <span class="n">data</span> <span class="o">+</span> <span class="n">len_part</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">len_part</span><span class="p">);</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">len_part</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;len=%d, new write_ptr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This marks the write_ptr as position of new frame header */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scratch_mark_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;header at write_ptr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_write_ptr</span><span class="p">);</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_write_ptr</span><span class="p">]</span> <span class="o">=</span>
				<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_write_ptr</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_write_ptr</span> <span class="o">%=</span> <span class="n">USBVISION_NUM_HEADERMARKER</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This gets data from the buffer at the given &quot;ptr&quot; position */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scratch_get_extra</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len_part</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">scratch_buf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">+</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len_part</span> <span class="o">=</span> <span class="n">scratch_buf_size</span> <span class="o">-</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">+</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="n">len_part</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">len_part</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>							<span class="cm">/* just set the y_ptr to zero */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">len_part</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">len_part</span><span class="p">);</span>
			<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">len_part</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;len=%d, new ptr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This sets the scratch extra read pointer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scratch_set_extra_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">%</span> <span class="n">scratch_buf_size</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;ptr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* This increments the scratch extra read pointer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scratch_inc_extra_ptr</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span> <span class="o">+</span> <span class="n">len</span><span class="p">)</span> <span class="o">%</span> <span class="n">scratch_buf_size</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;ptr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">ptr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* This gets data from the buffer */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scratch_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len_part</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">scratch_buf_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">+</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">len_part</span> <span class="o">=</span> <span class="n">scratch_buf_size</span> <span class="o">-</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">+</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span><span class="p">,</span> <span class="n">len_part</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="n">len_part</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>				<span class="cm">/* just set the read_ptr to zero */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">len_part</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="n">len_part</span><span class="p">);</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">len_part</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;len=%d, new read_ptr=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This sets read pointer to next header and returns it */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scratch_get_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">usbvision_frame_header</span> <span class="o">*</span><span class="n">header</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;from read_ptr=%d&quot;</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_read_ptr</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_write_ptr</span> <span class="o">-</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_read_ptr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">=</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_read_ptr</span><span class="p">];</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_read_ptr</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_read_ptr</span> <span class="o">%=</span> <span class="n">USBVISION_NUM_HEADERMARKER</span><span class="p">;</span>
		<span class="n">scratch_get</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">header</span><span class="p">,</span> <span class="n">USBVISION_HEADER_LENGTH</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">magic_1</span> <span class="o">==</span> <span class="n">USBVISION_MAGIC_1</span><span class="p">)</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">magic_2</span> <span class="o">==</span> <span class="n">USBVISION_MAGIC_2</span><span class="p">)</span>
			 <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">header_length</span> <span class="o">==</span> <span class="n">USBVISION_HEADER_LENGTH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err_code</span> <span class="o">=</span> <span class="n">USBVISION_HEADER_LENGTH</span><span class="p">;</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_width</span>  <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_width_lo</span>  <span class="o">+</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_width_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_height</span> <span class="o">=</span> <span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_height_lo</span> <span class="o">+</span> <span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">frame_height_hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* This removes len bytes of old data from the buffer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scratch_rm_old</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">%=</span> <span class="n">scratch_buf_size</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;read_ptr is now %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* This resets the buffer - kills all data in it too */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">scratch_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_SCRATCH</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_read_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_read_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_headermarker_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isocstate</span> <span class="o">=</span> <span class="n">isoc_state_no_frame</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">usbvision_scratch_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">=</span> <span class="n">vmalloc_32</span><span class="p">(</span><span class="n">scratch_buf_size</span><span class="p">);</span>
	<span class="n">scratch_reset</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: unable to allocate %d bytes for scratch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">scratch_buf_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbvision_scratch_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_decompress_alloc()</span>
<span class="cm"> *</span>
<span class="cm"> * allocates intermediate buffer for decompression</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usbvision_decompress_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">IFB_size</span> <span class="o">=</span> <span class="n">MAX_FRAME_WIDTH</span> <span class="o">*</span> <span class="n">MAX_FRAME_HEIGHT</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">intra_frame_buffer</span> <span class="o">=</span> <span class="n">vmalloc_32</span><span class="p">(</span><span class="n">IFB_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">intra_frame_buffer</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: unable to allocate %d for compr. frame buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">IFB_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_decompress_free()</span>
<span class="cm"> *</span>
<span class="cm"> * frees intermediate buffer for decompression</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usbvision_decompress_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">vfree</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">intra_frame_buffer</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">intra_frame_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/************************************************************</span>
<span class="cm"> * Here comes the data parsing stuff that is run as interrupt</span>
<span class="cm"> ************************************************************/</span>
<span class="cm">/*</span>
<span class="cm"> * usbvision_find_header()</span>
<span class="cm"> *</span>
<span class="cm"> * Locate one of supported header markers in the scratch buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">parse_state</span> <span class="nf">usbvision_find_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found_header</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">scratch_get_header</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">)</span> <span class="o">==</span> <span class="n">USBVISION_HEADER_LENGTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* found header in scratch */</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_HEADER</span><span class="p">,</span> <span class="s">&quot;found header: 0x%02x%02x %d %d %d %d %#x 0x%02x %u %u&quot;</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">magic_2</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">magic_1</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">header_length</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_num</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_phase</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_latency</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">data_format</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">format_param</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_width</span><span class="p">,</span>
				<span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_height</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">request_intra</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">format_param</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found_header</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_isoc_frame_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* do not check for lost frames this time */</span>
				<span class="n">usbvision_unrequest_intra</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">found_header</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">found_header</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmwidth</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_width</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmheight</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_height</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span><span class="p">;</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmwidth</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">depth</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* no header found */</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_HEADER</span><span class="p">,</span> <span class="s">&quot;skipping scratch data, no header&quot;</span><span class="p">);</span>
		<span class="n">scratch_reset</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">parse_state_end_parse</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* found header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">data_format</span> <span class="o">==</span> <span class="n">ISOC_MODE_COMPRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* check isoc_header.frame_num for lost frames */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_isoc_frame_num</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_isoc_frame_num</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">32</span><span class="p">)</span> <span class="o">!=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_num</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* unexpected frame drop: need to request new intra frame */</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_HEADER</span><span class="p">,</span> <span class="s">&quot;Lost frame before %d on USB&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_num</span><span class="p">);</span>
				<span class="n">usbvision_request_intra</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">parse_state_next_frame</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_isoc_frame_num</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_num</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">header_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanstate</span> <span class="o">=</span> <span class="n">scan_state_lines</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">parse_state_continue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">parse_state</span> <span class="nf">usbvision_parse_lines_422</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span>
					   <span class="kt">long</span> <span class="o">*</span><span class="n">pcopylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">volatile</span> <span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">yuyv</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">128</span> <span class="p">};</span> <span class="cm">/* YUV components */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rv</span><span class="p">,</span> <span class="n">gv</span><span class="p">,</span> <span class="n">bv</span><span class="p">;</span>	<span class="cm">/* RGB components */</span>
	<span class="kt">int</span> <span class="n">clipmask_index</span><span class="p">,</span> <span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stretch_bytes</span><span class="p">,</span> <span class="n">clipmask_add</span><span class="p">;</span>

	<span class="n">frame</span>  <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span><span class="p">);</span>

	<span class="cm">/* Make sure there&#39;s enough data for the entire line */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_width</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scratch_len</span><span class="p">(</span><span class="n">usbvision</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PARSE</span><span class="p">,</span> <span class="s">&quot;out of data in line %d, need %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">parse_state_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmheight</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parse_state_next_frame</span><span class="p">;</span>

	<span class="n">bytes_per_pixel</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="n">stretch_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="n">clipmask_index</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">*</span> <span class="n">MAX_FRAME_WIDTH</span><span class="p">;</span>
	<span class="n">clipmask_add</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmwidth</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">scratch_get</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">yuyv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">yuyv</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="cm">/* Y */</span>
			<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">yuyv</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span> <span class="cm">/* U */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">YUV_TO_RGB_BY_THE_BOOK</span><span class="p">(</span><span class="n">yuyv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yuyv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yuyv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rv</span><span class="p">,</span> <span class="n">gv</span><span class="p">,</span> <span class="n">bv</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">rv</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x07</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0xF8</span> <span class="o">&amp;</span>  <span class="n">bv</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">gv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">bv</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB32</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">gv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">bv</span><span class="p">;</span>
				<span class="n">f</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB555</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">rv</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0x7C</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">clipmask_index</span> <span class="o">+=</span> <span class="n">clipmask_add</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">+=</span> <span class="n">stretch_bytes</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">yuyv</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* Y */</span>
			<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">yuyv</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span> <span class="cm">/* V */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">YUV_TO_RGB_BY_THE_BOOK</span><span class="p">(</span><span class="n">yuyv</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">yuyv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">yuyv</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">rv</span><span class="p">,</span> <span class="n">gv</span><span class="p">,</span> <span class="n">bv</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">rv</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x07</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0xF8</span> <span class="o">&amp;</span>  <span class="n">bv</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">gv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">bv</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB32</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">gv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">bv</span><span class="p">;</span>
				<span class="n">f</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB555</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">rv</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0x7C</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">clipmask_index</span> <span class="o">+=</span> <span class="n">clipmask_add</span><span class="p">;</span>
		<span class="n">f</span> <span class="o">+=</span> <span class="n">stretch_bytes</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">+=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pcopylen</span> <span class="o">+=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">&gt;=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmheight</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parse_state_next_frame</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">parse_state_continue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* The decompression routine  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_decompress</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">compressed</span><span class="p">,</span>
								<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">decompressed</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">start_pos</span><span class="p">,</span>
								<span class="kt">int</span> <span class="o">*</span><span class="n">block_typestart_pos</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rest_pixel</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">extra_pos</span><span class="p">,</span> <span class="n">block_len</span><span class="p">,</span> <span class="n">block_type_pos</span><span class="p">,</span> <span class="n">block_type_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">block_byte</span><span class="p">,</span> <span class="n">block_code</span><span class="p">,</span> <span class="n">block_type</span><span class="p">,</span> <span class="n">block_type_byte</span><span class="p">,</span> <span class="n">integrator</span><span class="p">;</span>

	<span class="n">integrator</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">start_pos</span><span class="p">;</span>
	<span class="n">block_type_pos</span> <span class="o">=</span> <span class="o">*</span><span class="n">block_typestart_pos</span><span class="p">;</span>
	<span class="n">extra_pos</span> <span class="o">=</span> <span class="n">pos</span><span class="p">;</span>
	<span class="n">block_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">block_byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">block_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">block_type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">block_type_byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">block_type_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rest_pixel</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">block_type_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">block_type_byte</span> <span class="o">=</span> <span class="n">compressed</span><span class="p">[</span><span class="n">block_type_pos</span><span class="p">];</span>
				<span class="n">block_type_pos</span><span class="o">++</span><span class="p">;</span>
				<span class="n">block_type_len</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">block_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">block_type_byte</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>

			<span class="cm">/* statistic: */</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_block_types</span><span class="p">[</span><span class="n">block_type</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>

			<span class="n">pos</span> <span class="o">=</span> <span class="n">extra_pos</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">block_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rest_pixel</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">idx</span> <span class="o">+=</span> <span class="mi">23</span><span class="p">;</span>
					<span class="n">rest_pixel</span> <span class="o">-=</span> <span class="mi">24</span><span class="p">;</span>
					<span class="n">integrator</span> <span class="o">=</span> <span class="n">decompressed</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">idx</span> <span class="o">+=</span> <span class="n">rest_pixel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">rest_pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">block_code</span> <span class="o">=</span> <span class="n">compressed</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
				<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rest_pixel</span> <span class="o">&gt;=</span> <span class="mi">24</span><span class="p">)</span>
					<span class="n">block_len</span>  <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">block_len</span> <span class="o">=</span> <span class="n">rest_pixel</span><span class="p">;</span>
				<span class="n">rest_pixel</span> <span class="o">-=</span> <span class="n">block_len</span><span class="p">;</span>
				<span class="n">extra_pos</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">block_len</span> <span class="o">/</span> <span class="mi">4</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">block_type_byte</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">block_type_len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">block_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">block_len</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">block_byte</span> <span class="o">=</span> <span class="n">compressed</span><span class="p">[</span><span class="n">pos</span><span class="p">];</span>
				<span class="n">pos</span><span class="o">++</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">block_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="cm">/* inter Block */</span>
				<span class="n">integrator</span> <span class="o">=</span> <span class="n">decompressed</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">block_byte</span> <span class="o">&amp;</span> <span class="mh">0xC0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x03</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>:
				<span class="n">integrator</span> <span class="o">+=</span> <span class="n">compressed</span><span class="p">[</span><span class="n">extra_pos</span><span class="p">];</span>
				<span class="n">extra_pos</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x02</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span>:
				<span class="n">integrator</span> <span class="o">+=</span> <span class="n">block_code</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mh">0x00</span>:
				<span class="n">integrator</span> <span class="o">-=</span> <span class="n">block_code</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">decompressed</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">integrator</span><span class="p">;</span>
			<span class="n">block_byte</span> <span class="o">&lt;&lt;=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">block_len</span> <span class="o">-=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">start_pos</span> <span class="o">=</span> <span class="n">extra_pos</span><span class="p">;</span>
	<span class="o">*</span><span class="n">block_typestart_pos</span> <span class="o">=</span> <span class="n">block_type_pos</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * usbvision_parse_compress()</span>
<span class="cm"> *</span>
<span class="cm"> * Parse compressed frame from the scratch buffer, put</span>
<span class="cm"> * decoded RGB value into the current frame buffer and add the written</span>
<span class="cm"> * number of bytes (RGB) to the *pcopylen.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">parse_state</span> <span class="nf">usbvision_parse_compress</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span>
					   <span class="kt">long</span> <span class="o">*</span><span class="n">pcopylen</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define USBVISION_STRIP_MAGIC		0x5A</span>
<span class="cp">#define USBVISION_STRIP_LEN_MAX		400</span>
<span class="cp">#define USBVISION_STRIP_HEADER_LEN	3</span>

	<span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">u</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">v</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">strip_data</span><span class="p">[</span><span class="n">USBVISION_STRIP_LEN_MAX</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">strip_header</span><span class="p">[</span><span class="n">USBVISION_STRIP_HEADER_LEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">idx_end</span><span class="p">,</span> <span class="n">strip_len</span><span class="p">,</span> <span class="n">strip_ptr</span><span class="p">,</span> <span class="n">startblock_pos</span><span class="p">,</span> <span class="n">block_pos</span><span class="p">,</span> <span class="n">block_type_pos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clipmask_index</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">image_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rv</span><span class="p">,</span> <span class="n">gv</span><span class="p">,</span> <span class="n">bv</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">Y</span><span class="p">,</span> <span class="o">*</span><span class="n">U</span><span class="p">,</span> <span class="o">*</span><span class="n">V</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>
	<span class="n">image_size</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmwidth</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmheight</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUV422P</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YVU420</span><span class="p">))</span> <span class="p">{</span>       <span class="cm">/* this is a planar format */</span>
		<span class="cm">/* ... v4l2_linesize not used here. */</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">f</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* initialise u and v pointers */</span>
		<span class="cm">/* get base of u and b planes add halfoffset */</span>
		<span class="n">u</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span>
			<span class="o">+</span> <span class="n">image_size</span>
			<span class="o">+</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmwidth</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span><span class="p">;</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">u</span> <span class="o">+</span> <span class="p">(</span><span class="n">image_size</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YVU420</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">image_size</span> <span class="o">+</span> <span class="p">((</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">*</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">u</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="p">(</span><span class="n">image_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usbvision_adjust_compression</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scratch_len</span><span class="p">(</span><span class="n">usbvision</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">USBVISION_STRIP_HEADER_LEN</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parse_state_out</span><span class="p">;</span>

	<span class="cm">/* get strip header without changing the scratch_read_ptr */</span>
	<span class="n">scratch_set_extra_ptr</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">strip_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">scratch_get_extra</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">strip_header</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">strip_ptr</span><span class="p">,</span>
				<span class="n">USBVISION_STRIP_HEADER_LEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strip_header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">USBVISION_STRIP_MAGIC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wrong strip magic */</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">strip_magic_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">parse_state_next_frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">!=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strip_header</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="p">{</span>
		<span class="cm">/* line number mismatch error */</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">strip_line_number_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strip_len</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">strip_header</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strip_len</span> <span class="o">&gt;</span> <span class="n">USBVISION_STRIP_LEN_MAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* strip overrun */</span>
		<span class="cm">/* I think this never happens */</span>
		<span class="n">usbvision_request_intra</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scratch_len</span><span class="p">(</span><span class="n">usbvision</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">strip_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* there is not enough data for the strip */</span>
		<span class="k">return</span> <span class="n">parse_state_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">intra_frame_buffer</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">Y</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">intra_frame_buffer</span> <span class="o">+</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmwidth</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span><span class="p">;</span>
		<span class="n">U</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">intra_frame_buffer</span> <span class="o">+</span> <span class="n">image_size</span> <span class="o">+</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmwidth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">V</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">intra_frame_buffer</span> <span class="o">+</span> <span class="n">image_size</span> <span class="o">/</span> <span class="mi">4</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmwidth</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">parse_state_next_frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clipmask_index</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">*</span> <span class="n">MAX_FRAME_WIDTH</span><span class="p">;</span>

	<span class="n">scratch_get</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">strip_data</span><span class="p">,</span> <span class="n">strip_len</span><span class="p">);</span>

	<span class="n">idx_end</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmwidth</span><span class="p">;</span>
	<span class="n">block_type_pos</span> <span class="o">=</span> <span class="n">USBVISION_STRIP_HEADER_LEN</span><span class="p">;</span>
	<span class="n">startblock_pos</span> <span class="o">=</span> <span class="n">block_type_pos</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx_end</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">96</span> <span class="o">+</span> <span class="p">(</span><span class="n">idx_end</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">96</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">block_pos</span> <span class="o">=</span> <span class="n">startblock_pos</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">block_pos</span> <span class="o">=</span> <span class="n">block_pos</span><span class="p">;</span>

	<span class="n">usbvision_decompress</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">strip_data</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_type_pos</span><span class="p">,</span> <span class="n">idx_end</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strip_len</span> <span class="o">&gt;</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">max_strip_len</span><span class="p">)</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">max_strip_len</span> <span class="o">=</span> <span class="n">strip_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">%</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">usbvision_decompress</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">strip_data</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_type_pos</span><span class="p">,</span> <span class="n">idx_end</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">usbvision_decompress</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">strip_data</span><span class="p">,</span> <span class="n">U</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_pos</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block_type_pos</span><span class="p">,</span> <span class="n">idx_end</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">block_pos</span> <span class="o">&gt;</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">comprblock_pos</span><span class="p">)</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">comprblock_pos</span> <span class="o">=</span> <span class="n">block_pos</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">block_pos</span> <span class="o">&gt;</span> <span class="n">strip_len</span><span class="p">)</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">strip_len_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">idx_end</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">?</span> <span class="n">U</span><span class="p">[</span><span class="n">idx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">]</span> <span class="o">:</span> <span class="n">V</span><span class="p">[</span><span class="n">idx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUV422P</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
				<span class="o">*</span><span class="n">u</span><span class="o">++</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">idx</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">];</span>
			<span class="k">else</span>
				<span class="o">*</span><span class="n">v</span><span class="o">++</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">idx</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">];</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YVU420</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">idx</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)))</span> <span class="p">{</span>
				<span class="cm">/* only need do this for 1 in 4 pixels */</span>
				<span class="cm">/* intraframe buffer is YUV420 format */</span>
				<span class="o">*</span><span class="n">u</span><span class="o">++</span> <span class="o">=</span> <span class="n">U</span><span class="p">[</span><span class="n">idx</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">];</span>
				<span class="o">*</span><span class="n">v</span><span class="o">++</span> <span class="o">=</span> <span class="n">V</span><span class="p">[</span><span class="n">idx</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">];</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">YUV_TO_RGB_BY_THE_BOOK</span><span class="p">(</span><span class="n">Y</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">U</span><span class="p">[</span><span class="n">idx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">V</span><span class="p">[</span><span class="n">idx</span> <span class="o">/</span> <span class="mi">2</span><span class="p">],</span> <span class="n">rv</span><span class="p">,</span> <span class="n">gv</span><span class="p">,</span> <span class="n">bv</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_GREY</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">Y</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB555</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">rv</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0x7C</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">bv</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">rv</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x07</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">gv</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
					<span class="p">(</span><span class="mh">0xF8</span> <span class="o">&amp;</span> <span class="n">bv</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">gv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">bv</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB32</span>:
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">gv</span><span class="p">;</span>
				<span class="o">*</span><span class="n">f</span><span class="o">++</span> <span class="o">=</span> <span class="n">bv</span><span class="p">;</span>
				<span class="n">f</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">clipmask_index</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Deal with non-integer no. of bytes for YUV420P */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">!=</span> <span class="n">V4L2_PIX_FMT_YVU420</span><span class="p">)</span>
		<span class="o">*</span><span class="n">pcopylen</span> <span class="o">+=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="o">*</span><span class="n">pcopylen</span> <span class="o">+=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="o">?</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span> <span class="o">:</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">&gt;=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmheight</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parse_state_next_frame</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">parse_state_continue</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * usbvision_parse_lines_420()</span>
<span class="cm"> *</span>
<span class="cm"> * Parse two lines from the scratch buffer, put</span>
<span class="cm"> * decoded RGB value into the current frame buffer and add the written</span>
<span class="cm"> * number of bytes (RGB) to the *pcopylen.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">parse_state</span> <span class="nf">usbvision_parse_lines_420</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span>
					   <span class="kt">long</span> <span class="o">*</span><span class="n">pcopylen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">f_even</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">*</span><span class="n">f_odd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixel_per_line</span><span class="p">,</span> <span class="n">block</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pixel</span><span class="p">,</span> <span class="n">block_split</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">y_ptr</span><span class="p">,</span> <span class="n">u_ptr</span><span class="p">,</span> <span class="n">v_ptr</span><span class="p">,</span> <span class="n">y_odd_offset</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">y_block_size</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">uv_block_size</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">sub_block_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">y_step</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="p">},</span> <span class="n">y_step_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">uv_step</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span> <span class="p">},</span> <span class="n">uv_step_size</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>	<span class="cm">/* YUV components */</span>
	<span class="kt">int</span> <span class="n">y_</span><span class="p">,</span> <span class="n">u_</span><span class="p">,</span> <span class="n">v_</span><span class="p">,</span> <span class="n">vb</span><span class="p">,</span> <span class="n">uvg</span><span class="p">,</span> <span class="n">ur</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">r_</span><span class="p">,</span> <span class="n">g_</span><span class="p">,</span> <span class="n">b_</span><span class="p">;</span>			<span class="cm">/* RGB components */</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">g</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clipmask_even_index</span><span class="p">,</span> <span class="n">clipmask_odd_index</span><span class="p">,</span> <span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">clipmask_add</span><span class="p">,</span> <span class="n">stretch_bytes</span><span class="p">;</span>

	<span class="n">frame</span>  <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>
	<span class="n">f_even</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span> <span class="o">*</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span><span class="p">);</span>
	<span class="n">f_odd</span>  <span class="o">=</span> <span class="n">f_even</span> <span class="o">+</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span><span class="p">;</span>

	<span class="cm">/* Make sure there&#39;s enough data for the entire line */</span>
	<span class="cm">/* In this mode usbvision transfer 3 bytes for every 2 pixels */</span>
	<span class="cm">/* I need two lines to decode the color */</span>
	<span class="n">bytes_per_pixel</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="n">stretch_bytes</span> <span class="o">=</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="n">clipmask_even_index</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">*</span> <span class="n">MAX_FRAME_WIDTH</span><span class="p">;</span>
	<span class="n">clipmask_odd_index</span>  <span class="o">=</span> <span class="n">clipmask_even_index</span> <span class="o">+</span> <span class="n">MAX_FRAME_WIDTH</span><span class="p">;</span>
	<span class="n">clipmask_add</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span><span class="p">;</span>
	<span class="n">pixel_per_line</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">isoc_header</span><span class="p">.</span><span class="n">frame_width</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scratch_len</span><span class="p">(</span><span class="n">usbvision</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">pixel_per_line</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* printk(KERN_DEBUG &quot;out of data, need %d\n&quot;, len); */</span>
		<span class="k">return</span> <span class="n">parse_state_out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmheight</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parse_state_next_frame</span><span class="p">;</span>

	<span class="n">block_split</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel_per_line</span><span class="o">%</span><span class="n">y_block_size</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* are some blocks splitted into different lines? */</span>

	<span class="n">y_odd_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">pixel_per_line</span> <span class="o">/</span> <span class="n">y_block_size</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">y_block_size</span> <span class="o">+</span> <span class="n">uv_block_size</span><span class="p">)</span>
			<span class="o">+</span> <span class="n">block_split</span> <span class="o">*</span> <span class="n">uv_block_size</span><span class="p">;</span>

	<span class="n">scratch_set_extra_ptr</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y_ptr</span><span class="p">,</span> <span class="n">y_odd_offset</span><span class="p">);</span>
	<span class="n">scratch_set_extra_ptr</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u_ptr</span><span class="p">,</span> <span class="n">y_block_size</span><span class="p">);</span>
	<span class="n">scratch_set_extra_ptr</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v_ptr</span><span class="p">,</span> <span class="n">y_odd_offset</span>
			<span class="o">+</span> <span class="p">(</span><span class="mi">4</span> <span class="o">-</span> <span class="n">block_split</span><span class="p">)</span> <span class="o">*</span> <span class="n">sub_block_size</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">block</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">pixel_per_line</span> <span class="o">/</span> <span class="n">sub_block_size</span><span class="p">);</span> <span class="n">block</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">pixel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">pixel</span> <span class="o">&lt;</span> <span class="n">sub_block_size</span><span class="p">;</span> <span class="n">pixel</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scratch_get</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">scratch_get_extra</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">scratch_get_extra</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

			<span class="cm">/* I don&#39;t use the YUV_TO_RGB macro for better performance */</span>
			<span class="n">v_</span> <span class="o">=</span> <span class="n">v</span> <span class="o">-</span> <span class="mi">128</span><span class="p">;</span>
			<span class="n">u_</span> <span class="o">=</span> <span class="n">u</span> <span class="o">-</span> <span class="mi">128</span><span class="p">;</span>
			<span class="n">vb</span> <span class="o">=</span> <span class="mi">132252</span> <span class="o">*</span> <span class="n">v_</span><span class="p">;</span>
			<span class="n">uvg</span> <span class="o">=</span> <span class="o">-</span><span class="mi">53281</span> <span class="o">*</span> <span class="n">u_</span> <span class="o">-</span> <span class="mi">25625</span> <span class="o">*</span> <span class="n">v_</span><span class="p">;</span>
			<span class="n">ur</span> <span class="o">=</span> <span class="mi">104595</span> <span class="o">*</span> <span class="n">u_</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">y_</span> <span class="o">=</span> <span class="mi">76284</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

				<span class="n">b_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">vb</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">g_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">uvg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">r_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">ur</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
					<span class="n">g</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span>
						<span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span>
						<span class="p">(</span><span class="mh">0x07</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xF8</span> <span class="o">&amp;</span>  <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB32</span>:
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">);</span>
					<span class="n">f_even</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB555</span>:
					<span class="n">g</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0x7C</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">clipmask_even_index</span> <span class="o">+=</span> <span class="n">clipmask_add</span><span class="p">;</span>
			<span class="n">f_even</span> <span class="o">+=</span> <span class="n">stretch_bytes</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">y_</span> <span class="o">=</span> <span class="mi">76284</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

				<span class="n">b_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">vb</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">g_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">uvg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">r_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">ur</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
					<span class="n">g</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span>
						<span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span>
						<span class="p">(</span><span class="mh">0x07</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xF8</span> <span class="o">&amp;</span>  <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB32</span>:
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">);</span>
					<span class="n">f_even</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB555</span>:
					<span class="n">g</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
					<span class="o">*</span><span class="n">f_even</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0x7C</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">clipmask_even_index</span> <span class="o">+=</span> <span class="n">clipmask_add</span><span class="p">;</span>
			<span class="n">f_even</span> <span class="o">+=</span> <span class="n">stretch_bytes</span><span class="p">;</span>

			<span class="n">scratch_get_extra</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">y_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
				<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">y_</span> <span class="o">=</span> <span class="mi">76284</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

				<span class="n">b_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">vb</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">g_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">uvg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">r_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">ur</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
					<span class="n">g</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span>
						<span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span>
						<span class="p">(</span><span class="mh">0x07</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xF8</span> <span class="o">&amp;</span>  <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB32</span>:
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">);</span>
					<span class="n">f_odd</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB555</span>:
					<span class="n">g</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0x7C</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">clipmask_odd_index</span> <span class="o">+=</span> <span class="n">clipmask_add</span><span class="p">;</span>
			<span class="n">f_odd</span> <span class="o">+=</span> <span class="n">stretch_bytes</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span> <span class="o">==</span> <span class="n">V4L2_PIX_FMT_YUYV</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">u</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">y_</span> <span class="o">=</span> <span class="mi">76284</span> <span class="o">*</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">16</span><span class="p">);</span>

				<span class="n">b_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">vb</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">g_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">uvg</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
				<span class="n">r_</span> <span class="o">=</span> <span class="p">(</span><span class="n">y_</span> <span class="o">+</span> <span class="n">ur</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>

				<span class="k">switch</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span><span class="p">.</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB565</span>:
					<span class="n">g</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span>
						<span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span>
						<span class="p">(</span><span class="mh">0x07</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xF8</span> <span class="o">&amp;</span>  <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB24</span>:
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">);</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB32</span>:
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">);</span>
					<span class="n">f_odd</span><span class="o">++</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">V4L2_PIX_FMT_RGB555</span>:
					<span class="n">g</span> <span class="o">=</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">g_</span><span class="p">);</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x1F</span> <span class="o">&amp;</span> <span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">r_</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0xE0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">));</span>
					<span class="o">*</span><span class="n">f_odd</span><span class="o">++</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0x03</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">g</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span>
						<span class="p">(</span><span class="mh">0x7C</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">LIMIT_RGB</span><span class="p">(</span><span class="n">b_</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">clipmask_odd_index</span> <span class="o">+=</span> <span class="n">clipmask_add</span><span class="p">;</span>
			<span class="n">f_odd</span> <span class="o">+=</span> <span class="n">stretch_bytes</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scratch_rm_old</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">y_step</span><span class="p">[</span><span class="n">block</span> <span class="o">%</span> <span class="n">y_step_size</span><span class="p">]</span> <span class="o">*</span> <span class="n">sub_block_size</span><span class="p">);</span>
		<span class="n">scratch_inc_extra_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">y_ptr</span><span class="p">,</span> <span class="n">y_step</span><span class="p">[(</span><span class="n">block</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">block_split</span><span class="p">)</span> <span class="o">%</span> <span class="n">y_step_size</span><span class="p">]</span>
				<span class="o">*</span> <span class="n">sub_block_size</span><span class="p">);</span>
		<span class="n">scratch_inc_extra_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">u_ptr</span><span class="p">,</span> <span class="n">uv_step</span><span class="p">[</span><span class="n">block</span> <span class="o">%</span> <span class="n">uv_step_size</span><span class="p">]</span>
				<span class="o">*</span> <span class="n">sub_block_size</span><span class="p">);</span>
		<span class="n">scratch_inc_extra_ptr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v_ptr</span><span class="p">,</span> <span class="n">uv_step</span><span class="p">[(</span><span class="n">block</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">block_split</span><span class="p">)</span> <span class="o">%</span> <span class="n">uv_step_size</span><span class="p">]</span>
				<span class="o">*</span> <span class="n">sub_block_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scratch_rm_old</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">pixel_per_line</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">/</span> <span class="mi">2</span>
			<span class="o">+</span> <span class="n">block_split</span> <span class="o">*</span> <span class="n">sub_block_size</span><span class="p">);</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">+=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span><span class="p">;</span>
	<span class="o">*</span><span class="n">pcopylen</span> <span class="o">+=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_linesize</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">curline</span> <span class="o">&gt;=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">frmheight</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">parse_state_next_frame</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">parse_state_continue</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_parse_data()</span>
<span class="cm"> *</span>
<span class="cm"> * Generic routine to parse the scratch buffer. It employs either</span>
<span class="cm"> * usbvision_find_header() or usbvision_parse_lines() to do most</span>
<span class="cm"> * of work.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_parse_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">parse_state</span> <span class="n">newstate</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">copylen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PARSE</span><span class="p">,</span> <span class="s">&quot;parsing len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scratch_len</span><span class="p">(</span><span class="n">usbvision</span><span class="p">));</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">newstate</span> <span class="o">=</span> <span class="n">parse_state_out</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scratch_len</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanstate</span> <span class="o">==</span> <span class="n">scan_state_scanning</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">newstate</span> <span class="o">=</span> <span class="n">usbvision_find_header</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanstate</span> <span class="o">==</span> <span class="n">scan_state_lines</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_mode</span> <span class="o">==</span> <span class="n">ISOC_MODE_YUV420</span><span class="p">)</span>
					<span class="n">newstate</span> <span class="o">=</span> <span class="n">usbvision_parse_lines_420</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">copylen</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_mode</span> <span class="o">==</span> <span class="n">ISOC_MODE_YUV422</span><span class="p">)</span>
					<span class="n">newstate</span> <span class="o">=</span> <span class="n">usbvision_parse_lines_422</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">copylen</span><span class="p">);</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_mode</span> <span class="o">==</span> <span class="n">ISOC_MODE_COMPRESS</span><span class="p">)</span>
					<span class="n">newstate</span> <span class="o">=</span> <span class="n">usbvision_parse_compress</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">copylen</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">newstate</span> <span class="o">==</span> <span class="n">parse_state_continue</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">newstate</span> <span class="o">==</span> <span class="n">parse_state_next_frame</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">newstate</span> <span class="o">==</span> <span class="n">parse_state_out</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>	<span class="cm">/* parse_state_end_parse */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">newstate</span> <span class="o">==</span> <span class="n">parse_state_next_frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">=</span> <span class="n">frame_state_done</span><span class="p">;</span>
		<span class="n">do_gettimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">));</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame_num</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
		<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame_num</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* This will cause the process to request another frame. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_frame</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PARSE</span><span class="p">,</span> <span class="s">&quot;Wake up !&quot;</span><span class="p">);</span>
			<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_frame</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">=</span> <span class="n">frame_state_grabbing</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update the frame&#39;s uncompressed length. */</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanlength</span> <span class="o">+=</span> <span class="n">copylen</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Make all of the blocks of data contiguous</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_compress_isochronous</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">packet_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">totlen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">packet_len</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">packet_stat</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">;</span>

		<span class="n">packet_data</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">+</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">offset</span><span class="p">;</span>

		<span class="cm">/* Detect and ignore errored packets */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet_stat</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* packet_stat != 0 ????????????? */</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;data error: [%d] len=%d, status=%X&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">packet_len</span><span class="p">,</span> <span class="n">packet_stat</span><span class="p">);</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_err_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Detect and ignore empty packets */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">packet_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;error packet [%d]&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_skip_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">packet_len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* Frame end ????? */</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;null packet [%d]&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isocstate</span> <span class="o">=</span> <span class="n">isoc_state_no_frame</span><span class="p">;</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_skip_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">packet_len</span> <span class="o">&gt;</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;packet[%d] &gt; isoc_packet_size&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_skip_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;packet ok [%d] len=%d&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">packet_len</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isocstate</span> <span class="o">==</span> <span class="n">isoc_state_no_frame</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* new frame begins */</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isocstate</span> <span class="o">=</span> <span class="n">isoc_state_in_frame</span><span class="p">;</span>
			<span class="n">scratch_mark_header</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="n">usbvision_measure_bandwidth</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;packet with header&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * If usbvision continues to feed us with data but there is no</span>
<span class="cm">		 * consumption (if, for example, V4L client fell asleep) we</span>
<span class="cm">		 * may overflow the buffer. We have to move old data over to</span>
<span class="cm">		 * free room for new data. This is bad for old data. If we</span>
<span class="cm">		 * just drop new data then it&#39;s bad for new data... choose</span>
<span class="cm">		 * your favorite evil here.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scratch_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">packet_len</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratch_ovf_count</span><span class="o">++</span><span class="p">;</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;scratch buf overflow! scr_len: %d, n: %d&quot;</span><span class="p">,</span>
			       <span class="n">scratch_len</span><span class="p">(</span><span class="n">usbvision</span><span class="p">),</span> <span class="n">packet_len</span><span class="p">);</span>
			<span class="n">scratch_rm_old</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">packet_len</span> <span class="o">-</span> <span class="n">scratch_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">));</span>
		<span class="p">}</span>

		<span class="cm">/* Now we know that there is enough room in scratch buffer */</span>
		<span class="n">scratch_put</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">packet_data</span><span class="p">,</span> <span class="n">packet_len</span><span class="p">);</span>
		<span class="n">totlen</span> <span class="o">+=</span> <span class="n">packet_len</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_data_count</span> <span class="o">+=</span> <span class="n">packet_len</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#if ENABLE_HEXDUMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">static</span> <span class="kt">int</span> <span class="n">foo</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">foo</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;+%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">scratchlen</span><span class="p">);</span>
			<span class="n">usbvision_hexdump</span><span class="p">(</span><span class="n">data0</span><span class="p">,</span> <span class="p">(</span><span class="n">totlen</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">?</span> <span class="mi">64</span> <span class="o">:</span> <span class="n">totlen</span><span class="p">);</span>
			<span class="o">++</span><span class="n">foo</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">totlen</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_isoc_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">**</span><span class="n">f</span><span class="p">;</span>

	<span class="cm">/* We don&#39;t want to do anything if we are about to be removed! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* any urb with wrong status is ignored without acknowledgement */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">f</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span><span class="p">;</span>

	<span class="cm">/* Manage streaming interruption */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">stream_interrupt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">stream_idle</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">f</span><span class="p">))</span> <span class="p">{</span>
			<span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">=</span> <span class="n">frame_state_ready</span><span class="p">;</span>
			<span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">scanstate</span> <span class="o">=</span> <span class="n">scan_state_scanning</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;stream interrupted&quot;</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_stream</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Copy the data received into our scratch buffer */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">usbvision_compress_isochronous</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">urb</span><span class="p">);</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_urb_count</span><span class="o">++</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">urb_length</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">stream_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If we collected enough data let&#39;s parse! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">scratch_len</span><span class="p">(</span><span class="n">usbvision</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">USBVISION_HEADER_LENGTH</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">inqueue</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">))</span> <span class="p">{</span>
				<span class="p">(</span><span class="o">*</span><span class="n">f</span><span class="p">)</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">inqueue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
						  <span class="k">struct</span> <span class="n">usbvision_frame</span><span class="p">,</span>
						  <span class="n">frame</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">usbvision_parse_data</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* If we don&#39;t have a frame</span>
<span class="cm">			  we&#39;re current working on, complain */</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span>
			       <span class="s">&quot;received data, but no one needs it&quot;</span><span class="p">);</span>
			<span class="n">scratch_reset</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;received data, but no one needs it&quot;</span><span class="p">);</span>
		<span class="n">scratch_reset</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">time_in_irq</span> <span class="o">+=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USBVISION_URB_FRAMES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">actual_length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: usb_submit_urb failed: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*************************************/</span>
<span class="cm">/* Low level usbvision access functions */</span>
<span class="cm">/*************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_read_reg()</span>
<span class="cm"> *</span>
<span class="cm"> * return  &lt; 0 -&gt; Error</span>
<span class="cm"> *        &gt;= 0 -&gt; Data</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">usbvision_read_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_rcvctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
				<span class="n">USBVISION_OP_CODE</span><span class="p">,</span>
				<span class="n">USB_DIR_IN</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">,</span>
				<span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">reg</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: failed: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_write_reg()</span>
<span class="cm"> *</span>
<span class="cm"> * return 1 -&gt; Reg written</span>
<span class="cm"> *        0 -&gt; usbvision is not yet ready</span>
<span class="cm"> *       -1 -&gt; Something went wrong</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">usbvision_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">reg</span><span class="p">,</span>
			    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
				<span class="n">USBVISION_OP_CODE</span><span class="p">,</span>
				<span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span>
				<span class="n">USB_RECIP_ENDPOINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: failed: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_ctrl_urb_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="p">)</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">waitqueue_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_wq</span><span class="p">))</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_wq</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_write_reg_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">int</span> <span class="n">address</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_busy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_setup</span><span class="p">.</span><span class="n">bRequestType</span> <span class="o">=</span> <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_setup</span><span class="p">.</span><span class="n">bRequest</span>     <span class="o">=</span> <span class="n">USBVISION_OP_CODE</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_setup</span><span class="p">.</span><span class="n">wValue</span>       <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_setup</span><span class="p">.</span><span class="n">wIndex</span>       <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">address</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_setup</span><span class="p">.</span><span class="n">wLength</span>      <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">usb_fill_control_urb</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
							<span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
							<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_setup</span><span class="p">,</span>
							<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_buffer</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
							<span class="n">usbvision_ctrl_urb_complete</span><span class="p">,</span>
							<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* error in usb_submit_urb() */</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;submit %d byte: error %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_init_compression</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_isoc_frame_num</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_data_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_skip_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_compr_level</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_urb_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">request_intra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_measure_bandwidth_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* this function measures the used bandwidth since last call</span>
<span class="cm"> * return:    0 : no error</span>
<span class="cm"> * sets used_bandwidth to 1-100 : 1-100% of full bandwidth resp. to isoc_packet_size</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_measure_bandwidth</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_measure_bandwidth_count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* this gives an average bandwidth of 3 frames */</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_measure_bandwidth_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">used_bandwidth</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_data_count</span> <span class="o">/</span>
					<span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_count</span> <span class="o">+</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_skip_count</span><span class="p">)</span> <span class="o">*</span>
					<span class="mi">100</span> <span class="o">/</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_measure_bandwidth_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_data_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_skip_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_adjust_compression</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adjust_compression</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">used_bandwidth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">+=</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">used_bandwidth</span> <span class="o">-</span> <span class="mi">90</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">RESTRICT_TO_RANGE</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">!=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_compr_level</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">distortion</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">bridge_type</span> <span class="o">==</span> <span class="n">BRIDGE_NT1004</span> <span class="o">||</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">bridge_type</span> <span class="o">==</span> <span class="n">BRIDGE_NT1005</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>	<span class="cm">/* PCM Threshold 1 */</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>	<span class="cm">/* PCM Threshold 2 */</span>
				<span class="n">distortion</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">248</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">distortion</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>				<span class="cm">/* Average distortion Threshold (inter) */</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">distortion</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>				<span class="cm">/* Average distortion Threshold (intra) */</span>
				<span class="n">distortion</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="mi">42</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">distortion</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>				<span class="cm">/* Maximum distortion Threshold (inter) */</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">distortion</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>				<span class="cm">/* Maximum distortion Threshold (intra) */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* BRIDGE_NT1003 */</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">16</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>	<span class="cm">/* PCM threshold 1 */</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="mi">4</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">/</span> <span class="mi">100</span><span class="p">);</span>	<span class="cm">/* PCM threshold 2 */</span>
				<span class="n">distortion</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">253</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">distortion</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>				<span class="cm">/* distortion threshold bit0-7 */</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* (unsigned char)((distortion &gt;&gt; 8) &amp; 0x0F);		distortion threshold bit 8-11 */</span>
				<span class="n">distortion</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="mi">43</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="p">)(</span><span class="n">distortion</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>				<span class="cm">/* maximum distortion bit0-7 */</span>
				<span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* (unsigned char)((distortion &gt;&gt; 8) &amp; 0x01);		maximum distortion bit 8 */</span>
			<span class="p">}</span>
			<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_write_reg_irq</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_PCM_THR1</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;new compr params %#02x %#02x %#02x %#02x %#02x %#02x&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
								<span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
				<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_compr_level</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">compr_level</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_request_intra</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">request_intra</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">usbvision_write_reg_irq</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_FORCE_INTRA</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_unrequest_intra</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IRQ</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">request_intra</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision_write_reg_irq</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_FORCE_INTRA</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*******************************</span>
<span class="cm"> * usbvision utility functions</span>
<span class="cm"> *******************************/</span>

<span class="kt">int</span> <span class="nf">usbvision_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_PWR_REG</span><span class="p">,</span> <span class="n">USBVISION_SSPND_EN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;%s: err_code %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ERROR&quot;</span> <span class="o">:</span> <span class="s">&quot;power is off&quot;</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* configure webcam image sensor using the serial port */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_init_webcam</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="n">init_values</span><span class="p">[</span><span class="mi">38</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x08</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xc8</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0xcc</span><span class="p">,</span> <span class="mh">0xcc</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x14</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x9b</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x5a</span><span class="p">,</span> <span class="mh">0x3f</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0xe4</span><span class="p">,</span> <span class="mh">0x73</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0x88</span><span class="p">,</span> <span class="mh">0x84</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x14</span><span class="p">,</span> <span class="mh">0x89</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x15</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x17</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xa0</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x6b</span><span class="p">,</span> <span class="mh">0x20</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x40</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x07</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x47</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0xe0</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x1d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x1e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x28</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x60</span> <span class="p">},</span>
		<span class="p">{</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x2d</span><span class="p">,</span> <span class="mh">0x24</span> <span class="p">},</span> <span class="p">{</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="cm">/* the only difference between PAL and NTSC init_values */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">video_norm</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span>
		<span class="n">init_values</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x34</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">init_values</span><span class="p">)</span> <span class="o">/</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE_SOFT</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">init_values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
				     <span class="n">USBVISION_OP_CODE</span><span class="p">,</span>
				     <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span>
				     <span class="n">USB_RECIP_ENDPOINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">USBVISION_SER_DAT1</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span>
				     <span class="mi">3</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE_SIO</span><span class="p">);</span>
		<span class="cm">/* write 3 bytes to the serial port using SIO mode */</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_SER_CONT</span><span class="p">,</span> <span class="mi">3</span> <span class="o">|</span> <span class="mh">0x10</span><span class="p">);</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_IOPIN_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE_SOFT</span><span class="p">);</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_IOPIN_REG</span><span class="p">,</span> <span class="n">USBVISION_IO_2</span><span class="p">);</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE_SOFT</span> <span class="o">|</span> <span class="n">USBVISION_CLK_OUT</span><span class="p">);</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE_SOFT</span> <span class="o">|</span> <span class="n">USBVISION_DAT_IO</span><span class="p">);</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE</span><span class="p">,</span> <span class="n">USBVISION_SER_MODE_SOFT</span> <span class="o">|</span> <span class="n">USBVISION_CLK_OUT</span> <span class="o">|</span> <span class="n">USBVISION_DAT_IO</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_set_video_format()</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_set_video_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">proc</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;usbvision_set_video_format&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;isoc_mode %#02x&quot;</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">format</span> <span class="o">!=</span> <span class="n">ISOC_MODE_YUV422</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">format</span> <span class="o">!=</span> <span class="n">ISOC_MODE_YUV420</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">format</span> <span class="o">!=</span> <span class="n">ISOC_MODE_COMPRESS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;usbvision: unknown video format %02x, using default YUV420&quot;</span><span class="p">,</span>
		       <span class="n">format</span><span class="p">);</span>
		<span class="n">format</span> <span class="o">=</span> <span class="n">ISOC_MODE_YUV420</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0A</span><span class="p">;</span>  <span class="cm">/* TODO: See the effect of the filter */</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span> <span class="cm">/* Sets the VO_MODE register which follows FILT_CONT */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			     <span class="n">USBVISION_OP_CODE</span><span class="p">,</span>
			     <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span>
			     <span class="n">USB_RECIP_ENDPOINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">USBVISION_FILT_CONT</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: ERROR=%d. USBVISION stopped - &quot;</span>
		       <span class="s">&quot;reconnect or reload driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_mode</span> <span class="o">=</span> <span class="n">format</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_set_output()</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">usbvision_set_output</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">int</span> <span class="n">width</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">height</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">usb_width</span><span class="p">,</span> <span class="n">usb_height</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frame_drop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">width</span> <span class="o">&gt;</span> <span class="n">MAX_USB_WIDTH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_width</span> <span class="o">=</span> <span class="n">width</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usb_width</span> <span class="o">=</span> <span class="n">width</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">height</span> <span class="o">&gt;</span> <span class="n">MAX_USB_HEIGHT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_height</span> <span class="o">=</span> <span class="n">height</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usb_height</span> <span class="o">=</span> <span class="n">height</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">RESTRICT_TO_RANGE</span><span class="p">(</span><span class="n">usb_width</span><span class="p">,</span> <span class="n">MIN_FRAME_WIDTH</span><span class="p">,</span> <span class="n">MAX_USB_WIDTH</span><span class="p">);</span>
	<span class="n">usb_width</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">MIN_FRAME_WIDTH</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">RESTRICT_TO_RANGE</span><span class="p">(</span><span class="n">usb_height</span><span class="p">,</span> <span class="n">MIN_FRAME_HEIGHT</span><span class="p">,</span> <span class="n">MAX_USB_HEIGHT</span><span class="p">);</span>
	<span class="n">usb_height</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;usb %dx%d; screen %dx%d; stretch %dx%d&quot;</span><span class="p">,</span>
						<span class="n">usb_width</span><span class="p">,</span> <span class="n">usb_height</span><span class="p">,</span> <span class="n">width</span><span class="p">,</span> <span class="n">height</span><span class="p">,</span>
						<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span><span class="p">);</span>

	<span class="cm">/* I&#39;ll not rewrite the same values */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">usb_width</span> <span class="o">!=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curwidth</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">usb_height</span> <span class="o">!=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curheight</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">usb_width</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>		<span class="cm">/* LSB */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">usb_width</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>	<span class="cm">/* MSB */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">usb_height</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>		<span class="cm">/* LSB */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">usb_height</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>	<span class="cm">/* MSB */</span>

		<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			     <span class="n">USBVISION_OP_CODE</span><span class="p">,</span>
			     <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">,</span>
				 <span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">USBVISION_LXSIZE_O</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s failed: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curwidth</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span> <span class="o">*</span> <span class="n">usb_width</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curheight</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span> <span class="o">*</span> <span class="n">usb_height</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_mode</span> <span class="o">==</span> <span class="n">ISOC_MODE_YUV422</span><span class="p">)</span>
		<span class="n">frame_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">usb_width</span> <span class="o">*</span> <span class="n">usb_height</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_mode</span> <span class="o">==</span> <span class="n">ISOC_MODE_YUV420</span><span class="p">)</span>
		<span class="n">frame_rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="n">usb_width</span> <span class="o">*</span> <span class="n">usb_height</span> <span class="o">*</span> <span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">frame_rate</span> <span class="o">=</span> <span class="n">FRAMERATE_MAX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">tvnorm_id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_625_50</span><span class="p">)</span>
		<span class="n">frame_drop</span> <span class="o">=</span> <span class="n">frame_rate</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">/</span> <span class="mi">25</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">tvnorm_id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_525_60</span><span class="p">)</span>
		<span class="n">frame_drop</span> <span class="o">=</span> <span class="n">frame_rate</span> <span class="o">*</span> <span class="mi">32</span> <span class="o">/</span> <span class="mi">30</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">RESTRICT_TO_RANGE</span><span class="p">(</span><span class="n">frame_drop</span><span class="p">,</span> <span class="n">FRAMERATE_MIN</span><span class="p">,</span> <span class="n">FRAMERATE_MAX</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;frame_rate %d fps, frame_drop %d&quot;</span><span class="p">,</span> <span class="n">frame_rate</span><span class="p">,</span> <span class="n">frame_drop</span><span class="p">);</span>

	<span class="n">frame_drop</span> <span class="o">=</span> <span class="n">FRAMERATE_MAX</span><span class="p">;</span>	<span class="cm">/* We can allow the maximum here, because dropping is controlled */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">codec</span> <span class="o">==</span> <span class="n">CODEC_WEBCAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">video_norm</span> <span class="o">==</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span>
			<span class="n">frame_drop</span> <span class="o">=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">frame_drop</span> <span class="o">=</span> <span class="mi">30</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* frame_drop = 7; =&gt; frame_phase = 1, 5, 9, 13, 17, 21, 25, 0, 4, 8, ...</span>
<span class="cm">		=&gt; frame_skip = 4;</span>
<span class="cm">		=&gt; frame_rate = (7 + 1) * 25 / 32 = 200 / 32 = 6.25;</span>

<span class="cm">	   frame_drop = 9; =&gt; frame_phase = 1, 5, 8, 11, 14, 17, 21, 24, 27, 1, 4, 8, ...</span>
<span class="cm">	    =&gt; frame_skip = 4, 3, 3, 3, 3, 4, 3, 3, 3, 3, 4, ...</span>
<span class="cm">		=&gt; frame_rate = (9 + 1) * 25 / 32 = 250 / 32 = 7.8125;</span>
<span class="cm">	*/</span>
	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_FRM_RATE</span><span class="p">,</span> <span class="n">frame_drop</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * usbvision_frames_alloc</span>
<span class="cm"> * allocate the required frames</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usbvision_frames_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">int</span> <span class="n">number_of_frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* needs to be page aligned cause the buffers can be mapped individually! */</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">max_frame_size</span> <span class="o">=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curwidth</span> <span class="o">*</span>
						<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curheight</span> <span class="o">*</span>
						<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">bytes_per_pixel</span><span class="p">);</span>

	<span class="cm">/* Try to do my best to allocate the frames the user want in the remaining memory */</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span> <span class="o">=</span> <span class="n">number_of_frames</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">fbuf_size</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">fbuf</span> <span class="o">=</span> <span class="n">usbvision_rvmalloc</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">fbuf_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_frame</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_stream</span><span class="p">);</span>

	<span class="cm">/* Allocate all buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">grabstate</span> <span class="o">=</span> <span class="n">frame_state_unused</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">fbuf</span> <span class="o">+</span>
			<span class="n">i</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * Set default sizes for read operation.</span>
<span class="cm">		 */</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_width</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">stretch_height</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">width</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curwidth</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">height</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curheight</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;allocated %d frames (%d bytes per frame)&quot;</span><span class="p">,</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_frames_free</span>
<span class="cm"> * frees memory allocated for the frames</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usbvision_frames_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Have to free all that memory */</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;free %d frames&quot;</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">fbuf</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision_rvfree</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">fbuf</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">fbuf_size</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">fbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * usbvision_empty_framequeues()</span>
<span class="cm"> * prepare queues for incoming and outgoing frames</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usbvision_empty_framequeues</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">inqueue</span><span class="p">));</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">USBVISION_NUMFRAMES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">grabstate</span> <span class="o">=</span> <span class="n">frame_state_unused</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_stream_interrupt()</span>
<span class="cm"> * stops streaming</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usbvision_stream_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* stop reading from the device */</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">stream_interrupt</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_stream</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">stream_idle</span><span class="p">),</span>
				 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">USBVISION_NUMSBUF</span><span class="o">*</span><span class="n">USBVISION_URB_FRAMES</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_set_compress_params()</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_set_compress_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">proc</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;usbvision_set_compresion_params: &quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>

	<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>    <span class="cm">/* Intra-Compression cycle */</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>    <span class="cm">/* Reg.45 one line per strip */</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>    <span class="cm">/* Reg.46 Force intra mode on all new frames */</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>    <span class="cm">/* Reg.47 FORCE_UP &lt;- 0 normal operation (not force) */</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xA2</span><span class="p">;</span>    <span class="cm">/* Reg.48 BUF_THR I&#39;m not sure if this does something in not compressed mode. */</span>
	<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>    <span class="cm">/* Reg.49 DVI_YUV This has nothing to do with compression */</span>

	<span class="cm">/* catched values for NT1004 */</span>
	<span class="cm">/* value[0] = 0xFF; Never apply intra mode automatically */</span>
	<span class="cm">/* value[1] = 0xF1; Use full frame height for virtual strip width; One line per strip */</span>
	<span class="cm">/* value[2] = 0x01; Force intra mode on all new frames */</span>
	<span class="cm">/* value[3] = 0x00; Strip size 400 Bytes; do not force up */</span>
	<span class="cm">/* value[4] = 0xA2; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			     <span class="n">USBVISION_OP_CODE</span><span class="p">,</span>
			     <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span>
			     <span class="n">USB_RECIP_ENDPOINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">USBVISION_INTRA_CYC</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%sERROR=%d. USBVISION stopped - &quot;</span>
		       <span class="s">&quot;reconnect or reload driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">bridge_type</span> <span class="o">==</span> <span class="n">BRIDGE_NT1004</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">20</span><span class="p">;</span> <span class="cm">/* PCM Threshold 1 */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">12</span><span class="p">;</span> <span class="cm">/* PCM Threshold 2 */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="cm">/* Distortion Threshold inter */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="cm">/* Distortion Threshold intra */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">43</span><span class="p">;</span> <span class="cm">/* Max Distortion inter */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">43</span><span class="p">;</span> <span class="cm">/* Max Distortion intra */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">20</span><span class="p">;</span> <span class="cm">/* PCM Threshold 1 */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">12</span><span class="p">;</span> <span class="cm">/* PCM Threshold 2 */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span> <span class="cm">/* Distortion Threshold d7-d0 */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Distortion Threshold d11-d8 */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span>  <span class="mi">43</span><span class="p">;</span> <span class="cm">/* Max Distortion d7-d0 */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span>   <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Max Distortion d8 */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			     <span class="n">USBVISION_OP_CODE</span><span class="p">,</span>
			     <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span>
			     <span class="n">USB_RECIP_ENDPOINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">USBVISION_PCM_THR1</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%sERROR=%d. USBVISION stopped - &quot;</span>
		       <span class="s">&quot;reconnect or reload driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * usbvision_set_input()</span>
<span class="cm"> *</span>
<span class="cm"> * Set the input (saa711x, ...) size x y and other misc input params</span>
<span class="cm"> * I&#39;ve no idea if this parameters are right</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usbvision_set_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">proc</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;usbvision_set_input: &quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dvi_yuv_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set input format expected from decoder*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">vin_reg1_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">vin_reg1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">codec</span> <span class="o">==</span> <span class="n">CODEC_SAA7113</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* SAA7113 uses 8 bit output */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">USBVISION_8_422_SYNC</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* I&#39;m sure only about d2-d0 [010] 16 bit 4:2:2 usin sync pulses</span>
<span class="cm">		 * as that is how saa7111 is configured */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">USBVISION_16_422_SYNC</span><span class="p">;</span>
		<span class="cm">/* | USBVISION_VSNC_POL | USBVISION_VCLK_POL);*/</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_VIN_REG1</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%sERROR=%d. USBVISION stopped - &quot;</span>
		       <span class="s">&quot;reconnect or reload driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">tvnorm_id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_PAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>	<span class="cm">/* 0x02C0 -&gt; 704 Input video line length */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* 0x0120 -&gt; 288 Input video n. of lines */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x60</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0x0060 -&gt; 96 Input video h offset */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x16</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0x0016 -&gt; 22 Input video v offset */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">tvnorm_id</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xC0</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>	<span class="cm">/* 0x02C0 -&gt; 704 Input video line length */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* 0x0120 -&gt; 288 Input video n. of lines */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0x0001 -&gt; 01 Input video h offset */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0x0001 -&gt; 01 Input video v offset */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* V4L2_STD_NTSC */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xD0</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span>	<span class="cm">/* 0x02D0 -&gt; 720 Input video line length */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xF0</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0x00F0 -&gt; 240 Input video number of lines */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0x0050 -&gt; 80 Input video h offset */</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* 0x0010 -&gt; 16 Input video v offset */</span>
	<span class="p">}</span>

	<span class="cm">/* webcam is only 480 pixels wide, both PAL and NTSC version */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">codec</span> <span class="o">==</span> <span class="n">CODEC_WEBCAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x01</span><span class="p">;</span>	<span class="cm">/* 0x01E0 -&gt; 480 Input video line length */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">x_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">x_offset</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">x_offset</span> <span class="o">&amp;</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adjust_x_offset</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjust_x_offset</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">adjust_x_offset</span> <span class="o">&amp;</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">y_offset</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">y_offset</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">y_offset</span> <span class="o">&amp;</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adjust_y_offset</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">adjust_y_offset</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">adjust_y_offset</span> <span class="o">&amp;</span> <span class="mh">0x0300</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			     <span class="n">USBVISION_OP_CODE</span><span class="p">,</span>	<span class="cm">/* USBVISION specific code */</span>
			     <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span> <span class="n">USB_RECIP_ENDPOINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">USBVISION_LXSIZE_I</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%sERROR=%d. USBVISION stopped - &quot;</span>
		       <span class="s">&quot;reconnect or reload driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proc</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">dvi_yuv_value</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* U comes after V, Ya comes after U/V, Yb comes after Yb */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">dvi_yuv_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dvi_yuv_value</span> <span class="o">=</span> <span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">dvi_yuv</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">codec</span> <span class="o">==</span> <span class="n">CODEC_SAA7113</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* This changes as the fine sync control changes. Further investigation necessary */</span>
		<span class="n">dvi_yuv_value</span> <span class="o">=</span> <span class="mh">0x06</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_DVI_YUV</span><span class="p">,</span> <span class="n">dvi_yuv_value</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * usbvision_set_dram_settings()</span>
<span class="cm"> *</span>
<span class="cm"> * Set the buffer address needed by the usbvision dram to operate</span>
<span class="cm"> * This values has been taken with usbsnoop.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_set_dram_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">value</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_mode</span> <span class="o">==</span> <span class="n">ISOC_MODE_COMPRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x71</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x98</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xe0</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x71</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="cm">/* UR:  0x0E200-0x3FFFF = 204288 Words (1 Word = 2 Byte) */</span>
		<span class="cm">/* FDL: 0x00000-0x0E099 =  57498 Words */</span>
		<span class="cm">/* VDW: 0x0E3FF-0x3FFFF */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">value</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* These are the values of the address of the video buffer,</span>
<span class="cm">	 * they have to be loaded into the USBVISION_DRM_PRM1-8</span>
<span class="cm">	 *</span>
<span class="cm">	 * Start address of video output buffer for read:	drm_prm1-2 -&gt; 0x00000</span>
<span class="cm">	 * End address of video output buffer for read:		drm_prm1-3 -&gt; 0x1ffff</span>
<span class="cm">	 * Start address of video frame delay buffer:		drm_prm1-4 -&gt; 0x20000</span>
<span class="cm">	 *    Only used in compressed mode</span>
<span class="cm">	 * End address of video frame delay buffer:		drm_prm1-5-6 -&gt; 0x3ffff</span>
<span class="cm">	 *    Only used in compressed mode</span>
<span class="cm">	 * Start address of video output buffer for write:	drm_prm1-7 -&gt; 0x00000</span>
<span class="cm">	 * End address of video output buffer for write:	drm_prm1-8 -&gt; 0x1ffff</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">usb_control_msg</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usb_sndctrlpipe</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
			     <span class="n">USBVISION_OP_CODE</span><span class="p">,</span>	<span class="cm">/* USBVISION specific code */</span>
			     <span class="n">USB_DIR_OUT</span> <span class="o">|</span> <span class="n">USB_TYPE_VENDOR</span> <span class="o">|</span>
			     <span class="n">USB_RECIP_ENDPOINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			     <span class="p">(</span><span class="n">__u16</span><span class="p">)</span> <span class="n">USBVISION_DRM_PRM1</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: ERROR=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Restart the video buffer logic */</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_DRM_CONT</span><span class="p">,</span> <span class="n">USBVISION_RES_UR</span> <span class="o">|</span>
				   <span class="n">USBVISION_RES_FDL</span> <span class="o">|</span> <span class="n">USBVISION_RES_VDW</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_DRM_CONT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ()</span>
<span class="cm"> *</span>
<span class="cm"> * Power on the device, enables suspend-resume logic</span>
<span class="cm"> * &amp;  reset the isoc End-Point</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">usbvision_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_PWR_REG</span><span class="p">,</span> <span class="n">USBVISION_SSPND_EN</span><span class="p">);</span>
	<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_PWR_REG</span><span class="p">,</span>
			<span class="n">USBVISION_SSPND_EN</span> <span class="o">|</span> <span class="n">USBVISION_RES2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">codec</span> <span class="o">==</span> <span class="n">CODEC_WEBCAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_VIN_REG1</span><span class="p">,</span>
				<span class="n">USBVISION_16_422_SYNC</span> <span class="o">|</span> <span class="n">USBVISION_HVALID_PO</span><span class="p">);</span>
		<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_VIN_REG2</span><span class="p">,</span>
				<span class="n">USBVISION_NOHVALID</span> <span class="o">|</span> <span class="n">USBVISION_KEEP_BLANK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_PWR_REG</span><span class="p">,</span>
			<span class="n">USBVISION_SSPND_EN</span> <span class="o">|</span> <span class="n">USBVISION_PWR_VID</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_PWR_REG</span><span class="p">,</span>
			<span class="n">USBVISION_SSPND_EN</span> <span class="o">|</span> <span class="n">USBVISION_PWR_VID</span> <span class="o">|</span> <span class="n">USBVISION_RES2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;%s: err_code %d&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ERROR&quot;</span> <span class="o">:</span> <span class="s">&quot;power is on&quot;</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * usbvision timer stuff</span>
<span class="cm"> */</span>

<span class="cm">/* to call usbvision_power_off from task queue */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">call_usbvision_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_usbvision</span><span class="p">,</span> <span class="n">power_off_work</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision_i2c_unregister</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

		<span class="n">usbvision_power_off</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_power_off_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power_off_timer</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power_off_work</span><span class="p">,</span> <span class="n">call_usbvision_power_off</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power_off_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbvision_init_power_off_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power_off_timer</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power_off_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">usbvision</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power_off_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">usbvision_power_off_timer</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbvision_set_power_off_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power_off_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">USBVISION_POWEROFF_TIME</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">usbvision_reset_power_off_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timer_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power_off_timer</span><span class="p">))</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power_off_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_begin_streaming()</span>
<span class="cm"> * Sure you have to put bit 7 to 0, if not incoming frames are droped, but no</span>
<span class="cm"> * idea about the rest</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usbvision_begin_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_mode</span> <span class="o">==</span> <span class="n">ISOC_MODE_COMPRESS</span><span class="p">)</span>
		<span class="n">usbvision_init_compression</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_VIN_REG2</span><span class="p">,</span>
		<span class="n">USBVISION_NOHVALID</span> <span class="o">|</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vin_reg2_preset</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_restart_isoc()</span>
<span class="cm"> * Not sure yet if touching here PWR_REG make loose the config</span>
<span class="cm"> */</span>

<span class="kt">int</span> <span class="nf">usbvision_restart_isoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_PWR_REG</span><span class="p">,</span>
			      <span class="n">USBVISION_SSPND_EN</span> <span class="o">|</span> <span class="n">USBVISION_PWR_VID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_PWR_REG</span><span class="p">,</span>
			      <span class="n">USBVISION_SSPND_EN</span> <span class="o">|</span> <span class="n">USBVISION_PWR_VID</span> <span class="o">|</span>
			      <span class="n">USBVISION_RES2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_VIN_REG2</span><span class="p">,</span>
			      <span class="n">USBVISION_KEEP_BLANK</span> <span class="o">|</span> <span class="n">USBVISION_NOHVALID</span> <span class="o">|</span>
				  <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vin_reg2_preset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* TODO: schedule timeout */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">usbvision_read_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_STATUS_REG</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">usbvision_audio_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_IOPIN_REG</span><span class="p">,</span> <span class="n">USBVISION_AUDIO_MUTE</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;usbvision_audio_off: can&#39;t write reg</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">audio_mute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">audio_channel</span> <span class="o">=</span> <span class="n">USBVISION_AUDIO_MUTE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">usbvision_set_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">int</span> <span class="n">audio_channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">audio_mute</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_IOPIN_REG</span><span class="p">,</span> <span class="n">audio_channel</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;usbvision_set_audio: can&#39;t write iopin register for audio switching</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">audio_channel</span> <span class="o">=</span> <span class="n">audio_channel</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">usbvision_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">int</span> <span class="n">format</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">codec</span> <span class="o">==</span> <span class="n">CODEC_WEBCAM</span><span class="p">)</span>
		<span class="n">usbvision_init_webcam</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_set_video_format</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">format</span><span class="p">);</span>
	<span class="n">usbvision_set_dram_settings</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_set_compress_params</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_set_input</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_set_output</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">MAX_USB_WIDTH</span><span class="p">,</span> <span class="n">MAX_USB_HEIGHT</span><span class="p">);</span>
	<span class="n">usbvision_restart_isoc</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="cm">/* cosas del PCM */</span>
	<span class="k">return</span> <span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">usbvision_set_alternate</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span><span class="p">,</span> <span class="n">prev_alt</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface_alt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface_alt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">num_alt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface_alt</span><span class="p">])</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface_alt</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface_alt</span> <span class="o">!=</span> <span class="n">prev_alt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface_alt</span><span class="p">];</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_FUNC</span><span class="p">,</span> <span class="s">&quot;setting alternate %d with max_packet_size=%u&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface_alt</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span><span class="p">);</span>
		<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface_alt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;cannot change alternate number to %d (error=%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">iface_alt</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;ISO Packet Length:%d&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_init_isoc()</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">usbvision_init_isoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">buf_idx</span><span class="p">,</span> <span class="n">err_code</span><span class="p">,</span> <span class="n">reg_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sb_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">scratch_reset</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="cm">/* Alternate interface 1 is is the biggest frame size */</span>
	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_set_alternate</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">err_code</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sb_size</span> <span class="o">=</span> <span class="n">USBVISION_URB_FRAMES</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span><span class="p">;</span>

	<span class="n">reg_value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span> <span class="o">-</span> <span class="n">usbvision_read_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span>
					    <span class="n">USBVISION_ALTER_REG</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">usb_bandwidth</span> <span class="o">=</span> <span class="n">reg_value</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;USB Bandwidth Usage: %dMbit/Sec&quot;</span><span class="p">,</span>
	       <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">usb_bandwidth</span><span class="p">);</span>



	<span class="cm">/* We double buffer the Iso lists */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">buf_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buf_idx</span> <span class="o">&lt;</span> <span class="n">USBVISION_NUMSBUF</span><span class="p">;</span> <span class="n">buf_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">urb</span> <span class="o">*</span><span class="n">urb</span><span class="p">;</span>

		<span class="n">urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">USBVISION_URB_FRAMES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: usb_alloc_urb() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">urb</span> <span class="o">=</span> <span class="n">urb</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span>
			<span class="n">usb_alloc_coherent</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">sb_size</span><span class="p">,</span>
					   <span class="n">GFP_KERNEL</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">context</span> <span class="o">=</span> <span class="n">usbvision</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">pipe</span> <span class="o">=</span> <span class="n">usb_rcvisocpipe</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">video_endp</span><span class="p">);</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_flags</span> <span class="o">=</span> <span class="n">URB_ISO_ASAP</span> <span class="o">|</span> <span class="n">URB_NO_TRANSFER_DMA_MAP</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">interval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="n">usbvision_isoc_irq</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">number_of_packets</span> <span class="o">=</span> <span class="n">USBVISION_URB_FRAMES</span><span class="p">;</span>
		<span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_buffer_length</span> <span class="o">=</span>
		    <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span> <span class="o">*</span> <span class="n">USBVISION_URB_FRAMES</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">USBVISION_URB_FRAMES</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span>
		     <span class="n">k</span> <span class="o">+=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">offset</span> <span class="o">=</span> <span class="n">k</span><span class="p">;</span>
			<span class="n">urb</span><span class="o">-&gt;</span><span class="n">iso_frame_desc</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">length</span> <span class="o">=</span>
				<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Submit all URBs */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">buf_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buf_idx</span> <span class="o">&lt;</span> <span class="n">USBVISION_NUMSBUF</span><span class="p">;</span> <span class="n">buf_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_submit_urb</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">urb</span><span class="p">,</span>
						 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: usb_submit_urb(%d) failed: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">buf_idx</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">stream_idle</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;%s: streaming=1 usbvision-&gt;video_endp=$%02x&quot;</span><span class="p">,</span>
	       <span class="n">__func__</span><span class="p">,</span>
	       <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">video_endp</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_stop_isoc()</span>
<span class="cm"> *</span>
<span class="cm"> * This procedure stops streaming and deallocates URBs. Then it</span>
<span class="cm"> * activates zero-bandwidth alt. setting of the video interface.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">usbvision_stop_isoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">buf_idx</span><span class="p">,</span> <span class="n">err_code</span><span class="p">,</span> <span class="n">reg_value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sb_size</span> <span class="o">=</span> <span class="n">USBVISION_URB_FRAMES</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">stream_off</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Unschedule all of the iso td&#39;s */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">buf_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">buf_idx</span> <span class="o">&lt;</span> <span class="n">USBVISION_NUMSBUF</span><span class="p">;</span> <span class="n">buf_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usb_kill_urb</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usb_free_coherent</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">sb_size</span><span class="p">,</span>
					  <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">data</span><span class="p">,</span>
					  <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">urb</span><span class="o">-&gt;</span><span class="n">transfer_dma</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">urb</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">sbuf</span><span class="p">[</span><span class="n">buf_idx</span><span class="p">].</span><span class="n">urb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;%s: streaming=stream_off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">stream_off</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">remove_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set packet size to 0 */</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">iface_alt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">,</span>
					    <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">iface_alt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;%s: usb_set_interface() failed: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">err_code</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">reg_value</span> <span class="o">=</span> <span class="p">(</span><span class="mi">16</span><span class="o">-</span><span class="n">usbvision_read_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_ALTER_REG</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">;</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">reg_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="p">(</span><span class="n">reg_value</span> <span class="o">*</span> <span class="mi">64</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;ISO Packet Length:%d&quot;</span><span class="p">,</span>
		       <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span><span class="p">);</span>

		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">usb_bandwidth</span> <span class="o">=</span> <span class="n">reg_value</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_ISOC</span><span class="p">,</span> <span class="s">&quot;USB Bandwidth Usage: %dMbit/Sec&quot;</span><span class="p">,</span>
		       <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">usb_bandwidth</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">usbvision_muxsel</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* inputs #0 and #3 are constant for every SAA711x. */</span>
	<span class="cm">/* inputs #1 and #2 are variable for SAA7111 and SAA7113 */</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">SAA7115_COMPOSITE0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">SAA7115_COMPOSITE3</span> <span class="p">};</span>
	<span class="kt">int</span> <span class="n">audio</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="cm">/* channel 0 is TV with audiochannel 1 (tuner mono) */</span>
	<span class="cm">/* channel 1 is Composite with audio channel 0 (line in) */</span>
	<span class="cm">/* channel 2 is S-Video with audio channel 0 (line in) */</span>
	<span class="cm">/* channel 3 is additional video inputs to the device with audio channel 0 (line in) */</span>

	<span class="n">RESTRICT_TO_RANGE</span><span class="p">(</span><span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">video_inputs</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctl_input</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

	<span class="cm">/* set the new channel */</span>
	<span class="cm">/* Regular USB TV Tuners -&gt; channel: 0 = Television, 1 = Composite, 2 = S-Video */</span>
	<span class="cm">/* Four video input devices -&gt; channel: 0 = Chan White, 1 = Chan Green, 2 = Chan Yellow, 3 = Chan Red */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">codec</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CODEC_SAA7113</span>:
		<span class="n">mode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAA7115_COMPOSITE2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">switch_svideo_input</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* To handle problems with S-Video Input for</span>
<span class="cm">			 * some devices.  Use switch_svideo_input</span>
<span class="cm">			 * parameter when loading the module.*/</span>
			<span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAA7115_COMPOSITE1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAA7115_SVIDEO1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CODEC_SAA7111</span>:
	<span class="nl">default:</span>
		<span class="cm">/* modes for saa7111 */</span>
		<span class="n">mode</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAA7115_COMPOSITE1</span><span class="p">;</span>
		<span class="n">mode</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">SAA7115_SVIDEO1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_routing</span><span class="p">,</span> <span class="n">mode</span><span class="p">[</span><span class="n">channel</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">usbvision_set_audio</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">audio</span><span class="p">[</span><span class="n">channel</span><span class="p">]);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we follow Linus&#39;s tabbing style.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
