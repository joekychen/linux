<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › usbvision › usbvision-video.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>usbvision-video.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * USB USBVISION Video device driver 0.9.10</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1999-2005 Joerg Heckenbach &lt;joerg@heckenbach-aw.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This module is part of usbvision driver project.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * Let&#39;s call the version 0.... until compression decoding is completely</span>
<span class="cm"> * implemented.</span>
<span class="cm"> *</span>
<span class="cm"> * This driver is written by Jose Ignacio Gijon and Joerg Heckenbach.</span>
<span class="cm"> * It was based on USB CPiA driver written by Peter Pregler,</span>
<span class="cm"> * Scott J. Bertin and Johannes Erdfelt</span>
<span class="cm"> * Ideas are taken from bttv driver by Ralph Metzler, Marcus Metzler &amp;</span>
<span class="cm"> * Gerd Knorr and zoran 36120/36125 driver by Pauline Middelink</span>
<span class="cm"> * Updates to driver completed by Dwaine P. Garden</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> *     - use submit_urb for all setup packets</span>
<span class="cm"> *     - Fix memory settings for nt1004. It is 4 times as big as the</span>
<span class="cm"> *       nt1003 memory.</span>
<span class="cm"> *     - Add audio on endpoint 3 for nt1004 chip.</span>
<span class="cm"> *         Seems impossible, needs a codec interface.  Which one?</span>
<span class="cm"> *     - Clean up the driver.</span>
<span class="cm"> *     - optimization for performance.</span>
<span class="cm"> *     - Add Videotext capability (VBI).  Working on it.....</span>
<span class="cm"> *     - Check audio for other devices</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/highmem.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>

<span class="cp">#include &lt;media/saa7115.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-ioctl.h&gt;</span>
<span class="cp">#include &lt;media/tuner.h&gt;</span>

<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &quot;usbvision.h&quot;</span>
<span class="cp">#include &quot;usbvision-cards.h&quot;</span>

<span class="cp">#define DRIVER_AUTHOR					\</span>
<span class="cp">	&quot;Joerg Heckenbach &lt;joerg@heckenbach-aw.de&gt;, &quot;	\</span>
<span class="cp">	&quot;Dwaine Garden &lt;DwaineGarden@rogers.com&gt;&quot;</span>
<span class="cp">#define DRIVER_NAME &quot;usbvision&quot;</span>
<span class="cp">#define DRIVER_ALIAS &quot;USBVision&quot;</span>
<span class="cp">#define DRIVER_DESC &quot;USBVision USB Video Device Driver for Linux&quot;</span>
<span class="cp">#define DRIVER_LICENSE &quot;GPL&quot;</span>
<span class="cp">#define USBVISION_VERSION_STRING &quot;0.9.11&quot;</span>

<span class="cp">#define	ENABLE_HEXDUMP	0	</span><span class="cm">/* Enable if you need it */</span><span class="cp"></span>


<span class="cp">#ifdef USBVISION_DEBUG</span>
	<span class="cp">#define PDEBUG(level, fmt, args...) { \</span>
<span class="cp">		if (video_debug &amp; (level)) \</span>
<span class="cp">			printk(KERN_INFO KBUILD_MODNAME &quot;:[%s:%d] &quot; fmt, \</span>
<span class="cp">				__func__, __LINE__ , ## args); \</span>
<span class="cp">	}</span>
<span class="cp">#else</span>
	<span class="cp">#define PDEBUG(level, fmt, args...) do {} while (0)</span>
<span class="cp">#endif</span>

<span class="cp">#define DBG_IO		(1 &lt;&lt; 1)</span>
<span class="cp">#define DBG_PROBE	(1 &lt;&lt; 2)</span>
<span class="cp">#define DBG_MMAP	(1 &lt;&lt; 3)</span>

<span class="cm">/* String operations */</span>
<span class="cp">#define rmspace(str)	while (*str == &#39; &#39;) str++;</span>
<span class="cp">#define goto2next(str)	while (*str != &#39; &#39;) str++; while (*str == &#39; &#39;) str++;</span>


<span class="cm">/* sequential number of usbvision device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">usbvision_nr</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usbvision_v4l2_format_st</span> <span class="n">usbvision_v4l2_format</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>  <span class="mi">8</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_GREY</span>    <span class="p">,</span> <span class="s">&quot;GREY&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_RGB565</span>  <span class="p">,</span> <span class="s">&quot;RGB565&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_RGB24</span>   <span class="p">,</span> <span class="s">&quot;RGB24&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_RGB32</span>   <span class="p">,</span> <span class="s">&quot;RGB32&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_RGB555</span>  <span class="p">,</span> <span class="s">&quot;RGB555&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_YUYV</span>    <span class="p">,</span> <span class="s">&quot;YUV422&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_YVU420</span>  <span class="p">,</span> <span class="s">&quot;YUV420P&quot;</span> <span class="p">},</span> <span class="cm">/* 1.5 ! */</span>
	<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">V4L2_PIX_FMT_YUV422P</span> <span class="p">,</span> <span class="s">&quot;YUV422P&quot;</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Function prototypes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">usbvision_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">);</span>

<span class="cm">/* Default initialization of device driver parameters */</span>
<span class="cm">/* Set the default format for ISOC endpoint */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">isoc_mode</span> <span class="o">=</span> <span class="n">ISOC_MODE_COMPRESS</span><span class="p">;</span>
<span class="cm">/* Set the default Debug Mode of the device driver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_debug</span><span class="p">;</span>
<span class="cm">/* Set the default device to power on at startup */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">power_on_at_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/* Sequential Number of Video Device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">video_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cm">/* Sequential Number of Radio Device */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">radio_nr</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Grab parameters for the device driver */</span>

<span class="cm">/* Showing parameters under SYSFS */</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">isoc_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video_debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">power_on_at_open</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">isoc_mode</span><span class="p">,</span> <span class="s">&quot; Set the default format for ISOC endpoint.  Default: 0x60 (Compression On)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video_debug</span><span class="p">,</span> <span class="s">&quot; Set the default Debug Mode of the device driver.  Default: 0 (Off)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">power_on_at_open</span><span class="p">,</span> <span class="s">&quot; Set the default device to power on when device is opened.  Default: 1 (On)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">video_nr</span><span class="p">,</span> <span class="s">&quot;Set video device number (/dev/videoX).  Default: -1 (autodetect)&quot;</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">radio_nr</span><span class="p">,</span> <span class="s">&quot;Set radio device number (/dev/radioX).  Default: -1 (autodetect)&quot;</span><span class="p">);</span>


<span class="cm">/* Misc stuff */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESC</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="n">DRIVER_LICENSE</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">USBVISION_VERSION_STRING</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="n">DRIVER_ALIAS</span><span class="p">);</span>


<span class="cm">/*****************************************************************************/</span>
<span class="cm">/* SYSFS Code - Copied from the stv680.c usb module.			     */</span>
<span class="cm">/* Device information is located at /sys/class/video4linux/video0            */</span>
<span class="cm">/* Device parameters information is located at /sys/module/usbvision         */</span>
<span class="cm">/* Device USB Information is located at                                      */</span>
<span class="cm">/*   /sys/bus/usb/drivers/USBVision Video Grabber                            */</span>
<span class="cm">/*****************************************************************************/</span>

<span class="cp">#define YES_NO(x) ((x) ? &quot;Yes&quot; : &quot;No&quot;)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="nf">cd_to_usbvision</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">USBVISION_VERSION_STRING</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_version</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_model</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">model_string</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_model</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_hue</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_HUE</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span>
		<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">hue</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_hue</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_contrast</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_CONTRAST</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span>
		<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">contrast</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_contrast</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_brightness</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_BRIGHTNESS</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span>
		<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">brightness</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_brightness</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_saturation</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">V4L2_CID_SATURATION</span><span class="p">;</span>
	<span class="n">ctrl</span><span class="p">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span>
		<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">.</span><span class="n">value</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">saturation</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_saturation</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">YES_NO</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">stream_on</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">streaming</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_streaming</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_compression</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">YES_NO</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_mode</span> <span class="o">==</span> <span class="n">ISOC_MODE_COMPRESS</span><span class="p">));</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">compression</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_compression</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_device_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">cd</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">cd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">video_device</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_get_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">bridge_type</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">bridge</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_device_bridge</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_create_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vdev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_version</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_model</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_hue</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_contrast</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_brightness</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_saturation</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_streaming</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_compression</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bridge</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">res</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_remove_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_version</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_model</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_hue</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_contrast</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_brightness</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_saturation</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_streaming</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_compression</span><span class="p">);</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_bridge</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_open()</span>
<span class="cm"> *</span>
<span class="cm"> * This is part of Video 4 Linux API. The driver can be opened by one</span>
<span class="cm"> * client only (checks internal counter &#39;usbvision-&gt;user&#39;). The procedure</span>
<span class="cm"> * then allocates buffers needed for video processing.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_v4l2_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;open&quot;</span><span class="p">);</span>

	<span class="n">usbvision_reset_power_off_timer</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span>
		<span class="n">err_code</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Allocate memory for the scratch ring buffer */</span>
		<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_scratch_alloc</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">isoc_mode</span> <span class="o">==</span> <span class="n">ISOC_MODE_COMPRESS</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Allocate intermediate decompression buffers</span>
<span class="cm">			   only if needed */</span>
			<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_decompress_alloc</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Deallocate all buffers if trouble */</span>
			<span class="n">usbvision_scratch_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="n">usbvision_decompress_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If so far no errors then we shall start the camera */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usbvision_power_on</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="n">usbvision_i2c_register</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Send init sequence only once, it&#39;s large! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">setup_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">setup_ok</span> <span class="o">=</span> <span class="n">usbvision_setup</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">isoc_mode</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">setup_ok</span><span class="p">)</span>
				<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">err_code</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usbvision_begin_streaming</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_init_isoc</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="cm">/* device must be initialized before isoc transfer */</span>
			<span class="n">usbvision_muxsel</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">power_on_at_open</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">usbvision_i2c_unregister</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
				<span class="n">usbvision_power_off</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
				<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* prepare queues */</span>
	<span class="n">usbvision_empty_framequeues</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_v4l2_close()</span>
<span class="cm"> *</span>
<span class="cm"> * This is part of Video 4 Linux API. The procedure</span>
<span class="cm"> * stops streaming and deallocates all buffers that were earlier</span>
<span class="cm"> * allocated in usbvision_v4l2_open().</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_v4l2_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;close&quot;</span><span class="p">);</span>

	<span class="n">usbvision_audio_off</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_restart_isoc</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_stop_isoc</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">usbvision_decompress_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_frames_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_empty_framequeues</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_scratch_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_on_at_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* power off in a little while</span>
<span class="cm">		   to avoid off/on every close/open short sequences */</span>
		<span class="n">usbvision_set_power_off_timer</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">remove_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Final disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">usbvision_release</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * usbvision_ioctl()</span>
<span class="cm"> *</span>
<span class="cm"> * This is part of Video 4 Linux API. The procedure handles ioctl() calls.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err_code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* NT100x has a 8-bit register space */</span>
	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_read_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span><span class="o">&amp;</span><span class="mh">0xff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: VIDIOC_DBG_G_REGISTER failed: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="n">reg</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_dbg_register</span> <span class="o">*</span><span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err_code</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">v4l2_chip_match_host</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reg</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* NT100x has a 8-bit register space */</span>
	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_write_reg</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">reg</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: VIDIOC_DBG_S_REGISTER failed: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">err_code</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querycap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_capability</span> <span class="o">*</span><span class="n">vc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;USBVision&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">));</span>
	<span class="n">strlcpy</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
		<span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">model_string</span><span class="p">,</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">));</span>
	<span class="n">usb_make_path</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">vc</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vc</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">));</span>
	<span class="n">vc</span><span class="o">-&gt;</span><span class="n">capabilities</span> <span class="o">=</span> <span class="n">V4L2_CAP_VIDEO_CAPTURE</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_AUDIO</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_READWRITE</span> <span class="o">|</span>
		<span class="n">V4L2_CAP_STREAMING</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">have_tuner</span> <span class="o">?</span> <span class="n">V4L2_CAP_TUNER</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_input</span> <span class="o">*</span><span class="n">vi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">chan</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">video_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">have_tuner</span><span class="p">)</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">vi</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* skip Television string*/</span>

	<span class="cm">/* Determine the requested input characteristics</span>
<span class="cm">	   specific for each usbvision card model */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">video_channels</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;White Video Input&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Television&quot;</span><span class="p">);</span>
			<span class="n">vi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_TUNER</span><span class="p">;</span>
			<span class="n">vi</span><span class="o">-&gt;</span><span class="n">audioset</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">vi</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">=</span> <span class="n">chan</span><span class="p">;</span>
			<span class="n">vi</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">USBVISION_NORMS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="n">vi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">video_channels</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Green Video Input&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Composite Video Input&quot;</span><span class="p">);</span>
		<span class="n">vi</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">vi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">video_channels</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Yellow Video Input&quot;</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;S-Video Input&quot;</span><span class="p">);</span>
		<span class="n">vi</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="n">vi</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_INPUT_TYPE_CAMERA</span><span class="p">;</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">vi</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Red Video Input&quot;</span><span class="p">);</span>
		<span class="n">vi</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="o">*</span><span class="n">input</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_input</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">input</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">input</span> <span class="o">&gt;=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">video_inputs</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">usbvision_muxsel</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">input</span><span class="p">);</span>
	<span class="n">usbvision_set_input</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_set_output</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span>
			     <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curwidth</span><span class="p">,</span>
			     <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curheight</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_std</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">v4l2_std_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">tvnorm_id</span> <span class="o">=</span> <span class="o">*</span><span class="n">id</span><span class="p">;</span>

	<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_std</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">tvnorm_id</span><span class="p">);</span>
	<span class="cm">/* propagate the change to the decoder */</span>
	<span class="n">usbvision_muxsel</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctl_input</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">have_tuner</span> <span class="o">||</span> <span class="n">vt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>	<span class="cm">/* Only tuner 0 */</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">);</span>
		<span class="n">vt</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">vt</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Television&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Let clients fill in the remainder of this struct */</span>
	<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">g_tuner</span><span class="p">,</span> <span class="n">vt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_tuner</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_tuner</span> <span class="o">*</span><span class="n">vt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="cm">/* Only no or one tuner for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">have_tuner</span> <span class="o">||</span> <span class="n">vt</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* let clients handle this */</span>
	<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_tuner</span><span class="p">,</span> <span class="n">vt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">freq</span><span class="o">-&gt;</span><span class="n">tuner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Only one tuner */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
		<span class="n">freq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_RADIO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">freq</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_TUNER_ANALOG_TV</span><span class="p">;</span>
	<span class="n">freq</span><span class="o">-&gt;</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">freq</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_frequency</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_frequency</span> <span class="o">*</span><span class="n">freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="cm">/* Only no or one tuner for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">have_tuner</span> <span class="o">||</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">tuner</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span><span class="o">-&gt;</span><span class="n">frequency</span><span class="p">;</span>
	<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_frequency</span><span class="p">,</span> <span class="n">freq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;Radio&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;TV&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_audio</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_audio</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_queryctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">v4l2_queryctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">queryctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">g_ctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_control</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">core</span><span class="p">,</span> <span class="n">s_ctrl</span><span class="p">,</span> <span class="n">ctrl</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_reqbufs</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_requestbuffers</span> <span class="o">*</span><span class="n">vr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">RESTRICT_TO_RANGE</span><span class="p">(</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">USBVISION_NUMFRAMES</span><span class="p">);</span>

	<span class="cm">/* Check input validity:</span>
<span class="cm">	   the user must do a VIDEO CAPTURE and MMAP method. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vr</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">!=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">stream_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbvision_stream_interrupt</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbvision_frames_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_empty_framequeues</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">vr</span><span class="o">-&gt;</span><span class="n">count</span> <span class="o">=</span> <span class="n">usbvision_frames_alloc</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">vr</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_querybuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>

	<span class="cm">/* FIXME : must control</span>
<span class="cm">	   that buffers are mapped (VIDIOC_REQBUFS has been called) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="cm">/* Updating the corresponding frame state */</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">&gt;=</span> <span class="n">frame_state_ready</span><span class="p">)</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_QUEUED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">&gt;=</span> <span class="n">frame_state_done</span><span class="p">)</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">==</span> <span class="n">frame_state_unused</span><span class="p">)</span>
		<span class="n">vb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_BUF_FLAG_MAPPED</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">m</span><span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="n">vb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">*</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">);</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curwidth</span> <span class="o">*</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curheight</span> <span class="o">*</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">timestamp</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">sequence</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_qbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>

	<span class="cm">/* FIXME : works only on VIDEO_CAPTURE MODE, MMAP. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">!=</span> <span class="n">frame_state_unused</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* Mark it as ready and enqueue frame */</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">=</span> <span class="n">frame_state_ready</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanstate</span> <span class="o">=</span> <span class="n">scan_state_scanning</span><span class="p">;</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Accumulated in usbvision_parse_data() */</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>

	<span class="cm">/* set v4l2_format index */</span>
	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">vb</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">frame</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">inqueue</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_dqbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_buffer</span> <span class="o">*</span><span class="n">vb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">stream_idle</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span>
			<span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_frame</span><span class="p">,</span>
			 <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">usbvision_frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="n">f</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">=</span> <span class="n">frame_state_unused</span><span class="p">;</span>

	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">memory</span> <span class="o">=</span> <span class="n">V4L2_MEMORY_MMAP</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_BUF_FLAG_MAPPED</span> <span class="o">|</span>
		<span class="n">V4L2_BUF_FLAG_QUEUED</span> <span class="o">|</span>
		<span class="n">V4L2_BUF_FLAG_DONE</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">sequence</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">timestamp</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>
	<span class="n">vb</span><span class="o">-&gt;</span><span class="n">bytesused</span> <span class="o">=</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">scanlength</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamon</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">stream_on</span><span class="p">;</span>
	<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_streamoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">enum</span> <span class="n">v4l2_buf_type</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">stream_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision_stream_interrupt</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="cm">/* Stop all video streamings */</span>
		<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usbvision_empty_framequeues</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_enum_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_fmtdesc</span> <span class="o">*</span><span class="n">vfd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">USBVISION_SUPPORTED_PALETTES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">description</span><span class="p">,</span> <span class="n">usbvision_v4l2_format</span><span class="p">[</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">desc</span><span class="p">);</span>
	<span class="n">vfd</span><span class="o">-&gt;</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">usbvision_v4l2_format</span><span class="p">[</span><span class="n">vfd</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">format</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_g_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">vf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curwidth</span><span class="p">;</span>
	<span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curheight</span><span class="p">;</span>
	<span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">format</span><span class="p">;</span>
	<span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curwidth</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">curheight</span><span class="p">;</span>
	<span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">colorspace</span> <span class="o">=</span> <span class="n">V4L2_COLORSPACE_SMPTE170M</span><span class="p">;</span>
	<span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">field</span> <span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span> <span class="cm">/* Always progressive image */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_try_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">vf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">format_idx</span><span class="p">;</span>

	<span class="cm">/* Find requested format in available ones */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">format_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">format_idx</span> <span class="o">&lt;</span> <span class="n">USBVISION_SUPPORTED_PALETTES</span><span class="p">;</span> <span class="n">format_idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">pixelformat</span> <span class="o">==</span>
		   <span class="n">usbvision_v4l2_format</span><span class="p">[</span><span class="n">format_idx</span><span class="p">].</span><span class="n">format</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">palette</span> <span class="o">=</span> <span class="n">usbvision_v4l2_format</span><span class="p">[</span><span class="n">format_idx</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* robustness */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">format_idx</span> <span class="o">==</span> <span class="n">USBVISION_SUPPORTED_PALETTES</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="n">RESTRICT_TO_RANGE</span><span class="p">(</span><span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">MIN_FRAME_WIDTH</span><span class="p">,</span> <span class="n">MAX_FRAME_WIDTH</span><span class="p">);</span>
	<span class="n">RESTRICT_TO_RANGE</span><span class="p">(</span><span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">MIN_FRAME_HEIGHT</span><span class="p">,</span> <span class="n">MAX_FRAME_HEIGHT</span><span class="p">);</span>

	<span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span> <span class="o">=</span> <span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="o">*</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">.</span><span class="n">bytes_per_pixel</span><span class="p">;</span>
	<span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">sizeimage</span> <span class="o">=</span> <span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">bytesperline</span><span class="o">*</span><span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">vidioc_s_fmt_vid_cap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_format</span> <span class="o">*</span><span class="n">vf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">vidioc_try_fmt_vid_cap</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">priv</span><span class="p">,</span> <span class="n">vf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* stop io in case it is already in progress */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">stream_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">usbvision_stream_interrupt</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usbvision_frames_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_empty_framequeues</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">cur_frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* by now we are committed to the new data... */</span>
	<span class="n">usbvision_set_output</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">vf</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">.</span><span class="n">pix</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">usbvision_v4l2_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
		      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">noblock</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">lock_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usbvision_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;%s: %ld bytes, noblock=%d&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">count</span><span class="p">,</span> <span class="n">noblock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="cm">/* This entry point is compatible with the mmap routines</span>
<span class="cm">	   so that a user can do either VIDIOC_QBUF/VIDIOC_DQBUF</span>
<span class="cm">	   to get frames or call read on the device. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* First, allocate some frames to work with</span>
<span class="cm">		   if this has not been done with VIDIOC_REQBUF */</span>
		<span class="n">usbvision_frames_free</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="n">usbvision_empty_framequeues</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="n">usbvision_frames_alloc</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_NUMFRAMES</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">!=</span> <span class="n">stream_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* no stream is running, make it running ! */</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">stream_on</span><span class="p">;</span>
		<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">video</span><span class="p">,</span> <span class="n">s_stream</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Then, enqueue as many frames as possible</span>
<span class="cm">	   (like a user of VIDIOC_QBUF would do) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">==</span> <span class="n">frame_state_unused</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Mark it as ready and enqueue frame */</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">=</span> <span class="n">frame_state_ready</span><span class="p">;</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanstate</span> <span class="o">=</span> <span class="n">scan_state_scanning</span><span class="p">;</span>
			<span class="cm">/* Accumulated in usbvision_parse_data() */</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanlength</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* set v4l2_format index */</span>
			<span class="n">frame</span><span class="o">-&gt;</span><span class="n">v4l2_format</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">palette</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">inqueue</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span>
					       <span class="n">lock_flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Then try to steal a frame (like a VIDIOC_DQBUF would do) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">noblock</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span>
			<span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_frame</span><span class="p">,</span>
			 <span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">)));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>
	<span class="n">frame</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">usbvision_frame</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">outqueue</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">queue_lock</span><span class="p">,</span> <span class="n">lock_flags</span><span class="p">);</span>

	<span class="cm">/* An error returns an empty frame */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">==</span> <span class="n">frame_state_error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;%s: frmx=%d, bytes_read=%ld, scanlength=%ld&quot;</span><span class="p">,</span>
	       <span class="n">__func__</span><span class="p">,</span>
	       <span class="n">frame</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">bytes_read</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanlength</span><span class="p">);</span>

	<span class="cm">/* copy bytes to user space; we allow for partials reads */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">+</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">bytes_read</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanlength</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">scanlength</span> <span class="o">-</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">bytes_read</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">bytes_read</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">frame</span><span class="o">-&gt;</span><span class="n">bytes_read</span> <span class="o">+=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;%s: {copy} count used=%ld, new bytes_read=%ld&quot;</span><span class="p">,</span>
	       <span class="n">__func__</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">count</span><span class="p">,</span> <span class="n">frame</span><span class="o">-&gt;</span><span class="n">bytes_read</span><span class="p">);</span>

	<span class="cm">/* For now, forget the frame if it has not been read in one shot. */</span>
<span class="cm">/*	if (frame-&gt;bytes_read &gt;= frame-&gt;scanlength) {*/</span> <span class="cm">/* All data has been read */</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">bytes_read</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Mark it as available to be used again. */</span>
		<span class="n">frame</span><span class="o">-&gt;</span><span class="n">grabstate</span> <span class="o">=</span> <span class="n">frame_state_unused</span><span class="p">;</span>
<span class="cm">/*	} */</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_v4l2_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">,</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">pos</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_MMAP</span><span class="p">,</span> <span class="s">&quot;mmap&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USBVISION_IS_OPERATIONAL</span><span class="p">(</span><span class="n">usbvision</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_WRITE</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">size</span> <span class="o">!=</span> <span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(((</span><span class="n">PAGE_ALIGN</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">max_frame_size</span><span class="p">)</span><span class="o">*</span><span class="n">i</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">)</span> <span class="o">==</span>
		    <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_pgoff</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_frames</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_MMAP</span><span class="p">,</span>
		       <span class="s">&quot;mmap: user supplied mapping address is out of range&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* VM_IO is eventually going to replace PageReserved altogether */</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_IO</span><span class="p">;</span>
	<span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">|=</span> <span class="n">VM_RESERVED</span><span class="p">;</span>	<span class="cm">/* avoid to swap out this VMA */</span>

	<span class="n">pos</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">vm_insert_page</span><span class="p">(</span><span class="n">vma</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">vmalloc_to_page</span><span class="p">(</span><span class="n">pos</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_MMAP</span><span class="p">,</span> <span class="s">&quot;mmap: vm_insert_page failed&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">start</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Here comes the stuff for radio on usbvision based devices</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_radio_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;%s:&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: Someone tried to open an already opened USBVision Radio!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="n">err_code</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power_on_at_open</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usbvision_reset_power_off_timer</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">usbvision_power_on</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
				<span class="n">usbvision_i2c_register</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Alternate interface 1 is is the biggest frame size */</span>
		<span class="n">err_code</span> <span class="o">=</span> <span class="n">usbvision_set_alternate</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">last_error</span> <span class="o">=</span> <span class="n">err_code</span><span class="p">;</span>
			<span class="n">err_code</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* If so far no errors then we shall start the radio */</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">call_all</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">tuner</span><span class="p">,</span> <span class="n">s_radio</span><span class="p">);</span>
		<span class="n">usbvision_set_audio</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span> <span class="n">USBVISION_AUDIO_RADIO</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">power_on_at_open</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">usbvision_i2c_unregister</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="n">usbvision_power_off</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">usbvision_radio_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">video_drvdata</span><span class="p">(</span><span class="n">file</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/* Set packet size to 0 */</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">iface_alt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_set_interface</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">iface</span><span class="p">,</span>
				    <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">iface_alt</span><span class="p">);</span>

	<span class="n">usbvision_audio_off</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="o">--</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_on_at_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision_set_power_off_timer</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">remove_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Final disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">usbvision_release</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Video registration stuff */</span>

<span class="cm">/* Video template */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">usbvision_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>             <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">usbvision_v4l2_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">usbvision_v4l2_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">usbvision_v4l2_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">usbvision_v4l2_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
<span class="cm">/*	.poll		= video_poll, */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">usbvision_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>      <span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_fmt_vid_cap</span>  <span class="o">=</span> <span class="n">vidioc_enum_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_fmt_vid_cap</span>     <span class="o">=</span> <span class="n">vidioc_g_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_try_fmt_vid_cap</span>   <span class="o">=</span> <span class="n">vidioc_try_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_fmt_vid_cap</span>     <span class="o">=</span> <span class="n">vidioc_s_fmt_vid_cap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_reqbufs</span>       <span class="o">=</span> <span class="n">vidioc_reqbufs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_querybuf</span>      <span class="o">=</span> <span class="n">vidioc_querybuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_qbuf</span>          <span class="o">=</span> <span class="n">vidioc_qbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_dqbuf</span>         <span class="o">=</span> <span class="n">vidioc_dqbuf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_std</span>         <span class="o">=</span> <span class="n">vidioc_s_std</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>    <span class="o">=</span> <span class="n">vidioc_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>       <span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>       <span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>     <span class="o">=</span> <span class="n">vidioc_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audio</span>       <span class="o">=</span> <span class="n">vidioc_g_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audio</span>       <span class="o">=</span> <span class="n">vidioc_s_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>        <span class="o">=</span> <span class="n">vidioc_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>        <span class="o">=</span> <span class="n">vidioc_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamon</span>      <span class="o">=</span> <span class="n">vidioc_streamon</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_streamoff</span>     <span class="o">=</span> <span class="n">vidioc_streamoff</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>       <span class="o">=</span> <span class="n">vidioc_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>       <span class="o">=</span> <span class="n">vidioc_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span>   <span class="o">=</span> <span class="n">vidioc_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>   <span class="o">=</span> <span class="n">vidioc_s_frequency</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_VIDEO_ADV_DEBUG</span>
	<span class="p">.</span><span class="n">vidioc_g_register</span>    <span class="o">=</span> <span class="n">vidioc_g_register</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_register</span>    <span class="o">=</span> <span class="n">vidioc_s_register</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">usbvision_video_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision_ioctl_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>           <span class="o">=</span> <span class="s">&quot;usbvision-video&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">video_device_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tvnorms</span>        <span class="o">=</span> <span class="n">USBVISION_NORMS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">current_norm</span>   <span class="o">=</span> <span class="n">V4L2_STD_PAL</span>
<span class="p">};</span>


<span class="cm">/* Radio template */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_file_operations</span> <span class="n">usbvision_radio_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>             <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">usbvision_radio_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">usbvision_radio_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">video_ioctl2</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ioctl_ops</span> <span class="n">usbvision_radio_ioctl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">vidioc_querycap</span>      <span class="o">=</span> <span class="n">vidioc_querycap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_enum_input</span>    <span class="o">=</span> <span class="n">vidioc_enum_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_input</span>       <span class="o">=</span> <span class="n">vidioc_g_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_input</span>       <span class="o">=</span> <span class="n">vidioc_s_input</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_queryctrl</span>     <span class="o">=</span> <span class="n">vidioc_queryctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_audio</span>       <span class="o">=</span> <span class="n">vidioc_g_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_audio</span>       <span class="o">=</span> <span class="n">vidioc_s_audio</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_ctrl</span>        <span class="o">=</span> <span class="n">vidioc_g_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_ctrl</span>        <span class="o">=</span> <span class="n">vidioc_s_ctrl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_tuner</span>       <span class="o">=</span> <span class="n">vidioc_g_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_tuner</span>       <span class="o">=</span> <span class="n">vidioc_s_tuner</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_g_frequency</span>   <span class="o">=</span> <span class="n">vidioc_g_frequency</span><span class="p">,</span>
	<span class="p">.</span><span class="n">vidioc_s_frequency</span>   <span class="o">=</span> <span class="n">vidioc_s_frequency</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="n">usbvision_radio_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision_radio_fops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;usbvision-radio&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">video_device_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ioctl_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision_radio_ioctl_ops</span><span class="p">,</span>

	<span class="p">.</span><span class="n">tvnorms</span>              <span class="o">=</span> <span class="n">USBVISION_NORMS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">current_norm</span>         <span class="o">=</span> <span class="n">V4L2_STD_PAL</span>
<span class="p">};</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="nf">usbvision_vdev_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev_template</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">usb_dev</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">video_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usb_dev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;%s: usbvision-&gt;dev is not set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">vdev</span> <span class="o">=</span> <span class="n">video_device_alloc</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="nb">NULL</span> <span class="o">==</span> <span class="n">vdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="o">*</span><span class="n">vdev_template</span><span class="p">;</span>
	<span class="cm">/* Locking in file operations other than ioctl should be done</span>
<span class="cm">	   by the driver, not the V4L2 core.</span>
<span class="cm">	   This driver needs auditing so that this flag can be removed. */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">V4L2_FL_LOCK_ALL_FOPS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">;</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">video_set_drvdata</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">usbvision</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">vdev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* unregister video4linux devices */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_unregister_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Radio Device: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;unregister %s [v4l2]&quot;</span><span class="p">,</span>
		       <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">))</span>
			<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Video Device: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;unregister %s [v4l2]&quot;</span><span class="p">,</span>
		       <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_is_registered</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">))</span>
			<span class="n">video_unregister_device</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">video_device_release</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* register video4linux devices */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">usbvision_register_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Video Device: */</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">usbvision_vdev_init</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">usbvision_video_template</span><span class="p">,</span>
					      <span class="s">&quot;USBVision Video&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">,</span> <span class="n">VFL_TYPE_GRABBER</span><span class="p">,</span> <span class="n">video_nr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;USBVision[%d]: registered USBVision Video device %s [v4l2]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">));</span>

	<span class="cm">/* Radio Device: */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">radio</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* usbvision has radio */</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">=</span> <span class="n">usbvision_vdev_init</span><span class="p">(</span><span class="n">usbvision</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">usbvision_radio_template</span><span class="p">,</span>
						      <span class="s">&quot;USBVision Radio&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">video_register_device</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">,</span> <span class="n">VFL_TYPE_RADIO</span><span class="p">,</span> <span class="n">radio_nr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_exit</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;USBVision[%d]: registered USBVision Radio device %s [v4l2]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">video_device_node_name</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">rdev</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* all done */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">err_exit:</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;USBVision[%d]: video_register_device() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
	<span class="n">usbvision_unregister_video</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_alloc()</span>
<span class="cm"> *</span>
<span class="cm"> * This code allocates the struct usb_usbvision.</span>
<span class="cm"> * It is filled with default values.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns NULL on error, a pointer to usb_usbvision else.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="nf">usbvision_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">;</span>

	<span class="n">usbvision</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v4l2_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>

	<span class="cm">/* prepare control urb for control messages during interrupts */</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span> <span class="o">=</span> <span class="n">usb_alloc_urb</span><span class="p">(</span><span class="n">USBVISION_URB_FRAMES</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unreg</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb_wq</span><span class="p">);</span>

	<span class="n">usbvision_init_power_off_timer</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">usbvision</span><span class="p">;</span>

<span class="nl">err_unreg:</span>
	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
<span class="nl">err_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_release()</span>
<span class="cm"> *</span>
<span class="cm"> * This code does final release of struct usb_usbvision. This happens</span>
<span class="cm"> * after the device is disconnected -and- all clients closed their files.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">usbvision_reset_power_off_timer</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">usbvision_remove_sysfs</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
	<span class="n">usbvision_unregister_video</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">usb_free_urb</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctrl_urb</span><span class="p">);</span>

	<span class="n">v4l2_device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*********************** usb interface **********************************/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">usbvision_configure_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">model</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">model</span> <span class="o">=</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">palette</span> <span class="o">=</span> <span class="n">usbvision_v4l2_format</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span> <span class="cm">/* V4L2_PIX_FMT_RGB24; */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">vin_reg2_override</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vin_reg2_preset</span> <span class="o">=</span>
			<span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span><span class="p">].</span><span class="n">vin_reg2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vin_reg2_preset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">tvnorm_id</span> <span class="o">=</span> <span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">video_norm</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">video_inputs</span> <span class="o">=</span> <span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">video_channels</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">ctl_input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* This should be here to make i2c clients to be able to register */</span>
	<span class="cm">/* first switch off audio */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">audio_channels</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usbvision_audio_off</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">power_on_at_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* and then power up the noisy tuner */</span>
		<span class="n">usbvision_power_on</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="n">usbvision_i2c_register</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_probe()</span>
<span class="cm"> *</span>
<span class="cm"> * This procedure queries device descriptor and accepts the interface</span>
<span class="cm"> * if it looks like USBVISION video device</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">usbvision_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">usb_get_dev</span><span class="p">(</span><span class="n">interface_to_usbdev</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">uif</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">ifnum</span> <span class="o">=</span> <span class="n">intf</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="o">-&gt;</span><span class="n">desc</span><span class="p">.</span><span class="n">bInterfaceNumber</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_host_interface</span> <span class="o">*</span><span class="n">interface</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">usb_endpoint_descriptor</span> <span class="o">*</span><span class="n">endpoint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">model</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;VID=%#04x, PID=%#04x, ifnum=%u&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idVendor</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">idProduct</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">);</span>

	<span class="n">model</span> <span class="o">=</span> <span class="n">devid</span><span class="o">-&gt;</span><span class="n">driver_info</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">model</span> <span class="o">&gt;=</span> <span class="n">usbvision_device_data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;model out of bounds %d&quot;</span><span class="p">,</span> <span class="n">model</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">model_string</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">interface</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">interface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">interface</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="n">interface</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="n">ifnum</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">endpoint</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">interface</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">usb_endpoint_xfer_isoc</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: interface %d. has non-ISO endpoint!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Endpoint attributes %d&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bmAttributes</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usb_endpoint_dir_out</span><span class="p">(</span><span class="n">endpoint</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: interface %d. has ISO OUT endpoint!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">__func__</span><span class="p">,</span> <span class="n">ifnum</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usbvision</span> <span class="o">=</span> <span class="n">usbvision_alloc</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: couldn&#39;t allocate USBVision struct</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">bNumConfigurations</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">bridge_type</span> <span class="o">=</span> <span class="n">BRIDGE_NT1004</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">model</span> <span class="o">==</span> <span class="n">DAZZLE_DVC_90_REV_1_SECAM</span><span class="p">)</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">bridge_type</span> <span class="o">=</span> <span class="n">BRIDGE_NT1005</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">bridge_type</span> <span class="o">=</span> <span class="n">BRIDGE_NT1003</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;bridge_type %d&quot;</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">bridge_type</span><span class="p">);</span>

	<span class="cm">/* compute alternate max packet sizes */</span>
	<span class="n">uif</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">actconfig</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_alt</span> <span class="o">=</span> <span class="n">uif</span><span class="o">-&gt;</span><span class="n">num_altsetting</span><span class="p">;</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;Alternate settings: %i&quot;</span><span class="p">,</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_alt</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">32</span> <span class="o">*</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_alt</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intf</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;usbvision: out of memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">num_alt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">uif</span><span class="o">-&gt;</span><span class="n">altsetting</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">endpoint</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">desc</span><span class="p">.</span>
				      <span class="n">wMaxPacketSize</span><span class="p">);</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x07ff</span><span class="p">)</span> <span class="o">*</span> <span class="p">(((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x1800</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;Alternate setting %i, max size= %i&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
		       <span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">alt_max_pkt_size</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>


	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">usbvision_nr</span><span class="o">++</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">have_tuner</span> <span class="o">=</span> <span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">tuner</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">have_tuner</span><span class="p">)</span>
		<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">tuner_type</span> <span class="o">=</span> <span class="n">usbvision_device_data</span><span class="p">[</span><span class="n">model</span><span class="p">].</span><span class="n">tuner_type</span><span class="p">;</span>

	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev_model</span> <span class="o">=</span> <span class="n">model</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">remove_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">iface</span> <span class="o">=</span> <span class="n">ifnum</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">iface_alt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">video_endp</span> <span class="o">=</span> <span class="n">endpoint</span><span class="o">-&gt;</span><span class="n">bEndpointAddress</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">isoc_packet_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">usb_bandwidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">stream_off</span><span class="p">;</span>
	<span class="n">usbvision_configure_video</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="n">usbvision_register_video</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">usbvision_create_sysfs</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * usbvision_disconnect()</span>
<span class="cm"> *</span>
<span class="cm"> * This procedure stops all driver activity, deallocates interface-private</span>
<span class="cm"> * structure (pointed by &#39;ptr&#39;) and after that driver should be removable</span>
<span class="cm"> * with no ill consequences.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">usbvision_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usb_usbvision</span> <span class="o">*</span><span class="n">usbvision</span> <span class="o">=</span> <span class="n">to_usbvision</span><span class="p">(</span><span class="n">usb_get_intfdata</span><span class="p">(</span><span class="n">intf</span><span class="p">));</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: usb_get_intfdata() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>

	<span class="cm">/* At this time we ask to cancel outstanding URBs */</span>
	<span class="n">usbvision_stop_isoc</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>

	<span class="n">v4l2_device_disconnect</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">usbvision_i2c_unregister</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
		<span class="n">usbvision_power_off</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">remove_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Now all ISO data will be ignored */</span>

	<span class="n">usb_put_dev</span><span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* USB device is no more */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">v4l2_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">user</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: In use, disconnect pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_frame</span><span class="p">);</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision</span><span class="o">-&gt;</span><span class="n">wait_stream</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">usbvision_release</span><span class="p">(</span><span class="n">usbvision</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">usbvision_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;usbvision&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">usbvision_table</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">usbvision_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">usbvision_disconnect</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * usbvision_init()</span>
<span class="cm"> *</span>
<span class="cm"> * This code is run to initialize the driver.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">usbvision_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err_code</span><span class="p">;</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_IO</span><span class="p">,</span>  <span class="s">&quot;IO      debugging is enabled [video]&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;PROBE   debugging is enabled [video]&quot;</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_MMAP</span><span class="p">,</span> <span class="s">&quot;MMAP    debugging is enabled [video]&quot;</span><span class="p">);</span>

	<span class="cm">/* disable planar mode support unless compression enabled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">isoc_mode</span> <span class="o">!=</span> <span class="n">ISOC_MODE_COMPRESS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* FIXME : not the right way to set supported flag */</span>
		<span class="n">usbvision_v4l2_format</span><span class="p">[</span><span class="mi">6</span><span class="p">].</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* V4L2_PIX_FMT_YVU420 */</span>
		<span class="n">usbvision_v4l2_format</span><span class="p">[</span><span class="mi">7</span><span class="p">].</span><span class="n">supported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* V4L2_PIX_FMT_YUV422P */</span>
	<span class="p">}</span>

	<span class="n">err_code</span> <span class="o">=</span> <span class="n">usb_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision_driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err_code</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="n">DRIVER_DESC</span> <span class="s">&quot; : &quot;</span> <span class="n">USBVISION_VERSION_STRING</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">err_code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">usbvision_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">usb_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">usbvision_driver</span><span class="p">);</span>
	<span class="n">PDEBUG</span><span class="p">(</span><span class="n">DBG_PROBE</span><span class="p">,</span> <span class="s">&quot;success&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">usbvision_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">usbvision_exit</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Overrides for Emacs so that we follow Linus&#39;s tabbing style.</span>
<span class="cm"> * ---------------------------------------------------------------------------</span>
<span class="cm"> * Local variables:</span>
<span class="cm"> * c-basic-offset: 8</span>
<span class="cm"> * End:</span>
<span class="cm"> */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
