<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › msp3400-kthreads.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>msp3400-kthreads.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Programming the mspx4xx sound processor family</span>
<span class="cm"> *</span>
<span class="cm"> * (c) 1997-2001 Gerd Knorr &lt;kraxel@bytesex.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation; either version 2</span>
<span class="cm"> * of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-common.h&gt;</span>
<span class="cp">#include &lt;media/msp3400.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/suspend.h&gt;</span>
<span class="cp">#include &quot;msp3400-driver.h&quot;</span>

<span class="cm">/* this one uses the automatic sound standard detection of newer msp34xx</span>
<span class="cm">   chip versions */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">main</span><span class="p">,</span> <span class="n">second</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">v4l2_std_id</span> <span class="n">std</span><span class="p">;</span>
<span class="p">}</span> <span class="n">msp_stdlist</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;could not detect sound standard&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;autodetect start&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0002</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">4.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">4.72</span><span class="p">),</span>
	  <span class="s">&quot;4.5/4.72  M Dual FM-Stereo&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_MN</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.7421875</span><span class="p">),</span>
	  <span class="s">&quot;5.5/5.74  B/G Dual FM-Stereo&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_BG</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0004</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.2578125</span><span class="p">),</span>
	  <span class="s">&quot;6.5/6.25  D/K1 Dual FM-Stereo&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_DK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.7421875</span><span class="p">),</span>
	  <span class="s">&quot;6.5/6.74  D/K2 Dual FM-Stereo&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_DK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span>
	  <span class="s">&quot;6.5  D/K FM-Mono (HDEV3)&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_DK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.7421875</span><span class="p">),</span>
	  <span class="s">&quot;6.5/5.74  D/K3 Dual FM-Stereo&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_DK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.85</span><span class="p">),</span>
	  <span class="s">&quot;5.5/5.85  B/G NICAM FM&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_BG</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.85</span><span class="p">),</span>
	  <span class="s">&quot;6.5/5.85  L NICAM AM&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_L</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.0</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.55</span><span class="p">),</span>
	  <span class="s">&quot;6.0/6.55  I NICAM FM&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_PAL_I</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000b</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.85</span><span class="p">),</span>
	  <span class="s">&quot;6.5/5.85  D/K NICAM FM&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_DK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.85</span><span class="p">),</span>
	  <span class="s">&quot;6.5/5.85  D/K NICAM FM (HDEV2)&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_DK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.85</span><span class="p">),</span>
	  <span class="s">&quot;6.5/5.85  D/K NICAM FM (HDEV3)&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_DK</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">4.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">4.5</span><span class="p">),</span>
	  <span class="s">&quot;4.5  M BTSC-Stereo&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_MTS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0021</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">4.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">4.5</span><span class="p">),</span>
	  <span class="s">&quot;4.5  M BTSC-Mono + SAP&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_MTS</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">4.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">4.5</span><span class="p">),</span>
	  <span class="s">&quot;4.5  M EIA-J Japan Stereo&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_NTSC_M_JP</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">10.7</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">10.7</span><span class="p">),</span>
	  <span class="s">&quot;10.7  FM-Stereo Radio&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0050</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span>
	  <span class="s">&quot;6.5  SAT-Mono&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.02</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.20</span><span class="p">),</span>
	  <span class="s">&quot;7.02/7.20  SAT-Stereo&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.2</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.2</span><span class="p">),</span>
	  <span class="s">&quot;7.2  SAT ADR&quot;</span><span class="p">,</span> <span class="n">V4L2_STD_ALL</span> <span class="p">},</span>
	<span class="p">{</span>     <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span> <span class="cm">/* EOF */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msp3400c_init_data_dem</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">fir1</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">fir2</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">cdo1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cdo2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ad_cv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode_reg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsp_src</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dsp_matrix</span><span class="p">;</span>
<span class="p">}</span> <span class="n">msp3400c_init_data</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>	<span class="cm">/* AM (for carrier detect / msp3400) */</span>
		<span class="p">{</span><span class="mi">75</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">75</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">},</span>
		<span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span>
		<span class="mh">0x00d0</span><span class="p">,</span> <span class="mh">0x0500</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x3000</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* AM (for carrier detect / msp3410) */</span>
		<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">126</span><span class="p">},</span>
		<span class="p">{</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">126</span><span class="p">},</span>
		<span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span>
		<span class="mh">0x00d0</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x3000</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* FM Radio */</span>
		<span class="p">{</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">107</span><span class="p">},</span>
		<span class="p">{</span><span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">107</span><span class="p">},</span>
		<span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">10.7</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">10.7</span><span class="p">),</span>
		<span class="mh">0x00d0</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x3000</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* Terrestrial FM-mono + FM-stereo */</span>
		<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">72</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">72</span><span class="p">},</span>
		<span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span>
		<span class="mh">0x00d0</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x3000</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* Sat FM-mono */</span>
		<span class="p">{</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">37</span><span class="p">},</span>
		<span class="p">{</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">72</span><span class="p">},</span>
		<span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span>
		<span class="mh">0x00c6</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">,</span> <span class="mh">0x3000</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* NICAM/FM --  B/G (5.5/5.85), D/K (6.5/5.85) */</span>
		<span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">86</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">72</span><span class="p">},</span>
		<span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span>
		<span class="mh">0x00d0</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="mh">0x0120</span><span class="p">,</span> <span class="mh">0x3000</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* NICAM/FM -- I (6.0/6.552) */</span>
		<span class="p">{</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">6</span><span class="p">,</span> <span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">94</span><span class="p">},</span>
		<span class="p">{</span><span class="mi">3</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">72</span><span class="p">},</span>
		<span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.0</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.0</span><span class="p">),</span>
		<span class="mh">0x00d0</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">,</span> <span class="mh">0x0120</span><span class="p">,</span> <span class="mh">0x3000</span>
	<span class="p">},</span> <span class="p">{</span>	<span class="cm">/* NICAM/AM -- L (6.5/5.85) */</span>
		<span class="p">{</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">86</span><span class="p">},</span>
		<span class="p">{</span><span class="o">-</span><span class="mi">4</span><span class="p">,</span> <span class="o">-</span><span class="mi">12</span><span class="p">,</span> <span class="o">-</span><span class="mi">9</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">126</span><span class="p">},</span>
		<span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span>
		<span class="mh">0x00c6</span><span class="p">,</span> <span class="mh">0x0140</span><span class="p">,</span> <span class="mh">0x0120</span><span class="p">,</span> <span class="mh">0x7c00</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">msp3400c_carrier_detect</span> <span class="p">{</span>
	<span class="kt">int</span>   <span class="n">cdo</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msp3400c_carrier_detect</span> <span class="n">msp3400c_carrier_detect_main</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* main carrier */</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">4.5</span><span class="p">),</span>        <span class="s">&quot;4.5   NTSC&quot;</span>                   <span class="p">},</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.5</span><span class="p">),</span>        <span class="s">&quot;5.5   PAL B/G&quot;</span>                <span class="p">},</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.0</span><span class="p">),</span>        <span class="s">&quot;6.0   PAL I&quot;</span>                  <span class="p">},</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span>        <span class="s">&quot;6.5   PAL D/K + SAT + SECAM&quot;</span>  <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msp3400c_carrier_detect</span> <span class="n">msp3400c_carrier_detect_55</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* PAL B/G */</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.7421875</span><span class="p">),</span>  <span class="s">&quot;5.742 PAL B/G FM-stereo&quot;</span>     <span class="p">},</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.85</span><span class="p">),</span>       <span class="s">&quot;5.85  PAL B/G NICAM&quot;</span>         <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">msp3400c_carrier_detect</span> <span class="n">msp3400c_carrier_detect_65</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* PAL SAT / SECAM */</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">5.85</span><span class="p">),</span>       <span class="s">&quot;5.85  PAL D/K + SECAM NICAM&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.2578125</span><span class="p">),</span>  <span class="s">&quot;6.25  PAL D/K1 FM-stereo&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.7421875</span><span class="p">),</span>  <span class="s">&quot;6.74  PAL D/K2 FM-stereo&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.02</span><span class="p">),</span>       <span class="s">&quot;7.02  PAL SAT FM-stereo s/b&quot;</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.20</span><span class="p">),</span>       <span class="s">&quot;7.20  PAL SAT FM-stereo s&quot;</span>   <span class="p">},</span>
	<span class="p">{</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.38</span><span class="p">),</span>       <span class="s">&quot;7.38  PAL SAT FM-stereo b&quot;</span>   <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* ------------------------------------------------------------------------ */</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">msp_standard_std_name</span><span class="p">(</span><span class="kt">int</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">retval</span> <span class="o">==</span> <span class="n">std</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
	<span class="k">return</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">v4l2_std_id</span> <span class="nf">msp_standard_std</span><span class="p">(</span><span class="kt">int</span> <span class="n">std</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">retval</span> <span class="o">==</span> <span class="n">std</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">std</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">V4L2_STD_ALL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msp_set_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">src</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msp_dolby</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="mh">0x0520</span><span class="p">);</span> <span class="cm">/* I2S1 */</span>
		<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x0620</span><span class="p">);</span> <span class="cm">/* I2S2 */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
		<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">has_scart2_out</span><span class="p">)</span>
		<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0041</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">msp3400c_set_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cdo1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cdo2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0093</span><span class="p">,</span> <span class="n">cdo1</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x009b</span><span class="p">,</span> <span class="n">cdo1</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x00a3</span><span class="p">,</span> <span class="n">cdo2</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">);</span>
	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x00ab</span><span class="p">,</span> <span class="n">cdo2</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0056</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span> <span class="cm">/* LOAD_REG_1/2 */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">msp3400c_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">msp3400c_init_data_dem</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msp3400c_init_data</span><span class="p">[</span><span class="n">mode</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">tuner</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">route_in</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;set_mode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>

	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x00bb</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">ad_cv</span> <span class="o">|</span> <span class="p">(</span><span class="n">tuner</span> <span class="o">?</span> <span class="mh">0x100</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>               <span class="cm">/* fir 1 */</span>
		<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fir1</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x0004</span><span class="p">);</span> <span class="cm">/* fir 2 */</span>
	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
		<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">fir2</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0083</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">mode_reg</span><span class="p">);</span>

	<span class="n">msp3400c_set_carrier</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cdo1</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">cdo2</span><span class="p">);</span>

	<span class="n">msp_set_source</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dsp_src</span><span class="p">);</span>
	<span class="cm">/* set prescales */</span>

	<span class="cm">/* volume prescale for SCART (AM mono input) */</span>
	<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000d</span><span class="p">,</span> <span class="mh">0x1900</span><span class="p">);</span>
	<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">dsp_matrix</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">has_nicam</span><span class="p">)</span> <span class="cm">/* nicam prescale */</span>
		<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span> <span class="mh">0x5a00</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set audio mode. Note that the pre-&#39;G&#39; models do not support BTSC+SAP,</span>
<span class="cm">   nor do they support stereo BTSC. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msp3400c_set_audmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">strmode</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="s">&quot;mono&quot;</span><span class="p">,</span> <span class="s">&quot;stereo&quot;</span><span class="p">,</span> <span class="s">&quot;lang2&quot;</span><span class="p">,</span> <span class="s">&quot;lang1&quot;</span><span class="p">,</span> <span class="s">&quot;lang1+lang2&quot;</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">modestr</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">strmode</span><span class="p">[</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">]</span> <span class="o">:</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">src</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* channel source: FM/AM, nicam or SCART */</span>
	<span class="kt">int</span> <span class="n">audmode</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">opmode</span> <span class="o">==</span> <span class="n">OPMODE_AUTOSELECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this method would break everything, let&#39;s make sure</span>
<span class="cm">		 * it&#39;s never called</span>
<span class="cm">		 */</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;set_audmode called with mode=%d instead of set_source (ignored)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Note: for the C and D revs no NTSC stereo + SAP is possible as</span>
<span class="cm">	   the hardware does not support SAP. So the rxsubchans combination</span>
<span class="cm">	   of STEREO | LANG2 does not occur. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">MSP_MODE_EXTERN</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* switch to mono if only mono is available */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">==</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">)</span>
			<span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">;</span>
		<span class="cm">/* if bilingual */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* and mono or stereo, then fallback to lang1 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">audmode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_MODE_MONO</span> <span class="o">||</span>
			    <span class="n">audmode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">)</span>
				<span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_LANG1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* if stereo, and audmode is not mono, then switch to stereo */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">audmode</span> <span class="o">!=</span> <span class="n">V4L2_TUNER_MODE_MONO</span><span class="p">)</span>
			<span class="n">audmode</span> <span class="o">=</span> <span class="n">V4L2_TUNER_MODE_STEREO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* switch demodulator */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSP_MODE_FM_TERRA</span>:
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;FM set_audmode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">modestr</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">audmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
			<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="mh">0x3001</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span>:
			<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000e</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSP_MODE_FM_SAT</span>:
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;SAT set_audmode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">modestr</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">audmode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
			<span class="n">msp3400c_set_carrier</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.5</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span>:
			<span class="n">msp3400c_set_carrier</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.2</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.02</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
			<span class="n">msp3400c_set_carrier</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.38</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.02</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
			<span class="n">msp3400c_set_carrier</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.38</span><span class="p">),</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">7.02</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSP_MODE_FM_NICAM1</span>:
	<span class="k">case</span> <span class="n">MSP_MODE_FM_NICAM2</span>:
	<span class="k">case</span> <span class="n">MSP_MODE_AM_NICAM</span>:
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;NICAM set_audmode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">modestr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span><span class="p">)</span>
			<span class="n">src</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">;</span>  <span class="cm">/* NICAM */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSP_MODE_BTSC</span>:
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;BTSC set_audmode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">modestr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSP_MODE_EXTERN</span>:
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;extern set_audmode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">modestr</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span>  <span class="cm">/* SCART */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSP_MODE_FM_RADIO</span>:
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;FM-Radio set_audmode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">modestr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;mono set_audmode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* switch audio */</span>
	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;set audmode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">audmode</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">audmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span>:
		<span class="n">src</span> <span class="o">|=</span> <span class="mh">0x0020</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MSP_MODE_AM_NICAM</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;switching to AM mono</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* AM mono decoding is handled by tuner, not MSP chip */</span>
			<span class="cm">/* SCART switching control register */</span>
			<span class="n">msp_set_scart</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">SCART_MONO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">src</span> <span class="o">=</span> <span class="mh">0x0200</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">)</span>
			<span class="n">src</span> <span class="o">=</span> <span class="mh">0x0030</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
		<span class="n">src</span> <span class="o">|=</span> <span class="mh">0x0010</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
		<span class="s">&quot;set_audmode final source/matrix = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>

	<span class="n">msp_set_source</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">src</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msp3400c_print_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">main</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;mono sound carrier: %d.%03d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">main</span> <span class="o">/</span> <span class="mi">910000</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">main</span> <span class="o">/</span> <span class="mi">910</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;main sound carrier: %d.%03d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">main</span> <span class="o">/</span> <span class="mi">910000</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">main</span> <span class="o">/</span> <span class="mi">910</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MSP_MODE_FM_NICAM1</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MSP_MODE_FM_NICAM2</span><span class="p">)</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;NICAM/FM carrier  : %d.%03d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">/</span> <span class="mi">910000</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">/</span><span class="mi">910</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MSP_MODE_AM_NICAM</span><span class="p">)</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;NICAM/AM carrier  : %d.%03d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">/</span> <span class="mi">910000</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">/</span> <span class="mi">910</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MSP_MODE_FM_TERRA</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">main</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;FM-stereo carrier : %d.%03d MHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">/</span> <span class="mi">910000</span><span class="p">,</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">/</span> <span class="mi">910</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msp3400c_detect_stereo</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">newnicam</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">MSP_MODE_FM_TERRA</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">msp_read_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="mi">65536</span><span class="p">;</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;stereo detect register: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">8192</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">newnicam</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">MSP_MODE_FM_NICAM1</span>:
	<span class="k">case</span> <span class="n">MSP_MODE_FM_NICAM2</span>:
	<span class="k">case</span> <span class="n">MSP_MODE_AM_NICAM</span>:
		<span class="n">val</span> <span class="o">=</span> <span class="n">msp_read_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">);</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;nicam sync=%d, mode=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* nicam synced */</span>
			<span class="k">switch</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span>  <span class="p">{</span>
			<span class="k">case</span> <span class="mi">0</span>:
			<span class="k">case</span> <span class="mi">8</span>:
				<span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">case</span> <span class="mi">9</span>:
				<span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">case</span> <span class="mi">10</span>:
				<span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">newnicam</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">newnicam</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxsubchans</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;watch: rxsubchans %02x =&gt; %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span><span class="p">,</span> <span class="n">rxsubchans</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">rxsubchans</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newnicam</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;watch: nicam %d =&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span><span class="p">,</span> <span class="n">newnicam</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span> <span class="o">=</span> <span class="n">newnicam</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">update</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * A kernel thread for msp3400 control -- we don&#39;t want to block the</span>
<span class="cm"> * in the ioctl while doing the sound carrier &amp; stereo detect</span>
<span class="cm"> */</span>
<span class="cm">/* stereo/multilang monitoring */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">watch_stereo</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msp_detect_stereo</span><span class="p">(</span><span class="n">client</span><span class="p">))</span>
		<span class="n">msp_set_audmode</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msp_once</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">msp3400c_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">msp3400c_carrier_detect</span> <span class="o">*</span><span class="n">cd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">max1</span><span class="p">,</span> <span class="n">max2</span><span class="p">,</span> <span class="n">val1</span><span class="p">,</span> <span class="n">val2</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;msp3400 daemon started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">V4L2_STD_ALL</span><span class="p">;</span>
	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;msp3400 thread: sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;msp3400 thread: wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">restart:</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;thread: restart scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">||</span> <span class="n">MSP_MODE_EXTERN</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no carrier scan, just unmute */</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
				<span class="s">&quot;thread: no carrier scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">scan_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">msp_update_volume</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* mute audio */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">scan_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">msp_update_volume</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="n">msp3400c_set_mode</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_MODE_AM_DETECT</span><span class="p">);</span>
		<span class="n">val1</span> <span class="o">=</span> <span class="n">val2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">max1</span> <span class="o">=</span> <span class="n">max2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* wait for tuner to settle down after a channel change */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>

		<span class="cm">/* carrier detect pass #1 -- main carrier */</span>
		<span class="n">cd</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_main</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msp3400c_carrier_detect_main</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msp_amsound</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">v4l2_std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* autodetect doesn&#39;t work well with AM ... */</span>
			<span class="n">max1</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;AM sound override</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msp3400c_set_carrier</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdo</span><span class="p">,</span> <span class="n">cd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">msp_read_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">-=</span> <span class="mi">65536</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val1</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">)</span>
				<span class="n">val1</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="n">max1</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
				<span class="s">&quot;carrier1 val: %5d / %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* carrier detect pass #2 -- second (stereo) carrier */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">max1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* 5.5 */</span>
			<span class="n">cd</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_55</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msp3400c_carrier_detect_55</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* 6.5 */</span>
			<span class="n">cd</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_65</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msp3400c_carrier_detect_65</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* 4.5 */</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* 6.0 */</span>
		<span class="nl">default:</span>
			<span class="n">cd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msp_amsound</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">v4l2_std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* autodetect doesn&#39;t work well with AM ... */</span>
			<span class="n">cd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">max2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msp3400c_set_carrier</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">cd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdo</span><span class="p">,</span> <span class="n">cd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cdo</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">msp_read_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span>
				<span class="n">val</span> <span class="o">-=</span> <span class="mi">65536</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val2</span> <span class="o">&lt;</span> <span class="n">val</span><span class="p">)</span>
				<span class="n">val2</span> <span class="o">=</span> <span class="n">val</span><span class="p">,</span> <span class="n">max2</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
				<span class="s">&quot;carrier2 val: %5d / %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">cd</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* program the msp3400 according to the results */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">main</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_main</span><span class="p">[</span><span class="n">max1</span><span class="p">].</span><span class="n">cdo</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">max1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>: <span class="cm">/* 5.5 */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">V4L2_STD_BG</span> <span class="o">|</span> <span class="n">V4L2_STD_PAL_H</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* B/G FM-stereo */</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_55</span><span class="p">[</span><span class="n">max2</span><span class="p">].</span><span class="n">cdo</span><span class="p">;</span>
				<span class="n">msp3400c_set_mode</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_MODE_FM_TERRA</span><span class="p">);</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max2</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">has_nicam</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* B/G NICAM */</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_55</span><span class="p">[</span><span class="n">max2</span><span class="p">].</span><span class="n">cdo</span><span class="p">;</span>
				<span class="n">msp3400c_set_mode</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_MODE_FM_NICAM1</span><span class="p">);</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">no_second</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>: <span class="cm">/* 6.0 */</span>
			<span class="cm">/* PAL I NICAM */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">V4L2_STD_PAL_I</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">6.552</span><span class="p">);</span>
			<span class="n">msp3400c_set_mode</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_MODE_FM_NICAM2</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>: <span class="cm">/* 6.5 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">max2</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">max2</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* D/K FM-stereo */</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_65</span><span class="p">[</span><span class="n">max2</span><span class="p">].</span><span class="n">cdo</span><span class="p">;</span>
				<span class="n">msp3400c_set_mode</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_MODE_FM_TERRA</span><span class="p">);</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">V4L2_STD_DK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max2</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">v4l2_std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* L NICAM or AM-mono */</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_65</span><span class="p">[</span><span class="n">max2</span><span class="p">].</span><span class="n">cdo</span><span class="p">;</span>
				<span class="n">msp3400c_set_mode</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_MODE_AM_NICAM</span><span class="p">);</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">V4L2_STD_L</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">max2</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">has_nicam</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* D/K NICAM */</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_65</span><span class="p">[</span><span class="n">max2</span><span class="p">].</span><span class="n">cdo</span><span class="p">;</span>
				<span class="n">msp3400c_set_mode</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_MODE_FM_NICAM1</span><span class="p">);</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">V4L2_STD_DK</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">no_second</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* 4.5 */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">V4L2_STD_MN</span><span class="p">;</span>
		<span class="nl">default:</span>
<span class="nl">no_second:</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">msp3400c_carrier_detect_main</span><span class="p">[</span><span class="n">max1</span><span class="p">].</span><span class="n">cdo</span><span class="p">;</span>
			<span class="n">msp3400c_set_mode</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_MODE_FM_TERRA</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msp3400c_set_carrier</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">main</span><span class="p">);</span>

		<span class="cm">/* unmute */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">scan_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msp3400c_set_audmode</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="n">msp_update_volume</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msp_debug</span><span class="p">)</span>
			<span class="n">msp3400c_print_mode</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

		<span class="cm">/* monitor tv audio mode, the first time don&#39;t wait</span>
<span class="cm">		   so long to get a quick stereo/bilingual result */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">count</span> <span class="o">?</span> <span class="mi">1000</span> <span class="o">:</span> <span class="mi">5000</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
				<span class="n">count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">watch_stereo</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;thread: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="kt">int</span> <span class="nf">msp3410d_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">std</span><span class="p">,</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;msp3410 daemon started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">V4L2_STD_ALL</span><span class="p">;</span>
	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;msp3410 thread: sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;msp3410 thread: wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">restart:</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;thread: restart scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MSP_MODE_EXTERN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no carrier scan needed, just unmute */</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
				<span class="s">&quot;thread: no carrier scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">scan_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">msp_update_volume</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* mute audio */</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">scan_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">msp_update_volume</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/* start autodetect. Note: autodetect is not supported for</span>
<span class="cm">		   NTSC-M and radio, hence we force the standard in those</span>
<span class="cm">		   cases. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span>
			<span class="n">std</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">std</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">v4l2_std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_NTSC</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x20</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* wait for tuner to settle down after a channel change */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">200</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msp_debug</span><span class="p">)</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
				<span class="s">&quot;setting standard: %s (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">msp_standard_std_name</span><span class="p">(</span><span class="n">std</span><span class="p">),</span> <span class="n">std</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">std</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* programmed some specific mode */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">std</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* triggered autodetect */</span>
			<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">std</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>

				<span class="cm">/* check results */</span>
				<span class="n">val</span> <span class="o">=</span> <span class="n">msp_read_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mh">0x07ff</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
					<span class="s">&quot;detection still in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">retval</span> <span class="o">==</span> <span class="n">val</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;current standard: %s (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msp_standard_std_name</span><span class="p">(</span><span class="n">val</span><span class="p">),</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">main</span>   <span class="o">=</span> <span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">main</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">msp_stdlist</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msp_amsound</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">v4l2_std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_SECAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="mh">0x0009</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* autodetection has failed, let backup */</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;autodetection failed,&quot;</span>
				<span class="s">&quot; switching to backup standard: %s (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">msp_stdlist</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">name</span> <span class="o">?</span>
					<span class="n">msp_stdlist</span><span class="p">[</span><span class="mi">8</span><span class="p">].</span><span class="n">name</span> <span class="o">:</span> <span class="s">&quot;unknown&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="mh">0x0009</span><span class="p">;</span>
			<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">msp_standard_std</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* set stereo */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0008</span>: <span class="cm">/* B/G NICAM */</span>
		<span class="k">case</span> <span class="mh">0x000a</span>: <span class="cm">/* I NICAM */</span>
		<span class="k">case</span> <span class="mh">0x000b</span>: <span class="cm">/* D/K NICAM */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="mh">0x000a</span><span class="p">)</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MSP_MODE_FM_NICAM2</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MSP_MODE_FM_NICAM1</span><span class="p">;</span>
			<span class="cm">/* just turn on stereo */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0009</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MSP_MODE_AM_NICAM</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">nicam_on</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0020</span>: <span class="cm">/* BTSC */</span>
			<span class="cm">/* The pre-&#39;G&#39; models only have BTSC-mono */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MSP_MODE_BTSC</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0040</span>: <span class="cm">/* FM radio */</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MSP_MODE_FM_RADIO</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
			<span class="cm">/* not needed in theory if we have radio, but</span>
<span class="cm">			   short programming enables carrier mute */</span>
			<span class="n">msp3400c_set_mode</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_MODE_FM_RADIO</span><span class="p">);</span>
			<span class="n">msp3400c_set_carrier</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">10.7</span><span class="p">),</span>
					    <span class="n">MSP_CARRIER</span><span class="p">(</span><span class="mf">10.7</span><span class="p">));</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x0002</span>:
		<span class="k">case</span> <span class="mh">0x0003</span>:
		<span class="k">case</span> <span class="mh">0x0004</span>:
		<span class="k">case</span> <span class="mh">0x0005</span>:
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">MSP_MODE_FM_TERRA</span><span class="p">;</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* set various prescales */</span>
		<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x1900</span><span class="p">);</span> <span class="cm">/* scart */</span>
		<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">);</span> <span class="cm">/* FM */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">has_nicam</span><span class="p">)</span>
			<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x5a00</span><span class="p">);</span> <span class="cm">/* nicam */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">has_i2s_conf</span><span class="p">)</span>
			<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2s_mode</span><span class="p">);</span>

		<span class="cm">/* unmute */</span>
		<span class="n">msp3400c_set_audmode</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">scan_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">msp_update_volume</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/* monitor tv audio mode, the first time don&#39;t wait</span>
<span class="cm">		   so long to get a quick stereo/bilingual result */</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">count</span> <span class="o">?</span> <span class="mi">1000</span> <span class="o">:</span> <span class="mi">5000</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span>
				<span class="n">count</span><span class="o">--</span><span class="p">;</span>
			<span class="n">watch_stereo</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;thread: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* ----------------------------------------------------------------------- */</span>

<span class="cm">/* msp34xxG + (autoselect no-thread)</span>
<span class="cm"> * this one uses both automatic standard detection and automatic sound</span>
<span class="cm"> * select which are available in the newer G versions</span>
<span class="cm"> * struct msp: only norm, acb and source are really used in this mode</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msp34xxg_modus</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;selected radio modus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">v4l2_std</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC_M_JP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;selected M (EIA-J) modus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0x4001</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">v4l2_std</span> <span class="o">==</span> <span class="n">V4L2_STD_NTSC_M_KR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;selected M (A2) modus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">v4l2_std</span> <span class="o">==</span> <span class="n">V4L2_STD_SECAM_L</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;selected SECAM-L modus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0x6001</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">v4l2_std</span> <span class="o">&amp;</span> <span class="n">V4L2_STD_MN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;selected M (BTSC) modus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mh">0x2001</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mh">0x7001</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msp34xxg_set_source</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u16</span> <span class="n">reg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">in</span><span class="p">)</span>
 <span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">source</span><span class="p">,</span> <span class="n">matrix</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_MONO</span>:
		<span class="n">source</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* mono only */</span>
		<span class="n">matrix</span> <span class="o">=</span> <span class="mh">0x30</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG2</span>:
		<span class="n">source</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span> <span class="cm">/* stereo or B */</span>
		<span class="n">matrix</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span>:
		<span class="n">source</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* stereo or A|B */</span>
		<span class="n">matrix</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_LANG1</span>:
		<span class="n">source</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* stereo or A */</span>
		<span class="n">matrix</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_TUNER_MODE_STEREO</span>:
	<span class="nl">default:</span>
		<span class="n">source</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* stereo or A */</span>
		<span class="n">matrix</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">in</span> <span class="o">==</span> <span class="n">MSP_DSP_IN_TUNER</span><span class="p">)</span>
		<span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="n">source</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="cm">/* the msp34x2g puts the MAIN_AVC, MAIN and AUX sources in 12, 13, 14</span>
<span class="cm">	   instead of 11, 12, 13. So we add one for that msp version. */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;=</span> <span class="n">MSP_DSP_IN_MAIN_AVC</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">has_dolby_pro_logic</span><span class="p">)</span>
		<span class="n">source</span> <span class="o">=</span> <span class="p">((</span><span class="n">in</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">matrix</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">source</span> <span class="o">=</span> <span class="p">(</span><span class="n">in</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">matrix</span><span class="p">;</span>

	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
		<span class="s">&quot;set source to %d (0x%x) for output %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">in</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">source</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msp34xxg_set_sources</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="n">u32</span> <span class="n">in</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">route_in</span><span class="p">;</span>

	<span class="n">msp34xxg_set_source</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0008</span><span class="p">,</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="cm">/* quasi-peak detector is set to same input as the loudspeaker (MAIN) */</span>
	<span class="n">msp34xxg_set_source</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000c</span><span class="p">,</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">msp34xxg_set_source</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">msp34xxg_set_source</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000a</span><span class="p">,</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">has_scart2_out</span><span class="p">)</span>
		<span class="n">msp34xxg_set_source</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0041</span><span class="p">,</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
	<span class="n">msp34xxg_set_source</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x000b</span><span class="p">,</span> <span class="p">(</span><span class="n">in</span> <span class="o">&gt;&gt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* (re-)initialize the msp34xxg */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">msp34xxg_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">tuner</span> <span class="o">=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">route_in</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">modus</span><span class="p">;</span>

	<span class="cm">/* initialize std to 1 (autodetect) to signal that no standard is</span>
<span class="cm">	   selected yet. */</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">msp_reset</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">has_i2s_conf</span><span class="p">)</span>
		<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">i2s_mode</span><span class="p">);</span>

	<span class="cm">/* step-by-step initialisation, as described in the manual */</span>
	<span class="n">modus</span> <span class="o">=</span> <span class="n">msp34xxg_modus</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">modus</span> <span class="o">|=</span> <span class="n">tuner</span> <span class="o">?</span> <span class="mh">0x100</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">,</span> <span class="n">modus</span><span class="p">);</span>

	<span class="cm">/* write the dsps that may have an influence on</span>
<span class="cm">	   standard/audio autodetection right now */</span>
	<span class="n">msp34xxg_set_sources</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x1900</span><span class="p">);</span> <span class="cm">/* scart */</span>
	<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x3000</span><span class="p">);</span> <span class="cm">/* FM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">has_nicam</span><span class="p">)</span>
		<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x5a00</span><span class="p">);</span> <span class="cm">/* nicam */</span>

	<span class="cm">/* set identification threshold. Personally, I</span>
<span class="cm">	 * I set it to a higher value than the default</span>
<span class="cm">	 * of 0x190 to ignore noisy stereo signals.</span>
<span class="cm">	 * this needs tuning. (recommended range 0x00a0-0x03c0)</span>
<span class="cm">	 * 0x7f0 = forced mono mode</span>
<span class="cm">	 *</span>
<span class="cm">	 * a2 threshold for stereo/bilingual.</span>
<span class="cm">	 * Note: this register is part of the Manual/Compatibility mode.</span>
<span class="cm">	 * It is supported by all &#39;G&#39;-family chips.</span>
<span class="cm">	 */</span>
	<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="n">msp_stereo_thresh</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">msp34xxg_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;msp34xxg daemon started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">V4L2_STD_ALL</span><span class="p">;</span>
	<span class="n">set_freezable</span><span class="p">();</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;msp34xxg thread: sleep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;msp34xxg thread: wakeup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">restart:</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;thread: restart scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">restart</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MSP_MODE_EXTERN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no carrier scan needed, just unmute */</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
				<span class="s">&quot;thread: no carrier scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">scan_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">msp_update_volume</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* setup the chip*/</span>
		<span class="n">msp34xxg_reset</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">radio</span> <span class="o">?</span> <span class="mh">0x40</span> <span class="o">:</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">force_btsc</span> <span class="o">&amp;&amp;</span> <span class="n">msp_standard</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">32</span> <span class="o">:</span> <span class="n">msp_standard</span><span class="p">;</span>
		<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>
		<span class="cm">/* start autodetect */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">unmute</span><span class="p">;</span>

		<span class="cm">/* watch autodetect */</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;started autodetect, waiting for result</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>

			<span class="cm">/* check results */</span>
			<span class="n">val</span> <span class="o">=</span> <span class="n">msp_read_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x7e</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mh">0x07ff</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
				<span class="s">&quot;detection still in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
				<span class="s">&quot;detection still in progress after 10 tries. giving up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

<span class="nl">unmute:</span>
		<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
			<span class="s">&quot;detected standard: %s (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msp_standard_std_name</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">),</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">detected_std</span> <span class="o">=</span> <span class="n">msp_standard_std</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* AM NICAM mode */</span>
			<span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x7c00</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* unmute: dispatch sound to scart output, set scart volume */</span>
		<span class="n">msp_update_volume</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/* restore ACB */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msp_write_dsp</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">acb</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* the periodic stereo/SAP check is only relevant for</span>
<span class="cm">		   the 0x20 standard (BTSC) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">!=</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* monitor tv audio mode, the first time don&#39;t wait</span>
<span class="cm">		   in order to get a quick stereo/SAP update */</span>
		<span class="n">watch_stereo</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">watch_stereo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">watch_stereo</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">msp_sleep</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="mi">5000</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="s">&quot;thread: exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">msp34xxg_detect_stereo</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">msp_read_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">is_bilingual</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">is_stereo</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">oldrx</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">MSP_MODE_EXTERN</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_stereo</span><span class="p">)</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_STEREO</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span> <span class="n">V4L2_TUNER_SUB_MONO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_bilingual</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">|=</span> <span class="n">V4L2_TUNER_SUB_SAP</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">=</span>
				<span class="n">V4L2_TUNER_SUB_LANG1</span> <span class="o">|</span> <span class="n">V4L2_TUNER_SUB_LANG2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">v4l_dbg</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">msp_debug</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span>
		<span class="s">&quot;status=0x%x, stereo=%d, bilingual=%d -&gt; rxsubchans=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">status</span><span class="p">,</span> <span class="n">is_stereo</span><span class="p">,</span> <span class="n">is_bilingual</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span><span class="p">);</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">oldrx</span> <span class="o">!=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">msp34xxg_set_audmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">std</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)</span> <span class="p">{</span>
	       <span class="k">if</span> <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">rxsubchans</span> <span class="o">&amp;</span> <span class="n">V4L2_TUNER_SUB_SAP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_MODE_LANG1_LANG2</span> <span class="o">||</span>
		    <span class="n">state</span><span class="o">-&gt;</span><span class="n">audmode</span> <span class="o">==</span> <span class="n">V4L2_TUNER_MODE_LANG2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">);</span>
	       <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">msp_write_dem</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
	       <span class="p">}</span>
	<span class="p">}</span>

	<span class="n">msp34xxg_set_sources</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">msp_set_audmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OPMODE_MANUAL</span>:
	<span class="k">case</span> <span class="n">OPMODE_AUTODETECT</span>:
		<span class="n">msp3400c_set_audmode</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">OPMODE_AUTOSELECT</span>:
		<span class="n">msp34xxg_set_audmode</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">msp_detect_stereo</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">msp_state</span> <span class="o">*</span><span class="n">state</span>  <span class="o">=</span> <span class="n">to_state</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">opmode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OPMODE_MANUAL</span>:
	<span class="k">case</span> <span class="n">OPMODE_AUTODETECT</span>:
		<span class="k">return</span> <span class="n">msp3400c_detect_stereo</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">OPMODE_AUTOSELECT</span>:
		<span class="k">return</span> <span class="n">msp34xxg_detect_stereo</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
