<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › smiapp › smiapp-core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>smiapp-core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/media/video/smiapp/smiapp-core.c</span>
<span class="cm"> *</span>
<span class="cm"> * Generic driver for SMIA/SMIA++ compliant camera modules</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010--2012 Nokia Corporation</span>
<span class="cm"> * Contact: Sakari Ailus &lt;sakari.ailus@maxwell.research.nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Based on smiapp driver by Vimarsh Zutshi</span>
<span class="cm"> * Based on jt8ev1.c by Vimarsh Zutshi</span>
<span class="cm"> * Based on smia-sensor.c by Tuukka Toivonen &lt;tuukkat76@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-device.h&gt;</span>

<span class="cp">#include &quot;smiapp.h&quot;</span>

<span class="cp">#define SMIAPP_ALIGN_DIM(dim, flags)		\</span>
<span class="cp">	((flags) &amp; V4L2_SUBDEV_SEL_FLAG_SIZE_GE	\</span>
<span class="cp">	 ? ALIGN((dim), 2)			\</span>
<span class="cp">	 : (dim) &amp; ~1)</span>

<span class="cm">/*</span>
<span class="cm"> * smiapp_module_idents - supported camera modules</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">smiapp_module_ident</span> <span class="n">smiapp_module_idents</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SMIAPP_IDENT_L</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x022b</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;vs6555&quot;</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_L</span><span class="p">(</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x022e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;vw6558&quot;</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_L</span><span class="p">(</span><span class="mh">0x07</span><span class="p">,</span> <span class="mh">0x7698</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;ovm7698&quot;</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_L</span><span class="p">(</span><span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0x4242</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;smiapp-003&quot;</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_L</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x208a</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;tcm8330md&quot;</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_LQ</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2134</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;tcm8500md&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_tcm8500md_quirk</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_L</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x213e</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;et8en2&quot;</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_L</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x2184</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;tcm8580md&quot;</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_LQ</span><span class="p">(</span><span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x560f</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;jt8ew9&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_jt8ew9_quirk</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_LQ</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x4141</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;jt8ev1&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_jt8ev1_quirk</span><span class="p">),</span>
	<span class="n">SMIAPP_IDENT_LQ</span><span class="p">(</span><span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x4241</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;imx125es&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_imx125es_quirk</span><span class="p">),</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * Dynamic Capability Identification</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_read_frame_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">fmt_model_type</span><span class="p">,</span> <span class="n">fmt_model_subtype</span><span class="p">,</span> <span class="n">ncol_desc</span><span class="p">,</span> <span class="n">nrow_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">line_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">embedded_start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">embedded_end</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">image_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_FRAME_FORMAT_MODEL_TYPE</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">fmt_model_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_FRAME_FORMAT_MODEL_SUBTYPE</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">fmt_model_subtype</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">ncol_desc</span> <span class="o">=</span> <span class="p">(</span><span class="n">fmt_model_subtype</span>
		     <span class="o">&amp;</span> <span class="n">SMIAPP_FRAME_FORMAT_MODEL_SUBTYPE_NCOLS_MASK</span><span class="p">)</span>
		<span class="o">&gt;&gt;</span> <span class="n">SMIAPP_FRAME_FORMAT_MODEL_SUBTYPE_NCOLS_SHIFT</span><span class="p">;</span>
	<span class="n">nrow_desc</span> <span class="o">=</span> <span class="n">fmt_model_subtype</span>
		<span class="o">&amp;</span> <span class="n">SMIAPP_FRAME_FORMAT_MODEL_SUBTYPE_NROWS_MASK</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;format_model_type %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">fmt_model_type</span> <span class="o">==</span> <span class="n">SMIAPP_FRAME_FORMAT_MODEL_TYPE_2BYTE</span>
		<span class="o">?</span> <span class="s">&quot;2 byte&quot;</span> <span class="o">:</span>
		<span class="n">fmt_model_type</span> <span class="o">==</span> <span class="n">SMIAPP_FRAME_FORMAT_MODEL_TYPE_4BYTE</span>
		<span class="o">?</span> <span class="s">&quot;4 byte&quot;</span> <span class="o">:</span> <span class="s">&quot;is simply bad&quot;</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ncol_desc</span> <span class="o">+</span> <span class="n">nrow_desc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">desc</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">pixelcode</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">pixels</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">which</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">what</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fmt_model_type</span> <span class="o">==</span> <span class="n">SMIAPP_FRAME_FORMAT_MODEL_TYPE_2BYTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span>
				<span class="n">sensor</span><span class="p">,</span>
				<span class="n">SMIAPP_REG_U16_FRAME_FORMAT_DESCRIPTOR_2</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

			<span class="n">pixelcode</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">desc</span>
				 <span class="o">&amp;</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_2_PIXELCODE_MASK</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_2_PIXELCODE_SHIFT</span><span class="p">;</span>
			<span class="n">pixels</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">&amp;</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_2_PIXELS_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fmt_model_type</span>
			   <span class="o">==</span> <span class="n">SMIAPP_FRAME_FORMAT_MODEL_TYPE_4BYTE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span>
				<span class="n">sensor</span><span class="p">,</span>
				<span class="n">SMIAPP_REG_U32_FRAME_FORMAT_DESCRIPTOR_4</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
				<span class="o">&amp;</span><span class="n">desc</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

			<span class="n">pixelcode</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">desc</span>
				 <span class="o">&amp;</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_4_PIXELCODE_MASK</span><span class="p">)</span>
				<span class="o">&gt;&gt;</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_4_PIXELCODE_SHIFT</span><span class="p">;</span>
			<span class="n">pixels</span> <span class="o">=</span> <span class="n">desc</span> <span class="o">&amp;</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_4_PIXELS_MASK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;invalid frame format model type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">fmt_model_type</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ncol_desc</span><span class="p">)</span>
			<span class="n">which</span> <span class="o">=</span> <span class="s">&quot;columns&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">which</span> <span class="o">=</span> <span class="s">&quot;rows&quot;</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">pixelcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_PIXELCODE_EMBEDDED</span>:
			<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;embedded&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_PIXELCODE_DUMMY</span>:
			<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;dummy&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_PIXELCODE_BLACK</span>:
			<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;black&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_PIXELCODE_DARK</span>:
			<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;dark&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_PIXELCODE_VISIBLE</span>:
			<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;visible&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">what</span> <span class="o">=</span> <span class="s">&quot;invalid&quot;</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pixelcode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixelcode</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s pixels: %d %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">what</span><span class="p">,</span> <span class="n">pixels</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">ncol_desc</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="cm">/* Handle row descriptors */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pixelcode</span>
		    <span class="o">==</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_PIXELCODE_EMBEDDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">embedded_start</span> <span class="o">=</span> <span class="n">line_count</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pixelcode</span> <span class="o">==</span> <span class="n">SMIAPP_FRAME_FORMAT_DESC_PIXELCODE_VISIBLE</span>
			    <span class="o">||</span> <span class="n">pixels</span> <span class="o">&gt;=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_FRAME_LENGTH_LINES</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">image_start</span> <span class="o">=</span> <span class="n">line_count</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">embedded_start</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">embedded_end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">embedded_end</span> <span class="o">=</span> <span class="n">line_count</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">line_count</span> <span class="o">+=</span> <span class="n">pixels</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">embedded_start</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">embedded_end</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">embedded_start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">embedded_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;embedded data from lines %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">embedded_start</span><span class="p">,</span> <span class="n">embedded_end</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;image data starts at line %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">image_start</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_pll_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_pll</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_VT_PIX_CLK_DIV</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vt_pix_clk_div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_VT_SYS_CLK_DIV</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vt_sys_clk_div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_PRE_PLL_CLK_DIV</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pre_pll_clk_div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_PLL_MULTIPLIER</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pll_multiplier</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="cm">/* Lane op clock ratio does not apply here. */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U32_REQUESTED_LINK_BIT_RATE_MBPS</span><span class="p">,</span>
		<span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">pll</span><span class="o">-&gt;</span><span class="n">op_sys_clk_freq_hz</span><span class="p">,</span> <span class="mi">1000000</span> <span class="o">/</span> <span class="mi">256</span> <span class="o">/</span> <span class="mi">256</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">.</span><span class="n">smiapp_profile</span> <span class="o">==</span> <span class="n">SMIAPP_PROFILE_0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_OP_PIX_CLK_DIV</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">op_pix_clk_div</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_OP_SYS_CLK_DIV</span><span class="p">,</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">op_sys_clk_div</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_pll_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_pll_limits</span> <span class="n">lim</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">min_pre_pll_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_PRE_PLL_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_pre_pll_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_PRE_PLL_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_pll_ip_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_PLL_IP_FREQ_HZ</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_pll_ip_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_PLL_IP_FREQ_HZ</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_pll_multiplier</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_PLL_MULTIPLIER</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_pll_multiplier</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_PLL_MULTIPLIER</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_pll_op_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_PLL_OP_FREQ_HZ</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_pll_op_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_PLL_OP_FREQ_HZ</span><span class="p">],</span>

		<span class="p">.</span><span class="n">min_op_sys_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_OP_SYS_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_op_sys_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_OP_SYS_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_op_pix_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_OP_PIX_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_op_pix_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_OP_PIX_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_op_sys_clk_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_OP_SYS_CLK_FREQ_HZ</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_op_sys_clk_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_OP_SYS_CLK_FREQ_HZ</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_op_pix_clk_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_OP_PIX_CLK_FREQ_HZ</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_op_pix_clk_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_OP_PIX_CLK_FREQ_HZ</span><span class="p">],</span>

		<span class="p">.</span><span class="n">min_vt_sys_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_VT_SYS_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_vt_sys_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_VT_SYS_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_vt_pix_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_VT_PIX_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_vt_pix_clk_div</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_VT_PIX_CLK_DIV</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_vt_sys_clk_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_VT_SYS_CLK_FREQ_HZ</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_vt_sys_clk_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_VT_SYS_CLK_FREQ_HZ</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_vt_pix_clk_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_VT_PIX_CLK_FREQ_HZ</span><span class="p">],</span>
		<span class="p">.</span><span class="n">max_vt_pix_clk_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_VT_PIX_CLK_FREQ_HZ</span><span class="p">],</span>

		<span class="p">.</span><span class="n">min_line_length_pck_bin</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_LINE_LENGTH_PCK_BIN</span><span class="p">],</span>
		<span class="p">.</span><span class="n">min_line_length_pck</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_LINE_LENGTH_PCK</span><span class="p">],</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">smiapp_pll</span> <span class="o">*</span><span class="n">pll</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">));</span>

	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">lanes</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">lanes</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">ext_clk_freq_hz</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">.</span><span class="n">smiapp_profile</span> <span class="o">==</span> <span class="n">SMIAPP_PROFILE_0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Fill in operational clock divisors limits from the</span>
<span class="cm">		 * video timing ones. On profile 0 sensors the</span>
<span class="cm">		 * requirements regarding them are essentially the</span>
<span class="cm">		 * same as on VT ones.</span>
<span class="cm">		 */</span>
		<span class="n">lim</span><span class="p">.</span><span class="n">min_op_sys_clk_div</span> <span class="o">=</span> <span class="n">lim</span><span class="p">.</span><span class="n">min_vt_sys_clk_div</span><span class="p">;</span>
		<span class="n">lim</span><span class="p">.</span><span class="n">max_op_sys_clk_div</span> <span class="o">=</span> <span class="n">lim</span><span class="p">.</span><span class="n">max_vt_sys_clk_div</span><span class="p">;</span>
		<span class="n">lim</span><span class="p">.</span><span class="n">min_op_pix_clk_div</span> <span class="o">=</span> <span class="n">lim</span><span class="p">.</span><span class="n">min_vt_pix_clk_div</span><span class="p">;</span>
		<span class="n">lim</span><span class="p">.</span><span class="n">max_op_pix_clk_div</span> <span class="o">=</span> <span class="n">lim</span><span class="p">.</span><span class="n">max_vt_pix_clk_div</span><span class="p">;</span>
		<span class="n">lim</span><span class="p">.</span><span class="n">min_op_sys_clk_freq_hz</span> <span class="o">=</span> <span class="n">lim</span><span class="p">.</span><span class="n">min_vt_sys_clk_freq_hz</span><span class="p">;</span>
		<span class="n">lim</span><span class="p">.</span><span class="n">max_op_sys_clk_freq_hz</span> <span class="o">=</span> <span class="n">lim</span><span class="p">.</span><span class="n">max_vt_sys_clk_freq_hz</span><span class="p">;</span>
		<span class="n">lim</span><span class="p">.</span><span class="n">min_op_pix_clk_freq_hz</span> <span class="o">=</span> <span class="n">lim</span><span class="p">.</span><span class="n">min_vt_pix_clk_freq_hz</span><span class="p">;</span>
		<span class="n">lim</span><span class="p">.</span><span class="n">max_op_pix_clk_freq_hz</span> <span class="o">=</span> <span class="n">lim</span><span class="p">.</span><span class="n">max_vt_pix_clk_freq_hz</span><span class="p">;</span>
		<span class="cm">/* Profile 0 sensors have no separate OP clock branch. */</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SMIAPP_PLL_FLAG_NO_OP_CLOCKS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">smiapp_needs_quirk</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
			       <span class="n">SMIAPP_QUIRK_FLAG_OP_PIX_CLOCK_PER_LANE</span><span class="p">))</span>
		<span class="n">pll</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SMIAPP_PLL_FLAG_OP_PIX_CLOCK_PER_LANE</span><span class="p">;</span>

	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">binning_horizontal</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_horizontal</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">binning_vertical</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_vertical</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">link_freq</span> <span class="o">=</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">link_freq</span><span class="o">-&gt;</span><span class="n">qmenu_int</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">link_freq</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">];</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">scale_m</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scale_m</span><span class="p">;</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">scale_n</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">];</span>
	<span class="n">pll</span><span class="o">-&gt;</span><span class="n">bits_per_pixel</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span><span class="o">-&gt;</span><span class="n">compressed</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_pll_calculate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lim</span><span class="p">,</span> <span class="n">pll</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_rate_parray</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val64</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">vt_pix_clk_freq_hz</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_rate_csi</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val64</span> <span class="o">=</span> <span class="n">pll</span><span class="o">-&gt;</span><span class="n">pixel_rate_csi</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * V4L2 Controls handling</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__smiapp_update_exposure_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span><span class="p">;</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">height</span>
		<span class="o">+</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="o">-&gt;</span><span class="n">val</span>
		<span class="o">-</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_COARSE_INTEGRATION_TIME_MAX_MARGIN</span><span class="p">];</span>

	<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span> <span class="o">&gt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Order matters.</span>
<span class="cm"> *</span>
<span class="cm"> * 1. Bits-per-pixel, descending.</span>
<span class="cm"> * 2. Bits-per-pixel compressed, descending.</span>
<span class="cm"> * 3. Pixel order, same as in pixel_order_str. Formats for all four pixel</span>
<span class="cm"> *    orders must be defined.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">smiapp_csi_data_format</span> <span class="n">smiapp_csi_data_formats</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SGRBG12_1X12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_GRBG</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SRGGB12_1X12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_RGGB</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SBGGR12_1X12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_BGGR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SGBRG12_1X12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_GBRG</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_1X10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_GRBG</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SRGGB10_1X10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_RGGB</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_1X10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_BGGR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SGBRG10_1X10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_GBRG</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SGRBG10_DPCM8_1X8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_GRBG</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SRGGB10_DPCM8_1X8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_RGGB</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SBGGR10_DPCM8_1X8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_BGGR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SGBRG10_DPCM8_1X8</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_GBRG</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SGRBG8_1X8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_GRBG</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SRGGB8_1X8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_RGGB</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SBGGR8_1X8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_BGGR</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="n">V4L2_MBUS_FMT_SGBRG8_1X8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">SMIAPP_PIXEL_ORDER_GBRG</span><span class="p">,</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pixel_order_str</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;GRBG&quot;</span><span class="p">,</span> <span class="s">&quot;RGGB&quot;</span><span class="p">,</span> <span class="s">&quot;BGGR&quot;</span><span class="p">,</span> <span class="s">&quot;GBRG&quot;</span> <span class="p">};</span>

<span class="cp">#define to_csi_format_idx(fmt) (((unsigned long)(fmt)			\</span>
<span class="cp">				 - (unsigned long)smiapp_csi_data_formats) \</span>
<span class="cp">				/ sizeof(*smiapp_csi_data_formats))</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">smiapp_pixel_order</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">flip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hflip</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hflip</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">flip</span> <span class="o">|=</span> <span class="n">SMIAPP_IMAGE_ORIENTATION_HFLIP</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vflip</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">flip</span> <span class="o">|=</span> <span class="n">SMIAPP_IMAGE_ORIENTATION_VFLIP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">flip</span> <span class="o">^=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hvflip_inv_mask</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;flip %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">default_pixel_order</span> <span class="o">^</span> <span class="n">flip</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smiapp_update_mbus_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">csi_format_idx</span> <span class="o">=</span>
		<span class="n">to_csi_format_idx</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">internal_csi_format_idx</span> <span class="o">=</span>
		<span class="n">to_csi_format_idx</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">internal_csi_format</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pixel_order</span> <span class="o">=</span> <span class="n">smiapp_pixel_order</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mbus_frame_fmts</span> <span class="o">=</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">default_mbus_frame_fmts</span> <span class="o">&lt;&lt;</span> <span class="n">pixel_order</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">smiapp_csi_data_formats</span><span class="p">[</span><span class="n">csi_format_idx</span> <span class="o">+</span> <span class="n">pixel_order</span><span class="p">];</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">internal_csi_format</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">smiapp_csi_data_formats</span><span class="p">[</span><span class="n">internal_csi_format_idx</span>
					 <span class="o">+</span> <span class="n">pixel_order</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="n">internal_csi_format_idx</span><span class="p">,</span> <span class="n">csi_format_idx</span><span class="p">)</span> <span class="o">+</span> <span class="n">pixel_order</span>
	       <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smiapp_csi_data_formats</span><span class="p">));</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">min</span><span class="p">(</span><span class="n">internal_csi_format_idx</span><span class="p">,</span> <span class="n">csi_format_idx</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;new pixel order %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">pixel_order_str</span><span class="p">[</span><span class="n">pixel_order</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_set_ctrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">ctrl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="k">struct</span> <span class="n">smiapp_subdev</span><span class="p">,</span> <span class="n">ctrl_handler</span><span class="p">)</span>
			<span class="o">-&gt;</span><span class="n">sensor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">orient</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exposure</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_CID_ANALOGUE_GAIN</span>:
		<span class="k">return</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span>
			<span class="n">SMIAPP_REG_U16_ANALOGUE_GAIN_CODE_GLOBAL</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">V4L2_CID_EXPOSURE</span>:
		<span class="k">return</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span>
			<span class="n">SMIAPP_REG_U16_COARSE_INTEGRATION_TIME</span><span class="p">,</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">V4L2_CID_HFLIP</span>:
	<span class="k">case</span> <span class="n">V4L2_CID_VFLIP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hflip</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">orient</span> <span class="o">|=</span> <span class="n">SMIAPP_IMAGE_ORIENTATION_HFLIP</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vflip</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span>
			<span class="n">orient</span> <span class="o">|=</span> <span class="n">SMIAPP_IMAGE_ORIENTATION_VFLIP</span><span class="p">;</span>

		<span class="n">orient</span> <span class="o">^=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hvflip_inv_mask</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
				    <span class="n">SMIAPP_REG_U8_IMAGE_ORIENTATION</span><span class="p">,</span>
				    <span class="n">orient</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

		<span class="n">smiapp_update_mbus_formats</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">V4L2_CID_VBLANK</span>:
		<span class="n">exposure</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>

		<span class="n">__smiapp_update_exposure_limits</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">exposure</span> <span class="o">&gt;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">;</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_set_ctrl</span><span class="p">(</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">exposure</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_FRAME_LENGTH_LINES</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">height</span>
			<span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">V4L2_CID_HBLANK</span>:
		<span class="k">return</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_LINE_LENGTH_PCK</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">width</span>
			<span class="o">+</span> <span class="n">ctrl</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">V4L2_CID_LINK_FREQ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">smiapp_pll_update</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_ctrl_ops</span> <span class="n">smiapp_ctrl_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_ctrl</span> <span class="o">=</span> <span class="n">smiapp_set_ctrl</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_init_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">;</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">analog_gain</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ctrl_ops</span><span class="p">,</span>
		<span class="n">V4L2_CID_ANALOGUE_GAIN</span><span class="p">,</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_ANALOGUE_GAIN_CODE_MIN</span><span class="p">],</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_ANALOGUE_GAIN_CODE_MAX</span><span class="p">],</span>
		<span class="n">max</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_ANALOGUE_GAIN_CODE_STEP</span><span class="p">],</span> <span class="mi">1U</span><span class="p">),</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_ANALOGUE_GAIN_CODE_MIN</span><span class="p">]);</span>

	<span class="cm">/* Exposure limits will be updated soon, use just something here. */</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">exposure</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ctrl_ops</span><span class="p">,</span>
		<span class="n">V4L2_CID_EXPOSURE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hflip</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ctrl_ops</span><span class="p">,</span>
		<span class="n">V4L2_CID_HFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vflip</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ctrl_ops</span><span class="p">,</span>
		<span class="n">V4L2_CID_VFLIP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vblank</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ctrl_ops</span><span class="p">,</span>
		<span class="n">V4L2_CID_VBLANK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">)</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_UPDATE</span><span class="p">;</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hblank</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ctrl_ops</span><span class="p">,</span>
		<span class="n">V4L2_CID_HBLANK</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">)</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_CTRL_FLAG_UPDATE</span><span class="p">;</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_rate_parray</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ctrl_ops</span><span class="p">,</span>
		<span class="n">V4L2_CID_PIXEL_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pixel array controls initialization failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">;</span>

	<span class="n">v4l2_ctrl_cluster</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hflip</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_handler_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">lock</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">max</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">op_sys_clock</span><span class="p">[</span><span class="n">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span> <span class="n">max</span><span class="o">++</span><span class="p">);</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">link_freq</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_int_menu</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ctrl_ops</span><span class="p">,</span>
		<span class="n">V4L2_CID_LINK_FREQ</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">op_sys_clock</span><span class="p">);</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_rate_csi</span> <span class="o">=</span> <span class="n">v4l2_ctrl_new_std</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ctrl_ops</span><span class="p">,</span>
		<span class="n">V4L2_CID_PIXEL_RATE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;src controls initialization failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">);</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">.</span><span class="n">error</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">ctrl_handler</span> <span class="o">=</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smiapp_free_controls</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">v4l2_ctrl_handler_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ctrl_handler</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_get_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span> <span class="kt">int</span> <span class="k">const</span> <span class="o">*</span><span class="n">limit</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span> <span class="n">smiapp_reg_limits</span><span class="p">[</span><span class="n">limit</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">limit</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;0x%8.8x </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> = %d, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smiapp_reg_limits</span><span class="p">[</span><span class="n">limit</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">addr</span><span class="p">,</span>
			<span class="n">smiapp_reg_limits</span><span class="p">[</span><span class="n">limit</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">what</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_get_all_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SMIAPP_LIMIT_LAST</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_get_limits</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">smiapp_replace_limit</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_get_limits_binning</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="k">const</span> <span class="n">limits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">SMIAPP_LIMIT_MIN_FRAME_LENGTH_LINES_BIN</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_MAX_FRAME_LENGTH_LINES_BIN</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_MIN_LINE_LENGTH_PCK_BIN</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_MAX_LINE_LENGTH_PCK_BIN</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_MIN_LINE_BLANKING_PCK_BIN</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_FINE_INTEGRATION_TIME_MIN_BIN</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_FINE_INTEGRATION_TIME_MAX_MARGIN_BIN</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">static</span> <span class="n">u32</span> <span class="k">const</span> <span class="n">limits_replace</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">SMIAPP_LIMIT_MIN_FRAME_LENGTH_LINES</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_MAX_FRAME_LENGTH_LINES</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_MIN_LINE_LENGTH_PCK</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_MAX_LINE_LENGTH_PCK</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_MIN_LINE_BLANKING_PCK</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_FINE_INTEGRATION_TIME_MIN</span><span class="p">,</span>
		<span class="n">SMIAPP_LIMIT_FINE_INTEGRATION_TIME_MAX_MARGIN</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_BINNING_CAPABILITY</span><span class="p">]</span> <span class="o">==</span>
	    <span class="n">SMIAPP_BINNING_CAPABILITY_NO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">limits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">limits_replace</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_get_limits</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">limits</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">limits</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Sanity check whether the binning limits are valid. If not,</span>
<span class="cm">	 * use the non-binning ones.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_FRAME_LENGTH_LINES_BIN</span><span class="p">]</span>
	    <span class="o">&amp;&amp;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_LINE_LENGTH_PCK_BIN</span><span class="p">]</span>
	    <span class="o">&amp;&amp;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_LINE_BLANKING_PCK_BIN</span><span class="p">])</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">limits</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;replace limit 0x%8.8x </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> = %d, 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">smiapp_reg_limits</span><span class="p">[</span><span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">addr</span><span class="p">,</span>
			<span class="n">smiapp_reg_limits</span><span class="p">[</span><span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">]].</span><span class="n">what</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">limits_replace</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">limits_replace</span><span class="p">[</span><span class="n">i</span><span class="p">]]);</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">limits</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span> <span class="o">=</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">limits_replace</span><span class="p">[</span><span class="n">i</span><span class="p">]];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_get_mbus_formats</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">pixel_order</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_DATA_FORMAT_MODEL_TYPE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;data_format_model_type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_PIXEL_ORDER</span><span class="p">,</span>
			   <span class="o">&amp;</span><span class="n">pixel_order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pixel_order</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">pixel_order_str</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad pixel order %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixel_order</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pixel order %d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pixel_order</span><span class="p">,</span>
		<span class="n">pixel_order_str</span><span class="p">[</span><span class="n">pixel_order</span><span class="p">]);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SMIAPP_DATA_FORMAT_MODEL_TYPE_NORMAL</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">SMIAPP_DATA_FORMAT_MODEL_TYPE_NORMAL_N</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SMIAPP_DATA_FORMAT_MODEL_TYPE_EXTENDED</span>:
		<span class="n">n</span> <span class="o">=</span> <span class="n">SMIAPP_DATA_FORMAT_MODEL_TYPE_EXTENDED_N</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">default_pixel_order</span> <span class="o">=</span> <span class="n">pixel_order</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mbus_frame_fmts</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fmt</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span>
			<span class="n">SMIAPP_REG_U16_DATA_FORMAT_DESCRIPTOR</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">fmt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bpp %d, compressed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">fmt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">fmt</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smiapp_csi_data_formats</span><span class="p">);</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">smiapp_csi_data_format</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span>
				<span class="o">&amp;</span><span class="n">smiapp_csi_data_formats</span><span class="p">[</span><span class="n">j</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">pixel_order</span> <span class="o">!=</span> <span class="n">SMIAPP_PIXEL_ORDER_GRBG</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">f</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">!=</span> <span class="n">fmt</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span> <span class="o">||</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">compressed</span> <span class="o">!=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">fmt</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;jolly good! %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">j</span><span class="p">);</span>

			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">default_mbus_frame_fmts</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">internal_csi_format</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;no supported mbus code found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">smiapp_update_mbus_formats</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smiapp_update_blanking</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">vblank</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">v4l2_ctrl</span> <span class="o">*</span><span class="n">hblank</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="p">;</span>

	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span>
		<span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_FRAME_BLANKING_LINES</span><span class="p">],</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_FRAME_LENGTH_LINES_BIN</span><span class="p">]</span> <span class="o">-</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_FRAME_LENGTH_LINES_BIN</span><span class="p">]</span> <span class="o">-</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">height</span><span class="p">;</span>

	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">vblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span>
			      <span class="n">vblank</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">,</span> <span class="n">vblank</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">);</span>
	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">vblank</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">;</span>
	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">vblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
	<span class="n">vblank</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">vblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>

	<span class="n">hblank</span><span class="o">-&gt;</span><span class="n">minimum</span> <span class="o">=</span>
		<span class="n">max_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_LINE_LENGTH_PCK_BIN</span><span class="p">]</span> <span class="o">-</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">width</span><span class="p">,</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_LINE_BLANKING_PCK_BIN</span><span class="p">]);</span>
	<span class="n">hblank</span><span class="o">-&gt;</span><span class="n">maximum</span> <span class="o">=</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_LINE_LENGTH_PCK_BIN</span><span class="p">]</span> <span class="o">-</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">width</span><span class="p">;</span>

	<span class="n">hblank</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">clamp_t</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="n">hblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">,</span>
			      <span class="n">hblank</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">,</span> <span class="n">hblank</span><span class="o">-&gt;</span><span class="n">maximum</span><span class="p">);</span>
	<span class="n">hblank</span><span class="o">-&gt;</span><span class="n">default_value</span> <span class="o">=</span> <span class="n">hblank</span><span class="o">-&gt;</span><span class="n">minimum</span><span class="p">;</span>
	<span class="n">hblank</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">hblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>
	<span class="n">hblank</span><span class="o">-&gt;</span><span class="n">cur</span><span class="p">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">hblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">;</span>

	<span class="n">__smiapp_update_exposure_limits</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_update_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">binning_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;frame size: %dx%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PAD_SRC</span><span class="p">].</span><span class="n">width</span><span class="p">,</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PAD_SRC</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;csi format width: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>

	<span class="cm">/* Binning has to be set up here; it affects limits */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_horizontal</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_vertical</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">binning_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">binning_type</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_horizontal</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="o">|</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_vertical</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_BINNING_TYPE</span><span class="p">,</span> <span class="n">binning_type</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

		<span class="n">binning_mode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_BINNING_MODE</span><span class="p">,</span> <span class="n">binning_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="cm">/* Get updated limits due to binning */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_get_limits_binning</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_pll_update</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="cm">/* Output from pixel array, including blanking */</span>
	<span class="n">smiapp_update_blanking</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vblank</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;hblank</span><span class="se">\t\t</span><span class="s">%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;real timeperframe</span><span class="se">\t</span><span class="s">100/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pll</span><span class="p">.</span><span class="n">vt_pix_clk_freq_hz</span> <span class="o">/</span>
		<span class="p">((</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">width</span>
		  <span class="o">+</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="o">*</span>
		 <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">height</span>
		  <span class="o">+</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vblank</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * SMIA++ NVM handling</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_read_nvm</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span>
			   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nvm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">np</span><span class="p">,</span> <span class="n">v</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rval2</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm_size</span> <span class="o">/</span> <span class="n">SMIAPP_NVM_PAGE_SIZE</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span> <span class="o">&lt;</span> <span class="n">np</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span>
			<span class="n">SMIAPP_REG_U8_DATA_TRANSFER_IF_1_PAGE_SELECT</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
				    <span class="n">SMIAPP_REG_U8_DATA_TRANSFER_IF_1_CTRL</span><span class="p">,</span>
				    <span class="n">SMIAPP_DATA_TRANSFER_IF_1_CTRL_EN</span> <span class="o">|</span>
				    <span class="n">SMIAPP_DATA_TRANSFER_IF_1_CTRL_RD_EN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span>
				<span class="n">sensor</span><span class="p">,</span>
				<span class="n">SMIAPP_REG_U8_DATA_TRANSFER_IF_1_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">s</span> <span class="o">&amp;</span> <span class="n">SMIAPP_DATA_TRANSFER_IF_1_STATUS_RD_READY</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SMIAPP_NVM_PAGE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span>
				<span class="n">sensor</span><span class="p">,</span>
				<span class="n">SMIAPP_REG_U8_DATA_TRANSFER_IF_1_DATA_0</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">v</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="o">*</span><span class="n">nvm</span><span class="o">++</span> <span class="o">=</span> <span class="n">v</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">rval2</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_DATA_TRANSFER_IF_1_CTRL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">rval2</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * SMIA++ CCI address control</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_change_cci_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">i2c_addr_dfl</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
			    <span class="n">SMIAPP_REG_U8_CCI_ADDRESS_CONTROL</span><span class="p">,</span>
			    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">i2c_addr_alt</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">i2c_addr_alt</span><span class="p">;</span>

	<span class="cm">/* verify addr change went ok */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_CCI_ADDRESS_CONTROL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">i2c_addr_alt</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> * SMIA++ Mode Control</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_setup_flash_strobe</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_flash_strobe_parms</span> <span class="o">*</span><span class="n">strobe_setup</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ext_freq</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">strobe_adjustment</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">strobe_width_high_rs</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">strobe_setup</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">strobe_setup</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * How to calculate registers related to strobe length. Please</span>
<span class="cm">	 * do not change, or if you do at least know what you&#39;re</span>
<span class="cm">	 * doing. :-)</span>
<span class="cm">	 *</span>
<span class="cm">	 * Sakari Ailus &lt;sakari.ailus@maxwell.research.nokia.com&gt; 2010-10-25</span>
<span class="cm">	 *</span>
<span class="cm">	 * flash_strobe_length [us] / 10^6 = (tFlash_strobe_width_ctrl</span>
<span class="cm">	 *	/ EXTCLK freq [Hz]) * flash_strobe_adjustment</span>
<span class="cm">	 *</span>
<span class="cm">	 * tFlash_strobe_width_ctrl E N, [1 - 0xffff]</span>
<span class="cm">	 * flash_strobe_adjustment E N, [1 - 0xff]</span>
<span class="cm">	 *</span>
<span class="cm">	 * The formula above is written as below to keep it on one</span>
<span class="cm">	 * line:</span>
<span class="cm">	 *</span>
<span class="cm">	 * l / 10^6 = w / e * a</span>
<span class="cm">	 *</span>
<span class="cm">	 * Let&#39;s mark w * a by x:</span>
<span class="cm">	 *</span>
<span class="cm">	 * x = w * a</span>
<span class="cm">	 *</span>
<span class="cm">	 * Thus, we get:</span>
<span class="cm">	 *</span>
<span class="cm">	 * x = l * e / 10^6</span>
<span class="cm">	 *</span>
<span class="cm">	 * The strobe width must be at least as long as requested,</span>
<span class="cm">	 * thus rounding upwards is needed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * x = (l * e + 10^6 - 1) / 10^6</span>
<span class="cm">	 * -----------------------------</span>
<span class="cm">	 *</span>
<span class="cm">	 * Maximum possible accuracy is wanted at all times. Thus keep</span>
<span class="cm">	 * a as small as possible.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Calculate a, assuming maximum w, with rounding upwards:</span>
<span class="cm">	 *</span>
<span class="cm">	 * a = (x + (2^16 - 1) - 1) / (2^16 - 1)</span>
<span class="cm">	 * -------------------------------------</span>
<span class="cm">	 *</span>
<span class="cm">	 * Thus, we also get w, with that a, with rounding upwards:</span>
<span class="cm">	 *</span>
<span class="cm">	 * w = (x + a - 1) / a</span>
<span class="cm">	 * -------------------</span>
<span class="cm">	 *</span>
<span class="cm">	 * To get limits:</span>
<span class="cm">	 *</span>
<span class="cm">	 * x E [1, (2^16 - 1) * (2^8 - 1)]</span>
<span class="cm">	 *</span>
<span class="cm">	 * Substituting maximum x to the original formula (with rounding),</span>
<span class="cm">	 * the maximum l is thus</span>
<span class="cm">	 *</span>
<span class="cm">	 * (2^16 - 1) * (2^8 - 1) * 10^6 = l * e + 10^6 - 1</span>
<span class="cm">	 *</span>
<span class="cm">	 * l = (10^6 * (2^16 - 1) * (2^8 - 1) - 10^6 + 1) / e</span>
<span class="cm">	 * --------------------------------------------------</span>
<span class="cm">	 *</span>
<span class="cm">	 * flash_strobe_length must be clamped between 1 and</span>
<span class="cm">	 * (10^6 * (2^16 - 1) * (2^8 - 1) - 10^6 + 1) / EXTCLK freq.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Then,</span>
<span class="cm">	 *</span>
<span class="cm">	 * flash_strobe_adjustment = ((flash_strobe_length *</span>
<span class="cm">	 *	EXTCLK freq + 10^6 - 1) / 10^6 + (2^16 - 1) - 1) / (2^16 - 1)</span>
<span class="cm">	 *</span>
<span class="cm">	 * tFlash_strobe_width_ctrl = ((flash_strobe_length *</span>
<span class="cm">	 *	EXTCLK freq + 10^6 - 1) / 10^6 +</span>
<span class="cm">	 *	flash_strobe_adjustment - 1) / flash_strobe_adjustment</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(</span><span class="mi">1000000ULL</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span>
		      <span class="mi">1000000</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ext_freq</span><span class="p">);</span>
	<span class="n">strobe_setup</span><span class="o">-&gt;</span><span class="n">strobe_width_high_us</span> <span class="o">=</span>
		<span class="n">clamp_t</span><span class="p">(</span><span class="n">u32</span><span class="p">,</span> <span class="n">strobe_setup</span><span class="o">-&gt;</span><span class="n">strobe_width_high_us</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">div_u64</span><span class="p">(((</span><span class="n">u64</span><span class="p">)</span><span class="n">strobe_setup</span><span class="o">-&gt;</span><span class="n">strobe_width_high_us</span> <span class="o">*</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ext_freq</span> <span class="o">+</span>
			<span class="mi">1000000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="mi">1000000ULL</span><span class="p">);</span>
	<span class="n">strobe_adjustment</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strobe_width_high_rs</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">+</span> <span class="n">strobe_adjustment</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
				<span class="n">strobe_adjustment</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_FLASH_MODE_RS</span><span class="p">,</span>
			    <span class="n">strobe_setup</span><span class="o">-&gt;</span><span class="n">mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_FLASH_STROBE_ADJUSTMENT</span><span class="p">,</span>
			    <span class="n">strobe_adjustment</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_TFLASH_STROBE_WIDTH_HIGH_RS_CTRL</span><span class="p">,</span>
		<span class="n">strobe_width_high_rs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_TFLASH_STROBE_DELAY_RS_CTRL</span><span class="p">,</span>
			    <span class="n">strobe_setup</span><span class="o">-&gt;</span><span class="n">strobe_delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_FLASH_STROBE_START_POINT</span><span class="p">,</span>
			    <span class="n">strobe_setup</span><span class="o">-&gt;</span><span class="n">stobe_start_point</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_FLASH_TRIGGER_RS</span><span class="p">,</span>
			    <span class="n">strobe_setup</span><span class="o">-&gt;</span><span class="n">trigger</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">strobe_setup</span><span class="o">-&gt;</span><span class="n">trigger</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Power management</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_power_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sleep</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">regulator_enable</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vana</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to enable vana regulator</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">set_xclk</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">set_xclk</span><span class="p">(</span>
			<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">clk_enable</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to set xclk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_xclk_fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span> <span class="o">!=</span> <span class="n">SMIAPP_NO_XSHUTDOWN</span><span class="p">)</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">sleep</span> <span class="o">=</span> <span class="n">SMIAPP_RESET_DELAY</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="n">sleep</span><span class="p">,</span> <span class="n">sleep</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Failures to respond to the address change command have been noticed.</span>
<span class="cm">	 * Those failures seem to be caused by the sensor requiring a longer</span>
<span class="cm">	 * boot time than advertised. An additional 10ms delay seems to work</span>
<span class="cm">	 * around the issue, but the SMIA++ I2C write retry hack makes the delay</span>
<span class="cm">	 * unnecessary. The failures need to be investigated to find a proper</span>
<span class="cm">	 * fix, and a delay will likely need to be added here if the I2C write</span>
<span class="cm">	 * retry hack is reverted before the root cause of the boot time issue</span>
<span class="cm">	 * is found.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">i2c_addr_alt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_change_cci_addr</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cci address change error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_SOFTWARE_RESET</span><span class="p">,</span>
			    <span class="n">SMIAPP_SOFTWARE_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;software reset failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">i2c_addr_alt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_change_cci_addr</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cci address change error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_COMPRESSION_MODE</span><span class="p">,</span>
			    <span class="n">SMIAPP_COMPRESSION_MODE_SIMPLE_PREDICTOR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;compression mode set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_EXTCLK_FREQUENCY_MHZ</span><span class="p">,</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1000000</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;extclk frequency set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_CSI_LANE_MODE</span><span class="p">,</span>
			    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">lanes</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;csi lane mode set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_FAST_STANDBY_CTRL</span><span class="p">,</span>
			    <span class="n">SMIAPP_FAST_STANDBY_CTRL_IMMEDIATE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;fast standby set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_CSI_SIGNALLING_MODE</span><span class="p">,</span>
			    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">csi_signalling_mode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;csi signalling mode set failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* DPHY control done by sensor based on requested link rate */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_DPHY_CTRL</span><span class="p">,</span>
			    <span class="n">SMIAPP_DPHY_CTRL_UI</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_call_quirk</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">post_poweron</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;post_poweron quirks failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Are we still initialising...? If yes, return here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_ctrl_handler_setup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">ctrl_handler</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_update_mode</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_cci_addr_fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_cci_addr_fail:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span> <span class="o">!=</span> <span class="n">SMIAPP_NO_XSHUTDOWN</span><span class="p">)</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">set_xclk</span><span class="p">)</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">set_xclk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>

<span class="nl">out_xclk_fail:</span>
	<span class="n">regulator_disable</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vana</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smiapp_power_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Currently power/clock to lens are enable/disabled separately</span>
<span class="cm">	 * but they are essentially the same signals. So if the sensor is</span>
<span class="cm">	 * powered off while the lens is powered on the sensor does not</span>
<span class="cm">	 * really see a power off and next time the cci address change</span>
<span class="cm">	 * will fail. So do a soft reset explicitly here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">i2c_addr_alt</span><span class="p">)</span>
		<span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
			     <span class="n">SMIAPP_REG_U8_SOFTWARE_RESET</span><span class="p">,</span>
			     <span class="n">SMIAPP_SOFTWARE_RESET</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span> <span class="o">!=</span> <span class="n">SMIAPP_NO_XSHUTDOWN</span><span class="p">)</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">set_xclk</span><span class="p">)</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">set_xclk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clk_disable</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
	<span class="n">regulator_disable</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vana</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_set_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the power count is modified from 0 to != 0 or from != 0</span>
<span class="cm">	 * to 0, update the power state.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_count</span> <span class="o">==</span> <span class="o">!</span><span class="n">on</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">on</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Power on and perform initialisation. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">smiapp_power_on</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">smiapp_power_off</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Update the power count. */</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_count</span> <span class="o">+=</span> <span class="n">on</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_count</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * Video stream management</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_start_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_CSI_DATA_FORMAT</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
			    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span><span class="o">-&gt;</span><span class="n">compressed</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_pll_configure</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Analog crop start coordinates */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_X_ADDR_START</span><span class="p">,</span>
			    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">left</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_Y_ADDR_START</span><span class="p">,</span>
			    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">top</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Analog crop end coordinates */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_X_ADDR_END</span><span class="p">,</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">left</span>
		<span class="o">+</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">width</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
		<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_Y_ADDR_END</span><span class="p">,</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">top</span>
		<span class="o">+</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">].</span><span class="n">height</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Output from pixel array, including blanking, is set using</span>
<span class="cm">	 * controls below. No need to set here.</span>
<span class="cm">	 */</span>

	<span class="cm">/* Digital crop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_DIGITAL_CROP_CAPABILITY</span><span class="p">]</span>
	    <span class="o">==</span> <span class="n">SMIAPP_DIGITAL_CROP_CAPABILITY_INPUT_CROP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_DIGITAL_CROP_X_OFFSET</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">].</span><span class="n">left</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_DIGITAL_CROP_Y_OFFSET</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">].</span><span class="n">top</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_DIGITAL_CROP_IMAGE_WIDTH</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">].</span><span class="n">width</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span>
			<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_DIGITAL_CROP_IMAGE_HEIGHT</span><span class="p">,</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Scaling */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALING_CAPABILITY</span><span class="p">]</span>
	    <span class="o">!=</span> <span class="n">SMIAPP_SCALING_CAPABILITY_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_SCALING_MODE</span><span class="p">,</span>
				    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaling_mode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_SCALE_M</span><span class="p">,</span>
				    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scale_m</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Output size from sensor */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_X_OUTPUT_SIZE</span><span class="p">,</span>
			    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PAD_SRC</span><span class="p">].</span><span class="n">width</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_Y_OUTPUT_SIZE</span><span class="p">,</span>
			    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">SMIAPP_PAD_SRC</span><span class="p">].</span><span class="n">height</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">flash_capability</span> <span class="o">&amp;</span>
	     <span class="p">(</span><span class="n">SMIAPP_FLASH_MODE_CAPABILITY_SINGLE_STROBE</span> <span class="o">|</span>
	      <span class="n">SMIAPP_FLASH_MODE_CAPABILITY_MULTIPLE_STROBE</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">strobe_setup</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">strobe_setup</span><span class="o">-&gt;</span><span class="n">trigger</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_setup_flash_strobe</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_call_quirk</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">pre_streamon</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;pre_streamon quirks failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_MODE_SELECT</span><span class="p">,</span>
			    <span class="n">SMIAPP_MODE_SELECT_STREAMING</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_stop_streaming</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_write</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_MODE_SELECT</span><span class="p">,</span>
			    <span class="n">SMIAPP_MODE_SELECT_SOFTWARE_STANDBY</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_call_quirk</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">post_streamoff</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;post_streamoff quirks failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * V4L2 subdev video operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_set_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">==</span> <span class="n">enable</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enable</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_start_streaming</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_stop_streaming</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_enum_mbus_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">v4l2_subdev_mbus_code_enum</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;subdev %s, pad %d, index %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">subdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">,</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subdev</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span> <span class="o">||</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">!=</span> <span class="n">SMIAPP_PAD_SRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">internal_csi_format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smiapp_csi_data_formats</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mbus_frame_fmts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">==</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">smiapp_csi_data_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;found index %d, i %d, code %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">code</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">code</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">__smiapp_get_mbus_code</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">subdev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span> <span class="o">&amp;&amp;</span> <span class="n">pad</span> <span class="o">==</span> <span class="n">SMIAPP_PAD_SRC</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">internal_csi_format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__smiapp_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">to_smiapp_subdev</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_TRY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span> <span class="o">=</span> <span class="o">*</span><span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">source_pad</span><span class="p">)</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">source_pad</span><span class="p">];</span>
		<span class="k">else</span>
			<span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_fmt</span><span class="p">;</span>

		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">__smiapp_get_mbus_code</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">);</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_get_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">__smiapp_get_format</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smiapp_get_crop_compose</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">**</span><span class="n">crops</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">**</span><span class="n">comps</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">to_smiapp_subdev</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crops</span><span class="p">)</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">subdev</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">num_pads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">crops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comps</span><span class="p">)</span>
			<span class="o">*</span><span class="n">comps</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">compose</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">crops</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">subdev</span><span class="o">-&gt;</span><span class="n">entity</span><span class="p">.</span><span class="n">num_pads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">crops</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_crop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">crops</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">comps</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">comps</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_compose</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span>
							     <span class="n">SMIAPP_PAD_SINK</span><span class="p">);</span>
			<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!*</span><span class="n">comps</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Changes require propagation only on sink pad. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smiapp_propagate</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span> <span class="kt">int</span> <span class="n">which</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">target</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">to_smiapp_subdev</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="o">*</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PADS</span><span class="p">];</span>

	<span class="n">smiapp_get_crop_compose</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">crops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">,</span> <span class="n">which</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span>:
		<span class="n">comp</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">comp</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scale_m</span> <span class="o">=</span>
					<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span>
						<span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">];</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaling_mode</span> <span class="o">=</span>
					<span class="n">SMIAPP_SCALING_MODE_NONE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binner</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_horizontal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_vertical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Fall through */</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_COMPOSE_ACTUAL</span>:
		<span class="o">*</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SRC</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">smiapp_csi_data_format</span>
<span class="o">*</span><span class="nf">smiapp_validate_csi_data_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span> <span class="n">u32</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">smiapp_csi_data_format</span> <span class="o">*</span><span class="n">csi_format</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smiapp_csi_data_formats</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mbus_frame_fmts</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">)</span>
		    <span class="o">&amp;&amp;</span> <span class="n">smiapp_csi_data_formats</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">&amp;</span><span class="n">smiapp_csi_data_formats</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">csi_format</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_set_format</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">v4l2_subdev_format</span> <span class="o">*</span><span class="n">fmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">to_smiapp_subdev</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PADS</span><span class="p">];</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Media bus code is changeable on src subdev&#39;s source pad. On</span>
<span class="cm">	 * other source pads we just get format here.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">source_pad</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">code</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">code</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="n">__smiapp_get_format</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span> <span class="o">&amp;&amp;</span> <span class="n">subdev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">smiapp_csi_data_format</span> <span class="o">*</span><span class="n">csi_format</span> <span class="o">=</span>
				<span class="n">smiapp_validate_csi_data_format</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">csi_format</span> <span class="o">=</span> <span class="n">csi_format</span><span class="p">;</span>
			<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">csi_format</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sink pad. Width and height are changeable here. */</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">code</span> <span class="o">=</span> <span class="n">__smiapp_get_mbus_code</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span>
		<span class="n">clamp</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_X_OUTPUT_SIZE</span><span class="p">],</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_X_OUTPUT_SIZE</span><span class="p">]);</span>
	<span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span>
		<span class="n">clamp</span><span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_Y_OUTPUT_SIZE</span><span class="p">],</span>
		      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_Y_OUTPUT_SIZE</span><span class="p">]);</span>

	<span class="n">smiapp_get_crop_compose</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">crops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

	<span class="n">crops</span><span class="p">[</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crops</span><span class="p">[</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">crops</span><span class="p">[</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">crops</span><span class="p">[</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">format</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span>
		<span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_fmt</span> <span class="o">=</span> <span class="o">*</span><span class="n">crops</span><span class="p">[</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">];</span>
	<span class="n">smiapp_propagate</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">,</span>
			 <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate goodness of scaled image size compared to expected image</span>
<span class="cm"> * size and flags provided.</span>
<span class="cm"> */</span>
<span class="cp">#define SCALING_GOODNESS		100000</span>
<span class="cp">#define SCALING_GOODNESS_EXTREME	100000000</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">scaling_goodness</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">w</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ask_w</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">h</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ask_h</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ask_w</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">h</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">ask_h</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_SUBDEV_SEL_FLAG_SIZE_GE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">ask_w</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="n">SCALING_GOODNESS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&lt;</span> <span class="n">ask_h</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="n">SCALING_GOODNESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">V4L2_SUBDEV_SEL_FLAG_SIZE_LE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">ask_w</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="n">SCALING_GOODNESS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">h</span> <span class="o">&gt;</span> <span class="n">ask_h</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">-=</span> <span class="n">SCALING_GOODNESS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">val</span> <span class="o">-=</span> <span class="n">abs</span><span class="p">(</span><span class="n">w</span> <span class="o">-</span> <span class="n">ask_w</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">-=</span> <span class="n">abs</span><span class="p">(</span><span class="n">h</span> <span class="o">-</span> <span class="n">ask_h</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_X_OUTPUT_SIZE</span><span class="p">])</span>
		<span class="n">val</span> <span class="o">-=</span> <span class="n">SCALING_GOODNESS_EXTREME</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;w %d ask_w %d h %d ask_h %d goodness %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">w</span><span class="p">,</span> <span class="n">ask_h</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">ask_h</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">smiapp_set_compose_binner</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">**</span><span class="n">crops</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">binh</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">binv</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">best</span> <span class="o">=</span> <span class="n">scaling_goodness</span><span class="p">(</span>
		<span class="n">subdev</span><span class="p">,</span>
		<span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
		<span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nbinning_subtypes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">this</span> <span class="o">=</span> <span class="n">scaling_goodness</span><span class="p">(</span>
			<span class="n">subdev</span><span class="p">,</span>
			<span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span>
			<span class="o">/</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">horizontal</span><span class="p">,</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			<span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span>
			<span class="o">/</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vertical</span><span class="p">,</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">binh</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">horizontal</span><span class="p">;</span>
			<span class="n">binv</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vertical</span><span class="p">;</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_vertical</span> <span class="o">=</span> <span class="n">binv</span><span class="p">;</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_horizontal</span> <span class="o">=</span> <span class="n">binh</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="p">(</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">/</span> <span class="n">binh</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="p">(</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">/</span> <span class="n">binv</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Calculate best scaling ratio and mode for given output resolution.</span>
<span class="cm"> *</span>
<span class="cm"> * Try all of these: horizontal ratio, vertical ratio and smallest</span>
<span class="cm"> * size possible (horizontally).</span>
<span class="cm"> *</span>
<span class="cm"> * Also try whether horizontal scaler or full scaler gives a better</span>
<span class="cm"> * result.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">smiapp_set_compose_scaler</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">**</span><span class="n">crops</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">comp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">min</span><span class="p">,</span> <span class="n">max</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">max_m</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">scale_m</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">SMIAPP_SCALING_MODE_HORIZONTAL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">try</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ntry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">best</span> <span class="o">=</span> <span class="n">INT_MIN</span><span class="p">;</span>

	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			     <span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			      <span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span>
		<span class="o">*</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">]</span> <span class="o">/</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span>
		<span class="o">*</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">]</span> <span class="o">/</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
	<span class="n">max_m</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span>
		<span class="o">*</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">]</span>
		<span class="o">/</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_X_OUTPUT_SIZE</span><span class="p">];</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_M_MAX</span><span class="p">],</span>
		<span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_M_MIN</span><span class="p">]));</span>
	<span class="n">b</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_M_MAX</span><span class="p">],</span>
		<span class="n">max</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_M_MIN</span><span class="p">]));</span>
	<span class="n">max_m</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_M_MAX</span><span class="p">],</span>
		    <span class="n">max</span><span class="p">(</span><span class="n">max_m</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_M_MIN</span><span class="p">]));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;scaling: a %d b %d max_m %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">max_m</span><span class="p">);</span>

	<span class="n">min</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_m</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>
	<span class="n">max</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">max_m</span><span class="p">,</span> <span class="n">max</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">));</span>

	<span class="n">try</span><span class="p">[</span><span class="n">ntry</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span><span class="p">;</span>
	<span class="n">ntry</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">!=</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">try</span><span class="p">[</span><span class="n">ntry</span><span class="p">]</span> <span class="o">=</span> <span class="n">max</span><span class="p">;</span>
		<span class="n">ntry</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max</span> <span class="o">!=</span> <span class="n">max_m</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">try</span><span class="p">[</span><span class="n">ntry</span><span class="p">]</span> <span class="o">=</span> <span class="n">min</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ntry</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">min</span> <span class="o">!=</span> <span class="n">max</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">try</span><span class="p">[</span><span class="n">ntry</span><span class="p">]</span> <span class="o">=</span> <span class="n">max</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">ntry</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ntry</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">this</span> <span class="o">=</span> <span class="n">scaling_goodness</span><span class="p">(</span>
			<span class="n">subdev</span><span class="p">,</span>
			<span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span>
			<span class="o">/</span> <span class="n">try</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="o">*</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">],</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			<span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">,</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trying factor %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">try</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scale_m</span> <span class="o">=</span> <span class="n">try</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">SMIAPP_SCALING_MODE_HORIZONTAL</span><span class="p">;</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALING_CAPABILITY</span><span class="p">]</span>
		    <span class="o">==</span> <span class="n">SMIAPP_SCALING_CAPABILITY_HORIZONTAL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">this</span> <span class="o">=</span> <span class="n">scaling_goodness</span><span class="p">(</span>
			<span class="n">subdev</span><span class="p">,</span> <span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span>
			<span class="o">/</span> <span class="n">try</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="o">*</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">],</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">,</span>
			<span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span>
			<span class="o">/</span> <span class="n">try</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
			<span class="o">*</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">],</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">,</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">&gt;</span> <span class="n">best</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">scale_m</span> <span class="o">=</span> <span class="n">try</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">SMIAPP_SCALING_MODE_BOTH</span><span class="p">;</span>
			<span class="n">best</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span>
		<span class="p">(</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">width</span>
		 <span class="o">/</span> <span class="n">scale_m</span>
		 <span class="o">*</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">SMIAPP_SCALING_MODE_BOTH</span><span class="p">)</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span>
			 <span class="o">/</span> <span class="n">scale_m</span>
			 <span class="o">*</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">])</span>
			<span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PAD_SINK</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scale_m</span> <span class="o">=</span> <span class="n">scale_m</span><span class="p">;</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaling_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cm">/* We&#39;re only called on source pads. This function sets scaling. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_set_compose</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">to_smiapp_subdev</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="o">*</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PADS</span><span class="p">];</span>

	<span class="n">smiapp_get_crop_compose</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">crops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binner</span><span class="p">)</span>
		<span class="n">smiapp_set_compose_binner</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">crops</span><span class="p">,</span> <span class="n">comp</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">smiapp_set_compose_scaler</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="p">,</span> <span class="n">crops</span><span class="p">,</span> <span class="n">comp</span><span class="p">);</span>

	<span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">;</span>
	<span class="n">smiapp_propagate</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">,</span>
			 <span class="n">V4L2_SUBDEV_SEL_TGT_COMPOSE_ACTUAL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">smiapp_update_mode</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__smiapp_sel_supported</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">to_smiapp_subdev</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>

	<span class="cm">/* We only implement crop in three places. */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span>:
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_BOUNDS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span>
		    <span class="o">&amp;&amp;</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">SMIAPP_PA_PAD_SRC</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span>
		    <span class="o">&amp;&amp;</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">SMIAPP_PAD_SRC</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span>
		    <span class="o">&amp;&amp;</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">SMIAPP_PAD_SINK</span>
		    <span class="o">&amp;&amp;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_DIGITAL_CROP_CAPABILITY</span><span class="p">]</span>
		    <span class="o">==</span> <span class="n">SMIAPP_DIGITAL_CROP_CAPABILITY_INPUT_CROP</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_COMPOSE_ACTUAL</span>:
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_COMPOSE_BOUNDS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">source_pad</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binner</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span>
		    <span class="o">&amp;&amp;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALING_CAPABILITY</span><span class="p">]</span>
		    <span class="o">!=</span> <span class="n">SMIAPP_SCALING_CAPABILITY_NONE</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* Fall through */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_set_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">to_smiapp_subdev</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">src_size</span><span class="p">,</span> <span class="o">*</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PADS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">_r</span><span class="p">;</span>

	<span class="n">smiapp_get_crop_compose</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">crops</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">)</span>
			<span class="n">src_size</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_fmt</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">src_size</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ssd</span><span class="o">-&gt;</span><span class="n">compose</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">_r</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">_r</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">_r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">)</span>
				<span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
			<span class="n">_r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">)</span>
				<span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
			<span class="n">src_size</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">_r</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">src_size</span> <span class="o">=</span>
				<span class="n">v4l2_subdev_get_try_compose</span><span class="p">(</span>
					<span class="n">fh</span><span class="p">,</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">&amp;&amp;</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">SMIAPP_PAD_SRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">src_size</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">);</span>
	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">src_size</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">);</span>

	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">src_size</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">-</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">top</span><span class="p">,</span> <span class="n">src_size</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">-</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="o">*</span><span class="n">crops</span><span class="p">[</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">]</span> <span class="o">=</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">!=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span> <span class="o">&amp;&amp;</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">SMIAPP_PAD_SINK</span><span class="p">)</span>
		<span class="n">smiapp_propagate</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">,</span>
				 <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__smiapp_get_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">to_smiapp_subdev</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">comp</span><span class="p">,</span> <span class="o">*</span><span class="n">crops</span><span class="p">[</span><span class="n">SMIAPP_PADS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="n">sink_fmt</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__smiapp_sel_supported</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">smiapp_get_crop_compose</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">crops</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">which</span> <span class="o">==</span> <span class="n">V4L2_SUBDEV_FORMAT_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sink_fmt</span> <span class="o">=</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_fmt</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span>
			<span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">);</span>

		<span class="n">sink_fmt</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sink_fmt</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">sink_fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">sink_fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_BOUNDS</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_X_ADDR_MAX</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_Y_ADDR_MAX</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span> <span class="o">==</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="n">sink_fmt</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span>:
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_COMPOSE_BOUNDS</span>:
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">crops</span><span class="p">[</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">pad</span><span class="p">];</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_COMPOSE_ACTUAL</span>:
		<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">comp</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_get_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">__smiapp_get_selection</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_set_selection</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_subdev_selection</span> <span class="o">*</span><span class="n">sel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__smiapp_sel_supported</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">left</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">left</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">top</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">top</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SMIAPP_ALIGN_DIM</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>
	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">SMIAPP_ALIGN_DIM</span><span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">,</span> <span class="n">sel</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
			     <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_X_OUTPUT_SIZE</span><span class="p">],</span>
			     <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">width</span><span class="p">);</span>
	<span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">max_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
			      <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_Y_OUTPUT_SIZE</span><span class="p">],</span>
			      <span class="n">sel</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">height</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sel</span><span class="o">-&gt;</span><span class="n">target</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_CROP_ACTUAL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">smiapp_set_crop</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V4L2_SUBDEV_SEL_TGT_COMPOSE_ACTUAL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">smiapp_set_compose</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="n">fh</span><span class="p">,</span> <span class="n">sel</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_get_skip_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">frames</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">frames</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">frame_skip</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * sysfs attributes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">smiapp_sysfs_nvm_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">dev_init_done</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* NVM not read yet - read it now */</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm_size</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">nvm_size</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smiapp_set_power</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smiapp_read_nvm</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nvm read failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">smiapp_set_power</span><span class="p">(</span><span class="n">subdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * NVM is still way below a PAGE_SIZE, so we can safely</span>
<span class="cm">	 * assume this for now.</span>
<span class="cm">	 */</span>
	<span class="n">nbytes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm_size</span><span class="p">,</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">nbytes</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">nvm</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">smiapp_sysfs_nvm_read</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * V4L2 subdev core operations</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_identify_module</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_module_info</span> <span class="o">*</span><span class="n">minfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">SMIAPP_NAME</span><span class="p">;</span>

	<span class="cm">/* Module info */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_MANUFACTURER_ID</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">manufacturer_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U16_MODEL_ID</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
					 <span class="n">SMIAPP_REG_U8_REVISION_NUMBER_MAJOR</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">revision_number_major</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
					 <span class="n">SMIAPP_REG_U8_REVISION_NUMBER_MINOR</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">revision_number_minor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
					 <span class="n">SMIAPP_REG_U8_MODULE_DATE_YEAR</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">module_year</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
					 <span class="n">SMIAPP_REG_U8_MODULE_DATE_MONTH</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">module_month</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_MODULE_DATE_DAY</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">module_day</span><span class="p">);</span>

	<span class="cm">/* Sensor info */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
					 <span class="n">SMIAPP_REG_U8_SENSOR_MANUFACTURER_ID</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_manufacturer_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
					 <span class="n">SMIAPP_REG_U16_SENSOR_MODEL_ID</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_model_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
					 <span class="n">SMIAPP_REG_U8_SENSOR_REVISION_NUMBER</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_revision_number</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
					 <span class="n">SMIAPP_REG_U8_SENSOR_FIRMWARE_VERSION</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_firmware_version</span><span class="p">);</span>

	<span class="cm">/* SMIA */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_SMIA_VERSION</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">smia_version</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rval</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read_8only</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_SMIAPP_VERSION</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">smiapp_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sensor detection failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;module 0x%2.2x-0x%4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">manufacturer_id</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;module revision 0x%2.2x-0x%2.2x date %2.2d-%2.2d-%2.2d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">revision_number_major</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">revision_number_minor</span><span class="p">,</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">module_year</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">module_month</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">module_day</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sensor 0x%2.2x-0x%4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_manufacturer_id</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_model_id</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;sensor revision 0x%2.2x firmware version 0x%2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_revision_number</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_firmware_version</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;smia version %2.2d smiapp version %2.2d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">smia_version</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">smiapp_version</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Some modules have bad data in the lvalues below. Hope the</span>
<span class="cm">	 * rvalues have better stuff. The lvalues are module</span>
<span class="cm">	 * parameters whereas the rvalues are sensor parameters.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">manufacturer_id</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">minfo</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">manufacturer_id</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_manufacturer_id</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">model_id</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_model_id</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">revision_number_major</span> <span class="o">=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">sensor_revision_number</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smiapp_module_idents</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smiapp_module_idents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">manufacturer_id</span>
		    <span class="o">!=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">manufacturer_id</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smiapp_module_idents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model_id</span> <span class="o">!=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">smiapp_module_idents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span>
		    <span class="o">&amp;</span> <span class="n">SMIAPP_MODULE_IDENT_FLAG_REV_LE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">smiapp_module_idents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revision_number_major</span>
			    <span class="o">&lt;</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">revision_number_major</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">smiapp_module_idents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">revision_number_major</span>
			    <span class="o">!=</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">revision_number_major</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">smiapp_module_idents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">quirk</span> <span class="o">=</span> <span class="n">smiapp_module_idents</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">quirk</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">smiapp_module_idents</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;no quirks for this module; let&#39;s hope it&#39;s fully compliant</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;the sensor is called %s, ident %2.2x%4.4x%2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">manufacturer_id</span><span class="p">,</span> <span class="n">minfo</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">,</span>
		<span class="n">minfo</span><span class="o">-&gt;</span><span class="n">revision_number_major</span><span class="p">);</span>

	<span class="n">strlcpy</span><span class="p">(</span><span class="n">subdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">subdev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">smiapp_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_internal_ops</span> <span class="n">smiapp_internal_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">media_entity_operations</span> <span class="n">smiapp_entity_ops</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_registered</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vana</span> <span class="o">=</span> <span class="n">regulator_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;VANA&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vana</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not get regulator for vana</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">set_xclk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span> <span class="o">=</span> <span class="n">clk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk_name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not get clock %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk_name</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_clk_get</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">clk_set_rate</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">,</span>
				    <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unable to set clock %s freq to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk_name</span><span class="p">,</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_clk_set_rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span> <span class="o">!=</span> <span class="n">SMIAPP_NO_XSHUTDOWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio_request_one</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				     <span class="s">&quot;SMIA++ xshutdown&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;unable to acquire reset gpio %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_clk_set_rate</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_power_on</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_smiapp_power_on</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_identify_module</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_power_off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_get_all_limits</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_power_off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Handle Sensor Module orientation on the board.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The application of H-FLIP and V-FLIP on the sensor is modified by</span>
<span class="cm">	 * the sensor orientation on the board.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For SMIAPP_BOARD_SENSOR_ORIENT_180 the default behaviour is to set</span>
<span class="cm">	 * both H-FLIP and V-FLIP for normal operation which also implies</span>
<span class="cm">	 * that a set/unset operation for user space HFLIP and VFLIP v4l2</span>
<span class="cm">	 * controls will need to be internally inverted.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Rotation also changes the bayer pattern.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">module_board_orient</span> <span class="o">==</span>
	    <span class="n">SMIAPP_MODULE_BOARD_ORIENT_180</span><span class="p">)</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">hvflip_inv_mask</span> <span class="o">=</span> <span class="n">SMIAPP_IMAGE_ORIENTATION_HFLIP</span> <span class="o">|</span>
					  <span class="n">SMIAPP_IMAGE_ORIENTATION_VFLIP</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_get_mbus_formats</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_power_off</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_BINNING_CAPABILITY</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span>
				   <span class="n">SMIAPP_REG_U8_BINNING_SUBTYPES</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_power_off</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nbinning_subtypes</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="n">u8</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span>
						  <span class="n">SMIAPP_BINNING_SUBTYPES</span><span class="p">);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nbinning_subtypes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span>
				<span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_BINNING_TYPE_n</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out_power_off</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
				<span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">smiapp_binning_subtype</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">val</span><span class="p">;</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;binning %xx%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">horizontal</span><span class="p">,</span>
				<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_subtypes</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">vertical</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_horizontal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binning_vertical</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* SMIA++ NVM initialization - it will be read from the sensor</span>
<span class="cm">	 * when it is first requested by userspace.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">.</span><span class="n">smiapp_version</span> <span class="o">&amp;&amp;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">nvm_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">nvm_size</span><span class="p">,</span>
				      <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;nvm buf allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_power_off</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_nvm</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;sysfs nvm entry failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">rval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_power_off</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_call_quirk</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">limits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;limits quirks failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_nvm_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We consider this as profile 0 sensor if any of these are zero. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_OP_SYS_CLK_DIV</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_OP_SYS_CLK_DIV</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MIN_OP_PIX_CLK_DIV</span><span class="p">]</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_MAX_OP_PIX_CLK_DIV</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">.</span><span class="n">smiapp_profile</span> <span class="o">=</span> <span class="n">SMIAPP_PROFILE_0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALING_CAPABILITY</span><span class="p">]</span>
		   <span class="o">!=</span> <span class="n">SMIAPP_SCALING_CAPABILITY_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALING_CAPABILITY</span><span class="p">]</span>
		    <span class="o">==</span> <span class="n">SMIAPP_SCALING_CAPABILITY_HORIZONTAL</span><span class="p">)</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">.</span><span class="n">smiapp_profile</span> <span class="o">=</span> <span class="n">SMIAPP_PROFILE_1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">.</span><span class="n">smiapp_profile</span> <span class="o">=</span> <span class="n">SMIAPP_PROFILE_2</span><span class="p">;</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="p">];</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_DIGITAL_CROP_CAPABILITY</span><span class="p">]</span>
		   <span class="o">==</span> <span class="n">SMIAPP_DIGITAL_CROP_CAPABILITY_INPUT_CROP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="p">];</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binner</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="p">];</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="o">++</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="p">];</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="o">++</span><span class="p">;</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scale_m</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_SCALER_N_MIN</span><span class="p">];</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SMIAPP_SUBDEVS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">const</span> <span class="n">__this</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">scaler</span><span class="p">,</span> <span class="s">&quot;scaler&quot;</span><span class="p">,</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">binner</span><span class="p">,</span> <span class="s">&quot;binner&quot;</span><span class="p">,</span> <span class="p">},</span>
			<span class="p">{</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="p">,</span> <span class="s">&quot;pixel array&quot;</span><span class="p">,</span> <span class="p">},</span>
		<span class="p">},</span> <span class="o">*</span><span class="n">_this</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">__this</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">this</span> <span class="o">=</span> <span class="n">_this</span><span class="o">-&gt;</span><span class="n">ssd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">this</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">!=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="p">)</span>
			<span class="n">v4l2_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ops</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">sensor</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">==</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">npads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">npads</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">source_pad</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">snprintf</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
			 <span class="k">sizeof</span><span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">name</span><span class="p">),</span> <span class="s">&quot;%s %s&quot;</span><span class="p">,</span>
			 <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_this</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">sink_fmt</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_X_ADDR_MAX</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">sink_fmt</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_Y_ADDR_MAX</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">compose</span><span class="p">.</span><span class="n">width</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">sink_fmt</span><span class="p">.</span><span class="n">width</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">compose</span><span class="p">.</span><span class="n">height</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">sink_fmt</span><span class="p">.</span><span class="n">height</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">source_pad</span><span class="p">]</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">compose</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">source_pad</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">this</span> <span class="o">!=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">crop</span><span class="p">[</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">]</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">compose</span><span class="p">;</span>
			<span class="n">this</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SINK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">entity</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smiapp_entity_ops</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">last</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">last</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_HAS_DEVNODE</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">internal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smiapp_internal_ops</span><span class="p">;</span>
		<span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">v4l2_set_subdevdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">media_entity_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span>
					 <span class="n">this</span><span class="o">-&gt;</span><span class="n">npads</span><span class="p">,</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;media_entity_init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_nvm_release</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">media_entity_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span>
						<span class="n">this</span><span class="o">-&gt;</span><span class="n">source_pad</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span>
						<span class="n">last</span><span class="o">-&gt;</span><span class="n">sink_pad</span><span class="p">,</span>
						<span class="n">MEDIA_LNK_FL_ENABLED</span> <span class="o">|</span>
						<span class="n">MEDIA_LNK_FL_IMMUTABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;media_entity_create_link failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_nvm_release</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rval</span> <span class="o">=</span> <span class="n">v4l2_device_register_subdev</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">v4l2_dev</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;v4l2_device_register_subdev failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_nvm_release</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">last</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;profile %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">minfo</span><span class="p">.</span><span class="n">smiapp_profile</span><span class="p">);</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">entity</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">MEDIA_ENT_T_V4L2_SUBDEV_SENSOR</span><span class="p">;</span>

	<span class="cm">/* final steps */</span>
	<span class="n">smiapp_read_frame_fmt</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_init_controls</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nvm_release</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_update_mode</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;update mode failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_nvm_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">dev_init_done</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="cm">/* check flash capability */</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_read</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="n">SMIAPP_REG_U8_FLASH_MODE_CAPABILITY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">flash_capability</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_nvm_release</span><span class="p">;</span>

	<span class="n">smiapp_power_off</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_nvm_release:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_nvm</span><span class="p">);</span>

<span class="nl">out_power_off:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">smiapp_power_off</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

<span class="nl">out_smiapp_power_on:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span> <span class="o">!=</span> <span class="n">SMIAPP_NO_XSHUTDOWN</span><span class="p">)</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span><span class="p">);</span>

<span class="nl">out_clk_set_rate:</span>
	<span class="n">clk_put</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="nl">out_clk_get:</span>
	<span class="n">regulator_put</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vana</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vana</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_subdev</span> <span class="o">*</span><span class="n">ssd</span> <span class="o">=</span> <span class="n">to_smiapp_subdev</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mbus_code</span> <span class="o">=</span>
		<span class="n">smiapp_csi_data_formats</span><span class="p">[</span><span class="n">smiapp_pixel_order</span><span class="p">(</span><span class="n">sensor</span><span class="p">)].</span><span class="n">code</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ssd</span><span class="o">-&gt;</span><span class="n">npads</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">try_fmt</span> <span class="o">=</span>
			<span class="n">v4l2_subdev_get_try_format</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">try_crop</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_crop</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">try_comp</span><span class="p">;</span>

		<span class="n">try_fmt</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_X_ADDR_MAX</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">try_fmt</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">limits</span><span class="p">[</span><span class="n">SMIAPP_LIMIT_Y_ADDR_MAX</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">try_fmt</span><span class="o">-&gt;</span><span class="n">code</span> <span class="o">=</span> <span class="n">mbus_code</span><span class="p">;</span>

		<span class="n">try_crop</span><span class="o">-&gt;</span><span class="n">top</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">try_crop</span><span class="o">-&gt;</span><span class="n">left</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">try_crop</span><span class="o">-&gt;</span><span class="n">width</span> <span class="o">=</span> <span class="n">try_fmt</span><span class="o">-&gt;</span><span class="n">width</span><span class="p">;</span>
		<span class="n">try_crop</span><span class="o">-&gt;</span><span class="n">height</span> <span class="o">=</span> <span class="n">try_fmt</span><span class="o">-&gt;</span><span class="n">height</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ssd</span> <span class="o">!=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">pixel_array</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">try_comp</span> <span class="o">=</span> <span class="n">v4l2_subdev_get_try_compose</span><span class="p">(</span><span class="n">fh</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="o">*</span><span class="n">try_comp</span> <span class="o">=</span> <span class="o">*</span><span class="n">try_crop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">smiapp_set_power</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_subdev_fh</span> <span class="o">*</span><span class="n">fh</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">smiapp_set_power</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">smiapp_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span> <span class="o">=</span> <span class="n">smiapp_set_stream</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">smiapp_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_power</span> <span class="o">=</span> <span class="n">smiapp_set_power</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_pad_ops</span> <span class="n">smiapp_pad_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">enum_mbus_code</span> <span class="o">=</span> <span class="n">smiapp_enum_mbus_code</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_fmt</span> <span class="o">=</span> <span class="n">smiapp_get_format</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_fmt</span> <span class="o">=</span> <span class="n">smiapp_set_format</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_selection</span> <span class="o">=</span> <span class="n">smiapp_get_selection</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_selection</span> <span class="o">=</span> <span class="n">smiapp_set_selection</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_sensor_ops</span> <span class="n">smiapp_sensor_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_skip_frames</span> <span class="o">=</span> <span class="n">smiapp_get_skip_frames</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">smiapp_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smiapp_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smiapp_video_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pad</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smiapp_pad_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sensor</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smiapp_sensor_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">media_entity_operations</span> <span class="n">smiapp_entity_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">link_validate</span> <span class="o">=</span> <span class="n">v4l2_subdev_link_validate</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_internal_ops</span> <span class="n">smiapp_internal_src_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">registered</span> <span class="o">=</span> <span class="n">smiapp_registered</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">smiapp_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">smiapp_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">v4l2_subdev_internal_ops</span> <span class="n">smiapp_internal_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">smiapp_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">close</span> <span class="o">=</span> <span class="n">smiapp_close</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* -----------------------------------------------------------------------------</span>
<span class="cm"> * I2C Driver</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">streaming</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">mutex_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="n">smiapp_stop_streaming</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="n">streaming</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">;</span>

	<span class="n">smiapp_power_off</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="cm">/* save state for resume */</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span> <span class="o">=</span> <span class="n">streaming</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">to_i2c_client</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_power_on</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">streaming</span><span class="p">)</span>
		<span class="n">rval</span> <span class="o">=</span> <span class="n">smiapp_start_streaming</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define smiapp_suspend	NULL</span>
<span class="cp">#define smiapp_resume	NULL</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">smiapp_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">devid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">sensor</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sensor</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_mutex</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds</span><span class="p">[</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="p">];</span>

	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">smiapp_ops</span><span class="p">);</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">internal_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smiapp_internal_src_ops</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">V4L2_SUBDEV_FL_HAS_DEVNODE</span><span class="p">;</span>
	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">sensor</span><span class="p">;</span>

	<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">MEDIA_PAD_FL_SOURCE</span><span class="p">;</span>
	<span class="n">rval</span> <span class="o">=</span> <span class="n">media_entity_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">.</span><span class="n">entity</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
				 <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">pads</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__exit</span> <span class="nf">smiapp_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">subdev</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">smiapp_sensor</span> <span class="o">*</span><span class="n">sensor</span> <span class="o">=</span> <span class="n">to_smiapp_sensor</span><span class="p">(</span><span class="n">subdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span> <span class="o">!=</span> <span class="n">SMIAPP_NO_XSHUTDOWN</span><span class="p">)</span>
			<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">set_xclk</span><span class="p">)</span>
			<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">set_xclk</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">src</span><span class="o">-&gt;</span><span class="n">sd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clk_disable</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>
		<span class="n">sensor</span><span class="o">-&gt;</span><span class="n">power_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_nvm</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">nvm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds_used</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">media_entity_cleanup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sd</span><span class="p">.</span><span class="n">entity</span><span class="p">);</span>
		<span class="n">v4l2_device_unregister_subdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ssds</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sd</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">smiapp_free_controls</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span> <span class="o">!=</span> <span class="n">SMIAPP_NO_XSHUTDOWN</span><span class="p">)</span>
		<span class="n">gpio_free</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">platform_data</span><span class="o">-&gt;</span><span class="n">xshutdown</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">)</span>
		<span class="n">clk_put</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ext_clk</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vana</span><span class="p">)</span>
		<span class="n">regulator_put</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">vana</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">sensor</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">smiapp_id_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SMIAPP_NAME</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">smiapp_id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">smiapp_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">smiapp_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">smiapp_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">smiapp_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">SMIAPP_NAME</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">smiapp_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>	<span class="o">=</span> <span class="n">smiapp_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__exit_p</span><span class="p">(</span><span class="n">smiapp_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">smiapp_id_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">smiapp_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Sakari Ailus &lt;sakari.ailus@maxwell.research.nokia.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Generic SMIA/SMIA++ camera module driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
