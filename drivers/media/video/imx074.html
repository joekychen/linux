<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › media › video › imx074.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>imx074.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for IMX074 CMOS Image Sensor from Sony</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010, Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Partially inspired by the IMX074 driver from the Android / MSM tree</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/v4l2-mediabus.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/videodev2.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;media/soc_camera.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-subdev.h&gt;</span>
<span class="cp">#include &lt;media/v4l2-chip-ident.h&gt;</span>

<span class="cm">/* IMX074 registers */</span>

<span class="cp">#define MODE_SELECT			0x0100</span>
<span class="cp">#define IMAGE_ORIENTATION		0x0101</span>
<span class="cp">#define GROUPED_PARAMETER_HOLD		0x0104</span>

<span class="cm">/* Integration Time */</span>
<span class="cp">#define COARSE_INTEGRATION_TIME_HI	0x0202</span>
<span class="cp">#define COARSE_INTEGRATION_TIME_LO	0x0203</span>
<span class="cm">/* Gain */</span>
<span class="cp">#define ANALOGUE_GAIN_CODE_GLOBAL_HI	0x0204</span>
<span class="cp">#define ANALOGUE_GAIN_CODE_GLOBAL_LO	0x0205</span>

<span class="cm">/* PLL registers */</span>
<span class="cp">#define PRE_PLL_CLK_DIV			0x0305</span>
<span class="cp">#define PLL_MULTIPLIER			0x0307</span>
<span class="cp">#define PLSTATIM			0x302b</span>
<span class="cp">#define VNDMY_ABLMGSHLMT		0x300a</span>
<span class="cp">#define Y_OPBADDR_START_DI		0x3014</span>
<span class="cm">/* mode setting */</span>
<span class="cp">#define FRAME_LENGTH_LINES_HI		0x0340</span>
<span class="cp">#define FRAME_LENGTH_LINES_LO		0x0341</span>
<span class="cp">#define LINE_LENGTH_PCK_HI		0x0342</span>
<span class="cp">#define LINE_LENGTH_PCK_LO		0x0343</span>
<span class="cp">#define YADDR_START			0x0347</span>
<span class="cp">#define YADDR_END			0x034b</span>
<span class="cp">#define X_OUTPUT_SIZE_MSB		0x034c</span>
<span class="cp">#define X_OUTPUT_SIZE_LSB		0x034d</span>
<span class="cp">#define Y_OUTPUT_SIZE_MSB		0x034e</span>
<span class="cp">#define Y_OUTPUT_SIZE_LSB		0x034f</span>
<span class="cp">#define X_EVEN_INC			0x0381</span>
<span class="cp">#define X_ODD_INC			0x0383</span>
<span class="cp">#define Y_EVEN_INC			0x0385</span>
<span class="cp">#define Y_ODD_INC			0x0387</span>

<span class="cp">#define HMODEADD			0x3001</span>
<span class="cp">#define VMODEADD			0x3016</span>
<span class="cp">#define VAPPLINE_START			0x3069</span>
<span class="cp">#define VAPPLINE_END			0x306b</span>
<span class="cp">#define SHUTTER				0x3086</span>
<span class="cp">#define HADDAVE				0x30e8</span>
<span class="cp">#define LANESEL				0x3301</span>

<span class="cm">/* IMX074 supported geometry */</span>
<span class="cp">#define IMX074_WIDTH			1052</span>
<span class="cp">#define IMX074_HEIGHT			780</span>

<span class="cm">/* IMX074 has only one fixed colorspace per pixelcode */</span>
<span class="k">struct</span> <span class="n">imx074_datafmt</span> <span class="p">{</span>
	<span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span>	<span class="n">code</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">v4l2_colorspace</span>		<span class="n">colorspace</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">imx074</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_subdev</span>		<span class="n">subdev</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">imx074_datafmt</span>	<span class="o">*</span><span class="n">fmt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">imx074_datafmt</span> <span class="n">imx074_colour_fmts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">V4L2_MBUS_FMT_SBGGR8_1X8</span><span class="p">,</span> <span class="n">V4L2_COLORSPACE_SRGB</span><span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">imx074</span> <span class="o">*</span><span class="nf">to_imx074</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">container_of</span><span class="p">(</span><span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">),</span> <span class="k">struct</span> <span class="n">imx074</span><span class="p">,</span> <span class="n">subdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Find a data format by a pixel code in an array */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">imx074_datafmt</span> <span class="o">*</span><span class="nf">imx074_find_datafmt</span><span class="p">(</span><span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">imx074_colour_fmts</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">imx074_colour_fmts</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">code</span> <span class="o">==</span> <span class="n">code</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">imx074_colour_fmts</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reg_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adap</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tx</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">addr</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">tx</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">tx</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">adap</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mdelay</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">reg_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_msg</span> <span class="n">msgs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>  <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>   <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">},</span> <span class="p">{</span>
			<span class="p">.</span><span class="n">addr</span>  <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span>
			<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">I2C_M_RD</span><span class="p">,</span>
			<span class="p">.</span><span class="n">len</span>   <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
			<span class="p">.</span><span class="n">buf</span>   <span class="o">=</span> <span class="n">buf</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">};</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_transfer</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span> <span class="n">msgs</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">msgs</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reading register %x from %x failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">addr</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* no sign-extension */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_try_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">imx074_datafmt</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">imx074_find_datafmt</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fmt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">imx074_colour_fmts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
		<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">imx074_colour_fmts</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">IMX074_WIDTH</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">IMX074_HEIGHT</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_s_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imx074</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_imx074</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">sd</span><span class="o">-&gt;</span><span class="n">v4l2_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s(%u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

	<span class="cm">/* MIPI CSI could have changed the format, double-check */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">imx074_find_datafmt</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">imx074_try_fmt</span><span class="p">(</span><span class="n">sd</span><span class="p">,</span> <span class="n">mf</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">imx074_find_datafmt</span><span class="p">(</span><span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_g_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">v4l2_mbus_framefmt</span> <span class="o">*</span><span class="n">mf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">imx074</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_imx074</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">const</span> <span class="k">struct</span> <span class="n">imx074_datafmt</span> <span class="o">*</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">fmt</span><span class="p">;</span>

	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">code</span>	<span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">code</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">colorspace</span>	<span class="o">=</span> <span class="n">fmt</span><span class="o">-&gt;</span><span class="n">colorspace</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">IMX074_WIDTH</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">IMX074_HEIGHT</span><span class="p">;</span>
	<span class="n">mf</span><span class="o">-&gt;</span><span class="n">field</span>	<span class="o">=</span> <span class="n">V4L2_FIELD_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_g_crop</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_crop</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">v4l2_rect</span> <span class="o">*</span><span class="n">rect</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">;</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">top</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">left</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">width</span>	<span class="o">=</span> <span class="n">IMX074_WIDTH</span><span class="p">;</span>
	<span class="n">rect</span><span class="o">-&gt;</span><span class="n">height</span>	<span class="o">=</span> <span class="n">IMX074_HEIGHT</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_cropcap</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">v4l2_cropcap</span> <span class="o">*</span><span class="n">a</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">left</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">top</span>			<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">width</span>			<span class="o">=</span> <span class="n">IMX074_WIDTH</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">.</span><span class="n">height</span>		<span class="o">=</span> <span class="n">IMX074_HEIGHT</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">defrect</span>			<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">bounds</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span>				<span class="o">=</span> <span class="n">V4L2_BUF_TYPE_VIDEO_CAPTURE</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">numerator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">pixelaspect</span><span class="p">.</span><span class="n">denominator</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_enum_fmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
			   <span class="k">enum</span> <span class="n">v4l2_mbus_pixelcode</span> <span class="o">*</span><span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">imx074_colour_fmts</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="o">*</span><span class="n">code</span> <span class="o">=</span> <span class="n">imx074_colour_fmts</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">code</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_s_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">enable</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="cm">/* MODE_SELECT: stream or standby */</span>
	<span class="k">return</span> <span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">MODE_SELECT</span><span class="p">,</span> <span class="o">!!</span><span class="n">enable</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_g_chip_ident</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">v4l2_dbg_chip_ident</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">v4l2_get_subdevdata</span><span class="p">(</span><span class="n">sd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">V4L2_CHIP_MATCH_I2C_ADDR</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">match</span><span class="p">.</span><span class="n">addr</span> <span class="o">!=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">id</span><span class="o">-&gt;</span><span class="n">ident</span>	<span class="o">=</span> <span class="n">V4L2_IDENT_IMX074</span><span class="p">;</span>
	<span class="n">id</span><span class="o">-&gt;</span><span class="n">revision</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_g_mbus_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">v4l2_subdev</span> <span class="o">*</span><span class="n">sd</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">v4l2_mbus_config</span> <span class="o">*</span><span class="n">cfg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">V4L2_MBUS_CSI2</span><span class="p">;</span>
	<span class="n">cfg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">V4L2_MBUS_CSI2_2_LANE</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_CSI2_CHANNEL_0</span> <span class="o">|</span>
		<span class="n">V4L2_MBUS_CSI2_CONTINUOUS_CLOCK</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_video_ops</span> <span class="n">imx074_subdev_video_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">s_stream</span>	<span class="o">=</span> <span class="n">imx074_s_stream</span><span class="p">,</span>
	<span class="p">.</span><span class="n">s_mbus_fmt</span>	<span class="o">=</span> <span class="n">imx074_s_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_fmt</span>	<span class="o">=</span> <span class="n">imx074_g_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">try_mbus_fmt</span>	<span class="o">=</span> <span class="n">imx074_try_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">enum_mbus_fmt</span>	<span class="o">=</span> <span class="n">imx074_enum_fmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_crop</span>		<span class="o">=</span> <span class="n">imx074_g_crop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cropcap</span>	<span class="o">=</span> <span class="n">imx074_cropcap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">g_mbus_config</span>	<span class="o">=</span> <span class="n">imx074_g_mbus_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_core_ops</span> <span class="n">imx074_subdev_core_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">g_chip_ident</span>	<span class="o">=</span> <span class="n">imx074_g_chip_ident</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">v4l2_subdev_ops</span> <span class="n">imx074_subdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">core</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx074_subdev_core_ops</span><span class="p">,</span>
	<span class="p">.</span><span class="n">video</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx074_subdev_video_ops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_video_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Read sensor Model ID */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">reg_read</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">id</span> <span class="o">|=</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Chip ID 0x%04x detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0x74</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* PLL Setting EXTCLK=24MHz, 22.5times */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">PLL_MULTIPLIER</span><span class="p">,</span> <span class="mh">0x2D</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">PRE_PLL_CLK_DIV</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">PLSTATIM</span><span class="p">,</span> <span class="mh">0x4B</span><span class="p">);</span>

	<span class="cm">/* 2-lane mode */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3024</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">IMAGE_ORIENTATION</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* select RAW mode:</span>
<span class="cm">	 * 0x08+0x08 = top 8 bits</span>
<span class="cm">	 * 0x0a+0x08 = compressed 8-bits</span>
<span class="cm">	 * 0x0a+0x0a = 10 bits</span>
<span class="cm">	 */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0112</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x0113</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>

	<span class="cm">/* Base setting for High frame mode */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">VNDMY_ABLMGSHLMT</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Y_OPBADDR_START_DI</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3015</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x301C</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x302C</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3031</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3041</span><span class="p">,</span> <span class="mh">0x60</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3051</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3053</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3057</span><span class="p">,</span> <span class="mh">0xC0</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x305C</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x305D</span><span class="p">,</span> <span class="mh">0x07</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3060</span><span class="p">,</span> <span class="mh">0x30</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3065</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x30AA</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x30AB</span><span class="p">,</span> <span class="mh">0x1C</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x30B0</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x30B2</span><span class="p">,</span> <span class="mh">0x83</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x30D3</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3106</span><span class="p">,</span> <span class="mh">0x78</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x310C</span><span class="p">,</span> <span class="mh">0x82</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3304</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3305</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3306</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3307</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3308</span><span class="p">,</span> <span class="mh">0x0C</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3309</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x330A</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x330B</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x330C</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x330D</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x330E</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="mh">0x3381</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* V : 1/2V-addition (1,3), H : 1/2H-averaging (1,3) -&gt; Full HD */</span>
	<span class="cm">/* 1608 = 1560 + 48 (black lines) */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">FRAME_LENGTH_LINES_HI</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">FRAME_LENGTH_LINES_LO</span><span class="p">,</span> <span class="mh">0x48</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">YADDR_START</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">YADDR_END</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">);</span>
	<span class="cm">/* 0x838 == 2104 */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">X_OUTPUT_SIZE_MSB</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">X_OUTPUT_SIZE_LSB</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">);</span>
	<span class="cm">/* 0x618 == 1560 */</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Y_OUTPUT_SIZE_MSB</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Y_OUTPUT_SIZE_LSB</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">X_EVEN_INC</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">X_ODD_INC</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Y_EVEN_INC</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">Y_ODD_INC</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">HMODEADD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">VMODEADD</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">VAPPLINE_START</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">VAPPLINE_END</span><span class="p">,</span> <span class="mh">0x53</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">SHUTTER</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">HADDAVE</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">LANESEL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">reg_write</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">GROUPED_PARAMETER_HOLD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>	<span class="cm">/* off */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx074</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_adapter</span> <span class="o">*</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">to_i2c_adapter</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">icl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IMX074: missing platform data!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">adapter</span><span class="p">,</span> <span class="n">I2C_FUNC_SMBUS_BYTE_DATA</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adapter</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;I2C-Adapter doesn&#39;t support I2C_FUNC_SMBUS_BYTE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">imx074</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">v4l2_i2c_subdev_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">subdev</span><span class="p">,</span> <span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">imx074_subdev_ops</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">fmt</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">imx074_colour_fmts</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">imx074_video_probe</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">imx074_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">imx074</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">to_imx074</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">soc_camera_link</span> <span class="o">*</span><span class="n">icl</span> <span class="o">=</span> <span class="n">soc_camera_i2c_to_link</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">icl</span><span class="o">-&gt;</span><span class="n">free_bus</span><span class="p">)</span>
		<span class="n">icl</span><span class="o">-&gt;</span><span class="n">free_bus</span><span class="p">(</span><span class="n">icl</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">imx074_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;imx074&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">imx074_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">imx074_i2c_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;imx074&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">imx074_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">imx074_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">imx074_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">imx074_i2c_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Sony IMX074 Camera driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Guennadi Liakhovetski &lt;g.liakhovetski@gmx.de&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
